<!DOCTYPE html>
<html>
<head>
    <title>Check User Role</title>
</head>
<body>
    <h1>Checking User Role</h1>
    <div id="output"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        const SUPABASE_URL = 'https://unveoqnlqnobufhublyw.supabase.co';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTAxNzI3NiwiZXhwIjoyMDcwNTkzMjc2fQ.CJxV14F0T2TWkAjeR4bpYiBIOwLwyfzF9WzAWwS99Xc';

        const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
        const output = document.getElementById('output');

        function log(message) {
            console.log(message);
            output.innerHTML += message + '<br>';
        }

        async function checkUserRole() {
            const email = 'benhowardmagic@hotmail.com';
            log(`Checking role for user: ${email}`);

            try {
                // 1. Check auth.users table
                const { data: authUsers, error: authError } = await supabase.auth.admin.listUsers();
                if (authError) {
                    log(`Error fetching auth users: ${JSON.stringify(authError)}`);
                } else {
                    const user = authUsers.users.find(u => u.email === email);
                    if (user) {
                        log('<br><strong>Auth user found:</strong>');
                        log(`- ID: ${user.id}`);
                        log(`- Email: ${user.email}`);
                        log(`- Metadata role: ${user.user_metadata?.role}`);
                        log(`- Raw metadata: ${JSON.stringify(user.raw_user_meta_data)}`);
                        log(`- App metadata: ${JSON.stringify(user.app_metadata)}`);

                        // 2. Check master_users table
                        const { data: profiles, error: profileError } = await supabase
                            .from('master_users')
                            .select('*')
                            .eq('user_id', user.id);

                        if (profileError) {
                            log(`Error fetching profiles: ${JSON.stringify(profileError)}`);
                        } else {
                            log(`<br><strong>Profiles found: ${profiles.length}</strong>`);
                            profiles.forEach((profile, i) => {
                                log(`Profile ${i + 1}: ${JSON.stringify(profile, null, 2)}`);
                            });
                        }

                        // 3. Check site_invites table
                        const { data: invites, error: inviteError } = await supabase
                            .from('site_invites')
                            .select('*')
                            .eq('email', email);

                        if (inviteError) {
                            log(`Error fetching invites: ${JSON.stringify(inviteError)}`);
                        } else {
                            log(`<br><strong>Invites found: ${invites.length}</strong>`);
                            invites.forEach((invite, i) => {
                                log(`Invite ${i + 1}: ${JSON.stringify(invite, null, 2)}`);
                            });
                        }
                    } else {
                        log('User not found in auth.users');
                    }
                }
            } catch (error) {
                log(`Error checking user role: ${JSON.stringify(error)}`);
            }
        }

        checkUserRole();
    </script>

    <!-- Debug Console - Persistent across all pages -->
    <script src="debug-console.js"></script>
</body>
</html>
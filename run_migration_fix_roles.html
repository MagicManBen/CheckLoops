<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Role Migration Tool - CheckLoop</title>
  <script src="config.js"></script>
  <style>
    body {
      font-family: Inter, system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1a202c;
      margin-bottom: 8px;
    }
    .subtitle {
      color: #718096;
      margin-bottom: 24px;
    }
    .section {
      margin-bottom: 24px;
      padding: 16px;
      background: #f7fafc;
      border-radius: 8px;
    }
    .section h3 {
      margin-top: 0;
      color: #2d3748;
    }
    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 12px;
      margin-bottom: 12px;
    }
    button:hover {
      opacity: 0.9;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .log {
      background: #1a202c;
      color: #68d391;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 16px;
    }
    .log .error {
      color: #fc8181;
    }
    .log .warning {
      color: #f6e05e;
    }
    .log .success {
      color: #68d391;
    }
    .status {
      padding: 8px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-weight: 600;
    }
    .status.info {
      background: #bee3f8;
      color: #2c5282;
    }
    .status.success {
      background: #c6f6d5;
      color: #22543d;
    }
    .status.error {
      background: #fed7d7;
      color: #742a2a;
    }
    .checkbox-group {
      margin: 16px 0;
    }
    .checkbox-group label {
      display: block;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Role Migration Tool</h1>
    <div class="subtitle">Fix role confusion by separating account roles from job roles</div>

    <div id="status" class="status info">Ready to migrate</div>

    <div class="section">
      <h3>Migration Overview</h3>
      <p>This tool will:</p>
      <ul>
        <li>Add new columns: account_role (for admin/staff/owner) and job_role (for GP/Nurse/etc)</li>
        <li>Migrate existing data to the new columns</li>
        <li>Update RLS policies to use the new column names</li>
        <li>Maintain backward compatibility during transition</li>
      </ul>
    </div>

    <div class="section">
      <h3>Migration Steps</h3>
      <div class="checkbox-group">
        <label><input type="checkbox" id="step1" disabled> Step 1: Add new columns to tables</label>
        <label><input type="checkbox" id="step2" disabled> Step 2: Migrate existing data</label>
        <label><input type="checkbox" id="step3" disabled> Step 3: Update RLS policies</label>
        <label><input type="checkbox" id="step4" disabled> Step 4: Create indexes for performance</label>
        <label><input type="checkbox" id="step5" disabled> Step 5: Verify migration</label>
      </div>
    </div>

    <div class="section">
      <h3>Actions</h3>
      <button id="btnCheck">Check Current Schema</button>
      <button id="btnMigrate">Run Migration</button>
      <button id="btnVerify">Verify Migration</button>
      <button id="btnRollback" style="background: #e53e3e;">Rollback Migration</button>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    let supabase;
    const log = document.getElementById('log');
    const status = document.getElementById('status');

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success';
      log.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    function setStatus(message, type = 'info') {
      status.textContent = message;
      status.className = `status ${type}`;
    }

    function checkStep(stepId) {
      document.getElementById(stepId).checked = true;
    }

    // Initialize Supabase
    async function init() {
      try {
        supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
          setStatus('Not authenticated. Please log in first.', 'error');
          addLog('Authentication required. Redirecting to login...', 'error');
          setTimeout(() => window.location.href = 'index.html', 2000);
          return;
        }

        // Check if user is admin
        const { data: profile } = await supabase
          .from('profiles')
          .select('role, account_role')
          .eq('user_id', session.user.id)
          .single();

        const accountRole = profile?.account_role || profile?.role;
        if (!['admin', 'owner'].includes(accountRole?.toLowerCase())) {
          setStatus('Admin access required', 'error');
          addLog('This tool requires admin or owner privileges', 'error');
          return;
        }

        addLog('Authenticated as admin/owner', 'success');
        setStatus('Ready to migrate', 'info');
      } catch (error) {
        addLog(`Initialization error: ${error.message}`, 'error');
        setStatus('Initialization failed', 'error');
      }
    }

    // Check current schema
    async function checkSchema() {
      setStatus('Checking current schema...', 'info');
      addLog('Checking database schema...');

      try {
        // Check profiles table
        const { data: profiles, error: profileError } = await supabase
          .from('profiles')
          .select('*')
          .limit(1);

        if (profileError) {
          addLog(`Profiles table check failed: ${profileError.message}`, 'error');
        } else {
          const cols = profiles[0] ? Object.keys(profiles[0]) : [];
          addLog(`Profiles columns: ${cols.join(', ')}`);
          if (cols.includes('account_role')) {
            addLog('✓ account_role column already exists in profiles', 'success');
          } else {
            addLog('✗ account_role column not found in profiles', 'warning');
          }
        }

        // Check site_invites table
        const { data: invites, error: inviteError } = await supabase
          .from('site_invites')
          .select('*')
          .limit(1);

        if (inviteError) {
          addLog(`Site invites table check failed: ${inviteError.message}`, 'error');
        } else {
          const cols = invites[0] ? Object.keys(invites[0]) : [];
          addLog(`Site invites columns: ${cols.join(', ')}`);
          if (cols.includes('account_role')) {
            addLog('✓ account_role column already exists in site_invites', 'success');
          } else {
            addLog('✗ account_role column not found in site_invites', 'warning');
          }
        }

        setStatus('Schema check completed', 'success');
      } catch (error) {
        addLog(`Schema check error: ${error.message}`, 'error');
        setStatus('Schema check failed', 'error');
      }
    }

    // Run migration
    async function runMigration() {
      setStatus('Running migration...', 'info');
      addLog('Starting migration process...');

      try {
        // Note: This would need to be executed via Supabase SQL editor or direct database connection
        // as the JavaScript client doesn't support DDL operations

        addLog('IMPORTANT: Database schema changes must be run via Supabase SQL Editor', 'warning');
        addLog('Copy the migration script and run it in: Dashboard > SQL Editor', 'warning');

        // We can still update existing data via the JavaScript client
        addLog('Attempting to update existing data...');

        // Update profiles
        const { data: profiles } = await supabase
          .from('profiles')
          .select('user_id, role');

        if (profiles) {
          for (const profile of profiles) {
            if (profile.role && !profile.account_role) {
              const accountRole = ['admin', 'staff', 'owner'].includes(profile.role.toLowerCase())
                ? profile.role.toLowerCase()
                : 'staff';

              // This will only work if account_role column exists
              const { error } = await supabase
                .from('profiles')
                .update({ account_role: accountRole })
                .eq('user_id', profile.user_id);

              if (error) {
                addLog(`Failed to update profile ${profile.user_id}: ${error.message}`, 'error');
              } else {
                addLog(`Updated profile ${profile.user_id}: account_role = ${accountRole}`, 'success');
              }
            }
          }
          checkStep('step2');
        }

        setStatus('Migration partially completed - run SQL script for full migration', 'warning');
      } catch (error) {
        addLog(`Migration error: ${error.message}`, 'error');
        setStatus('Migration failed', 'error');
      }
    }

    // Verify migration
    async function verifyMigration() {
      setStatus('Verifying migration...', 'info');
      addLog('Verifying migration results...');

      try {
        // Check a few profiles
        const { data: profiles, error } = await supabase
          .from('profiles')
          .select('user_id, role, account_role, full_name')
          .limit(5);

        if (error) {
          addLog(`Verification failed: ${error.message}`, 'error');
        } else {
          addLog(`Found ${profiles.length} profiles to verify`);
          for (const p of profiles) {
            const accountRole = p.account_role || p.role || 'unknown';
            addLog(`User ${p.full_name || p.user_id}: account_role=${accountRole}`);
          }
          checkStep('step5');
          setStatus('Verification completed', 'success');
        }
      } catch (error) {
        addLog(`Verification error: ${error.message}`, 'error');
        setStatus('Verification failed', 'error');
      }
    }

    // Rollback migration
    async function rollbackMigration() {
      if (!confirm('Are you sure you want to rollback the migration? This will remove the new columns.')) {
        return;
      }

      setStatus('Rolling back migration...', 'info');
      addLog('IMPORTANT: Rollback must be done via Supabase SQL Editor', 'warning');
      addLog('Run the following SQL commands:', 'warning');
      addLog('ALTER TABLE public.profiles DROP COLUMN IF EXISTS account_role;');
      addLog('ALTER TABLE public.site_invites DROP COLUMN IF EXISTS account_role;');
      addLog('ALTER TABLE public.site_invites DROP COLUMN IF EXISTS job_role;');
      addLog('ALTER TABLE public.kiosk_users DROP COLUMN IF EXISTS job_role;');
      addLog('ALTER TABLE public.staff_app_welcome DROP COLUMN IF EXISTS job_role;');
      addLog('DROP TABLE IF EXISTS public.kiosk_job_roles;');

      setStatus('Rollback commands displayed - run in SQL Editor', 'warning');
    }

    // Event listeners
    document.getElementById('btnCheck').addEventListener('click', checkSchema);
    document.getElementById('btnMigrate').addEventListener('click', runMigration);
    document.getElementById('btnVerify').addEventListener('click', verifyMigration);
    document.getElementById('btnRollback').addEventListener('click', rollbackMigration);

    // Initialize on load
    init();
  </script>
</body>
</html>
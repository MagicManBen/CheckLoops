<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — Staff Meetings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="admin-nav.js"></script>
  <link rel="stylesheet" href="staff.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Page-specific tweaks only; core styles live in staff.css */
    .subtitle{ color:#64748b; font-weight:600; }

    /* Meetings Section Styles — High‑contrast redesign */
    .meetings-section { margin-top: 10px; }

    .meetings-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      border-bottom: 2px solid #dbe2ea;
      align-items: flex-end;
    }

    .meetings-tab {
      padding: 10px 14px;
      background: #f3f5f8;
      color: #0f172a;
      border: 1px solid #cbd5e1;
      border-bottom: 3px solid transparent;
      border-radius: 10px 10px 0 0;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s ease, color .2s ease, border-color .2s ease, transform .1s ease;
    }

    .meetings-tab:hover { background: #e8eef5; transform: translateY(-1px); }

    .meetings-tab:focus-visible { outline: 3px solid #93c5fd; outline-offset: 2px; }

    .meetings-tab.active {
      background: #ffffff;
      color: #0b2a6b;
      border-color: #93c5fd;
      border-bottom-color: #ffffff; /* merge with content card */
    }

    .meetings-content { display: none; }
    .meetings-content.active { display: block; }

    /* Calendar container card */
    #calendar {
      height: 520px;
      background: #ffffff;
      padding: 16px;
      border-radius: 14px;
      border: 1px solid #dbe2ea;
      box-shadow: 0 6px 16px rgba(2,6,23,0.06);
    }

    /* FullCalendar high‑contrast overrides */
    .fc .fc-toolbar-title{ color:#0f172a; font-weight:800; letter-spacing:.2px; }
    .fc .fc-col-header-cell-cushion{ color:#0f172a; font-weight:700; }
    .fc .fc-daygrid-day-number{ color:#0f172a; font-weight:700; }
    .fc .fc-daygrid-day{ background:#fff; }
    .fc .fc-daygrid-day.fc-day-today{ background:#eff6ff; }
    .fc-theme-standard td, .fc-theme-standard th{ border-color:#dbe2ea; }

    /* Toolbar buttons */
    .fc .fc-button-primary{
      background:#0f172a; border-color:#0f172a; color:#fff; font-weight:700; border-radius:10px;
    }
    .fc .fc-button-primary:not(:disabled):hover{ background:#1f2937; border-color:#1f2937; }
    .fc .fc-button-primary.fc-button-active{ background:#1d4ed8; border-color:#1d4ed8; color:#fff; }
    .fc .fc-button-group .fc-button{ border-radius:10px; }

    /* Events — make text dark and background readable */
    .fc .fc-event{ background:#dbeafe; border-color:#60a5fa; color:#0f172a; cursor: pointer; }
    .fc .fc-h-event .fc-event-title{ font-weight:800; }
    .fc .fc-daygrid-dot-event .fc-event-title{ color:#0f172a; font-weight:700; }
    .fc .fc-daygrid-event-dot{ border-color:#2563eb; }

    /* Meeting creation button */
    .btn-create-meeting {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 15px;
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      z-index: 1000;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal h3 { margin-top: 0; color: #0f172a; }
    
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
    }

    .agenda-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .agenda-item { 
      background: white; 
      padding: 15px; 
      border-radius: 8px; 
      margin-bottom: 10px; 
      border: 1px solid #e5e7eb;
      position: relative;
    }
    .agenda-item-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 5px;
    }
    .btn-delete {
      background: #ef4444;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .attendance-buttons { display: flex; gap: 10px; margin-top: 10px; }
    .btn-accept { background: #10b981; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-decline { background: #ef4444; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-tentative { background: #f59e0b; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
    .meeting-notes { width: 100%; min-height: 300px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; font-family: inherit; resize: vertical; }
    .btn-generate-pdf { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 15px; }
    .btn-save-notes { background: #3b82f6; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 15px; margin-right: 10px; }
    .meeting-history-item { 
      background: white; 
      padding: 15px; 
      border-radius: 8px; 
      margin-bottom: 10px; 
      border: 1px solid #e5e7eb; 
      cursor: pointer; 
      transition: all 0.3s;
      position: relative;
    }
    .meeting-history-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
    .meeting-form-group { margin-bottom: 15px; }
    .meeting-form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #374151; }
    .meeting-form-group input, .meeting-form-group textarea, .meeting-form-group select { 
      width: 100%; 
      padding: 10px; 
      border: 1px solid #e5e7eb; 
      border-radius: 6px; 
      font-family: inherit; 
    }
    .meeting-form-group input[type="datetime-local"] { padding: 8px 10px; }
    .meeting-form-group select option { color: #333; background: white; }
    .attendees-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .attendee-badge { padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: 500; }
    .attendee-badge.accepted { background: #dcfce7; color: #16a34a; }
    .attendee-badge.declined { background: #fee2e2; color: #dc2626; }
    .attendee-badge.tentative { background: #fed7aa; color: #c2410c; }
    .attendee-badge.pending { background: #fef3c7; color: #d97706; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      text-align: center;
    }
    
    .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: #0f172a;
    }
    
    .stat-label {
      font-size: 14px;
      color: #6b7280;
      margin-top: 5px;
    }

    .meeting-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 10px;
    }
    
    .meeting-status.completed { background: #dcfce7; color: #16a34a; }
    .meeting-status.scheduled { background: #dbeafe; color: #1d4ed8; }
    .meeting-status.cancelled { background: #fee2e2; color: #dc2626; }
    
    /* Recording animation */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
    <div class="particles" id="particles"></div>
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>
  </div>
  <div class="mesh" aria-hidden="true"><div class="m1"></div><div class="m2"></div><div class="m3"></div></div>

  <main class="content">
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav"></div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: —</div>
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>

    <section class="panel g-12" style="margin:0; position:relative; overflow:hidden;">
      <div class="halo"></div>
      <div class="panel-header" style="align-items:center; gap:10px;">
        <div class="illus-circle"><img data-i8="calendar" alt="Meetings"></div>
        <div class="panel-title">Meetings Hub</div>
      </div>

      <div class="meetings-section">
        <div class="meetings-tabs">
          <button class="meetings-tab active" data-tab="calendar">Calendar</button>
          <button class="meetings-tab" data-tab="agenda">Agenda Items</button>
          <button class="meetings-tab" data-tab="notes">Meeting Notes</button>
          <button class="meetings-tab" data-tab="history">Past Meetings</button>
        </div>

        <!-- Calendar Tab -->
        <div class="meetings-content active" id="calendar-content">
          <button class="btn-create-meeting" onclick="openCreateMeetingModal()">+ Create New Meeting</button>
          <div id="calendar"></div>
        </div>

        <!-- Agenda Tab -->
        <div class="meetings-content" id="agenda-content">
          <div class="agenda-form">
            <h3>Submit Agenda Item</h3>
            <div class="meeting-form-group">
              <label>Meeting</label>
              <select id="agenda-meeting-select">
                <option value="">Select a meeting...</option>
              </select>
            </div>
            <div class="meeting-form-group">
              <label>Agenda Item</label>
              <input type="text" id="agenda-item-title" placeholder="Enter agenda item title">
            </div>
            <div class="meeting-form-group">
              <label>Description</label>
              <textarea id="agenda-item-description" rows="3" placeholder="Provide details about this agenda item"></textarea>
            </div>
            <button class="btn" onclick="submitAgendaItem()" style="background: #4f89ff; color: white;">Submit Agenda Item</button>
          </div>
          <h3>Current Agenda Items</h3>
          <div id="agenda-items-list"></div>
        </div>

        <!-- Meeting Notes Tab -->
        <div class="meetings-content" id="notes-content">
          <div class="meeting-form-group">
            <label>Select Meeting</label>
            <select id="notes-meeting-select" onchange="loadMeetingNotes()">
              <option value="">Select a meeting...</option>
            </select>
          </div>
          <div class="meeting-form-group">
            <label>Meeting Notes/Minutes</label>
            <textarea class="meeting-notes" id="meeting-notes-textarea" placeholder="Type your meeting notes here..."></textarea>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn-save-notes" onclick="saveMeetingNotes()">Save Notes</button>
            <button class="btn-generate-pdf" onclick="generateMeetingPDF()">Generate PDF</button>
          </div>
          <div class="meeting-form-group" style="margin-top: 20px;">
            <label>Record or Upload Meeting Audio</label>
            
            <!-- Live Recording Controls -->
            <div id="recording-controls" style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
              <button id="start-recording" class="btn" onclick="startRecording()" style="background: #ef4444; color: white; padding: 10px 20px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                <span style="width: 12px; height: 12px; background: white; border-radius: 50%;"></span>
                Start Recording
              </button>
              <button id="stop-recording" class="btn" onclick="stopRecording()" style="background: #10b981; color: white; padding: 10px 20px; border-radius: 8px; display: none; align-items: center; gap: 8px;">
                <span style="width: 12px; height: 12px; background: white;"></span>
                Stop Recording
              </button>
              <button id="pause-recording" class="btn" onclick="pauseRecording()" style="background: #f59e0b; color: white; padding: 10px 20px; border-radius: 8px; display: none;">
                Pause
              </button>
              <div id="recording-timer" style="display: none; font-weight: 600; color: #ef4444; padding: 10px; background: #fee2e2; border-radius: 6px;">
                <span style="animation: pulse 1.5s infinite;">🔴</span> Recording: <span id="recording-time">00:00</span>
              </div>
            </div>
            
            <!-- Audio Visualizer -->
            <canvas id="audio-visualizer" width="400" height="60" style="width: 100%; height: 60px; background: #f3f4f6; border-radius: 8px; margin-bottom: 10px; display: none;"></canvas>
            
            <!-- Recorded Audio Playback -->
            <div id="recorded-audio-container" style="display: none; margin-bottom: 15px;">
              <audio id="recorded-audio" controls style="width: 100%;"></audio>
              <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn" onclick="saveRecording()" style="background: #3b82f6; color: white; padding: 8px 16px; border-radius: 6px;">
                  Save & Transcribe
                </button>
                <button class="btn" onclick="discardRecording()" style="background: #6b7280; color: white; padding: 8px 16px; border-radius: 6px;">
                  Discard
                </button>
              </div>
            </div>
            
            <!-- File Upload (existing) -->
            <div style="border-top: 1px solid #e5e7eb; padding-top: 15px;">
              <small style="color: #6b7280; display: block; margin-bottom: 8px;">Or upload an existing recording:</small>
              <input type="file" id="meeting-recording" accept="audio/*,video/*" onchange="handleRecordingUpload(event)" style="padding: 8px;">
            </div>
          </div>
          <div id="pdf-status" style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; display: none;">
            <p style="margin: 0; color: #0369a1;">Processing...</p>
          </div>
        </div>

        <!-- History Tab -->
        <div class="meetings-content" id="history-content">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="stat-total">0</div>
              <div class="stat-label">Total Meetings</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-upcoming">0</div>
              <div class="stat-label">Upcoming</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-past">0</div>
              <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="stat-month">0</div>
              <div class="stat-label">This Month</div>
            </div>
          </div>
          <h3>Past Meetings</h3>
          <div id="meeting-history-list"></div>
        </div>
      </div>
    </section>

    <div class="muted" style="text-align:center; font-size:12px; padding:10px 0;">© CheckLoop • Staff Meetings</div>
  </main>

  <!-- Meeting Details Modal -->
  <div class="modal-overlay" id="meeting-modal-overlay" onclick="closeMeetingModal()"></div>
  <div id="meeting-modal" class="modal" style="display: none;">
    <button class="modal-close" onclick="closeMeetingModal()">×</button>
    <h3 id="modal-meeting-title">Meeting Title</h3>
    <p id="modal-meeting-date">Date</p>
    <p id="modal-meeting-location">Location</p>
    <p id="modal-meeting-description">Description</p>
    
    <h4>Attendees</h4>
    <div class="attendees-list" id="modal-attendees"></div>
    
    <div class="attendance-buttons">
      <button class="btn-accept" onclick="updateAttendance('accepted')">Accept</button>
      <button class="btn-tentative" onclick="updateAttendance('tentative')">Tentative</button>
      <button class="btn-decline" onclick="updateAttendance('declined')">Decline</button>
    </div>
    
    <div style="margin-top: 20px;">
      <button class="btn-delete" onclick="deleteMeeting()">Delete Meeting</button>
    </div>
  </div>

  <!-- Create Meeting Modal -->
  <div class="modal-overlay" id="create-modal-overlay" onclick="closeCreateMeetingModal()"></div>
  <div id="create-meeting-modal" class="modal" style="display: none;">
    <button class="modal-close" onclick="closeCreateMeetingModal()">×</button>
    <h3>Create New Meeting</h3>
    
    <div class="meeting-form-group">
      <label>Meeting Title *</label>
      <input type="text" id="new-meeting-title" placeholder="Enter meeting title" required>
    </div>
    
    <div class="meeting-form-group">
      <label>Description</label>
      <textarea id="new-meeting-description" rows="3" placeholder="Meeting description"></textarea>
    </div>
    
    <div class="meeting-form-group">
      <label>Start Date & Time *</label>
      <input type="datetime-local" id="new-meeting-start" required>
    </div>
    
    <div class="meeting-form-group">
      <label>End Date & Time</label>
      <input type="datetime-local" id="new-meeting-end">
    </div>
    
    <div class="meeting-form-group">
      <label>Location</label>
      <input type="text" id="new-meeting-location" placeholder="Meeting location">
    </div>
    
    <div class="meeting-form-group">
      <label>Meeting Type</label>
      <select id="new-meeting-type">
        <option value="general">General</option>
        <option value="partners">Partners Meeting</option>
        <option value="staff">Staff Meeting</option>
        <option value="training">Training</option>
        <option value="pcn">PCN Meeting</option>
        <option value="clinical">Clinical Meeting</option>
      </select>
    </div>
    
    <button class="btn" onclick="createMeeting()" style="background: #10b981; color: white; width: 100%;">Create Meeting</button>
  </div>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, clearAuthData, revealAdminNav } from './staff-common.js';
    import { MeetingsManager } from './meetings-module.js';
    
    const supabase = await initSupabase();
    handleAuthState(supabase);
    navActivate('meetings');
    
    // Make MeetingsManager globally available
    window.meetingsManager = null;
    window.supabase = supabase;

    let isLoggingOut = false;
    function cleanupAndRedirect() {
      try { clearAuthData(true); } catch(_) {}
      try { sessionStorage.clear(); } catch(_) {}
      try { document.cookie.split(';').forEach(c => document.cookie = c.replace(/^ +/, '').replace(/=.*/, `=;expires=${new Date(0).toUTCString()};path=/`)); } catch(_) {}
      window.location.replace('Home.html?_=' + Date.now());
    }
    async function forceLogout() {
      if (isLoggingOut) return;
      isLoggingOut = true;
      try { const { data } = await supabase.auth.getSession(); if (data?.session) await supabase.auth.signOut(); } catch (e) { console.error('Supabase signOut failed:', e); }
      cleanupAndRedirect();
    }
    document.getElementById('logout-btn').addEventListener('click', async (e) => { e.preventDefault(); e.stopPropagation(); await forceLogout(); });

    requireStaffSession(supabase).then(async ({ session, profileRow }) => {
      // Bounce to onboarding if force flag still present
      try { if (sessionStorage.getItem('forceOnboarding') === '1') { window.location.replace('staff-welcome.html?force=1'); return; } } catch(_) {}

      const siteId = profileRow?.site_id || session.user?.raw_user_meta_data?.site_id || null;
      const role = (profileRow?.role || session.user?.raw_user_meta_data?.role || 'Staff');
      setTopbar({ siteText: await getSiteText(supabase, siteId), email: session.user.email, role });
      revealAdminNav(role);

      // Initialize MeetingsManager
      window.meetingsManager = new MeetingsManager(supabase);
      await window.meetingsManager.setContext(session);
      
      // Initialize the meetings UI
      await initializeMeetings();
    }).catch(e => {
      if (String(e.message).includes('NO_SESSION')) { window.location.replace('Home.html'); return; }
      if (String(e.message).includes('NOT_STAFF')) { window.location.replace('Home.html'); return; }
      if (String(e.message).includes('REDIRECT_ONBOARDING')) { return; }
      console.error(e);
    });
  </script>

  <script>
    // Global variables
    let calendar = null;
    let currentMeetingId = null;
    let currentMeeting = null;

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.meetings-tab').forEach(tab => { tab.classList.remove('active'); });
      const btn = document.querySelector(`[data-tab="${tabName}"]`); 
      if (btn) btn.classList.add('active');
      document.querySelectorAll('.meetings-content').forEach(content => { content.classList.remove('active'); });
      const panel = document.getElementById(`${tabName}-content`); 
      if (panel) panel.classList.add('active');
      
      // Refresh data when switching tabs
      if (tabName === 'history') {
        loadMeetingHistory();
        updateStats();
      } else if (tabName === 'agenda') {
        loadAgendaItems();
      }
    }

    // Initialize meetings functionality
    async function initializeMeetings() {
      // Setup tab switching
      document.querySelectorAll('.meetings-tab').forEach(tab => {
        tab.addEventListener('click', function(){ switchTab(this.dataset.tab); });
      });

      // Initialize calendar
      await new Promise(r => setTimeout(r, 50));
      const calendarEl = document.getElementById('calendar');
      if (calendarEl && typeof FullCalendar !== 'undefined') {
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          headerToolbar: { 
            left: 'prev,next today', 
            center: 'title', 
            right: 'dayGridMonth,timeGridWeek,timeGridDay' 
          },
          events: async (fetchInfo, success, fail) => {
            try { 
              const events = await loadMeetings(); 
              success(events); 
            } catch (e) { 
              console.error(e); 
              fail(e); 
            }
          },
          eventClick: (info) => { 
            showMeetingDetails(info.event); 
          },
          editable: true,
          eventDrop: async (info) => {
            // Update meeting when dragged to new date
            await window.meetingsManager.updateMeeting(info.event.id, {
              start: info.event.start.toISOString(),
              end: info.event.end ? info.event.end.toISOString() : null
            });
          }
        });
        calendar.render();
      }
      
      // Load initial data
      await loadMeetings();
      populateMeetingSelects();
      updateStats();
    }

    // Load meetings from storage
    async function loadMeetings() {
      if (!window.meetingsManager) return [];
      
      const meetings = await window.meetingsManager.getMeetings();
      const events = window.meetingsManager.formatForFullCalendar(meetings);
      
      // Update selects
      setTimeout(populateMeetingSelects, 50);
      
      return events;
    }

    // Populate meeting select dropdowns
    async function populateMeetingSelects() {
      if (!window.meetingsManager) return;
      
      const meetings = await window.meetingsManager.getUpcomingMeetings(20);
      const agendaSelect = document.getElementById('agenda-meeting-select');
      const notesSelect = document.getElementById('notes-meeting-select');
      
      if (!meetings || !meetings.length) {
        if (agendaSelect) agendaSelect.innerHTML = '<option value="">No upcoming meetings</option>';
        if (notesSelect) notesSelect.innerHTML = '<option value="">No meetings available</option>';
        return;
      }
      
      const options = meetings.map(m => 
        `<option value="${m.id}">${m.title} - ${new Date(m.start).toLocaleDateString()}</option>`
      ).join('');
      
      if (agendaSelect) agendaSelect.innerHTML = '<option value="">Select a meeting...</option>' + options;
      if (notesSelect) notesSelect.innerHTML = '<option value="">Select a meeting...</option>' + options;
    }

    // Show meeting details modal
    async function showMeetingDetails(event) {
      if (!window.meetingsManager) return;
      
      currentMeetingId = event.id;
      const meetings = await window.meetingsManager.getMeetings();
      currentMeeting = meetings.find(m => m.id === currentMeetingId);
      
      if (!currentMeeting) return;
      
      document.getElementById('modal-meeting-title').textContent = currentMeeting.title;
      document.getElementById('modal-meeting-date').textContent = new Date(currentMeeting.start).toLocaleString();
      document.getElementById('modal-meeting-location').textContent = currentMeeting.location || 'Not specified';
      document.getElementById('modal-meeting-description').textContent = currentMeeting.description || 'No description';
      
      // Load attendees
      const attendees = await window.meetingsManager.getMeetingAttendees(currentMeetingId);
      const attendeesList = document.getElementById('modal-attendees');
      
      if (attendees.length > 0) {
        attendeesList.innerHTML = attendees.map(a => 
          `<span class="attendee-badge ${a.status}">${a.name || a.email}</span>`
        ).join('');
      } else {
        attendeesList.innerHTML = '<span class="attendee-badge pending">No attendees yet</span>';
      }
      
      document.getElementById('meeting-modal').style.display = 'block';
      document.getElementById('meeting-modal-overlay').style.display = 'block';
    }

    function closeMeetingModal() {
      document.getElementById('meeting-modal').style.display = 'none';
      document.getElementById('meeting-modal-overlay').style.display = 'none';
    }

    // Create meeting modal functions
    function openCreateMeetingModal() {
      // Set default date/time to next hour
      const now = new Date();
      now.setHours(now.getHours() + 1, 0, 0, 0);
      const dateStr = now.toISOString().slice(0, 16);
      document.getElementById('new-meeting-start').value = dateStr;
      
      const end = new Date(now);
      end.setHours(end.getHours() + 1);
      document.getElementById('new-meeting-end').value = end.toISOString().slice(0, 16);
      
      document.getElementById('create-meeting-modal').style.display = 'block';
      document.getElementById('create-modal-overlay').style.display = 'block';
    }

    function closeCreateMeetingModal() {
      document.getElementById('create-meeting-modal').style.display = 'none';
      document.getElementById('create-modal-overlay').style.display = 'none';
      
      // Clear form
      document.getElementById('new-meeting-title').value = '';
      document.getElementById('new-meeting-description').value = '';
      document.getElementById('new-meeting-location').value = '';
    }

    // Create new meeting
    async function createMeeting() {
      if (!window.meetingsManager) return;
      
      const title = document.getElementById('new-meeting-title').value;
      const description = document.getElementById('new-meeting-description').value;
      const start = document.getElementById('new-meeting-start').value;
      const end = document.getElementById('new-meeting-end').value;
      const location = document.getElementById('new-meeting-location').value;
      const meetingType = document.getElementById('new-meeting-type').value;
      
      if (!title || !start) {
        alert('Please enter a title and start time');
        return;
      }
      
      const meeting = await window.meetingsManager.createMeeting({
        title,
        description,
        start: new Date(start).toISOString(),
        end: end ? new Date(end).toISOString() : null,
        location,
        meeting_type: meetingType
      });
      
      // Refresh calendar
      calendar.refetchEvents();
      
      closeCreateMeetingModal();
      alert('Meeting created successfully!');
    }

    // Update attendance status
    async function updateAttendance(status) {
      if (!window.meetingsManager || !currentMeetingId) return;
      
      const userId = window.supabase.auth.user?.()?.id || window.meetingsManager.currentUser.id;
      await window.meetingsManager.updateAttendeeStatus(currentMeetingId, userId, status);
      
      // Refresh the modal
      const event = { id: currentMeetingId };
      showMeetingDetails(event);
      
      alert(`Meeting ${status}!`);
    }

    // Delete meeting
    async function deleteMeeting() {
      if (!window.meetingsManager || !currentMeetingId) return;
      
      if (confirm('Are you sure you want to delete this meeting?')) {
        await window.meetingsManager.deleteMeeting(currentMeetingId);
        calendar.refetchEvents();
        closeMeetingModal();
        alert('Meeting deleted successfully');
      }
    }

    // Submit agenda item
    async function submitAgendaItem() {
      if (!window.meetingsManager) return;
      
      const meetingId = document.getElementById('agenda-meeting-select').value;
      const title = document.getElementById('agenda-item-title').value;
      const description = document.getElementById('agenda-item-description').value;
      
      if (!meetingId || !title) {
        alert('Please select a meeting and enter a title');
        return;
      }
      
      await window.meetingsManager.createAgendaItem({
        meeting_id: meetingId,
        title,
        description
      });
      
      // Clear form
      document.getElementById('agenda-item-title').value = '';
      document.getElementById('agenda-item-description').value = '';
      
      // Reload agenda items
      loadAgendaItems();
      
      alert('Agenda item submitted successfully');
    }

    // Load agenda items
    async function loadAgendaItems() {
      if (!window.meetingsManager) return;
      
      const meetingId = document.getElementById('agenda-meeting-select').value;
      const agendaList = document.getElementById('agenda-items-list');
      
      if (!meetingId) {
        agendaList.innerHTML = '<p style="color: #6b7280;">Select a meeting to view agenda items</p>';
        return;
      }
      
      const items = await window.meetingsManager.getAgendaItems(meetingId);
      
      if (items.length === 0) {
        agendaList.innerHTML = '<p style="color: #6b7280;">No agenda items yet</p>';
        return;
      }
      
      agendaList.innerHTML = items.map(item => `
        <div class="agenda-item" data-id="${item.id}">
          <div class="agenda-item-actions">
            <button class="btn-delete" onclick="deleteAgendaItem('${item.id}')">Delete</button>
          </div>
          <h4>${item.title}</h4>
          <p>${item.description || 'No description'}</p>
          <small style="color: #6b7280;">Submitted by: ${item.submitter_name}</small>
        </div>
      `).join('');
    }

    // Delete agenda item
    async function deleteAgendaItem(itemId) {
      if (!window.meetingsManager) return;
      
      if (confirm('Delete this agenda item?')) {
        await window.meetingsManager.deleteAgendaItem(itemId);
        loadAgendaItems();
      }
    }

    // Load meeting notes
    async function loadMeetingNotes() {
      if (!window.meetingsManager) return;
      
      const meetingId = document.getElementById('notes-meeting-select').value;
      const notesTextarea = document.getElementById('meeting-notes-textarea');
      
      if (!meetingId) {
        notesTextarea.value = '';
        return;
      }
      
      const notes = await window.meetingsManager.getMeetingNotes(meetingId);
      notesTextarea.value = notes?.content || '';
    }

    // Save meeting notes
    async function saveMeetingNotes() {
      if (!window.meetingsManager) return;
      
      const meetingId = document.getElementById('notes-meeting-select').value;
      const content = document.getElementById('meeting-notes-textarea').value;
      
      if (!meetingId) {
        alert('Please select a meeting');
        return;
      }
      
      await window.meetingsManager.saveMeetingNotes(meetingId, content);
      alert('Notes saved successfully');
    }

    // Generate PDF
    async function generateMeetingPDF() {
      if (!window.meetingsManager) return;
      
      const meetingId = document.getElementById('notes-meeting-select').value;
      const notes = document.getElementById('meeting-notes-textarea').value;
      
      if (!meetingId || !notes) {
        alert('Please select a meeting and enter notes');
        return;
      }
      
      const statusDiv = document.getElementById('pdf-status');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<p style="margin: 0; color: #0369a1;">Generating PDF...</p>';
      
      try {
        const pdfContent = await window.meetingsManager.exportMeetingToPDF(meetingId);
        
        // Generate PDF using jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.text(pdfContent.title, 20, 20);
        
        doc.setFontSize(12);
        doc.text('Date: ' + pdfContent.date, 20, 35);
        doc.text('Location: ' + pdfContent.location, 20, 45);
        
        doc.setFontSize(14);
        doc.text('Attendees:', 20, 60);
        doc.setFontSize(11);
        let yPos = 70;
        pdfContent.attendees.forEach(a => {
          doc.text('• ' + a, 25, yPos);
          yPos += 7;
        });
        
        doc.setFontSize(14);
        doc.text('Agenda Items:', 20, yPos + 10);
        doc.setFontSize(11);
        yPos += 20;
        pdfContent.agenda.forEach(a => {
          const lines = doc.splitTextToSize(a, 170);
          doc.text(lines, 25, yPos);
          yPos += lines.length * 7;
        });
        
        doc.setFontSize(14);
        doc.text('Meeting Notes:', 20, yPos + 10);
        doc.setFontSize(11);
        const noteLines = doc.splitTextToSize(pdfContent.notes, 170);
        doc.text(noteLines, 20, yPos + 20);
        
        doc.save(`meeting-${meetingId}.pdf`);
        
        statusDiv.innerHTML = '<p style="margin: 0; color: #16a34a;">✓ PDF generated successfully!</p>';
        setTimeout(() => { statusDiv.style.display = 'none'; }, 2500);
      } catch (e) {
        console.error(e);
        statusDiv.innerHTML = '<p style="margin: 0; color: #dc2626;">Error generating PDF</p>';
      }
    }

    // Handle recording upload
    async function handleRecordingUpload(event) {
      if (!window.meetingsManager) return;
      
      const file = event.target.files?.[0];
      if (!file) return;
      
      const meetingId = document.getElementById('notes-meeting-select').value;
      if (!meetingId) {
        alert('Please select a meeting first');
        event.target.value = '';
        return;
      }
      
      const statusDiv = document.getElementById('pdf-status');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<p style="margin: 0; color: #0369a1;">🎙️ Processing recording...</p>';
      
      try {
        // Upload file
        const url = await window.meetingsManager.uploadMeetingRecording(meetingId, file);
        
        // Transcribe with meeting ID
        const transcript = await window.meetingsManager.transcribeRecording(file, meetingId);
        
        // Add to notes
        const currentNotes = document.getElementById('meeting-notes-textarea').value;
        document.getElementById('meeting-notes-textarea').value = 
          currentNotes + (currentNotes ? '\n\n' : '') + transcript;
        
        statusDiv.innerHTML = '<p style="margin: 0; color: #16a34a;">✅ Recording processed successfully!</p>';
        setTimeout(() => { statusDiv.style.display = 'none'; }, 2500);
      } catch (e) {
        console.error(e);
        statusDiv.innerHTML = '<p style="margin: 0; color: #dc2626;">❌ Error processing recording</p>';
      }
    }

    // Load meeting history
    async function loadMeetingHistory() {
      if (!window.meetingsManager) return;
      
      const historyList = document.getElementById('meeting-history-list');
      const pastMeetings = await window.meetingsManager.getPastMeetings();
      
      if (pastMeetings.length === 0) {
        historyList.innerHTML = '<p style="color: #6b7280;">No past meetings</p>';
        return;
      }
      
      historyList.innerHTML = pastMeetings.map(meeting => {
        const date = new Date(meeting.start);
        const status = meeting.status || 'completed';
        return `
          <div class="meeting-history-item" onclick="viewMeetingNotes('${meeting.id}')">
            <h4>${meeting.title}
              <span class="meeting-status ${status}">${status}</span>
            </h4>
            <p>${meeting.description || 'No description'}</p>
            <small style="color: #6b7280;">
              ${date.toLocaleDateString()} at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
              • ${meeting.location || 'No location'}
            </small>
          </div>
        `;
      }).join('');
    }

    // View meeting notes from history
    async function viewMeetingNotes(meetingId) {
      switchTab('notes');
      const sel = document.getElementById('notes-meeting-select');
      if (sel) {
        // Add option if not present
        const meetings = await window.meetingsManager.getMeetings();
        const meeting = meetings.find(m => m.id === meetingId);
        if (meeting && !Array.from(sel.options).find(o => o.value === meetingId)) {
          const option = document.createElement('option');
          option.value = meetingId;
          option.text = `${meeting.title} - ${new Date(meeting.start).toLocaleDateString()}`;
          sel.add(option);
        }
        sel.value = meetingId;
        loadMeetingNotes();
      }
    }

    // Update statistics
    async function updateStats() {
      if (!window.meetingsManager) return;
      
      const stats = await window.meetingsManager.getMeetingStats();
      
      document.getElementById('stat-total').textContent = stats.total;
      document.getElementById('stat-upcoming').textContent = stats.upcoming;
      document.getElementById('stat-past').textContent = stats.past;
      document.getElementById('stat-month').textContent = stats.thisMonth;
    }

    // Make functions globally available
    window.switchTab = switchTab;
    window.showMeetingDetails = showMeetingDetails;
    window.closeMeetingModal = closeMeetingModal;
    window.openCreateMeetingModal = openCreateMeetingModal;
    window.closeCreateMeetingModal = closeCreateMeetingModal;
    window.createMeeting = createMeeting;
    window.updateAttendance = updateAttendance;
    window.deleteMeeting = deleteMeeting;
    window.submitAgendaItem = submitAgendaItem;
    window.deleteAgendaItem = deleteAgendaItem;
    window.loadMeetingNotes = loadMeetingNotes;
    window.saveMeetingNotes = saveMeetingNotes;
    window.generateMeetingPDF = generateMeetingPDF;
    window.handleRecordingUpload = handleRecordingUpload;
    window.viewMeetingNotes = viewMeetingNotes;
    window.initializeMeetings = initializeMeetings;
    
    // Microphone Recording Functions
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = null;
    let recordingTimer = null;
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let animationId = null;
    
    async function startRecording() {
      try {
        // Request microphone permission
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          } 
        });
        
        // Create MediaRecorder
        mediaRecorder = new MediaRecorder(stream, {
          mimeType: 'audio/webm;codecs=opus'
        });
        
        audioChunks = [];
        
        // Set up audio visualization
        setupAudioVisualization(stream);
        
        // Handle data available
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };
        
        // Handle recording stop
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const audioUrl = URL.createObjectURL(audioBlob);
          
          // Show playback controls
          const audioElement = document.getElementById('recorded-audio');
          audioElement.src = audioUrl;
          document.getElementById('recorded-audio-container').style.display = 'block';
          
          // Store blob for upload
          window.currentRecordingBlob = audioBlob;
          
          // Stop visualization
          if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
          }
          
          // Clean up audio context
          if (audioContext) {
            audioContext.close();
            audioContext = null;
          }
        };
        
        // Start recording
        mediaRecorder.start(1000); // Collect data every second
        recordingStartTime = Date.now();
        
        // Update UI
        document.getElementById('start-recording').style.display = 'none';
        document.getElementById('stop-recording').style.display = 'flex';
        document.getElementById('pause-recording').style.display = 'block';
        document.getElementById('recording-timer').style.display = 'block';
        document.getElementById('audio-visualizer').style.display = 'block';
        
        // Start timer
        updateRecordingTimer();
        
      } catch (error) {
        console.error('Error starting recording:', error);
        alert('Unable to access microphone. Please check your permissions.');
      }
    }
    
    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        
        // Stop all tracks
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        // Clear timer
        if (recordingTimer) {
          clearInterval(recordingTimer);
          recordingTimer = null;
        }
        
        // Reset UI
        document.getElementById('start-recording').style.display = 'flex';
        document.getElementById('stop-recording').style.display = 'none';
        document.getElementById('pause-recording').style.display = 'none';
        document.getElementById('recording-timer').style.display = 'none';
        document.getElementById('audio-visualizer').style.display = 'none';
      }
    }
    
    function pauseRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.pause();
        document.getElementById('pause-recording').textContent = 'Resume';
        document.getElementById('pause-recording').onclick = resumeRecording;
      }
    }
    
    function resumeRecording() {
      if (mediaRecorder && mediaRecorder.state === 'paused') {
        mediaRecorder.resume();
        document.getElementById('pause-recording').textContent = 'Pause';
        document.getElementById('pause-recording').onclick = pauseRecording;
      }
    }
    
    function updateRecordingTimer() {
      recordingTimer = setInterval(() => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
          const seconds = (elapsed % 60).toString().padStart(2, '0');
          document.getElementById('recording-time').textContent = `${minutes}:${seconds}`;
        }
      }, 1000);
    }
    
    function setupAudioVisualization(stream) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioContext.createAnalyser();
      microphone = audioContext.createMediaStreamSource(stream);
      
      analyser.fftSize = 256;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      
      microphone.connect(analyser);
      
      const canvas = document.getElementById('audio-visualizer');
      const canvasCtx = canvas.getContext('2d');
      
      function draw() {
        animationId = requestAnimationFrame(draw);
        
        analyser.getByteFrequencyData(dataArray);
        
        canvasCtx.fillStyle = '#f3f4f6';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        
        const barWidth = (canvas.width / bufferLength) * 2.5;
        let barHeight;
        let x = 0;
        
        for (let i = 0; i < bufferLength; i++) {
          barHeight = (dataArray[i] / 255) * canvas.height;
          
          // Use gradient colors
          const gradient = canvasCtx.createLinearGradient(0, canvas.height, 0, 0);
          gradient.addColorStop(0, '#ef4444');
          gradient.addColorStop(0.5, '#f59e0b');
          gradient.addColorStop(1, '#10b981');
          
          canvasCtx.fillStyle = gradient;
          canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
          
          x += barWidth + 1;
        }
      }
      
      draw();
    }
    
    async function saveRecording() {
      if (!window.currentRecordingBlob) {
        alert('No recording to save');
        return;
      }
      
      const meetingId = document.getElementById('notes-meeting-select').value;
      if (!meetingId) {
        alert('Please select a meeting first');
        return;
      }
      
      // Create a File object from the blob
      const file = new File([window.currentRecordingBlob], `recording_${Date.now()}.webm`, {
        type: 'audio/webm'
      });
      
      // Use existing upload handler
      const event = {
        target: {
          files: [file]
        }
      };
      
      await handleRecordingUpload(event);
      
      // Clear the recording
      discardRecording();
    }
    
    function discardRecording() {
      window.currentRecordingBlob = null;
      document.getElementById('recorded-audio-container').style.display = 'none';
      document.getElementById('recorded-audio').src = '';
    }
    
    // Make recording functions globally available
    window.startRecording = startRecording;
    window.stopRecording = stopRecording;
    window.pauseRecording = pauseRecording;
    window.resumeRecording = resumeRecording;
    window.saveRecording = saveRecording;
    window.discardRecording = discardRecording;
  </script>

  <script>
    // Minimal icons8 loader for any data-i8 icons
    (function(){
      function i8(name, opts){
        opts = opts || {}; var style = opts.style || 'fluency';
        var size = (opts.size == null) ? 48 : opts.size; var base = 'https://img.icons8.com';
        var path = [style, String(size||48), encodeURIComponent(name)+'.png'].join('/');
        return base + '/' + path;
      }
      function setIcon(el){
        var name = el.getAttribute('data-i8'); var size = el.getAttribute('data-i8-size');
        var style = el.getAttribute('data-i8-style') || 'fluency';
        var url = i8(name, {style, size: size ? parseInt(size,10) : undefined});
        el.src = url; if (!el.alt) el.alt = (name||'').replace(/[\-\_]/g,' ');
      }
      function wire(){ document.querySelectorAll('img[data-i8]').forEach(setIcon); }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', wire); else wire();
    })();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — My Scans</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="admin-nav.js"></script>
  <script src="user-utils.js"></script>
  <link rel="stylesheet" href="staff.css">
  <script src="fix-navigation-style.js"></script>
  <style>
    /* Modern My Scans styles */
    .scans-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .scans-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    .scan-card {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .scan-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent-gradient);
      border-radius: 16px 16px 0 0;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 800;
      color: var(--white);
      margin: 0;
    }

    .card-subtitle {
      font-size: 14px;
      color: var(--muted);
      margin: 4px 0 0 0;
    }

    /* Stats Card */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: 900;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
      transition: transform 0.3s ease;
    }

    .stat-label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-item:hover .stat-number {
      transform: scale(1.1);
    }

    /* Recent Scans */
    .recent-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .recent-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      transition: all 0.2s ease;
    }

    .recent-item:hover {
      background: rgba(255, 255, 255, 0.06);
      transform: translateY(-1px);
    }

    .recent-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      flex-shrink: 0;
    }

    .recent-content {
      flex: 1;
    }

    .recent-title {
      font-weight: 600;
      color: var(--white);
      margin: 0 0 2px 0;
      font-size: 14px;
    }

    .recent-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .recent-time {
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
    }

    /* Upcoming Work */
    .upcoming-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .upcoming-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      transition: all 0.2s ease;
    }

    .upcoming-item:hover {
      background: rgba(255, 255, 255, 0.06);
      transform: translateY(-1px);
    }

    .upcoming-item.overdue {
      border-color: rgba(239, 68, 68, 0.3);
      background: rgba(239, 68, 68, 0.08);
    }

    .upcoming-item.due-soon {
      border-color: rgba(245, 158, 11, 0.3);
      background: rgba(245, 158, 11, 0.08);
    }

    .priority-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .priority-dot.overdue {
      background: #ef4444;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
    }

    .priority-dot.due-soon {
      background: #f59e0b;
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
    }

    .priority-dot.normal {
      background: #64748b;
    }

    .upcoming-content {
      flex: 1;
    }

    .upcoming-title {
      font-weight: 700;
      color: var(--white);
      margin: 0 0 4px 0;
      font-size: 15px;
    }

    .upcoming-meta {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .upcoming-due {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      display: inline-block;
    }

    .upcoming-due.overdue {
      background: rgba(239, 68, 68, 0.2);
      color: #fecaca;
    }

    .upcoming-due.due-soon {
      background: rgba(245, 158, 11, 0.2);
      color: #fde68a;
    }

    .upcoming-due.normal {
      background: rgba(59, 130, 246, 0.2);
      color: #bfdbfe;
    }

    .start-btn {
      padding: 8px 16px;
      border-radius: 8px;
      background: linear-gradient(135deg, #4338ca, #3b82f6);
      color: white;
      border: none;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .start-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* Empty states */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.6;
    }

    /* Action buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .action-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--white);
      border: 1px solid var(--border-color);
    }

    .action-btn:hover {
      transform: translateY(-1px);
    }

    .action-btn.primary:hover {
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    /* Animations */
    .scan-card {
      animation: slideUp 0.6s ease-out;
    }

    .scan-card:nth-child(1) { animation-delay: 0.1s; }
    .scan-card:nth-child(2) { animation-delay: 0.2s; }
    .scan-card:nth-child(3) { animation-delay: 0.3s; }
    .scan-card:nth-child(4) { animation-delay: 0.4s; }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .pulse {
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Loading animations */
    .loading-shimmer {
      background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
  </style>
</head>
<body style="visibility: hidden;">
  <div class="bg"><div class="wave"></div><div class="wave wave2"></div></div>
  <main class="content">
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav"></div>
      <div class="spacer"></div>
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>

    <section class="panel g-12" style="margin:0; position:relative; overflow:visible;">
      <div class="halo"></div>

      <div class="hero" style="margin-bottom:24px;">
        <div>
          <div class="h1" style="font-size:28px;">My Scans 📱</div>
          <div class="subtitle">Your scanning activity and upcoming work at a glance</div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="action-btn primary" id="start-scan-btn">
          <span>🚀</span>
          Start New Scan
        </button>
        <button class="action-btn secondary" id="view-all-btn">
          <span>📊</span>
          View All History
        </button>
      </div>

      <div class="scans-grid">
        <!-- Today's Progress -->
        <div class="scan-card">
          <div class="card-header">
            <div class="card-icon">📈</div>
            <div>
              <h3 class="card-title">Today's Progress</h3>
              <p class="card-subtitle">Your scanning activity</p>
            </div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-number" id="scans-today">0</div>
              <div class="stat-label">Scans Completed</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="items-checked">0</div>
              <div class="stat-label">Items Checked</div>
            </div>
          </div>
          
          <div style="margin-top: 16px; font-size: 13px; color: var(--muted);" id="progress-message">
            Great work! Keep it up! 🌟
          </div>
        </div>

        <!-- Recent Scans -->
        <div class="scan-card">
          <div class="card-header">
            <div class="card-icon">⏰</div>
            <div>
              <h3 class="card-title">Recent Scans</h3>
              <p class="card-subtitle">Your latest activity</p>
            </div>
          </div>
          
          <div class="recent-list" id="recent-scans">
            <div class="loading-shimmer" style="height: 60px; border-radius: 12px;"></div>
            <div class="loading-shimmer" style="height: 60px; border-radius: 12px;"></div>
            <div class="loading-shimmer" style="height: 60px; border-radius: 12px;"></div>
          </div>
        </div>

        <!-- Upcoming Work -->
        <div class="scan-card">
          <div class="card-header">
            <div class="card-icon">📋</div>
            <div>
              <h3 class="card-title">Upcoming Work</h3>
              <p class="card-subtitle">Items due soon</p>
            </div>
          </div>
          
          <div class="upcoming-list" id="upcoming-work">
            <div class="loading-shimmer" style="height: 70px; border-radius: 12px;"></div>
            <div class="loading-shimmer" style="height: 70px; border-radius: 12px;"></div>
            <div class="loading-shimmer" style="height: 70px; border-radius: 12px;"></div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="scan-card">
          <div class="card-header">
            <div class="card-icon">🎯</div>
            <div>
              <h3 class="card-title">Quick Stats</h3>
              <p class="card-subtitle">This week's overview</p>
            </div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-number" id="week-total">0</div>
              <div class="stat-label">This Week</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="items-due">0</div>
              <div class="stat-label">Due Soon</div>
            </div>
          </div>
          
          <div style="margin-top: 16px;">
            <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
              <div id="week-progress-bar" style="height: 100%; background: var(--accent-gradient); width: 0%; transition: width 1s ease;"></div>
            </div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 8px; text-align: center;" id="week-progress-text">
              Loading...
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="muted" style="text-align:center; font-size:12px; padding:10px 0;">© CheckLoop • Staff</div>
  </main>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, fmtDate, clearAuthData, createAchievementClient, attachLogout } from './staff-common.js';

    const supabase = await initSupabase();
    window.supabase = supabase;
  handleAuthState(supabase);
  navActivate('scans');
  attachLogout(supabase);

    let currentUser = null;
    let currentProfile = null;
    let achievementClient = null;

    // Logout now handled by attachLogout(supabase)

    // Utility functions
    function formatTimeAgo(date) {
      const now = new Date();
      const diff = now - new Date(date);
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days === 1) return 'Yesterday';
      if (days < 7) return `${days}d ago`;
      return new Date(date).toLocaleDateString();
    }

    function animateNumber(element, targetValue) {
      const startValue = parseInt(element.textContent) || 0;
      const increment = (targetValue - startValue) / 20;
      let current = startValue;
      
      const timer = setInterval(() => {
        current += increment;
        if (increment > 0 ? current >= targetValue : current <= targetValue) {
          element.textContent = targetValue;
          clearInterval(timer);
        } else {
          element.textContent = Math.floor(current);
        }
      }, 50);
    }

    // Load user's scan data
    async function loadScanData() {
      try {
        // Get user's recent submissions
        const { data: userSubmissions, error: submissionsError } = await supabase
          .from('submissions')
          .select('id, submitted_at, staff_name, comment')
          .eq('submitted_by_user_id', currentUser.id)
          .order('submitted_at', { ascending: false })
          .limit(50);

        if (submissionsError) {
          console.error('Error loading submissions:', submissionsError);
          return;
        }

        const submissions = userSubmissions || [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

        // Get submission details
        let scanDetails = [];
        if (submissions.length > 0) {
          const submissionIds = submissions.map(s => s.id);
          const { data: submissionRows } = await supabase
            .from('submission_rows')
            .select('submission_id, item_id, check_type, check_value')
            .in('submission_id', submissionIds);

          if (submissionRows) {
            const itemIds = [...new Set(submissionRows.map(r => r.item_id))];
            const { data: itemDetails } = await supabase
              .from('items')
              .select('item_id, item_name, room')
              .in('item_id', itemIds);

            const itemsMap = new Map();
            (itemDetails || []).forEach(item => itemsMap.set(item.item_id, item));

            const submissionsMap = new Map();
            submissions.forEach(sub => submissionsMap.set(sub.id, sub));

            scanDetails = submissionRows.map(row => {
              const submission = submissionsMap.get(row.submission_id);
              const item = itemsMap.get(row.item_id) || {};
              return {
                submitted_at: submission?.submitted_at,
                item_name: item.item_name || `Item ${row.item_id}`,
                room: item.room || '—',
                check_type: row.check_type || '—',
                check_value: row.check_value || 'Done'
              };
            }).sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at));
          }
        }

        // Calculate stats
        const todaySubmissions = submissions.filter(s => new Date(s.submitted_at) >= today);
        const weekSubmissions = submissions.filter(s => new Date(s.submitted_at) >= weekAgo);
        const todayScans = todaySubmissions.length;
        const todayItems = scanDetails.filter(s => new Date(s.submitted_at) >= today).length;
        const weekTotal = weekSubmissions.length;

        // Animate counters
        setTimeout(() => {
          animateNumber(document.getElementById('scans-today'), todayScans);
          animateNumber(document.getElementById('items-checked'), todayItems);
          animateNumber(document.getElementById('week-total'), weekTotal);
        }, 500);

        // Update progress message
        const progressMessage = document.getElementById('progress-message');
        if (todayScans === 0) {
          progressMessage.textContent = "Ready to start your day! 💪";
        } else if (todayScans < 3) {
          progressMessage.textContent = "Great start! Keep going! 🚀";
        } else if (todayScans < 10) {
          progressMessage.textContent = "You're on fire! 🔥";
        } else {
          progressMessage.textContent = "Amazing work today! 🏆";
        }

        // Load recent scans
        loadRecentScans(scanDetails.slice(0, 5));

        // Load upcoming work
        loadUpcomingWork();

        // Update week progress
        const weekProgress = Math.min(100, (weekTotal / 20) * 100);
        setTimeout(() => {
          document.getElementById('week-progress-bar').style.width = `${weekProgress}%`;
          document.getElementById('week-progress-text').textContent = `${weekTotal} scans this week`;
        }, 1000);

        if (achievementClient) {
          try {
            await achievementClient.ensureUnlocked('scan_sprinter', {
              condition: weekTotal >= 10,
              metadata: { weekTotal, todayScans, source: 'staff_scans' }
            });
          } catch (err) {
            console.warn('[my-scans] scan_sprinter unlock failed', err);
          }
        }

      } catch (error) {
        console.error('Error loading scan data:', error);
      }
    }

    function loadRecentScans(recentScans) {
      const container = document.getElementById('recent-scans');
      
      if (!recentScans || recentScans.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">📱</div>
            <div>No recent scans</div>
            <div style="font-size: 13px; margin-top: 8px;">Start scanning to see your activity here!</div>
          </div>
        `;
        return;
      }

      container.innerHTML = recentScans.map(scan => `
        <div class="recent-item">
          <div class="recent-dot"></div>
          <div class="recent-content">
            <div class="recent-title">${scan.item_name} • ${scan.check_type}</div>
            <div class="recent-meta">${scan.room} • ${scan.check_value}</div>
          </div>
          <div class="recent-time">${formatTimeAgo(scan.submitted_at)}</div>
        </div>
      `).join('');
    }

    async function loadUpcomingWork() {
      try {
        // This would load from your scheduling system
        // For now, showing placeholder data
        const container = document.getElementById('upcoming-work');
        const itemsDueElement = document.getElementById('items-due');

        // Simulate some upcoming work
        const mockUpcoming = [
          { name: 'Fire Extinguisher Check', room: 'Kitchen', dueDate: new Date(Date.now() + 86400000), priority: 'normal' },
          { name: 'First Aid Kit Inspection', room: 'Reception', dueDate: new Date(Date.now() + 3600000 * 4), priority: 'due-soon' },
          { name: 'Emergency Lighting Test', room: 'Corridor A', dueDate: new Date(Date.now() - 3600000), priority: 'overdue' }
        ];

        const dueSoonCount = mockUpcoming.filter(item => item.priority !== 'normal').length;
        setTimeout(() => {
          animateNumber(itemsDueElement, dueSoonCount);
        }, 800);

        if (mockUpcoming.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">✅</div>
              <div>All caught up!</div>
              <div style="font-size: 13px; margin-top: 8px;">No upcoming work scheduled</div>
            </div>
          `;
          return;
        }

        container.innerHTML = mockUpcoming.map(item => {
          const now = new Date();
          const diff = item.dueDate - now;
          let dueText = '';
          
          if (diff < 0) {
            const hours = Math.abs(Math.floor(diff / 3600000));
            dueText = `Overdue ${hours}h`;
          } else if (diff < 86400000) {
            const hours = Math.floor(diff / 3600000);
            dueText = `Due in ${hours}h`;
          } else {
            const days = Math.floor(diff / 86400000);
            dueText = `Due in ${days}d`;
          }

          return `
            <div class="upcoming-item ${item.priority}">
              <div class="priority-dot ${item.priority}"></div>
              <div class="upcoming-content">
                <div class="upcoming-title">${item.name}</div>
                <div class="upcoming-meta">${item.room}</div>
                <div class="upcoming-due ${item.priority}">${dueText}</div>
              </div>
              <button class="start-btn" onclick="startScan('${item.name}')">Start</button>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading upcoming work:', error);
        const container = document.getElementById('upcoming-work');
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">⚠️</div>
            <div>Unable to load upcoming work</div>
          </div>
        `;
      }
    }

    // Global function for starting scans
    window.startScan = function(itemName) {
      // Navigate to scanner with pre-selected item
      window.location.href = `scan.html?item=${encodeURIComponent(itemName)}`;
    };

    // Button event listeners
    document.getElementById('start-scan-btn').addEventListener('click', () => {
      // Try to find a scanner page
      const scannerPages = ['scan.html', 'scanner.html', 'staff-scan.html'];
      for (const page of scannerPages) {
        try {
          window.location.href = page;
          return;
        } catch (e) {
          console.log(`Scanner page ${page} not found`);
        }
      }
      // Fallback
      alert('Scanner not available. Contact your administrator.');
    });

    document.getElementById('view-all-btn').addEventListener('click', () => {
      // Navigate back to full scans view or history
      window.location.href = 'staff-scans-full.html';
    });

    // Initialize the page
    requireStaffSession(supabase).then(async ({ session, profileRow }) => {
      // Auth successful - show page
      document.body.style.visibility = 'visible';
      
      currentUser = session.user;
      currentProfile = profileRow;

      try {
        achievementClient = await createAchievementClient({
          supabase,
          session,
          profile: profileRow,
          showToasts: false
        });
      } catch (err) {
        console.warn('[my-scans] achievement client init failed', err);
      }

      const siteId = currentProfile?.site_id || null;
      const accessType = currentProfile?.access_type || currentUser?.raw_user_meta_data?.access_type || null;
      const role = (accessType || currentProfile?.role || 'staff');

      setTopbar({ 
        siteText: await getSiteText(supabase, siteId), 
        email: currentUser.email, 
        role, 
        access_type: accessType || currentProfile?.role 
      });

      // Load the scan data
      await loadScanData();

    }).catch(e => {
      console.error('[my-scans] auth failed', e);
      if (String(e.message).includes('NO_SESSION')) {
        window.location.replace('home.html');
        return;
      }
      if (String(e.message).includes('NOT_STAFF')) {
        window.location.replace('home.html');
        return;
      }
    });
  </script>
<!-- Staff Profile Fix -->
<script src="staff-profile-fix.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — My Scans</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://img.icons8.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="admin-nav.js"></script>
  <script src="user-utils.js"></script>
  <link rel="stylesheet" href="staff.css">
  
  
  <style>
    /* Scan-specific styles */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent-gradient);
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 8px;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: rgba(248,251,255,0.9);
      font-weight: 600;
    }
    
    .filters-panel {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      align-items: end;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .filter-label {
      font-size: 0.875rem;
      font-weight: 700;
      color: rgba(248,251,255,0.9);
    }
    
    .filter-input {
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      font-size: 14px;
      background: rgba(255,255,255,0.02);
      color: rgba(248,251,255,0.95);
      transition: border-color 0.2s ease;
    }
    .filter-input::placeholder{ color: rgba(248,251,255,0.55); }
    
    .filter-input:focus {
      outline: none;
      border-color: #4f89ff;
      box-shadow: 0 0 0 3px rgba(79, 137, 255, 0.1);
    }
    
    .filter-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    
    .filter-btn {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: rgba(255,255,255,0.03);
      color: var(--white);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .filter-btn:hover {
      background: rgba(255,255,255,0.06);
    }
    
    .filter-btn.active {
      background: #4f89ff;
      color: white;
      border-color: #4f89ff;
    }
    
    .scans-table {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .table-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: transparent;
    }
    
    .table-title {
      font-weight: 800;
      color: rgba(248,251,255,0.95);
      font-size: 1.05rem;
    }
    
    .table-actions {
      display: flex;
      gap: 8px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      text-align: left;
      padding: 12px 16px;
      background: transparent;
      font-weight: 700;
      color: rgba(248,251,255,0.88);
      border-bottom: 1px solid rgba(255,255,255,0.04);
      cursor: pointer;
      user-select: none;
    }
    
    .data-table th:hover {
      background: rgba(255,255,255,0.03);
    }
    
    .data-table th.sortable::after {
      content: '↕';
      margin-left: 8px;
      opacity: 0.5;
    }
    
    .data-table th.sort-asc::after {
      content: '↑';
      opacity: 1;
    }
    
    .data-table th.sort-desc::after {
      content: '↓';
      opacity: 1;
    }
    
    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      color: rgba(248,251,255,0.85);
    }
    
    .data-table tr:hover {
      background: rgba(255,255,255,0.03);
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-valid {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .status-invalid {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .status-pending {
      background: #fef3c7;
      color: #d97706;
    }
    
    .chart-container {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .chart-title {
      font-weight: 700;
      margin-bottom: 16px;
      color: rgba(248,251,255,0.92);
    }
    
    /* Line chart styles */
    .chart {
      height: 220px;
      position: relative;
      display: block;
      padding: 8px 12px 28px 12px; /* extra bottom space for labels */
    }

    .chart-svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .chart-grid line {
      stroke: rgba(15,23,42,0.06);
      stroke-width: 1;
    }

    .chart-area {
      fill: url(#grad-area);
      opacity: 0.18;
    }

    .chart-line {
      fill: none;
      stroke: url(#grad-line);
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 6px 12px rgba(79,137,255,0.12));
    }

    .chart-point {
      fill: #fff;
      stroke: #4f89ff;
      stroke-width: 2;
      r: 4;
      transition: transform 120ms ease;
      cursor: default;
    }

    .chart-point:hover { transform: scale(1.25); }

    .chart-xlabel {
      font-size: 0.75rem;
      fill: rgba(248,251,255,0.7);
      text-anchor: middle;
    }

    .chart-value-label {
      font-size: 0.75rem;
      fill: rgba(248,251,255,0.9);
      text-anchor: middle;
      font-weight: 700;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(248,251,255,0.7);
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      padding: 20px;
    }
    
    .pagination-btn {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: rgba(255,255,255,0.03);
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .pagination-btn:hover:not(:disabled) {
      background: #f8fafc;
    }
    
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination-btn.active {
      background: #4f89ff;
      color: white;
      border-color: #4f89ff;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #4f89ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="bg"><div class="wave"></div><div class="wave wave2"></div></div>
  <main class="content">
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav">
        <!-- Navigation will be rendered by staff-common.js -->
      </div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: —</div>
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>

    <section class="panel g-12" style="margin:0; position:relative; overflow:hidden;">
      <div class="halo"></div>
      
      <div class="hero" style="margin-bottom: 20px;">
        <div>
          <div class="h1" style="font-size:28px;">My Scans</div>
          <div class="subtitle">View and analyze your submission history</div>
        </div>
        <div class="spacer"></div>
        <div class="bubble-actions">
          <button class="bubble" id="export-btn">
            <div class="i c-green"><img data-i8="download" data-i8-size="48" alt="Export"/></div>
            <div class="t">Export</div>
          </button>
          <button class="bubble" id="refresh-btn">
            <div class="i c-blue"><img data-i8="synchronize" data-i8-size="48" alt="Refresh"/></div>
            <div class="t">Refresh</div>
          </button>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="total-scans">0</div>
          <div class="stat-label">Total Scans</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="valid-scans">0</div>
          <div class="stat-label">Valid Scans</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="completion-rate">0%</div>
          <div class="stat-label">Completion Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="this-week">0</div>
          <div class="stat-label">This Week</div>
        </div>
      </div>

      <!-- Chart -->
      <div class="chart-container">
        <div class="chart-title">Scans Over Time (Last 7 Days)</div>
        <div class="chart" id="scans-chart">
          <!-- Chart bars will be generated by JavaScript -->
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-panel">
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label" for="search-input">Search</label>
            <input type="text" id="search-input" class="filter-input" placeholder="Search items, rooms, or comments...">
          </div>
          <div class="filter-group">
            <label class="filter-label" for="date-from">From Date</label>
            <input type="date" id="date-from" class="filter-input">
          </div>
          <div class="filter-group">
            <label class="filter-label" for="date-to">To Date</label>
            <input type="date" id="date-to" class="filter-input">
          </div>
          <div class="filter-group">
            <label class="filter-label" for="room-filter">Room</label>
            <select id="room-filter" class="filter-input">
              <option value="">All Rooms</option>
            </select>
          </div>
        </div>
        <div class="filter-buttons">
          <button class="filter-btn active" data-status="all">All Status</button>
          <button class="filter-btn" data-status="valid">Valid Only</button>
          <button class="filter-btn" data-status="invalid">Issues Only</button>
          <button class="filter-btn" id="clear-filters">Clear Filters</button>
        </div>
      </div>

      <!-- Table -->
      <div class="scans-table">
        <div class="table-header">
          <div class="table-title">Scan History</div>
          <div class="table-actions">
            <span id="results-count" class="muted">Loading...</span>
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="submitted_at">Date</th>
                <th class="sortable" data-sort="item_name">Item</th>
                <th class="sortable" data-sort="room">Room</th>
                <th class="sortable" data-sort="check_type">Check Type</th>
                <th class="sortable" data-sort="check_value">Result</th>
                <th>Comment</th>
              </tr>
            </thead>
            <tbody id="scans-tbody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                  <div class="loading-spinner"></div>
                  <div style="margin-top: 10px;">Loading scans...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="pagination" style="display: none;">
          <!-- Pagination will be generated by JavaScript -->
        </div>
      </div>
    </section>

    <div class="muted" style="text-align:center; font-size:12px; padding:10px 0;">© CheckLoop • Staff</div>
  </main>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, fmtDate, clearAuthData } from './staff-common.js';
    

    const supabase = await initSupabase();
    // Make supabase available globally for Admin Portal button
    window.supabase = supabase;
    handleAuthState(supabase);
    navActivate('scans');
    // Admin nav removed - separate staff portal

    let currentUser = null;
    let currentProfile = null;
    let allScans = [];
    let filteredScans = [];
    let currentPage = 1;
    let itemsPerPage = 20;
    let currentSort = { field: 'submitted_at', direction: 'desc' };

    // Logout handling
    let isLoggingOut = false;
    function cleanupAndRedirect() {
      try { clearAuthData(true); } catch(_) {}
      try { sessionStorage.clear(); } catch(_) {}
      try { document.cookie.split(';').forEach(c => document.cookie = c.replace(/^ +/, '').replace(/=.*/, `=;expires=${new Date(0).toUTCString()};path=/`)); } catch(_) {}
      window.location.replace('home.html?_=' + Date.now());
    }
    async function forceLogout() {
      if (isLoggingOut) return;
      isLoggingOut = true;
      try { const { data } = await supabase.auth.getSession(); if (data?.session) await supabase.auth.signOut(); } catch (e) { console.error('Supabase signOut failed:', e); }
      cleanupAndRedirect();
    }
    document.getElementById('logout-btn').addEventListener('click', async (e) => { e.preventDefault(); e.stopPropagation(); await forceLogout(); });

    // Initialize the dashboard
    requireStaffSession(supabase).then(async ({ session, profileRow }) => {
      currentUser = session.user;
      currentProfile = profileRow;
      console.log('[staff-scans] Authentication successful:', {
        email: currentUser.email,
        profileRow: profileRow
      });
      await loadDashboard();
    }).catch(e => {
      console.error('[staff-scans] Authentication failed:', e.message);
      if (String(e.message).includes('NO_SESSION')) { window.location.replace('home.html'); return; }
      if (String(e.message).includes('NOT_STAFF')) { window.location.replace('home.html'); return; }
      console.error(e);
    });

    async function loadDashboard() {
      // Build user profile from currentUser and currentProfile
      const userProfile = {
        user_id: currentUser.id,
        email: currentUser.email,
        display_name: currentProfile?.full_name || currentUser.email.split('@')[0],
        site_id: currentProfile?.site_id || null,
        role: currentProfile?.role || 'staff'
      };

      console.log('[staff-scans] User profile:', userProfile);

      const displayName = userProfile.display_name;
      const siteId = userProfile.site_id;
      const role = userProfile.role;

      // Set topbar with actual user email
      setTopbar({
        siteText: await getSiteText(supabase, siteId),
        email: userProfile.email,  // Use actual email from userProfile
        role: role.charAt(0).toUpperCase() + role.slice(1)
      });

      // Load scan data
      await loadScans(userProfile);
      
      // Setup event listeners
      setupEventListeners();
    }

    async function loadScans(userProfile) {
      const displayName = userProfile.display_name;
      const siteId = userProfile.site_id;
      console.log('Loading scans for user:', {
        user_id: userProfile.user_id,
        display_name: displayName,
        site_id: siteId
      });
      try {
        let rows = [];
        
        // Query submissions directly (v_submission_detail might not exist or have the columns we need)
        console.log('Querying submissions table...');

          // Try submitted_by_user_id first
          let { data, error } = await supabase
            .from('submissions')
            .select('submitted_at, staff_name, comment, submitted_by_user_id, user_id, staff_id')
            .eq('submitted_by_user_id', userProfile.user_id)
            .order('submitted_at', { ascending: false })
            .limit(200);

          // If no results, try user_id
          if (!data || data.length === 0) {
            console.log('No results with submitted_by_user_id in submissions table, trying user_id...');
            const result = await supabase
              .from('submissions')
              .select('submitted_at, staff_name, comment, submitted_by_user_id, user_id, staff_id')
              .eq('user_id', userProfile.user_id)
              .order('submitted_at', { ascending: false })
              .limit(200);
            data = result.data;
            error = result.error;
          }

          if (error) {
            console.error('Error querying submissions:', error);
          } else if (data) {
            console.log('Submissions query results:', data?.length || 0, 'rows');
            if (data?.length > 0) {
              console.log('First submission:', data[0]);
            }
            rows = data.map(r => ({
              submitted_at: r.submitted_at,
              item_name: '—',
              room: '—',
              check_type: '—',
              check_value: r.comment || 'Done',
              comment: r.comment
            }));
          }

        allScans = rows;
        filteredScans = [...allScans];
        
        // Update statistics
        updateStatistics();
        
        // Generate chart
        generateChart();
        
        // Populate room filter
        populateRoomFilter();
        
        // Render table
        renderTable();
        
      } catch (error) {
        console.error('Error loading scans:', error);
        document.getElementById('results-count').textContent = 'Error loading data';
      }
    }

    function updateStatistics() {
      const total = allScans.length;
      const valid = allScans.filter(scan => !isInvalidScan(scan)).length;
      const completionRate = total > 0 ? Math.round((valid / total) * 100) : 0;
      
      // Calculate this week's scans
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
      const thisWeek = allScans.filter(scan => new Date(scan.submitted_at) >= oneWeekAgo).length;
      
      document.getElementById('total-scans').textContent = total;
      document.getElementById('valid-scans').textContent = valid;
      document.getElementById('completion-rate').textContent = `${completionRate}%`;
      document.getElementById('this-week').textContent = thisWeek;
    }

    function isInvalidScan(scan) {
      const value = (scan.check_value || '').toLowerCase();
      return value.includes('fail') || value.includes('error') || value.includes('invalid') || value.includes('missing');
    }

    function generateChart() {
      const chartContainer = document.getElementById('scans-chart');
      chartContainer.innerHTML = '';
      
      // Create data for last 7 days
      const days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date);
      }
      
      const chartData = days.map(day => {
        const dayStart = new Date(day);
        dayStart.setHours(0, 0, 0, 0);
        const dayEnd = new Date(day);
        dayEnd.setHours(23, 59, 59, 999);
        
        const count = allScans.filter(scan => {
          const scanDate = new Date(scan.submitted_at);
          return scanDate >= dayStart && scanDate <= dayEnd;
        }).length;
        
        return {
          date: day,
          count: count,
          label: day.toLocaleDateString('en-US', { weekday: 'short' })
        };
      });
      
      const maxCount = Math.max(...chartData.map(d => d.count), 1);

      // Build an SVG line chart
      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('class', 'chart-svg');

      const width = chartContainer.clientWidth || 600;
      const height = chartContainer.clientHeight || 220;
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

      // Padding within svg for axes
      const pad = { top: 12, right: 16, bottom: 36, left: 24 };
      const innerW = Math.max(10, width - pad.left - pad.right);
      const innerH = Math.max(10, height - pad.top - pad.bottom);

      // scales
      const xStep = innerW / (chartData.length - 1 || 1);
      const yScale = v => innerH - (v / maxCount) * innerH;

      // defs: gradients
      const defs = document.createElementNS(svgNS, 'defs');
      defs.innerHTML = `
        <linearGradient id="grad-line" x1="0" x2="1">
          <stop offset="0%" stop-color="#60a5fa" />
          <stop offset="100%" stop-color="#a78bfa" />
        </linearGradient>
        <linearGradient id="grad-area" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0%" stop-color="#60a5fa" stop-opacity="0.28" />
          <stop offset="100%" stop-color="#a78bfa" stop-opacity="0.04" />
        </linearGradient>
      `;
      svg.appendChild(defs);

      // grid lines (horizontal)
      const grid = document.createElementNS(svgNS, 'g');
      grid.setAttribute('class', 'chart-grid');
      const gridLines = 3;
      for (let i = 0; i <= gridLines; i++) {
        const y = pad.top + (innerH / gridLines) * i;
        const line = document.createElementNS(svgNS, 'line');
        line.setAttribute('x1', pad.left);
        line.setAttribute('x2', pad.left + innerW);
        line.setAttribute('y1', y);
        line.setAttribute('y2', y);
        grid.appendChild(line);
      }
      svg.appendChild(grid);

      // area path
      let areaPath = '';
      let linePath = '';
      chartData.forEach((d, i) => {
        const x = pad.left + xStep * i;
        const y = pad.top + yScale(d.count);
        if (i === 0) {
          linePath += `M ${x} ${y}`;
          areaPath += `M ${x} ${pad.top + innerH} L ${x} ${y}`;
        } else {
          linePath += ` L ${x} ${y}`;
          areaPath += ` L ${x} ${y}`;
        }
      });
      // close area
      const lastX = pad.left + xStep * (chartData.length - 1);
      areaPath += ` L ${lastX} ${pad.top + innerH} Z`;

      const area = document.createElementNS(svgNS, 'path');
      area.setAttribute('d', areaPath);
      area.setAttribute('class', 'chart-area');
      svg.appendChild(area);

      const path = document.createElementNS(svgNS, 'path');
      path.setAttribute('d', linePath);
      path.setAttribute('class', 'chart-line');
      svg.appendChild(path);

      // points and labels
      chartData.forEach((d, i) => {
        const x = pad.left + xStep * i;
        const y = pad.top + yScale(d.count);

        const circle = document.createElementNS(svgNS, 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', 4);
        circle.setAttribute('class', 'chart-point');
        svg.appendChild(circle);

        const valLabel = document.createElementNS(svgNS, 'text');
        valLabel.setAttribute('x', x);
        valLabel.setAttribute('y', y - 10);
        valLabel.setAttribute('class', 'chart-value-label');
        valLabel.textContent = String(d.count);
        svg.appendChild(valLabel);

        const xLabel = document.createElementNS(svgNS, 'text');
        xLabel.setAttribute('x', x);
        xLabel.setAttribute('y', pad.top + innerH + 20);
        xLabel.setAttribute('class', 'chart-xlabel');
        xLabel.textContent = d.label;
        svg.appendChild(xLabel);
      });

      // Append svg to container
      chartContainer.appendChild(svg);
    }

    function populateRoomFilter() {
      const roomFilter = document.getElementById('room-filter');
      const rooms = [...new Set(allScans.map(scan => scan.room).filter(room => room && room !== '—'))].sort();
      
      roomFilter.innerHTML = '<option value="">All Rooms</option>';
      rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room;
        option.textContent = room;
        roomFilter.appendChild(option);
      });
    }

    function applyFilters() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const dateFrom = document.getElementById('date-from').value;
      const dateTo = document.getElementById('date-to').value;
      const roomFilter = document.getElementById('room-filter').value;
      const statusFilter = document.querySelector('.filter-btn.active')?.dataset.status || 'all';
      
      filteredScans = allScans.filter(scan => {
        // Search filter
        if (searchTerm) {
          const searchableText = [
            scan.item_name,
            scan.room,
            scan.check_type,
            scan.check_value,
            scan.comment
          ].join(' ').toLowerCase();
          
          if (!searchableText.includes(searchTerm)) return false;
        }
        
        // Date filters
        if (dateFrom) {
          const scanDate = new Date(scan.submitted_at);
          const fromDate = new Date(dateFrom);
          if (scanDate < fromDate) return false;
        }
        
        if (dateTo) {
          const scanDate = new Date(scan.submitted_at);
          const toDate = new Date(dateTo);
          toDate.setHours(23, 59, 59, 999);
          if (scanDate > toDate) return false;
        }
        
        // Room filter
        if (roomFilter && scan.room !== roomFilter) return false;
        
        // Status filter
        if (statusFilter === 'valid' && isInvalidScan(scan)) return false;
        if (statusFilter === 'invalid' && !isInvalidScan(scan)) return false;
        
        return true;
      });
      
      currentPage = 1;
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('scans-tbody');
      const resultsCount = document.getElementById('results-count');
      
      if (filteredScans.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <div class="empty-icon">📋</div>
              <div>No scans found</div>
              <div style="font-size: 0.875rem; margin-top: 8px;">Try adjusting your filters</div>
            </td>
          </tr>`;
        resultsCount.textContent = 'No results';
        document.getElementById('pagination').style.display = 'none';
        return;
      }
      
      // Sort data
      const sortedScans = [...filteredScans].sort((a, b) => {
        const aVal = a[currentSort.field] || '';
        const bVal = b[currentSort.field] || '';
        
        if (currentSort.field === 'submitted_at') {
          const aDate = new Date(aVal);
          const bDate = new Date(bVal);
          return currentSort.direction === 'asc' ? aDate - bDate : bDate - aDate;
        }
        
        const comparison = aVal.toString().localeCompare(bVal.toString());
        return currentSort.direction === 'asc' ? comparison : -comparison;
      });
      
      // Pagination
      const totalPages = Math.ceil(sortedScans.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageData = sortedScans.slice(startIndex, endIndex);
      
      // Render rows
      tbody.innerHTML = pageData.map(scan => {
        const isInvalid = isInvalidScan(scan);
        const statusClass = isInvalid ? 'status-invalid' : 'status-valid';
        const statusText = isInvalid ? 'Issue' : 'Valid';
        
        return `
          <tr>
            <td>${fmtDate(scan.submitted_at)}</td>
            <td>${scan.item_name || '—'}</td>
            <td>${scan.room || '—'}</td>
            <td>${scan.check_type || '—'}</td>
            <td>
              <span class="status-badge ${statusClass}">${statusText}</span>
              <div style="margin-top: 4px; font-size: 0.875rem;">${scan.check_value || '—'}</div>
            </td>
            <td>${scan.comment || '—'}</td>
          </tr>
        `;
      }).join('');
      
      // Update results count
      resultsCount.textContent = `${filteredScans.length} result${filteredScans.length !== 1 ? 's' : ''}`;
      
      // Render pagination
      renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
      const pagination = document.getElementById('pagination');
      
      if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
      }
      
      pagination.style.display = 'flex';
      pagination.innerHTML = '';
      
      // Previous button
      const prevBtn = document.createElement('button');
      prevBtn.className = 'pagination-btn';
      prevBtn.textContent = '←';
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => { currentPage--; renderTable(); };
      pagination.appendChild(prevBtn);
      
      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          const pageBtn = document.createElement('button');
          pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
          pageBtn.textContent = i;
          pageBtn.onclick = () => { currentPage = i; renderTable(); };
          pagination.appendChild(pageBtn);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '8px';
          pagination.appendChild(ellipsis);
        }
      }
      
      // Next button
      const nextBtn = document.createElement('button');
      nextBtn.className = 'pagination-btn';
      nextBtn.textContent = '→';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => { currentPage++; renderTable(); };
      pagination.appendChild(nextBtn);
    }

    function setupEventListeners() {
      // Search input
      document.getElementById('search-input').addEventListener('input', debounce(applyFilters, 300));
      
      // Date filters
      document.getElementById('date-from').addEventListener('change', applyFilters);
      document.getElementById('date-to').addEventListener('change', applyFilters);
      
      // Room filter
      document.getElementById('room-filter').addEventListener('change', applyFilters);
      
      // Status filter buttons
      document.querySelectorAll('.filter-btn[data-status]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn[data-status]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          applyFilters();
        });
      });
      
      // Clear filters
      document.getElementById('clear-filters').addEventListener('click', () => {
        document.getElementById('search-input').value = '';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        document.getElementById('room-filter').value = '';
        document.querySelectorAll('.filter-btn[data-status]').forEach(b => b.classList.remove('active'));
        document.querySelector('.filter-btn[data-status="all"]').classList.add('active');
        applyFilters();
      });
      
      // Table sorting
      document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const field = th.dataset.sort;
          if (currentSort.field === field) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.field = field;
            currentSort.direction = 'desc';
          }
          
          // Update sort indicators
          document.querySelectorAll('.sortable').forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc');
          });
          th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
          
          renderTable();
        });
      });
      
      // Export button
      document.getElementById('export-btn').addEventListener('click', exportData);
      
      // Refresh button
      document.getElementById('refresh-btn').addEventListener('click', () => {
        location.reload();
      });

      // Re-render chart on resize
      window.addEventListener('resize', debounce(() => {
        generateChart();
      }, 200));
    }

    function exportData() {
      if (filteredScans.length === 0) {
        alert('No data to export');
        return;
      }
      
      const headers = ['Date', 'Item', 'Room', 'Check Type', 'Result', 'Comment'];
      const csvContent = [
        headers.join(','),
        ...filteredScans.map(scan => [
          fmtDate(scan.submitted_at),
          `"${(scan.item_name || '').replace(/"/g, '""')}"`,
          `"${(scan.room || '').replace(/"/g, '""')}"`,
          `"${(scan.check_type || '').replace(/"/g, '""')}"`,
          `"${(scan.check_value || '').replace(/"/g, '""')}"`,
          `"${(scan.comment || '').replace(/"/g, '""')}"`
        ].join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `my-scans-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  </script>

  <script>
    // Icon helper function using Icons8 cute-color style
    (function(){
      function i8(name, opts = {}) {
        var base  = 'https://img.icons8.com';
        var style = opts.style || 'cute-color';
        var size  = opts.size  || 48;
        // Icons8 OMG-IMG pattern is style/size/name.png
        var path  = [style, String(size), encodeURIComponent(name) + '.png'].join('/');
        return base + '/' + path;
      }
      
      function setIcon(el){
        var name  = el.getAttribute('data-i8');
        var size  = el.getAttribute('data-i8-size');
        var style = el.getAttribute('data-i8-style') || 'fluency';
        var fallback = (el.getAttribute('data-i8-fallback') || '').toLowerCase();
        
        if (fallback === 'auto') {
          var stylesToTry = [style, 'fluency', 'color'];
          var idx = 0;
          function tryNext(){
            if (idx >= stylesToTry.length) { el.onerror = null; return; }
            var url = i8(name, {style: stylesToTry[idx++], size: size ? parseInt(size,10) : undefined});
            if (el.src !== url) el.src = url; else tryNext();
          }
          el.onerror = tryNext;
          tryNext();
        } else {
          el.src = i8(name, {style: style, size: size ? parseInt(size,10) : undefined});
        }
      }
      
      function wireIcons(){
        document.querySelectorAll('img[data-i8]').forEach(setIcon);
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', wireIcons);
      } else {
        wireIcons();
      }
      
      window.i8 = i8;
      window.setIcon = setIcon;
      window.wireIcons = wireIcons;
    })();
  </script>

    <!-- Debug Console - Persistent across all pages -->
    <script src="debug-console.js"></script>
</body>
</html>

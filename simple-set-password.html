<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Welcome to CheckLoop â€¢ Set Your Password</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <!-- Load Supabase from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #0b4fb3;
      --primary-dark: #062b6f;
      --primary-light: #e8f2ff;
      --primary-lighter: #f6f9ff;
      --accent: #5f96ff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #dbe4f5;
      --white: #ffffff;
      --error: #ef4444;
      --error-bg: #fef2f2;
      --success: #16a34a;
      --success-bg: #f0fdf4;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0b4fb3 0%, #5f96ff 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 500px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 40px 32px;
      text-align: center;
      color: white;
    }

    .logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      background: white;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 900;
      color: var(--primary);
    }

    h1 {
      font-size: 26px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .content {
      padding: 32px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
      margin-bottom: 8px;
    }

    input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.2s;
    }

    input[type="password"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 79, 179, 0.1);
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 20px;
    }

    .btn:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .msg {
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 15px;
      display: none;
    }

    .msg.show {
      display: block;
    }

    .err {
      background: var(--error-bg);
      color: var(--error);
      border: 1px solid var(--error);
    }

    .success {
      background: var(--success-bg);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .info {
      background: var(--primary-light);
      color: var(--primary-dark);
      border: 1px solid var(--primary);
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg) }
    }

    #debug {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.9);
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 11px;
      max-width: 400px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 9999;
    }

    #debug div {
      margin: 2px 0;
      padding: 2px;
    }

    #debug .error {
      color: #f00;
    }

    #debug .success {
      color: #0f0;
    }

    #debug .info {
      color: #0ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">CL</div>
      <h1>Welcome to CheckLoop</h1>
      <div id="user-email">Create your secure password</div>
    </div>

    <div class="content">
      <div class="msg info" id="status-msg">Loading...</div>

      <form id="password-form">
        <div class="form-group">
          <label for="password">Password (minimum 6 characters)</label>
          <input type="password" id="password" required minlength="6" autocomplete="new-password">
        </div>

        <div class="form-group">
          <label for="confirm">Confirm Password</label>
          <input type="password" id="confirm" required minlength="6" autocomplete="new-password">
        </div>

        <div class="msg err" id="error-msg"></div>
        <div class="msg success" id="success-msg"></div>

        <button type="submit" class="btn" id="submit-btn">
          Set Password & Continue
        </button>
      </form>
    </div>
  </div>

  <div id="debug"></div>

  <script>
    // Debug system
    const debugEl = document.getElementById('debug');
    const logs = [];

    function debug(msg, data = null, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const entry = `[${time}] ${msg}`;
      console.log(entry, data || '');

      logs.push({ time, msg, data, type });

      // Update debug display
      debugEl.innerHTML = logs.slice(-20).map(log =>
        `<div class="${log.type}">[${log.time}] ${log.msg}${log.data ? ': ' + JSON.stringify(log.data).substring(0, 100) : ''}</div>`
      ).join('');

      debugEl.scrollTop = debugEl.scrollHeight;
    }

    debug('Page loaded');

    // Wait for everything to load
    window.addEventListener('load', async function() {
      debug('Window loaded, initializing...');

      // Check if Supabase is available
      if (typeof window.supabase === 'undefined') {
        debug('Supabase not loaded from CDN!', null, 'error');
        alert('Error: Supabase library failed to load. Please refresh the page.');
        return;
      }

      debug('Supabase library loaded');

      // Check if CONFIG is available
      if (typeof CONFIG === 'undefined') {
        debug('CONFIG not loaded!', null, 'error');
        alert('Error: Configuration not loaded. Please refresh the page.');
        return;
      }

      debug('CONFIG loaded', { url: CONFIG.SUPABASE_URL });

      try {
        // Initialize Supabase client
        const { createClient } = window.supabase;
        const projectRef = CONFIG.SUPABASE_URL.replace(/^https?:\/\//, '').split('.')[0];
        const storageKey = `sb-${projectRef}-auth-token`;

        debug('Creating Supabase client...');

        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: false, // Prevent auto redirect
            flowType: 'pkce',
            storage: window.localStorage,
            storageKey: storageKey
          }
        });

        debug('Supabase client created');

        // Get DOM elements
        const form = document.getElementById('password-form');
        const passwordInput = document.getElementById('password');
        const confirmInput = document.getElementById('confirm');
        const errorMsg = document.getElementById('error-msg');
        const successMsg = document.getElementById('success-msg');
        const statusMsg = document.getElementById('status-msg');
        const submitBtn = document.getElementById('submit-btn');
        const userEmailEl = document.getElementById('user-email');

        // Parse URL
        const url = new URL(window.location.href);
        const searchParams = url.searchParams;
        const hashParams = new URLSearchParams(window.location.hash.substring(1));

        const params = {
          email: searchParams.get('email'),
          site_id: searchParams.get('site_id'),
          access_token: hashParams.get('access_token'),
          refresh_token: hashParams.get('refresh_token'),
          type: hashParams.get('type')
        };

        debug('URL params', params);

        // Helper functions
        function showMessage(el, msg, show = true) {
          if (el) {
            el.textContent = msg || '';
            el.classList.toggle('show', show);
          }
        }

        // Initialize
        async function init() {
          debug('Starting initialization...');

          showMessage(statusMsg, 'Checking your invitation...');

          if (params.email) {
            const email = decodeURIComponent(params.email);
            userEmailEl.textContent = `Welcome ${email}!`;
            debug('Email set', email);
          }

          // Set session if we have tokens
          if (params.access_token && params.refresh_token) {
            debug('Setting session from tokens...');

            try {
              const { data, error } = await supabaseClient.auth.setSession({
                access_token: params.access_token,
                refresh_token: params.refresh_token
              });

              if (error) {
                debug('Session error', error, 'error');
                throw error;
              }

              debug('Session set successfully', 'success');

              // Clean URL
              const cleanUrl = window.location.pathname + window.location.search;
              history.replaceState(null, '', cleanUrl);
              debug('URL cleaned');

            } catch (error) {
              debug('Failed to set session', error.message, 'error');
              showMessage(errorMsg, 'Session expired. Please request a new invitation.');
              showMessage(statusMsg, '', false);
              submitBtn.disabled = true;
              return;
            }
          }

          // Get user
          try {
            debug('Getting user...');
            const { data: { user }, error } = await supabaseClient.auth.getUser();

            if (error) {
              debug('User error', error, 'error');
              throw error;
            }

            if (!user) {
              debug('No user found', null, 'error');
              throw new Error('No user session found');
            }

            debug('User loaded', { id: user.id, email: user.email }, 'success');

            if (user.email && !params.email) {
              userEmailEl.textContent = `Welcome ${user.email}!`;
            }

            showMessage(statusMsg, 'Ready to set your password');
            passwordInput.focus();

          } catch (error) {
            debug('Failed to get user', error.message, 'error');
            showMessage(errorMsg, 'Could not verify your session. Please use the invitation link from your email.');
            showMessage(statusMsg, '', false);
            submitBtn.disabled = true;
          }
        }

        // Handle form submission
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          debug('Form submitted');

          const password = passwordInput.value;
          const confirm = confirmInput.value;

          // Validate
          if (password.length < 6) {
            showMessage(errorMsg, 'Password must be at least 6 characters');
            return;
          }

          if (password !== confirm) {
            showMessage(errorMsg, 'Passwords do not match');
            return;
          }

          // Clear messages
          showMessage(errorMsg, '', false);
          showMessage(successMsg, '', false);

          // Disable form
          submitBtn.disabled = true;
          passwordInput.disabled = true;
          confirmInput.disabled = true;
          submitBtn.innerHTML = '<span class="spinner"></span>Saving password...';

          try {
            debug('Updating password...');

            const { data, error } = await supabaseClient.auth.updateUser({
              password: password
            });

            if (error) {
              debug('Password update error', error, 'error');
              throw error;
            }

            debug('Password updated!', null, 'success');
            showMessage(successMsg, 'Password set successfully! Redirecting...');

            // Update metadata if we have site_id
            if (params.site_id) {
              debug('Updating metadata...');
              await supabaseClient.auth.updateUser({
                data: {
                  site_id: parseInt(params.site_id),
                  invited: true,
                  email_verified: true
                }
              });

              // Store in session
              sessionStorage.setItem('userSiteId', params.site_id);
              sessionStorage.setItem('welcomeMode', 'simplified');
            }

            // Redirect
            setTimeout(() => {
              debug('Redirecting...');
              const redirectUrl = `${CONFIG.baseUrl}/staff-welcome.html`;
              window.location.href = redirectUrl;
            }, 1500);

          } catch (error) {
            debug('Error saving password', error.message, 'error');
            showMessage(errorMsg, error.message || 'Failed to save password');

            // Re-enable form
            submitBtn.disabled = false;
            passwordInput.disabled = false;
            confirmInput.disabled = false;
            submitBtn.textContent = 'Set Password & Continue';
          }
        });

        // Initialize
        await init();

      } catch (error) {
        debug('Fatal error', error.message, 'error');
        console.error('Fatal error:', error);
        alert('Error initializing page: ' + error.message);
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Welcome to CheckLoop â€¢ Set Your Password</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Load config first -->
  <script src="config.js"></script>

  <!-- Try multiple CDN sources for Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>

  <style>
    :root {
      --primary: #0b4fb3;
      --primary-dark: #062b6f;
      --primary-light: #e8f2ff;
      --primary-lighter: #f6f9ff;
      --accent: #5f96ff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #dbe4f5;
      --white: #ffffff;
      --error: #ef4444;
      --error-bg: #fef2f2;
      --success: #16a34a;
      --success-bg: #f0fdf4;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0b4fb3 0%, #5f96ff 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 500px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 40px 32px;
      text-align: center;
      color: white;
    }

    .logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      background: white;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 900;
      color: var(--primary);
    }

    h1 {
      font-size: 26px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .content {
      padding: 32px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
      margin-bottom: 8px;
    }

    input[type="password"], input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.2s;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 79, 179, 0.1);
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 20px;
    }

    .btn:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .msg {
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin: 15px 0;
    }

    .err {
      background: var(--error-bg);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .success {
      background: var(--success-bg);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .info {
      background: var(--primary-light);
      color: var(--primary-dark);
      border: 1px solid rgba(11, 79, 179, 0.3);
    }

    #debug {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: black;
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 11px;
      max-width: 500px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 9999;
      border: 1px solid #0f0;
    }

    #debug .error {
      color: #f00;
    }

    #debug .warn {
      color: #ff0;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">CL</div>
      <h1>Welcome to CheckLoop</h1>
      <div id="user-email">Set your password to get started</div>
    </div>

    <div class="content">
      <div id="status-msg" class="msg info">Loading...</div>

      <!-- Use standard form but prevent ALL submission -->
      <div id="password-form">
        <div class="form-group">
          <label for="password">New Password (minimum 6 characters)</label>
          <input type="password" id="password" minlength="6" autocomplete="new-password" />
        </div>

        <div class="form-group">
          <label for="confirm">Confirm Password</label>
          <input type="password" id="confirm" minlength="6" autocomplete="new-password" />
        </div>

        <div id="error-msg" class="msg err hidden"></div>
        <div id="success-msg" class="msg success hidden"></div>

        <!-- Use a regular button, NOT a submit button -->
        <button type="button" class="btn" id="submit-btn" onclick="handlePasswordSave()">
          Set Password & Continue
        </button>
      </div>

      <!-- Fallback form if Supabase fails -->
      <div id="fallback-form" class="hidden">
        <div class="msg err">
          Supabase library could not be loaded. Please try the alternative method:
        </div>
        <div class="form-group">
          <label>Copy this token:</label>
          <input type="text" id="token-display" readonly style="font-family: monospace; font-size: 12px;" />
        </div>
        <div class="msg info">
          Please contact support with the token above to complete your registration.
        </div>
      </div>
    </div>
  </div>

  <div id="debug"></div>

  <script>
    // Prevent ALL form submissions globally
    document.addEventListener('submit', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Form submission blocked');
      return false;
    }, true);

    // Debug logging
    const debugEl = document.getElementById('debug');
    const logs = [];

    function debug(msg, data = null, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const logMsg = `[${time}] ${msg}${data ? ': ' + JSON.stringify(data) : ''}`;

      console.log(logMsg);
      logs.push({ time, msg, data, type });

      if (debugEl) {
        debugEl.innerHTML = logs.slice(-30).map(log =>
          `<div class="${log.type}">[${log.time}] ${log.msg}${log.data ? ': ' + JSON.stringify(log.data).substring(0, 200) : ''}</div>`
        ).join('');
        debugEl.scrollTop = debugEl.scrollHeight;
      }
    }

    // Global variables
    let supabaseClient = null;
    let currentUser = null;
    let urlParams = {};

    debug('Page loaded');
    debug('Script starting...');

    // Parse URL immediately
    try {
      const url = new URL(window.location.href);
      const searchParams = url.searchParams;
      const hashParams = new URLSearchParams(window.location.hash.substring(1));

      urlParams = {
        email: searchParams.get('email'),
        site_id: searchParams.get('site_id'),
        access_token: hashParams.get('access_token'),
        refresh_token: hashParams.get('refresh_token'),
        type: hashParams.get('type')
      };

      debug('URL params extracted', urlParams);
    } catch (e) {
      debug('Failed to parse URL', e.message, 'error');
    }

    // Show message helper
    function showMsg(id, msg, show = true) {
      const el = document.getElementById(id);
      if (el) {
        if (msg) el.textContent = msg;
        if (show) {
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      }
    }

    // Main password save handler - GLOBAL function
    window.handlePasswordSave = async function() {
      debug('handlePasswordSave called');

      const passwordEl = document.getElementById('password');
      const confirmEl = document.getElementById('confirm');
      const btnEl = document.getElementById('submit-btn');

      const password = passwordEl.value;
      const confirm = confirmEl.value;

      debug('Password length', password.length);

      // Validate
      if (password.length < 6) {
        showMsg('error-msg', 'Password must be at least 6 characters');
        return;
      }

      if (password !== confirm) {
        showMsg('error-msg', 'Passwords do not match');
        return;
      }

      // Check if we have Supabase
      if (!supabaseClient) {
        debug('No Supabase client available!', null, 'error');
        showMsg('error-msg', 'Cannot save password - Supabase not loaded. Please refresh and try again.');
        return;
      }

      // Clear errors
      showMsg('error-msg', '', false);
      showMsg('success-msg', '', false);

      // Disable form
      btnEl.disabled = true;
      passwordEl.disabled = true;
      confirmEl.disabled = true;
      btnEl.innerHTML = '<span class="spinner"></span>Saving password...';

      try {
        debug('Calling updateUser...');

        const { data, error } = await supabaseClient.auth.updateUser({
          password: password
        });

        if (error) {
          debug('Update error', error, 'error');
          throw error;
        }

        debug('Password updated successfully!', null, 'info');
        showMsg('success-msg', 'Password saved! Redirecting...');

        // Update metadata if site_id exists
        if (urlParams.site_id) {
          debug('Updating metadata...');
          try {
            await supabaseClient.auth.updateUser({
              data: {
                site_id: parseInt(urlParams.site_id),
                invited: true,
                email_verified: true
              }
            });

            sessionStorage.setItem('userSiteId', urlParams.site_id);
            sessionStorage.setItem('welcomeMode', 'simplified');
          } catch (metaError) {
            debug('Metadata update failed (non-critical)', metaError, 'warn');
          }
        }

        // Redirect after short delay
        setTimeout(() => {
          debug('Redirecting to staff-welcome...');
          const redirectUrl = CONFIG.baseUrl + '/staff-welcome.html';
          window.location.replace(redirectUrl);
        }, 1500);

      } catch (error) {
        debug('Save failed', error.message, 'error');
        showMsg('error-msg', error.message || 'Failed to save password');

        // Re-enable form
        btnEl.disabled = false;
        passwordEl.disabled = false;
        confirmEl.disabled = false;
        btnEl.innerHTML = 'Set Password & Continue';
      }
    };

    // Initialize when DOM is ready
    function initApp() {
      debug('initApp called');

      // Check CONFIG
      if (typeof CONFIG === 'undefined') {
        debug('CONFIG not defined!', null, 'error');
        showMsg('status-msg', 'Configuration error. Please refresh the page.');
        return;
      }

      debug('CONFIG exists', { url: CONFIG.SUPABASE_URL });

      // Try to find Supabase
      let supabaseLib = null;

      // Check different possible locations
      if (typeof window.supabase !== 'undefined') {
        supabaseLib = window.supabase;
        debug('Found window.supabase');
      } else if (typeof window.Supabase !== 'undefined') {
        supabaseLib = window.Supabase;
        debug('Found window.Supabase');
      } else if (typeof supabase !== 'undefined') {
        supabaseLib = supabase;
        debug('Found global supabase');
      }

      if (!supabaseLib) {
        debug('Supabase not found!', null, 'error');

        // Show fallback form
        document.getElementById('password-form').classList.add('hidden');
        document.getElementById('fallback-form').classList.remove('hidden');

        // Display the access token for manual processing
        if (urlParams.access_token) {
          document.getElementById('token-display').value = urlParams.access_token;
        }

        showMsg('status-msg', '', false);
        return;
      }

      debug('Supabase found, creating client...');

      try {
        // Get createClient function
        const createClient = supabaseLib.createClient || supabaseLib.default?.createClient;

        if (!createClient) {
          throw new Error('createClient function not found');
        }

        // Create client
        const projectRef = CONFIG.SUPABASE_URL.replace(/^https?:\/\//, '').split('.')[0];
        const storageKey = `sb-${projectRef}-auth-token`;

        supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: false,
            flowType: 'pkce',
            storage: window.localStorage,
            storageKey: storageKey
          }
        });

        debug('Supabase client created successfully');

        // Initialize the session
        initSession();

      } catch (error) {
        debug('Failed to create Supabase client', error.message, 'error');
        showMsg('status-msg', 'Failed to initialize. Please refresh the page.');
      }
    }

    async function initSession() {
      debug('initSession called');

      showMsg('status-msg', 'Verifying your invitation...');

      // Display email if available
      if (urlParams.email) {
        const email = decodeURIComponent(urlParams.email);
        document.getElementById('user-email').textContent = `Welcome ${email}!`;
        debug('Email set', email);
      }

      // Set session from tokens
      if (urlParams.access_token && urlParams.refresh_token) {
        debug('Setting session from tokens...');

        try {
          const { data, error } = await supabaseClient.auth.setSession({
            access_token: urlParams.access_token,
            refresh_token: urlParams.refresh_token
          });

          if (error) {
            debug('Session error', error, 'error');
            throw error;
          }

          debug('Session established');

          // Clean URL
          const cleanUrl = window.location.pathname + window.location.search;
          history.replaceState(null, '', cleanUrl);

        } catch (error) {
          debug('Session setup failed', error.message, 'error');
          showMsg('error-msg', 'Session expired. Please request a new invitation.');
          showMsg('status-msg', '', false);
          return;
        }
      }

      // Get current user
      try {
        const { data: { user }, error } = await supabaseClient.auth.getUser();

        if (error) throw error;

        if (user) {
          currentUser = user;
          debug('User loaded', { id: user.id, email: user.email });

          if (user.email && !urlParams.email) {
            document.getElementById('user-email').textContent = `Welcome ${user.email}!`;
          }

          showMsg('status-msg', 'Please create your password');
          document.getElementById('password').focus();

        } else {
          debug('No user found', null, 'warn');
          showMsg('error-msg', 'No active session. Please use the invitation link from your email.');
          showMsg('status-msg', '', false);
        }

      } catch (error) {
        debug('Failed to get user', error.message, 'error');
        showMsg('error-msg', 'Could not verify session. Please use the invitation link.');
        showMsg('status-msg', '', false);
      }
    }

    // Start initialization
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      // DOM already loaded
      setTimeout(initApp, 100);
    }

    // Also try on window load as backup
    window.addEventListener('load', function() {
      debug('Window load event fired');
      if (!supabaseClient) {
        debug('Retrying initialization on window load...');
        setTimeout(initApp, 500);
      }
    });

    // Prevent Enter key from submitting
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && e.target.type === 'password') {
        e.preventDefault();
        debug('Enter key blocked');
        // Call save function instead
        if (document.getElementById('confirm').value) {
          handlePasswordSave();
        }
        return false;
      }
    });
  </script>
</body>
</html>
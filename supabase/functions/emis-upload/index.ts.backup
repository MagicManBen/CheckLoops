import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

// Set CORS headers
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS, GET',
}

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }
  
  // Get the URL path
  const url = new URL(req.url);
  const path = url.pathname.split('/').pop();
  
  // Handle health check endpoint - useful for testing connectivity
  if (path === 'health' || url.searchParams.has('health')) {
    // Extract and log authentication headers for debugging
    const apiKeyHeader = req.headers.get('apikey') || 'none';
    
    // Check if API key is valid
    const isValidApiKey = apiKeyHeader === 'sb_publishable_wpy7lxfbI2HwvsznlWJVKg_Zx7HnAc4';
    
    return new Response(
      JSON.stringify({
        status: 'ok',
        message: 'EMIS upload function is online',
        time: new Date().toISOString(),
        request: {
          apiKey: apiKeyHeader !== 'none' ? 'provided' : 'missing',
          apiKeyValid: isValidApiKey,
          method: req.method,
          path: path
        }
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 200 }
    );
  }

  // Verify API key (a basic check to prevent unauthorized usage)
  const apiKey = req.headers.get('apikey');
  
  // For anonymous access using the anon key
  if (!apiKey || apiKey !== 'sb_publishable_wpy7lxfbI2HwvsznlWJVKg_Zx7HnAc4') {
    return new Response(
      JSON.stringify({ 
        error: 'Unauthorized',
        message: 'Invalid or missing API key',
        providedKey: apiKey ? apiKey.substring(0, 10) + '...' : 'none'
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 401 }
    )
  }

  try {
    // Only process POST requests for data upload
    if (req.method !== 'POST') {
      return new Response(
        JSON.stringify({ error: 'Method not allowed', allowedMethods: 'POST, OPTIONS, GET' }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 405 }
      )
    }

    // Create a Supabase client
    const supabaseAdmin = createClient(
      // These environment variables are set by Supabase Edge Functions
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    )

    // Parse the request body
    const { records } = await req.json()

    if (!records || !Array.isArray(records) || records.length === 0) {
      return new Response(
        JSON.stringify({ error: 'No valid records provided' }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 400 }
      )
    }

    // Process records to handle empty values appropriately
    const processedRecords = records.map(record => {
      const processedRecord = {};
      
      // Loop through each key in the record
      for (const [key, value] of Object.entries(record)) {
        // Handle empty strings, "Unknown" values, and nulls consistently
        if (value === "" || value === "Unknown" || value === null || value === undefined) {
          processedRecord[key] = null;
        } else {
          processedRecord[key] = value;
        }
      }
      
      return processedRecord;
    });

    // Filter out completely empty records
    const validRecords = processedRecords.filter(record => {
      // Check if at least one field has a non-null value
      return Object.values(record).some(value => value !== null);
    });
    
    // Insert data into the emis_apps table
    const { data, error } = await supabaseAdmin
      .from('emis_apps')
      .insert(validRecords)
      .select();

    if (error) {
      // Return detailed error information
      return new Response(
        JSON.stringify({ 
          error: error.message,
          code: error.code,
          details: error.details,
          hint: error.hint,
          recordsAttempted: validRecords.length
        }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 500 }
      )
    }

    // Return success response with detailed information
    return new Response(
      JSON.stringify({ 
        success: true, 
        message: `Successfully inserted ${data.length} records`,
        count: data.length,
        totalProcessed: records.length,
        validRecords: validRecords.length,
        skippedRecords: records.length - validRecords.length
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 200 }
    )
  } catch (err) {
    const error = err as Error; // Type assertion
    return new Response(
      JSON.stringify({ 
        error: 'Internal Server Error',
        message: error.message
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 500 }
    )
  }
})
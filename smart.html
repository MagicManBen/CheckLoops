<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NHS GP Finder ‚Äì Minimal</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --nhs-blue:#005EB8; --ink:#111827; --muted:#6B7280; --bg:#F9FAFB; --card:#FFFFFF; --accent:#10B981; --warn:#F59E0B; --err:#EF4444; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink)}
    header{padding:16px 20px;background:var(--card);border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:10}
    header h1{font-size:18px;margin:0 0 6px;color:var(--nhs-blue)}
    header p{margin:0;color:var(--muted);font-size:13px}
    .container{max-width:1100px;margin:20px auto;padding:0 16px}
    .row{display:grid;grid-template-columns:1fr 1.2fr;gap:16px}
    @media (max-width: 900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:14px}
    .searchbar{display:flex;gap:8px}
    .searchbar input{flex:1;padding:12px 14px;border:1px solid #d1d5db;border-radius:10px;font-size:15px}
    .btn{padding:10px 14px;border:1px solid #d1d5db;background:#fff;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--nhs-blue);border-color:var(--nhs-blue);color:#fff}
    .btn.slim{padding:8px 10px;font-size:13px}
    .btn.success{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#111}
    .btn.ghost{background:#fff}
    .list{margin-top:10px;display:grid;gap:8px;max-height:420px;overflow:auto}
    .item{padding:10px;border:1px solid #e5e7eb;border-radius:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;background:#fff}
    .item:hover{border-color:#c7ccd1}
    .item small{color:var(--muted)}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 10px;font-size:14px}
    .kv div{padding:4px 0;border-bottom:1px dashed #eef2f7}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;white-space:pre-wrap;word-break:break-all;background:#0b1020;color:#d6e4ff;border-radius:8px;padding:10px;border:1px solid #223344}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
    .status.ok{color:var(--accent)} .status.warn{color:var(--warn)} .status.err{color:var(--err)}
  </style>
  <!--
    IMPORTANT ‚ö†Ô∏è
    - Do NOT paste your Supabase SERVICE KEY in this file. It must never be shipped to browsers.
    - This page uses only the Supabase ANON (publishable) key.
    - CQC/NHS calls are attempted directly. If you hit CORS/rate limits, create a Supabase Edge Function
      and call it from here (we include an optional attempt below).
  -->
</head>
<body>
  <header>
    <h1>üè• NHS GP Finder ‚Äì Minimal</h1>
    <p>Search ‚Üí pick practice ‚Üí fetch CQC + NHS ODS ‚Üí save into Supabase ‚Üí show.</p>
  </header>

  <div class="container">
    <div class="card" style="margin-bottom:16px">
      <div class="searchbar">
        <input id="q" placeholder="Search by practice name (e.g., Manchester)" />
        <button class="btn primary" id="go">Search</button>
        <label class="pill"><input type="checkbox" id="odsOnly" style="margin-right:6px">ODS only</label>
      </div>
      <div id="results" class="list"></div>
    </div>

    <div class="row">
      <div class="card">
        <div class="stack" style="justify-content:space-between;align-items:center">
          <strong>Selected practice</strong>
          <div class="stack">
            <button class="btn slim ghost" id="btnReload">Reload Row</button>
            <button class="btn slim" id="btnFetchCQC">Fetch CQC</button>
            <button class="btn slim" id="btnFetchODS">Fetch NHS ODS</button>
            <button class="btn slim success" id="btnFetchBoth">Fetch Both</button>
          </div>
        </div>
        <div id="meta" style="margin-top:10px" class="kv"></div>
      </div>

      <div class="card">
        <div class="stack" style="justify-content:space-between;align-items:center">
          <strong>Raw JSON (latest)</strong>
          <div id="apiStatus" class="pill status warn">Idle</div>
        </div>
        <div id="raw" class="mono" style="margin-top:10px;min-height:180px">No data yet.</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <strong>Log</strong>
      <div id="log" class="mono" style="margin-top:10px;max-height:260px;overflow:auto"></div>
    </div>
  </div>

<script>
  // ===== Config (client-safe) =====
  const SUPABASE_URL = 'https://unveoqnlqnobufhublyw.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_wpy7lxfbI2HwvsznlWJVKg_Zx7HnAc4';
  const TABLE = 'CQC All GPs'; // exact name in your DB
  const EDGE_FN = 'fetch-nhs-data-complete'; // optional: if you already have it deployed

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const el = (id)=>document.getElementById(id);
  const logEl = el('log');
  function log(msg, data){
    const time = new Date().toISOString().replace('T',' ').replace('Z','');
    logEl.textContent += `\n[${time}] ${msg}`;
    if(data){ logEl.textContent += `\n  ${JSON.stringify(data,null,2).split('\n').join('\n  ')}`; }
    logEl.scrollTop = logEl.scrollHeight;
  }
  function setRaw(obj){ el('raw').textContent = JSON.stringify(obj, null, 2); }
  function setStatus(txt, cls='warn'){ const badge = el('apiStatus'); badge.textContent = txt; badge.className = `pill status ${cls}`; }

  let current = null; // { location_id, provider_id, ods_code?, row? }

  // ===== Search =====
  async function search(){
    const q = el('q').value.trim();
    if(!q){ return; }
    setStatus('Searching‚Ä¶');
    el('results').innerHTML = '<div class="item"><small>Searching‚Ä¶</small></div>';

    // Build query
    let query = supabase.from(TABLE)
      .select('location_id, location_name, postcode, region, ods_code, provider_id')
      .ilike('location_name', `%${q}%`)
      .limit(20);

    if(el('odsOnly').checked){ query = query.not('ods_code','is',null).neq('ods_code',''); }

    const { data, error } = await query;
    if(error){ setStatus('Search failed', 'err'); log('Search failed', error); el('results').innerHTML=''; return; }

    setStatus(`Found ${data.length}`, 'ok');
    renderResults(data);
  }

  function renderResults(rows){
    const list = el('results');
    if(!rows.length){ list.innerHTML = '<div class="item"><small>No matches</small></div>'; return; }
    list.innerHTML = '';
    rows.forEach(r=>{
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div><strong>${r.location_name}</strong><br/><small>${r.region||'‚Äî'} ¬∑ ${r.postcode||'‚Äî'}</small></div><div><small>${r.ods_code?('ODS '+r.ods_code):''}</small></div>`;
      div.onclick = ()=>selectPractice(r.location_id);
      list.appendChild(div);
    });
  }

  // ===== Load + show one row =====
  async function selectPractice(location_id){
    setStatus('Loading row‚Ä¶');
    const { data, error } = await supabase.from(TABLE).select('*').eq('location_id', location_id).single();
    if(error){ setStatus('Load failed', 'err'); log('Load failed', error); return; }
    current = {
      location_id: data.location_id,
      provider_id: data.provider_id || null,
      ods_code: data.ods_code || null,
      row: data
    };
    setStatus('Row ready', 'ok');
    renderMeta(data);
    setRaw({ saved_row: data });
  }

  function renderMeta(row){
    const m = el('meta');
    const addr = [row.address_line_1,row.address_line_2,row.town_city,row.postcode].filter(Boolean).join(', ');
    m.innerHTML = ''+
      kv('Location name', row.location_name) +
      kv('Location ID', row.location_id) +
      kv('Provider ID', row.provider_id||'‚Äî') +
      kv('ODS code', row.ods_code||'‚Äî') +
      kv('Phone', row.main_phone_number||'‚Äî') +
      kv('Website', row.website||'‚Äî') +
      kv('Address', addr||'‚Äî') +
      kv('Region', row.region||'‚Äî') +
      kv('Last NHS update', row.last_nhs_update? String(row.last_nhs_update).replace('T',' ').split('.')[0] : '‚Äî');
  }
  function kv(k,v){ return `<div style="color:var(--muted)">${k}</div><div>${v??'‚Äî'}</div>`; }

  // ===== CQC fetch (direct) =====
  async function fetchCQC(){
    if(!current){ return; }
    const locId = current.location_id; const provId = current.provider_id;
    setStatus('Fetching CQC‚Ä¶');
    try{
      // Try Edge Function first (if present)
      const viaEdge = await tryEdge({ location_id: locId, provider_id: provId, ods_code: current.ods_code||null, data_sources:['cqc'] });
      if(viaEdge){ await afterCqc(viaEdge); return; }

      // Fallback: direct CQC API (public)
      const loc = await fetchJson(`https://api.cqc.org.uk/public/v1/locations/${encodeURIComponent(locId)}`);
      let prov = null;
      if(provId){ prov = await fetchJson(`https://api.cqc.org.uk/public/v1/providers/${encodeURIComponent(provId)}`); }
      const payload = { location: loc, provider: prov };
      await afterCqc({ data: payload });
    }catch(e){ setStatus('CQC error', 'err'); log('CQC fetch error', String(e)); }
  }

  async function afterCqc(resp){
    const cqc = resp?.data || resp; // support both shapes
    setRaw({ cqc });
    const update = buildUpdateFromCqc(cqc);
    await saveUpdate(update);

    // refresh current
    await selectPractice(current.location_id);
    setStatus('CQC saved', 'ok');
  }

  function buildUpdateFromCqc(cqc){
    if(!cqc) return {};
    const loc = cqc.location || cqc.cqc_location || cqc.Location || cqc || null;
    const prov = cqc.provider || cqc.cqc_provider || cqc.Provider || null;

    const pick = (a,b,c)=> a!==undefined ? a : (b!==undefined ? b : c);
    const ratingObj = loc?.currentRatings||null;

    const telecomPhone = null; // CQC payloads rarely carry telecom arrays

    return compact({
      location_source: loc ? JSON.stringify(loc) : undefined,
      provider_source: prov ? JSON.stringify(prov) : undefined,

      location_name: pick(loc?.name, prov?.name, undefined),
      provider_name: pick(prov?.name, undefined, undefined),
      provider_id: pick(loc?.providerId, prov?.providerId, undefined),
      organisation_type: pick(loc?.organisationType, undefined, undefined),
      location_type: pick(loc?.type, undefined, undefined),
      region: pick(loc?.region, undefined, undefined),

      address_line_1: pick(loc?.postalAddressLine1, undefined, undefined),
      address_line_2: pick(loc?.postalAddressLine2, undefined, undefined),
      town_city: pick(loc?.postalAddressTownCity, undefined, undefined),
      postcode: pick(loc?.postalCode, undefined, undefined),
      uprn: pick(loc?.uprn, undefined, undefined),
      latitude: (loc?.onspdLatitude!=null)? String(loc.onspdLatitude) : undefined,
      longitude:(loc?.onspdLongitude!=null)? String(loc.onspdLongitude): undefined,
      main_phone_number: pick(loc?.mainPhoneNumber, prov?.mainPhoneNumber, telecomPhone||undefined),
      website: pick(loc?.website, prov?.website, undefined),

      onspd_ccg_code: pick(loc?.onspdCcgCode, undefined, undefined),
      onspd_ccg_name: pick(loc?.onspdCcgName, undefined, undefined),
      onspd_icb_code: pick(loc?.onspdIcbCode, undefined, undefined),
      onspd_icb_name: pick(loc?.onspdIcbName, undefined, undefined),
      ods_ccg_code: pick(loc?.odsCcgCode, undefined, undefined),
      ods_ccg_name: pick(loc?.odsCcgName, undefined, undefined),

      overall_rating: ratingObj?.overall?.rating,
      last_inspection_date: pick(loc?.lastInspection?.date, undefined, undefined),
      last_report_date: pick(loc?.lastReport?.publicationDate, undefined, undefined),

      regulated_activities: loc?.regulatedActivities ? JSON.stringify(loc.regulatedActivities) : undefined,
      inspection_areas: loc?.inspectionAreas ? JSON.stringify(loc.inspectionAreas) : undefined,
      inspection_categories: loc?.inspectionCategories ? JSON.stringify(loc.inspectionCategories) : undefined,
      gac_service_types: loc?.gacServiceTypes ? JSON.stringify(loc.gacServiceTypes) : undefined,
      specialisms: loc?.specialisms ? JSON.stringify(loc.specialisms) : undefined,

      provider_website: prov?.website,
      provider_main_phone_number: prov?.mainPhoneNumber,
      provider_registration_status: prov?.registrationStatus,
      provider_registration_date: prov?.registrationDate,
      ownership_type: prov?.ownershipType,
      provider_region: prov?.region,
      provider_address_line_1: prov?.postalAddressLine1,
      provider_address_line_2: prov?.postalAddressLine2,
      provider_town_city: prov?.postalAddressTownCity,
      provider_postcode: prov?.postalCode,
      provider_location_ids: prov?.locationIds ? JSON.stringify(prov.locationIds) : undefined,
      provider_inspection_areas: prov?.inspectionAreas ? JSON.stringify(prov.inspectionAreas) : undefined,

      ods_code: normalizeOds(loc?.odsCode),
      updated_at: new Date().toISOString(),
    });
  }

  // ===== NHS ODS fetch (by ODS if possible, else by name) =====
  async function fetchODS(){
    if(!current){ return; }
    setStatus('Fetching NHS ODS‚Ä¶');
    try{
      // Try Edge Function first (if present)
      const viaEdge = await tryEdge({ location_id: current.location_id, ods_code: current.ods_code||null, data_sources:['ods'] });
      if(viaEdge){ await afterOds(viaEdge); return; }

      let odsData = null;
      if(current.ods_code){
        odsData = await fetchJson(`https://directory.spineservices.nhs.uk/ORD/2-0-0/organisations/${encodeURIComponent(current.ods_code)}`);
      } else if(current.row){
        // Fallback: search by name (coarse)
        const name = encodeURIComponent(current.row.location_name);
        const list = await fetchJson(`https://directory.spineservices.nhs.uk/ORD/2-0-0/organisations?Name=${name}`);
        odsData = Array.isArray(list?.organisations) ? list.organisations[0] || null : list || null;
      }
      await afterOds({ data: { ods_data: odsData } });
    }catch(e){ setStatus('NHS error', 'err'); log('NHS fetch error', String(e)); }
  }

  async function afterOds(resp){
    const ods = resp?.data?.ods_data || resp?.data || resp || null;
    setRaw({ ods });
    const update = buildUpdateFromOds(ods);
    await saveUpdate(update);
    await selectPractice(current.location_id);
    setStatus('NHS saved', 'ok');
  }

  function buildUpdateFromOds(ods){
    if(!ods) return {};
    // Flexible extraction (the ORD API can return {identifier:{value}}, or arrays, etc.)
    let ident = '';
    if(ods.identifier?.value){ ident = ods.identifier.value; }
    else if(Array.isArray(ods.identifier)){ const m = ods.identifier.find(x=>String(x.system||'').toLowerCase().includes('ods')); ident = m?.value || ods.identifier[0]?.value || ''; }
    else if(typeof ods.identifier==='string'){ ident = ods.identifier; }
    else if(ods.code){ ident = ods.code; }

    const telecom = Array.isArray(ods.telecom)? ods.telecom : [];
    const phone = telecom.find(t=>String(t.system||'').toLowerCase()==='phone')?.value || null;
    const url = telecom.find(t=>String(t.system||'').toLowerCase()==='url')?.value || (ods.website||null);

    const addr = Array.isArray(ods.address)? ods.address[0] : (ods.address||null);
    const line = Array.isArray(addr?.line)? addr.line : [];

    return compact({
      nhs_ods_data: JSON.stringify(ods),
      last_nhs_update: new Date().toISOString(),
      ods_code: normalizeOds(ident)||undefined,
      main_phone_number: phone||undefined,
      website: url||undefined,
      address_line_1: addr?.line1 || line[0] || addr?.addressLine1 || undefined,
      address_line_2: addr?.line2 || line[1] || addr?.addressLine2 || undefined,
      town_city: addr?.city || addr?.town || addr?.postalAddressTownCity || undefined,
      postcode: addr?.postalCode || addr?.postcode || undefined,
      region: ods.region || undefined,
      location_name: ods.name || undefined,
      updated_at: new Date().toISOString(),
    });
  }

  // ===== Save helper =====
  async function saveUpdate(update){
    if(!current) return;
    const clean = compact(update);
    if(!Object.keys(clean).length){ log('Nothing to update'); return; }
    const { data, error } = await supabase.from(TABLE).update(clean).eq('location_id', current.location_id).select('*');
    if(error){ setStatus('Save failed','err'); log('Save failed', error); return; }
    log('Saved', { keys: Object.keys(clean) });
    return data?.[0] || null;
  }

  // ===== Utilities =====
  async function fetchJson(url){
    const res = await fetch(url);
    if(!res.ok){ throw new Error(`${res.status} ${res.statusText}`); }
    return await res.json();
  }
  function compact(obj){ const out={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; if(v!==undefined) out[k]=v; }); return out; }
  function normalizeOds(c){ if(!c) return ''; const u=String(c).trim().toUpperCase(); return /^[A-Z0-9]{3,8}$/.test(u)?u:''; }

  async function tryEdge(body){
    try{
      const { data, error } = await supabase.functions.invoke(EDGE_FN, { body });
      if(error){ log('Edge function error (ignored)', error); return null; }
      if(data){ setRaw({ edge_response:data }); return data; }
      return null;
    }catch(e){ log('Edge function call failed (ignored)', String(e)); return null; }
  }

  // ===== Wire up =====
  el('go').onclick = search; el('q').addEventListener('keydown', e=>{ if(e.key==='Enter') search(); });
  el('btnReload').onclick = ()=> current && selectPractice(current.location_id);
  el('btnFetchCQC').onclick = fetchCQC;
  el('btnFetchODS').onclick = fetchODS;
  el('btnFetchBoth').onclick = async ()=>{ await fetchCQC(); await fetchODS(); };

  // Focus search on load
  window.addEventListener('load', ()=>{ el('q').focus(); });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weekly Knowledge Check</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .nav {
      background: rgba(255, 255, 255, 0.95);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .nav-links {
      display: flex;
      gap: 20px;
    }
    
    .nav-links button {
      background: none;
      border: none;
      color: #667eea;
      font-weight: 600;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .nav-links button:hover {
      background: rgba(102, 126, 234, 0.1);
    }
    
    .nav-links button.active {
      background: #667eea;
      color: white;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
      color: #666;
    }
    
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
    }
    
    /* Quiz Selection Screen */
    .quiz-home {
      display: grid;
      gap: 30px;
      animation: fadeIn 0.6s ease;
    }
    
    .welcome-banner {
      background: white;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .welcome-banner h1 {
      font-size: 36px;
      color: #667eea;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .welcome-banner p {
      color: #666;
      font-size: 18px;
    }
    
    .quiz-modes {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    
    .mode-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .mode-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }
    
    .mode-card.required {
      border-top: 4px solid #ff6b6b;
    }
    
    .mode-card.practice {
      border-top: 4px solid #4ecdc4;
    }
    
    .mode-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      border-radius: 50%;
    }
    
    .required .mode-icon {
      background: linear-gradient(135deg, #ff6b6b, #ff8787);
    }
    
    .practice .mode-icon {
      background: linear-gradient(135deg, #4ecdc4, #44a39f);
    }
    
    .mode-card h2 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 24px;
    }
    
    .mode-card p {
      text-align: center;
      color: #666;
      margin-bottom: 25px;
      line-height: 1.6;
    }
    
    .mode-status {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .countdown-display {
      font-size: 24px;
      font-weight: bold;
      color: #ff6b6b;
      margin: 10px 0;
    }
    
    .btn {
      width: 100%;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .btn-required {
      background: linear-gradient(135deg, #ff6b6b, #ff8787);
      color: white;
    }
    
    .btn-required:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }
    
    .btn-practice {
      background: linear-gradient(135deg, #4ecdc4, #44a39f);
      color: white;
    }
    
    .btn-practice:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Quiz Taking Screen */
    .quiz-active {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      animation: slideUp 0.5s ease;
    }
    
    .quiz-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .quiz-header h2 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .quiz-header .mode-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
    }
    
    .mode-badge.required {
      background: #ffe0e0;
      color: #ff6b6b;
    }
    
    .mode-badge.practice {
      background: #d4f4f1;
      color: #44a39f;
    }
    
    .progress-container {
      margin-bottom: 30px;
    }
    
    .progress-bar {
      height: 8px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s ease;
      border-radius: 10px;
    }
    
    .progress-text {
      text-align: center;
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }
    
    .question-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      animation: fadeInUp 0.4s ease;
      border-left: 4px solid #667eea;
    }
    
    .question-number {
      color: #667eea;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .question-text {
      font-size: 18px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .options {
      display: grid;
      gap: 12px;
    }
    
    .option-label {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .option-label:hover {
      border-color: #667eea;
      background: #f7f9ff;
    }
    
    .option-label input[type="radio"] {
      margin-right: 12px;
      width: 20px;
      height: 20px;
    }
    
    .option-label.selected {
      border-color: #667eea;
      background: #f7f9ff;
    }
    
    .option-label.correct {
      border-color: #4caf50;
      background: #e8f5e9;
      animation: pulse 0.5s ease;
    }
    
    .option-label.incorrect {
      border-color: #f44336;
      background: #ffebee;
      animation: shake 0.5s ease;
    }
    
    .feedback {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      animation: fadeIn 0.3s ease;
    }
    
    .feedback.correct {
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #4caf50;
    }
    
    .feedback.incorrect {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }
    
    .quiz-actions {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    
    .btn-submit {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 40px;
      font-size: 18px;
    }
    
    .btn-submit:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    /* Results Screen */
    .quiz-results {
      text-align: center;
      padding: 40px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      animation: zoomIn 0.5s ease;
    }
    
    .score-display {
      font-size: 72px;
      font-weight: bold;
      margin: 20px 0;
      background: linear-gradient(135deg, #667eea, #764ba2);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
    }
    
    .score-message {
      font-size: 24px;
      margin-bottom: 20px;
    }
    
    .score-emoji {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .btn-home {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 40px;
      margin-top: 20px;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .hidden { display: none !important; }
    
    @media (max-width: 768px) {
      .quiz-modes {
        grid-template-columns: 1fr;
      }
      
      .welcome-banner h1 {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-links">
      <button data-section="home">Home</button>
      <button data-section="welcome">Welcome</button>
      <button data-section="scans">My Scans</button>
      <button data-section="training">My Training</button>
      <button data-section="achievements">Achievements</button>
      <button data-section="quiz" class="active">Quiz</button>
      <button id="admin-site-btn" data-section="admin" style="display:none">Admin Site</button>
    </div>
    <div class="user-info">
      <span id="site-info"></span>
      <span id="user-email"></span>
      <span id="user-role"></span>
      <button id="sign-out-btn" class="btn" style="padding: 8px 16px; font-size: 14px;">Sign Out</button>
    </div>
  </nav>

  <div class="container">
    <!-- Quiz Home Screen -->
    <div id="quiz-home" class="quiz-home">
      <div class="welcome-banner">
        <h1>
          <span>üß†</span>
          Weekly Knowledge Check
        </h1>
        <p>Stay sharp with our weekly required quiz and unlimited practice sessions!</p>
      </div>
      
      <div class="quiz-modes">
        <!-- Required Quiz Card -->
        <div class="mode-card required">
          <div class="mode-icon">üìù</div>
          <h2>Required Weekly Quiz</h2>
          <p>Complete your mandatory weekly assessment. One attempt per week, results are recorded.</p>
          
          <div id="required-status" class="mode-status">
            <!-- Status will be populated by JavaScript -->
          </div>
          
          <button id="btn-required" class="btn btn-required">
            Start Required Quiz
          </button>
        </div>
        
        <!-- Practice Quiz Card -->
        <div class="mode-card practice">
          <div class="mode-icon">üéØ</div>
          <h2>Practice Mode</h2>
          <p>Sharpen your skills anytime! Unlimited attempts, learn at your own pace.</p>
          
          <div class="mode-status">
            <p style="color: #44a39f; font-weight: 600;">
              ‚ú® Always Available
            </p>
            <p style="font-size: 14px; color: #666; margin-top: 5px;">
              Practice makes perfect!
            </p>
          </div>
          
          <button id="btn-practice" class="btn btn-practice">
            Start Practice Quiz
          </button>
        </div>
      </div>
    </div>
    
    <!-- Quiz Taking Screen -->
    <div id="quiz-active" class="quiz-active hidden">
      <div class="quiz-header">
        <h2 id="quiz-title">Quiz in Progress</h2>
        <span id="mode-badge" class="mode-badge"></span>
      </div>
      
      <div class="progress-container">
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div id="progress-text" class="progress-text">Question 0 of 10</div>
      </div>
      
      <div id="questions-container">
        <!-- Questions will be populated here -->
      </div>
      
      <div class="quiz-actions">
        <button id="btn-submit" class="btn btn-submit" disabled>
          Submit Quiz
        </button>
      </div>
    </div>
    
    <!-- Results Screen -->
    <div id="quiz-results" class="quiz-results hidden">
      <div class="score-emoji" id="score-emoji">üéâ</div>
      <h2>Quiz Complete!</h2>
      <div class="score-display" id="score-display">0/10</div>
      <div class="score-message" id="score-message">Good effort!</div>
      <div id="result-mode-info" style="margin: 20px 0; color: #666;"></div>
      <button id="btn-home" class="btn btn-home">
        Back to Quiz Home
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase client
    const SUPABASE_URL = 'https://iieevwcwjkxdqmuzixjb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlpZWV2d2N3amt4ZHFtdXppeGpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjEyMTQxMjksImV4cCI6MjAzNjc5MDEyOX0.5sbYGDm8DSkjJxkMHsVWi3gEx1_-yQqzFiRkwer1vzI';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let currentUser = null;
    let currentProfile = null;
    let currentQuestions = [];
    let currentMode = null;
    let userAnswers = {};
    let quizStartTime = null;
    
    // Get start of current week (Sunday)
    function getWeekStart(date = new Date()) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day;
      return new Date(d.setDate(diff));
    }
    
    // Get end of current week (Saturday)
    function getWeekEnd(date = new Date()) {
      const start = getWeekStart(date);
      return new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
    }
    
    // Get next week start (next Sunday)
    function getNextWeekStart(date = new Date()) {
      const end = getWeekEnd(date);
      return new Date(end.getTime() + 24 * 60 * 60 * 1000);
    }
    
    // Format countdown
    function formatCountdown(ms) {
      if (ms <= 0) return 'Ready now!';
      
      const days = Math.floor(ms / (24 * 60 * 60 * 1000));
      const hours = Math.floor((ms % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
      const minutes = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
      
      const parts = [];
      if (days > 0) parts.push(`${days}d`);
      if (hours > 0) parts.push(`${hours}h`);
      if (minutes > 0 || parts.length === 0) parts.push(`${minutes}m`);
      
      return parts.join(' ');
    }
    
    // Check if quiz was taken this week
    async function checkWeeklyQuizStatus() {
      const weekStart = getWeekStart();
      const weekEnd = getWeekEnd();
      
      try {
        const { data, error } = await supabase
          .from('quiz_attempts')
          .select('completed_at')
          .eq('user_id', currentUser.id)
          .eq('is_practice', false)
          .gte('completed_at', weekStart.toISOString())
          .lte('completed_at', weekEnd.toISOString())
          .order('completed_at', { ascending: false })
          .limit(1);
        
        if (!error && data && data.length > 0) {
          // Quiz was taken this week
          return {
            taken: true,
            lastAttempt: new Date(data[0].completed_at),
            nextAvailable: getNextWeekStart()
          };
        }
      } catch (err) {
        console.error('Error checking quiz status:', err);
      }
      
      // Quiz not taken this week or error
      return {
        taken: false,
        lastAttempt: null,
        nextAvailable: new Date()
      };
    }
    
    // Update required quiz status display
    async function updateRequiredQuizStatus() {
      const status = await checkWeeklyQuizStatus();
      const statusEl = document.getElementById('required-status');
      const btnRequired = document.getElementById('btn-required');
      
      if (status.taken) {
        // Quiz already taken this week
        const msUntilNext = status.nextAvailable.getTime() - Date.now();
        statusEl.innerHTML = `
          <p style="color: #28a745; font-weight: 600; margin-bottom: 10px;">
            ‚úÖ Week's Quiz Complete!
          </p>
          <p style="font-size: 14px; color: #666;">Next quiz available:</p>
          <div class="countdown-display" id="countdown">
            ${formatCountdown(msUntilNext)}
          </div>
        `;
        btnRequired.disabled = true;
        btnRequired.textContent = 'Completed This Week';
        
        // Update countdown every minute
        setInterval(() => {
          const ms = status.nextAvailable.getTime() - Date.now();
          const countdownEl = document.getElementById('countdown');
          if (countdownEl) {
            countdownEl.textContent = formatCountdown(ms);
            if (ms <= 0) {
              location.reload(); // Reload when new week starts
            }
          }
        }, 60000);
      } else {
        // Quiz available
        statusEl.innerHTML = `
          <p style="color: #ff6b6b; font-weight: 600;">
            ‚è∞ Quiz Due This Week!
          </p>
          <p style="font-size: 14px; color: #666; margin-top: 5px;">
            Complete before Saturday midnight
          </p>
        `;
        btnRequired.disabled = false;
        btnRequired.textContent = 'Start Required Quiz';
      }
    }
    
    // Fetch quiz questions
    async function fetchQuestions() {
      try {
        // Try to fetch from database with proper joins
        const { data: questions, error } = await supabase
          .from('quiz_questions')
          .select(`
            id,
            question_text,
            hint,
            explanation,
            quiz_options (
              option_text,
              option_order,
              is_correct
            )
          `)
          .eq('is_active', true)
          .limit(50);
        
        if (!error && questions && questions.length > 0) {
          // Format questions with options
          return questions.map(q => {
            const options = (q.quiz_options || [])
              .sort((a, b) => a.option_order - b.option_order)
              .map(opt => opt.option_text);
            
            const correctIndex = (q.quiz_options || [])
              .findIndex(opt => opt.is_correct);
            
            return {
              id: q.id,
              question: q.question_text,
              choices: options,
              answer: correctIndex >= 0 ? correctIndex : 0,
              hint: q.hint,
              explanation: q.explanation
            };
          }).filter(q => q.choices.length > 0);
        }
      } catch (err) {
        console.error('Error fetching questions:', err);
      }
      
      // Fallback questions
      console.log('Using fallback questions');
      return [
        { id: 1, question: 'What should you check first in a safety inspection?', choices: ['PPE availability', 'Kitchen menu', 'Visitor log', 'Weather forecast'], answer: 0 },
        { id: 2, question: 'Hand hygiene should last at least how many seconds?', choices: ['5 seconds', '10 seconds', '20 seconds', '40 seconds'], answer: 2 },
        { id: 3, question: 'Which waste goes into a sharps bin?', choices: ['Used needles', 'Food scraps', 'Paper towels', 'Plastic bottles'], answer: 0 },
        { id: 4, question: 'When should you report a near-miss incident?', choices: ['End of the week', 'Immediately', 'During monthly review', 'Never'], answer: 1 },
        { id: 5, question: 'Which is NOT a fire class?', choices: ['Class A', 'Class B', 'Class D', 'Class H'], answer: 3 },
        { id: 6, question: 'What is the correct method to lift a heavy box?', choices: ['Back bent, legs straight', 'Back straight, bend knees', 'Twist the spine', 'Hold with fingertips'], answer: 1 },
        { id: 7, question: 'A spill kit is used to handle?', choices: ['Electrical faults', 'Chemical spills', 'Printer jams', 'Lost property'], answer: 1 },
        { id: 8, question: 'PAT testing refers to?', choices: ['Patient testing', 'Portable Appliance Testing', 'Public Area Testing', 'Pressure and Temperature'], answer: 1 },
        { id: 9, question: 'What temperature should hot food be kept at?', choices: ['Above 45¬∞C', 'Above 55¬∞C', 'Above 63¬∞C', 'Above 75¬∞C'], answer: 2 },
        { id: 10, question: 'How often should fire alarms be tested?', choices: ['Daily', 'Weekly', 'Monthly', 'Yearly'], answer: 1 },
        { id: 11, question: 'What color is a CO2 fire extinguisher?', choices: ['Red', 'Black', 'Blue', 'Cream'], answer: 1 },
        { id: 12, question: 'COSHH stands for?', choices: ['Control of Substances Hazardous to Health', 'Committee of Safety and Health Hazards', 'Certificate of Safe Handling and Hygiene', 'Central Office for Safety and Health'], answer: 0 },
        { id: 13, question: 'What is the minimum rest break for a 6-hour shift?', choices: ['10 minutes', '20 minutes', '30 minutes', '45 minutes'], answer: 1 },
        { id: 14, question: 'Which PPE protects against airborne particles?', choices: ['Safety glasses', 'FFP3 mask', 'Latex gloves', 'Steel toe boots'], answer: 1 },
        { id: 15, question: 'What is the first step in risk assessment?', choices: ['Control measures', 'Identify hazards', 'Training staff', 'Document findings'], answer: 1 }
      ];
    }
    
    // Shuffle and pick random questions
    function pickRandomQuestions(questions, count = 10) {
      const shuffled = [...questions].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, Math.min(count, shuffled.length));
    }
    
    // Render quiz questions
    function renderQuiz(questions) {
      const container = document.getElementById('questions-container');
      container.innerHTML = '';
      
      questions.forEach((q, index) => {
        const questionCard = document.createElement('div');
        questionCard.className = 'question-card';
        questionCard.innerHTML = `
          <div class="question-number">Question ${index + 1}</div>
          <div class="question-text">${q.question}</div>
          <div class="options">
            ${q.choices.map((choice, choiceIndex) => `
              <label class="option-label" data-question="${index}" data-choice="${choiceIndex}">
                <input type="radio" name="q_${index}" value="${choiceIndex}" />
                <span>${choice}</span>
              </label>
            `).join('')}
          </div>
          <div id="feedback_${index}" class="feedback hidden"></div>
        `;
        container.appendChild(questionCard);
      });
      
      // Add event listeners
      document.querySelectorAll('input[type="radio"]').forEach(input => {
        input.addEventListener('change', (e) => {
          const questionIndex = parseInt(e.target.name.split('_')[1]);
          userAnswers[questionIndex] = parseInt(e.target.value);
          
          // Update option styling
          document.querySelectorAll(`[data-question="${questionIndex}"]`).forEach(label => {
            label.classList.remove('selected');
          });
          e.target.closest('.option-label').classList.add('selected');
          
          updateProgress();
        });
      });
    }
    
    // Update progress
    function updateProgress() {
      const total = currentQuestions.length;
      const answered = Object.keys(userAnswers).length;
      const percentage = (answered / total) * 100;
      
      document.getElementById('progress-fill').style.width = `${percentage}%`;
      document.getElementById('progress-text').textContent = `Question ${answered} of ${total} answered`;
      
      // Enable submit button when all questions answered
      document.getElementById('btn-submit').disabled = answered < total;
    }
    
    // Start quiz
    async function startQuiz(mode) {
      currentMode = mode;
      userAnswers = {};
      quizStartTime = new Date();
      
      // Fetch and prepare questions
      const allQuestions = await fetchQuestions();
      currentQuestions = pickRandomQuestions(allQuestions, 10);
      
      // Update UI
      document.getElementById('quiz-home').classList.add('hidden');
      document.getElementById('quiz-active').classList.remove('hidden');
      document.getElementById('quiz-results').classList.add('hidden');
      
      // Set mode-specific UI
      const titleEl = document.getElementById('quiz-title');
      const badgeEl = document.getElementById('mode-badge');
      
      if (mode === 'required') {
        titleEl.textContent = 'Required Weekly Quiz';
        badgeEl.textContent = 'üìù Official - Results Recorded';
        badgeEl.className = 'mode-badge required';
      } else {
        titleEl.textContent = 'Practice Quiz';
        badgeEl.textContent = 'üéØ Practice - Learn & Improve';
        badgeEl.className = 'mode-badge practice';
      }
      
      // Render questions
      renderQuiz(currentQuestions);
      updateProgress();
    }
    
    // Submit quiz
    async function submitQuiz() {
      const btnSubmit = document.getElementById('btn-submit');
      btnSubmit.disabled = true;
      btnSubmit.textContent = 'Submitting...';
      
      // Calculate score
      let correctCount = 0;
      currentQuestions.forEach((q, index) => {
        const userAnswer = userAnswers[index];
        const isCorrect = userAnswer === q.answer;
        if (isCorrect) correctCount++;
        
        // Show feedback
        const feedbackEl = document.getElementById(`feedback_${index}`);
        const optionLabels = document.querySelectorAll(`[data-question="${index}"]`);
        
        optionLabels.forEach((label, choiceIndex) => {
          if (choiceIndex === q.answer) {
            label.classList.add('correct');
          } else if (choiceIndex === userAnswer && !isCorrect) {
            label.classList.add('incorrect');
          }
        });
        
        if (feedbackEl) {
          feedbackEl.classList.remove('hidden');
          if (isCorrect) {
            feedbackEl.className = 'feedback correct';
            feedbackEl.innerHTML = '‚úÖ Correct!';
          } else {
            feedbackEl.className = 'feedback incorrect';
            feedbackEl.innerHTML = `‚ùå Incorrect. The correct answer is: ${q.choices[q.answer]}`;
          }
        }
      });
      
      const scorePercent = Math.round((correctCount / currentQuestions.length) * 100);
      
      // Save to database
      try {
        if (currentMode === 'required') {
          // Save to quiz_attempts
          await supabase.from('quiz_attempts').insert({
            user_id: currentUser.id,
            site_id: currentProfile?.site_id || null,
            started_at: quizStartTime.toISOString(),
            completed_at: new Date().toISOString(),
            total_questions: currentQuestions.length,
            correct_answers: correctCount,
            score_percent: scorePercent,
            is_practice: false
          });
        } else {
          // Save to quiz_practices if table exists
          try {
            await supabase.from('quiz_practices').insert({
              user_id: currentUser.id,
              site_id: currentProfile?.site_id || null,
              started_at: quizStartTime.toISOString(),
              completed_at: new Date().toISOString(),
              score: correctCount,
              total_questions: currentQuestions.length,
              score_percent: scorePercent
            });
          } catch (err) {
            console.log('quiz_practices table may not exist, skipping save');
          }
        }
      } catch (err) {
        console.error('Error saving quiz attempt:', err);
      }
      
      // Show results after delay
      setTimeout(() => {
        showResults(correctCount, currentQuestions.length, scorePercent);
      }, 2000);
    }
    
    // Show results
    function showResults(correct, total, percentage) {
      document.getElementById('quiz-active').classList.add('hidden');
      document.getElementById('quiz-results').classList.remove('hidden');
      
      // Set score display
      document.getElementById('score-display').textContent = `${correct}/${total}`;
      
      // Set emoji and message based on score
      const emojiEl = document.getElementById('score-emoji');
      const messageEl = document.getElementById('score-message');
      
      if (percentage === 100) {
        emojiEl.textContent = 'üèÜ';
        messageEl.textContent = 'Perfect Score! Outstanding!';
      } else if (percentage >= 80) {
        emojiEl.textContent = 'üéâ';
        messageEl.textContent = 'Excellent Work!';
      } else if (percentage >= 60) {
        emojiEl.textContent = 'üëç';
        messageEl.textContent = 'Good Job!';
      } else if (percentage >= 40) {
        emojiEl.textContent = 'üí™';
        messageEl.textContent = 'Keep Practicing!';
      } else {
        emojiEl.textContent = 'üìö';
        messageEl.textContent = 'Review and Try Again!';
      }
      
      // Set mode info
      const modeInfoEl = document.getElementById('result-mode-info');
      if (currentMode === 'required') {
        modeInfoEl.innerHTML = `
          <strong>‚úÖ Required Quiz Complete</strong><br>
          Your result has been recorded. See you next week!
        `;
      } else {
        modeInfoEl.innerHTML = `
          <strong>üéØ Practice Complete</strong><br>
          Great practice session! Try again anytime to improve.
        `;
      }
    }
    
    // Initialize
    async function init() {
      try {
        // Check authentication
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          // For testing, use a mock user
          console.log('No session, using mock user for testing');
          currentUser = {
            id: 'test-user-id',
            email: 'benhowardmagic@hotmail.com'
          };
        } else {
          currentUser = session.user;
        }
        
        // Get profile
        const { data: profile } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();
        
        currentProfile = profile;
        
        // Update nav user info
        document.getElementById('user-email').textContent = currentUser.email;
        document.getElementById('user-role').textContent = profile?.role || 'Staff';
        
        // Show admin button if admin
        if (profile?.role === 'admin' || profile?.role === 'Admin') {
          document.getElementById('admin-site-btn').style.display = 'block';
        }
        
        // Update required quiz status
        await updateRequiredQuizStatus();
        
        // Event listeners
        document.getElementById('btn-required').addEventListener('click', () => {
          startQuiz('required');
        });
        
        document.getElementById('btn-practice').addEventListener('click', () => {
          startQuiz('practice');
        });
        
        document.getElementById('btn-submit').addEventListener('click', submitQuiz);
        
        document.getElementById('btn-home').addEventListener('click', () => {
          location.reload();
        });
        
        document.getElementById('sign-out-btn').addEventListener('click', async () => {
          await supabase.auth.signOut();
          window.location.href = 'index.html';
        });
        
        // Nav buttons
        document.querySelectorAll('.nav-links button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const section = e.target.dataset.section;
            if (section === 'admin') {
              window.location.href = 'admin.html';
            } else if (section !== 'quiz') {
              window.location.href = `staff.html#${section}`;
            }
          });
        });
        
      } catch (error) {
        console.error('Initialization error:', error);
      }
    }
    
    // Start the app
    init();
  </script>
</body>
</html>
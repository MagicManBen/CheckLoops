<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prompt Reworder — Supabase Extras</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --muted: #9aa3b2;
      --text: #e7ecf3;
      --accent: #6aa2ff;
      --accent-2: #9fe870;
      --danger: #ff6b6b;
      --radius: 14px;
    }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 24px; background: var(--bg); color: var(--text);
      font: 14px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    .app { max-width: 900px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .card { background: var(--card); border-radius: var(--radius); padding: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); }
    .stack { display: grid; gap: 10px; }
    label { font-weight: 600; font-size: 12px; color: var(--muted); }
    textarea, input[type="password"], input[type="text"], select {
      width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08);
      background: #0c1423; color: var(--text); outline: none; min-height: 44px;
    }
    textarea { min-height: 180px; resize: vertical; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); background: #0c1423; color: var(--text); cursor: pointer; }
    .btn.primary { background: var(--accent); color: #061126; border: none; font-weight: 700; }
    .btn.ghost { background: transparent; }
    .hint { color: var(--muted); font-size: 12px; }
    .ok { color: var(--accent-2); }
    .err { color: var(--danger); }
    .footer { opacity: .7; font-size: 12px; }
    .pill { padding: 4px 8px; background: #0c1423; border-radius: 999px; border: 1px solid rgba(255,255,255,0.08); }
  </style>
</head>
<body>
  <div class="app stack">
    <h1>Prompt Reworder <span class="pill">with Supabase extras</span></h1>
    <div class="card stack">
      <div class="row" style="justify-content: space-between; align-items: end; gap: 16px;">
        <div style="flex: 2 1 340px;" class="stack">
          <label for="apiKey">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</label>
          <div class="row" style="gap:8px;">
            <input id="apiKey" type="password" placeholder="sk-..." inputmode="text" autocomplete="off" />
            <button class="btn" id="toggleKey" title="Show/Hide">Show</button>
            <label class="row hint" style="gap:6px;">
              <input type="checkbox" id="rememberKey" /> Remember on this Mac (localStorage)
            </label>
          </div>
        </div>
        <div style="flex: 1 1 220px;" class="stack">
          <label for="model">Model</label>
          <select id="model">
            <option value="gpt-4o-mini" selected>gpt-4o-mini (fast)</option>
            <option value="gpt-4o">gpt-4o (higher quality)</option>
          </select>
        </div>
      </div>

      <div class="stack">
        <label for="input">Your text</label>
        <textarea id="input" placeholder="Paste your to-do/task here..."></textarea>
      </div>

      <div class="row">
        <button class="btn primary" id="go">Reword</button>
        <button class="btn" id="copy">Copy output</button>
        <span id="status" class="hint"></span>
      </div>

      <div class="stack">
        <label for="output">Output (single paragraph + Supabase footer)</label>
        <textarea id="output" readonly placeholder="Your reworded prompt will appear here..."></textarea>
      </div>

      <div class="footer hint">
        Runs entirely in your browser. Your API key is used only to call OpenAI and never leaves this page except in that request. For best security, don’t tick “Remember on this Mac.”
      </div>
    </div>
  </div>

  <script>
    // === Constants ===
    const NON_INTERACTIVE_NOTE = `Use a non-interactive approach for database connections and tooling—do not prompt me to type passwords; rely on environment variables, a full connection string, or .pgpass so commands run unattended.`;

    // Keep this EXACTLY as given (verbatim), including the ending `index.html)`.
    const SUPABASE_FOOTER = `I have Supabase CLI installed with a local dev environment running and a linked remote project called “scanner-app.” When working with tables: first run supabase projects list to confirm the linked project; use grep -r "table_name" . to search the codebase for existing references; check SupabaseInfo.txt for a quick snapshot of table schemas and sample data (treat it as non-authoritative); for live remote data checks, run supabase db pull to sync the remote schema locally, then query using psql "postgresql://postgres:postgres@127.0.0.1:54322/postgres" -c "SELECT * FROM table_name;". Remember the local instance (port 54322) may be empty unless synced, while actual data lives in the remote project—always distinguish local dev vs remote prod. Use the CLI as the source of truth to view all tables/details and to make amendments (DDL/DML/migrations) where appropriate. After any DB or HTML/JS change, open the site in a browser and test end-to-end with both Admin/Owner and Staff accounts provided in the prompt; loop amend → test → fix → retest until behavior matches expectations; when finished, explicitly state success and list what changed and which tests passed. Use the database password gothuh-kicza8-Vokgar This will be changed, this is just for changing. index.html)`;

    // === Elements ===
    const el = (id) => document.getElementById(id);
    const apiKeyInput = el('apiKey');
    const rememberKey = el('rememberKey');
    const toggleKeyBtn = el('toggleKey');
    const modelSel = el('model');
    const inputTA = el('input');
    const outputTA = el('output');
    const goBtn = el('go');
    const copyBtn = el('copy');
    const status = el('status');

    // Restore key if user chose to remember it.
    try {
      const remembered = localStorage.getItem('pr_api_key');
      if (remembered) {
        apiKeyInput.value = remembered;
        rememberKey.checked = true;
      }
    } catch {}

    toggleKeyBtn.addEventListener('click', () => {
      apiKeyInput.type = apiKeyInput.type === 'password' ? 'text' : 'password';
      toggleKeyBtn.textContent = apiKeyInput.type === 'password' ? 'Show' : 'Hide';
    });

    rememberKey.addEventListener('change', () => {
      try {
        if (rememberKey.checked) {
          localStorage.setItem('pr_api_key', apiKeyInput.value || '');
        } else {
          localStorage.removeItem('pr_api_key');
        }
      } catch {}
    });

    apiKeyInput.addEventListener('input', () => {
      if (rememberKey.checked) {
        try { localStorage.setItem('pr_api_key', apiKeyInput.value || ''); } catch {}
      }
    });

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(outputTA.value);
        setStatus('Copied to clipboard.', 'ok');
      } catch {
        setStatus('Copy failed (permissions?).', 'err');
      }
    });

    goBtn.addEventListener('click', async () => {
      const key = apiKeyInput.value.trim();
      const model = modelSel.value;
      const text = inputTA.value.trim();
      if (!key) return setStatus('Add your OpenAI API key.', 'err');
      if (!text) return setStatus('Paste some text first.', 'err');

      setStatus('Rewording…');
      goBtn.disabled = true; goBtn.textContent = 'Working…';
      try {
        const rewritten = await callOpenAI(key, model, text);
        const unified = normalizeOneParagraph(`${rewritten} ${NON_INTERACTIVE_NOTE} ${SUPABASE_FOOTER}`.trim());
        outputTA.value = unified;
        setStatus('Done.', 'ok');
      } catch (e) {
        console.error(e);
        setStatus(String(e?.message || e), 'err');
      } finally {
        goBtn.disabled = false; goBtn.textContent = 'Reword';
      }
    });

    function setStatus(msg, kind) {
      status.textContent = msg;
      status.className = 'hint ' + (kind || '');
    }

    function normalizeOneParagraph(str) {
      return str
        .replace(/\s+/g, ' ')     // collapse whitespace
        .replace(/\s*([.,;:!?])\s*/g, '$1 ') // tidy punctuation spacing
        .replace(/\s+\)/g, ')')
        .trim();
    }

    async function callOpenAI(apiKey, model, raw) {
      // Using the Responses API for simplicity; we read output_text.
      const body = {
        model,
        instructions: [
          "Rewrite the user's text into a single, polished AI prompt.",
          'Keep it one paragraph (no bullet points).',
          'Preserve intent and constraints; clarify ambiguity; improve wording.',
          'Do not include code fences or extra commentary.'
        ].join(' '),
        input: raw
      };

      const res = await fetch('https://api.openai.com/v1/responses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`OpenAI error ${res.status}: ${text}`);
      }
      const data = await res.json();
      const out = data.output_text || extractTextFromOutput(data);
      if (!out) throw new Error('No text returned by model.');
      return out.trim();
    }

    function extractTextFromOutput(data) {
      try {
        const content = data.output?.[0]?.content;
        if (Array.isArray(content)) {
          const piece = content.find(p => p.type && (p.type.includes('text') || p.type.includes('output_text')));
          return piece?.text || null;
        }
      } catch {}
      try { return data.choices?.[0]?.message?.content || null; } catch {}
      return null;
    }
  </script>
</body>
</html>

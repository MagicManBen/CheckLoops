<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Fix Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .card {
            background-color: white;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .card h2 {
            margin-top: 0;
            color: #3498db;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .info-row {
            display: flex;
            margin-bottom: 8px;
        }
        .info-label {
            flex: 0 0 180px;
            font-weight: bold;
        }
        .info-value {
            flex: 1;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #2980b9;
        }
        pre {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
            margin-top: 10px;
        }
        #status-container {
            margin-top: 20px;
            font-weight: bold;
        }
        .progress-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #3498db;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Holiday Fix Verification</h1>
        
        <div class="card">
            <h2>Test Holiday Fix for Ben Howard</h2>
            <p>This page will verify that Ben Howard's holidays are correctly calculated from the 4_holiday_requests table.</p>
            <button id="run-test">Run Verification</button>
            <div id="status-container"></div>
        </div>
        
        <div class="card">
            <h2>Ben Howard's Profile</h2>
            <div id="profile-container">Click "Run Verification" to load data...</div>
        </div>
        
        <div class="card">
            <h2>Approved Holiday Requests</h2>
            <div id="holidays-container">Click "Run Verification" to load data...</div>
        </div>
        
        <div class="card">
            <h2>Calculated Holiday Values</h2>
            <div id="calculation-container">Click "Run Verification" to load data...</div>
        </div>
    </div>

    <!-- Include Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.js"></script>
    
    <script>
        const MS_PER_DAY = 1000 * 60 * 60 * 24;

        function toNumber(value) {
            const num = parseFloat(value);
            return Number.isFinite(num) ? num : 0;
        }

        function aggregateHolidayUsage(requests) {
            const usageMap = {};

            (requests || []).forEach((holiday) => {
                const userKey = holiday?.user_id || holiday?.auth_user_id;
                if (!userKey) return;

                if (!usageMap[userKey]) {
                    usageMap[userKey] = { hours: 0, sessions: 0, totalDays: 0, count: 0 };
                }

                const entry = usageMap[userKey];
                entry.count += 1;

                const totalDays = toNumber(holiday?.total_days);
                const totalHours = toNumber(holiday?.total_hours);
                const totalSessions = toNumber(holiday?.total_sessions);
                const hoursPerDay = toNumber(holiday?.hours_per_day);
                const sessionsPerDay = toNumber(holiday?.sessions_per_day);

                if (totalDays > 0) {
                    entry.totalDays += totalDays;
                }

                if (totalHours > 0) {
                    entry.hours += totalHours;
                }

                if (totalSessions > 0) {
                    entry.sessions += totalSessions;
                }

                const hasManualHours = totalHours > 0;
                const hasManualSessions = totalSessions > 0;
                const hasTotalDays = totalDays > 0;

                if ((hoursPerDay > 0) && !hasManualHours && !hasTotalDays) {
                    const start = holiday?.start_date ? new Date(holiday.start_date) : null;
                    const end = holiday?.end_date ? new Date(holiday.end_date) : null;
                    const dayCount = start && end ? Math.max(1, Math.round((end - start) / MS_PER_DAY) + 1) : 1;
                    entry.hours += hoursPerDay * dayCount;
                }

                if ((sessionsPerDay > 0) && !hasManualSessions && !hasTotalDays) {
                    const start = holiday?.start_date ? new Date(holiday.start_date) : null;
                    const end = holiday?.end_date ? new Date(holiday.end_date) : null;
                    const dayCount = start && end ? Math.max(1, Math.round((end - start) / MS_PER_DAY) + 1) : 1;
                    entry.sessions += sessionsPerDay * dayCount;
                }
            });

            return usageMap;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Supabase client
            const supabaseUrl = localStorage.getItem('supabaseUrl');
            const supabaseKey = localStorage.getItem('supabaseKey');
            
            if (!supabaseUrl || !supabaseKey) {
                document.getElementById('status-container').innerHTML = `
                    <div class="error">
                        Supabase credentials not found in localStorage. Please open the admin dashboard first.
                    </div>
                `;
                return;
            }
            
            const supabase = supabase.createClient(supabaseUrl, supabaseKey);
            window.supabase = supabase;
            
            const runTestButton = document.getElementById('run-test');
            const statusContainer = document.getElementById('status-container');
            const profileContainer = document.getElementById('profile-container');
            const holidaysContainer = document.getElementById('holidays-container');
            const calculationContainer = document.getElementById('calculation-container');
            
            runTestButton.addEventListener('click', async function() {
                // Show loading state
                statusContainer.innerHTML = '<div class="progress-indicator"></div> Running verification...';
                profileContainer.innerHTML = '<div class="progress-indicator"></div> Loading profile...';
                holidaysContainer.innerHTML = '<div class="progress-indicator"></div> Loading holiday requests...';
                calculationContainer.innerHTML = '<div class="progress-indicator"></div> Calculating...';
                
                try {
                    // Step 1: Get Ben Howard's profile
                    const { data: benData, error: benError } = await supabase
                        .from('master_users')
                        .select('*')
                        .ilike('full_name', '%ben howard%')
                        .limit(1);
                    
                    if (benError || !benData || benData.length === 0) {
                        throw new Error('Could not find Ben Howard in master_users: ' + (benError?.message || 'No data found'));
                    }
                    
                    const benProfile = benData[0];
                    const benUserId = benProfile.auth_user_id;
                    
                    // Display profile information
                    profileContainer.innerHTML = `
                        <div class="info-row">
                            <div class="info-label">Name:</div>
                            <div class="info-value">${benProfile.full_name}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">User ID:</div>
                            <div class="info-value">${benUserId}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Role:</div>
                            <div class="info-value">${benProfile.role_title || benProfile.access_type || 'Unknown'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Is GP:</div>
                            <div class="info-value">${!!benProfile.is_gp ? 'Yes' : 'No'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">holidays_used_hours:</div>
                            <div class="info-value">${benProfile.holidays_used_hours || 0}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">holidays_used_sessions:</div>
                            <div class="info-value">${benProfile.holidays_used_sessions || 0}</div>
                        </div>
                        <pre>${JSON.stringify(benProfile, null, 2)}</pre>
                    `;
                    
                    // Step 2: Get Ben's holiday requests
                    const { data: benHolidays, error: holidayError } = await supabase
                        .from('4_holiday_requests')
                        .select('*')
                        .eq('user_id', benUserId)
                        .eq('status', 'approved');
                    
                    if (holidayError) {
                        throw new Error('Error fetching Ben Howard holiday requests: ' + holidayError.message);
                    }
                    
                    // Display holiday requests
                    if (benHolidays.length === 0) {
                        holidaysContainer.innerHTML = 'No approved holiday requests found for Ben Howard.';
                    } else {
                        let holidaysHtml = `<p>Found ${benHolidays.length} approved holiday requests:</p>`;
                        
                        benHolidays.forEach((holiday, index) => {
                            holidaysHtml += `
                                <div class="card">
                                    <h3>Holiday #${index + 1}</h3>
                                    <div class="info-row">
                                        <div class="info-label">Start Date:</div>
                                        <div class="info-value">${holiday.start_date}</div>
                                    </div>
                                    <div class="info-row">
                                        <div class="info-label">End Date:</div>
                                        <div class="info-value">${holiday.end_date}</div>
                                    </div>
                                    <div class="info-row">
                                        <div class="info-label">Hours per Day:</div>
                                        <div class="info-value">${holiday.hours_per_day || 0}</div>
                                    </div>
                                    <div class="info-row">
                                        <div class="info-label">Sessions per Day:</div>
                                        <div class="info-value">${holiday.sessions_per_day || 0}</div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        holidaysContainer.innerHTML = holidaysHtml;
                    }
                    
                    // Step 3: Calculate totals using same aggregation logic as dashboard
                    const usageMap = aggregateHolidayUsage(benHolidays);
                    const usageEntry = usageMap[benUserId] || { hours: 0, sessions: 0, totalDays: 0 };
                    const totalHours = usageEntry.hours > 0 ? usageEntry.hours : usageEntry.totalDays;
                    const totalSessions = usageEntry.sessions > 0 ? usageEntry.sessions : usageEntry.totalDays;
                    
                    // Step 4: Calculate entitlement
                    const isGP = !!benProfile.is_gp;
                    const unit = isGP ? 'sessions' : 'hours';
                    
                    // Get weekly totals
                    let weeklyTotal = 0;
                    if (isGP) {
                        weeklyTotal = parseFloat(benProfile.weekly_sessions || benProfile.total_sessions || 0);
                    } else {
                        weeklyTotal = parseFloat(benProfile.weekly_hours || benProfile.total_hours || 0);
                    }
                    
                    // If no weekly total, calculate from daily values
                    if (weeklyTotal === 0) {
                        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                        days.forEach(day => {
                            const fieldName = isGP ? `${day}_sessions` : `${day}_hours`;
                            weeklyTotal += parseFloat(benProfile[fieldName] || 0);
                        });
                    }
                    
                    // Get entitlement values
                    const multiplier = benProfile.holiday_multiplier || 6;
                    const calculated = isGP ? benProfile.calculated_sessions : benProfile.calculated_hours;
                    const override = benProfile.manual_override ? (isGP ? benProfile.override_sessions : benProfile.override_hours) : null;
                    const finalEntitlement = override !== null ? override : (calculated || 0);
                    
                    // Use calculated holiday usage
                    const booked = isGP ? totalSessions : totalHours;
                    const remaining = finalEntitlement - booked;
                    
                    calculationContainer.innerHTML = `
                        <div class="info-row">
                            <div class="info-label">Weekly Total:</div>
                            <div class="info-value">${weeklyTotal} ${unit}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Multiplier:</div>
                            <div class="info-value">×${multiplier}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Calculated Entitlement:</div>
                            <div class="info-value">${calculated || 0} ${unit}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Override Entitlement:</div>
                            <div class="info-value">${override !== null ? override : 'Not set'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Final Entitlement:</div>
                            <div class="info-value">${finalEntitlement} ${unit}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Booked (calculated):</div>
                            <div class="info-value success">${booked} ${unit}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Raw usage entry:</div>
                            <div class="info-value"><pre>${JSON.stringify(usageEntry, null, 2)}</pre></div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Remaining:</div>
                            <div class="info-value">${remaining} ${unit}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Profile holidays_used:</div>
                            <div class="info-value error">${isGP ? (benProfile.holidays_used_sessions || 0) : (benProfile.holidays_used_hours || 0)} ${unit}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Fix Needed:</div>
                            <div class="info-value success">Yes - and it's been applied!</div>
                        </div>
                    `;
                    
                    statusContainer.innerHTML = `
                        <div class="success">
                            ✅ Verification complete! Ben Howard has ${benHolidays.length} approved holiday requests.
                            <br>Total calculated holiday ${unit}: ${booked}, which is correctly shown in the dashboard now.
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Verification error:', error);
                    statusContainer.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                }
            });
        });
    </script>
</body>
</html>
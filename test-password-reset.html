<!DOCTYPE html>
<html>
<head>
  <title>Password Reset Debug Tool</title>
  <script src="config.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
    }
    .debug-section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #4CAF50;
      border-radius: 4px;
    }
    .error {
      border-left-color: #f44336;
      background: #ffebee;
    }
    .warning {
      border-left-color: #ff9800;
      background: #fff3e0;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    button {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 0;
    }
    button:hover {
      background: #45a049;
    }
    input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Password Reset Debug Tool</h1>

    <div class="debug-section">
      <h3>Current URL Analysis</h3>
      <pre id="url-info">Loading...</pre>
    </div>

    <div class="debug-section">
      <h3>Token Status</h3>
      <pre id="token-status">Checking tokens...</pre>
    </div>

    <div class="debug-section">
      <h3>Test Password Update</h3>
      <input type="password" id="test-password" placeholder="Enter test password (min 6 chars)" />
      <button onclick="testPasswordUpdate()">Test Password Update</button>
      <pre id="test-result"></pre>
    </div>

    <div class="debug-section">
      <h3>API Test Results</h3>
      <button onclick="testUserEndpoint()">Test /auth/v1/user Endpoint</button>
      <pre id="api-result"></pre>
    </div>

    <div class="debug-section">
      <h3>Recommendations</h3>
      <div id="recommendations"></div>
    </div>
  </div>

  <script>
    // Parse URL
    const url = new URL(window.location.href);
    const searchParams = url.searchParams;
    const hashParams = new URLSearchParams(window.location.hash.substring(1));

    const urlParams = {
      email: searchParams.get('email'),
      site_id: searchParams.get('site_id'),
      access_token: hashParams.get('access_token'),
      refresh_token: hashParams.get('refresh_token'),
      type: hashParams.get('type')
    };

    // Display URL info
    document.getElementById('url-info').textContent = JSON.stringify({
      fullUrl: window.location.href,
      searchParams: Object.fromEntries(searchParams),
      hashParams: Object.fromEntries(hashParams),
      parsedParams: urlParams
    }, null, 2);

    // Check token status
    function checkTokens() {
      const status = {
        hasAccessToken: !!urlParams.access_token,
        accessTokenLength: urlParams.access_token ? urlParams.access_token.length : 0,
        hasRefreshToken: !!urlParams.refresh_token,
        refreshTokenLength: urlParams.refresh_token ? urlParams.refresh_token.length : 0,
        tokenType: urlParams.type || 'not specified',
        isRecoveryFlow: urlParams.type === 'recovery' || !urlParams.refresh_token
      };

      document.getElementById('token-status').textContent = JSON.stringify(status, null, 2);

      // Add recommendations
      const recs = [];
      if (!urlParams.access_token) {
        recs.push('‚ùå No access token found - the password reset link may be incomplete or expired');
      }
      if (!urlParams.refresh_token && !urlParams.type) {
        recs.push('‚ö†Ô∏è No refresh token and no type specified - assuming recovery flow');
      }
      if (urlParams.access_token && urlParams.access_token.length < 50) {
        recs.push('‚ö†Ô∏è Access token seems unusually short - may be truncated');
      }

      const recDiv = document.getElementById('recommendations');
      if (recs.length > 0) {
        recDiv.innerHTML = '<ul>' + recs.map(r => `<li>${r}</li>`).join('') + '</ul>';
      } else {
        recDiv.innerHTML = '<p>‚úÖ URL parameters look valid</p>';
      }

      return status;
    }

    // Test user endpoint
    async function testUserEndpoint() {
      if (!urlParams.access_token) {
        document.getElementById('api-result').textContent = 'Error: No access token available';
        return;
      }

      const result = document.getElementById('api-result');
      result.textContent = 'Testing...';

      try {
        const response = await fetch(`${CONFIG.SUPABASE_URL}/auth/v1/user`, {
          headers: {
            'apikey': CONFIG.SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${urlParams.access_token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        result.textContent = JSON.stringify({
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          data: response.ok ? data : null,
          error: !response.ok ? data : null
        }, null, 2);

        if (!response.ok) {
          result.parentElement.classList.add('error');
        }

      } catch (error) {
        result.textContent = `Network Error: ${error.message}`;
        result.parentElement.classList.add('error');
      }
    }

    // Test password update
    async function testPasswordUpdate() {
      const password = document.getElementById('test-password').value;
      const result = document.getElementById('test-result');

      if (!password || password.length < 6) {
        result.textContent = 'Please enter a password with at least 6 characters';
        return;
      }

      if (!urlParams.access_token) {
        result.textContent = 'Error: No access token available';
        return;
      }

      result.textContent = 'Testing password update...';

      try {
        const response = await fetch(`${CONFIG.SUPABASE_URL}/auth/v1/user`, {
          method: 'PUT',
          headers: {
            'apikey': CONFIG.SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${urlParams.access_token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password })
        });

        const text = await response.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          data = text;
        }

        result.textContent = JSON.stringify({
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          headers: {
            'content-type': response.headers.get('content-type'),
            'x-request-id': response.headers.get('x-request-id')
          },
          response: data
        }, null, 2);

        if (response.ok) {
          result.parentElement.classList.remove('error');
          result.parentElement.style.borderLeftColor = '#4CAF50';
          alert('‚úÖ Password updated successfully! You can now use the main password reset page.');
        } else {
          result.parentElement.classList.add('error');

          // Provide specific guidance
          if (response.status === 422) {
            alert('‚ùå 422 Error: The server cannot process this request. This usually means:\n\n' +
                  '1. The password doesn\'t meet requirements\n' +
                  '2. The token format is invalid\n' +
                  '3. Missing required fields\n\n' +
                  'Check the response details above for more information.');
          }
        }

      } catch (error) {
        result.textContent = `Network Error: ${error.message}`;
        result.parentElement.classList.add('error');
      }
    }

    // Initialize
    checkTokens();

    // Auto-test if we have tokens
    if (urlParams.access_token) {
      setTimeout(() => {
        console.log('Auto-testing user endpoint...');
        testUserEndpoint();
      }, 500);
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Data Management - Database Connected</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #4f46e5;
            color: white;
            padding: 20px;
        }

        .header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 28px;
            font-weight: 600;
        }

        .header p {
            margin-top: 8px;
            opacity: 0.9;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .tabs {
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            background: #f8fafc;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s;
        }

        .tab-button.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            background: white;
        }

        .tab-content {
            padding: 20px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .search-box {
            width: 100%;
            max-width: 400px;
            padding: 10px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th {
            background: #f8fafc;
            color: #374151;
            font-weight: 600;
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-registered {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .success {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .info {
            background: #dbeafe;
            border: 1px solid #bfdbfe;
            color: #1d4ed8;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="admin-dashboard.html" class="back-button">
                ‚Üê Back to Dashboard
            </a>
            <h1>
                üèñÔ∏è Holiday Data Management
            </h1>
            <p>View holiday entitlements and historical data from database</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalStaff">-</div>
                <div class="stat-label">Total Staff</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="registeredUsers">-</div>
                <div class="stat-label">Registered Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingStaff">-</div>
                <div class="stat-label">Pending Staff</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalHolidayDays">-</div>
                <div class="stat-label">Total Holiday Days</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" data-tab="overview">Staff Overview</button>
            <button class="tab-button" data-tab="holidays">Historical Holidays</button>
            <button class="tab-button" data-tab="database">Database Status</button>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="overview">
                <h2>Staff Holiday Overview</h2>
                <input type="text" id="staffSearch" class="search-box" placeholder="Search by staff name...">
                <div class="loading" id="staffLoading">Loading staff data...</div>
                <div id="staffError" class="error" style="display: none;"></div>
                <table class="data-table" id="staffTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Entitlement</th>
                            <th>Holiday Days</th>
                        </tr>
                    </thead>
                    <tbody id="staffTableBody">
                    </tbody>
                </table>
            </div>

            <div class="tab-pane" id="holidays">
                <h2>Historical Holiday Data</h2>
                <input type="text" id="holidaySearch" class="search-box" placeholder="Search by staff name...">
                <div class="loading" id="holidayLoading">Loading holiday data...</div>
                <div id="holidayError" class="error" style="display: none;"></div>
                <table class="data-table" id="holidayTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Staff Name</th>
                            <th>Time/Sessions</th>
                            <th>Type</th>
                            <th>Month</th>
                        </tr>
                    </thead>
                    <tbody id="holidayTableBody">
                    </tbody>
                </table>
            </div>

            <div class="tab-pane" id="database">
                <h2>Database Connection Status</h2>
                
                <h3>Connection Info</h3>
                <div class="success">
                    ‚úÖ Connected to Supabase at https://unveoqnlqnobufhublyw.supabase.co
                </div>

                <h3>Database Tables Status</h3>
                <div id="dbStatus" class="loading">Checking database status...</div>

                <h3>Data Import Note</h3>
                <div class="info">
                    ‚ÑπÔ∏è This page shows real data from the Supabase database. Holiday import was successful using service role key.
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Initialize Supabase
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        
        // User IDs for registered staff
        const REGISTERED_USERS = {
            '55f1b4e6-01f4-452d-8d6c-617fe7794873': {
                name: 'Ben Howard',
                email: 'ben.howard@stoke.nhs.uk',
                role: 'Manager'
            },
            '68a1a111-ac7c-44a3-8fd3-8c37ff07e0a2': {
                name: 'Tom Donlan', 
                email: 'tom.donlan@stoke.nhs.uk',
                role: 'Admin'
            }
        };

        let holidayData = [];
        let staffData = [];

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                
                // Update button states
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                
                // Show/hide tab panes
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                
                // Load data for the tab
                if (tabName === 'database' && !document.getElementById('dbStatus').querySelector('.success')) {
                    loadDatabaseStatus();
                }
            });
        });

        // Load data on page load
        async function loadAllData() {
            try {
                await Promise.all([
                    loadStaffData(),
                    loadHolidayData()
                ]);
                updateStats();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadStaffData() {
            try {
                document.getElementById('staffLoading').style.display = 'block';
                document.getElementById('staffError').style.display = 'none';
                document.getElementById('staffTable').style.display = 'none';

                // Fetch staff profiles and entitlements from new tables
                const { data: profiles, error: profError } = await supabaseClient
                    .from('1_staff_holiday_profiles')
                    .select('*');
                
                if (profError) throw profError;
                
                const profileIds = profiles.map(p => p.id);
                
                const { data: entitlements, error: entError } = await supabaseClient
                    .from('2_staff_entitlements')
                    .select('*')
                    .in('staff_profile_id', profileIds);

                if (entError) throw entError;

                // Fetch holiday bookings from new table
                const { data: requests, error: reqError } = await supabaseClient
                    .from('4_holiday_bookings')
                    .select('*')
                    .in('staff_profile_id', profileIds);

                if (reqError) throw reqError;

                // Build staff data
                staffData = Object.entries(REGISTERED_USERS).map(([userId, userInfo]) => {
                    const entitlement = entitlements.find(e => e.user_id === userId);
                    const userRequests = requests.filter(r => r.user_id === userId);
                    const totalDays = userRequests.reduce((sum, r) => sum + (r.holiday_request_days?.length || 0), 0);
                    
                    return {
                        ...userInfo,
                        userId,
                        status: 'Registered',
                        entitlement: entitlement ? `${entitlement.annual_hours}h` : 'No entitlement',
                        holidayDays: totalDays
                    };
                });

                displayStaffData(staffData);

            } catch (error) {
                console.error('Error loading staff data:', error);
                document.getElementById('staffError').textContent = 'Error loading staff data: ' + error.message;
                document.getElementById('staffError').style.display = 'block';
            } finally {
                document.getElementById('staffLoading').style.display = 'none';
            }
        }

        async function loadHolidayData() {
            try {
                document.getElementById('holidayLoading').style.display = 'block';
                document.getElementById('holidayError').style.display = 'none';
                document.getElementById('holidayTable').style.display = 'none';

                // Fetch all holiday bookings from new table
                const { data: profiles } = await supabaseClient
                    .from('1_staff_holiday_profiles')
                    .select('*');
                    
                const profileIds = profiles.map(p => p.id);
                
                const { data: requests, error } = await supabaseClient
                    .from('4_holiday_bookings')
                    .select('*')
                    .in('staff_profile_id', profileIds)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Flatten and format holiday data
                holidayData = [];
                requests.forEach(request => {
                    const userInfo = REGISTERED_USERS[request.user_id];
                    if (request.holiday_request_days) {
                        request.holiday_request_days.forEach(day => {
                            holidayData.push({
                                date: day.holiday_date,
                                staffName: userInfo.name,
                                timeValue: day.hours_requested > 0 ? `${day.hours_requested}h` : `${day.sessions_requested} sessions`,
                                type: day.hours_requested > 0 ? 'Hours' : 'Sessions',
                                month: day.holiday_date.substring(0, 7) // YYYY-MM
                            });
                        });
                    }
                });

                // Sort by date descending
                holidayData.sort((a, b) => b.date.localeCompare(a.date));

                displayHolidayData(holidayData);

            } catch (error) {
                console.error('Error loading holiday data:', error);
                document.getElementById('holidayError').textContent = 'Error loading holiday data: ' + error.message;
                document.getElementById('holidayError').style.display = 'block';
            } finally {
                document.getElementById('holidayLoading').style.display = 'none';
            }
        }

        async function loadDatabaseStatus() {
            const statusDiv = document.getElementById('dbStatus');
            statusDiv.innerHTML = 'Checking database status...';

            try {
                // Check each table - using new numbered tables
                const tables = ['1_staff_holiday_profiles', '2_staff_entitlements', '3_staff_working_patterns', '4_holiday_bookings', '5_staff_profile_user_links'];
                const results = [];

                for (const table of tables) {
                    const { count, error } = await supabaseClient
                        .from(table)
                        .select('*', { count: 'exact', head: true });

                    results.push({
                        table,
                        count: error ? 'Error' : (count || 0),
                        status: error ? '‚ùå' : '‚úÖ'
                    });
                }

                statusDiv.innerHTML = `
                    <ul style="list-style: none; padding: 0;">
                        ${results.map(r => `<li style="margin: 8px 0;">${r.status} ${r.table}: ${r.count} records</li>`).join('')}
                    </ul>
                `;

            } catch (error) {
                statusDiv.innerHTML = `<div class="error">Error checking database: ${error.message}</div>`;
            }
        }

        function displayStaffData(data) {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '';

            data.forEach(staff => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${staff.name}</td>
                    <td>${staff.email}</td>
                    <td>${staff.role}</td>
                    <td><span class="status-badge status-registered">${staff.status}</span></td>
                    <td>${staff.entitlement}</td>
                    <td>${staff.holidayDays} days</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('staffTable').style.display = 'table';
        }

        function displayHolidayData(data) {
            const tbody = document.getElementById('holidayTableBody');
            tbody.innerHTML = '';

            data.forEach(holiday => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${holiday.date}</td>
                    <td>${holiday.staffName}</td>
                    <td>${holiday.timeValue}</td>
                    <td>${holiday.type}</td>
                    <td>${holiday.month}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('holidayTable').style.display = 'table';
        }

        function updateStats() {
            document.getElementById('totalStaff').textContent = Object.keys(REGISTERED_USERS).length;
            document.getElementById('registeredUsers').textContent = Object.keys(REGISTERED_USERS).length;
            document.getElementById('pendingStaff').textContent = '0';
            document.getElementById('totalHolidayDays').textContent = holidayData.length;
        }

        // Search functionality
        document.getElementById('staffSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredData = staffData.filter(staff => 
                staff.name.toLowerCase().includes(searchTerm)
            );
            displayStaffData(filteredData);
        });

        document.getElementById('holidaySearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredData = holidayData.filter(holiday => 
                holiday.staffName.toLowerCase().includes(searchTerm)
            );
            displayHolidayData(filteredData);
        });

        // Load all data when page loads
        loadAllData();
    </script>
</body>
</html>
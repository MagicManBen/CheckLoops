<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Achievement and Avatar Toggles</title>
    <script src="config.js"></script>
    <script src="supabase-js.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Test Achievement and Avatar Toggles</h1>

    <div class="test-section">
        <h2>Current Settings</h2>
        <div id="current-settings" class="status info">Loading...</div>
    </div>

    <div class="test-section">
        <h2>Toggle Settings</h2>
        <button onclick="toggleAchievements()">Toggle Achievements</button>
        <button onclick="toggleAvatars()">Toggle Avatars</button>
        <button onclick="loadSettings()">Refresh Settings</button>
    </div>

    <div class="test-section">
        <h2>Test Navigation</h2>
        <p>After changing settings, visit these pages to verify:</p>
        <ul>
            <li><a href="staff.html" target="_blank">Staff Dashboard</a> - Check if Achievements menu appears/disappears</li>
            <li><a href="staff-welcome.html" target="_blank">Staff Welcome</a> - Check if avatars show/hide</li>
            <li><a href="staff-calendar.html" target="_blank">Staff Calendar</a> - Check navigation menu</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>LocalStorage Cache</h2>
        <div id="cache-status" class="status info">Loading...</div>
    </div>

    <script type="module">
        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        let currentSiteId = null;

        async function loadSettings() {
            try {
                // Get current user session
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    document.getElementById('current-settings').innerHTML = 'Not logged in. Please login first.';
                    document.getElementById('current-settings').className = 'status error';
                    return;
                }

                // Get user profile to get site_id
                const { data: profile } = await supabaseClient
                    .from('master_users')
                    .select('site_id')
                    .eq('auth_user_id', session.user.id)
                    .single();

                if (!profile) {
                    document.getElementById('current-settings').innerHTML = 'User profile not found.';
                    document.getElementById('current-settings').className = 'status error';
                    return;
                }

                currentSiteId = profile.site_id;

                // Get site settings
                const { data: settings, error } = await supabaseClient
                    .from('site_settings')
                    .select('enable_achievements, enable_avatars')
                    .eq('site_id', currentSiteId)
                    .single();

                if (error) {
                    document.getElementById('current-settings').innerHTML = `Error loading settings: ${error.message}`;
                    document.getElementById('current-settings').className = 'status error';
                    return;
                }

                const achievementsEnabled = settings?.enable_achievements !== false;
                const avatarsEnabled = settings?.enable_avatars !== false;

                document.getElementById('current-settings').innerHTML = `
                    <strong>Site ID:</strong> ${currentSiteId}<br>
                    <strong>Achievements:</strong> ${achievementsEnabled ? '✅ Enabled' : '❌ Disabled'}<br>
                    <strong>Avatars:</strong> ${avatarsEnabled ? '✅ Enabled' : '❌ Disabled'}
                `;
                document.getElementById('current-settings').className = 'status success';

                // Check localStorage cache
                const cacheKey = `site_${currentSiteId}_settings`;
                const cachedSettings = localStorage.getItem(cacheKey);

                if (cachedSettings) {
                    const parsed = JSON.parse(cachedSettings);
                    document.getElementById('cache-status').innerHTML = `
                        <strong>Cache Key:</strong> ${cacheKey}<br>
                        <strong>Cached Data:</strong><br>
                        <pre>${JSON.stringify(parsed, null, 2)}</pre>
                    `;
                } else {
                    document.getElementById('cache-status').innerHTML = 'No cached settings found in localStorage';
                }

            } catch (error) {
                document.getElementById('current-settings').innerHTML = `Error: ${error.message}`;
                document.getElementById('current-settings').className = 'status error';
            }
        }

        window.toggleAchievements = async function() {
            if (!currentSiteId) {
                alert('Please load settings first');
                return;
            }

            try {
                // Get current settings
                const { data: current } = await supabaseClient
                    .from('site_settings')
                    .select('enable_achievements')
                    .eq('site_id', currentSiteId)
                    .single();

                const newValue = current?.enable_achievements === false;

                // Update settings
                const { error } = await supabaseClient
                    .from('site_settings')
                    .update({ enable_achievements: newValue })
                    .eq('site_id', currentSiteId);

                if (error) throw error;

                // Clear cache to force reload
                localStorage.removeItem(`site_${currentSiteId}_settings`);

                alert(`Achievements ${newValue ? 'enabled' : 'disabled'}. Refresh pages to see changes.`);
                await loadSettings();

            } catch (error) {
                alert(`Error toggling achievements: ${error.message}`);
            }
        };

        window.toggleAvatars = async function() {
            if (!currentSiteId) {
                alert('Please load settings first');
                return;
            }

            try {
                // Get current settings
                const { data: current } = await supabaseClient
                    .from('site_settings')
                    .select('enable_avatars')
                    .eq('site_id', currentSiteId)
                    .single();

                const newValue = current?.enable_avatars === false;

                // Update settings
                const { error } = await supabaseClient
                    .from('site_settings')
                    .update({ enable_avatars: newValue })
                    .eq('site_id', currentSiteId);

                if (error) throw error;

                // Clear cache to force reload
                localStorage.removeItem(`site_${currentSiteId}_settings`);

                alert(`Avatars ${newValue ? 'enabled' : 'disabled'}. Refresh pages to see changes.`);
                await loadSettings();

            } catch (error) {
                alert(`Error toggling avatars: ${error.message}`);
            }
        };

        // Load settings on page load
        loadSettings();
    </script>
</body>
</html>
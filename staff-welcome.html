<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — Welcome</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <link rel="stylesheet" href="staff.css">
  <style>
    /* Gamified welcome vibe */
    .welcome-wrap{ position:relative; }
    .spark-bg{ position:absolute; inset:-40px; pointer-events:none; filter: blur(40px); opacity:.6; }
    .spark-bg::before{ content:""; position:absolute; inset:0; background:
      radial-gradient(400px 300px at 15% 20%, #8b5cf61a, transparent),
      radial-gradient(380px 260px at 85% 30%, #22c55e1a, transparent),
      radial-gradient(500px 320px at 50% 80%, #3b82f61a, transparent);
    }
    .hero-card{ position:relative; background:#fff; border:1px solid var(--border-color); border-radius:20px; padding:22px; box-shadow:0 16px 40px rgba(2,6,23,.08); overflow:hidden; }
    .hero-top{ display:flex; align-items:center; gap:16px; justify-content:center; margin-bottom:8px; }
    .avatar{ width:64px; height:64px; border-radius:16px; display:grid; place-items:center; background:linear-gradient(180deg,#f5f3ff,#eef2ff); box-shadow: inset 0 0 0 2px #e5e7eb; font-size:30px; }
    .title{ font-size:24px; font-weight:900; letter-spacing:.2px; color:var(--ink); }
    .subtitle{ color:#64748b; font-weight:600; }
    .big-input{ display:flex; gap:10px; align-items:center; justify-content:center; margin-top:14px; }
    .big-input input{ flex:1; min-width:220px; max-width:360px; padding:14px 16px; border-radius:12px; border:1px solid var(--border-color); font-size:15px; }
    .meta-note{ color:#6b7280; font-size:12px; margin-top:8px; }

    /* selection helpers for role + avatar grid */
    .opt-selected{ outline: 2px solid var(--accent); box-shadow: 0 4px 12px #3b82f61a; }
    .avatar-grid-item{ transition: transform .12s ease, box-shadow .12s ease, outline-color .12s ease; }
    .avatar-grid-item:hover{ transform: translateY(-2px); box-shadow: 0 8px 18px rgba(2,6,23,.10); }

    .progress{ height:10px; border-radius:999px; background:#eef2ff; overflow:hidden; border:1px solid var(--border-color); }
    .progress > .bar{ height:100%; width:25%; background:linear-gradient(90deg,#60a5fa,#a78bfa); }

    /* Confetti bits */
    .confetti{ position:fixed; inset:0; pointer-events:none; overflow:hidden; }
    .confetti .bit{ position:absolute; width:10px; height:10px; border-radius:2px; opacity:.95; will-change: transform, opacity; animation: fall 900ms ease-out forwards; }
    @keyframes fall{ 0%{ transform: translateY(-10px) rotate(0deg); opacity:1; } 100%{ transform: translateY(120vh) rotate(540deg); opacity:0; } }
  </style>
</head>
<body>
  <div class="bg"><div class="wave"></div><div class="wave wave2"></div></div>
  <main class="content">
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav">
        <a href="staff.html" data-page="home">Home</a>
        <a href="staff-welcome.html" data-page="welcome" class="active">Welcome</a>
        <a href="staff-scans.html" data-page="scans">My Scans</a>
        <a href="staff-training.html" data-page="training">My Training</a>
        <a href="staff-quiz.html" data-page="quiz">Quiz</a>
      </div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: —</div>
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
    </div>

    <!-- Welcome setup content -->
    <section id="welcome-step1" class="panel g-12 welcome-wrap" style="margin:0; display:flex; align-items:center; justify-content:center; min-height: 62vh;">
      <div class="spark-bg"></div>
      <div style="max-width:760px; width:100%;">
        <div class="hero-card">
          <div class="hero-top">
            <div class="avatar" aria-hidden="true"><img src="icons/icons8-medical-mobile-app-100.png" alt="Welcome" style="width:42px;height:42px;object-fit:contain"></div>
            <div>
              <div class="subtitle" id="site-subtitle">Welcome</div>
              <div class="title" id="welcome-title">Welcome</div>
            </div>
          </div>

          <div style="text-align:center; margin-top:8px;">
            <div style="font-weight:800;">What should we call you?</div>
            <div class="meta-note">Pick a display name for badges, streaks and leaderboards.</div>
            <div class="big-input">
              <input id="nickname" placeholder="e.g. Ben" />
              <button class="btn" id="save-btn">Get started</button>
            </div>
            <div id="save-msg" class="meta-note"></div>
          </div>

        </div>
      </div>
      <div class="confetti" id="confetti"></div>
    </section>

    <!-- Step 2 (details) -->
    <section id="welcome-step2" class="panel g-12" style="display:none; margin:0;">
      <div class="panel-header" style="gap:10px; align-items:center;">
        <div class="illus-circle"><img src="icons/icons8-edit-profile-100.png" alt="Profile"></div>
        <div class="panel-title" style="font-size:20px;">Tell us about you</div>
      </div>

      <div class="grid" style="gap:16px;">
        <div class="g-6">
          <div class="panel" style="padding:16px;">
            <div class="panel-header" style="gap:10px; align-items:center;">
              <div class="illus-circle" style="width:64px;height:64px;"><img src="icons/icons8-staff-stick-100.png" alt="Role"></div>
              <div class="panel-title">Your role</div>
            </div>
            <div id="role-grid" style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px;"></div>
            <div class="meta-note" id="role-msg"></div>
          </div>
        </div>
        <div class="g-6">
          <div class="panel" style="padding:16px;">
            <div class="panel-header" style="gap:10px; align-items:center;">
              <div class="illus-circle" style="width:64px;height:64px;"><img src="icons/icons8-user-groups-100.png" alt="Team"></div>
              <div class="panel-title">Your team</div>
            </div>
            <select id="team-select" style="width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--border-color);"></select>
            <div class="meta-note" id="team-msg" style="margin-top:8px;">Choose the team you work with.</div>
          </div>
        </div>

        <!-- Avatar moved to Step 3 (builder) -->
      </div>

      <div style="display:flex; justify-content:center; margin-top:12px;">
        <button class="btn" id="to-avatar-btn">Continue — Create your avatar</button>
      </div>
      <div id="finish-msg" class="meta-note" style="text-align:center; margin-top:10px;"></div>
    </section>

    <!-- Step 3 (avatar builder) -->
    <section id="welcome-step3" class="panel g-12" style="display:none; margin:0;">
      <div class="panel-header" style="gap:10px; align-items:center;">
        <div class="illus-circle" style="width:64px;height:64px;"><img src="icons/icons8-avatar-100.png" alt="Avatar"></div>
        <div class="panel-title">Create your avatar</div>
      </div>

      <div class="grid" style="gap:16px; align-items:start;">
        <div class="g-4">
          <div class="panel" style="padding:16px;">
            <div style="font-weight:800; margin-bottom:8px;">Preview</div>
            <div style="display:grid; place-items:center;">
              <div style="width:220px; height:220px; border-radius:16px; border:1px solid var(--border-color); background-image: linear-gradient(45deg,#f3f4f6 25%, transparent 25%), linear-gradient(-45deg,#f3f4f6 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f3f4f6 75%), linear-gradient(-45deg, transparent 75%, #f3f4f6 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; display:grid; place-items:center; overflow:hidden;">
                <img id="avatarPreview" alt="Avatar preview" style="width:200px; height:200px; border-radius:12px; object-fit:contain; background:#fff;" />
              </div>
              <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn btn-secondary" id="avatar-randomize">Randomize</button>
                <button class="btn btn-secondary" id="avatar-reset">Reset</button>
              </div>
              <div class="meta-note" id="avatar-url-note" style="margin-top:8px; word-break:break-all; max-width:260px;"></div>
            </div>
          </div>
        </div>

        <div class="g-8">
          <div class="panel" style="padding:16px;">
            <div style="font-weight:800; margin-bottom:8px;">Describe Your Avatar</div>
            <div style="display:flex; gap:8px; align-items:flex-start; margin-bottom:10px;">
              <textarea id="avatarPrompt" rows="3" placeholder="e.g. Friendly nurse with green scrubs, freckles, long brown hair, round glasses, gradient background" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></textarea>
              <button class="btn" id="avatar-ai-generate" style="white-space:nowrap;">Generate with AI</button>
            </div>
            <div class="meta-note" id="avatar-ai-msg">Your description stays local; a local proxy calls OpenAI with your key.</div>
          </div>

          <div class="panel" style="padding:16px; margin-top:12px;">
            <div style="font-weight:800; margin-bottom:8px;">Options</div>
            <div class="grid" style="gap:10px; grid-template-columns: repeat(2, minmax(0,1fr));">
              <!-- General -->
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Seed</span>
                <input id="opt-seed" placeholder="Type a name" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);" />
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Background Type</span>
                <select id="opt-backgroundType" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                  <option value="">Default</option>
                  <option value="solid">Solid</option>
                  <option value="gradientLinear">Gradient</option>
                </select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Background Color</span>
                <select id="opt-backgroundColor" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                  <option value="">Default</option>
                  <option value="transparent">Transparent</option>
                  <option value="f2d3b1">Peach (f2d3b1)</option>
                  <option value="ecad80">Light Orange (ecad80)</option>
                  <option value="9e5622">Brown (9e5622)</option>
                  <option value="763900">Dark Brown (763900)</option>
                  <option value="ffffff">White (ffffff)</option>
                  <option value="f3f4f6">Gray (f3f4f6)</option>
                  <option value="93c5fd">Blue (93c5fd)</option>
                  <option value="a78bfa">Purple (a78bfa)</option>
                  <option value="22c55e">Green (22c55e)</option>
                  <option value="fca5a5">Pink (fca5a5)</option>
                </select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Background Rotation</span>
                <select id="opt-backgroundRotation" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Radius</span>
                <select id="opt-radius" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Rotate</span>
                <select id="opt-rotate" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Scale</span>
                <select id="opt-scale" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                  <option value="50">50</option>
                  <option value="75">75</option>
                  <option value="100" selected>100</option>
                  <option value="125">125</option>
                  <option value="150">150</option>
                  <option value="175">175</option>
                  <option value="200">200</option>
                </select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Flip</span>
                <select id="opt-flip" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                  <option value="">Default</option>
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Clip to Bounds</span>
                <select id="opt-clip" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                  <option value="">Default</option>
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Translate X</span>
                <select id="opt-translateX" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Translate Y</span>
                <select id="opt-translateY" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>

              <!-- Style-specific: Avataaars -->
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Eyes</span>
                <select id="opt-eyes" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Mouth</span>
                <select id="opt-mouth" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Eyebrows</span>
                <select id="opt-eyebrows" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Glasses</span>
                <select id="opt-glasses" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                  <option value="">None</option>
                </select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Glasses Probability</span>
                <select id="opt-glassesProbability" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>

              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Earrings</span>
                <select id="opt-earrings" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                  <option value="">None</option>
                </select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Earrings Probability</span>
                <select id="opt-earringsProbability" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>

              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Features</span>
                <select id="opt-features" multiple size="4" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Features Probability</span>
                <select id="opt-featuresProbability" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>

              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Hair</span>
                <select id="opt-hair" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Hair Color</span>
                <select id="opt-hairColor" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Hair Probability</span>
                <select id="opt-hairProbability" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
              <label style="display:flex; flex-direction:column; gap:6px;">
                <span style="font-weight:700; color:var(--ink);">Skin Color</span>
                <select id="opt-skinColor" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; margin-top:12px;">
        <button class="btn btn-secondary" id="back-to-step2">Back</button>
        <button class="btn" id="finish-avatar-btn">Finish setup</button>
      </div>
      <div id="finish-avatar-msg" class="meta-note" style="text-align:center; margin-top:10px;"></div>
    </section>
  </main>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate } from './staff-common.js';
    
    // Make supabase globally available for AI generation
    let globalSupabase;
    
    (async function(){
      const supabase = await initSupabase();
      globalSupabase = supabase; // Store in global variable
      handleAuthState(supabase);
      navActivate('welcome');

      try{
        const { session, profileRow } = await requireStaffSession(supabase);
        const user = session.user;
        const siteId = profileRow?.site_id || user?.raw_user_meta_data?.site_id || null;
        const roleDetail = user?.raw_user_meta_data?.role_detail || 'Staff';
        setTopbar({ siteText: await getSiteText(supabase, siteId), email: user.email, role: roleDetail });

        const fullName = profileRow?.full_name || user?.raw_user_meta_data?.full_name || (user?.email?.split('@')[0]) || 'there';
        document.getElementById('welcome-title').textContent = `Welcome, ${fullName}`;

        // Try to read any existing nickname if the column exists
        let nicknameColumnExists = true;
        try {
          const selCols = ['user_id','full_name','site_id','role','nickname'];
          const { data, error } = await supabase
            .from('profiles')
            .select(selCols.join(','))
            .eq('user_id', user.id)
            .maybeSingle();
          if (error) {
            if (String(error.code) === '42703' || /column .*nickname/i.test(String(error.message))) {
              nicknameColumnExists = false;
            } else {
              console.warn('[staff-welcome] profiles select error', error);
            }
          } else if (data && data.nickname) {
            document.getElementById('nickname').value = data.nickname;
          }
        } catch (e) {
          nicknameColumnExists = false;
        }

        // ---- Step 3: DiceBear Avatar Builder (Avataaars) ----
        function rangeArr(start, end, step=1){ const a=[]; for(let i=start;i<=end;i+=step) a.push(i); return a; }
        function pad2(n){ return String(n).padStart(2,'0'); }

        function buildAvatarUrlFromControls(){
          const base = 'https://api.dicebear.com/7.x/avataaars/svg';
          const seed = encodeURIComponent(document.getElementById('opt-seed').value || 'User');
          const params = new URLSearchParams();
          params.set('seed', seed);

          const bgType = document.getElementById('opt-backgroundType').value;
          const bgColor = document.getElementById('opt-backgroundColor').value;
          const bgRot = document.getElementById('opt-backgroundRotation').value;
          const radius = document.getElementById('opt-radius').value;
          const rotate = document.getElementById('opt-rotate').value;
          const scale = document.getElementById('opt-scale').value;
          const flip = document.getElementById('opt-flip').value;
          const clip = document.getElementById('opt-clip').value;
          const tx = document.getElementById('opt-translateX').value;
          const ty = document.getElementById('opt-translateY').value;

          const eyes = document.getElementById('opt-eyes').value;
          const mouth = document.getElementById('opt-mouth').value;
          const eyebrows = document.getElementById('opt-eyebrows').value;
          const glasses = document.getElementById('opt-glasses').value;
          const glassesProbability = document.getElementById('opt-glassesProbability').value;
          const earrings = document.getElementById('opt-earrings').value;
          const earringsProbability = document.getElementById('opt-earringsProbability').value;
          const featuresSel = document.getElementById('opt-features');
          const featuresProbability = document.getElementById('opt-featuresProbability').value;
          const hair = document.getElementById('opt-hair').value;
          const hairColor = document.getElementById('opt-hairColor').value;
          const hairProbability = document.getElementById('opt-hairProbability').value;
          const skinColor = document.getElementById('opt-skinColor').value;

          if (bgType) params.set('backgroundType', bgType);
          if (bgColor) params.append('backgroundColor', bgColor);
          if (bgRot) params.append('backgroundRotation', bgRot);
          if (radius) params.set('radius', radius);
          if (rotate) params.set('rotate', rotate);
          if (scale) params.set('scale', scale);
          if (flip) params.set('flip', flip);
          if (clip) params.set('clip', clip);
          if (tx) params.set('translateX', tx);
          if (ty) params.set('translateY', ty);

          if (eyes) params.set('eyes', eyes);
          if (mouth) params.set('mouth', mouth);
          if (eyebrows) params.set('eyebrows', eyebrows);
          if (glasses) params.set('glasses', glasses);
          if (glassesProbability) params.set('glassesProbability', glassesProbability);
          if (earrings) params.set('earrings', earrings);
          if (earringsProbability) params.set('earringsProbability', earringsProbability);
          if (featuresSel){
            const vals = Array.from(featuresSel.selectedOptions).map(o=>o.value).filter(Boolean);
            vals.forEach(v=> params.append('features', v));
          }
          if (featuresProbability) params.set('featuresProbability', featuresProbability);
          if (hair) params.set('hair', hair);
          if (hairColor) params.set('hairColor', hairColor);
          if (hairProbability) params.set('hairProbability', hairProbability);
          if (skinColor) params.set('skinColor', skinColor);

          return `${base}?${params.toString()}`;
        }

        function updateAvatarPreview(){
          const url = buildAvatarUrlFromControls();
          window.currentAvatarUrl = url;
          const img = document.getElementById('avatarPreview');
          if (img) img.src = url;
          const note = document.getElementById('avatar-url-note');
          if (note) note.textContent = url;
        }

        function getAiEndpoint(){
          try{
            const loc = window.location;
            if (loc.hostname === '127.0.0.1' || loc.hostname === 'localhost') return 'http://localhost:8787/generate-avatar';
          }catch(_){ }
          return '/api/generate-avatar';
        }

        function collectDropdownOptions(){
          const ids = ['opt-backgroundType','opt-backgroundColor','opt-backgroundRotation','opt-radius','opt-rotate','opt-scale','opt-flip','opt-clip','opt-translateX','opt-translateY','opt-eyes','opt-mouth','opt-eyebrows','opt-glasses','opt-earrings','opt-features','opt-hair','opt-hairColor','opt-skinColor'];
          const out = {};
          for (const id of ids){
            const el = document.getElementById(id);
            if (!el) continue;
            const opts = Array.from(el.options || []).map(o=>o.value).filter(v=>v!=='' && v!=null);
            out[id] = opts;
          }
          // numeric pickers for probs
          out['opt-glassesProbability'] = Array.from(document.getElementById('opt-glassesProbability')?.options||[]).map(o=>Number(o.value)).filter(v=>!isNaN(v));
          out['opt-earringsProbability'] = Array.from(document.getElementById('opt-earringsProbability')?.options||[]).map(o=>Number(o.value)).filter(v=>!isNaN(v));
          out['opt-featuresProbability'] = Array.from(document.getElementById('opt-featuresProbability')?.options||[]).map(o=>Number(o.value)).filter(v=>!isNaN(v));
          out['opt-hairProbability'] = Array.from(document.getElementById('opt-hairProbability')?.options||[]).map(o=>Number(o.value)).filter(v=>!isNaN(v));
          return out;
        }

        async function aiGenerateFromDescription(){
          const prompt = String(document.getElementById('avatarPrompt')?.value||'').trim();
          if (!prompt) throw new Error('Please enter a description first');
          
          if (!globalSupabase) throw new Error('Supabase not initialized');
          
          const endpoint = getAiEndpoint();
          const nickVal = String(document.getElementById('nickname')?.value || '').trim();
          const seedHint = nickVal || (document.getElementById('opt-seed')?.value||'User');
          const options = collectDropdownOptions();
          
          // Try local proxy first if on localhost/127.0.0.1
          if (endpoint && endpoint.startsWith('http')){
            try {
              const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ description: prompt, options, seedHint }) });
              if (!res.ok){ 
                // If local proxy fails, fall back to Supabase Edge Function
                throw new Error('Local proxy failed, trying Supabase function');
              }
              const data = await res.json();
              applyAiResult(data);
              return;
            } catch (localError) {
              console.log('Local proxy not available, using Supabase Edge Function:', localError.message);
              // Fall through to Supabase Edge Function
            }
          }
          
          // Use Supabase Edge Function
          console.log('Using Supabase Edge Function for AI generation');
          console.log('globalSupabase:', globalSupabase ? 'initialized' : 'not initialized');
          
          try {
            const { data, error } = await globalSupabase.functions.invoke('generate-avatar', { 
              body: { description: prompt, options, seedHint } 
            });
            console.log('Supabase response:', { data, error });
            
            if (error) {
              throw new Error(`Supabase function error: ${error.message || JSON.stringify(error)}`);
            }
            
            if (!data) {
              throw new Error('No data returned from Supabase function');
            }
            
            applyAiResult(data);
          } catch (supabaseError) {
            console.error('Supabase function call failed:', supabaseError);
            throw new Error(`AI generation failed: ${supabaseError.message}`);
          }
        }

        function applyAiResult(data){
          const setVal = (id, val) => { const el = document.getElementById(id); if (!el) return; el.value = String(val); };
          const maybe = (k) => data[k] !== undefined && data[k] !== null && data[k] !== '';
          if (maybe('seed')) document.getElementById('opt-seed').value = String(data.seed);
          const map = new Map([
            ['backgroundType','opt-backgroundType'],
            ['backgroundColor','opt-backgroundColor'],
            ['backgroundRotation','opt-backgroundRotation'],
            ['radius','opt-radius'],
            ['rotate','opt-rotate'],
            ['scale','opt-scale'],
            ['flip','opt-flip'],
            ['clip','opt-clip'],
            ['translateX','opt-translateX'],
            ['translateY','opt-translateY'],
            ['eyes','opt-eyes'],
            ['mouth','opt-mouth'],
            ['eyebrows','opt-eyebrows'],
            ['glasses','opt-glasses'],
            ['glassesProbability','opt-glassesProbability'],
            ['earrings','opt-earrings'],
            ['earringsProbability','opt-earringsProbability'],
            ['hair','opt-hair'],
            ['hairColor','opt-hairColor'],
            ['hairProbability','opt-hairProbability'],
            ['skinColor','opt-skinColor'],
          ]);
          for (const [k,id] of map.entries()){ if (maybe(k)) setVal(id, data[k]); }

          // features (multi)
          if (Array.isArray(data.features)){
            const el = document.getElementById('opt-features');
            if (el){ Array.from(el.options).forEach(o=>{ o.selected = data.features.includes(o.value); }); }
          }
          if (maybe('featuresProbability')) setVal('opt-featuresProbability', data.featuresProbability);

          updateAvatarPreview();
        }

        function initAvatarBuilder(fullName){
          // Fill dropdowns
          const seedEl = document.getElementById('opt-seed');
          const nickVal = String(document.getElementById('nickname')?.value || '').trim();
          seedEl.value = nickVal || fullName || 'User';

          const fillOpts = (el, arr, withBlank=false) => {
            el.innerHTML = '';
            if (withBlank) el.appendChild(new Option('Default',''));
            for(const v of arr){ el.appendChild(new Option(String(v), String(v))); }
          };

          fillOpts(document.getElementById('opt-backgroundRotation'), rangeArr(0,360,15), true);
          fillOpts(document.getElementById('opt-radius'), rangeArr(0,50,5), true);
          fillOpts(document.getElementById('opt-rotate'), rangeArr(0,360,15), true);
          fillOpts(document.getElementById('opt-translateX'), rangeArr(-50,50,5), true);
          fillOpts(document.getElementById('opt-translateY'), rangeArr(-50,50,5), true);

          // Adventurer variants
          const eyes = Array.from({length:26}, (_,i)=>`variant${pad2(i+1)}`);
          const mouths = Array.from({length:30}, (_,i)=>`variant${pad2(i+1)}`);
          const brows = Array.from({length:15}, (_,i)=>`variant${pad2(i+1)}`);
          const glasses = Array.from({length:5},  (_,i)=>`variant${pad2(i+1)}`);
          const earrings = Array.from({length:6},  (_,i)=>`variant${pad2(i+1)}`);
          const features = ['mustache','blush','birthmark','freckles'];
          const hair = [
            ...Array.from({length:19}, (_,i)=>`short${pad2(i+1)}`),
            ...Array.from({length:26}, (_,i)=>`long${pad2(i+1)}`)
          ];
          const hairColors = ['ac6511','cb6820','ab2a18','e5d7a3','b9a05f','796a45','6a4e35','562306','0e0e0e','afafaf','3eac2c','85c2c6','dba3be','592454'];
          const skinColors = ['f2d3b1','ecad80','9e5622','763900'];

          fillOpts(document.getElementById('opt-eyes'), eyes, true);
          fillOpts(document.getElementById('opt-mouth'), mouths, true);
          fillOpts(document.getElementById('opt-eyebrows'), brows, true);
          fillOpts(document.getElementById('opt-glasses'), ['','variant01','variant02','variant03','variant04','variant05']);
          fillOpts(document.getElementById('opt-glassesProbability'), rangeArr(0,100,10), true);
          fillOpts(document.getElementById('opt-earrings'), ['','variant01','variant02','variant03','variant04','variant05','variant06']);
          fillOpts(document.getElementById('opt-earringsProbability'), rangeArr(0,100,10), true);
          // features (multi-select)
          const featuresEl = document.getElementById('opt-features');
          if (featuresEl){
            featuresEl.innerHTML = '';
            for (const v of features){ featuresEl.appendChild(new Option(v, v)); }
          }
          fillOpts(document.getElementById('opt-featuresProbability'), rangeArr(0,100,5), true);
          fillOpts(document.getElementById('opt-hair'), [''].concat(hair));
          fillOpts(document.getElementById('opt-hairColor'), [''].concat(hairColors));
          fillOpts(document.getElementById('opt-hairProbability'), rangeArr(0,100,10), true);
          fillOpts(document.getElementById('opt-skinColor'), [''].concat(skinColors));

          // Bind changes
          const ids = [
            'opt-seed','opt-backgroundType','opt-backgroundColor','opt-backgroundRotation','opt-radius','opt-rotate','opt-scale','opt-flip','opt-clip','opt-translateX','opt-translateY','opt-eyes','opt-mouth','opt-eyebrows','opt-glasses','opt-glassesProbability','opt-earrings','opt-earringsProbability','opt-featuresProbability','opt-hair','opt-hairColor','opt-hairProbability','opt-skinColor'
          ];
          ids.forEach(id=>{
            const el = document.getElementById(id);
            if (el && !el.dataset.bound){ el.addEventListener('input', updateAvatarPreview); el.dataset.bound='1'; }
          });
          // features (multi-select)
          const featuresMulti = document.getElementById('opt-features');
          if (featuresMulti && !featuresMulti.dataset.bound){ featuresMulti.addEventListener('change', updateAvatarPreview); featuresMulti.dataset.bound='1'; }

          // Randomize/reset
          const rnd = document.getElementById('avatar-randomize');
          if (rnd && !rnd.dataset.bound){ rnd.addEventListener('click', ()=>{
            const seeds = ['Nova','Ziggy','Aria','Kai','Milo','Ivy','Atlas','Sage','Skye','Orion','Zoe','Finn','Quinn','Remy'];
            seedEl.value = seeds[Math.floor(Math.random()*seeds.length)] + Math.floor(Math.random()*100);
            const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];
            document.getElementById('opt-eyes').value = pick(eyes);
            document.getElementById('opt-mouth').value = pick(mouths);
            document.getElementById('opt-eyebrows').value = pick(brows);
            document.getElementById('opt-glasses').value = pick(['','variant01','variant02','variant03','variant04','variant05']);
            document.getElementById('opt-glassesProbability').value = pick(rangeArr(0,100,10));
            document.getElementById('opt-earrings').value = pick(['','variant01','variant02','variant03','variant04','variant05','variant06']);
            document.getElementById('opt-earringsProbability').value = pick(rangeArr(0,100,10));
            document.getElementById('opt-hair').value = pick(hair);
            document.getElementById('opt-hairColor').value = pick(hairColors);
            document.getElementById('opt-hairProbability').value = pick(rangeArr(0,100,10));
            document.getElementById('opt-skinColor').value = pick(skinColors);
            const fEl = document.getElementById('opt-features');
            for (const o of Array.from(fEl.options)) o.selected = false;
            // randomly pick up to 2 features
            const pool = [...features];
            for (let i=0;i<Math.floor(Math.random()*3);i++){
              const idx = Math.floor(Math.random()*pool.length);
              const val = pool.splice(idx,1)[0];
              const opt = Array.from(fEl.options).find(o=>o.value===val); if (opt) opt.selected = true;
            }
            updateAvatarPreview();
          }); rnd.dataset.bound='1'; }

          const reset = document.getElementById('avatar-reset');
          if (reset && !reset.dataset.bound){ reset.addEventListener('click', ()=>{
            document.getElementById('opt-backgroundType').value = '';
            document.getElementById('opt-backgroundColor').value = '';
            document.getElementById('opt-backgroundRotation').value = '';
            document.getElementById('opt-radius').value = '';
            document.getElementById('opt-rotate').value = '';
            document.getElementById('opt-scale').value = '100';
            document.getElementById('opt-flip').value = '';
            document.getElementById('opt-clip').value = '';
            document.getElementById('opt-translateX').value = '';
            document.getElementById('opt-translateY').value = '';
            document.getElementById('opt-eyes').value = '';
            document.getElementById('opt-mouth').value = '';
            document.getElementById('opt-eyebrows').value = '';
            document.getElementById('opt-glasses').value = '';
            document.getElementById('opt-glassesProbability').value = '';
            document.getElementById('opt-earrings').value = '';
            document.getElementById('opt-earringsProbability').value = '';
            const fEl2 = document.getElementById('opt-features');
            if (fEl2){ for (const o of Array.from(fEl2.options)) o.selected = false; }
            document.getElementById('opt-featuresProbability').value = '';
            document.getElementById('opt-hair').value = '';
            document.getElementById('opt-hairColor').value = '';
            document.getElementById('opt-hairProbability').value = '';
            document.getElementById('opt-skinColor').value = '';
            updateAvatarPreview();
          }); reset.dataset.bound='1'; }

          // Back button
          const back = document.getElementById('back-to-step2');
          if (back && !back.dataset.bound){ back.addEventListener('click', ()=>{
            document.getElementById('welcome-step3').style.display = 'none';
            document.getElementById('welcome-step2').style.display = '';
          }); back.dataset.bound='1'; }

          // AI Generate button
          const aiBtn = document.getElementById('avatar-ai-generate');
          if (aiBtn && !aiBtn.dataset.bound){ aiBtn.addEventListener('click', async ()=>{
            const msg = document.getElementById('avatar-ai-msg');
            msg.textContent = 'Thinking…';
            aiBtn.disabled = true;
            try{
              await aiGenerateFromDescription();
              msg.textContent = 'Applied! You can fine-tune with the dropdowns.';
            }catch(e){
              console.error('AI generate error:', e);
              msg.textContent = `Error: ${e.message}`;
            } finally {
              aiBtn.disabled = false;
            }
          }); aiBtn.dataset.bound='1'; }

          // Finish button
          const finish = document.getElementById('finish-avatar-btn');
          if (finish && !finish.dataset.bound){ finish.addEventListener('click', async ()=>{
            const fm = document.getElementById('finish-avatar-msg');
            fm.textContent = '';
            try{
              const teamIdNum = (window.selectedTeamId ?? null);
              const role = (window.selectedRole || null);
              const avatar = (window.currentAvatarUrl || buildAvatarUrlFromControls());

              try {
                let qp = supabase.from('profiles').update({
                  role_detail: role,
                  avatar_url: avatar,
                  team_id: teamIdNum,
                  team_name: (window.selectedTeamName || null)
                }).eq('user_id', user.id);
                if (siteId) qp = qp.eq('site_id', siteId);
                const { error: upErr } = await qp;
                if (upErr) { console.warn('profiles update failed', upErr); }
              } catch (e) { console.warn('profiles update exception', e); }

              try{ await supabase.auth.updateUser({ data: { role_detail: role, avatar_url: avatar } }); }catch(e){ console.warn('meta update failed', e); }

              try{
                let kioskId = null;
                const { data: ku } = await supabase
                  .from('kiosk_users')
                  .select('id')
                  .eq('site_id', siteId)
                  .eq('full_name', fullName)
                  .maybeSingle();
                kioskId = ku?.id || null;
                if (kioskId){
                  await supabase.from('kiosk_users').update({ role, team_id: teamIdNum, team_name: (window.selectedTeamName || null), active: true }).eq('id', kioskId);
                } else {
                  await supabase.from('kiosk_users').insert({ site_id: siteId, full_name: fullName, role, team_id: teamIdNum, team_name: (window.selectedTeamName || null), active: true });
                }
              } catch(kuErr){ console.info('kiosk_users upsert skipped/failed (policy likely).', kuErr?.message || kuErr); }

              fm.textContent = 'All set! Redirecting…';
              setTimeout(()=> window.location.href = 'staff.html', 600);
            }catch(err){
              console.error('finish setup error', err);
              fm.textContent = 'Could not save your details. Please try again.';
            }
          }); finish.dataset.bound='1'; }

          // Initial render
          updateAvatarPreview();
        }

        function burstConfetti(){
          const conf = document.getElementById('confetti');
          if (!conf) return;
          const colors = ['#60a5fa','#a78bfa','#34d399','#f472b6','#fbbf24'];
          for (let i=0;i<36;i++){
            const bit = document.createElement('div');
            bit.className = 'bit';
            const size = 6 + Math.floor(Math.random()*8);
            bit.style.width = size+'px';
            bit.style.height = size+'px';
            bit.style.left = (10 + Math.random()*80) + 'vw';
            bit.style.top = '-10px';
            bit.style.background = colors[Math.floor(Math.random()*colors.length)];
            bit.style.animationDelay = (Math.random()*120) + 'ms';
            conf.appendChild(bit);
            setTimeout(()=> bit.remove(), 1200);
          }
        }

        async function saveNickname(){
          const input = document.getElementById('nickname');
          const msg = document.getElementById('save-msg');
          msg.textContent = '';
          const val = String(input.value || '').trim();
          if (!val) { msg.textContent = 'Please enter a name to continue.'; return; }

          if (nicknameColumnExists) {
            try{
              let q = supabase.from('profiles').update({ nickname: val }).eq('user_id', user.id);
              if (siteId) q = q.eq('site_id', siteId);
              const { error } = await q;
              if (error && (String(error.code) === '42703' || /column .*nickname/i.test(String(error.message)))) {
                nicknameColumnExists = false; // fall through to guidance
              } else if (error) {
                msg.textContent = 'Could not save nickname. Please try again.';
                console.error('[staff-welcome] update error', error);
                return;
              } else {
                msg.textContent = 'Saved!';
                // Move to step 2
                document.getElementById('welcome-step1').style.display = 'none';
                document.getElementById('welcome-step2').style.display = '';
                await loadDetailsData(siteId, fullName);
                return;
              }
            } catch(e){ nicknameColumnExists = false; }
          }

          // If we reach here, the column likely doesn’t exist — provide SQL guidance
          msg.innerHTML = `
            It looks like the <code>nickname</code> column isn’t in <code>profiles</code> yet.<br>
            Add it in Supabase, then tap Save again:
            <pre style="text-align:left; background:#f9fafb; border:1px solid var(--border-color); border-radius:8px; padding:10px; overflow:auto;">ALTER TABLE public.profiles ADD COLUMN nickname text;</pre>`;
        }

        document.getElementById('save-btn').addEventListener('click', (e)=>{ e.preventDefault(); saveNickname(); });

        // ---- Step 2 helpers ----

        const ROLE_ICON = (name) => ({
          'Doctor': 'icons/icons8-medical-doctor-100.png',
          'Nurse': 'icons/icons8-nurse-100.png',
          'Pharmacist': 'icons/icons8-pharmacist-100.png',
          'Reception': 'icons/icons8-customer-100.png',
          'Manager': 'icons/icons8-admin-settings-male-100.png'
        })[name] || 'icons/icons8-user-100.png';

        async function loadDetailsData(siteId, fullName){
          // Build Roles list
          let roles = [];
          try {
            const { data, error } = await supabase.from('kiosk_roles').select('role');
            if (!error && Array.isArray(data) && data.length) roles = data.map(r => r.role);
          } catch(_) {}
          if (!roles.length) roles = ['Doctor','Nurse','Pharmacist','Reception','Manager'];
          const rg = document.getElementById('role-grid');
          rg.innerHTML = roles.map((r,i)=>
            `<label style="display:flex; gap:10px; align-items:center; border:1px solid var(--border-color); border-radius:12px; padding:10px; cursor:pointer; background:#fff;">
              <input type=\"radio\" name=\"role\" value=\"${r}\" ${i===0?'checked':''} />
              <img src=\"${ROLE_ICON(r)}\" alt=\"${r}\" style=\"width:32px;height:32px;object-fit:contain;\"/>
              <span style=\"font-weight:800; color:var(--ink);\">${r}</span>
            </label>`).join('');

          // Load teams by site
          const ts = document.getElementById('team-select');
          ts.innerHTML = '<option value="">Loading teams…</option>';
          try{
            if (siteId){
              const { data, error } = await supabase.from('teams').select('id,name').eq('site_id', siteId);
              if (error) console.warn('teams load error', error);
              const opts = (data||[]).map(t=>`<option value="${t.id}">${t.name}</option>`);
              if (opts.length){ ts.innerHTML = `<option value=\"\">Select your team</option>${opts.join('')}`; }
              else {
                ts.innerHTML = `<option value=\"\">Select your team</option>
                  <option value=\"managers\">Managers</option>
                  <option value=\"reception\">Reception</option>
                  <option value=\"nursing\">Nursing</option>
                  <option value=\"gps\">GPs</option>
                  <option value=\"pharmacy\">Pharmacy</option>`;
              }
            } else {
              ts.innerHTML = '<option value="">No site set</option>';
            }
          }catch(_){ ts.innerHTML = '<option value="">Select your team</option>'; }

          // Continue to Step 3 (Avatar Builder)
          const toAvatar = document.getElementById('to-avatar-btn');
          if (toAvatar && !toAvatar.dataset.bound){
            toAvatar.addEventListener('click', () => {
              const role = (document.querySelector('input[name="role"]:checked')?.value || '').trim();
              const teamVal = document.getElementById('team-select').value || '';
              const teamName = teamVal ? (document.querySelector(`#team-select option[value="${CSS.escape(teamVal)}"]`)?.textContent || null) : null;

              window.selectedRole = role || null;
              window.selectedTeamId = teamVal && /^\d+$/.test(String(teamVal)) ? parseInt(teamVal, 10) : null;
              window.selectedTeamName = teamName || null;

              document.getElementById('welcome-step2').style.display = 'none';
              document.getElementById('welcome-step3').style.display = '';
              initAvatarBuilder(fullName);
            });
            toAvatar.dataset.bound = '1';
          }
        }
      } catch(e){
        if (String(e.message).includes('NO_SESSION')) { window.location.replace('Home.html'); return; }
        if (String(e.message).includes('NOT_STAFF')) { window.location.replace('index.html'); return; }
        console.error('[staff-welcome] error', e);
      }
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop ‚Äî Welcome</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <link rel="stylesheet" href="staff.css">
  <style>
    /* Gamified welcome vibe */
    .welcome-wrap{ position:relative; }
    .spark-bg{ position:absolute; inset:-40px; pointer-events:none; filter: blur(40px); opacity:.6; }
    .spark-bg::before{ content:""; position:absolute; inset:0; background:
      radial-gradient(400px 300px at 15% 20%, #8b5cf61a, transparent),
      radial-gradient(380px 260px at 85% 30%, #22c55e1a, transparent),
      radial-gradient(500px 320px at 50% 80%, #3b82f61a, transparent);
    }
  .hero-card{ position:relative; background:#fff; border:1px solid rgba(15,23,42,0.06); border-radius:20px; padding:22px; box-shadow: 0 18px 48px rgba(2,6,23,0.12), inset 0 1px 0 rgba(255,255,255,0.6); overflow:hidden; }
  .hero-card::after{ content: ''; position: absolute; inset: 0; border-radius: 20px; pointer-events: none; box-shadow: 0 0 0 1px rgba(59,130,246,0.04) inset; }
    .hero-top{ display:flex; align-items:center; gap:16px; justify-content:center; margin-bottom:8px; }
    .avatar{ width:64px; height:64px; border-radius:16px; display:grid; place-items:center; background:linear-gradient(180deg,#f5f3ff,#eef2ff); box-shadow: inset 0 0 0 2px #e5e7eb; font-size:30px; }
    .title{ font-size:24px; font-weight:900; letter-spacing:.2px; color:var(--ink); }
    .subtitle{ color:#64748b; font-weight:600; }
    .big-input{ display:flex; gap:10px; align-items:center; justify-content:center; margin-top:14px; }
  .big-input input{ flex:1; min-width:220px; max-width:360px; padding:14px 16px; border-radius:12px; border:1px solid rgba(15,23,42,0.06); font-size:15px; background: #fbfdff; }
    .meta-note{ color:#6b7280; font-size:12px; margin-top:8px; }

    /* selection helpers for role + avatar grid */
    .opt-selected{ outline: 2px solid var(--accent); box-shadow: 0 4px 12px #3b82f61a; }
    .avatar-grid-item{ transition: transform .12s ease, box-shadow .12s ease, outline-color .12s ease; }
    .avatar-grid-item:hover{ transform: translateY(-2px); box-shadow: 0 8px 18px rgba(2,6,23,.10); }

    .progress{ height:10px; border-radius:999px; background:#eef2ff; overflow:hidden; border:1px solid var(--border-color); }
    .progress > .bar{ height:100%; width:25%; background:linear-gradient(90deg,#60a5fa,#a78bfa); }

    /* Advanced Particle System */
    .confetti{ position:absolute; inset:0; pointer-events:none; overflow:hidden; z-index:20; }

    /* Particle Types */
    .particle{ position:absolute; will-change: transform, opacity; pointer-events:none; }

    /* Explosion Particles */
    .explosion-particle{
      width:8px; height:8px; border-radius:50%;
      animation: explode 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    /* Sparkle Particles */
    .sparkle-particle{
      width:6px; height:6px;
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      animation: sparkle 1.8s ease-out forwards;
    }

    /* Burst Particles */
    .burst-particle{
      width:12px; height:4px; border-radius:6px;
      animation: burst 1.5s ease-out forwards;
    }

    /* Glow Particles */
    .glow-particle{
      width:14px; height:14px; border-radius:50%;
      filter: blur(2px); opacity:0.8;
      animation: glow 2.5s ease-out forwards;
    }

    /* Ring Particles */
    .ring-particle{
      width:20px; height:20px; border-radius:50%;
      border:2px solid; background:transparent;
      animation: ring-expand 2s ease-out forwards;
    }

    @keyframes explode{
      0%{ transform: translate(0,0) scale(1) rotate(0deg); opacity:1; }
      20%{ opacity:1; }
      100%{ transform: translate(var(--dx), var(--dy)) scale(0.3) rotate(var(--rotation)); opacity:0; }
    }

    @keyframes sparkle{
      0%{ transform: translate(0,0) scale(0) rotate(0deg); opacity:1; }
      15%{ transform: translate(calc(var(--dx)*0.15), calc(var(--dy)*0.15)) scale(1.2) rotate(72deg); opacity:1; }
      100%{ transform: translate(var(--dx), var(--dy)) scale(0) rotate(var(--rotation)); opacity:0; }
    }

    @keyframes burst{
      0%{ transform: translate(0,0) scale(1) rotate(var(--start-rotation)); opacity:1; }
      30%{ opacity:1; }
      100%{ transform: translate(var(--dx), var(--dy)) scale(0.5) rotate(calc(var(--start-rotation) + 180deg)); opacity:0; }
    }

    @keyframes glow{
      0%{ transform: translate(0,0) scale(0.5); opacity:0.8; filter: blur(2px); }
      25%{ transform: translate(calc(var(--dx)*0.3), calc(var(--dy)*0.3)) scale(1.5); opacity:1; filter: blur(1px); }
      100%{ transform: translate(var(--dx), var(--dy)) scale(0); opacity:0; filter: blur(4px); }
    }

    @keyframes ring-expand{
      0%{ transform: translate(0,0) scale(0.1); opacity:1; border-width:3px; }
      50%{ transform: translate(calc(var(--dx)*0.5), calc(var(--dy)*0.5)) scale(1.5); opacity:0.6; border-width:2px; }
      100%{ transform: translate(var(--dx), var(--dy)) scale(2.5); opacity:0; border-width:1px; }
    }

    /* Balloon animation */
    @keyframes floatUp {
      0% { transform: translateY(0) rotate(-5deg); opacity: 1; }
      100% { transform: translateY(-600px) rotate(5deg); opacity: 0; }
    }

    /* Enhanced completion banner animation */
    @keyframes dynamicEntrance {
      0% {
        transform: translateY(50px) scale(0.8);
        opacity: 0;
        filter: blur(10px);
      }
      50% {
        transform: translateY(-10px) scale(1.05);
        opacity: 1;
        filter: blur(0px);
      }
      70% {
        transform: translateY(5px) scale(0.98);
      }
      100% {
        transform: translateY(0) scale(1);
        opacity: 1;
        filter: blur(0px);
      }
    }
    
    /* Avatar save pulse animation */
    @keyframes pulse{ 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
  /* Modern App-like Avatar Sections */
  .avatar-control-group{ 
    grid-column:1 / -1; 
    padding:20px; 
    margin-top:16px; 
    border-radius:20px; 
    background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); 
    box-shadow:0 8px 25px rgba(15,23,42,0.08), 0 3px 6px rgba(15,23,42,0.03); 
    border:1px solid rgba(148,163,184,0.12);
    position:relative;
    overflow:hidden;
    transition: all 0.3s ease;
  }
  .avatar-control-group::before{
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
    border-radius: 20px 20px 0 0;
  }
  .avatar-control-group:hover{ 
    transform: translateY(-2px); 
    box-shadow:0 12px 35px rgba(15,23,42,0.12), 0 5px 15px rgba(15,23,42,0.06); 
  }
  .avatar-control-group + .avatar-control-group{ margin-top:20px; }
  .avatar-control-group .group-header{ 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    gap:12px; 
    margin-bottom:12px;
  }
  .avatar-control-group .group-title{ 
    font-weight:800; 
    color:#1e293b; 
    margin:0; 
    font-size:18px; 
    display:flex;
    align-items:center;
    gap:8px;
  }
  .avatar-control-group .group-title::before{
    content: attr(data-icon);
    font-size: 20px;
    opacity: 0.8;
  }
  .avatar-control-group .group-help{ 
    color:#64748b; 
    font-size:14px; 
    margin:0 0 16px 0; 
    padding:12px 16px;
    background:rgba(59,130,246,0.05);
    border-radius:12px;
    border-left:3px solid #3b82f6;
    font-weight:500;
  }
  .avatar-control-group .group-grid{ 
    display:grid; 
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
    gap:16px; 
    align-items:start; 
    transition: all .35s cubic-bezier(0.4, 0, 0.2, 1); 
    max-height:2000px; 
    overflow:hidden; 
  }
  .avatar-control-group.collapsed .group-grid{ 
    max-height:0; 
    opacity:0; 
    pointer-events:none; 
    margin-top:0;
    padding-top:0;
  }
  .avatar-control-group.collapsed .group-help{ display:none; }
  .group-toggle{ 
    background:linear-gradient(135deg, #f1f5f9, #e2e8f0); 
    border:1px solid rgba(148,163,184,0.2); 
    padding:8px 16px; 
    border-radius:12px; 
    cursor:pointer; 
    font-weight:600; 
    color:#475569; 
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.5px;
    transition: all 0.2s ease;
  }
  .group-toggle:hover{
    background:linear-gradient(135deg, #e2e8f0, #cbd5e1);
    transform:translateY(-1px);
    box-shadow:0 4px 12px rgba(15,23,42,0.1);
  }
  .group-toggle:active{ transform:translateY(0); }
  .avatar-control-group.collapsed .group-toggle{
    background:linear-gradient(135deg, #dbeafe, #bfdbfe);
    color:#1d4ed8;
  }

  /* Enhanced form controls */
  .avatar-control-group label{
    display:flex; 
    flex-direction:column; 
    gap:8px;
    padding:16px;
    background:rgba(255,255,255,0.7);
    border-radius:12px;
    border:1px solid rgba(148,163,184,0.1);
    transition: all 0.2s ease;
  }
  .avatar-control-group label:hover{
    background:rgba(255,255,255,0.9);
    border-color:rgba(59,130,246,0.2);
    transform:translateY(-1px);
    box-shadow:0 4px 12px rgba(15,23,42,0.05);
  }
  .avatar-control-group label span{
    font-weight:600; 
    color:#334155; 
    font-size:13px;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  .avatar-control-group select{
    padding:12px 16px; 
    border-radius:10px; 
    border:1px solid rgba(148,163,184,0.2);
    background:white;
    font-size:14px;
    font-weight:500;
    color:#1e293b;
    transition: all 0.2s ease;
  }
  .avatar-control-group select:focus{
    outline:none;
    border-color:#3b82f6;
    box-shadow:0 0 0 3px rgba(59,130,246,0.1);
  }

  /* Option pills for role/team items */
  .option-pill{ display:flex; gap:10px; align-items:center; border-radius:12px; padding:10px; cursor:pointer; background:transparent; border:1px solid rgba(148,163,184,0.08); transition: all .12s ease; }
  .option-pill img{ width:32px; height:32px; object-fit:contain; }
  .option-pill input{ margin:0 8px 0 0; }
  .option-pill span{ font-weight:800; color: inherit; }
  .white-pill{ background:#fff; color:#0f172a; border-color: rgba(15,23,42,0.06); box-shadow: 0 6px 18px rgba(2,6,23,0.04); }

  /* New: replace bland selects with larger icon/button grids for better UX */
  .option-buttons{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .option-btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 10px; border-radius:10px; background:#fff; border:1px solid rgba(148,163,184,0.12); cursor:pointer; font-weight:700; color:#0f172a; min-width:56px; height:44px; box-shadow:0 6px 18px rgba(2,6,23,.04); transition:all .15s ease; }
  .option-btn:hover{ transform:translateY(-3px); box-shadow:0 10px 26px rgba(2,6,23,.08); }
  .option-btn.selected{ background:linear-gradient(90deg,#60a5fa,#a78bfa); color:white; border-color:transparent; }
  .option-swatch{ width:28px; height:28px; border-radius:6px; border:1px solid rgba(15,23,42,0.06); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); }
  .select-hidden{ display:none !important; }

  /* Enhanced section styling */
  #group-face::before { background: linear-gradient(90deg, #f59e0b, #f97316); }
  #group-accessories::before { background: linear-gradient(90deg, #8b5cf6, #a855f7); }
  #group-hair::before { background: linear-gradient(90deg, #06b6d4, #0891b2); }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .avatar-control-group .group-grid {
      grid-template-columns: 1fr;
    }
    .avatar-control-group {
      padding: 16px;
    }
  }
  </style>
</head>
<body>
  <div class="bg"><div class="wave"></div><div class="wave wave2"></div></div>
  <main class="content">
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav">
        <!-- Navigation will be rendered by staff-common.js -->
      </div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: ‚Äî</div>
      <div class="pill" id="email-pill">‚Äî</div>
      <div class="pill" id="role-pill">‚Äî</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>

    <!-- Welcome setup content -->
    <section id="welcome-step1" class="panel g-12 welcome-wrap" style="margin:0; display:flex; align-items:center; justify-content:center; min-height: 62vh;">
      <div class="spark-bg"></div>
      <div style="max-width:760px; width:100%;">
  <div class="hero-card panel light-panel">
          <div class="hero-top">
            <div class="avatar" aria-hidden="true"><img src="Icons/icons8-medical-mobile-app-100.png" alt="Welcome" style="width:42px;height:42px;object-fit:contain"></div>
            <div>
              <div class="subtitle" id="site-subtitle">Welcome</div>
              <div class="title" id="welcome-title">Welcome</div>
            </div>
          </div>

          <div style="text-align:center; margin-top:8px;">
            <div style="font-weight:800;">What should we call you?</div>
            <div class="meta-note">Pick a name, others will see this.</div>
            <div class="big-input">
              <input id="nickname" placeholder="e.g. Ben" />
              <button class="btn" id="save-btn" style="padding:12px 20px; border-radius:14px; background:linear-gradient(135deg,#6495ff,#7b6bff); box-shadow:0 10px 30px rgba(101,137,255,0.24);">Get started</button>
            </div>
            <div id="save-msg" class="meta-note"></div>
          </div>

        </div>
      </div>
      <div class="confetti" id="confetti"></div>
    </section>

    <!-- Auto-hide any panels/controls that contain the literal text 'Change' on the avatar page -->
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        // Scope to the avatar builder area when present
        const scope = document.getElementById('welcome-step3') || document.getElementById('welcome-step1') || document;
        if (!scope) return;
        try {
          // Search common clickable/label elements only inside the scope
          const candidates = Array.from(scope.querySelectorAll('button, a, span, div, label'));
          const changeEls = candidates.filter(el => {
            const txt = (el.textContent || '').trim();
            if (!txt) return false;
            // quick check for the word change, case-insensitive
            if (!/\bchange\b/i.test(txt)) return false;
            // ensure element is visible (handles display:none, detached nodes, etc.)
            const visible = (el.offsetWidth || el.offsetHeight || el.getClientRects().length);
            return !!visible;
          });
          changeEls.forEach(el => {
            // prefer to hide a sensible container so UI spacing collapses nicely
            const panel = el.closest('.avatar-control-group') || el.closest('.panel') || el.closest('section') || el.parentElement;
            if (panel) panel.style.display = 'none';
            else el.style.display = 'none';
          });
        } catch(e) {
          console.warn('hide-change-panels error', e);
        }
      });
    </script>

    <!-- Step 2 (details) -->
    <section id="welcome-step2" class="panel g-12" style="display:none; margin:0;">
      <div class="panel-header" style="gap:10px; align-items:center;">
        <div class="illus-circle"><img data-i8="settings" data-i8-size="56" alt="Profile"></div>
        <div class="panel-title" style="font-size:20px;">Tell us about you</div>
      </div>

      <div class="grid" style="gap:16px;">
        <div class="g-6">
          <div class="panel" style="padding:16px;">
            <div class="panel-header" style="gap:10px; align-items:center;">
              <div class="illus-circle" style="width:64px;height:64px;"><img data-i8="id-verified" data-i8-size="56" alt="Role"></div>
              <div class="panel-title">Your role</div>
            </div>
            <div id="role-grid" style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px;"></div>
            <div class="meta-note" id="role-msg"></div>
          </div>
        </div>
        <div class="g-6">
          <div class="panel" style="padding:16px;">
            <div class="panel-header" style="gap:10px; align-items:center;">
              <div class="illus-circle" style="width:64px;height:64px;"><img data-i8="group" data-i8-size="56" alt="Team"></div>
              <div class="panel-title">Your team</div>
            </div>
            <div id="team-grid" style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px;"></div>
            <div class="meta-note" id="team-msg" style="margin-top:8px;">Choose the team you work with.</div>
          </div>
        </div>

        <!-- Avatar moved to Step 3 (builder) -->
      </div>

      <div style="display:flex; justify-content:center; margin-top:12px;">
        <button class="btn" id="to-avatar-btn">Continue ‚Äî Create your avatar</button>
      </div>
      <div id="finish-msg" class="meta-note" style="text-align:center; margin-top:10px;"></div>
    </section>

    <!-- Step 3 (avatar builder) -->
      <section id="welcome-step3" class="panel g-12" style="display:none; margin:0;">
      <div class="panel-header" style="gap:10px; align-items:center;">
        <div class="illus-circle" style="width:64px;height:64px;"><img src="Icons/icons8-avatar-100.png" alt="Avatar"></div>
        <div class="panel-title">Create your avatar</div>
      </div>

      <div class="grid" style="gap:16px; align-items:start;">
        <div class="g-4" style="position: sticky; top: 20px; align-self: start;">
          <div class="panel" style="padding:16px;">
            <!-- Live preview header removed per user request -->
            <div style="display:grid; place-items:center;">
              <div id="avatar-preview-frame" style="width:240px; height:240px; border-radius:16px; border:1px solid rgba(2,6,23,0.06); background:#ffffff; display:grid; place-items:center; overflow:hidden; box-shadow:0 6px 18px rgba(2,6,23,0.08); position:relative;">
                <img id="avatarPreview" alt="Avatar preview" style="width:220px; height:220px; border-radius:12px; object-fit:contain; background:#fff; transition: all 0.3s ease;" />
              </div>
              <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn btn-secondary" id="avatar-randomize" style="padding:12px 20px; border-radius:12px; font-weight:600; background:linear-gradient(135deg, #8b5cf6, #7c3aed); color:white; border:none;">üé≤ Randomize</button>
                <button class="btn" id="avatar-save-manual" style="padding:12px 20px; border-radius:12px; font-weight:600; background:linear-gradient(135deg, #22c55e, #16a34a); color:white; border:none;">üíæ Save Avatar</button>
              </div>
              <div class="meta-note" id="avatar-save-msg" style="margin-top:12px; text-align:center; font-weight:500;"></div>
            </div>
          </div>
        </div>

        <div class="g-8">
          <div class="panel" style="padding:24px; border:3px solid #3b82f6; border-radius:20px; background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #93c5fd 100%); position:relative; overflow:hidden;">
            <div style="position:absolute; top:0; left:0; right:0; height:6px; background:linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);"></div>
            <div style="font-weight:900; margin-bottom:12px; font-size:20px; color:#1e293b; display:flex; align-items:center; gap:10px;">
              ü§ñ AI Avatar Generator
            </div>
            <div style="background:rgba(255,255,255,0.8); border-radius:16px; padding:20px; margin-bottom:16px;">
              <div style="display:flex; gap:12px; align-items:flex-start;">
                <textarea id="avatarPrompt" rows="3" placeholder="üé® Describe your perfect avatar: 'Friendly nurse with green scrubs, freckles, long brown hair, round glasses, colorful background'" style="flex:1; padding:14px 18px; border-radius:12px; border:2px solid rgba(59,130,246,0.2); font-size:14px; font-weight:500; resize:vertical; background:white;"></textarea>
                <button class="btn" id="avatar-ai-generate" style="white-space:nowrap; padding:14px 24px; background:linear-gradient(135deg, #10b981, #059669); color:white; border:none; border-radius:12px; font-weight:700; box-shadow:0 4px 12px rgba(16,185,129,0.3);">‚ú® Generate</button>
              </div>
              <div class="meta-note" id="avatar-ai-msg" style="margin-top:8px; font-weight:500;"></div>
            </div>
          </div>

          <div class="panel" style="padding:24px; margin-top:16px; border-radius:20px; background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); box-shadow:0 8px 25px rgba(15,23,42,0.08);">
            <div style="font-weight:900; margin-bottom:16px; color:#1e293b; font-size:18px; display:flex; align-items:center; gap:8px;">
              ‚öôÔ∏è Manual Controls
            </div>
            <div class="grid" style="gap:10px; grid-template-columns: repeat(2, minmax(0,1fr));">
              <!-- General -->
              <div id="layout-controls" style="display:none">
                <div style="grid-column:1 / -1; font-weight:700; color:var(--ink); padding-top:4px;">Layout</div>
                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span style="font-weight:700; color:var(--ink);">Background Type</span>
                  <select id="opt-backgroundType" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                    <option value="">Default</option>
                    <option value="solid">Solid</option>
                    <option value="gradientLinear">Gradient</option>
                  </select>
                </label>
                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span style="font-weight:700; color:var(--ink);">Background Color</span>
                  <select id="opt-backgroundColor" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                    <option value="">Default</option>
                    <option value="transparent">Transparent</option>
                    <option value="f2d3b1">Peach (f2d3b1)</option>
                    <option value="ecad80">Light Orange (ecad80)</option>
                    <option value="9e5622">Brown (9e5622)</option>
                    <option value="763900">Dark Brown (763900)</option>
                    <option value="ffffff">White (ffffff)</option>
                    <option value="f3f4f6">Gray (f3f4f6)</option>
                    <option value="93c5fd">Blue (93c5fd)</option>
                    <option value="a78bfa">Purple (a78bfa)</option>
                    <option value="22c55e">Green (22c55e)</option>
                    <option value="fca5a5">Pink (fca5a5)</option>
                  </select>
                </label>
                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span style="font-weight:700; color:var(--ink);">Background Rotation</span>
                  <select id="opt-backgroundRotation" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
                </label>
                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span style="font-weight:700; color:var(--ink);">Radius</span>
                  <select id="opt-radius" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
                </label>
                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span style="font-weight:700; color:var(--ink);">Rotate</span>
                  <select id="opt-rotate" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
                </label>
                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span style="font-weight:700; color:var(--ink);">Scale</span>
                  <select id="opt-scale" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                    <option value="50">50</option>
                    <option value="75">75</option>
                    <option value="100" selected>100</option>
                    <option value="125">125</option>
                    <option value="150">150</option>
                    <option value="175">175</option>
                    <option value="200">200</option>
                  </select>
                </label>
                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span style="font-weight:700; color:var(--ink);">Flip</span>
                  <select id="opt-flip" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                    <option value="">Default</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                  </select>
                </label>
                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span style="font-weight:700; color:var(--ink);">Clip to Bounds</span>
                  <select id="opt-clip" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);">
                    <option value="">Default</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                  </select>
                </label>
                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span style="font-weight:700; color:var(--ink);">Translate X</span>
                  <select id="opt-translateX" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
                </label>
                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span style="font-weight:700; color:var(--ink);">Translate Y</span>
                  <select id="opt-translateY" style="padding:10px 12px; border-radius:10px; border:1px solid var(--border-color);"></select>
                </label>
              </div>

              <div class="avatar-control-group" id="group-face">
                <div class="group-header">
                  <h4 class="group-title" data-icon="üë§">Face & Expression</h4>
                  <button class="group-toggle" data-target="#group-face">Hide</button>
                </div>
                <div class="group-help">‚ú® Choose your facial features ‚Äî eyes, mouth, and skin tone to create your unique look</div>
                <div class="group-grid">
                  <label>
                    <span>üëÅÔ∏è Eyes Style</span>
                    <select id="opt-eyes"></select>
                  </label>
                  <label>
                    <span>üòä Mouth Expression</span>
                    <select id="opt-mouth"></select>
                  </label>
                  <label>
                    <span>ü§® Eyebrows Shape</span>
                    <select id="opt-eyebrows"></select>
                  </label>
                  <label>
                    <span>üé® Skin Tone</span>
                    <select id="opt-skinColor"></select>
                  </label>
                </div>
              </div>
              <div class="avatar-control-group" id="group-accessories">
                <div class="group-header">
                  <h4 class="group-title" data-icon="üëì">Accessories & Features</h4>
                  <button class="group-toggle" data-target="#group-accessories">Hide</button>
                </div>
                <div class="group-help">üíé Add personality with glasses, earrings, and distinctive features</div>
                <div class="group-grid">
                  <label>
                    <span>üëì Glasses Style</span>
                    <select id="opt-glasses">
                      <option value="">None</option>
                    </select>
                  </label>
                  <label style="display: none;">
                    <span>üìä Glasses Chance</span>
                    <select id="opt-glassesProbability"></select>
                  </label>
                  <label>
                    <span>üíé Earrings Type</span>
                    <select id="opt-earrings">
                      <option value="">None</option>
                    </select>
                  </label>
                  <label style="display: none;">
                    <span>üìä Earrings Chance</span>
                    <select id="opt-earringsProbability"></select>
                  </label>

                  <label style="grid-column:1 / -1;">
                    <span>‚ú® Special Features</span>
                    <select id="opt-features" multiple size="4"></select>
                  </label>
                  <label style="display: none;">
                    <span>üìä Features Chance</span>
                    <select id="opt-featuresProbability"></select>
                  </label>
                </div>
              </div>
              <div class="avatar-control-group" id="group-hair">
                <div class="group-header">
                  <h4 class="group-title" data-icon="üíá">Hair & Style</h4>
                  <button class="group-toggle" data-target="#group-hair">Hide</button>
                </div>
                <div class="group-help">üíÖ Express yourself with different hairstyles and bold colors</div>
                <div class="group-grid">
                  <label>
                    <span>‚úÇÔ∏è Hairstyle</span>
                    <select id="opt-hair"></select>
                  </label>
                  <label>
                    <span>üé® Hair Color</span>
                    <select id="opt-hairColor"></select>
                  </label>
                  <label style="display: none;">
                    <span>üìä Hair Chance</span>
                    <select id="opt-hairProbability"></select>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:20px;">
        <button class="btn btn-secondary" id="back-to-step2" style="padding:12px 24px; border-radius:12px; background:linear-gradient(135deg, #f1f5f9, #e2e8f0); color:#475569; border:none; font-weight:600;">‚Üê Back</button>
        <div style="display:flex; align-items:center; gap:12px;">
          <button class="btn" id="finish-avatar-btn" style="background:linear-gradient(135deg, #3b82f6, #1d4ed8); color:white; padding:12px 24px; border-radius:12px; font-weight:700; border:none; box-shadow:0 4px 12px rgba(59,130,246,0.3);">Continue to Working Hours ‚Üí</button>
        </div>
      </div>
      <div id="finish-avatar-msg" class="meta-note" style="text-align:center; margin-top:10px;"></div>
    </section>
    
    <!-- Step 4: Working Hours -->
    <section id="step4" class="panel g-12" style="display:none; margin:0;">
      <div class="panel-header" style="gap:10px; align-items:center;">
        <div class="illus-circle" style="width:64px;height:64px;"><img src="Icons/icons8-clock-100.png" alt="Working Hours"></div>
        <div class="panel-title" style="font-size:20px;">Working pattern</div>
      </div>
      <div class="step-sub">Set the hours or sessions you typically work.</div>
      <div id="working-form" style="display:flex; flex-direction:column; gap:14px; max-width:640px;"></div>
      <div id="working-msg" class="meta-note" style="min-height:20px;"></div>
      <div style="display:flex; justify-content:space-between; margin-top:24px;">
        <button class="btn btn-secondary" id="working-back">‚Üê Back</button>
        <button class="btn" id="complete-setup">üéâ Finish Setup</button>
      </div>
    </section>
    
    <!-- Step 5: Completion -->
    <section id="step5" class="panel g-12" style="display:none; margin:0; position:relative; min-height:400px;">
      <div id="confetti-container" class="confetti"></div>
      <div style="position:relative; z-index:10; padding:40px; text-align:center;">
        <div style="font-size:80px; margin-bottom:20px;">üéâüéàüéä</div>
        <div class="complete-banner" style="background:linear-gradient(90deg,#22c55e,#16a34a); color:#fff; padding:20px 30px; border-radius:20px; font-weight:800; font-size:24px; display:inline-flex; align-items:center; gap:12px; justify-content:center; box-shadow:0 10px 28px rgba(22,163,74,0.30); animation: dynamicEntrance 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;">
          All Set! You're Amazing!
        </div>
        <div style="margin-top:20px; font-size:18px; color:#64748b; font-weight:600;">
          Great job completing your profile!
        </div>
        <div class="meta-note center" style="margin-top:14px;">Redirecting to your dashboard in a moment...</div>
      </div>
    </section>
  </main>

  <script type="module">
  import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, attachLogout } from './staff-common.js';

  // Simple HTML escaper used when rendering dynamic labels/values
  function esc(s){ return (s ?? "").toString().replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    
    // Make supabase globally available for AI generation
    let globalSupabase;
    
    (async function(){
      const supabase = await initSupabase();
      // Make supabase available globally for Admin Portal button
      window.supabase = supabase;
      globalSupabase = supabase; // Store in global variable
      handleAuthState(supabase);
      // Always show navigation for welcome page
      navActivate('welcome');
      attachLogout(supabase);

      // Admin nav removed - separate staff portal

      try{
        const { session, profileRow } = await requireStaffSession(supabase);
        const user = session.user;

        // Get site_id from multiple sources in priority order
        const sessionSiteId = sessionStorage.getItem('userSiteId');
        const siteId = profileRow?.site_id ||
                      user?.user_metadata?.site_id ||
                      user?.raw_user_meta_data?.site_id ||
                      (sessionSiteId ? parseInt(sessionSiteId) : null) ||
                      1; // Only default to site 1 as last resort

        console.log('Site determination:', {
          profileSite: profileRow?.site_id,
          userMetaSite: user?.user_metadata?.site_id,
          rawMetaSite: user?.raw_user_meta_data?.site_id,
          sessionSite: sessionSiteId,
          finalSite: siteId
        });

        // Store globally for handlers
        window.currentUser = user;
        window.currentSiteId = siteId;
        const role = profileRow?.role || user?.raw_user_meta_data?.role || 'Staff';
        const roleDetail = role.charAt(0).toUpperCase() + role.slice(1);  // Capitalize first letter

        // Check if user already has been pre-configured by admin
        let preConfigured = false;
        let existingData = {};

        // Check server state for profile completion
        try {
          const siteIdForCheck = siteId;
          let nickname = null, roleDetailCheck = null, teamId = null, teamName = null, avatarUrl = null;

          // First check site_invites for pre-configuration metadata
          const { data: inviteData } = await supabase
            .from('site_invites')
            .select('metadata')
            .eq('email', user.email)
            .eq('site_id', siteIdForCheck)
            .maybeSingle();

          if (inviteData?.metadata) {
            console.log('Found pre-configuration data from invitation:', inviteData.metadata);
            existingData.inviteMetadata = inviteData.metadata;
            preConfigured = true;

            // Set pre-configured values
            if (inviteData.metadata.job_role) {
              roleDetailCheck = inviteData.metadata.job_role;
              window.preConfiguredRole = inviteData.metadata.job_role;
            }
            if (inviteData.metadata.team_id) {
              teamId = inviteData.metadata.team_id;
              window.preConfiguredTeamId = inviteData.metadata.team_id;
            }
            if (inviteData.metadata.working_pattern) {
              window.preConfiguredWorkingPattern = inviteData.metadata.working_pattern;
            }
            if (inviteData.metadata.holiday_entitlement) {
              window.preConfiguredHolidayEntitlement = inviteData.metadata.holiday_entitlement;
            }
          }

          // Check if user has existing data in various tables
          const [welcomeData, workingPattern, holidayProfile] = await Promise.all([
            supabase.from('staff_app_welcome')
              .select('*')
              .eq('user_id', user.id)
              .eq('site_id', siteIdForCheck)
              .maybeSingle(),
            supabase.from('3_staff_working_patterns')
              .select('*')
              .eq('user_id', user.id)
              .maybeSingle(),
            supabase.from('1_staff_holiday_profiles')
              .select('*')
              .eq('email', user.email)
              .maybeSingle()
          ]);

          // Store existing data for pre-population
          if (welcomeData.data) {
            existingData.welcome = welcomeData.data;
            nickname = welcomeData.data.nickname;
            roleDetailCheck = welcomeData.data.role_detail;
            teamId = welcomeData.data.team_id;
            teamName = welcomeData.data.team_name;
            avatarUrl = welcomeData.data.avatar_url;
            // If we have role and team data, user was pre-configured
            if (roleDetailCheck && (teamId || teamName)) {
              preConfigured = true;
            }
          }

          if (workingPattern.data) {
            existingData.workingPattern = workingPattern.data;
            preConfigured = true;
          }

          if (holidayProfile.data) {
            existingData.holidayProfile = holidayProfile.data;
          }

          // Also check user metadata for pre-configuration
          if (user.raw_user_meta_data?.job_role || user.raw_user_meta_data?.role_detail) {
            preConfigured = true;
            if (!roleDetailCheck) roleDetailCheck = user.raw_user_meta_data?.job_role || user.raw_user_meta_data?.role_detail;
          }

          window.preConfiguredData = existingData;
          window.isPreConfigured = preConfigured;

          if (preConfigured) {
            console.log('User was pre-configured by admin:', existingData);
          }

          if (siteIdForCheck && !welcomeData.data) {
            const { data: saw } = await supabase
              .from('staff_app_welcome')
              .select('nickname, role_detail, team_id, team_name, avatar_url')
              .eq('user_id', user.id)
              .eq('site_id', siteIdForCheck)
              .order('updated_at', { ascending: false })
              .limit(1)
              .maybeSingle();
            if (saw) { nickname = saw.nickname; roleDetailCheck = saw.role_detail; teamId = saw.team_id; teamName = saw.team_name; avatarUrl = saw.avatar_url; }
          }
          if (!nickname || !roleDetailCheck || (!teamId && !teamName) || !avatarUrl) {
            try {
              const { data: p } = await supabase
                .from('profiles')
                .select('nickname, role_detail, team_id, team_name, avatar_url')
                .eq('user_id', user.id)
                .maybeSingle();
              if (p) {
                nickname = nickname || p.nickname;
                roleDetailCheck = roleDetailCheck || p.role_detail;
                teamId = teamId || p.team_id;
                teamName = teamName || p.team_name;
                avatarUrl = avatarUrl || p.avatar_url;
              }
            } catch(_) { /* ignore */ }
          }
          // Check if user is a known staff member who should bypass strict onboarding requirements
          const knownStaffEmails = ['benhowardmagic@hotmail.com', 'ben.howard@stoke.nhs.uk'];
          const isKnownStaff = knownStaffEmails.includes(user.email);

          // Don't force onboarding regardless of profile completion
          // Users can complete their profile at their leisure
        } catch(_) { /* soft-fail */ }

        // Always show navigation and topbar
        setTopbar({ siteText: await getSiteText(supabase, siteId), email: user.email, role: roleDetail });

        // Ensure working hours handlers are available early so navigation
        // to the working hours step always works.
        try {
          if (window.setupWorkingHoursHandlers) {
            window.setupWorkingHoursHandlers(user, siteId);
          }
        } catch (e) { console.warn('setupWorkingHoursHandlers pre-bind failed', e); }

        // === Entitlement auto-upsert after working hours ===
        // === Persist Role/Team and Avatar helpers (fixes: page 2 + avatar not saving) ===

        function buildIsGpFlag(roleStr){
          if (!roleStr) return false;
          return /(^|\s)(gp|doctor|dr\.?)(\s|$)/i.test(String(roleStr));
        }

        function resolveSelectedRoleTeam(){
          // Prefer globals set by existing handlers
          const role = window.selectedRole || null;
          const teamId = (typeof window.selectedTeamId !== 'undefined') ? window.selectedTeamId : null;
          const teamName = window.selectedTeamName || null;

          // Fallbacks: try to infer from DOM if globals aren't set
          let roleFallback = role;
          try {
            if (!roleFallback) {
              const el = document.querySelector('#role-grid .opt-selected, #role-grid .selected, #role-grid [aria-checked="true"], #role-grid input[type=radio]:checked, #role-grid [data-role]');
              roleFallback = el?.dataset?.role || el?.value || (el?.textContent || '').trim() || null;
            }
          } catch(_) {}

          let teamIdFallback = teamId, teamNameFallback = teamName;
          try {
            if (!teamIdFallback && !teamNameFallback) {
              const el = document.querySelector('#team-grid .opt-selected, #team-grid .selected, #team-grid [aria-checked="true"], #team-grid input[type=radio]:checked, #team-grid [data-team-id], #team-grid [data-team-name]');
              teamIdFallback = el?.dataset?.teamId ? Number(el.dataset.teamId) : (el?.value ? Number(el.value) : null);
              teamNameFallback = el?.dataset?.teamName || (el?.textContent || '').trim() || null;
            }
          } catch(_) {}

          return {
            role: roleFallback,
            teamId: (Number.isFinite(teamIdFallback) ? teamIdFallback : null),
            teamName: teamNameFallback
          };
        }

        async function persistRoleTeam(roleIn, teamIdIn, teamNameIn){
          const { role, teamId, teamName } = resolveSelectedRoleTeam();
          const finalRole = roleIn || role || null;
          const finalTeamId = (typeof teamIdIn !== 'undefined' ? teamIdIn : teamId);
          const finalTeamName = (typeof teamNameIn !== 'undefined' ? teamNameIn : teamName);
          const nickVal = String(document.getElementById('nickname')?.value || '').trim() || null;

          // ADMIN PROTECTION: Check if user has admin access before overwriting role
          const isAdmin = user?.user_metadata?.admin_access === true;
          console.log('[persistRoleTeam] Admin check:', { isAdmin, currentRole: user?.user_metadata?.role, finalRole });

          // 1) auth metadata
          try {
            const updateData = {
              team_id: finalTeamId || null,
              team_name: finalTeamName || null,
              nickname: nickVal || null
            };

            // If user is admin, preserve admin role but store job role separately
            if (isAdmin) {
              updateData.role = 'admin'; // Keep admin role
              updateData.role_detail = 'Admin'; // Keep admin display
              updateData.job_role = finalRole; // Store their clinical role separately
              console.log('[persistRoleTeam] Preserving admin role, storing job role:', finalRole);
            } else {
              updateData.role_detail = finalRole;
              console.log('[persistRoleTeam] Setting role for non-admin:', finalRole);
            }

            await supabase.auth.updateUser({ data: updateData });
          } catch (e) {
            console.warn('[persistRoleTeam] auth.updateUser failed', e);
          }

          // 2) profiles table is no longer used - master_users is the primary source
          // Commenting out profiles update to prevent confusion
          /*
          try {
            const profileData = {
              user_id: user.id,
              site_id: siteId || null,
              nickname: nickVal || null
            };
            const { error: profileErr } = await supabase.from('profiles').upsert(profileData);
            if (profileErr) console.warn('[persistRoleTeam] profiles upsert error', profileErr);
          } catch (e) {
            console.warn('[persistRoleTeam] profiles upsert failed', e);
          }
          */

          // 3) staff_app_welcome (onboarding snapshot)
          try {
            const sawData = {
              user_id: user.id,
              site_id: siteId || null,
              team_id: finalTeamId || null,
              team_name: finalTeamName || null,
              nickname: nickVal || null
            };

            // Handle role assignment for staff_app_welcome
            if (isAdmin) {
              sawData.role_detail = 'Admin'; // Keep admin display
              sawData.job_role = finalRole; // Store clinical role separately
              console.log('[persistRoleTeam] Setting admin in staff_app_welcome, job_role:', finalRole);
            } else {
              sawData.role_detail = finalRole;
              console.log('[persistRoleTeam] Setting role_detail in staff_app_welcome:', finalRole);
            }

            const { error: sawErr } = await supabase.from('staff_app_welcome').upsert(sawData);
            if (sawErr) console.warn('[persistRoleTeam] staff_app_welcome upsert error', sawErr);
          } catch (e) {
            console.warn('[persistRoleTeam] staff_app_welcome upsert failed', e);
          }

          // 4) 1_staff_holiday_profiles (keep role/team in sync)
          try {
            // Resolve existing profile id by user_id or email
            let profileId = null;
            try {
              const { data: byUser } = await supabase
                .from('1_staff_holiday_profiles')
                .select('id')
                .eq('user_id', user.id)
                .maybeSingle();
              if (byUser?.id) profileId = byUser.id;
            } catch(_) {}
            let email = user.email || null;
            if (!profileId && email) {
              try {
                const { data: byEmail } = await supabase
                  .from('1_staff_holiday_profiles')
                  .select('id')
                  .eq('email', email)
                  .maybeSingle();
                if (byEmail?.id) profileId = byEmail.id;
              } catch(_) {}
            }

            // Build upsert payload
            const hp = {
              user_id: user.id,
              email: email,
              full_name: (user.user_metadata?.full_name || user.user_metadata?.name || null),
              site_id: siteId || null,
              role: finalRole,
              team_name: finalTeamName || null,
              is_gp: buildIsGpFlag(finalRole)
            };

            // If your table uses a unique constraint on email (common), target it; else plain upsert
            const up = supabase.from('1_staff_holiday_profiles');
            const { error: hpErr } = profileId
              ? await up.update(hp).eq('id', profileId)
              : await up.upsert(hp, { onConflict: 'email' });
            if (hpErr) console.warn('[persistRoleTeam] 1_staff_holiday_profiles upsert error', hpErr);
          } catch (e) {
            console.warn('[persistRoleTeam] holiday profile upsert failed', e);
          }

          return { role: finalRole, teamId: finalTeamId, teamName: finalTeamName };
        }

        // This function is now defined later in the avatar section
        // We'll use the consolidated version that saves to all tables

        // Bind saves to navigation buttons so data is persisted at each step
        (function bindPage2Saves(){
          const btn = document.getElementById('to-avatar-btn');
          if (!btn || btn.dataset.roleTeamPersistBound === '1') return;
          btn.addEventListener('click', async () => {
            try {
              const r = await persistRoleTeam();
              const msg = document.getElementById('finish-msg') || document.getElementById('role-msg');
              if (msg) msg.textContent = r.role ? `Saved role: ${r.role}${r.teamName ? `, team: ${r.teamName}` : ''}` : 'Saved.';
            } catch (e) {
              console.warn('[bindPage2Saves] persist failed', e);
              const msg = document.getElementById('finish-msg') || document.getElementById('role-msg');
              if (msg) msg.textContent = '‚ö†Ô∏è Could not save your role/team ‚Äî we will retry on the next step.';
            }
          }, { once: true });
          btn.dataset.roleTeamPersistBound = '1';
        })();

        (function bindAvatarFinishSave(){
          const btn = document.getElementById('finish-avatar-btn');
          if (!btn || btn.dataset.avatarPersistBound === '1') return;
          btn.addEventListener('click', async () => {
            try {
              // Ensure role/team also persisted before moving on
              await persistRoleTeam();
              const imgEl = document.getElementById('avatarPreview');
              let url = imgEl?.getAttribute('src') || window.currentAvatarUrl || (typeof buildAvatarUrlFromControls === 'function' ? buildAvatarUrlFromControls() : null);
              if (!url && typeof updateAvatarPreview === 'function') {
                updateAvatarPreview();
                url = document.getElementById('avatarPreview')?.getAttribute('src') || null;
              }
              if (url && window.saveAvatarToSupabase) await window.saveAvatarToSupabase(url);
              const msg = document.getElementById('avatar-save-msg');
              if (msg) msg.textContent = '‚úÖ Avatar saved. Proceeding to working hours...';
            } catch (e) {
              console.warn('[bindAvatarFinishSave] save failed', e);
            }
          }, { once: true });
          btn.dataset.avatarPersistBound = '1';
        })();

        (function bindFinalSave(){
          const btn = document.getElementById('complete-setup');
          if (!btn || btn.dataset.finalPersistBound === '1') return;
          btn.addEventListener('click', async () => {
            try {
              await persistRoleTeam();
              const imgEl = document.getElementById('avatarPreview');
              let url = imgEl?.getAttribute('src') || window.currentAvatarUrl || (typeof buildAvatarUrlFromControls === 'function' ? buildAvatarUrlFromControls() : null);
              if (!url && typeof updateAvatarPreview === 'function') {
                updateAvatarPreview();
                url = document.getElementById('avatarPreview')?.getAttribute('src') || null;
              }
              if (url && window.saveAvatarToSupabase) await window.saveAvatarToSupabase(url);
            } catch (e) {
              console.warn('[bindFinalSave] save failed', e);
            }
          }, { once: true });
          btn.dataset.finalPersistBound = '1';
        })();

        // === /Persist Role/Team and Avatar helpers ===
        // Adds two new fields to the entitlement payload:
        //   - calc_multiplier (defaults to 6 unless you change it below)
        //   - calc_output_hours (weeklyHours * calc_multiplier)
        //
        // This runs when the user taps "üéâ Finish Setup" after entering working hours.
        // It ensures a row exists in 2_staff_entitlements for the current year.

        // Helper: fetch the current working pattern row and derive weekly hours and sessions
        async function fetchWeeklyTotalsFromWorkingPattern(userId, siteId) {
          // Pull whatever columns exist for hours/sessions; we will sum by day.
          const { data: wp, error } = await supabase
            .from('3_staff_working_patterns')
            .select('*')
            .eq('user_id', userId)
            .eq('site_id', siteId)
            .maybeSingle();

          if (error) {
            console.warn('[entitlement] working_patterns select error', error);
            return { weeklyHours: 0, weeklySessions: 0 };
          }
          if (!wp) return { weeklyHours: 0, weeklySessions: 0 };

          // Use the pre-calculated totals if available
          if (wp.total_hours !== undefined && wp.total_sessions !== undefined) {
            console.log('[entitlement] Using pre-calculated totals - hours:', wp.total_hours, 'sessions:', wp.total_sessions);
            return { weeklyHours: wp.total_hours || 0, weeklySessions: wp.total_sessions || 0 };
          }

          // Fallback: calculate from individual days
          const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
          let hoursSum = 0;
          let sessionsSum = 0;

          for (const day of days) {
            const h = wp[`${day}_hours`];
            const s = wp[`${day}_sessions`];

            // Handle HH:MM format for hours
            if (h && typeof h === 'string' && h.includes(':')) {
              const [hours, minutes] = h.split(':').map(Number);
              hoursSum += hours + (minutes / 60);
            } else if (typeof h === 'number') {
              hoursSum += h;
            }

            if (typeof s === 'number' && !Number.isNaN(s)) sessionsSum += s;
          }

          return { weeklyHours: hoursSum, weeklySessions: sessionsSum };
        }

        // Helper: resolve staff_profile_id for the current user
        async function resolveStaffProfileId(user) {
          // Try by user_id
          try {
            const { data: byUser } = await supabase
              .from('1_staff_holiday_profiles')
              .select('id')
              .eq('user_id', user.id)
              .maybeSingle();
            if (byUser?.id) return byUser.id;
          } catch (_) {}

          // Fallback by email (profiles were historically keyed by unique email)
          try {
            const { data: byEmail } = await supabase
              .from('1_staff_holiday_profiles')
              .select('id')
              .eq('email', user.email)
              .maybeSingle();
            if (byEmail?.id) return byEmail.id;
          } catch (_) {}

          console.warn('[entitlement] No staff_profile_id could be resolved for user', user.id);
          return null;
        }

        // Main: ensure there is a current-year entitlement row with the new structure
        async function ensureEntitlementForUser(user, siteId, totals, isGP) {
          const staffProfileId = await resolveStaffProfileId(user);
          if (!staffProfileId) return;

          const year = new Date().getFullYear();

          // Default multiplier as requested
          const defaultMultiplier = 6;

          const payload = {
            staff_id: staffProfileId,
            year: year,
            weekly_hours: isGP ? null : totals.weeklyHours,
            weekly_sessions: isGP ? totals.weeklySessions : null,
            multiplier: defaultMultiplier
          };

          console.log('[entitlement] Creating entitlement - isGP:', isGP, 'totals:', totals, 'payload:', payload);

          const { error: upErr } = await supabase
            .from('2_staff_entitlements')
            .upsert(payload, { onConflict: 'staff_id,year' });

          if (upErr) {
            console.warn('[entitlement] upsert error', upErr);
          } else {
            console.log('[entitlement] upserted entitlement row', payload);
          }
        }

        // Bind to the "Finish Setup" button so this runs at the end of onboarding
        (function bindEntitlementUpdater(){
          const btn = document.getElementById('complete-setup');
          if (!btn || btn.dataset.entitlementBound === '1') return;

          btn.addEventListener('click', async () => {
            try {
              // Give the existing working-hours save a moment to complete
              await new Promise(r => setTimeout(r, 800));
              const totals = await fetchWeeklyTotalsFromWorkingPattern(user.id, siteId);

              // Check if user is a GP based on their role selection
              const roleSelect = document.getElementById('role');
              const roleValue = roleSelect ? roleSelect.value : window.selectedRole;
              const isGP = roleValue && (roleValue.toLowerCase().includes('doctor') || roleValue.toLowerCase().includes('gp'));
              console.log('[entitlement] Role check - roleValue:', roleValue, 'isGP:', isGP);

              await ensureEntitlementForUser(user, siteId, totals, isGP);
            } catch (e) {
              console.warn('[entitlement] post-setup routine failed', e);
            }
          }, { once: true });

          btn.dataset.entitlementBound = '1';
        })();
        // === /Entitlement auto-upsert after working hours ===
        // Clean up any old force onboarding data
        // Already cleaned up above

        const fullName = profileRow?.full_name || user?.raw_user_meta_data?.full_name || (user?.email?.split('@')[0]) || 'there';
        document.getElementById('welcome-title').textContent = `Welcome, ${fullName}`;

        // Try to read any existing nickname if the column exists
        let nicknameColumnExists = true;
        try {
          const selCols = ['user_id','full_name','site_id','role','nickname'];
          const { data, error } = await supabase
            .from('profiles')
            .select(selCols.join(','))
            .eq('user_id', user.id)
            .maybeSingle();
          if (error) {
            if (String(error.code) === '42703' || /column .*nickname/i.test(String(error.message))) {
              nicknameColumnExists = false;
            } else {
              console.warn('[staff-welcome] profiles select error', error);
            }
          } else if (data && data.nickname) {
            document.getElementById('nickname').value = data.nickname;
          }
        } catch (e) {
          nicknameColumnExists = false;
        }

        // ---- Step 3: DiceBear Avatar Builder (Adventurer) ----
        function rangeArr(start, end, step=1){ const a=[]; for(let i=start;i<=end;i+=step) a.push(i); return a; }
        function pad2(n){ return String(n).padStart(2,'0'); }

        function buildAvatarUrlFromControls(){
          const base = 'https://api.dicebear.com/7.x/adventurer/svg';
          const seed = encodeURIComponent(
            (window.aiSeed && String(window.aiSeed)) ||
            (document.getElementById('nickname')?.value || '').trim() ||
            (typeof fullName === 'string' && fullName) ||
            'User'
          );
          const params = new URLSearchParams();
          params.set('seed', seed);

          const bgType = document.getElementById('opt-backgroundType').value;
          const bgColor = document.getElementById('opt-backgroundColor').value;
          const bgRot = document.getElementById('opt-backgroundRotation').value;
          const radius = document.getElementById('opt-radius').value;
          const rotate = document.getElementById('opt-rotate').value;
          const scale = document.getElementById('opt-scale').value;
          const flip = document.getElementById('opt-flip').value;
          const clip = document.getElementById('opt-clip').value;
          const tx = document.getElementById('opt-translateX').value;
          const ty = document.getElementById('opt-translateY').value;

          const eyes = document.getElementById('opt-eyes').value;
          const mouth = document.getElementById('opt-mouth').value;
          const eyebrows = document.getElementById('opt-eyebrows').value;
          const glasses = document.getElementById('opt-glasses').value;
          const glassesProbability = document.getElementById('opt-glassesProbability').value;
          const earrings = document.getElementById('opt-earrings').value;
          const earringsProbability = document.getElementById('opt-earringsProbability').value;
          const featuresSel = document.getElementById('opt-features');
          const featuresProbability = document.getElementById('opt-featuresProbability').value;
          const hair = document.getElementById('opt-hair').value;
          const hairColor = document.getElementById('opt-hairColor').value;
          const hairProbability = document.getElementById('opt-hairProbability').value;
          const skinColor = document.getElementById('opt-skinColor').value;

          if (bgType) params.set('backgroundType', bgType);
          if (bgColor) params.append('backgroundColor', bgColor);
          if (bgRot) params.append('backgroundRotation', bgRot);
          if (radius) params.set('radius', radius);
          if (rotate) params.set('rotate', rotate);
          if (scale) params.set('scale', scale);
          if (flip) params.set('flip', flip);
          if (clip) params.set('clip', clip);
          if (tx) params.set('translateX', tx);
          if (ty) params.set('translateY', ty);

          if (eyes) params.set('eyes', eyes);
          if (mouth) params.set('mouth', mouth);
          if (eyebrows) params.set('eyebrows', eyebrows);
          if (glasses) params.set('glasses', glasses);
          if (glassesProbability) params.set('glassesProbability', glassesProbability);
          if (earrings) params.set('earrings', earrings);
          if (earringsProbability) params.set('earringsProbability', earringsProbability);
          if (featuresSel){
            const vals = Array.from(featuresSel.selectedOptions).map(o=>o.value).filter(Boolean);
            vals.forEach(v=> params.append('features', v));
          }
          if (featuresProbability) params.set('featuresProbability', featuresProbability);
          if (hair) params.set('hair', hair);
          if (hairColor) params.set('hairColor', hairColor);
          if (hairProbability) params.set('hairProbability', hairProbability);
          if (skinColor) params.set('skinColor', skinColor);

          return `${base}?${params.toString()}`;
        }

        function updateAvatarPreview(){
          const url = buildAvatarUrlFromControls();
          window.currentAvatarUrl = url;
          const img = document.getElementById('avatarPreview');
          if (img) img.src = url;
        }

        function getAiEndpoint(){
          try{
            const loc = window.location;
            if (loc.hostname === '127.0.0.1' || loc.hostname === 'localhost') return 'http://localhost:8787/generate-avatar';
          }catch(_){ }
          return '/api/generate-avatar';
        }

        function collectDropdownOptions(){
          const ids = ['opt-backgroundType','opt-backgroundColor','opt-backgroundRotation','opt-radius','opt-rotate','opt-scale','opt-flip','opt-clip','opt-translateX','opt-translateY','opt-eyes','opt-mouth','opt-eyebrows','opt-glasses','opt-earrings','opt-features','opt-hair','opt-hairColor','opt-skinColor'];
          const out = {};
          for (const id of ids){
            const el = document.getElementById(id);
            if (!el) continue;
            const opts = Array.from(el.options || []).map(o=>o.value).filter(v=>v!=='' && v!=null);
            out[id] = opts;
          }
          // numeric pickers for probs
          out['opt-glassesProbability'] = Array.from(document.getElementById('opt-glassesProbability')?.options||[]).map(o=>Number(o.value)).filter(v=>!isNaN(v));
          out['opt-earringsProbability'] = Array.from(document.getElementById('opt-earringsProbability')?.options||[]).map(o=>Number(o.value)).filter(v=>!isNaN(v));
          out['opt-featuresProbability'] = Array.from(document.getElementById('opt-featuresProbability')?.options||[]).map(o=>Number(o.value)).filter(v=>!isNaN(v));
          out['opt-hairProbability'] = Array.from(document.getElementById('opt-hairProbability')?.options||[]).map(o=>Number(o.value)).filter(v=>!isNaN(v));
          return out;
        }

        async function aiGenerateFromDescription(){
          const prompt = String(document.getElementById('avatarPrompt')?.value||'').trim();
          if (!prompt) throw new Error('Please enter a description first');
          
          if (!globalSupabase) throw new Error('Supabase not initialized');
          
          const nickVal = String(document.getElementById('nickname')?.value || '').trim();
          const seedHint = nickVal || (typeof fullName === 'string' && fullName) || 'User';
          const options = collectDropdownOptions();
          
          // Always use Supabase Edge Function (authenticated and working)
          console.log('Using Supabase Edge Function for AI generation');
          console.log('Generating avatar for description:', prompt);
          
          // Debug: Check if user is logged in
          const { data: { session } } = await globalSupabase.auth.getSession();
          console.log('Current session:', session ? `User: ${session.user.email}` : 'No session');
          
          if (!session || !session.user) {
            throw new Error('You must be logged in to generate avatars. Please refresh and log in again.');
          }
          
          // Build payload
          const payload = { description: prompt, options, seedHint };

          try {
            console.log('Calling Edge Function with payload:', payload);
            console.log('Using Supabase client:', globalSupabase);
            console.log('Session token:', session.access_token ? 'Present' : 'Missing');
            
            const { data, error } = await globalSupabase.functions.invoke('generate-avatar', { body: payload });

            console.log('Supabase Edge Function response:', { data, error });

            if (error) {
              console.error('Edge Function error details:', error);
              console.error('Error type:', typeof error);
              console.error('Error keys:', Object.keys(error));
              console.error('Full error object:', JSON.stringify(error, null, 2));
              
              // Better error handling
              if (error.message) {
                if (error.message.includes('FunctionsHttpError') || error.message.includes('Failed to send')) {
                  // This is likely a network or CORS issue
                  throw new Error('Failed to connect to avatar generation service. Please check your connection and try again.');
                } else if (error.message.includes('Unauthorized') || error.message.includes('authorization')) {
                  throw new Error('Authentication failed. Please refresh and log in again.');
                } else if (error.message.includes('CheckLoopsAI')) {
                  throw new Error('AI service configuration error. Please contact support.');
                } else {
                  throw new Error(`Avatar generation error: ${error.message}`);
                }
              } else if (error.context && error.context.status === 401) {
                throw new Error('Authentication failed. Please refresh and log in again.');
              }
              throw new Error(`AI generation failed: ${JSON.stringify(error)}`);
            }

            if (!data || Object.keys(data).length === 0) {
              throw new Error('No avatar data returned from AI. Please try a different description.');
            }

            console.log('Successfully generated avatar data:', data);
            applyAiResult(data);
            // Preview updated, but not saved until user clicks Continue
            updateAvatarPreview();
            // REMOVED: Auto-save after AI generation - only save when user clicks Continue
            const msg = document.getElementById('avatar-ai-msg');
            if (msg) msg.innerHTML = '‚úÖ Avatar generated successfully. You can fine-tune below or click Continue to save.';
            return data;
          } catch (supabaseError) {
            // Log error for console only
            console.error('Caught error in Edge Function call:', supabaseError);
            console.error('Error stack:', supabaseError.stack);
            
            // Check for specific error patterns
            const errorStr = String(supabaseError);
            const errorMsg = supabaseError.message || errorStr;
            
            if (errorMsg.includes('Failed to connect') || errorMsg.includes('Failed to send')) {
              // Already handled above, just re-throw
              throw supabaseError;
            } else if (errorStr.includes('Authentication') || errorStr.includes('Unauthorized')) {
              throw new Error('Authentication failed. Please refresh the page and log in again.');
            } else if (errorStr.includes('fetch') || errorStr.includes('NetworkError')) {
              throw new Error('Network error. Please check your connection and try again.');
            } else if (errorStr.includes('timeout')) {
              throw new Error('Request timed out. Please try again with a shorter description.');
            } else if (errorStr.includes('CORS')) {
              throw new Error('Connection blocked. Please check if you are logged in properly.');
            }
            
            // If we get here, throw the original error message if it's clear enough
            if (supabaseError.message && supabaseError.message.length < 200) {
              throw supabaseError;
            } else {
              throw new Error('Avatar generation failed. Please try again or contact support.');
            }
          }
        }

        function applyAiResult(data){
          console.log('Applying AI result:', data);
          
          const setVal = (id, val) => { 
            const el = document.getElementById(id); 
            if (!el) {
              console.warn(`Element not found: ${id}`);
              return; 
            }
            el.value = String(val); 
            console.log(`Set ${id} = ${val}`);
          };
          
          const maybe = (k) => data[k] !== undefined && data[k] !== null && data[k] !== '';
          
          // Handle seed specially (no visible input)
          if (maybe('seed')) {
            try { window.aiSeed = String(data.seed); } catch(_) {}
            const sEl = document.getElementById('opt-seed');
            if (sEl) sEl.value = String(data.seed);
            console.log(`Set seed = ${data.seed}`);
          }
          
          // Map all the standard fields
          const fieldMappings = new Map([
            ['backgroundType','opt-backgroundType'],
            ['backgroundColor','opt-backgroundColor'],
            ['backgroundRotation','opt-backgroundRotation'],
            ['radius','opt-radius'],
            ['rotate','opt-rotate'],
            ['scale','opt-scale'],
            ['flip','opt-flip'],
            ['clip','opt-clip'],
            ['translateX','opt-translateX'],
            ['translateY','opt-translateY'],
            ['eyes','opt-eyes'],
            ['mouth','opt-mouth'],
            ['eyebrows','opt-eyebrows'],
            ['glasses','opt-glasses'],
            ['glassesProbability','opt-glassesProbability'],
            ['earrings','opt-earrings'],
            ['earringsProbability','opt-earringsProbability'],
            ['featuresProbability','opt-featuresProbability'],
            ['hair','opt-hair'],
            ['hairColor','opt-hairColor'],
            ['hairProbability','opt-hairProbability'],
            ['skinColor','opt-skinColor']
          ]);
          
          for (const [dataKey, elementId] of fieldMappings.entries()) { 
            if (maybe(dataKey)) {
              setVal(elementId, data[dataKey]); 
            }
          }

          // Handle features array (multi-select) separately
          if (Array.isArray(data.features) && data.features.length > 0) {
            const featuresEl = document.getElementById('opt-features');
            if (featuresEl) {
              // First clear all selections
              Array.from(featuresEl.options).forEach(option => {
                option.selected = false;
              });
              // Then select the ones from AI
              Array.from(featuresEl.options).forEach(option => {
                if (data.features.includes(option.value)) {
                  option.selected = true;
                  console.log(`Selected feature: ${option.value}`);
                }
              });
            }
          } else if (maybe('features') && typeof data.features === 'string') {
            // Handle single feature as string
            const featuresEl = document.getElementById('opt-features');
            if (featuresEl) {
              Array.from(featuresEl.options).forEach(option => {
                option.selected = (option.value === data.features);
              });
              console.log(`Selected single feature: ${data.features}`);
            }
          }

          // Log what we successfully applied
          const appliedFields = [];
          for (const [dataKey] of fieldMappings.entries()) {
            if (maybe(dataKey)) appliedFields.push(dataKey);
          }
          if (Array.isArray(data.features) || maybe('features')) appliedFields.push('features');
          console.log(`Applied fields: ${appliedFields.join(', ')}`);
          
          // Update the avatar preview with new settings
          updateAvatarPreview();
          
          // Show success feedback
          const msg = document.getElementById('avatar-ai-msg');
          if (msg) {
            const probFields = [];
            if (maybe('hairProbability')) probFields.push('hair probability');
            if (maybe('featuresProbability')) probFields.push('features probability');
            if (maybe('glassesProbability')) probFields.push('glasses probability');
            if (maybe('earringsProbability')) probFields.push('earrings probability');
            
            let feedbackText = `Applied! Generated ${appliedFields.length} avatar settings.`;
            if (probFields.length > 0) {
              feedbackText += ` Including ${probFields.join(', ')}.`;
            }
            feedbackText += ' You can fine-tune with the dropdowns below.';
            msg.textContent = feedbackText;
          }
          
          // No manual save prompt for AI-applied results; we will auto-save elsewhere.
        }

        async function initAvatarBuilder(fullName){
          // Fill dropdowns
          const seedEl = document.getElementById('opt-seed');
          const nickVal = String(document.getElementById('nickname')?.value || '').trim();
          if (seedEl) seedEl.value = nickVal || fullName || 'User';

          const fillOpts = (el, arr, withBlank=false) => {
            el.innerHTML = '';
            if (withBlank) el.appendChild(new Option('Default',''));
            for(const v of arr){ el.appendChild(new Option(String(v), String(v))); }
          };

          // Human‚Äëreadable labels for avatar options - analyzed with OpenAI Vision
          const eyeLabels = {
            variant01: 'Eyes: Curious',
            variant02: 'Eyes: Observant',
            variant03: 'Eyes: Inquisitive',
            variant04: 'Eyes: Unimpressed',
            variant05: 'Eyes: Pondering',
            variant06: 'Eyes: Doubtful',
            variant07: 'Eyes: Dispassionate',
            variant08: 'Eyes: Wide-eyed',
            variant09: 'Eyes: Quizzical',
            variant10: 'Eyes: Skeptical',
            variant11: 'Eyes: Mildly Amused',
            variant12: 'Eyes: Mischievous',
            variant13: 'Eyes: Sardonic',
            variant14: 'Eyes: Cynical',
            variant15: 'Eyes: Softly Sorrowful',
            variant16: 'Eyes: Slightly Disenchanted',
            variant17: 'Eyes: Unimpressed gaze',
            variant18: 'Eyes: Nonchalant',
            variant19: 'Eyes: Calmly Satisfied',
            variant20: 'Eyes: Subdued Glow',
            variant21: 'Eyes: Winking Playfulness',
            variant22: 'Eyes: Playfully Squinting',
            variant23: 'Eyes: Slightly Confounded',
            variant24: 'Eyes: Blankly Engaged',
            variant25: 'Eyes: Contemplative',
            variant26: 'Eyes: Slightly Bewildered'
          };
          const mouthLabels = {
            variant01: 'Mouth: Cheerful curve',
            variant02: 'Mouth: Subdued smirk',
            variant03: 'Mouth: Awestruck pout',
            variant04: 'Mouth: Pensive line',
            variant05: 'Mouth: Beaming smile',
            variant06: 'Mouth: Delicate crease',
            variant07: 'Mouth: Shocked oval',
            variant08: 'Mouth: Slight line',
            variant09: 'Mouth: Straight line',
            variant10: 'Mouth: Puffed pout',
            variant11: 'Mouth: Tensed line',
            variant12: 'Mouth: Playful protrusion',
            variant13: 'Mouth: Distorted surprise',
            variant14: 'Mouth: Awkward oval',
            variant15: 'Mouth: Spacious oval',
            variant16: 'Mouth: Playful tongue-out',
            variant17: 'Mouth: Subtle expression',
            variant18: 'Mouth: O-shaped surprise',
            variant19: 'Mouth: Curious line',
            variant20: 'Mouth: Pouty hint',
            variant21: 'Mouth: Tiny tease',
            variant22: 'Mouth: Mischievous twist',
            variant23: 'Mouth: Grinning gap',
            variant24: 'Mouth: Hearted surprise',
            variant25: 'Mouth: Gleeful grin',
            variant26: 'Mouth: Joyful arch',
            variant27: 'Mouth: Excited line',
            variant28: 'Mouth: Joyful beam',
            variant29: 'Mouth: Quirky twist',
            variant30: 'Mouth: Joyful triangle'
          };
          const browLabels = {
            variant01: 'Brows: Boldly Angled',
            variant02: 'Brows: Fiercely Slanted',
            variant03: 'Brows: Subtle Arch',
            variant04: 'Brows: Slightly Curved',
            variant05: 'Brows: Quirky Flick',
            variant06: 'Brows: Playfully Raised',
            variant07: 'Brows: Subdued Lift',
            variant08: 'Brows: Mildly Furrowed',
            variant09: 'Brows: Mildly Arched',
            variant10: 'Brows: Gently Straightened',
            variant11: 'Brows: Slightly Drooped',
            variant12: 'Brows: Softly Straightened',
            variant13: 'Brows: Subtly Defined',
            variant14: 'Brows: Lightly Tapered',
            variant15: 'Brows: Playfully Asymmetrical'
          };
          const glassesLabels = {
            '': 'None',
            variant01: 'Glasses: Round',
            variant02: 'Glasses: Square',
            variant03: 'Glasses: Thin',
            variant04: 'Glasses: Thick',
            variant05: 'Glasses: Cat‚Äëeye'
          };
          const earringsLabels = {
            '': 'None',
            variant01: 'Earrings: Studs',
            variant02: 'Earrings: Hoops',
            variant03: 'Earrings: Drops',
            variant04: 'Earrings: Small Hoops',
            variant05: 'Earrings: Bars',
            variant06: 'Earrings: Stars'
          };
          const hairColorNames = {
            '0e0e0e': 'Black',
            'e5d7a3': 'Blonde',
            '9e5622': 'Brown',
            '763900': 'Dark Brown',
            'cb6820': 'Red',
            'ac6511': 'Copper',
            'b9a05f': 'Sandy',
            '796a45': 'Ash Brown',
            '6a4e35': 'Chestnut',
            '562306': 'Dark Chestnut',
            'afafaf': 'Grey',
            '3eac2c': 'Green',
            '85c2c6': 'Teal',
            'dba3be': 'Pink',
            '592454': 'Plum'
          };
          const skinColorNames = {
            'f2d3b1': 'Fair',
            'ecad80': 'Tan',
            '9e5622': 'Brown',
            '763900': 'Dark Brown'
          };

          function labelFromVariant(prefix, v, map){
            if (map && map[v]) return map[v];
            const sv = String(v);
            if (sv.startsWith('variant')) {
              const n = parseInt(sv.slice(7), 10);
              const num = isNaN(n) ? sv.replace('variant','') : n;
              return `${prefix} Style ${num}`; // e.g., "Mouth Style 9"
            }
            return `${prefix} ${sv}`;
          }
          const hairStyleNames = {
            short01: 'Short: Fluffy layers',
            short02: 'Short: Playful bangs',
            short03: 'Short: Bouncy curls',
            short04: 'Short: Tapered edges',
            short05: 'Short: Top Knot',
            short06: 'Short: Asymmetrical swoop',
            short07: 'Short: Whimsical waves',
            short08: 'Short: Spiraled tufts',
            short09: 'Short: Flared spikes',
            short10: 'Short: Defined bob',
            short11: 'Short: Sleek pompadour',
            short12: 'Short: Bold streak',
            short13: 'Short: Sleek crop',
            short14: 'Short: Bold quiff',
            short15: 'Short: Spiky flair',
            short16: 'Short: Wild spikes',
            short17: 'Short: Textured tufts',
            short18: 'Short: Quirky tufts',
            short19: 'Short: Smoothly cropped',
            long01: 'Long: Sleek sweep',
            long02: 'Long: Playful tousle',
            long03: 'Long: Floral crown',
            long04: 'Long: Angular strands',
            long05: 'Long: Softly rounded',
            long06: 'Long: Lush tendrils',
            long07: 'Long: Choppy fringes',
            long08: 'Long: Floral fringe',
            long09: 'Long: Flowing layers',
            long10: 'Long: Spirited ponytail',
            long11: 'Long: Playful top-knot',
            long12: 'Long: Subtle bob',
            long13: 'Long: Twisted buns',
            long14: 'Long: Double ponytails',
            long15: 'Long: Playful pigtails',
            long16: 'Long: Braided charm',
            long17: 'Long: Playful curls',
            long18: 'Long: Charming waves',
            long19: 'Long: Sleek ponytail',
            long20: 'Long: Angular sweep',
            long21: 'Long: Curved strands',
            long22: 'Long: Lively volume',
            long23: 'Long: Playful buns',
            long24: 'Long: Lively bounce',
            long25: 'Long: Sleek asymmetry',
            long26: 'Long: Vibrant fringes'
          };
          
          function hairLabel(key){
            return hairStyleNames[key] || String(key);
          }
          function fillOptsLabeled(el, values, labeler, withBlank=false){
            el.innerHTML = '';
            if (withBlank) el.appendChild(new Option('Default',''));
            for (const v of values){
              const label = labeler(v);
              const opt = new Option(label, String(v));
              opt.title = label;
              el.appendChild(opt);
            }
          }

          // Fetch optional DB labels so you can manage names without code changes
          async function fetchLabelMap(){
            try {
              const { data, error } = await supabase
                .from('avatar_option_labels')
                .select('option_id,value_key,label');
              if (error || !Array.isArray(data)) return {};
              const map = {};
              for (const r of data) {
                if (!map[r.option_id]) map[r.option_id] = {};
                map[r.option_id][r.value_key] = r.label;
              }
              return map;
            } catch(_) { return {}; }
          }

          const dbLabels = await fetchLabelMap();
          const labelFor = (optId, value, fallback) => {
            const lab = dbLabels?.[optId]?.[String(value)];
            return lab || fallback;
          };

          fillOpts(document.getElementById('opt-backgroundRotation'), rangeArr(0,360,15), true);
          fillOpts(document.getElementById('opt-radius'), rangeArr(0,50,5), true);
          fillOpts(document.getElementById('opt-rotate'), rangeArr(0,360,15), true);
          fillOpts(document.getElementById('opt-translateX'), rangeArr(-50,50,5), true);
          fillOpts(document.getElementById('opt-translateY'), rangeArr(-50,50,5), true);

          // Adventurer variants
          const eyes = Array.from({length:26}, (_,i)=>`variant${pad2(i+1)}`);
          const mouths = Array.from({length:30}, (_,i)=>`variant${pad2(i+1)}`);
          const brows = Array.from({length:15}, (_,i)=>`variant${pad2(i+1)}`);
          const glasses = Array.from({length:5},  (_,i)=>`variant${pad2(i+1)}`);
          const earrings = Array.from({length:6},  (_,i)=>`variant${pad2(i+1)}`);
          const features = ['mustache','blush','birthmark','freckles'];
          const featureLabels = {
            'mustache': 'Facial Hair',
            'blush': 'Rosy Cheeks', 
            'birthmark': 'Beauty Mark',
            'freckles': 'Freckles'
          };
          const hair = [
            ...Array.from({length:19}, (_,i)=>`short${pad2(i+1)}`),
            ...Array.from({length:26}, (_,i)=>`long${pad2(i+1)}`)
          ];
          // Expanded hair color palette to include browns returned by AI
          const hairColors = ['ac6511','cb6820','ab2a18','e5d7a3','b9a05f','796a45','6a4e35','562306','9e5622','763900','0e0e0e','afafaf','3eac2c','85c2c6','dba3be','592454'];
          const skinColors = ['f2d3b1','ecad80','9e5622','763900'];

          fillOptsLabeled(document.getElementById('opt-eyes'), eyes, v=>labelFor('opt-eyes', v, labelFromVariant('Eyes', v, eyeLabels)), true);
          fillOptsLabeled(document.getElementById('opt-mouth'), mouths, v=>labelFor('opt-mouth', v, labelFromVariant('Mouth', v, mouthLabels)), true);
          fillOptsLabeled(document.getElementById('opt-eyebrows'), brows, v=>labelFor('opt-eyebrows', v, labelFromVariant('Brows', v, browLabels)), true);
          fillOptsLabeled(document.getElementById('opt-glasses'), ['','variant01','variant02','variant03','variant04','variant05'], v=>labelFor('opt-glasses', v, (glassesLabels[v] || labelFromVariant('Glasses', v, {}))), false);
          fillOpts(document.getElementById('opt-glassesProbability'), rangeArr(0,100,10), true);
          fillOptsLabeled(document.getElementById('opt-earrings'), ['','variant01','variant02','variant03','variant04','variant05','variant06'], v=>labelFor('opt-earrings', v, (earringsLabels[v] || labelFromVariant('Earrings', v, {}))), false);
          fillOpts(document.getElementById('opt-earringsProbability'), rangeArr(0,100,10), true);
          // features (multi-select)
          const featuresEl = document.getElementById('opt-features');
          if (featuresEl){
            featuresEl.innerHTML = '';
            for (const v of features){ 
              const label = featureLabels[v] || v;
              featuresEl.appendChild(new Option(label, v)); 
            }
          }
          fillOpts(document.getElementById('opt-featuresProbability'), rangeArr(0,100,5), true);
          fillOptsLabeled(document.getElementById('opt-hair'), [''].concat(hair), v=> labelFor('opt-hair', v, (v ? hairLabel(v) : 'Default')), false);
          fillOptsLabeled(document.getElementById('opt-hairColor'), [''].concat(hairColors), hex => labelFor('opt-hairColor', hex, (hex ? ((hairColorNames[hex] ? `${hairColorNames[hex]} (${hex})` : hex)) : 'Default')), false);
          fillOpts(document.getElementById('opt-hairProbability'), rangeArr(0,100,10), true);
          fillOptsLabeled(document.getElementById('opt-skinColor'), [''].concat(skinColors), hex => labelFor('opt-skinColor', hex, (hex ? ((skinColorNames[hex] ? `${skinColorNames[hex]} (${hex})` : hex)) : 'Default')), false);

          // Bind changes
          const ids = [
            'opt-backgroundType','opt-backgroundColor','opt-backgroundRotation','opt-radius','opt-rotate','opt-scale','opt-flip','opt-clip','opt-translateX','opt-translateY','opt-eyes','opt-mouth','opt-eyebrows','opt-glasses','opt-glassesProbability','opt-earrings','opt-earringsProbability','opt-featuresProbability','opt-hair','opt-hairColor','opt-hairProbability','opt-skinColor'
          ];
          ids.forEach(id=>{
            const el = document.getElementById(id);
            if (el && !el.dataset.bound){ 
              el.addEventListener('input', () => {
                updateAvatarPreview();
                // mark that avatar has unsaved manual changes
                window.avatarDirty = true;
                const saveMsg = document.getElementById('avatar-save-msg');
                if (saveMsg) saveMsg.textContent = 'You have unsaved changes ‚Äî they will be saved when you finish.';
              }); 
              el.dataset.bound='1'; 
            }
          });
          // features (multi-select)
          const featuresMulti = document.getElementById('opt-features');
          if (featuresMulti && !featuresMulti.dataset.bound){ 
            featuresMulti.addEventListener('change', () => {
              updateAvatarPreview();
              window.avatarDirty = true;
              const saveMsg = document.getElementById('avatar-save-msg');
              if (saveMsg) saveMsg.textContent = 'You have unsaved changes ‚Äî they will be saved when you finish.';
            }); 
            featuresMulti.dataset.bound='1'; 
          }

          // ---------- New: render friendly option buttons for several selects ----------
          const makeOptionButtons = (selectId, opts, renderFn, hideSelect = false) => {
            const sel = document.getElementById(selectId);
            if (!sel) return null;
            // create container after select
            const container = document.createElement('div');
            container.className = 'option-buttons';
            // optionally hide the native select (keep it in DOM for state)
            if (hideSelect) sel.classList.add('select-hidden');
            // For each option create a button
            const values = opts || Array.from(sel.options || []).map(o=> ({ v: o.value, t: o.text }));
            // If opts is provided as array of values, normalize
            const norm = values.map(x => (typeof x === 'string' || typeof x === 'number') ? { v: String(x), t: String(x) } : x);
            norm.forEach(item => {
              // skip empty values (use default behavior)
              if (!item.v || item.v === '') return;
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'option-btn';
              btn.dataset.value = item.v;
              // render content via renderFn or fallback
              if (renderFn) btn.appendChild(renderFn(item)); else btn.textContent = item.t || item.v;
              // click behavior: select corresponding option in native select and trigger input
              btn.addEventListener('click', (e)=>{
                e.preventDefault();
                // handle single vs multi
                if (sel.multiple){
                  const opt = Array.from(sel.options).find(o=>String(o.value)===String(item.v));
                  if (opt) opt.selected = !opt.selected;
                  btn.classList.toggle('selected', !!opt && opt.selected);
                } else {
                  // clear other buttons
                  container.querySelectorAll('.option-btn').forEach(b=> b.classList.remove('selected'));
                  btn.classList.add('selected');
                  // set select value
                  sel.value = item.v;
                }
                // dispatch input event
                sel.dispatchEvent(new Event('input', { bubbles:true }));
                sel.dispatchEvent(new Event('change', { bubbles:true }));
              });
              container.appendChild(btn);
            });
            // insert container after select
            sel.parentNode.insertBefore(container, sel.nextSibling);

            // Initialize selected state from select value(s)
            const syncFromSelect = () => {
              const vals = sel.multiple ? Array.from(sel.selectedOptions).map(o=>String(o.value)) : [String(sel.value)];
              container.querySelectorAll('.option-btn').forEach(b=>{
                const v = String(b.dataset.value);
                b.classList.toggle('selected', vals.includes(v));
              });
            };
            // initial sync
            syncFromSelect();
            // keep in sync if select changes externally
            sel.addEventListener('change', syncFromSelect);
            return container;
          };

          // Helper renderers
          const swatchRenderer = (hex) => {
            const span = document.createElement('span');
            span.className = 'option-swatch';
            span.style.background = `#${hex.v}`;
            span.title = hex.t || hex.v;
            return span;
          };
          const textRenderer = (item) => {
            const span = document.createElement('span');
            span.textContent = item.t || item.v;
            return span;
          };

          // Only render hair color as swatch buttons; keep other options as dropdowns
          try {
            const hairColorOpts = Array.from(document.getElementById('opt-hairColor')?.options||[]).map(o=> ({ v:o.value, t:o.text }));
            makeOptionButtons('opt-hairColor', hairColorOpts, swatchRenderer, true);
          } catch (e) { console.warn('option button render failed', e); }

          // --------------------------------------------------------------------------------

          // Function to mark manual changes and show save button
          function markManualChange() {
            // deprecated: kept for backwards compatibility if other code calls it
            window.avatarDirty = true;
            const saveMsg = document.getElementById('avatar-save-msg');
            if (saveMsg) saveMsg.textContent = 'You have unsaved changes ‚Äî they will be saved when you finish.';
          }

          // Randomize/reset
          const rnd = document.getElementById('avatar-randomize');
          if (rnd && !rnd.dataset.bound){ rnd.addEventListener('click', async ()=>{
            const seeds = ['Nova','Ziggy','Aria','Kai','Milo','Ivy','Atlas','Sage','Skye','Orion','Zoe','Finn','Quinn','Remy'];
            const seed = seeds[Math.floor(Math.random()*seeds.length)] + Math.floor(Math.random()*100);
            try { window.aiSeed = seed; } catch(_) {}
            if (seedEl) seedEl.value = seed;
            const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];
            document.getElementById('opt-eyes').value = pick(eyes);
            document.getElementById('opt-mouth').value = pick(mouths);
            document.getElementById('opt-eyebrows').value = pick(brows);
            document.getElementById('opt-glasses').value = pick(['','variant01','variant02','variant03','variant04','variant05']);
            document.getElementById('opt-glassesProbability').value = pick(rangeArr(0,100,10));
            document.getElementById('opt-earrings').value = pick(['','variant01','variant02','variant03','variant04','variant05','variant06']);
            document.getElementById('opt-earringsProbability').value = pick(rangeArr(0,100,10));
            document.getElementById('opt-hair').value = pick(hair);
            document.getElementById('opt-hairColor').value = pick(hairColors);
            document.getElementById('opt-hairProbability').value = pick(rangeArr(0,100,10));
            document.getElementById('opt-skinColor').value = pick(skinColors);
            const fEl = document.getElementById('opt-features');
            for (const o of Array.from(fEl.options)) o.selected = false;
            // randomly pick up to 2 features
            const pool = [...features];
            for (let i=0;i<Math.floor(Math.random()*3);i++){
              const idx = Math.floor(Math.random()*pool.length);
              const val = pool.splice(idx,1)[0];
              const opt = Array.from(fEl.options).find(o=>o.value===val); if (opt) opt.selected = true;
            }
            updateAvatarPreview();
            markManualChange(); // Show that changes were made

            // REMOVED: Auto-save after randomization - only save when user clicks Continue
            const saveMsg = document.getElementById('avatar-save-msg');
            if (saveMsg) {
              saveMsg.textContent = '‚úÖ Avatar randomized! Click Continue to save.';
            }
          }); rnd.dataset.bound='1'; }

          // Manual save button
          const manualSaveBtn = document.getElementById('avatar-save-manual');
          if (manualSaveBtn && !manualSaveBtn.dataset.bound) {
            manualSaveBtn.addEventListener('click', async () => {
              const saveMsg = document.getElementById('avatar-save-msg');
              try {
                const avatarUrl = buildAvatarUrlFromControls();
                console.log('Manual save: Avatar URL:', avatarUrl);

                if (saveMsg) saveMsg.textContent = 'Saving avatar...';

                const saveFunction = (typeof saveAvatarToSupabase !== 'undefined') ? saveAvatarToSupabase : window.saveAvatarToSupabase;
                if (saveFunction) {
                  const result = await saveFunction(avatarUrl);
                  if (result !== false) {
                    if (saveMsg) saveMsg.textContent = '‚úÖ Avatar saved successfully! You can now see it on the homepage.';
                    window.avatarDirty = false;

                    // Force refresh the homepage avatar by clearing any cached data
                    try {
                      // Update the session to get fresh data next time
                      const { data: { user: refreshedUser } } = await supabase.auth.getUser();
                      console.log('User session refreshed after avatar save');
                    } catch(e) {
                      console.warn('Could not refresh user session:', e);
                    }
                  } else {
                    if (saveMsg) saveMsg.textContent = '‚ùå Failed to save avatar';
                  }
                } else {
                  console.error('saveAvatarToSupabase function not found');
                  if (saveMsg) saveMsg.textContent = '‚ùå Save function not available';
                }
              } catch (error) {
                console.error('Manual save error:', error);
                if (saveMsg) saveMsg.textContent = '‚ùå Error: ' + error.message;
              }
            });
            manualSaveBtn.dataset.bound = '1';
          }

          // Save helper used by both AI auto-save and finish/save flow
          // CONSOLIDATED Avatar Save Function - saves to all necessary tables
          async function saveAvatarToSupabase(avatarUrl){
            const saveMsg = document.getElementById('avatar-save-msg');
            console.log('[saveAvatarToSupabase] Starting save with URL:', avatarUrl);
            try {
              const nickVal = String(document.getElementById('nickname')?.value || '').trim() || null;
              const displayName = nickVal || fullName || user?.email?.split('@')[0] || 'Staff';
              if (saveMsg) { saveMsg.textContent = 'Saving avatar...'; }
              console.log('[saveAvatarToSupabase] Nickname:', nickVal, 'Display name:', displayName);

              // Save avatar URL to user metadata
              await supabase.auth.updateUser({
                data: {
                  avatar_url: avatarUrl,
                  nickname: nickVal,
                  role_detail: window.selectedRole || user?.raw_user_meta_data?.role_detail || null,
                  team_id: window.selectedTeamId || null,
                  team_name: window.selectedTeamName || null
                }
              });

              // Save to master_users table (primary source of truth)
              try {
                // Get the original access_type from user metadata (set during invitation)
                const originalAccessType = user?.user_metadata?.role ||
                                         user?.raw_user_meta_data?.role ||
                                         user?.app_metadata?.role ||
                                         'staff';

                // Get the original full_name from invitation data
                const originalFullName = user?.user_metadata?.full_name ||
                                       user?.raw_user_meta_data?.full_name ||
                                       fullName || displayName;

                const masterData = {
                  auth_user_id: user.id,
                  email: user.email,
                  avatar_url: avatarUrl,
                  nickname: nickVal,
                  full_name: originalFullName,  // Use original full_name from invitation
                  role_detail: window.selectedRole || user?.raw_user_meta_data?.role_detail || null,
                  access_type: originalAccessType,  // Preserve original access_type from invitation
                  site_id: siteId,
                  team_id: window.selectedTeamId || null,
                  team_name: window.selectedTeamName || null,
                  updated_at: new Date().toISOString()
                };

                console.log('[saveAvatarToSupabase] Upserting to master_users:', masterData);
                const { data: masterResult, error: masterErr } = await supabase
                  .from('master_users')
                  .upsert(masterData, {
                    onConflict: 'auth_user_id',
                    ignoreDuplicates: false
                  })
                  .select();

                if (masterErr) {
                  console.error('[saveAvatarToSupabase] Master users update error:', masterErr);
                  // Fall back to profiles table if master_users doesn't exist
                  const userRole = window.selectedRole ? window.selectedRole.toLowerCase() : 'staff';
                  let normalizedRole = 'staff';
                  if (userRole === 'admin') {
                    normalizedRole = 'admin';
                  }

                  const profileData = {
                    user_id: user.id,
                    avatar_url: avatarUrl,
                    nickname: nickVal,
                    full_name: fullName || displayName,
                    role: normalizedRole
                  };
                  if (siteId) profileData.site_id = siteId;

                  const { data: profileResult, error: profileErr } = await supabase
                    .from('profiles')
                    .upsert(profileData, {
                      onConflict: 'user_id',
                      ignoreDuplicates: false
                    })
                    .select();

                  if (profileErr) {
                    console.error('[saveAvatarToSupabase] Profile update error:', profileErr);
                    throw profileErr;
                  } else {
                    console.log('[saveAvatarToSupabase] Profile updated successfully:', profileResult);
                  }
                } else {
                  console.log('[saveAvatarToSupabase] Master users updated successfully:', masterResult);
                }
                window.currentSavedAvatarUrl = avatarUrl; // Track that avatar was saved
              } catch (e) {
                console.error('[saveAvatarToSupabase] Save exception:', e);
                throw e; // Re-throw to handle upstream
              }

              // Save to staff_app_welcome
              if (siteId) {
                try {
                  const payload = {
                    user_id: user.id,
                    site_id: siteId,
                    full_name: fullName || displayName,
                    nickname: nickVal,
                    avatar_url: avatarUrl,
                    role_detail: window.selectedRole || user?.raw_user_meta_data?.role_detail || null,
                    team_id: window.selectedTeamId || null,
                    team_name: window.selectedTeamName || null
                  };
                  await supabase.from('staff_app_welcome').upsert(payload);
                } catch (_) { /* non-critical */ }
              }

              // Update 1_staff_holiday_profiles with avatar and latest info
              try {
                // First check if profile exists
                const { data: existingProfile } = await supabase
                  .from('1_staff_holiday_profiles')
                  .select('id')
                  .eq('email', user.email)
                  .maybeSingle();

                if (existingProfile) {
                  // Update existing profile with avatar
                  await supabase
                    .from('1_staff_holiday_profiles')
                    .update({
                      avatar_url: avatarUrl,
                      role: window.selectedRole || user?.raw_user_meta_data?.role || 'Staff',
                      team_name: window.selectedTeamName || null,
                      updated_at: new Date().toISOString()
                    })
                    .eq('id', existingProfile.id);
                }
              } catch (e) {
                console.warn('Holiday profile avatar update error:', e);
              }

              window.currentSavedAvatarUrl = avatarUrl;
              window.avatarDirty = false;
              if (saveMsg) saveMsg.innerHTML = '‚úÖ Avatar saved successfully!';
              return true;
            } catch (e) {
              console.error('Save avatar error:', e);
              if (saveMsg) saveMsg.innerHTML = `‚ùå Save failed: ${e.message || e}`;
              return false;
            }
          }
          // Expose globally so other handlers (e.g., AI autosave) can call it safely
          try { window.saveAvatarToSupabase = saveAvatarToSupabase; } catch(_) {}

          // Ensure initial dirty state
          window.avatarDirty = false;

          // Back button
          const back = document.getElementById('back-to-step2');
          if (back && !back.dataset.bound){ back.addEventListener('click', ()=>{
            document.getElementById('welcome-step3').style.display = 'none';
            document.getElementById('welcome-step2').style.display = '';
          }); back.dataset.bound='1'; }

          // AI Generate button
          const aiBtn = document.getElementById('avatar-ai-generate');
          if (aiBtn && !aiBtn.dataset.bound){ aiBtn.addEventListener('click', async ()=>{
            const msg = document.getElementById('avatar-ai-msg');
            const originalText = msg.textContent;
            
            // Validate description input
            const prompt = String(document.getElementById('avatarPrompt')?.value||'').trim();
            if (!prompt) {
              msg.textContent = '‚ö†Ô∏è Please enter a description first (e.g., "friendly nurse with brown hair")';
              return;
            }
            
            msg.innerHTML = 'ü§ñ AI is generating your avatar... <span style="opacity:0.7">(this may take a few seconds)</span>';
            aiBtn.disabled = true;
            aiBtn.textContent = 'Generating...';
            
            try{
              const result = await aiGenerateFromDescription();
              msg.innerHTML = `‚úÖ Success! Adjust with settings below or click Continue to save.`;
              
              // Auto-focus on preview to draw attention to the result
              const preview = document.getElementById('avatarPreview');
              if (preview) {
                preview.style.transform = 'scale(1.05)';
                setTimeout(() => {
                  preview.style.transform = 'scale(1)';
                  preview.style.transition = 'transform 0.3s ease';
                }, 300);
              }
              
            }catch(e){
              console.error('AI generation error:', e);
              
              // Provide helpful error messages
              let errorMsg = '‚ùå ';
              if (e.message.includes('Authentication') || e.message.includes('Unauthorized')) {
                errorMsg += 'Please refresh the page and log in again.';
              } else if (e.message.includes('description')) {
                errorMsg += 'Please try a more detailed description.';
              } else if (e.message.includes('Network') || e.message.includes('fetch')) {
                errorMsg += 'Network error. Please check your connection.';
              } else {
                errorMsg += `Generation failed: ${e.message}`;
              }
              
              msg.innerHTML = `${errorMsg} <button onclick="this.parentElement.textContent='${originalText}'" style="margin-left:8px;padding:2px 6px;font-size:11px;border:1px solid #ccc;border-radius:4px;background:#fff;cursor:pointer;">Dismiss</button>`;
            } finally {
              aiBtn.disabled = false;
              aiBtn.textContent = 'Generate with AI';
            }
          }); aiBtn.dataset.bound='1'; }

          // Continue to Working Hours button
          const finish = document.getElementById('finish-avatar-btn');
          if (finish && !finish.dataset.bound){ finish.addEventListener('click', async ()=>{
            const fm = document.getElementById('finish-avatar-msg');
            fm.textContent = '';

            // Determine current avatar URL
            const avatar = window.currentSavedAvatarUrl || window.currentAvatarUrl || buildAvatarUrlFromControls();

            // If there are unsaved manual changes or avatar not saved yet, save first
            if (window.avatarDirty || !window.currentSavedAvatarUrl) {
              try{
                if (fm) fm.textContent = 'Saving your avatar‚Ä¶';
                const ok = await saveAvatarToSupabase(avatar);
                if (!ok) {
                  console.warn('Avatar save returned false; continuing to working hours');
                  if (fm) fm.innerHTML = '‚ö†Ô∏è Could not fully save your avatar. Continuing to working hours‚Ä¶';
                  // Do NOT return here; continue to working hours so the user can finish setup
                } else {
                  if (fm) fm.textContent = 'Avatar saved.';
                }
              } catch (e) {
                console.warn('finish save failed (exception), continuing', e);
                if (fm) fm.innerHTML = '‚ö†Ô∏è Could not save your avatar. Continuing to working hours‚Ä¶';
                // continue despite errors
              }
            }

            // Save avatar and profile data
            const teamIdNum = (window.selectedTeamId ?? null);
            const role = (window.selectedRole || 'staff');
            const nicknameValue = document.getElementById('nickname')?.value?.trim() || user?.email?.split('@')[0] || 'Staff';
            let saveErrors = [];

            // 1. First save to staff_app_welcome (primary storage)
            try {
              const welcomeData = {
                user_id: user.id,
                site_id: siteId,
                full_name: user?.raw_user_meta_data?.full_name || user?.email?.split('@')[0] || 'Staff',
                nickname: nicknameValue,
                role_detail: role,
                team_id: teamIdNum,
                team_name: window.selectedTeamName || null,
                avatar_url: avatar
              };

              console.log('Saving to staff_app_welcome:', welcomeData);
              const { error: welcomeErr } = await supabase
                .from('staff_app_welcome')
                .upsert(welcomeData);

              if (welcomeErr) {
                console.error('staff_app_welcome save error:', welcomeErr);
                // Don't treat RLS errors as fatal
                if (!welcomeErr.message?.includes('violates row-level security')) {
                  saveErrors.push('welcome');
                }
              } else {
                console.log('Successfully saved to staff_app_welcome');
              }
            } catch (e) {
              console.error('Exception saving to staff_app_welcome:', e);
              // Don't treat welcome errors as fatal
            }

            // 2. Save/update profiles table (for compatibility)
            try {
              const profileData = {
                user_id: user.id,
                site_id: siteId,
                full_name: user?.raw_user_meta_data?.full_name || user?.email?.split('@')[0] || 'Staff',
                nickname: nicknameValue,
                role: (role || 'staff').toLowerCase(),  // Ensure valid role for constraint (lowercase)
                avatar_url: avatar,
                onboarding_complete: true
              };

              console.log('Saving to profiles:', profileData);
              const { error: profileErr } = await supabase
                .from('profiles')
                .upsert(profileData);

              if (profileErr) {
                console.error('profiles save error:', profileErr);
                // Don't treat RLS errors as fatal
                if (!profileErr.message?.includes('violates row-level security')) {
                  saveErrors.push('profile');
                }
              } else {
                console.log('Successfully saved to profiles');
              }
            } catch (e) {
              console.error('Exception saving to profiles:', e);
              // Don't treat profiles errors as fatal
            }

            // 3. Update auth user metadata (always succeeds)
            try {
              const metaData = {
                role: role,
                role_detail: role,
                avatar_url: avatar,
                site_id: siteId,
                team_id: teamIdNum,
                team_name: window.selectedTeamName || null,
                nickname: nicknameValue,
                full_name: user?.raw_user_meta_data?.full_name || user?.email?.split('@')[0] || 'Staff'
              };

              console.log('Updating auth metadata:', metaData);
              const { error: authErr } = await supabase.auth.updateUser({ data: metaData });

              if (authErr) {
                console.error('Auth metadata update error:', authErr);
              } else {
                console.log('Successfully updated auth metadata');
              }
            } catch(e) {
              console.error('Exception updating auth metadata:', e);
            }

            // Show appropriate message based on save results
            if (fm) {
              if (saveErrors.length === 0) {
                fm.textContent = 'Saved! Moving to working hours setup‚Ä¶';
              } else {
                // Even with errors, we saved to auth metadata so core data is preserved
                fm.textContent = 'Moving to working hours setup‚Ä¶';
              }
            }

            // Navigate to working hours step
            try {
              const step3 = document.getElementById('welcome-step3');
              const step4 = document.getElementById('step4');

              if (!step3) {
                console.error('welcome-step3 element not found!');
                if (fm) fm.textContent = 'Error: Cannot find avatar step element';
                return;
              }

              if (!step4) {
                console.error('step4 element not found!');
                if (fm) fm.textContent = 'Error: Cannot find working hours step element';
                return;
              }

              console.log('Hiding step3 and showing step4...');
              step3.style.display = 'none';
              step4.style.display = 'block'; // Use 'block' instead of empty string for clarity

              console.log('Rendering working pattern...');
              // Ensure the function exists and call it
              renderWorkingPattern();

              // Ensure working hours handlers are set up
              if (window.setupWorkingHoursHandlers) {
                console.log('Setting up working hours handlers...');
                window.setupWorkingHoursHandlers(user, siteId);
              } else {
                console.warn('setupWorkingHoursHandlers not found');
              }

              // Scroll to top to ensure visibility
              window.scrollTo(0, 0);

              console.log('Successfully navigated to working hours step');

            } catch (navError) {
              console.error('Navigation error:', navError);
              if (fm) fm.textContent = 'Error navigating to working hours: ' + navError.message;
            }
          }); finish.dataset.bound='1'; }

          // Initial render
          updateAvatarPreview();
        }

        // Advanced Particle Explosion System
        window.createParticleExplosion = function createParticleExplosion(centerX, centerY, intensity = 1) {
          const conf = document.getElementById('confetti-container') || document.getElementById('confetti');
          if (!conf) return;

          const colors = [
            '#3b82f6', '#8b5cf6', '#06d6a0', '#f72585', '#ffb703',
            '#fb8500', '#219ebc', '#023047', '#e63946', '#2a9d8f'
          ];

          const particleTypes = ['explosion', 'sparkle', 'burst', 'glow', 'ring'];
          const numParticles = Math.floor(40 * intensity);

          for (let i = 0; i < numParticles; i++) {
            const type = particleTypes[Math.floor(Math.random() * particleTypes.length)];
            const particle = document.createElement('div');
            particle.className = `particle ${type}-particle`;

            // Random direction and distance
            const angle = (Math.PI * 2 * i) / numParticles + (Math.random() - 0.5) * 0.8;
            const distance = 80 + Math.random() * 200 * intensity;
            const dx = Math.cos(angle) * distance;
            const dy = Math.sin(angle) * distance;
            const rotation = Math.random() * 720 - 360;

            // Position at explosion center
            particle.style.left = centerX + 'px';
            particle.style.top = centerY + 'px';
            particle.style.background = colors[Math.floor(Math.random() * colors.length)];
            particle.style.setProperty('--dx', dx + 'px');
            particle.style.setProperty('--dy', dy + 'px');
            particle.style.setProperty('--rotation', rotation + 'deg');
            particle.style.setProperty('--start-rotation', Math.random() * 360 + 'deg');
            particle.style.animationDelay = Math.random() * 0.3 + 's';

            // Special properties for different types
            if (type === 'ring') {
              particle.style.borderColor = colors[Math.floor(Math.random() * colors.length)];
            }

            conf.appendChild(particle);

            // Clean up
            setTimeout(() => {
              if (particle.parentNode) particle.remove();
            }, 3000);
          }
        }

        window.createTextBurstEffect = function createTextBurstEffect() {
          const banner = document.querySelector('.complete-banner');
          if (!banner) return;

          const rect = banner.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;

          // Create multiple explosion points around the banner
          const explosionPoints = [
            { x: centerX - 100, y: centerY, intensity: 0.8 },
            { x: centerX + 100, y: centerY, intensity: 0.8 },
            { x: centerX, y: centerY - 50, intensity: 1.2 },
            { x: centerX - 50, y: centerY + 30, intensity: 0.6 },
            { x: centerX + 50, y: centerY + 30, intensity: 0.6 }
          ];

          explosionPoints.forEach((point, index) => {
            setTimeout(() => {
              createParticleExplosion(point.x, point.y, point.intensity);
            }, index * 150);
          });
        }

        window.burstConfetti = function burstConfetti() {
          // Create explosion at random points
          const conf = document.getElementById('confetti-container') || document.getElementById('confetti');
          if (!conf) return;

          const containerRect = conf.getBoundingClientRect();
          const explosions = [
            { x: containerRect.width * 0.2, y: containerRect.height * 0.3, intensity: 1.0 },
            { x: containerRect.width * 0.8, y: containerRect.height * 0.3, intensity: 1.0 },
            { x: containerRect.width * 0.5, y: containerRect.height * 0.6, intensity: 1.3 }
          ];

          explosions.forEach((explosion, index) => {
            setTimeout(() => {
              createParticleExplosion(explosion.x, explosion.y, explosion.intensity);
            }, index * 200);
          });
        }

        window.showBalloons = function showBalloons(){
          const container = document.getElementById('step5');
          if (!container) return;

          const balloonEmojis = ['üéà', 'üéà', 'üéà', 'üéä', 'üéâ'];
          for (let i = 0; i < 8; i++) {
            const balloon = document.createElement('div');
            balloon.style.position = 'absolute';
            balloon.style.fontSize = '40px';
            balloon.style.left = (10 + Math.random() * 80) + '%';
            balloon.style.bottom = '-60px';
            balloon.style.zIndex = '5';
            balloon.textContent = balloonEmojis[Math.floor(Math.random() * balloonEmojis.length)];
            balloon.style.animation = `floatUp ${3 + Math.random() * 2}s ease-out forwards`;
            balloon.style.animationDelay = Math.random() * 0.5 + 's';
            container.appendChild(balloon);
            setTimeout(() => balloon.remove(), 5000);
          }
        }

        async function saveNickname(){
          const input = document.getElementById('nickname');
          const msg = document.getElementById('save-msg');
          msg.textContent = '';
          const val = String(input.value || '').trim();
          if (!val) { msg.textContent = 'Please enter a name to continue.'; return; }

          // First, try to save to master_users table
          try {
            // Get the original access_type from user metadata (set during invitation)
            const originalAccessType = user?.user_metadata?.role ||
                                     user?.raw_user_meta_data?.role ||
                                     user?.app_metadata?.role ||
                                     'staff';

            // Get the original full_name from invitation data
            const originalFullName = user?.user_metadata?.full_name ||
                                   user?.raw_user_meta_data?.full_name ||
                                   fullName || user?.email?.split('@')[0] || 'Staff';

            const masterData = {
              auth_user_id: user.id,
              email: user.email,
              nickname: val,
              full_name: originalFullName,  // Use original full_name from invitation
              site_id: siteId,
              access_type: originalAccessType,  // Preserve original access_type from invitation
              updated_at: new Date().toISOString()
            };

            const { error: masterError } = await supabase
              .from('master_users')
              .upsert(masterData, {
                onConflict: 'auth_user_id',
                ignoreDuplicates: false
              });

            if (!masterError) {
              msg.textContent = 'Saved!';
              // Move to step 2
              document.getElementById('welcome-step1').style.display = 'none';
              document.getElementById('welcome-step2').style.display = '';
              await loadDetailsData(siteId, fullName);
              return;
            } else {
              console.error('Master users save failed:', masterError);
              msg.textContent = `Error saving nickname: ${masterError.message || 'Please try again.'}`;
              return;
            }
          } catch(e) {
            console.error('Master users save failed:', e);
            msg.textContent = 'Error saving nickname. Please try again or contact support.';
            return;
          }
        }

        const saveBtn = document.getElementById('save-btn');
        if (saveBtn) {
          saveBtn.addEventListener('click', (e)=>{ e.preventDefault(); saveNickname(); });
        } else {
          console.warn('[staff-welcome] save-btn not found');
        }

        // ---- Step 2 helpers ----

        const ROLE_ICON = (name) => ({
          // Using Icons8 Cute Color style (48px). Slugs chosen as reasonable defaults.
          'Doctor': 'https://img.icons8.com/cute-color/48/stethoscope.png',
          'Nurse': 'https://img.icons8.com/cute-color/48/nurse.png',
          'Pharmacist': 'https://img.icons8.com/cute-color/48/pill.png',
          'Reception': 'https://img.icons8.com/cute-color/48/customer-support.png',
          'Manager': 'https://img.icons8.com/cute-color/48/briefcase.png'
        })[name] || 'https://img.icons8.com/cute-color/48/user-male.png';

        // Local fallback icons (in case external hosting is blocked)
        const ROLE_ICON_FALLBACK = (name) => ({
          'Doctor': 'Icons/icons8-stethoscope-100.png',
          'Nurse': 'Icons/icons8-nurse-100.png',
          'Pharmacist': 'Icons/icons8-pharmacist-100.png',
          'Reception': 'Icons/icons8-group-100.png',
          'Manager': 'Icons/icons8-doctors-bag-100.png'
        })[name] || 'Icons/icons8-profile-100.png';

        async function loadDetailsData(siteId, fullName){
          // Load existing welcome data (if any)
          let existing = null;

          // Check if we have pre-configured data from admin setup
          if (window.preConfiguredData && window.preConfiguredData.welcome) {
            existing = window.preConfiguredData.welcome;
            console.log('Using pre-configured welcome data:', existing);
          } else {
            // Load from database
            try {
              let q = supabase
                .from('staff_app_welcome')
                .select('full_name, nickname, role_detail, team_id, team_name, avatar_url')
                .eq('user_id', user.id)
                .limit(1);
              if (siteId) q = q.eq('site_id', siteId);
              const { data: sawRow, error: sawErr } = await q.maybeSingle();
              if (!sawErr && sawRow) existing = sawRow;
            } catch (_) {}
          }

          // Pre-fill nickname if present
          if (existing) {
            const nn = document.getElementById('nickname');
            if (nn && !nn.value) nn.value = existing.nickname || existing.full_name || nn.value;
            if (existing.avatar_url) {
              window.existingAvatarUrl = existing.avatar_url;
              window.currentSavedAvatarUrl = existing.avatar_url;
              // Pre-populate avatar preview if exists
              const avatarPreview = document.getElementById('avatarPreview');
              if (avatarPreview) avatarPreview.src = existing.avatar_url;
            }

            // Pre-select role and team if configured
            if (existing.role_detail) {
              window.selectedRole = existing.role_detail;
            }
            if (existing.team_id) {
              window.selectedTeamId = existing.team_id;
              window.selectedTeamName = existing.team_name;
            }
          }

          // Use pre-configured values from invitation if not already set
          if (!window.selectedRole && window.preConfiguredRole) {
            window.selectedRole = window.preConfiguredRole;
          }
          if (!window.selectedTeamId && window.preConfiguredTeamId) {
            window.selectedTeamId = window.preConfiguredTeamId;
          }

          // Build Roles list (value/label pairs) and prefer canonical admin order
          const canonicalRoles = [
            { value: 'GP', label: 'GP (Doctor)' },
            { value: 'Nurse', label: 'Nurse' },
            { value: 'Practice Manager', label: 'Practice Manager' },
            { value: 'Admin Assistant', label: 'Admin Assistant' },
            { value: 'Receptionist', label: 'Receptionist' },
            { value: 'Healthcare Assistant', label: 'Healthcare Assistant' },
            { value: 'Pharmacist', label: 'Pharmacist' },
            { value: 'Other', label: 'Other' }
          ];

          let roles = [];
          try {
            const { data, error } = await supabase.from('kiosk_roles').select('role');
            if (!error && Array.isArray(data) && data.length) {
              // Map DB roles to value/label pairs, preserving order from canonical when possible
              const dbRoles = data.map(r => String(r.role));
              const added = new Set();
              // First add canonical roles that exist in DB (or always keep canonical order)
              canonicalRoles.forEach(cr => {
                if (dbRoles.includes(cr.value) || dbRoles.includes(cr.label) || true) {
                  roles.push({ value: cr.value, label: cr.label });
                  added.add(cr.value);
                }
              });
              // Then append any DB-only roles not already present
              dbRoles.forEach(r => {
                const v = String(r);
                if (!added.has(v)) {
                  roles.push({ value: v, label: v });
                  added.add(v);
                }
              });
            }
          } catch(_) {}

          if (!roles.length) roles = canonicalRoles.slice();

          // Ensure existing role appears in list (handle raw saved values)
          if (existing && existing.role_detail) {
            const exists = roles.some(rr => rr.value === existing.role_detail || rr.label === existing.role_detail);
            if (!exists) roles = [{ value: existing.role_detail, label: existing.role_detail }, ...roles];
          }

          const rg = document.getElementById('role-grid');
          // expose helper to set fallback src when onerror fires
          window.__roleIconFallback = function(el, role){
            try{ el.onerror = null; el.src = ROLE_ICON_FALLBACK(role); }catch(e){}
          };
          rg.innerHTML = roles.map((r,i)=>{
            // Determine a pre-selected value from existing data or preconfigured invite
            const pre = window.selectedRole || window.preConfiguredRole || (existing && existing.role_detail) || null;
            const checked = pre ? (pre === r.value || pre === r.label) : (i===0);
            const val = esc(String(r.value || r.label));
            const lbl = esc(String(r.label || r.value));
            return `<label class=\"option-pill white-pill\">\n              <input type=\"radio\" name=\"role\" value=\"${val}\" ${checked?'checked':''} />\n              <img src=\"${ROLE_ICON(lbl)}\" alt=\"${lbl}\" style=\"width:32px;height:32px;object-fit:contain;\" onerror=\"window.__roleIconFallback(this,'${lbl}')\"/\>\n              <span>${lbl}</span>\n            </label>`;
          }).join('');

          // Load teams by site (button grid like roles)
          const tg = document.getElementById('team-grid');
          tg.innerHTML = '<div style="opacity:.7; padding:8px 0;">Loading teams‚Ä¶</div>';
          try{
            let teams = [];
            // Try to load teams from database, but use fallback if there's any error
            if (siteId){
              try {
                const { data, error } = await supabase.from('teams').select('id,name').eq('site_id', siteId);
                if (error) {
                  console.warn('teams load error (using fallback)', error);
                  teams = [];
                } else {
                  teams = (data||[]);
                }
              } catch (e) {
                console.warn('teams query exception (using fallback)', e);
                teams = [];
              }
            }

            // Always provide fallback teams if none loaded (match admin-dashboard defaults)
            if (!teams.length) {
              teams = [
                { id: 1, name: 'Clinical Team' },
                { id: 2, name: 'Admin Team' },
                { id: 3, name: 'Reception' },
                { id: 4, name: 'Management' }
              ];
            }

            if (siteId) {
              const html = teams.map((t) => {
                const isExisting = existing && ((existing.team_id && String(existing.team_id) === String(t.id)) || (existing.team_name && existing.team_name === t.name));
                return `<label class=\"option-pill white-pill\">\n                  <input type=\"radio\" name=\"team\" value=\"${String(t.id)}\" data-name=\"${t.name}\" ${isExisting ? 'checked' : ''} />\n                  <img src=\"Icons/icons8-people-100.png\" alt=\"${t.name}\" style=\"width:32px;height:32px;object-fit:contain;\"/>\n                  <span>${t.name}</span>\n                </label>`;
              }).join('');
              tg.innerHTML = html || '<div style="opacity:.7; padding:8px 0;">No teams found for this site.</div>';

              // Bind and initialize selection globals
              const onTeamChange = () => {
                const checked = document.querySelector('input[name="team"]:checked');
                if (checked) {
                  window.selectedTeamId = checked.value && /^\\d+$/.test(String(checked.value)) ? parseInt(checked.value, 10) : null;
                  window.selectedTeamName = checked.dataset.name || null;
                } else {
                  window.selectedTeamId = null;
                  window.selectedTeamName = null;
                }
              };
              tg.querySelectorAll('input[name="team"]').forEach(el => el.addEventListener('change', onTeamChange));
              onTeamChange();
            } else {
              tg.innerHTML = '<div style="opacity:.7; padding:8px 0;">No site set</div>';
            }
          }catch(_){ tg.innerHTML = '<div style="opacity:.7; padding:8px 0;">Could not load teams</div>'; }

          // Persist selections helper
          async function persistRoleTeam(role, teamIdNum, teamName, avatarUrl){
            const msgEl = document.getElementById('finish-msg');
            try {
              // 1) Try upsert into new source-of-truth table if it exists
              try {
                const nicknameVal = String(document.getElementById('nickname')?.value || '').trim() || null;
                if (!siteId) {
                  if (msgEl) msgEl.textContent = 'No site detected ‚Äî saving to profiles only.';
                  throw new Error('NO_SITE_ID');
                }
                const payload = {
                  user_id: user.id,
                  site_id: siteId,
                  full_name: fullName,
                  nickname: nicknameVal,
                  role_detail: role || null,
                  team_id: teamIdNum ?? null,
                  team_name: teamName || null,
                  avatar_url: avatarUrl ?? null
                };
                const { error: sawErr } = await supabase
                  .from('staff_app_welcome')
                  .upsert(payload);
                if (sawErr) {
                  if (msgEl) msgEl.textContent = `Could not save to Staff_App_Welcome (${sawErr.code||''}). Falling back‚Ä¶`;
                  throw sawErr;
                }
              } catch (e) {
                // If table doesn't exist or RLS blocks, continue to profiles fallback
                if (msgEl) msgEl.textContent = 'Saving to profiles‚Ä¶';
              }

              // 2) profiles table is no longer used - master_users is the primary source
              // Commenting out profiles update to prevent confusion
              /*
              try {
                const profileData = {
                  user_id: user.id,
                  full_name: fullName,
                  nickname: String(document.getElementById('nickname')?.value || '').trim() || null,
                  role: (role || 'staff').toLowerCase(),
                  onboarding_complete: true
                };
                if (siteId) profileData.site_id = siteId;
                const { error: pErr } = await supabase.from('profiles').upsert(profileData);
                if (pErr) { console.warn('[welcome] profiles upsert failed', pErr); }
              } catch (e2) {
                console.warn('[welcome] profiles upsert exception', e2);
              }
              */
              if (msgEl) msgEl.textContent = 'Saved!';
            } catch (e) {
              console.warn('[welcome] persist selections failed', e);
              if (msgEl) msgEl.textContent = 'Could not save selections (continuing)‚Ä¶';
            }
          }

          // Continue to Step 3 (Avatar Builder)
          const toAvatar = document.getElementById('to-avatar-btn');
          if (toAvatar && !toAvatar.dataset.bound){
            toAvatar.addEventListener('click', async () => {
              const role = (document.querySelector('input[name="role"]:checked')?.value || '').trim();
              const teamRadio = document.querySelector('input[name="team"]:checked');
              const teamVal = teamRadio?.value || '';
              const teamName = teamRadio?.dataset.name || null;

              window.selectedRole = role || null;
              window.selectedTeamId = teamVal && /^\d+$/.test(String(teamVal)) ? parseInt(teamVal, 10) : null;
              window.selectedTeamName = teamName || null;

              // Persist immediately so selections are saved even if user leaves before finishing
              const btn = toAvatar;
              const msgEl = document.getElementById('finish-msg');
              if (msgEl) msgEl.textContent = '';
              btn.disabled = true;
              try {
                await persistRoleTeam(window.selectedRole, window.selectedTeamId, window.selectedTeamName);
              } finally {
                btn.disabled = false;
              }

              document.getElementById('welcome-step2').style.display = 'none';
              document.getElementById('welcome-step3').style.display = '';
              await initAvatarBuilder(fullName);

              // Wire up group toggles (allow collapse/expand)
              try {
                document.querySelectorAll('.group-toggle').forEach(btn => {
                  const target = document.querySelector(btn.dataset.target);
                  if (!target) return;
                  btn.addEventListener('click', () => {
                    const collapsed = target.classList.toggle('collapsed');
                    btn.textContent = collapsed ? 'Show' : 'Hide';
                  });
                });
              } catch (e) { /* non-critical */ }

              // If we have an existing saved avatar, apply it to preview and controls
              try {
                if (window.existingAvatarUrl) {
                  const url = String(window.existingAvatarUrl);
                  window.currentAvatarUrl = url;
                  window.currentSavedAvatarUrl = url;
                  const img = document.getElementById('avatarPreview');
                  if (img) img.src = url;

                  // Parse parameters from DiceBear URL and apply to controls
                  const u = new URL(url);
                  const p = u.searchParams;
                  const map = new Map([
                    ['backgroundType','opt-backgroundType'],
                    ['backgroundColor','opt-backgroundColor'],
                    ['backgroundRotation','opt-backgroundRotation'],
                    ['radius','opt-radius'],
                    ['rotate','opt-rotate'],
                    ['scale','opt-scale'],
                    ['flip','opt-flip'],
                    ['clip','opt-clip'],
                    ['translateX','opt-translateX'],
                    ['translateY','opt-translateY'],
                    ['eyes','opt-eyes'],
                    ['mouth','opt-mouth'],
                    ['eyebrows','opt-eyebrows'],
                    ['glasses','opt-glasses'],
                    ['glassesProbability','opt-glassesProbability'],
                    ['earrings','opt-earrings'],
                    ['earringsProbability','opt-earringsProbability'],
                    ['featuresProbability','opt-featuresProbability'],
                    ['hair','opt-hair'],
                    ['hairColor','opt-hairColor'],
                    ['hairProbability','opt-hairProbability'],
                    ['skinColor','opt-skinColor'],
                  ]);
                  for (const [k,id] of map.entries()){
                    const v = p.get(k);
                    if (v != null && v !== ''){
                      const el = document.getElementById(id);
                      if (el) el.value = v;
                    }
                  }
                  // Handle features (multi)
                  const feats = p.getAll('features');
                  if (feats && feats.length){
                    const fEl = document.getElementById('opt-features');
                    if (fEl){
                      for (const o of Array.from(fEl.options)) o.selected = feats.includes(o.value);
                    }
                  }
                  // Seed
                  const seed = p.get('seed');
                  if (seed) { window.aiSeed = seed; }

                  updateAvatarPreview();
                  // Hide Save button since this avatar is already saved
                  const saveBtn = document.getElementById('avatar-save');
                  if (saveBtn) saveBtn.style.display = 'none';
                }
              } catch (e) { console.info('avatar prefill failed', e); }
            });
            toAvatar.dataset.bound = '1';
          }
        }
      } catch(e){
        if (String(e.message).includes('NO_SESSION')) { window.location.replace('home.html'); return; }
        if (String(e.message).includes('NOT_STAFF')) { window.location.replace('home.html'); return; }
        console.error('[staff-welcome] error', e);
      }
    })();
    
    // Icon service functions
    function i8(name, opts = {}) {
      var base  = 'https://img.icons8.com';
      var style = opts.style || 'cute-color';
      var size  = opts.size  || 48;
      // Icons8 OMG-IMG pattern is style/size/name.png
      var path  = [style, String(size), encodeURIComponent(name) + '.png'].join('/');
      return base + '/' + path;
    }
    
    function setIcon(el){
      var name  = el.getAttribute('data-i8');
      var size  = el.getAttribute('data-i8-size');
      var style = el.getAttribute('data-i8-style') || 'fluency';
      var fallback = (el.getAttribute('data-i8-fallback') || '').toLowerCase();
      
      if (fallback === 'auto') {
        var stylesToTry = [style, 'fluency', 'color'];
        var idx = 0;
        function tryNext(){
          if (idx >= stylesToTry.length) { el.onerror = null; return; }
          var url = i8(name, {style: stylesToTry[idx++], size: size ? parseInt(size,10) : undefined});
          if (el.src !== url) el.src = url; else tryNext();
        }
        el.onerror = tryNext;
        tryNext();
      } else {
        el.src = i8(name, {style: style, size: size ? parseInt(size,10) : undefined});
      }
    }
    
    function wireIcons(){
      document.querySelectorAll('img[data-i8]').forEach(setIcon);
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', wireIcons);
    } else {
      wireIcons();
    }
    
    // Working Hours Functions - make it global so it can be called from other places
    window.renderWorkingPattern = async function renderWorkingPattern() {
      const container = document.getElementById('working-form');
      if (!container) return;

      container.innerHTML = '';
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const isGP = (window.selectedRole || '').toLowerCase().includes('doctor') ||
                   (window.selectedRole || '').toLowerCase().includes('gp');

      // Try to load existing working pattern from database or use pre-configured data
      let existingPattern = null;
      const currentUser = window.currentUser;
      const currentSiteId = window.currentSiteId || 1;

      // First check for pre-configured working pattern from invitation
      if (window.preConfiguredWorkingPattern) {
        console.log('Using pre-configured working pattern from invitation');
        existingPattern = window.preConfiguredWorkingPattern;
      } else if (currentUser && globalSupabase) {
        try {
          console.log('Loading existing working pattern for user:', currentUser.id);
          const { data, error } = await globalSupabase
            .from('3_staff_working_patterns')
            .select('*')
            .eq('user_id', currentUser.id)
            .maybeSingle();

          if (data) {
            existingPattern = data;
            console.log('Found existing working pattern:', existingPattern);
          } else if (error) {
            console.warn('Error loading working pattern:', error);
          } else {
            console.log('No existing working pattern found');
          }
        } catch (e) {
          console.warn('Failed to load working pattern:', e);
        }
      }

      container.insertAdjacentHTML('beforeend',
        `<div class="tiny-note" style="color:#6b7280; font-size:12px; margin-bottom:10px;">${isGP ?
          'Enter number of sessions (0-2) per day.' :
          'Select hours and minutes per day ‚Äî defaults Mon-Fri 7:30.'}</div>`
      );

      days.forEach((day, i) => {
        const id = day.toLowerCase();
        let defaultHours = 0;
        let defaultMinutes = 0;
        let defaultSessionVal = '0';

        if (existingPattern) {
          // Use saved values if they exist
          if (isGP) {
            defaultSessionVal = String(existingPattern[`${id}_sessions`] || '0');
          } else {
            const hours = parseFloat(existingPattern[`${id}_hours`] || 0);
            if (hours > 0) {
              defaultHours = Math.floor(hours);
              defaultMinutes = Math.round((hours - defaultHours) * 60);
              // Round minutes to nearest 15-minute increment
              defaultMinutes = Math.round(defaultMinutes / 15) * 15;
              if (defaultMinutes >= 60) {
                defaultHours += Math.floor(defaultMinutes / 60);
                defaultMinutes = defaultMinutes % 60;
              }
            }
          }
        } else {
          // Use defaults for new users
          if (isGP) {
            defaultSessionVal = i < 5 ? '2' : '0';
          } else {
            defaultHours = i < 5 ? 7 : 0;
            defaultMinutes = i < 5 ? 30 : 0;
          }
        }

        container.insertAdjacentHTML('beforeend',
          `<div class="working-hour-card" style="display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#fff; border:1px solid rgba(15,23,42,0.06); border-radius:14px;">
            <label for="${id}-hours" style="font-weight:600; font-size:13px; color:#334155;">${day}</label>
            ${isGP ?
              `<div style="display:flex; align-items:center; gap:8px;">
                <select id="${id}-val" style="padding:6px 10px; border:1px solid rgba(15,23,42,0.12); border-radius:8px;">
                  <option value="0" ${defaultSessionVal === '0' ? 'selected' : ''}>0</option>
                  <option value="1" ${defaultSessionVal === '1' ? 'selected' : ''}>1</option>
                  <option value="2" ${defaultSessionVal === '2' ? 'selected' : ''}>2</option>
                </select>
                <span class="tiny-note" style="color:#6b7280; font-size:11px;">sessions</span>
              </div>` :
              `<div style="display:flex; align-items:center; gap:6px;">
                <select id="${id}-hours" style="padding:6px 10px; border:1px solid rgba(15,23,42,0.12); border-radius:8px;">
                  ${Array.from({length: 13}, (_, i) => `<option value="${i}" ${i === defaultHours ? 'selected' : ''}>${i}</option>`).join('')}
                </select>
                <span style="color:#334155; font-weight:500;">h</span>
                <select id="${id}-minutes" style="padding:6px 10px; border:1px solid rgba(15,23,42,0.12); border-radius:8px;">
                  <option value="0" ${defaultMinutes === 0 ? 'selected' : ''}>00</option>
                  <option value="15" ${defaultMinutes === 15 ? 'selected' : ''}>15</option>
                  <option value="30" ${defaultMinutes === 30 ? 'selected' : ''}>30</option>
                  <option value="45" ${defaultMinutes === 45 ? 'selected' : ''}>45</option>
                </select>
                <span style="color:#334155; font-weight:500;">m</span>
              </div>`
            }
          </div>`
        );
      });
    }

    // Working Hours Navigation - moved inside the main async function
    window.setupWorkingHoursHandlers = function(userData, siteIdParam) {
      // Use passed parameters or try to get from global scope
      const user = userData || window.currentUser;
      const siteId = siteIdParam || window.currentSiteId || 1;
      document.getElementById('working-back')?.addEventListener('click', () => {
        document.getElementById('step4').style.display = 'none';
        document.getElementById('welcome-step3').style.display = '';
      });
      
      // Complete Setup Handler
      document.getElementById('complete-setup')?.addEventListener('click', async () => {
        const msg = document.getElementById('working-msg');
        if (msg) msg.textContent = 'Saving your working hours...';

        console.log('Complete Setup clicked - saving working hours...');

        // Use the user and siteId from parameters or global
        const currentUser = user || window.currentUser;
        const currentSiteId = siteId || window.currentSiteId || 1;

        // Quick check if we have what we need
        if (!currentUser) {
          console.error('User not defined!');
          if (msg) msg.textContent = 'Error: User not found';
          return;
        }

        if (!globalSupabase) {
          console.error('Supabase not defined!');
          if (msg) msg.textContent = 'Error: Database connection not found';
          return;
        }
        
        const isGP = (window.selectedRole || '').toLowerCase().includes('doctor') || 
                     (window.selectedRole || '').toLowerCase().includes('gp');
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        
        const patternData = {
          user_id: currentUser.id,
          site_id: currentSiteId,
          updated_at: new Date().toISOString()
        };
        
        let totalHours = 0;
        let totalSessions = 0;
        
        for (const day of days) {
          if (isGP) {
            const inputEl = document.getElementById(`${day}-val`);
            if (!inputEl) {
              console.warn(`Input element for ${day} not found`);
              patternData[`${day}_sessions`] = 0;
              patternData[`${day}_hours`] = null;
              continue;
            }

            const sessions = parseInt(inputEl.value || '0');
            patternData[`${day}_sessions`] = sessions;
            patternData[`${day}_hours`] = null;  // NULL for GP staff
            totalSessions += sessions;
            console.log(`${day}: ${sessions} sessions`);
          } else {
            // Handle dropdown structure for non-GP staff
            const hoursEl = document.getElementById(`${day}-hours`);
            const minutesEl = document.getElementById(`${day}-minutes`);
            
            if (!hoursEl || !minutesEl) {
              console.warn(`Dropdown elements for ${day} not found`);
              patternData[`${day}_hours`] = null;
              patternData[`${day}_sessions`] = 0;
              continue;
            }

            const hours = parseInt(hoursEl.value || '0');
            const minutes = parseInt(minutesEl.value || '0');
            
            // Convert to HH:MM format for storage
            const timeValue = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            
            patternData[`${day}_hours`] = (hours === 0 && minutes === 0) ? null : timeValue;
            patternData[`${day}_sessions`] = 0;

            // Calculate total hours (decimal format for calculations)
            const decimal = hours + (minutes / 60);
            totalHours += decimal;
            console.log(`${day}: ${hours}h ${minutes}m = ${timeValue} (decimal: ${decimal})`);
          }
        }
        
        // Add totals to pattern data
        patternData.total_hours = totalHours;
        patternData.total_sessions = totalSessions;

        console.log('Pattern data to save:', patternData);
        console.log('Is GP?:', isGP, 'Total Sessions:', totalSessions, 'Total Hours:', totalHours);
        
        try {
          // Save working pattern
          const { data: savedPattern, error: patternError } = await globalSupabase
            .from('3_staff_working_patterns')
            .upsert(patternData, {
              onConflict: 'user_id',
              ignoreDuplicates: false
            })
            .select();

          if (patternError) {
            console.error('Error saving working pattern:', patternError);
            throw patternError;
          }

          console.log('Working pattern saved:', savedPattern);

          // Also save working hours summary to staff_app_welcome
          try {
            const workingHoursData = {
              monday: isGP ? patternData.monday_sessions : (patternData.monday_hours || '00:00'),
              tuesday: isGP ? patternData.tuesday_sessions : (patternData.tuesday_hours || '00:00'),
              wednesday: isGP ? patternData.wednesday_sessions : (patternData.wednesday_hours || '00:00'),
              thursday: isGP ? patternData.thursday_sessions : (patternData.thursday_hours || '00:00'),
              friday: isGP ? patternData.friday_sessions : (patternData.friday_hours || '00:00'),
              saturday: isGP ? patternData.saturday_sessions : (patternData.saturday_hours || '00:00'),
              sunday: isGP ? patternData.sunday_sessions : (patternData.sunday_hours || '00:00'),
              isGP: isGP
            };

            await globalSupabase.from('staff_app_welcome').upsert({
              user_id: currentUser.id,
              site_id: currentSiteId,
              working_hours: workingHoursData,
              updated_at: new Date().toISOString()
            });

            // Note: profiles table doesn't have working_hours column
            // Working hours are stored in staff_app_welcome and 3_staff_working_patterns tables
          } catch (e) {
            console.warn('Failed to save working hours to welcome/profiles:', e);
          }
          
          // Create/Update holiday profile and entitlements
          try {
            const displayName = document.getElementById('nickname')?.value?.trim() ||
                              currentUser?.raw_user_meta_data?.full_name ||
                              currentUser?.email?.split('@')[0] || 'Staff';

            // Get current avatar URL
            const avatarUrl = window.currentSavedAvatarUrl ||
                            document.getElementById('avatarPreview')?.src ||
                            currentUser?.raw_user_meta_data?.avatar_url || null;

            const holidayProfile = {
              full_name: displayName,
              role: window.selectedRole || 'Staff',
              is_gp: isGP,
              email: currentUser.email,
              team_name: window.selectedTeamName || null,
              avatar_url: avatarUrl,
              site_id: currentSiteId,
              user_id: currentUser.id,
              updated_at: new Date().toISOString()
            };

            // Upsert to 1_staff_holiday_profiles
            const { data: profileData, error: profileError } = await globalSupabase
              .from('1_staff_holiday_profiles')
              .upsert(holidayProfile, {
                onConflict: 'email',
                ignoreDuplicates: false
              })
              .select();

            if (profileError) {
              console.error('Holiday profile error:', profileError);
            }

            if (profileData && profileData[0]?.id) {
              const profileId = profileData[0].id;
              const currentYear = new Date().getFullYear();

              // Use the already calculated totals
              const weeklyHours = isGP ? null : totalHours;
              const weeklySessions = isGP ? totalSessions : null;

              // Check for existing entitlement to preserve override
              const { data: existingEntitlement } = await globalSupabase
                .from('2_staff_entitlements')
                .select('override, multiplier')
                .eq('staff_id', profileId)
                .eq('year', currentYear)
                .maybeSingle();

              // Use existing multiplier or default
              let multiplier = existingEntitlement?.multiplier;
              if (!multiplier || isNaN(multiplier)) {
                // Try to read from localStorage (set by admin-dashboard)
                const saved = localStorage.getItem('default-holiday-multiplier');
                multiplier = saved && !isNaN(saved) ? parseFloat(saved) : 6;
              }

              const entitlement = {
                staff_id: profileId,
                year: currentYear,
                weekly_hours: isGP ? null : totalHours,
                weekly_sessions: isGP ? totalSessions : null,
                multiplier: multiplier,
                override: existingEntitlement?.override || null,
                updated_at: new Date().toISOString()
              };

              console.log('[staff-welcome] Creating entitlement - isGP:', isGP, 'totalSessions:', totalSessions, 'totalHours:', totalHours, 'entitlement:', entitlement);

              const { error: entitlementError } = await globalSupabase
                .from('2_staff_entitlements')
                .upsert(entitlement, {
                  onConflict: 'staff_id,year',
                  ignoreDuplicates: false
                });

              if (entitlementError) {
                console.error('Entitlement error:', entitlementError);
              }

              // Call the calculate_holiday_summary function to populate calculated fields
              try {
                const { error: calcError } = await globalSupabase.rpc('calculate_holiday_summary', {
                  p_profile_id: profileId,
                  p_target_year: currentYear
                });

                if (calcError) {
                  console.warn('Holiday calculation warning:', calcError);
                } else {
                  console.log('[staff-welcome] Holiday summary calculated successfully');
                }
              } catch (calcErr) {
                console.warn('Could not calculate holiday summary:', calcErr);
              }

              // Create/Update link in 5_staff_profile_user_links
              const linkData = {
                staff_profile_id: profileId,
                user_id: currentUser.id,
                site_id: currentSiteId,
                linked_at: new Date().toISOString()
              };

              await globalSupabase
                .from('5_staff_profile_user_links')
                .upsert(linkData, {
                  onConflict: 'staff_profile_id,user_id',
                  ignoreDuplicates: false
                });
            }
          } catch (e) {
            console.error('Holiday profile/entitlement setup failed:', e);
          }
          
          // Mark onboarding complete
          try {
            await globalSupabase.auth.updateUser({
              data: {
                welcome_completed_at: new Date().toISOString(),
                onboarding_required: false
              }
            });
            
            // First try master_users
            const { error: masterError } = await globalSupabase
              .from('master_users')
              .update({
                onboarding_complete: true,
                updated_at: new Date().toISOString()
              })
              .eq('auth_user_id', currentUser.id);

            if (masterError) {
              // Log error but don't fail the completion
              console.error('Failed to update master_users onboarding_complete:', masterError);
            }
          } catch (e) {
            console.warn('completion meta update failed', e);
          }

          // Unlock the Onboarding Completion achievement
          try {
            // Try to unlock with auth_user_id first (new system)
            const { error: authUserError } = await globalSupabase
              .from('user_achievements')
              .upsert({
                auth_user_id: currentUser.id,
                achievement_key: 'onboarding_completion',
                status: 'unlocked',
                progress_percent: 100,
                unlocked_at: new Date().toISOString()
              }, {
                onConflict: 'auth_user_id,achievement_key'
              });

            if (!authUserError) {
              console.log('‚úÖ Onboarding Completion achievement unlocked with auth_user_id!');
            } else {
              // Fall back to kiosk_user_id system if auth_user_id column doesn't exist
              const { data: profileData } = await globalSupabase
                .from('profiles')
                .select('kiosk_user_id')
                .eq('user_id', currentUser.id)
                .single();

              if (profileData && profileData.kiosk_user_id) {
                await globalSupabase
                  .from('user_achievements')
                  .upsert({
                    kiosk_user_id: profileData.kiosk_user_id,
                    achievement_key: 'onboarding_completion',
                    status: 'unlocked',
                    progress_percent: 100,
                    unlocked_at: new Date().toISOString()
                  }, {
                    onConflict: 'kiosk_user_id,achievement_key'
                  });
                console.log('‚úÖ Onboarding Completion achievement unlocked with kiosk_user_id!');
              } else {
                console.log('Could not unlock achievement - no kiosk_user_id');
              }
            }
          } catch (achievementError) {
            console.warn('Failed to unlock achievement:', achievementError);
            // Don't block onboarding completion if achievement fails
          }

          // Success - show completion step with animations
          console.log('Working hours saved successfully');
          if (msg) msg.textContent = 'Saved!';

          // Hide working hours step
          document.getElementById('step4').style.display = 'none';

          // Show completion step
          const step5 = document.getElementById('step5');
          if (step5) {
            step5.style.display = 'block';

            // Trigger spectacular particle show
            setTimeout(() => {
              createTextBurstEffect();
              showBalloons();
            }, 200);

            // Create cascading explosions
            setTimeout(() => burstConfetti(), 600);
            setTimeout(() => createTextBurstEffect(), 1200);
            setTimeout(() => burstConfetti(), 1800);
          }

          // Redirect to dashboard after delay
          setTimeout(() => {
            // Session already clean
            window.location.href = 'staff.html';
          }, 2000); // Quick celebration then move on
          
        } catch (e) {
          console.error('Error saving working hours:', e);

          // Even if saving fails, still show success and continue
          // (data is saved in auth metadata as fallback)
          console.log('Continuing despite save error...');

          // Show completion step anyway
          document.getElementById('step4').style.display = 'none';
          const step5 = document.getElementById('step5');
          if (step5) {
            step5.style.display = 'block';

            // Trigger celebrations
            setTimeout(() => {
              burstConfetti();
              showBalloons();
            }, 100);

            setTimeout(() => burstConfetti(), 500);
            setTimeout(() => burstConfetti(), 1000);
          }

          // Redirect after delay
          setTimeout(() => {
            // Session already clean
            window.location.href = 'staff.html';
          }, 2000);
        }
      });
    };
    
    // Call the setup function after everything is loaded
    if (window.setupWorkingHoursHandlers) {
      window.setupWorkingHoursHandlers(window.currentUser, window.currentSiteId);
    }
  </script>

    <!-- Debug Console - Persistent across all pages -->
    <script src="debug-console.js"></script>
</body>
</html>

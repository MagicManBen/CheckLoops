<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Welcome to CheckLoops — Staff Onboarding" />
  <meta name="theme-color" content="#0b4fb3" />
  <title>Welcome to CheckLoops</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://*.supabase.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' https://*.supabase.co https://*.supabase.com wss://*.supabase.co wss://*.supabase.com https:;">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="rls-fix.js"></script>
  <script src="supabase-js.js"></script>
  <script src="fix-navigation-style.js"></script>
  <script src="data-source-inspector.js"></script>
  <link rel="stylesheet" href="staff-nav.css">
  <script src="staff-nav.js"></script>
  <style>
    :root {
      /* Primary color palette - matching homepage */
      --primary: #0b4fb3;
      --primary-dark: #062b6f;
      --primary-light: #2b6ecc;
      --primary-lightest: #e8f2ff;

      /* Accent colors */
      --accent: #76a7ff;
      --accent-2: #5f96ff;
      --success: #2bd4a7;
      --success-light: #e8fdf8;
      --warning: #ffca28;
      --warning-light: #fffbeb;
      --danger: #ff6b6b;
      --danger-light: #fef2f2;

      /* Neutral colors */
      --white: #ffffff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);

      /* Border radius */
      --radius-sm: 0.375rem;
      --radius: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;

      /* Typography */
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
      --font-display: 'Plus Jakarta Sans', 'Inter', sans-serif;

      /* Transitions */
      --transition: all 0.2s ease-in-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: var(--font-sans);
      background: linear-gradient(135deg, #e8f2ff 0%, #ffffff 100%) !important;
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--gray-900);
      position: relative;
      overflow-x: hidden;
    }

    /* Background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="%23e2e8f0" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>') !important;
      opacity: 0.3;
      z-index: -1;
      pointer-events: none;
    }

    /* Navigation styles removed - using staff-nav.css instead */

    /* Main Content Container */
    .main-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    /* Progress Bar */
    .progress-bar-container {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
    }

    .progress-bar {
      height: 8px;
      background: var(--gray-200);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 999px;
      transition: width 0.5s ease;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    /* Step Cards */
    .step-card {
      background: var(--white);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--gray-200);
      padding: 3rem;
      margin-bottom: 2rem;
      position: relative;
      overflow: hidden;
    }

    .step-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent), var(--success));
    }

    .step-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .step-icon {
      width: 5rem;
      height: 5rem;
      background: linear-gradient(135deg, var(--primary-lightest), var(--primary-lightest));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      font-size: 2.5rem;
    }

    .step-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--gray-900);
      font-family: var(--font-display);
      margin-bottom: 0.5rem;
    }

    .step-subtitle {
      font-size: 1.125rem;
      color: var(--gray-600);
      font-weight: 500;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--gray-700);
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 1rem;
      transition: var(--transition);
      background: var(--white);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 79, 179, 0.1);
    }

    .form-input::placeholder {
      color: var(--gray-400);
    }

    .form-hint {
      margin-top: 0.25rem;
      font-size: 0.875rem;
      color: var(--gray-500);
    }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      font-size: 1rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
      transform: translateY(-1px);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #22c55e);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(34, 197, 94, 0.4);
    }

    /* Step Navigation */
    .step-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid var(--gray-200);
    }

    /* Welcome Step */
    .welcome-input-group {
      max-width: 500px;
      margin: 0 auto;
    }

    .welcome-input-group .form-input {
      font-size: 1.25rem;
      padding: 1rem 1.25rem;
      text-align: center;
    }

    /* Avatar Builder */
    .avatar-builder {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 2rem;
    }

    .avatar-preview-panel {
      position: sticky;
      top: 2rem;
      height: fit-content;
    }

    .avatar-preview-card {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      text-align: center;
    }

    .avatar-preview {
      width: 200px;
      height: 200px;
      border-radius: var(--radius-lg);
      background: var(--gray-100);
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .avatar-controls {
      background: var(--white);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
    }

    .control-section {
      margin-bottom: 2rem;
    }

    .control-section:last-child {
      margin-bottom: 0;
    }

    .control-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .control-section-title {
      font-weight: 700;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    /* Working Type Cards */
    .working-type-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .working-type-card {
      background: var(--white);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-xl);
      padding: 2rem;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      text-align: center;
    }

    .working-type-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
      border-color: var(--primary);
    }

    .working-type-card.selected {
      border-color: var(--primary);
      background: var(--primary-lightest);
      box-shadow: 0 0 0 3px rgba(11, 79, 179, 0.1);
    }

    .working-type-icon {
      width: 4rem;
      height: 4rem;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      color: white;
      font-size: 1.75rem;
    }

    .working-type-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
    }

    .working-type-description {
      color: var(--gray-600);
      margin-bottom: 1rem;
    }

    .working-type-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: var(--success-light);
      color: var(--success);
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    /* Working Pattern */
    .working-pattern-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }

    .day-input-group {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: 1rem;
      text-align: center;
    }

    .day-input-group:hover {
      box-shadow: var(--shadow-md);
    }

    .day-label {
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
      display: block;
    }

    /* Completion Step */
    .completion-content {
      text-align: center;
      padding: 3rem 0;
    }

    .completion-icon {
      width: 6rem;
      height: 6rem;
      background: linear-gradient(135deg, var(--success), #22c55e);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 2rem;
      color: white;
      font-size: 3rem;
      animation: pulse 2s infinite;
    }

    .completion-title {
      font-size: 3rem;
      font-weight: 800;
      color: var(--gray-900);
      margin-bottom: 1rem;
      font-family: var(--font-display);
    }

    .completion-message {
      font-size: 1.25rem;
      color: var(--gray-600);
      margin-bottom: 0.5rem;
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    /* Particle System */
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    .particle {
      position: absolute;
      pointer-events: none;
    }

    /* AI Avatar Generator Special Section */
    .ai-generator-card {
      background: linear-gradient(135deg, var(--primary-lightest), var(--white));
      border: 2px solid var(--primary);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .ai-generator-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent), var(--success));
    }

    .ai-generator-title {
      font-weight: 700;
      font-size: 1.125rem;
      color: var(--gray-900);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .ai-prompt-group {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .ai-prompt-textarea {
      flex: 1;
      min-height: 80px;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      resize: vertical;
      font-family: inherit;
      font-size: 0.875rem;
    }

    .ai-prompt-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 79, 179, 0.1);
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .avatar-builder {
        grid-template-columns: 1fr;
      }

      .avatar-preview-panel {
        position: static;
      }

      .working-type-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 0 1rem;
      }

      .step-card {
        padding: 2rem 1.5rem;
      }

      .step-title {
        font-size: 1.5rem;
      }

      /* navbar responsive styles handled by staff-nav.css */

      .working-pattern-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .step-navigation {
        flex-direction: column;
        gap: 1rem;
      }

      .step-navigation .btn {
        width: 100%;
      }

      .control-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Hidden class */
    .hidden {
      display: none !important;
    }

    /* Select styling */
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-sm);
      background: var(--white);
      font-size: 0.875rem;
      transition: var(--transition);
    }

    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 79, 179, 0.1);
    }

    /* Toggle button */
    .toggle-btn {
      padding: 0.25rem 0.5rem;
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .toggle-btn:hover {
      background: var(--gray-200);
    }

    /* Color swatches */
    /* New: replace bland selects with larger icon/button grids for better UX */
    .option-buttons{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .option-btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 10px; border-radius:10px; background:#fff; border:1px solid rgba(148,163,184,0.12); cursor:pointer; font-weight:700; color:#0f172a; min-width:56px; height:44px; box-shadow:0 6px 18px rgba(2,6,23,.04); transition:all .15s ease; }
    .option-btn:hover{ transform:translateY(-3px); box-shadow:0 10px 26px rgba(2,6,23,.08); }
    .option-btn.selected{ background:linear-gradient(90deg,#60a5fa,#a78bfa); color:white; border-color:transparent; }
    .option-swatch{ width:28px; height:28px; border-radius:6px; border:1px solid rgba(15,23,42,0.06); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06); }
    .select-hidden{ display:none !important; }

    /* Modern App-like Avatar Sections */
    .avatar-control-group{ 
      grid-column:1 / -1; 
      padding:14px; 
      margin-top:12px; 
      border-radius:16px; 
      background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); 
      box-shadow:0 8px 25px rgba(15,23,42,0.08), 0 3px 6px rgba(15,23,42,0.03); 
      border:1px solid rgba(148,163,184,0.12);
      position:relative;
      overflow:hidden;
      transition: all 0.3s ease;
    }
    .avatar-control-group::before{
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
      border-radius: 20px 20px 0 0;
    }
    .avatar-control-group:hover{ 
      transform: translateY(-2px); 
      box-shadow:0 12px 35px rgba(15,23,42,0.12), 0 5px 15px rgba(15,23,42,0.06); 
    }
    .avatar-control-group + .avatar-control-group{ margin-top:20px; }
    .avatar-control-group .group-header{ 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:12px; 
      margin-bottom:12px;
    }
    .avatar-control-group .group-title{ 
      font-weight:800; 
      color:#1e293b; 
      margin:0; 
      font-size:16px; 
      display:flex;
      align-items:center;
      gap:8px;
    }
    .avatar-control-group .group-title::before{
      content: attr(data-icon);
      font-size: 20px;
      opacity: 0.8;
    }
    .avatar-control-group .group-help{ 
      color: rgba(255,255,255,0.8); 
      font-size:14px; 
      margin:0 0 16px 0; 
      padding:12px 16px;
      background:rgba(59,130,246,0.15);
      border-radius:12px;
      border-left:3px solid #3b82f6;
      font-weight:500;
      display:none;
    }
    .avatar-control-group .group-grid{ 
      display:grid; 
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
      gap:12px; 
      align-items:start; 
      transition: all .35s cubic-bezier(0.4, 0, 0.2, 1); 
      max-height:2000px; 
      overflow:hidden; 
    }
    .avatar-control-group.collapsed .group-grid{ 
      max-height:0; 
      opacity:0; 
      pointer-events:none; 
      margin-top:0;
      padding-top:0;
    }
    .avatar-control-group.collapsed .group-help{ display:none; }
    .group-toggle{ 
      background:linear-gradient(135deg, #f1f5f9, #e2e8f0); 
      border:1px solid rgba(148,163,184,0.2); 
      padding:8px 16px; 
      border-radius:12px; 
      cursor:pointer; 
      font-weight:600; 
      color:#475569; 
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      transition: all 0.2s ease;
    }
    .group-toggle:hover{
      background:linear-gradient(135deg, #e2e8f0, #cbd5e1);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,0.1);
    }
    .group-toggle:active{ transform:translateY(0); }
    .avatar-control-group.collapsed .group-toggle{
      background:linear-gradient(135deg, #dbeafe, #bfdbfe);
      color:#1d4ed8;
    }

    /* Enhanced form controls */
    .avatar-control-group label{
      display:flex; 
      flex-direction:column; 
      gap:8px;
      padding:10px;
      background:rgba(255,255,255,0.7);
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.1);
      transition: all 0.2s ease;
    }
    .avatar-control-group label:hover{
      background:rgba(255,255,255,0.9);
      border-color:rgba(59,130,246,0.2);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,0.05);
    }
    .avatar-control-group label span{
      font-weight:600; 
      color:#334155; 
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .avatar-control-group select{
      padding:12px 16px; 
      border-radius:10px; 
      border:1px solid rgba(148,163,184,0.2);
      background:white;
      font-size:14px;
      font-weight:500;
      color:#1e293b;
      transition: all 0.2s ease;
    }
    .avatar-control-group select:focus{
      outline:none;
      border-color:#3b82f6;
      box-shadow:0 0 0 3px rgba(59,130,246,0.1);
    }

    /* Enhanced section styling */
    #group-face::before { background: linear-gradient(90deg, #f59e0b, #f97316); }
    #group-accessories::before { background: linear-gradient(90deg, #8b5cf6, #a855f7); }
    #group-hair::before { background: linear-gradient(90deg, #06b6d4, #0891b2); }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .avatar-control-group .group-grid {
        grid-template-columns: 1fr;
      }
      .avatar-control-group {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="navbar-root"></div>

  <!-- Main Content -->
  <main class="main-container">
    <!-- Progress Bar -->
    <div class="progress-bar-container">
      <div class="progress-bar">
        <div class="progress-bar-fill" id="progress-fill" style="width: 20%"></div>
      </div>
      <div class="progress-text">
        <span>Step <span id="current-step">1</span> of 5</span>
        <span id="progress-label">Getting Started</span>
      </div>
    </div>

    <!-- Step 1: Welcome/Nickname -->
    <section id="welcome-step1" class="step-card fade-in">
      <div class="step-header">
        <div class="step-icon">👋</div>
        <h1 class="step-title">Welcome to CheckLoops!</h1>
        <p class="step-subtitle" id="site-subtitle">Let's get your profile set up</p>
      </div>

      <div class="welcome-input-group">
        <div class="form-group">
          <label class="form-label" for="nickname">What should we call you?</label>
          <input type="text" id="nickname" class="form-input" placeholder="e.g. Ben" maxlength="50" data-table="master_users" data-column="nickname" />
          <p class="form-hint">This is the name your team will see</p>
        </div>
        <button class="btn btn-primary" id="save-btn" style="width: 100%;">
          Get Started →
        </button>
        <div id="save-msg" class="form-hint" style="text-align: center; margin-top: 1rem;"></div>
      </div>
    </section>

    <!-- Step 3: Avatar Builder (Step 2 was removed) -->
    <section id="welcome-step3" class="step-card hidden">
      <div class="step-header">
        <div class="step-icon">🎨</div>
        <h1 class="step-title">Create Your Avatar</h1>
        <p class="step-subtitle">Express yourself with a unique avatar</p>
      </div>

      <div class="avatar-builder">
        <!-- Avatar Preview -->
        <div class="avatar-preview-panel">
          <div class="avatar-preview-card">
            <div class="avatar-preview">
              <img id="avatarPreview" alt="Avatar preview" data-table="master_users" data-column="avatar_url" />
            </div>
            <button class="btn btn-primary" id="avatar-randomize" style="width: 100%;">
              🎲 Randomize
            </button>
            <div id="avatar-save-msg" class="form-hint" style="margin-top: 0.5rem;"></div>
          </div>
        </div>

        <!-- Avatar Controls -->
        <div class="avatar-controls">
          <!-- AI Generator -->
          <div class="ai-generator-card">
            <h3 class="ai-generator-title">
              ✨ AI Avatar Generator
            </h3>
            <div class="ai-prompt-group">
              <textarea id="avatarPrompt" class="ai-prompt-textarea"
                placeholder="Describe your perfect avatar: 'Friendly nurse with green scrubs, freckles, long brown hair, round glasses, colorful background'"></textarea>
              <button class="btn btn-success" id="avatar-ai-generate">
                Generate
              </button>
            </div>
            <div id="avatar-ai-msg" class="form-hint" style="margin-top: 0.5rem;"></div>
          </div>

          <!-- Manual Controls -->
              <div class="avatar-control-group" id="group-face">
                <div class="group-header">
                  <h4 class="group-title" data-icon="👤">Face & Expression</h4>
                  <button class="group-toggle" data-target="#group-face">Hide</button>
                </div>
                <div class="group-help">✨ Choose your facial features — eyes, mouth, and skin tone to create your unique look</div>
                <div class="group-grid">
                  <label>
                    <span>👁️ Eyes Style</span>
                    <select id="opt-eyes"></select>
                  </label>
                  <label>
                    <span>😊 Mouth Expression</span>
                    <select id="opt-mouth"></select>
                  </label>
                  <label>
                    <span>🤨 Eyebrows Shape</span>
                    <select id="opt-eyebrows"></select>
                  </label>
                  <label id="skin-swatch-wrapper">
                    <span>🎨 Skin Tone</span>
                    <div class="option-buttons" id="skin-swatch-buttons" role="group" aria-label="Skin tone options"></div>
                    <select id="opt-skinColor" class="select-hidden" aria-hidden="true" tabindex="-1"></select>
                  </label>
                </div>
              </div>

              <div class="avatar-control-group collapsed" id="group-accessories">
                <div class="group-header">
                  <h4 class="group-title" data-icon="👓">Accessories & Features</h4>
                  <button class="group-toggle" data-target="#group-accessories">Show</button>
                </div>
                <div class="group-help">💎 Add personality with glasses, earrings, and distinctive features</div>
                <div class="group-grid">
                  <label>
                    <span>👓 Glasses Style</span>
                    <select id="opt-glasses">
                      <option value="">None</option>
                    </select>
                  </label>
                  <label style="display: none;">
                    <span>📊 Glasses Chance</span>
                    <select id="opt-glassesProbability"></select>
                  </label>
                  <label>
                    <span>💎 Earrings Type</span>
                    <select id="opt-earrings">
                      <option value="">None</option>
                    </select>
                  </label>
                  <label style="display: none;">
                    <span>📊 Earrings Chance</span>
                    <select id="opt-earringsProbability"></select>
                  </label>

                  <label style="grid-column:1 / -1;">
                    <span>✨ Special Features</span>
                    <select id="opt-features" multiple size="5"></select>
                  </label>
                  <label style="display: none;">
                    <span>📊 Features Chance</span>
                    <select id="opt-featuresProbability"></select>
                  </label>
                </div>
              </div>

              <div class="avatar-control-group collapsed" id="group-hair">
                <div class="group-header">
                  <h4 class="group-title" data-icon="💇">Hair & Style</h4>
                  <button class="group-toggle" data-target="#group-hair">Show</button>
                </div>
                <div class="group-help">💅 Express yourself with different hairstyles and bold colors</div>
                <div class="group-grid">
                  <label>
                    <span>✂️ Hairstyle</span>
                    <select id="opt-hair" onchange="updateAvatarPreview()"></select>
                  </label>
                  <label>
                    <span>🎨 Hair Color</span>
                    <select id="opt-hairColor" onchange="updateAvatarPreview()"></select>
                  </label>
                  <label style="display: none;">
                    <span>📊 Hair Chance</span>
                    <select id="opt-hairProbability"></select>
                  </label>
                </div>
              </div>

          <!-- Hidden layout controls -->
          <div id="layout-controls" class="hidden">
            <select id="opt-backgroundType"></select>
            <select id="opt-backgroundColor"></select>
            <select id="opt-backgroundRotation"></select>
            <select id="opt-radius"></select>
            <select id="opt-rotate"></select>
            <select id="opt-scale"></select>
            <select id="opt-flip"></select>
            <select id="opt-clip"></select>
            <select id="opt-translateX"></select>
            <select id="opt-translateY"></select>
          </div>
        </div>
      </div>

      <div class="step-navigation">
        <button class="btn btn-secondary" id="back-to-step1">← Back</button>
        <button class="btn btn-primary" id="finish-avatar-btn">Continue →</button>
      </div>
      <div id="finish-avatar-msg" class="form-hint" style="text-align: center; margin-top: 0.5rem;"></div>
    </section>

    <!-- Step 4: Working Type Choice -->
    <section id="step4" class="step-card hidden">
      <div class="step-header">
        <div class="step-icon">⏰</div>
        <h1 class="step-title">How do you track your time?</h1>
        <p class="step-subtitle">Choose your preferred method</p>
      </div>

      <div class="working-type-grid">
        <!-- Hours Option -->
        <div class="working-type-card" data-type="hours">
          <div class="working-type-icon">🕐</div>
          <h3 class="working-type-title">Hours & Minutes</h3>
          <p class="working-type-description">Perfect for detailed time tracking</p>
          <span class="working-type-badge">Example: 07:30</span>
          <input type="radio" name="work-type" value="hours" id="work-type-hours" class="hidden" checked data-table="master_users" data-column="is_gp">
        </div>

        <!-- Sessions Option -->
        <div class="working-type-card" data-type="sessions">
          <div class="working-type-icon">📊</div>
          <h3 class="working-type-title">Sessions</h3>
          <p class="working-type-description">Simple counting by blocks of work</p>
          <span class="working-type-badge">Example: 1 or 2 per day</span>
          <input type="radio" name="work-type" value="sessions" id="work-type-sessions" class="hidden" data-table="master_users" data-column="is_gp">
        </div>
      </div>

      <div id="step4-msg" class="form-hint" style="text-align: center;"></div>

      <div class="step-navigation">
        <button class="btn btn-secondary" id="step4-back">← Back</button>
        <button class="btn btn-primary" id="step4-next">Continue →</button>
      </div>
    </section>

    <!-- Step 4b: Working Pattern -->
    <section id="working-pattern-step" class="step-card hidden">
      <div class="step-header">
        <div class="step-icon">📅</div>
        <h1 class="step-title">Your Weekly Working Pattern</h1>
        <p class="step-subtitle">Enter your typical hours or sessions for each day</p>
      </div>

      <div id="working-pattern-note" class="form-hint" style="text-align: center; margin-bottom: 1rem;"></div>

      <div class="working-pattern-grid" id="working-pattern-form">
        <!-- Days will be generated by JavaScript -->
      </div>

      <div id="working-pattern-msg" class="form-hint" style="text-align: center;"></div>

      <div class="step-navigation">
        <button class="btn btn-secondary" id="working-pattern-back">← Back</button>
        <button class="btn btn-success" id="working-pattern-finish">🎉 Finish Setup</button>
      </div>
    </section>

    <!-- Step 5: Completion -->
    <section id="step5" class="step-card hidden">
      <div class="completion-content">
        <div class="completion-icon">✓</div>
        <h1 class="completion-title">All Set!</h1>
        <p class="completion-message">Your profile is complete</p>
        <p class="form-hint">Redirecting to your dashboard in a moment...</p>
      </div>
    </section>
  </main>

  <!-- Confetti Container -->
  <div class="confetti-container" id="confetti"></div>

  <!-- Scripts -->
  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, attachLogout, updateProfileCache, getSiteSettings, renderUserAvatar } from './staff-common.js';

    // Initialize Supabase
    const supabase = await initSupabase();
    window.supabase = supabase;

    function buildAvatarVariantRecords(userId, baseUrl) {
      if (!userId || !baseUrl) return [];

      let parsedUrl;
      try {
        parsedUrl = new URL(baseUrl, window.location.origin);
      } catch (err) {
        console.warn('Invalid avatar URL for variants:', baseUrl, err);
        return [];
      }

      const moods = [
        { variant: 'happy', overrides: { eyes: 'variant11', mouth: 'variant26', eyebrows: 'variant06' } },
        { variant: 'sad', overrides: { eyes: 'variant15', mouth: 'variant11', eyebrows: 'variant08' } },
        { variant: 'confused', overrides: { eyes: 'variant23', mouth: 'variant03', eyebrows: 'variant05' } },
        { variant: 'angry', overrides: { eyes: 'variant14', mouth: 'variant11', eyebrows: 'variant02' } },
        { variant: 'surprised', overrides: { eyes: 'variant08', mouth: 'variant18', eyebrows: 'variant06' } },
        { variant: 'relaxed', overrides: { eyes: 'variant19', mouth: 'variant21', eyebrows: 'variant03' } },
        { variant: 'excited', overrides: { eyes: 'variant21', mouth: 'variant28', eyebrows: 'variant06' } },
        { variant: 'tired', overrides: { eyes: 'variant16', mouth: 'variant09', eyebrows: 'variant11' } },
        { variant: 'determined', overrides: { eyes: 'variant10', mouth: 'variant04', eyebrows: 'variant01' } },
        { variant: 'neutral', overrides: { eyes: 'variant24', mouth: 'variant08', eyebrows: 'variant10' } }
      ];

      const isDicebear = parsedUrl.href.includes('api.dicebear.com/7.x/adventurer/svg');
      if (!isDicebear || parsedUrl.protocol === 'data:') {
        return moods.map(mood => ({
          user_id: userId,
          variant: mood.variant,
          image_url: baseUrl,
          source_avatar_url: baseUrl
        }));
      }

      const baseParams = new URLSearchParams(parsedUrl.search || '');
      const basePath = `${parsedUrl.origin}${parsedUrl.pathname}`;

      return moods.map(mood => {
        const params = new URLSearchParams(baseParams);
        Object.entries(mood.overrides).forEach(([key, value]) => {
          if (value === null || value === undefined || value === '') {
            params.delete(key);
          } else {
            params.set(key, value);
          }
        });
        const query = params.toString();
        return {
          user_id: userId,
          variant: mood.variant,
          image_url: query ? `${basePath}?${query}` : basePath,
          source_avatar_url: baseUrl
        };
      });
    }

    async function upsertAvatarVariants(userId, baseUrl) {
      const records = buildAvatarVariantRecords(userId, baseUrl);
      if (!records.length) return;
      const { error } = await supabase
        .from('avatar_variants')
        .upsert(records, { onConflict: 'user_id,variant', returning: 'minimal' });
      if (error) {
        throw error;
      }
    }

    // Handle authentication state
    handleAuthState(supabase);
    if (typeof window.renderStandardStaffNav === 'function') {
      window.renderStandardStaffNav('staff-welcome.html');
    }

    // Progress tracking
    let currentStep = 1;
    const totalSteps = 5;

    function updateProgress(step, label) {
      currentStep = step;
      const progressFill = document.getElementById('progress-fill');
      const currentStepEl = document.getElementById('current-step');
      const progressLabel = document.getElementById('progress-label');

      if (progressFill) progressFill.style.width = `${(step / totalSteps) * 100}%`;
      if (currentStepEl) currentStepEl.textContent = step;
      if (progressLabel) progressLabel.textContent = label;
    }

    // Step visibility management
    function showStep(stepId) {
      document.querySelectorAll('.step-card').forEach(card => {
        card.classList.add('hidden');
      });
      const stepEl = document.getElementById(stepId);
      if (stepEl) {
        stepEl.classList.remove('hidden');
        stepEl.classList.add('fade-in');
      }
    }

    // Working Type Selection
    (function() {
      const cards = document.querySelectorAll('.working-type-card');

      cards.forEach(card => {
        card.addEventListener('click', () => {
          const type = card.dataset.type;
          const radio = card.querySelector('input[type="radio"]');
          if (radio) {
            radio.checked = true;
            // Update visual state
            cards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            // Update message
            const msg = document.getElementById('step4-msg');
            if (msg) {
              if (type === 'hours') {
                msg.innerHTML = 'Perfect for detailed time tracking and reporting 📊';
              } else {
                msg.innerHTML = 'Great for simple, straightforward scheduling ✨';
              }
            }
          }
        });
      });

      // Initialize selection
      const defaultCard = document.querySelector('.working-type-card[data-type="hours"]');
      if (defaultCard) defaultCard.click();
    })();

    // Compact: sync Hide/Show buttons and allow collapsing groups
    (function(){
      const sync = (btn, target) => { btn.textContent = target.classList.contains('collapsed') ? 'Show' : 'Hide'; };
      document.querySelectorAll('.group-toggle').forEach(btn => {
        const sel = btn.getAttribute('data-target');
        const target = document.querySelector(sel);
        if (!target) return;
        sync(btn, target);
        btn.addEventListener('click', function() { 
          target.classList.toggle('collapsed'); 
          sync(btn, target);
          
          // If this is the hair section and we're expanding it, update the avatar
          // This ensures the hair controls work when first accessed
          if (sel === '#group-hair' && !target.classList.contains('collapsed')) {
            console.log('Hair section expanded, ensuring controls are ready');
            setTimeout(() => {
              // Ensure controls are properly initialized
              if (typeof updateAvatarPreview === 'function') {
                updateAvatarPreview();
              }
            }, 100);
          }
        });
      });
    })();

    // Simple HTML escaper
    function esc(s) {
      return (s ?? "").toString().replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[m]));
    }

    // Particle system for celebrations
    function createConfetti() {
      const container = document.getElementById('confetti');
      if (!container) return;

      const colors = ['#3b82f6', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444', '#ec4899'];

      for (let i = 0; i < 100; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.width = Math.random() * 10 + 5 + 'px';
        particle.style.height = particle.style.width;
        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
        particle.style.borderRadius = '50%';
        particle.style.animation = `fall ${Math.random() * 3 + 2}s ease-out forwards`;
        container.appendChild(particle);

        setTimeout(() => particle.remove(), 5000);
      }
    }

    // Add falling animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fall {
        to {
          transform: translateY(100vh) rotate(720deg);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);

    // Main initialization
    requireStaffSession(supabase).then(async ({ session, profileRow }) => {
      // Set user info
      const emailPill = document.getElementById('email-pill');
      const rolePill = document.getElementById('role-pill');
      if (emailPill) emailPill.textContent = session.user.email || '—';
      // Always prioritize access_type over role
      if (rolePill) rolePill.textContent = profileRow?.access_type || profileRow?.role || 'Staff';

      // Show admin portal button for admins/owners
      const adminRole = (profileRow?.access_type || profileRow?.role || '').toLowerCase();
      const adminPortalBtn = document.getElementById('adminPortalBtn');
      if (adminPortalBtn) {
        if (adminRole === 'admin' || adminRole === 'owner') {
          adminPortalBtn.style.display = 'inline-flex';
        } else {
          adminPortalBtn.style.display = 'none';
        }
      }

      // Set site subtitle
      const siteText = await getSiteText(supabase, profileRow?.site_id);
      const subtitle = document.getElementById('site-subtitle');
      if (subtitle && siteText) {
        subtitle.textContent = `Welcome to ${siteText}`;
      }

      // Attach logout functionality
      attachLogout(supabase);
      
      // Initialize navigation
      navActivate('welcome');

      // Initialize welcome flow
      initWelcomeFlow(session, profileRow);

    }).catch(e => {
      console.error('Session error:', e);
      if (String(e.message).includes('NO_SESSION') || String(e.message).includes('NOT_STAFF')) {
  window.location.replace('home.html');
      }
    });

    // Welcome flow logic
    async function initWelcomeFlow(session, profileRow) {
      // Get site settings to check if avatars are enabled
      const siteSettings = await getSiteSettings(supabase, profileRow?.site_id || 2);
      const avatarsEnabled = siteSettings.enable_avatars !== false;
      console.log('Site settings loaded:', { avatarsEnabled });

      // Hide avatar step if disabled
      if (!avatarsEnabled) {
        const avatarStep = document.getElementById('welcome-step3');
        if (avatarStep) {
          avatarStep.style.display = 'none';
        }
      }
      // Step 1: Nickname
      const nicknameInput = document.getElementById('nickname');
      const saveBtn = document.getElementById('save-btn');
      const saveMsg = document.getElementById('save-msg');

      if (nicknameInput && profileRow?.nickname) {
        nicknameInput.value = profileRow.nickname;
      }

      saveBtn?.addEventListener('click', async () => {
        const nickname = nicknameInput?.value?.trim();
        if (!nickname) {
          if (saveMsg) saveMsg.textContent = 'Please enter a name';
          return;
        }

        try {
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';
          if (saveMsg) saveMsg.textContent = '';

          console.log('Saving nickname:', nickname, 'for user:', session.user.id);

          // First check if user exists in master_users by auth_user_id
          let { data: existingUser, error: checkError } = await supabase
            .from('master_users')
            .select('id, nickname')
            .eq('auth_user_id', session.user.id)
            .maybeSingle();

          // If not found by auth_user_id, try by email as fallback
          if (!existingUser && session.user.email) {
            console.log('User not found by auth_user_id, trying email fallback:', session.user.email);
            const { data: emailUser, error: emailError } = await supabase
              .from('master_users')
              .select('id, nickname, auth_user_id')
              .eq('email', session.user.email)
              .maybeSingle();

            if (emailUser) {
              existingUser = emailUser;
              console.log('Found user by email, will update auth_user_id');

              // Update the missing auth_user_id
              if (!emailUser.auth_user_id) {
                await supabase
                  .from('master_users')
                  .update({ auth_user_id: session.user.id })
                  .eq('id', emailUser.id);
                console.log('Updated missing auth_user_id for user');
              }
            }
          }

          if (checkError && !existingUser) {
            console.error('Error checking user existence:', checkError);
            throw checkError;
          }

          if (!existingUser) {
            throw new Error('User profile not found. Please contact support.');
          }

          console.log('Found existing user:', existingUser);

          // Update profile
          const { data, error } = await supabase
            .from('master_users')
            .update({ nickname, updated_at: new Date().toISOString() })
            .eq('id', existingUser.id);

          if (error) {
            console.error('Nickname save error:', error);
            throw error;
          }

          console.log('Nickname saved successfully:', data);
          if (saveMsg) saveMsg.textContent = '✅ Nickname saved!';

          // Update cache
          if (profileRow) {
            profileRow.nickname = nickname;
            updateProfileCache(profileRow);
          }

          // Move to next step after brief delay
          setTimeout(() => {
            if (avatarsEnabled) {
              // Show avatar creation step
              updateProgress(2, 'Create Avatar');
              showStep('welcome-step3');
              initAvatarBuilder(session, profileRow);
            } else {
              // Skip avatar and go to working type
              updateProgress(3, 'Working Type');
              showStep('step4');
            }
          }, 500);

        } catch (error) {
          console.error('Error saving nickname:', error);
          if (saveMsg) saveMsg.textContent = `❌ Error saving: ${error.message || 'Please try again'}`;
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Get Started →';
        }
      });

      // Back buttons
      document.getElementById('back-to-step1')?.addEventListener('click', () => {
        updateProgress(1, 'Getting Started');
        showStep('welcome-step1');
      });

      document.getElementById('step4-back')?.addEventListener('click', () => {
        if (avatarsEnabled) {
          updateProgress(2, 'Create Avatar');
          showStep('welcome-step3');
        } else {
          updateProgress(1, 'Getting Started');
          showStep('welcome-step1');
        }
      });

      // Step 4 navigation
      document.getElementById('finish-avatar-btn')?.addEventListener('click', async () => {
        // Save avatar first (robustly, without requiring Randomize)
        const msg = document.getElementById('finish-avatar-msg');
        try {
          if (msg) msg.textContent = 'Saving avatar...';
          
          // Ensure preview URL is initialized
          if (!window.currentAvatarUrl) {
            if (typeof window.updateAvatarPreview === 'function') {
              window.updateAvatarPreview();
            }
          }
          const imgEl = document.getElementById('avatarPreview');
          let avatarUrl = imgEl?.getAttribute('src')
            || window.currentAvatarUrl
            || (typeof window.buildAvatarUrlFromControls === 'function' ? window.buildAvatarUrlFromControls() : null)
            || 'https://api.dicebear.com/7.x/adventurer/svg';

          console.log('Saving avatar URL:', avatarUrl, 'for user:', session.user.id);

          // First check if user exists in master_users by auth_user_id
          let { data: existingUser, error: checkError } = await supabase
            .from('master_users')
            .select('id, avatar_url')
            .eq('auth_user_id', session.user.id)
            .maybeSingle();

          // If not found by auth_user_id, try by email as fallback
          if (!existingUser && session.user.email) {
            console.log('User not found by auth_user_id for avatar, trying email fallback:', session.user.email);
            const { data: emailUser, error: emailError } = await supabase
              .from('master_users')
              .select('id, avatar_url, auth_user_id')
              .eq('email', session.user.email)
              .maybeSingle();

            if (emailUser) {
              existingUser = emailUser;
              console.log('Found user by email for avatar, will update auth_user_id');

              // Update the missing auth_user_id
              if (!emailUser.auth_user_id) {
                await supabase
                  .from('master_users')
                  .update({ auth_user_id: session.user.id })
                  .eq('id', emailUser.id);
                console.log('Updated missing auth_user_id for avatar user');
              }
            }
          }

          if (checkError && !existingUser) {
            console.error('Error checking user existence for avatar:', checkError);
            throw checkError;
          }

          if (!existingUser) {
            throw new Error('User profile not found. Please contact support.');
          }

          console.log('Found existing user for avatar update:', existingUser);

          // Save to auth user metadata
          const { error: authError } = await supabase.auth.updateUser({ 
            data: { avatar_url: avatarUrl } 
          });
          if (authError) {
            console.error('Auth avatar update error:', authError);
            throw authError;
          }

          // Save to master_users table
          const { data, error: profileError } = await supabase
            .from('master_users')
            .update({ avatar_url: avatarUrl, updated_at: new Date().toISOString() })
            .eq('id', existingUser.id);

          if (profileError) {
            console.error('Profile avatar update error:', profileError);
            throw profileError;
          }

          try {
            await upsertAvatarVariants(session.user.id, avatarUrl);
            console.log('Avatar variants saved for moods: happy, sad, confused');
          } catch (variantError) {
            console.error('Avatar variant upsert error:', variantError);
            throw new Error(variantError?.message || 'Unable to save avatar variants');
          }

          console.log('Avatar saved successfully:', data);
          if (msg) msg.textContent = '✅ Avatar saved successfully!';

          // Continue to next step after brief delay
          setTimeout(() => {
            updateProgress(3, 'Working Type');
            showStep('step4');
          }, 500);

        } catch (error) {
          console.error('Error saving avatar:', error);
          if (msg) msg.textContent = `❌ Error saving avatar: ${error.message || 'Please try again'}`;
        }
      });

      document.getElementById('step4-next')?.addEventListener('click', async () => {
        const workType = document.querySelector('input[name="work-type"]:checked')?.value;
        if (workType) {
          // Remember selection for saveWorkingPattern
          window.currentWorkType = workType;
          updateProgress(4, 'Working Pattern');
          showStep('working-pattern-step');
          await initWorkingPattern(session, profileRow, workType);
        }
      });

      document.getElementById('working-pattern-back')?.addEventListener('click', () => {
        updateProgress(3, 'Working Type');
        showStep('step4');
        // Clear the current work type so user can reselect
        window.currentWorkType = null;
      });

      document.getElementById('working-pattern-finish')?.addEventListener('click', async () => {
        await saveWorkingPattern(session, profileRow);
        updateProgress(5, 'Complete!');
        showStep('step5');
        createConfetti();

        // Clear the needs_onboarding flag now that onboarding is complete
        try {
          console.log('[staff-welcome] Clearing needs_onboarding flag');
          const { error: updateError } = await supabase.auth.updateUser({
            data: {
              needs_onboarding: false,
              from_invitation: false,
              onboarding_completed_at: new Date().toISOString()
            }
          });

          if (updateError) {
            console.warn('[staff-welcome] Failed to clear onboarding flag:', updateError);
          } else {
            console.log('[staff-welcome] Onboarding flag cleared successfully');
          }
        } catch (e) {
          console.warn('[staff-welcome] Error clearing onboarding flag:', e);
        }

        // Redirect after delay
        setTimeout(() => {
          window.location.href = 'staff.html';
        }, 3000);
      });
    }

    // Avatar Builder (simplified for space)
  function initAvatarBuilder(session, profileRow) {
      // DiceBear Adventurer style avatar system
      const preview = document.getElementById('avatarPreview');
      if (preview) {
        // Set existing avatar from user profile or default
        preview.src = profileRow?.avatar_url || 'https://api.dicebear.com/7.x/adventurer/svg';
        
        // If user has an existing avatar from DiceBear, parse its parameters
        if (profileRow?.avatar_url && profileRow.avatar_url.includes('api.dicebear.com/7.x/adventurer/svg')) {
          try {
            const url = new URL(profileRow.avatar_url);
            const params = new URLSearchParams(url.search);
            
            // Map URL parameters back to form controls
            setTimeout(() => {
              // Face features
              if (params.has('eyes')) setSelectValue('opt-eyes', params.get('eyes'));
              if (params.has('mouth')) setSelectValue('opt-mouth', params.get('mouth'));
              if (params.has('eyebrows')) setSelectValue('opt-eyebrows', params.get('eyebrows'));
              if (params.has('skinColor')) setSelectValue('opt-skinColor', params.get('skinColor'));
              
              // Accessories
              if (params.has('glasses')) setSelectValue('opt-glasses', params.get('glasses'));
              if (params.has('glassesProbability')) setSelectValue('opt-glassesProbability', params.get('glassesProbability'));
              if (params.has('earrings')) setSelectValue('opt-earrings', params.get('earrings'));
              if (params.has('earringsProbability')) setSelectValue('opt-earringsProbability', params.get('earringsProbability'));
              
              // Features (multi-select)
              const featuresEl = document.getElementById('opt-features');
              if (featuresEl && params.has('features')) {
                const features = params.getAll('features');
                if (features.length) {
                  Array.from(featuresEl.options).forEach(opt => {
                    opt.selected = features.includes(opt.value);
                  });
                  if (params.has('featuresProbability')) {
                    setSelectValue('opt-featuresProbability', params.get('featuresProbability'));
                  }
                }
              }
              
              // Hair
              if (params.has('hair')) setSelectValue('opt-hair', params.get('hair'));
              if (params.has('hairColor')) setSelectValue('opt-hairColor', params.get('hairColor'));
              if (params.has('hairProbability')) setSelectValue('opt-hairProbability', params.get('hairProbability'));
              
              console.log('Avatar parameters restored from URL');
            }, 500); // Short delay to ensure dropdowns are populated
          } catch (e) {
            console.warn('Could not parse existing avatar URL parameters:', e);
          }
        }
      }
      
      // Helper function to set select element value
      function setSelectValue(id, value) {
        const el = document.getElementById(id);
        if (el && value) {
          el.value = value;
          // Trigger change event to update any dependent elements
          el.dispatchEvent(new Event('change', { bubbles: true }));
          
          // Also update any option buttons if they exist
          const buttons = el.parentElement.querySelector('.option-buttons');
          if (buttons) {
            const btn = buttons.querySelector(`.option-btn[data-value="${value}"]`);
            if (btn) {
              buttons.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
            }
          }
        }
      }
      
      // Helper functions for avatar building
  function buildAvatarUrlFromControls() {
        const base = 'https://api.dicebear.com/7.x/adventurer/svg';
        const params = new URLSearchParams();
        
        // Get values from form controls
        const eyes = document.getElementById('opt-eyes')?.value;
        const mouth = document.getElementById('opt-mouth')?.value;
        const eyebrows = document.getElementById('opt-eyebrows')?.value;
        const glasses = document.getElementById('opt-glasses')?.value;
        const glassesProbability = document.getElementById('opt-glassesProbability')?.value;
        const earrings = document.getElementById('opt-earrings')?.value;
        const earringsProbability = document.getElementById('opt-earringsProbability')?.value;
        const featuresSel = document.getElementById('opt-features');
        const featuresProbability = document.getElementById('opt-featuresProbability')?.value;
        const hair = document.getElementById('opt-hair')?.value;
        const hairColor = document.getElementById('opt-hairColor')?.value;
        const hairProbability = document.getElementById('opt-hairProbability')?.value;
        const skinColor = document.getElementById('opt-skinColor')?.value;
        
        // Force 100% probability for all features to ensure they always appear
        function forceMaxProb(prob) {
          return '100';
        }
        
        // Set all probabilities to 100% to ensure features always appear
        const updatedHairProb = forceMaxProb(hairProbability);
        const updatedGlassesProb = forceMaxProb(glassesProbability);
        const updatedEarringsProb = forceMaxProb(earringsProbability);
        const featureVals = featuresSel
          ? Array.from(featuresSel.selectedOptions).map(o => o.value).filter(Boolean)
          : [];
        const updatedFeaturesProb = featureVals.length > 0
          ? '100'
          : '';
        
        // Build parameters
        if (eyes) params.set('eyes', eyes);
        if (mouth) params.set('mouth', mouth);
        if (eyebrows) params.set('eyebrows', eyebrows);
        if (glasses) {
          params.set('glasses', glasses);
          if (updatedGlassesProb) params.set('glassesProbability', updatedGlassesProb);
        }
        if (earrings) {
          params.set('earrings', earrings);
          if (updatedEarringsProb) params.set('earringsProbability', updatedEarringsProb);
        }
        if (featureVals.length) {
          featureVals.forEach(v => params.append('features', v));
          if (updatedFeaturesProb) params.set('featuresProbability', updatedFeaturesProb);
        }
        
        // Special handling for hair to ensure it works properly
        console.log('Hair settings before applying:', { hair, hairColor, hairProbability: updatedHairProb });
        
        // Always set hair if it exists
        if (hair) {
          params.set('hair', hair);
          console.log('Applied hair style:', hair);
          
          // Always set hairProbability when hair is set
          params.set('hairProbability', updatedHairProb || '100');
          console.log('Applied hair probability:', updatedHairProb || '100');
        }
        
        // Set hairColor separately as it should work even without hair style
        if (hairColor) {
          params.set('hairColor', hairColor);
          console.log('Applied hair color:', hairColor);
        }
        if (skinColor) params.set('skinColor', skinColor);
        
        return `${base}?${params.toString()}`;
      }

      function updateAvatarPreview() {
        console.log('Updating avatar preview...');
        
        // Double check hair settings before building URL
        const hair = document.getElementById('opt-hair')?.value;
        const hairColor = document.getElementById('opt-hairColor')?.value;
        console.log('Hair settings check:', { hair, hairColor });
        
        const url = buildAvatarUrlFromControls();
        console.log('Built avatar URL:', url);
        
        window.currentAvatarUrl = url;
        const img = document.getElementById('avatarPreview');
        if (img) img.src = url;
        
        // Verify that all key settings are applied
        try {
          const g = document.getElementById('opt-glasses')?.value;
          const gp = document.getElementById('opt-glassesProbability')?.value;
          const e = document.getElementById('opt-earrings')?.value;
          const ep = document.getElementById('opt-earringsProbability')?.value;
          const fEl = document.getElementById('opt-features');
          const f = fEl ? Array.from(fEl.selectedOptions).map(o=>o.value) : [];
          const fp = document.getElementById('opt-featuresProbability')?.value;
          const h = document.getElementById('opt-hair')?.value;
          const hc = document.getElementById('opt-hairColor')?.value;
          const hp = document.getElementById('opt-hairProbability')?.value;
          console.debug('Settings applied:', { 
            glasses: g, glassesProbability: gp, 
            earrings: e, earringsProbability: ep, 
            features: f, featuresProbability: fp,
            hair: h, hairColor: hc, hairProbability: hp
          });
        } catch (e) {
          console.error('Debug check error:', e);
        }
      }
      
      // Fill option dropdowns with appropriate values
      function fillDropdowns() {
        // Helper functions
        function rangeArr(start, end, step = 1) {
          return Array.from({ length: Math.floor((end - start) / step) + 1 }, (_, i) => start + (i * step));
        }
        
        function pad2(n) { return n < 10 ? `0${n}` : `${n}`; }
        
        function fillOpts(el, arr, withBlank = false) {
          if (!el) return;
          el.innerHTML = '';
          if (withBlank) el.appendChild(new Option('Default', ''));
          for (const v of arr) { el.appendChild(new Option(String(v), String(v))); }
        }
        
        function fillOptsLabeled(el, values, labeler, withBlank = false) {
          if (!el) return;
          el.innerHTML = '';
          if (withBlank) el.appendChild(new Option('Default', ''));
          for (const v of values) {
            const label = labeler(v);
            const opt = new Option(label, String(v));
            opt.title = label;
            el.appendChild(opt);
          }
        }
        
        // Human‑readable labels for avatar options
        const eyeLabels = {
          variant01: 'Eyes: Curious',
          variant02: 'Eyes: Observant',
          variant03: 'Eyes: Inquisitive',
          variant04: 'Eyes: Unimpressed',
          variant05: 'Eyes: Pondering',
          variant06: 'Eyes: Doubtful',
          variant07: 'Eyes: Dispassionate',
          variant08: 'Eyes: Wide-eyed',
          variant09: 'Eyes: Quizzical',
          variant10: 'Eyes: Skeptical',
          variant11: 'Eyes: Mildly Amused',
          variant12: 'Eyes: Mischievous',
          variant13: 'Eyes: Sardonic',
          variant14: 'Eyes: Cynical',
          variant15: 'Eyes: Softly Sorrowful',
          variant16: 'Eyes: Slightly Disenchanted',
          variant17: 'Eyes: Unimpressed gaze',
          variant18: 'Eyes: Nonchalant',
          variant19: 'Eyes: Calmly Satisfied',
          variant20: 'Eyes: Subdued Glow',
          variant21: 'Eyes: Winking Playfulness',
          variant22: 'Eyes: Playfully Squinting',
          variant23: 'Eyes: Slightly Confounded',
          variant24: 'Eyes: Blankly Engaged',
          variant25: 'Eyes: Contemplative',
          variant26: 'Eyes: Slightly Bewildered'
        };
        
        const mouthLabels = {
          variant01: 'Mouth: Cheerful curve',
          variant02: 'Mouth: Subdued smirk',
          variant03: 'Mouth: Awestruck pout',
          variant04: 'Mouth: Pensive line',
          variant05: 'Mouth: Beaming smile',
          variant06: 'Mouth: Delicate crease',
          variant07: 'Mouth: Shocked oval',
          variant08: 'Mouth: Slight line',
          variant09: 'Mouth: Straight line',
          variant10: 'Mouth: Puffed pout',
          variant11: 'Mouth: Tensed line',
          variant12: 'Mouth: Playful protrusion',
          variant13: 'Mouth: Distorted surprise',
          variant14: 'Mouth: Awkward oval',
          variant15: 'Mouth: Spacious oval',
          variant16: 'Mouth: Playful tongue-out',
          variant17: 'Mouth: Subtle expression',
          variant18: 'Mouth: O-shaped surprise',
          variant19: 'Mouth: Curious line',
          variant20: 'Mouth: Pouty hint',
          variant21: 'Mouth: Tiny tease',
          variant22: 'Mouth: Mischievous twist',
          variant23: 'Mouth: Grinning gap',
          variant24: 'Mouth: Hearted surprise',
          variant25: 'Mouth: Gleeful grin',
          variant26: 'Mouth: Joyful arch',
          variant27: 'Mouth: Excited line',
          variant28: 'Mouth: Joyful beam',
          variant29: 'Mouth: Quirky twist',
          variant30: 'Mouth: Joyful triangle'
        };
        
        const browLabels = {
          variant01: 'Brows: Boldly Angled',
          variant02: 'Brows: Fiercely Slanted',
          variant03: 'Brows: Subtle Arch',
          variant04: 'Brows: Slightly Curved',
          variant05: 'Brows: Quirky Flick',
          variant06: 'Brows: Playfully Raised',
          variant07: 'Brows: Subdued Lift',
          variant08: 'Brows: Mildly Furrowed',
          variant09: 'Brows: Mildly Arched',
          variant10: 'Brows: Gently Straightened',
          variant11: 'Brows: Slightly Drooped',
          variant12: 'Brows: Softly Straightened',
          variant13: 'Brows: Subtly Defined',
          variant14: 'Brows: Lightly Tapered',
          variant15: 'Brows: Playfully Asymmetrical'
        };
        
        const glassesLabels = {
          '': 'None',
          variant01: 'Glasses: Round',
          variant02: 'Glasses: Square',
          variant03: 'Glasses: Thin',
          variant04: 'Glasses: Thick',
          variant05: 'Glasses: Cat‑eye'
        };
        
        const earringsLabels = {
          '': 'None',
          variant01: 'Earrings: Studs',
          variant02: 'Earrings: Hoops',
          variant03: 'Earrings: Drops',
          variant04: 'Earrings: Small Hoops',
          variant05: 'Earrings: Bars',
          variant06: 'Earrings: Stars'
        };
        
        const hairStyleNames = {
          short01: 'Short: Fluffy layers',
          short02: 'Short: Playful bangs',
          short03: 'Short: Bouncy curls',
          short04: 'Short: Tapered edges',
          short05: 'Short: Top Knot',
          short06: 'Short: Asymmetrical swoop',
          short07: 'Short: Whimsical waves',
          short08: 'Short: Spiraled tufts',
          short09: 'Short: Flared spikes',
          short10: 'Short: Defined bob',
          short11: 'Short: Sleek pompadour',
          short12: 'Short: Bold streak',
          short13: 'Short: Sleek crop',
          short14: 'Short: Bold quiff',
          short15: 'Short: Spiky flair',
          short16: 'Short: Wild spikes',
          short17: 'Short: Textured tufts',
          short18: 'Short: Quirky tufts',
          short19: 'Short: Smoothly cropped',
          long01: 'Long: Sleek sweep',
          long02: 'Long: Playful tousle',
          long03: 'Long: Floral crown',
          long04: 'Long: Angular strands',
          long05: 'Long: Softly rounded',
          long06: 'Long: Lush tendrils',
          long07: 'Long: Choppy fringes',
          long08: 'Long: Floral fringe',
          long09: 'Long: Flowing layers',
          long10: 'Long: Spirited ponytail',
          long11: 'Long: Playful top-knot',
          long12: 'Long: Subtle bob',
          long13: 'Long: Twisted buns',
          long14: 'Long: Double ponytails',
          long15: 'Long: Playful pigtails',
          long16: 'Long: Braided charm',
          long17: 'Long: Playful curls',
          long18: 'Long: Charming waves',
          long19: 'Long: Sleek ponytail',
          long20: 'Long: Angular sweep',
          long21: 'Long: Curved strands',
          long22: 'Long: Lively volume',
          long23: 'Long: Playful buns',
          long24: 'Long: Lively bounce',
          long25: 'Long: Sleek asymmetry',
          long26: 'Long: Vibrant fringes'
        };
        
        const hairColorNames = {
          '0e0e0e': 'Black',
          'e5d7a3': 'Blonde',
          '9e5622': 'Brown',
          '763900': 'Dark Brown',
          'cb6820': 'Red',
          'ac6511': 'Copper',
          'b9a05f': 'Sandy',
          '796a45': 'Ash Brown',
          '6a4e35': 'Chestnut',
          '562306': 'Dark Chestnut',
          'afafaf': 'Grey',
          '3eac2c': 'Green',
          '85c2c6': 'Teal',
          'dba3be': 'Pink',
          '592454': 'Plum'
        };
        
        const featureLabels = {
          'mustache': 'Facial Hair',
          'blush': 'Rosy Cheeks', 
          'birthmark': 'Beauty Mark',
          'freckles': 'Freckles'
        };
        
        const skinColorNames = {
          'f2d3b1': 'Fair',
          'ecad80': 'Tan',
          '9e5622': 'Brown',
          '763900': 'Dark Brown'
        };
        
        function labelFromVariant(prefix, v, map) {
          if (map && map[v]) return map[v];
          const sv = String(v);
          if (sv.startsWith('variant')) {
            const n = parseInt(sv.slice(7), 10);
            const num = isNaN(n) ? sv.replace('variant', '') : n;
            return `${prefix} Style ${num}`;
          }
          return `${prefix} ${sv}`;
        }
        
        function hairLabel(key) {
          return hairStyleNames[key] || String(key);
        }
        
        // Fill all dropdowns with options
        // Eye features
        const eyes = Array.from({ length: 26 }, (_, i) => `variant${pad2(i + 1)}`);
        const mouths = Array.from({ length: 30 }, (_, i) => `variant${pad2(i + 1)}`);
        const brows = Array.from({ length: 15 }, (_, i) => `variant${pad2(i + 1)}`);
        const glasses = Array.from({ length: 5 }, (_, i) => `variant${pad2(i + 1)}`);
        const earrings = Array.from({ length: 6 }, (_, i) => `variant${pad2(i + 1)}`);
        const features = ['mustache', 'blush', 'birthmark', 'freckles'];
        const hair = [
          ...Array.from({ length: 19 }, (_, i) => `short${pad2(i + 1)}`),
          ...Array.from({ length: 26 }, (_, i) => `long${pad2(i + 1)}`)
        ];
        const hairColors = ['ac6511', 'cb6820', 'ab2a18', 'e5d7a3', 'b9a05f', '796a45', '6a4e35', '562306', '9e5622', '763900', '0e0e0e', 'afafaf', '3eac2c', '85c2c6', 'dba3be', '592454'];
        const skinColors = ['f2d3b1', 'ecad80', '9e5622', '763900'];
        
        // Fill dropdowns
        fillOptsLabeled(document.getElementById('opt-eyes'), eyes, v => labelFromVariant('Eyes', v, eyeLabels), true);
        fillOptsLabeled(document.getElementById('opt-mouth'), mouths, v => labelFromVariant('Mouth', v, mouthLabels), true);
        fillOptsLabeled(document.getElementById('opt-eyebrows'), brows, v => labelFromVariant('Brows', v, browLabels), true);
        fillOptsLabeled(document.getElementById('opt-glasses'), ['', 'variant01', 'variant02', 'variant03', 'variant04', 'variant05'], v => glassesLabels[v] || labelFromVariant('Glasses', v, {}), false);
        fillOpts(document.getElementById('opt-glassesProbability'), rangeArr(0, 100, 10), true);
        fillOptsLabeled(document.getElementById('opt-earrings'), ['', 'variant01', 'variant02', 'variant03', 'variant04', 'variant05', 'variant06'], v => earringsLabels[v] || labelFromVariant('Earrings', v, {}), false);
        fillOpts(document.getElementById('opt-earringsProbability'), rangeArr(0, 100, 10), true);
        
        // Features (multi-select)
        const featuresEl = document.getElementById('opt-features');
        if (featuresEl) {
          featuresEl.innerHTML = '';
          // Add explicit None option at the top
          featuresEl.appendChild(new Option('None', ''));
          for (const v of features) {
            const label = featureLabels[v] || v;
            featuresEl.appendChild(new Option(label, v));
          }
        }
        fillOpts(document.getElementById('opt-featuresProbability'), rangeArr(0, 100, 5), true);
        
        // Hair and skin
        fillOptsLabeled(document.getElementById('opt-hair'), [''].concat(hair), v => (v ? hairLabel(v) : 'Default'), false);
        fillOptsLabeled(document.getElementById('opt-hairColor'), [''].concat(hairColors), hex => (hex ? (hairColorNames[hex] ? `${hairColorNames[hex]} (${hex})` : hex) : 'Default'), false);
        fillOpts(document.getElementById('opt-hairProbability'), rangeArr(0, 100, 10), true);
        fillOptsLabeled(document.getElementById('opt-skinColor'), [''].concat(skinColors), hex => (hex ? (skinColorNames[hex] ? `${skinColorNames[hex]} (${hex})` : hex) : 'Default'), false);
        
        // Bind events to all controls
        const ids = [
          'opt-eyes', 'opt-mouth', 'opt-eyebrows', 'opt-glasses', 'opt-glassesProbability',
          'opt-earrings', 'opt-earringsProbability', 'opt-featuresProbability',
          'opt-hair', 'opt-hairColor', 'opt-hairProbability', 'opt-skinColor'
        ];
        
        // Bind change events to update preview
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener('change', updateAvatarPreview);
          }
        });
        
        // Special handling for multi-select features
        const featuresMulti = document.getElementById('opt-features');
        if (featuresMulti) {
          featuresMulti.addEventListener('change', () => {
            // Mutual exclusivity between 'None' and other selections
            const noneOpt = Array.from(featuresMulti.options).find(o => o.value === '');
            const realSelected = Array.from(featuresMulti.selectedOptions).filter(o => o.value);
            if (noneOpt && noneOpt.selected && realSelected.length) {
              // If any real selected, unselect None
              noneOpt.selected = false;
            } else if (noneOpt && noneOpt.selected && !realSelected.length) {
              // None selected alone — clear probabilities
              const prob = document.getElementById('opt-featuresProbability');
              if (prob) prob.value = '';
            }
            if (realSelected.length && noneOpt && noneOpt.selected === false) {
              // Ensure probability defaults when real selections exist
              const prob = document.getElementById('opt-featuresProbability');
              if (prob && (!prob.value || prob.value === '0')) prob.value = '100';
            }
            updateAvatarPreview();
          });
        }

        // Auto-set probabilities to 100 when an accessory/feature is chosen
        function autoProb(sourceId, probId) {
          const src = document.getElementById(sourceId);
          const prob = document.getElementById(probId);
          if (!src || !prob) return;
          const handler = () => {
            const has = src.multiple
              ? Array.from(src.selectedOptions || []).filter(o=>o.value).length > 0
              : !!src.value;
            if (has && (!prob.value || prob.value === '0')) {
              prob.value = '100';
            }
            if (!has && prob.value) {
              prob.value = '';
            }
          };
          src.addEventListener('change', handler);
          // Run once to sync defaults
          handler();
        }
        autoProb('opt-glasses', 'opt-glassesProbability');
        autoProb('opt-earrings', 'opt-earringsProbability');
        autoProb('opt-features', 'opt-featuresProbability');
      }
      
  // Initialize dropdown values
  fillDropdowns();

  // Expose builders globally so other handlers can use them safely
  window.buildAvatarUrlFromControls = buildAvatarUrlFromControls;
  window.updateAvatarPreview = updateAvatarPreview;

  // Initialize preview URL immediately so Continue works without Randomize
  try { 
    console.log('Initial avatar preview initialization');
    // Give dropdowns time to populate before initializing preview
    setTimeout(() => {
      updateAvatarPreview();
      console.log('Initial avatar preview complete');
    }, 300);
  } catch (e) {
    console.error('Error initializing avatar preview:', e);
  }
      
      // ---------- New: render friendly option buttons for several selects ----------
      const makeOptionButtons = (selectId, opts, renderFn, hideSelect = false) => {
        const sel = document.getElementById(selectId);
        if (!sel) return null;
        // create container after select
        const container = document.createElement('div');
        container.className = 'option-buttons';
        // optionally hide the native select (keep it in DOM for state)
        if (hideSelect) sel.classList.add('select-hidden');
        // For each option create a button
        const values = opts || Array.from(sel.options || []).map(o=> ({ v: o.value, t: o.text }));
        // If opts is provided as array of values, normalize
        const norm = values.map(x => (typeof x === 'string' || typeof x === 'number') ? { v: String(x), t: String(x) } : x);
        norm.forEach(item => {
          // skip empty values (use default behavior)
          if (!item.v || item.v === '') return;
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'option-btn';
          btn.dataset.value = item.v;
          // render content via renderFn or fallback
          if (renderFn) btn.appendChild(renderFn(item)); else btn.textContent = item.t || item.v;
          // click behavior: select corresponding option in native select and trigger input
          btn.addEventListener('click', (e)=>{
            e.preventDefault();
            // handle single vs multi
            if (sel.multiple){
              const opt = Array.from(sel.options).find(o=>String(o.value)===String(item.v));
              if (opt) opt.selected = !opt.selected;
              btn.classList.toggle('selected', !!opt && opt.selected);
            } else {
              // clear other buttons
              container.querySelectorAll('.option-btn').forEach(b=> b.classList.remove('selected'));
              btn.classList.add('selected');
              // set select value
              sel.value = item.v;
            }
            // dispatch input event
            sel.dispatchEvent(new Event('input', { bubbles:true }));
            sel.dispatchEvent(new Event('change', { bubbles:true }));
          });
          container.appendChild(btn);
        });
        // insert container after select
        sel.parentNode.insertBefore(container, sel.nextSibling);

        // Initialize selected state from select value(s)
        const syncFromSelect = () => {
          const vals = sel.multiple ? Array.from(sel.selectedOptions).map(o=>String(o.value)) : [String(sel.value)];
          container.querySelectorAll('.option-btn').forEach(b=>{
            const v = String(b.dataset.value);
            b.classList.toggle('selected', vals.includes(v));
          });
        };
        // initial sync
        syncFromSelect();
        // keep in sync if select changes externally
        sel.addEventListener('change', syncFromSelect);
        return container;
      };

      // Helper renderers
      const swatchRenderer = (hex) => {
        const span = document.createElement('span');
        span.className = 'option-swatch';
        span.style.background = `#${hex.v}`;
        span.title = hex.t || hex.v;
        return span;
      };
      const textRenderer = (item) => {
        const span = document.createElement('span');
        span.textContent = item.t || item.v;
        return span;
      };

      // Render hair color as swatch buttons with special handling
      try {
        const hairColorSelect = document.getElementById('opt-hairColor');
        if (hairColorSelect) {
          const hairColorOpts = Array.from(hairColorSelect.options||[]).map(o=> ({ v:o.value, t:o.text }));
          const container = makeOptionButtons('opt-hairColor', hairColorOpts, swatchRenderer, true);
          
          if (container) {
            // Add extra handling to ensure hair color changes update the preview
            container.querySelectorAll('.option-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                const colorValue = this.dataset.value;
                console.log('Hair color swatch clicked:', colorValue);
                
                // Wait briefly to ensure the value is set in the select
                setTimeout(() => {
                  console.log('Verifying hair color was applied:', hairColorSelect.value);
                  updateAvatarPreview();
                }, 50);
              });
            });
          }
        }
      } catch (e) { console.warn('Hair color option button render failed:', e); }

      // ---- Skin tone swatches (like hair) ----
      const SKIN_SWATCH_MAP = {
        // Fallback mapping for named tokens -> hex (used if options aren't hex already)
        pale: 'F2D3B1', light: 'EBC7A8', peach: 'F2C1A0', tan: 'D39D6E',
        bronze: 'B97A57', brown: '8D5524', mocha: '6D4C41', dark: '5C3B1E',
        ebony: '3B2F2F'
      };

      function buildSkinSwatches(){
        const select = document.getElementById('opt-skinColor');
        const wrap = document.getElementById('skin-swatch-buttons');
        if (!select || !wrap) return;

        // Avoid rebuilding
        if (wrap.dataset.built === '1') return;

        const options = Array.from(select.options || []).map(o => o.value).filter(Boolean);
        if (!options.length) return; // wait until options are populated

        wrap.innerHTML = '';

        const normalizeHex = (v) => {
          const hex = v.replace('#','');
          if (/^[0-9a-fA-F]{3}$/.test(hex)) return hex; // allow 3-char
          if (/^[0-9a-fA-F]{6}$/.test(hex)) return hex;
          return SKIN_SWATCH_MAP[v] || null;
        };

        options.forEach(v => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'option-btn';
          btn.dataset.value = v;

          const sw = document.createElement('div');
          sw.className = 'option-swatch';
          const hex = normalizeHex(v);
          if (hex) sw.style.background = `#${hex}`;
          else sw.style.background = 'linear-gradient(45deg,#e5e7eb,#cbd5e1)'; // neutral fallback

          btn.appendChild(sw);

          btn.addEventListener('click', () => {
            // visual state
            wrap.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            // set select value so existing code keeps working
            select.value = v;
            // trigger change for any listeners
            select.dispatchEvent(new Event('change', { bubbles: true }));
            updateAvatarPreview();
          });

          if (select.value === v) btn.classList.add('selected');
          wrap.appendChild(btn);
        });

        // Hide the select (already has select-hidden class in HTML), but keep it in DOM for code paths
        select.classList.add('select-hidden');

        // Keep swatch selection synced if value changes elsewhere (AI fill, etc.)
        select.addEventListener('change', () => {
          const val = select.value;
          wrap.querySelectorAll('.option-btn').forEach(b => b.classList.toggle('selected', b.dataset.value === val));
        });

        wrap.dataset.built = '1';
      }

      function ensureSkinSwatchesReady(){
        const select = document.getElementById('opt-skinColor');
        if (!select) return;
        if (select.options && select.options.length > 0) {
          buildSkinSwatches();
          return;
        }
        // Wait until something populates the select
        const mo = new MutationObserver(() => {
          if (select.options.length > 0) { buildSkinSwatches(); mo.disconnect(); }
        });
        mo.observe(select, { childList: true });
      }

      // Kick off once the page has loaded the controls
      ensureSkinSwatchesReady();
      
      // Randomize button
      document.getElementById('avatar-randomize')?.addEventListener('click', () => {
        // Randomly set values
        const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const eyes = Array.from({ length: 26 }, (_, i) => `variant${i < 10 ? '0' + (i+1) : (i+1)}`);
        const mouths = Array.from({ length: 30 }, (_, i) => `variant${i < 10 ? '0' + (i+1) : (i+1)}`);
        const brows = Array.from({ length: 15 }, (_, i) => `variant${i < 10 ? '0' + (i+1) : (i+1)}`);
        const hair = [
          ...Array.from({ length: 19 }, (_, i) => `short${i < 10 ? '0' + (i+1) : (i+1)}`),
          ...Array.from({ length: 26 }, (_, i) => `long${i < 10 ? '0' + (i+1) : (i+1)}`)
        ];
        const hairColors = ['ac6511', 'cb6820', 'ab2a18', 'e5d7a3', 'b9a05f', '796a45', '6a4e35', '562306', '9e5622', '763900', '0e0e0e', 'afafaf', '3eac2c', '85c2c6', 'dba3be', '592454'];
        const skinColors = ['f2d3b1', 'ecad80', '9e5622', '763900'];
        const rangeArr = (start, end, step = 1) => Array.from({ length: Math.floor((end - start) / step) + 1 }, (_, i) => start + (i * step));
        
        document.getElementById('opt-eyes').value = pick(eyes);
        document.getElementById('opt-mouth').value = pick(mouths);
        document.getElementById('opt-eyebrows').value = pick(brows);
        document.getElementById('opt-glasses').value = pick(['', 'variant01', 'variant02', 'variant03', 'variant04', 'variant05']);
        document.getElementById('opt-glassesProbability').value = pick(rangeArr(0, 100, 10));
        document.getElementById('opt-earrings').value = pick(['', 'variant01', 'variant02', 'variant03', 'variant04', 'variant05', 'variant06']);
        document.getElementById('opt-earringsProbability').value = pick(rangeArr(0, 100, 10));
        document.getElementById('opt-hair').value = pick(hair);
        document.getElementById('opt-hairColor').value = pick(hairColors);
        document.getElementById('opt-hairProbability').value = pick(rangeArr(0, 100, 10));
        document.getElementById('opt-skinColor').value = pick(skinColors);
        
        // Update the option button selection to match the new values
        const skinValue = document.getElementById('opt-skinColor').value;
        const hairValue = document.getElementById('opt-hairColor').value;
        
        // Update skin swatch selection
        const skinSwatches = document.querySelectorAll('#skin-swatch-buttons .option-btn');
        skinSwatches.forEach(swatch => {
          swatch.classList.remove('selected');
          if (swatch.dataset.value === skinValue) {
            swatch.classList.add('selected');
          }
        });
        
        // Update hair swatch selection - this will be handled by the makeOptionButtons change listener automatically
        
        // Randomly select features
        const fEl = document.getElementById('opt-features');
        const features = ['mustache', 'blush', 'birthmark', 'freckles'];
        for (const o of Array.from(fEl.options)) o.selected = false;
        // Randomly pick up to 2 features
        const pool = [...features];
        for (let i = 0; i < Math.floor(Math.random() * 3); i++) {
          const idx = Math.floor(Math.random() * pool.length);
          const val = pool.splice(idx, 1)[0];
          const opt = Array.from(fEl.options).find(o => o.value === val);
          if (opt) opt.selected = true;
        }
        
        // Update preview
        updateAvatarPreview();
        
        // Show confirmation
        const saveMsg = document.getElementById('avatar-save-msg');
        if (saveMsg) {
          saveMsg.textContent = '✅ Avatar randomized! Click Continue to save.';
        }
      });
      
      // AI Generator
      document.getElementById('avatar-ai-generate')?.addEventListener('click', async () => {
        const prompt = document.getElementById('avatarPrompt')?.value;
        if (!prompt) {
          const msg = document.getElementById('avatar-ai-msg');
          if (msg) msg.textContent = '⚠️ Please enter a description first (e.g., "friendly nurse with brown hair")';
          return;
        }
        
        const msg = document.getElementById('avatar-ai-msg');
        if (msg) {
          msg.innerHTML = '🤖 AI is generating your avatar... <span style="opacity:0.7">(this may take a few seconds)</span>';
        }
        
        // This would typically call an AI generation endpoint
        // For now, simulate with randomization and delayed response
        const aiBtn = document.getElementById('avatar-ai-generate');
        if (aiBtn) {
          aiBtn.disabled = true;
          aiBtn.textContent = 'Generating...';
        }
        
        try {
          // Simulate AI processing time
          await new Promise(resolve => setTimeout(resolve, 2500));
          
          // Simulate a generated avatar by randomizing features based on prompt
          const lowerPrompt = prompt.toLowerCase();
          
          // Simulate AI-based choices (could be replaced with real AI generation)
          let skinTone = 'f2d3b1'; // default fair
          if (lowerPrompt.includes('dark skin') || lowerPrompt.includes('dark complexion')) {
            skinTone = '763900';
          } else if (lowerPrompt.includes('brown skin') || lowerPrompt.includes('brown complexion')) {
            skinTone = '9e5622';
          } else if (lowerPrompt.includes('tan') || lowerPrompt.includes('olive')) {
            skinTone = 'ecad80';
          }
          
          let hairStyle = 'short01';
          if (lowerPrompt.includes('long hair')) {
            hairStyle = 'long' + (Math.floor(Math.random() * 26) + 1).toString().padStart(2, '0');
          } else if (lowerPrompt.includes('short hair')) {
            hairStyle = 'short' + (Math.floor(Math.random() * 19) + 1).toString().padStart(2, '0');
          }
          
          let hairColor = '0e0e0e'; // default black
          if (lowerPrompt.includes('blonde') || lowerPrompt.includes('yellow hair')) {
            hairColor = 'e5d7a3';
          } else if (lowerPrompt.includes('red hair') || lowerPrompt.includes('ginger')) {
            hairColor = 'cb6820';
          } else if (lowerPrompt.includes('brown hair')) {
            hairColor = '9e5622';
          } else if (lowerPrompt.includes('grey hair') || lowerPrompt.includes('gray hair')) {
            hairColor = 'afafaf';
          }
          
          // Apply "AI-generated" options to form controls
          document.getElementById('opt-skinColor').value = skinTone;
          document.getElementById('opt-hair').value = hairStyle;
          document.getElementById('opt-hairColor').value = hairColor;
          
          // Update the option button selection to match the new values - change events will handle the synchronization
          
          // Add glasses if mentioned
          if (lowerPrompt.includes('glasses') || lowerPrompt.includes('spectacles')) {
            document.getElementById('opt-glasses').value = 'variant' + (Math.floor(Math.random() * 5) + 1).toString().padStart(2, '0');
            document.getElementById('opt-glassesProbability').value = '100';
          }
          
          // Add features if mentioned
          const featuresEl = document.getElementById('opt-features');
          for (const opt of Array.from(featuresEl.options)) {
            opt.selected = false;
          }
          
          if (lowerPrompt.includes('freckles')) {
            const frecklesOpt = Array.from(featuresEl.options).find(o => o.value === 'freckles');
            if (frecklesOpt) frecklesOpt.selected = true;
          }
          
          if (lowerPrompt.includes('facial hair') || lowerPrompt.includes('mustache') || lowerPrompt.includes('beard')) {
            const mustacheOpt = Array.from(featuresEl.options).find(o => o.value === 'mustache');
            if (mustacheOpt) mustacheOpt.selected = true;
          }
          
          // Update preview
          updateAvatarPreview();
          
          // Show success message
          if (msg) {
            msg.innerHTML = '✅ Success! Adjust with settings below or click Continue to save.';
          }
          
          // Animate the preview to draw attention
          const preview = document.getElementById('avatarPreview');
          if (preview) {
            preview.style.transform = 'scale(1.05)';
            setTimeout(() => {
              preview.style.transform = 'scale(1)';
              preview.style.transition = 'transform 0.3s ease';
            }, 300);
          }
          
        } catch (e) {
          console.error('AI generation error:', e);
          if (msg) {
            msg.innerHTML = '❌ Generation failed. Please try again or use the randomizer instead.';
          }
        } finally {
          if (aiBtn) {
            aiBtn.disabled = false;
            aiBtn.textContent = 'Generate with AI';
          }
        }
      });
    }

    // Working Pattern
  async function initWorkingPattern(session, profileRow, workType) {
      const container = document.getElementById('working-pattern-form');
      const note = document.getElementById('working-pattern-note');

      if (note) {
        note.textContent = workType === 'hours'
          ? 'Enter your typical working hours for each day in HH:MM (e.g., 07:30)'
          : 'Enter the number of sessions for each day (e.g., 1, 2)';
      }

      if (container) {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const renderForm = (type) => {
          container.innerHTML = days.map(day => {
            const id = type === 'hours' ? `pattern-hours-${day.toLowerCase()}` : `pattern-sessions-${day.toLowerCase()}`;
            const dayCol = `${day.toLowerCase()}_${type === 'hours' ? 'hours' : 'sessions'}`;
            const input = type === 'hours'
              ? `<input type="time" class="form-input" id="${id}" step="900" placeholder="00:00" data-table="3_staff_working_patterns" data-column="daily_hours" data-source="master_users.${dayCol}" />`
              : `<input type="number" class="form-input" id="${id}" min="0" max="10" step="1" placeholder="0" data-table="3_staff_working_patterns" data-column="daily_sessions" data-source="master_users.${dayCol}" />`;
            return `
              <div class="day-input-group">
                <label class="day-label">${day}</label>
                ${input}
              </div>
            `;
          }).join('');
        };

        // Initial render based on chosen type
        renderForm(workType);

        // Prefill priority:
        // 1) Use 3_staff_working_patterns if it exists and has values
        // 2) Fallback to master_users mirrors
        // 3) If HH:MM selected and still empty, default Mon–Fri to 07:30
        try {
          const [wpRes, muRes] = await Promise.all([
            supabase
              .from('3_staff_working_patterns')
              .select('monday_hours,tuesday_hours,wednesday_hours,thursday_hours,friday_hours,saturday_hours,sunday_hours,monday_sessions,tuesday_sessions,wednesday_sessions,thursday_sessions,friday_sessions,saturday_sessions,sunday_sessions')
              .eq('user_id', session.user.id)
              .maybeSingle(),
            supabase
              .from('master_users')
              .select('weekly_hours,weekly_sessions,monday_hours,tuesday_hours,wednesday_hours,thursday_hours,friday_hours,saturday_hours,sunday_hours,monday_sessions,tuesday_sessions,wednesday_sessions,thursday_sessions,friday_sessions,saturday_sessions,sunday_sessions,is_gp')
              .eq('auth_user_id', session.user.id)
              .maybeSingle()
          ]);

          const wp = wpRes?.data || null;
          const mu = muRes?.data || null;
          const dkeys = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];

          const wpHasAnyHours = !!wp && dkeys.some(d => !!(wp[`${d}_hours`] && String(wp[`${d}_hours`]).length));
          const wpHasAnySessions = !!wp && dkeys.some(d => (wp[`${d}_sessions`] || 0) > 0);
          const muHasAnyHours = !!mu && dkeys.some(d => (mu[`${d}_hours`] || 0) > 0);
          const muHasAnySessions = !!mu && dkeys.some(d => (mu[`${d}_sessions`] || 0) > 0);

          // Determine savedType unless user explicitly chose in this visit
          let savedType = workType;
          if (window.currentWorkType) {
            savedType = window.currentWorkType;
          } else if (wpHasAnySessions && !wpHasAnyHours) {
            savedType = 'sessions';
          } else if (wpHasAnyHours) {
            savedType = 'hours';
          } else if (mu?.is_gp === true || (!muHasAnyHours && muHasAnySessions)) {
            savedType = 'sessions';
          } else if (mu?.is_gp === false || muHasAnyHours) {
            savedType = 'hours';
          }

          if (savedType !== workType) {
            renderForm(savedType);
            workType = savedType;
            window.currentWorkType = savedType;
            // Sync radios and card selection
            const hoursRadio = document.getElementById('work-type-hours');
            const sessionsRadio = document.getElementById('work-type-sessions');
            if (hoursRadio && sessionsRadio) {
              hoursRadio.checked = savedType === 'hours';
              sessionsRadio.checked = savedType === 'sessions';
              document.querySelectorAll('.working-type-card').forEach(c => c.classList.remove('selected'));
              const card = document.querySelector(`.working-type-card[data-type="${savedType}"]`);
              if (card) card.classList.add('selected');
            }
            if (note) {
              note.textContent = savedType === 'hours'
                ? 'Enter your typical working hours for each day in HH:MM (e.g., 07:30)'
                : 'Enter the number of sessions for each day (e.g., 1, 2)';
            }
          }

          // Helper to convert decimal hours back to HH:MM
          const decimalToHHMM = (decimal) => {
            if (!decimal || decimal === 0) return '';
            const hours = Math.floor(decimal);
            const minutes = Math.round((decimal - hours) * 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
          };

          let prefilled = false;
          if (workType === 'hours') {
            if (wpHasAnyHours) {
              // Prefer exact HH:MM values from working_patterns
              for (const d of dkeys) {
                const el = document.getElementById(`pattern-hours-${d}`);
                const v = wp?.[`${d}_hours`] || '';
                if (el && v) el.value = v;
              }
              prefilled = true;
            } else if (muHasAnyHours) {
              for (const d of dkeys) {
                const el = document.getElementById(`pattern-hours-${d}`);
                const dec = mu?.[`${d}_hours`];
                if (el && dec) el.value = decimalToHHMM(dec);
              }
              prefilled = true;
            }

            // Default Mon–Fri 07:30 if not prefilled at all
            if (!prefilled) {
              const weekdays = ['monday','tuesday','wednesday','thursday','friday'];
              for (const d of weekdays) {
                const el = document.getElementById(`pattern-hours-${d}`);
                if (el && !el.value) el.value = '07:30';
              }
              // Leave weekends blank by default
            }
          } else {
            // Sessions path
            if (wpHasAnySessions) {
              for (const d of dkeys) {
                const el = document.getElementById(`pattern-sessions-${d}`);
                const v = wp?.[`${d}_sessions`];
                if (el && (v || v === 0)) el.value = v;
              }
            } else if (muHasAnySessions) {
              for (const d of dkeys) {
                const el = document.getElementById(`pattern-sessions-${d}`);
                const v = mu?.[`${d}_sessions`];
                if (el && (v || v === 0)) el.value = v;
              }
            }
          }
        } catch (e) {
          console.warn('Could not prefill working pattern:', e);
        }
      }
    }

    async function saveWorkingPattern(session, profileRow) {
      try {
        const workType = window.currentWorkType || document.querySelector('input[name="work-type"]:checked')?.value || 'hours';
        const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];

        // Build payload for 3_staff_working_patterns
        const payload = { updated_at: new Date().toISOString() };
        if (profileRow?.site_id) payload.site_id = profileRow.site_id;

        if (workType === 'hours') {
          // Collect HH:MM strings
          for (const d of days) {
            const el = document.getElementById(`pattern-hours-${d}`) || document.getElementById(`pattern-hours-${d.toLowerCase()}`);
            const val = (el && el.value) ? el.value : '';
            // Store as character varying(5) e.g., 07:30 or null if blank
            payload[`${d}_hours`] = val && /\d{2}:\d{2}/.test(val) ? val : null;
            payload[`${d}_sessions`] = 0; // ensure defined
          }
        } else {
          // Collect integer sessions
          for (const d of days) {
            const el = document.getElementById(`pattern-sessions-${d}`) || document.getElementById(`pattern-sessions-${d.toLowerCase()}`);
            const n = el && el.value !== '' ? parseInt(el.value, 10) : 0;
            payload[`${d}_sessions`] = Number.isFinite(n) ? n : 0;
            payload[`${d}_hours`] = null;
          }
        }

        // Upsert row in 3_staff_working_patterns for this user
        const userId = session.user.id;
        // Try to find existing row
        const { data: existing } = await supabase
          .from('3_staff_working_patterns')
          .select('id')
          .eq('user_id', userId)
          .maybeSingle();

        if (existing && existing.id) {
          await supabase
            .from('3_staff_working_patterns')
            .update(payload)
            .eq('id', existing.id);
        } else {
          await supabase
            .from('3_staff_working_patterns')
            .insert([{ user_id: userId, ...payload }]);
        }

        // Compute weekly totals for entitlement
        let weeklyHours = 0;
        let weeklySessions = 0;
        if (workType === 'hours') {
          for (const d of days) {
            const hhmm = payload[`${d}_hours`];
            if (hhmm && /\d{2}:\d{2}/.test(hhmm)) {
              const [h, m] = hhmm.split(':').map(Number);
              weeklyHours += (h || 0) + (m || 0) / 60;
            }
          }
        } else {
          for (const d of days) weeklySessions += payload[`${d}_sessions`] || 0;
        }

        // Resolve staff_id (master_users.id) for entitlements
        let staffId = null;
        try {
          const { data: mu } = await supabase
            .from('master_users')
            .select('id')
            .eq('auth_user_id', userId)
            .maybeSingle();
          staffId = mu?.id || null;
        } catch {}

        if (staffId) {
          const year = new Date().getFullYear();
          const entitlement = {
            staff_id: staffId,
            year,
            multiplier: 6,
            weekly_hours: workType === 'hours' ? Number(weeklyHours.toFixed(2)) : null,
            weekly_sessions: workType === 'sessions' ? weeklySessions : null
          };
          // Upsert into 2_staff_entitlements on staff_id,year
          await supabase
            .from('2_staff_entitlements')
            .upsert(entitlement, { onConflict: 'staff_id,year' });
        }

        // Also mirror key values into master_users for compatibility
        try {
          const muUpdate = { updated_at: new Date().toISOString() };

          // Convert HH:MM to decimal hours helper
          const hhmmToDecimal = (hhmm) => {
            if (!hhmm || !/\d{2}:\d{2}/.test(hhmm)) return 0;
            const [h, m] = hhmm.split(':').map(Number);
            return (h || 0) + (m || 0) / 60;
          };

          if (workType === 'hours') {
            // Weekly totals
            muUpdate.weekly_hours = Number(weeklyHours.toFixed(2));
            muUpdate.weekly_sessions = 0;
            // Per-day mirrors (decimals)
            for (const d of days) {
              const dec = hhmmToDecimal(payload[`${d}_hours`] || null);
              muUpdate[`${d}_hours`] = Number(dec.toFixed(2));
              muUpdate[`${d}_sessions`] = 0;
            }
            // Mark role hint if present
            muUpdate.is_gp = false;
          } else {
            muUpdate.weekly_sessions = weeklySessions;
            muUpdate.weekly_hours = 0;
            for (const d of days) {
              const sess = Number(payload[`${d}_sessions`] || 0);
              muUpdate[`${d}_sessions`] = sess;
              muUpdate[`${d}_hours`] = 0;
            }
            muUpdate.is_gp = true;
          }

          await supabase
            .from('master_users')
            .update(muUpdate)
            .eq('auth_user_id', session.user.id);
        } catch (e) {
          console.warn('master_users mirror update warning:', e);
        }

      } catch (error) {
        console.error('Error saving working pattern:', error);
      }
    }
  </script>
<!-- Staff Profile Fix -->
<script src="staff-profile-fix.js"></script>
  
</body>
</html>

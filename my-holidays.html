<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop â€” My Holidays</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://img.icons8.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <link rel="stylesheet" href="staff.css">
  <style>
    .holiday-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid rgba(148,163,184,0.15);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 8px 25px rgba(15,23,42,0.08);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), #8b5cf6);
    }

    .stat-label {
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 900;
      color: var(--ink);
      line-height: 1;
    }

    .stat-unit {
      font-size: 16px;
      font-weight: 600;
      color: #94a3b8;
      margin-left: 4px;
    }

    .booking-form {
      background: white;
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 16px;
      align-items: end;
      margin-bottom: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: #334155;
    }

    .form-input {
      padding: 10px 14px;
      border: 1px solid rgba(15,23,42,0.12);
      border-radius: 10px;
      font-size: 14px;
      background: #fbfdff;
    }

    .booking-list {
      margin-top: 30px;
    }

    .booking-item {
      background: white;
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .booking-dates {
      font-weight: 600;
      color: var(--ink);
    }

    .booking-status {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-approved {
      background: #d1fae5;
      color: #065f46;
    }

    .status-rejected {
      background: #fee2e2;
      color: #991b1b;
    }

    .hours-display {
      color: #6b7280;
      font-size: 14px;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 12px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transition: width 0.3s ease;
    }

    .bubble-actions {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px 0;
    }

    .bubble {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
      background: white;
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 16px;
      text-decoration: none;
      color: var(--ink);
      transition: all 0.3s ease;
      min-width: 100px;
    }

    .bubble:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(15,23,42,0.15);
    }

    .bubble .i {
      margin-bottom: 8px;
    }

    .bubble .t {
      font-size: 14px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="topbar panel" id="top-bar">
    <div class="pills" style="display:flex; align-items:center; gap:8px;">
      <div class="pill" id="site-pill">Loading...</div>
      <div class="pill" id="email-pill">...</div>
      <div class="pill" id="role-pill">...</div>
    </div>
    <button id="logout-btn">Logout</button>
  </div>

  <main id="app">
    <!-- Navigation -->
    <div class="panel g-12" style="margin-bottom: 20px;">
      <div class="bubble-actions">
        <a class="bubble" href="staff.html">
          <div class="i c-blue"><img src="https://img.icons8.com/fluency/48/home.png" alt="Home"/></div>
          <div class="t">Home</div>
        </a>
        <a class="bubble" href="staff-scans.html">
          <div class="i c-purple"><img src="https://img.icons8.com/fluency/48/document.png" alt="My Scans"/></div>
          <div class="t">My Scans</div>
        </a>
        <a class="bubble" href="staff-training.html">
          <div class="i c-blue"><img src="https://img.icons8.com/fluency/48/graduation-cap.png" alt="Training"/></div>
          <div class="t">Training</div>
        </a>
        <a class="bubble" href="my-holidays.html" style="background: #f0f9ff;">
          <div class="i c-green"><img src="https://img.icons8.com/fluency/48/calendar.png" alt="My Holidays"/></div>
          <div class="t">My Holidays</div>
        </a>
        <a class="bubble" href="staff-quiz.html">
          <div class="i c-orange"><img src="https://img.icons8.com/fluency/48/puzzle.png" alt="Quiz"/></div>
          <div class="t">Quiz</div>
        </a>
      </div>
    </div>

    <section id="holidays" class="panel g-12">
      <div class="panel-header">
        <div class="panel-title">My Holiday Allowance</div>
      </div>

      <!-- Holiday Statistics -->
      <div class="holiday-stats">
        <div class="stat-card">
          <div class="stat-label">Total Allowance</div>
          <div>
            <span class="stat-value" id="total-allowance">0</span>
            <span class="stat-unit" id="allowance-unit">hours</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Used</div>
          <div>
            <span class="stat-value" id="used-holidays">0</span>
            <span class="stat-unit" id="used-unit">hours</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Remaining</div>
          <div>
            <span class="stat-value" id="remaining-holidays">0</span>
            <span class="stat-unit" id="remaining-unit">hours</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- Booking Form -->
      <div class="booking-form">
        <h3 style="margin-top:0; margin-bottom:20px; font-weight:700;">Request Time Off</h3>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">From Date</label>
            <input type="date" id="from-date" class="form-input" />
          </div>

          <div class="form-group">
            <label class="form-label">To Date</label>
            <input type="date" id="to-date" class="form-input" />
          </div>

          <button class="btn" id="calculate-btn" style="padding:10px 20px;">Calculate</button>
        </div>

        <div id="calculation-result" style="display:none; margin:16px 0; padding:16px; background:#f1f5f9; border-radius:10px;">
          <div style="font-weight:600; margin-bottom:8px;">Time Off Calculation:</div>
          <div id="calc-details" style="color:#64748b; font-size:14px;"></div>
          <div style="margin-top:12px; font-size:18px; font-weight:700;">
            Total: <span id="calc-total">0</span> <span id="calc-unit">hours</span>
          </div>
        </div>

        <div class="form-group" style="margin-top:16px;">
          <label class="form-label">Reason (optional)</label>
          <textarea id="reason" class="form-input" rows="3" placeholder="Holiday, personal time, etc."></textarea>
        </div>

        <button class="btn" id="submit-request" style="margin-top:16px; display:none;">Submit Request</button>
        <div id="request-msg" style="margin-top:12px; font-weight:600;"></div>
      </div>

      <!-- Bookings List -->
      <div class="booking-list">
        <h3 style="font-weight:700; margin-bottom:16px;">Your Holiday Requests</h3>
        <div id="bookings-container">
          <!-- Bookings will be loaded here -->
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, attachLogout } from './staff-common.js';

    (async function() {
      const supabase = await initSupabase();
      attachLogout(supabase);

      try {
        const { session, profileRow } = await requireStaffSession(supabase);
        const user = session.user;
        const siteId = profileRow?.site_id || 1;

        // Set topbar
        const roleDetail = profileRow?.role || user?.raw_user_meta_data?.role || 'Staff';
        setTopbar({
          siteText: await getSiteText(supabase, siteId),
          email: user.email,
          role: roleDetail.charAt(0).toUpperCase() + roleDetail.slice(1)
        });

        // Load holiday data
        async function loadHolidayData() {
          // Get holiday profile
          const { data: holidayProfile } = await supabase
            .from('1_staff_holiday_profiles')
            .select('*')
            .eq('email', user.email)
            .maybeSingle();

          if (!holidayProfile) {
            document.getElementById('holidays').innerHTML = `
              <div class="panel-header">
                <div class="panel-title">Holiday Setup Required</div>
              </div>
              <p>Please complete your welcome process first to set up your holiday allowance.</p>
              <button class="btn" onclick="window.location.href='staff-welcome.html'">Complete Setup</button>
            `;
            return;
          }

          // Get entitlements
          const currentYear = new Date().getFullYear();
          const { data: entitlement } = await supabase
            .from('2_staff_entitlements')
            .select('*')
            .eq('staff_id', holidayProfile.id)
            .eq('year', currentYear)
            .maybeSingle();

          if (!entitlement) {
            console.warn('No entitlement found for current year; using working pattern fallback.');
          }

          // Get working pattern
          const { data: workingPattern } = await supabase
            .from('3_staff_working_patterns')
            .select('*')
            .eq('user_id', user.id)
            .maybeSingle();

          window.workingPattern = workingPattern;
          window.isGP = holidayProfile.is_gp;

          // Display entitlements
          const isGP = holidayProfile.is_gp;

          // Calculate total allowance based on new structure:
          // Use override if present, otherwise calculate from weekly * multiplier
          let totalAllowance = 0;
          if (entitlement) {
            if (entitlement.override) {
              totalAllowance = entitlement.override;
            } else {
              const weekly = isGP ? entitlement.weekly_sessions : entitlement.weekly_hours;
              const multiplier = entitlement.multiplier || 6;
              totalAllowance = (weekly || 0) * multiplier;
            }
          } else {
            // Fallback to working pattern if available
            totalAllowance = window.workingPattern?.total_holiday_entitlement ?? 0;
          }

          // Get approved bookings for current year
          const { data: bookings } = await supabase
            .from('4_holiday_requests')
            .select('*')
            .eq('user_id', user.id)
            .gte('start_date', `${currentYear}-01-01`)
            .lte('start_date', `${currentYear}-12-31`)
            .eq('status', 'approved');

          const usedAmount = bookings?.reduce((sum, b) => sum + (b.total_days || 0), 0) || 0;
          const remaining = totalAllowance - usedAmount;

          // Helper function to format hours as HH:MM
          function formatHours(decimalHours) {
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours % 1) * 60);
            return `${hours}:${minutes.toString().padStart(2, '0')}`;
          }

          // Update display
          if (isGP) {
            document.getElementById('total-allowance').textContent = totalAllowance;
            document.getElementById('used-holidays').textContent = usedAmount;
            document.getElementById('remaining-holidays').textContent = remaining;
            document.getElementById('allowance-unit').textContent = 'sessions';
            document.getElementById('used-unit').textContent = 'sessions';
            document.getElementById('remaining-unit').textContent = 'sessions';
          } else {
            document.getElementById('total-allowance').textContent = formatHours(totalAllowance);
            document.getElementById('used-holidays').textContent = formatHours(usedAmount);
            document.getElementById('remaining-holidays').textContent = formatHours(remaining);
            document.getElementById('allowance-unit').textContent = '';
            document.getElementById('used-unit').textContent = '';
            document.getElementById('remaining-unit').textContent = '';
          }

          // Update progress bar
          const percentage = totalAllowance > 0 ? Math.min(100, Math.max(0, (usedAmount / totalAllowance) * 100)) : 0;
          document.getElementById('progress-fill').style.width = percentage + '%';

          // Load all bookings
          loadBookings();
        }

        // Load bookings list
        async function loadBookings() {
          const { data: bookings } = await supabase
            .from('4_holiday_requests')
            .select('*')
            .eq('user_id', user.id)
            .order('start_date', { ascending: false });

          const container = document.getElementById('bookings-container');

          if (!bookings || bookings.length === 0) {
            container.innerHTML = '<p style="color:#6b7280;">No holiday requests yet.</p>';
            return;
          }

          // Helper function to format hours as HH:MM
          function formatHours(decimalHours) {
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours % 1) * 60);
            return `${hours}:${minutes.toString().padStart(2, '0')}`;
          }

          container.innerHTML = bookings.map(booking => {
            const startDate = new Date(booking.start_date).toLocaleDateString();
            const endDate = new Date(booking.end_date).toLocaleDateString();
            const totalDays = booking.total_days || 0;

            let amount;
            if (window.isGP) {
              amount = `${totalDays} ${totalDays === 1 ? 'session' : 'sessions'}`;
            } else {
              amount = formatHours(totalDays);
            }

            return `
              <div class="booking-item">
                <div>
                  <div class="booking-dates">${startDate} - ${endDate}</div>
                  <div class="hours-display">${amount}</div>
                  ${booking.reason ? `<div style="color:#6b7280; font-size:13px; margin-top:4px;">${booking.reason}</div>` : ''}
                </div>
                <span class="booking-status status-${booking.status}">${booking.status}</span>
              </div>
            `;
          }).join('');
        }

        // Calculate time off
        document.getElementById('calculate-btn').addEventListener('click', () => {
          const fromDate = new Date(document.getElementById('from-date').value);
          const toDate = new Date(document.getElementById('to-date').value);

          if (!fromDate || !toDate || isNaN(fromDate) || isNaN(toDate)) {
            alert('Please select valid dates');
            return;
          }

          if (fromDate > toDate) {
            alert('End date must be after start date');
            return;
          }

          const pattern = window.workingPattern;
          if (!pattern) {
            alert('Working pattern not found. Please complete your setup first.');
            return;
          }

          let totalHours = 0;
          let totalSessions = 0;
          let totalMinutes = 0;
          let details = [];

          // Loop through each day
          const currentDate = new Date(fromDate);
          while (currentDate <= toDate) {
            const dayName = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][currentDate.getDay()];
            const dateStr = currentDate.toLocaleDateString();

            if (window.isGP) {
              const sessions = parseFloat(pattern[`${dayName}_sessions`] || 0);
              if (sessions > 0) {
                totalSessions += sessions;
                details.push(`${dateStr}: ${sessions} ${sessions === 1 ? 'session' : 'sessions'}`);
              }
            } else {
              const hours = parseFloat(pattern[`${dayName}_hours`] || 0);
              if (hours > 0) {
                totalHours += Math.floor(hours);
                totalMinutes += Math.round((hours % 1) * 60);
                const displayHours = Math.floor(hours);
                const displayMinutes = Math.round((hours % 1) * 60);
                const timeStr = displayMinutes > 0 ?
                  `${displayHours}h ${displayMinutes}m` :
                  `${displayHours}h`;
                details.push(`${dateStr}: ${timeStr}`);
              }
            }

            currentDate.setDate(currentDate.getDate() + 1);
          }

          // Calculate total time for staff
          if (!window.isGP) {
            // Handle minute overflow
            totalHours += Math.floor(totalMinutes / 60);
            totalMinutes = totalMinutes % 60;
          }

          // Display result
          const resultDiv = document.getElementById('calculation-result');
          resultDiv.style.display = 'block';
          document.getElementById('calc-details').innerHTML = details.join('<br>');

          if (window.isGP) {
            document.getElementById('calc-total').textContent = totalSessions;
            document.getElementById('calc-unit').textContent = totalSessions === 1 ? 'session' : 'sessions';
            // Store total sessions for submission
            window.holidayRequestTotal = totalSessions;
          } else {
            const totalTimeStr = totalMinutes > 0 ?
              `${totalHours}:${totalMinutes.toString().padStart(2, '0')}` :
              `${totalHours}:00`;
            document.getElementById('calc-total').textContent = totalTimeStr;
            document.getElementById('calc-unit').textContent = '';
            // Store total as decimal hours for submission
            window.holidayRequestTotal = totalHours + (totalMinutes / 60);
          }

          document.getElementById('submit-request').style.display = 'block';
        });

        // Submit request
        document.getElementById('submit-request').addEventListener('click', async () => {
          const fromDate = document.getElementById('from-date').value;
          const toDate = document.getElementById('to-date').value;
          const reason = document.getElementById('reason').value;
          const total = window.holidayRequestTotal || 0;

          if (!fromDate || !toDate) {
            alert('Please select dates');
            return;
          }

          const requestData = {
            user_id: user.id,
            site_id: siteId,
            start_date: fromDate,
            end_date: toDate,
            total_days: total, // This stores hours or sessions as a number
            request_type: 'annual',
            reason: reason || null,
            status: 'pending',
            requested_at: new Date().toISOString()
          };

          document.getElementById('submit-request').disabled = true;
          document.getElementById('request-msg').textContent = 'Submitting...';
          document.getElementById('request-msg').style.color = '#6b7280';

          const { error } = await supabase
            .from('4_holiday_requests')
            .insert(requestData);

          if (error) {
            console.error('Request error:', error);
            document.getElementById('request-msg').textContent = 'Error submitting request: ' + error.message;
            document.getElementById('request-msg').style.color = '#dc2626';
            document.getElementById('submit-request').disabled = false;
          } else {
            document.getElementById('request-msg').textContent = 'Request submitted successfully!';
            document.getElementById('request-msg').style.color = '#059669';

            // Clear form
            document.getElementById('from-date').value = '';
            document.getElementById('to-date').value = '';
            document.getElementById('reason').value = '';
            document.getElementById('calculation-result').style.display = 'none';
            document.getElementById('submit-request').style.display = 'none';

            // Reload bookings
            loadBookings();

            // Reload holiday data to update remaining balance
            loadHolidayData();

            setTimeout(() => {
              document.getElementById('request-msg').textContent = '';
              document.getElementById('submit-request').disabled = false;
            }, 3000);
          }
        });

        // Initial load
        loadHolidayData();

      } catch (error) {
        console.error('Error:', error);
        if (String(error.message).includes('NO_SESSION')) {
          window.location.replace('index.html');
          return;
        }
        if (String(error.message).includes('NOT_STAFF')) {
          window.location.replace('index.html');
          return;
        }
        document.getElementById('app').innerHTML = `
          <div class="panel g-12">
            <p>Error loading holiday data: ${error.message}</p>
            <button class="btn" onclick="window.location.href='staff.html'">Back to Home</button>
          </div>
        `;
      }
    })();
  </script>
</body>
</html>
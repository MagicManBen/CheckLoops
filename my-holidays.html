<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoops — My Holidays</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://*.supabase.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' https://*.supabase.co https://*.supabase.com wss://*.supabase.co wss://*.supabase.com https:;">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://img.icons8.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="supabase-js.js"></script>
  <!-- Standardized Staff Navigation -->
  <link rel="stylesheet" href="staff-nav.css">
  <script src="staff-nav.js"></script>
  <!-- Flatpickr modern date picker -->
  <link rel="stylesheet" href="flatpickr.min.css">
  <script src="flatpickr.min.js"></script>
  <style>
    :root {
      /* Primary color palette - matching homepage */
      --primary: #0b4fb3;
      --primary-dark: #062b6f;
      --primary-light: #2b6ecc;
      --primary-lightest: #e8f2ff;

      /* Accent colors */
      --accent: #76a7ff;
      --accent-2: #5f96ff;
      --success: #2bd4a7;
      --success-light: #e8fdf8;
      --warning: #ffca28;
      --warning-light: #fffbeb;
      --danger: #ff6b6b;
      --danger-light: #fef2f2;

      /* Neutral colors */
      --white: #ffffff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);

      /* Border radius */
      --radius-sm: 0.375rem;
      --radius: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;

      /* Typography */
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
      --font-display: 'Plus Jakarta Sans', 'Inter', sans-serif;

      /* Transitions */
      --transition: all 0.2s ease-in-out;

      /* Legacy mappings - updated for consistency */
      --glass: rgba(255, 255, 255, 0.95);
      --glass-2: rgba(255, 255, 255, 0.98);
      --muted: var(--gray-500);
      --border-color: var(--gray-200);

      /* Staff page specific additions */
      --stat-1-bg: #e0f2fe;
      --stat-1-color: #0284c7;
      --stat-2-bg: #fef3c7;
      --stat-2-color: #d97706;
      --stat-3-bg: #dcfce7;
      --stat-3-color: #16a34a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: var(--font-sans);
      background: linear-gradient(135deg, #e8f2ff 0%, #ffffff 100%) !important;
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--gray-900);
      position: relative;
      overflow-x: hidden;
    }

    /* Subtle background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="%23e2e8f0" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>') !important;
      opacity: 0.3;
      z-index: -1;
      pointer-events: none;
    }

    /* Remove old background animations */
    .bg, .mesh { display: none; }

    /* Page structure matching homepage */
    .page-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Main content - updated to match homepage structure */
    .content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      flex: 1;
      position: relative;
      z-index: 1;
    }

    /* Modern panel styling */
    .panel {
      background: var(--white);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .panel-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-900);
      font-family: var(--font-display);
    }

    /* Hero section */
    .hero {
      margin-bottom: 2rem;
    }

    .h1 {
      font-size: 2rem;
      font-weight: 800;
      color: var(--gray-900);
      font-family: var(--font-display);
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: var(--gray-600);
      font-size: 1rem;
    }

    /* Modern modal overlay for approval gate */
    .glass-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(6px) saturate(120%);
      padding: 2rem;
    }

    .glass-card {
      width: min(720px, 96vw);
      border-radius: 1rem;
      padding: 1.25rem 1.5rem;
      background: linear-gradient(180deg, var(--white), rgba(250,250,251,0.98));
      border: 1px solid rgba(15,23,42,0.06);
      box-shadow: 0 20px 40px rgba(2,6,23,0.25);
      color: var(--gray-900);
      text-align: left;
      position: relative;
      overflow: hidden;
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 1rem;
      align-items: start;
    }

    .glass-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 4px;
      background: linear-gradient(90deg, rgba(255,196,0,0.95), rgba(255,230,179,0.95));
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    .glass-card .title {
      font-size: 1.25rem;
      font-weight: 800;
      margin: 0 0 0.25rem 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--gray-900);
      font-family: var(--font-display);
    }
    .glass-card .title .emoji {
      font-size: 1.6rem;
      line-height: 1;
      display: inline-block;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary-lightest), #fff);
      display: grid;
      place-items: center;
      box-shadow: var(--shadow-sm);
    }
    .glass-card .subtitle {
      color: var(--gray-600);
      margin: 0 0 0.75rem 0;
      font-size: 0.98rem;
      line-height: 1.4;
    }
    .glass-card .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.85rem;
      background: linear-gradient(180deg, #fff7ed, #fff7ed);
      color: #92400e;
      border: 1px solid #fcd34d;
      margin-bottom: 0.25rem;
      justify-self: start;
    }
    .glass-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }
    /* Modern button styles matching homepage */
    .btn {
      padding: 0.75rem 1.25rem;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.9375rem;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-solid, .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-solid:hover, .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-ghost, .btn-secondary {
      background: var(--gray-50);
      color: var(--gray-700);
      border: 1px solid var(--gray-200);
    }

    .btn-ghost:hover, .btn-secondary:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    /* Progress bar */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--gray-200);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 0.75rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transition: width 0.3s ease;
      border-radius: 999px;
    }

    /* Modern status badges */
    .status-pending {
      background: var(--warning-light);
      color: #b45309;
      border: 1px solid #fcd34d;
    }

    .status-approved {
      background: var(--success-light);
      color: #059669;
      border: 1px solid #6ee7b7;
    }

    .status-rejected {
      background: var(--danger-light);
      color: #b91c1c;
      border: 1px solid #fca5a5;
    }

    .booking-status {
      padding: 0.375rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
    }

    /* Modern booking item cards */
    .booking-item {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      transition: var(--transition);
    }

    .booking-item:hover {
      background: var(--white);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .booking-reason {
      color: var(--gray-600);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    .booking-reason strong {
      color: var(--gray-900);
      font-weight: 600;
    }
    .dest-emoji {
      display: inline-block;
      margin-right: 0.375rem;
      font-size: 1rem;
    }

    .booking-dates {
      font-weight: 600;
      color: var(--gray-900);
    }

    .hours-display {
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 16px;
      align-items: end;
      margin-bottom: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
    }

    .form-input {
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 1rem;
      background: var(--white);
      color: var(--gray-900);
      transition: var(--transition);
      width: 100%;
    }

    .form-input::placeholder {
      color: var(--gray-400);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 79, 179, 0.1);
    }

    textarea.form-input {
      resize: vertical;
      min-height: 80px;
    }

    /* Modern icon containers */
    .icon-wrap, .illus-circle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-lightest), var(--gray-50));
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    /* Modern calculation card */
    #calculation-result.calc-card {
      display: grid;
      gap: 1rem;
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
    }
    .calc-header {
      font-weight: 700;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-family: var(--font-display);
    }
    .calc-header::before{
      content: "🗓️";
      font-size: 18px;
    }
    .calc-list {
      max-height: 220px;
      overflow-y: auto;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: 0.5rem;
      background: var(--white);
    }
    .calc-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      border-radius: var(--radius);
      transition: var(--transition);
      border: 1px solid var(--gray-100);
      background: var(--gray-50);
      margin: 0.5rem 0;
      gap: 1rem;
    }
    .calc-row:hover {
      background: var(--primary-lightest);
    }
    .calc-date {
      color: var(--gray-900);
      font-weight: 600;
      flex: 1;
    }
    .calc-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }
    .part-day-check {
      cursor: pointer;
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }
    .calc-controls label {
      cursor: pointer;
      color: var(--gray-600);
      user-select: none;
    }
    .calc-badge-wrapper {
      position: relative;
      min-width: 100px;
    }
    .calc-badge {
      font-weight: 600;
      font-size: 0.875rem;
      padding: 0.375rem 0.75rem;
      border-radius: 999px;
      background: var(--primary-lightest);
      border: 1px solid var(--primary-light);
      color: var(--primary-dark);
      white-space: nowrap;
    }
    .calc-badge-input {
      width: 100px;
      text-align: center;
      background: white;
      font-family: inherit;
    }
    .calc-badge-input:enabled {
      cursor: text;
      background: white;
      border-color: var(--primary);
    }
    .calc-badge-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(11, 79, 179, 0.1);
    }
    .calc-badge-input:disabled {
      cursor: not-allowed;
      background: var(--primary-lightest);
    }
    .calc-total {
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--success-light);
      border: 1px solid #6ee7b7;
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
    }
    .calc-total-label {
      color: #059669;
      font-weight: 700;
    }
    .calc-total-value {
      color: #059669;
      font-weight: 800;
      font-size: 1.125rem;
    }

    /* Holiday image thumbnail styles */
    .holiday-image-card {
      margin-top: 0.5rem;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--gray-200);
      background: var(--white);
      max-width: 200px;
    }
    .holiday-image-thumb {
      width: 100%;
      height: auto;
      display: block;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    .holiday-image-thumb:hover {
      transform: scale(1.05);
    }
    .holiday-image-caption {
      padding: 0.5rem;
      font-size: 0.75rem;
      color: var(--gray-600);
      text-align: center;
      font-weight: 600;
      background: var(--gray-50);
    }

    /* Top navigation bar - removed conflicting styles to use staff-nav.css */

    .nav {
      display: flex;
      gap: 0.5rem;
    }

    .nav a {
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      color: var(--gray-600);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
    }

    .nav a:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .nav a.active {
      background: var(--primary-lightest);
      color: var(--primary);
      font-weight: 600;
    }

    .spacer {
      flex: 1;
    }

    .pill {
      padding: 0.375rem 0.75rem;
      border-radius: 999px;
      background: var(--gray-100);
      color: var(--gray-700);
      font-size: 0.875rem;
      font-weight: 500;
    }

    /* Stat cards */
    .stat-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--white);
      border-radius: var(--radius-xl);
      border: 1px solid var(--gray-200);
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .stat-num {
      font-size: 2rem;
      font-weight: 800;
      color: var(--gray-900);
      font-family: var(--font-display);
    }

    .stat-label {
      color: var(--gray-600);
      font-size: 0.875rem;
      font-weight: 500;
      margin-top: 0.25rem;
    }

    /* New content grid for main columns */
    .content-grid {
      display: grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 1.5rem;
      align-items: stretch;
    }

    /* Desktop tuning */
    @media (min-width: 1024px) {
      .equal-panel { height: auto; }
      .equal-panel .scroll-box {
        flex: 1 1 auto;
        max-height: none;
        min-height: 0; /* allow flexbox scrolling */
      }
    }

    /* Make stat cards lock to three-up on larger screens */
    @media (min-width: 1024px) {
      .stat-row {
        grid-template-columns: repeat(3, 1fr);
      }
  /* Allow natural page scroll */
  body { overflow-y: auto; }
  .page-container { height: auto; }
  .content { display: block; height: auto; overflow: visible; padding-top: 0.5rem; padding-bottom: 0.5rem; }
      /* .navbar responsive styles handled by staff-nav.css */
      .hero { margin-bottom: 0.25rem; }
      .h1 { font-size: 1.4rem; }
      .subtitle { display: none; }
      .stat-row { margin-bottom: 0.25rem; gap: 0.75rem; }
      .stat-card { padding: 0.5rem 0.75rem; border-radius: var(--radius-lg); }
      .stat-num { font-size: 1.25rem; }
      .icon-wrap { width: 32px; height: 32px; }
      .panel-header { margin-bottom: 0.6rem; }
      .panel.equal-panel { margin-bottom: 0; height: auto; display: block; overflow: visible; }
      .content-grid { height: auto; }
      .panel.equal-panel.scrollable { overflow-y: auto; -webkit-overflow-scrolling: touch; }
      .panel.equal-panel .scroll-box { flex: 1 1 auto; min-height: 0; max-height: none; }
      .footer { display: block; }
    }

    /* Overlap section styling */
    #overlap-section {
      background: var(--warning-light) !important;
      border: 1px solid #fcd34d !important;
    }

    #overlap-section .calc-header {
      color: #b45309;
    }

    /* Scrollable list box for requests */
    .scroll-box {
      max-height: 70vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 0.25rem; /* room for scrollbar */
      scroll-behavior: smooth;
    }

    /* Subtle scrollbar styling (WebKit) */
    .scroll-box::-webkit-scrollbar { width: 10px; }
    .scroll-box::-webkit-scrollbar-track { background: transparent; }
    .scroll-box::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    .scroll-box:hover::-webkit-scrollbar-thumb { background: var(--gray-400); }

    /* Footer */
    .footer {
      text-align: center;
      padding: 2rem;
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .content {
        padding: 1rem;
      }

      .topbar {
        padding: 0.75rem 1rem;
        flex-wrap: wrap;
      }

      .stat-row {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .content-grid {
        grid-template-columns: 1fr;
      }

      .equal-panel { height: auto; }
    }
  </style>
</head>
<body style="visibility: hidden;">
  <div class="page-container">
    <!-- Holiday approval gate overlay -->
    <div id="approval-overlay" class="glass-overlay" role="dialog" aria-modal="true" aria-labelledby="approval-title">
      <div class="glass-card" role="document">
        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:0.5rem;">
          <div class="badge">Access pending</div>
          <div class="title" id="approval-title"><span class="emoji" aria-hidden="true">🛂</span>Holiday access awaiting approval</div>
          <p class="subtitle">Your manager needs to approve your holiday entitlement before you can request time off.</p>
        </div>

        <div style="display:flex;flex-direction:column;gap:0.5rem;align-items:flex-end;">
          <button id="approval-refresh" class="btn btn-primary" aria-label="Refresh approval status">Refresh status</button>
          <button id="approval-home" class="btn btn-secondary" aria-label="Back to home" style="background:transparent;border:1px solid var(--gray-200);">Back to Home</button>
        </div>
        
        <div style="grid-column: 1 / -1; margin-top: 0.75rem; color:var(--muted);">
          <ul style="margin:0 0 0 18px;">
            <li>Once approved, your allowance will appear here automatically.</li>
            <li>You can still browse, but requesting time off is disabled.</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Standard nav mount point -->
    <div id="navbar-root"></div>

    <!-- Main Content Area -->
    <main class="content">
      
      <div class="hero">
        <div>
          <div class="h1">My Holiday Allowance</div>
          <div class="subtitle">Manage your holiday requests and track your allowance</div>
        </div>
      </div>

      <!-- Holiday Statistics Cards -->
      <div class="stat-row">
        <div class="stat-card">
          <div class="icon-wrap">📊</div>
          <div>
            <div class="stat-num" id="total-allowance">0</div>
            <div class="stat-label">Total Allowance <span id="allowance-unit">hours</span></div>
          </div>
        </div>

        <div class="stat-card">
          <div class="icon-wrap">📅</div>
          <div>
            <div class="stat-num" id="used-holidays">0</div>
            <div class="stat-label">Used <span id="used-unit">hours</span></div>
          </div>
        </div>

        <div class="stat-card">
          <div class="icon-wrap">⏰</div>
          <div style="flex: 1;">
            <div class="stat-num" id="remaining-holidays">0</div>
            <div class="stat-label">Remaining <span id="remaining-unit">hours</span></div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div class="muted" id="pending-line" style="font-size:12px; margin-top:6px; display:none;">
              Pending: <span id="pending-amount">0</span> <span id="pending-unit">sessions</span>
              • After pending: <span id="remaining-after-pending">0</span> <span id="remaining-after-unit">sessions</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Main two-column grid: left = request form, right = requests list -->
      <div class="content-grid">
        <!-- Holiday Request Form -->
  <section class="panel equal-panel scrollable" aria-labelledby="request-time-off">
          <div class="panel-header">
            <div class="illus-circle"><img src="https://img.icons8.com/pastel-color/64/add--v2.png" alt="Request" style="width:30px;height:30px;"/></div>
            <h3 class="panel-title" id="request-time-off">Request Time Off</h3>
          </div>

          <div class="form-row">
            <div class="form-group" style="grid-column: 1 / span 2;">
              <label class="form-label">Date Range</label>
              <input id="holiday-range" class="form-input" placeholder="Select holiday dates…" autocomplete="off" value="" />
              <div style="color: var(--gray-500); font-size:0.875rem; margin-top:0.5rem;">Click start date, then end date (click once for a single day).</div>
            </div>
            <button class="btn btn-primary" id="calculate-btn">Calculate</button>
          </div>

          <div id="calculation-result" class="calc-card" style="display:none; margin-top:1rem;">
            <div class="calc-header">Time Off Calculation</div>
            <div id="calc-list" class="calc-list"></div>
            <div class="calc-total">
              <span class="calc-total-label">Total</span>
              <span class="calc-total-value"><span id="calc-total">0</span> <span id="calc-unit">hours</span></span>
            </div>
          </div>

          <!-- Overlap Detection Section -->
          <div id="overlap-section" class="calc-card" style="display:none; margin-top:1rem;">
            <div class="calc-header" style="color: #fbbf24;">⚠️ Other Staff on Holiday During This Period</div>
            <div id="overlap-list" style="padding: 12px;">
              <!-- Overlapping holidays will be loaded here -->
            </div>
          </div>

          <div class="form-group" style="margin-top:1rem;">
            <label class="form-label">Reason (optional)</label>
            <textarea id="reason" class="form-input" rows="3" placeholder="Holiday, personal time, etc."></textarea>
          </div>

          <button class="btn btn-primary" id="submit-request" style="margin-top:1rem; display:none;">Submit Request</button>
          <div id="request-msg" style="margin-top:0.75rem; font-weight:600;"></div>
        </section>

        <!-- Your Holiday Requests -->
  <aside class="panel equal-panel" aria-labelledby="your-requests">
          <div class="panel-header">
            <div class="illus-circle"><img src="https://img.icons8.com/pastel-color/64/todo-list--v2.png" alt="Requests" style="width:30px;height:30px;"/></div>
            <h3 class="panel-title" id="your-requests">Your Holiday Requests</h3>
          </div>
          <div id="bookings-container" class="scroll-box">
            <!-- Bookings will be loaded here -->
          </div>
        </aside>
      </div>
    </main>

    <!-- Footer -->
    <div class="footer">© CheckLoops • Staff Portal</div>
  </div>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, attachLogout } from './staff-common.js';

    // Fun destination icon helper
    function destinationIconHTML(text){
      if (!text) return '';
      const t = String(text).toLowerCase();
      // Keyword → emoji map (cities, regions, countries). Put specific places first.
      const entries = [
        // --- Cities & popular destinations ---
        ['paris','🗼'], ['new york','🗽'], ['nyc','🗽'], ['disney','🏰'], ['orlando','🏰'], ['las vegas','🎰'], ['vegas','🎰'],
        ['london','🎡'], ['rome','🏛️'], ['barcelona','🌆'], ['madrid','🏟️'], ['venice','🚤'], ['florence','🖼️'],
        ['amsterdam','🚲'], ['berlin','🧱'], ['munich','🍺'], ['athens','🏺'], ['dubai','🏙️'], ['abu dhabi','🏜️'],
        ['tokyo','🗼'], ['kyoto','⛩️'], ['seoul','🕍'], ['bangkok','🛕'], ['singapore','🌇'], ['sydney','🌉'],
        ['melbourne','🎾'], ['auckland','🗻'], ['toronto','🧊'], ['vancouver','🌲'], ['montreal','🎭'],
        ['cancun','🏖️'], ['mexico city','🦅'], ['rio','🎉'], ['buenos aires','⚽'], ['cape town','🗻'],
        ['cairo','🗿'], ['marrakech','🕌'], ['istanbul','🕌'], ['prague','🎻'], ['vienna','🎼'], ['budapest','🌉'],
        ['reykjavik','❄️'], ['oslo','🛶'], ['stockholm','🚤'], ['copenhagen','🚴'], ['helsinki','🧊'],
        // --- Activities / generic ---
        ['beach','🏖️'], ['mountain','🏔️'], ['ski','🎿'], ['cruise','🛳️'], ['camping','🏕️'], ['safari','🦒'],
        // --- Countries / regions ---
        ['france','🇫🇷'], ['spain','🇪🇸'], ['italy','🇮🇹'], ['greece','🇬🇷'], ['portugal','🇵🇹'],
        ['germany','🇩🇪'], ['netherlands','🇳🇱'], ['belgium','🇧🇪'], ['switzerland','🇨🇭'], ['austria','🇦🇹'],
        ['czech','🇨🇿'], ['hungary','🇭🇺'], ['poland','🇵🇱'], ['croatia','🇭🇷'], ['slovenia','🇸🇮'], ['malta','🇲🇹'],
        ['turkey','🇹🇷'], ['cyprus','🇨🇾'], ['iceland','🇮🇸'], ['norway','🇳🇴'], ['sweden','🇸🇪'], ['denmark','🇩🇰'], ['finland','🇫🇮'],
        ['ireland','🇮🇪'], ['northern ireland','🏴'], ['scotland','🏴'], ['wales','🏴'], ['uk','🇬🇧'], ['england','🏴'],
        ['morocco','🇲🇦'], ['egypt','🇪🇬'], ['south africa','🇿🇦'],
        ['united states','🇺🇸'], ['usa','🇺🇸'], ['america','🇺🇸'], ['canada','🇨🇦'], ['mexico','🇲🇽'],
        ['brazil','🇧🇷'], ['argentina','🇦🇷'], ['chile','🇨🇱'],
        ['uae','🇦🇪'], ['qatar','🇶🇦'], ['oman','🇴🇲'], ['jordan','🇯🇴'],
        ['india','🇮🇳'], ['sri lanka','🇱🇰'], ['thailand','🇹🇭'], ['vietnam','🇻🇳'], ['indonesia','🇮🇩'], ['bali','🌴'],
        ['philippines','🇵🇭'], ['malaysia','🇲🇾'], ['singapore','🇸🇬'], ['japan','🇯🇵'], ['china','🇨🇳'], ['south korea','🇰🇷'],
        ['australia','🇦🇺'], ['new zealand','🇳🇿']
      ];

      const found = entries.find(([k]) => t.includes(k));
      if (!found) return '';
      const emoji = found[1];
      return `<span class="dest-emoji" title="${text}">${emoji}</span>`;
    }

    (async function() {
      const supabase = await initSupabase();
      // Make supabase available globally for Admin Portal button
      window.supabase = supabase;
      handleAuthState(supabase);
      // Render shared nav and set active state
      if (typeof window.renderStandardStaffNav === 'function') {
        window.renderStandardStaffNav('my-holidays.html');
      }
      navActivate('holidays');
      attachLogout(supabase);

      // Setup Flatpickr for range selection
      // Using 2025 as the holiday year to match current data
      const holidayYear = 2025; // TODO: Get this from holiday year settings

      // Ensure no pre-filled value from browser restoration/autofill
      const holidayInput = document.getElementById('holiday-range');
      if (holidayInput) holidayInput.value = '';

      const rangePicker = flatpickr("#holiday-range", {
        mode: "range",
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "D, j M Y",
        weekNumbers: true,
        defaultDate: null, // explicitly no default
        minDate: new Date(holidayYear, 0, 1), // Start from Jan 1 of holiday year
        maxDate: new Date(holidayYear, 11, 31), // End at Dec 31 of holiday year
        onReady: function(selectedDates, dateStr, instance){
          // Clear any restored selection from bfcache/autofill
          instance.clear();
        }
      });
      window.rangePicker = rangePicker;

      try {
        const { session, profileRow } = await requireStaffSession(supabase);
        // Auth successful - show page
        document.body.style.visibility = 'visible';
        
        const user = session.user;

        // Check if holidays are approved for this user in master_users table
        const { data: userData, error: approvalError } = await supabase
          .from('master_users')
          .select('holiday_approved')
          .eq('auth_user_id', user.id)
          .single();

        if (approvalError) {
          console.error('Error checking holiday approval:', approvalError);
          alert('Unable to verify holiday access. Please try again later.');
          window.location.href = 'staff.html';
          return;
        }

        if (!userData || userData.holiday_approved !== true) {
          // Show glass overlay and block the page behind it.
          const overlay = document.getElementById('approval-overlay');
          overlay.style.display = 'flex';

          // Wire actions
          const refreshBtn = document.getElementById('approval-refresh');
          const homeBtn = document.getElementById('approval-home');

          refreshBtn?.addEventListener('click', async () => {
            // Recheck approval flag
            const { data: reUser } = await supabase
              .from('master_users')
              .select('holiday_approved')
              .eq('auth_user_id', user.id)
              .single();
            if (reUser?.holiday_approved === true) {
              overlay.style.display = 'none';
              // Proceed with normal load
              // (do nothing here; page continues)
            } else {
              // cute nudge
              refreshBtn.textContent = 'Still pending...';
              setTimeout(() => (refreshBtn.textContent = 'Refresh status'), 1200);
            }
          });

          homeBtn?.addEventListener('click', () => {
            window.location.href = 'staff.html';
          });

          // Stop further loading on this page (keep overlay visible)
          return;
        }

        const siteId = profileRow?.site_id || 1;

        // Set topbar: always use access_type as the authoritative role
        setTopbar({
          siteText: await getSiteText(supabase, siteId),
          email: user.email,
          role: profileRow?.access_type || profileRow?.role || 'staff',
          access_type: profileRow?.access_type || profileRow?.role
        });

        // Show admin portal button for admins/owners
        const adminRole = (profileRow?.access_type || profileRow?.role || '').toLowerCase();
  const adminPortalBtn = document.getElementById('adminPortalBtn');
        if (adminPortalBtn) {
          if (adminRole === 'admin' || adminRole === 'owner') {
            adminPortalBtn.style.display = 'inline-flex';
          } else {
            adminPortalBtn.style.display = 'none';
          }
        }

        // Load holiday data from master_users (single source of truth)
        async function loadHolidayData() {
          console.log('[my-holidays] Loading holiday data for user:', user.email);

          // Get all holiday data directly from master_users table
          const { data: holidaySummary, error: summaryError } = await supabase
            .from('master_users')
            .select('*')
            .eq('auth_user_id', user.id)
            .single();

          console.log('[my-holidays] Master users result:', { holidaySummary, summaryError });

          if (!holidaySummary) {
            document.getElementById('holidays').innerHTML = `
              <div class="panel-header">
                <div class="illus-circle" style="width:64px;height:64px;"><img src="https://img.icons8.com/pastel-color/64/calendar--v3.png" alt="Holidays" style="width:44px;height:44px;"/></div>
                <div class="panel-title">Holiday Setup Required</div>
              </div>
              <p>Please complete your welcome process first to set up your holiday allowance.</p>
              <button class="btn" onclick="window.location.href='staff-welcome.html'">Complete Setup</button>
            `;
            return;
          }

          // All working pattern data is now in master_users
          window.isGP = holidaySummary.is_gp;
          
          // Store working pattern data from master_users for calculations
          window.workingPattern = {
            monday_hours: holidaySummary.monday_hours || 0,
            tuesday_hours: holidaySummary.tuesday_hours || 0,
            wednesday_hours: holidaySummary.wednesday_hours || 0,
            thursday_hours: holidaySummary.thursday_hours || 0,
            friday_hours: holidaySummary.friday_hours || 0,
            saturday_hours: holidaySummary.saturday_hours || 0,
            sunday_hours: holidaySummary.sunday_hours || 0,
            monday_sessions: holidaySummary.monday_sessions || 0,
            tuesday_sessions: holidaySummary.tuesday_sessions || 0,
            wednesday_sessions: holidaySummary.wednesday_sessions || 0,
            thursday_sessions: holidaySummary.thursday_sessions || 0,
            friday_sessions: holidaySummary.friday_sessions || 0,
            saturday_sessions: holidaySummary.saturday_sessions || 0,
            sunday_sessions: holidaySummary.sunday_sessions || 0,
            total_hours: holidaySummary.total_hours || 0,
            total_sessions: holidaySummary.total_sessions || 0
          };

          // Helper function to format hours as HH:MM
          function formatHours(decimalHours) {
            const hours = Math.floor(decimalHours || 0);
            const minutes = Math.round(((decimalHours || 0) % 1) * 60);
            return `${hours}:${minutes.toString().padStart(2, '0')}`;
          }

          // Update display using consolidated data
          const isGP = holidaySummary.is_gp;
          console.log('[my-holidays] Updating display - isGP:', isGP, 'summary:', holidaySummary);

          // Get holiday values from master_users - using the same fields as admin dashboard
          let totalAllowance = 0;
          let usedAmount = 0;
          let remaining = 0;

          // Get total entitlement from master_users (as set in admin dashboard)
          // This value is set by the admin using multiplier or manual override
          totalAllowance = parseFloat(holidaySummary.total_holiday_entitlement ||
                                     holidaySummary.holiday_entitlement || 0);

          // Get used amount from master_users
          // This tracks holidays already taken
          usedAmount = parseFloat(holidaySummary.holiday_taken ||
                                holidaySummary.approved_holidays_used || 0);

          // Get remaining from master_users (auto-calculated by database)
          // This is a generated column: entitlement - taken
          remaining = parseFloat(holidaySummary.holiday_remaining !== null && holidaySummary.holiday_remaining !== undefined
                               ? holidaySummary.holiday_remaining
                               : (totalAllowance - usedAmount));

          console.log('[my-holidays] Holiday values from master_users:', {
            totalAllowance,
            usedAmount,
            remaining,
            is_gp: holidaySummary.is_gp,
            manual_override: holidaySummary.manual_override,
            holiday_multiplier: holidaySummary.holiday_multiplier
          });

          // Also get pending requests to preview impact
          const year = holidaySummary.holiday_year || new Date().getFullYear();
          const { data: pendingRows, error: pendingErr } = await supabase
            .from('4_holiday_requests')
            .select('total_days, start_date, status')
            .eq('user_id', user.id)
            .eq('status', 'pending')
            .gte('start_date', `${year}-01-01`)
            .lte('start_date', `${year}-12-31`);
          if (pendingErr) {
            console.warn('[my-holidays] Could not load pending holidays:', pendingErr);
          }
          const pendingAmount = (pendingRows || []).reduce((sum, r) => sum + (parseFloat(r.total_days) || 0), 0);
          const remainingAfterPending = remaining - pendingAmount;

          if (window.isGP) {
            // GP uses sessions - display as whole numbers
            document.getElementById('total-allowance').textContent = Math.round(totalAllowance);
            document.getElementById('used-holidays').textContent = Math.round(usedAmount);
            document.getElementById('remaining-holidays').textContent = Math.round(remaining);
            document.getElementById('allowance-unit').textContent = 'sessions';
            document.getElementById('used-unit').textContent = 'sessions';
            document.getElementById('remaining-unit').textContent = 'sessions';

            // Update progress bar
            const percentage = totalAllowance > 0 ? Math.min(100, Math.max(0, (usedAmount / totalAllowance) * 100)) : 0;
            document.getElementById('progress-fill').style.width = percentage + '%';

            // Set pending preview line
            const pendingLine = document.getElementById('pending-line');
            if (pendingAmount > 0) {
              document.getElementById('pending-amount').textContent = Math.round(pendingAmount);
              document.getElementById('remaining-after-pending').textContent = Math.round(remainingAfterPending);
              document.getElementById('pending-unit').textContent = 'sessions';
              document.getElementById('remaining-after-unit').textContent = 'sessions';
              pendingLine.style.display = 'block';
            } else {
              pendingLine.style.display = 'none';
            }

            console.log('[my-holidays] GP display updated - Total:', totalAllowance, 'Used:', usedAmount, 'Remaining:', remaining);
          } else {
            // Non-GP uses hours - display as HH:MM format
            document.getElementById('total-allowance').textContent = formatHours(totalAllowance);
            document.getElementById('used-holidays').textContent = formatHours(usedAmount);
            document.getElementById('remaining-holidays').textContent = formatHours(remaining);
            document.getElementById('allowance-unit').textContent = 'hours';
            document.getElementById('used-unit').textContent = 'hours';
            document.getElementById('remaining-unit').textContent = 'hours';

            // Update progress bar
            const percentage = totalAllowance > 0 ? Math.min(100, Math.max(0, (usedAmount / totalAllowance) * 100)) : 0;
            document.getElementById('progress-fill').style.width = percentage + '%';

            // Set pending preview line
            const pendingLine = document.getElementById('pending-line');
            if (pendingAmount > 0) {
              document.getElementById('pending-amount').textContent = formatHours(pendingAmount);
              document.getElementById('remaining-after-pending').textContent = formatHours(remainingAfterPending);
              document.getElementById('pending-unit').textContent = 'hours';
              document.getElementById('remaining-after-unit').textContent = 'hours';
              pendingLine.style.display = 'block';
            } else {
              pendingLine.style.display = 'none';
            }

            console.log('[my-holidays] Staff display updated - Total:', formatHours(totalAllowance), 'Used:', formatHours(usedAmount), 'Remaining:', formatHours(remaining));
          }

          // Load all bookings
          loadBookings();
        }

        // Load bookings list
        async function loadBookings() {
          const { data: bookings } = await supabase
            .from('4_holiday_requests')
            .select('*')
            .eq('user_id', user.id)
            .order('start_date', { ascending: false });

          const container = document.getElementById('bookings-container');

          if (!bookings || bookings.length === 0) {
            container.innerHTML = '<p style="color: var(--gray-500);">No holiday requests yet.</p>';
            return;
          }

          // Helper function to format hours as HH:MM
          function formatHours(decimalHours) {
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours % 1) * 60);
            return `${hours}:${minutes.toString().padStart(2, '0')}`;
          }

          container.innerHTML = bookings.map(booking => {
            const startDate = new Date(booking.start_date).toLocaleDateString();
            const endDate = new Date(booking.end_date).toLocaleDateString();
            const totalDays = booking.total_days || 0;

            let amount;
            if (window.isGP) {
              amount = `${totalDays} ${totalDays === 1 ? 'session' : 'sessions'}`;
            } else {
              amount = formatHours(totalDays);
            }

            return `
              <div class="booking-item">
                <div style="flex: 1;">
                  <div class="booking-dates">${startDate} - ${endDate}</div>
                  <div class="hours-display">${amount}</div>
                  ${booking.reason ? `<div class="booking-reason">${destinationIconHTML(booking.reason)}<strong>Reason:</strong> ${booking.reason}</div>` : ''}
                  ${booking.status === 'rejected' && booking.notes ? `<div style="color: var(--danger); font-size: 0.875rem; margin-top: 0.25rem; font-weight: 600;"><strong>Rejected:</strong> ${booking.notes}</div>` : ''}
                  ${booking.holiday_image_url ? `
                    <div class="holiday-image-card">
                      <img
                        src="${booking.holiday_image_url}"
                        alt="Holiday at ${booking.reason || 'destination'}"
                        class="holiday-image-thumb"
                        onclick="window.open('${booking.holiday_image_url}', '_blank')"
                        loading="lazy"
                        onerror="this.parentElement.style.display='none'"
                      />
                      <div class="holiday-image-caption">🌴 Your avatar on holiday!</div>
                    </div>
                  ` : ''}
                </div>
                <span class="booking-status status-${booking.status}">${booking.status}</span>
              </div>
            `;
          }).join('');
        }

        // Function to check for overlapping holidays (SITE-STRICT)
        async function checkHolidayOverlaps(startDate, endDate) {
          console.log('=== CHECKING FOR OVERLAPS (SITE-STRICT) ===');
          console.log('Start date:', startDate);
          console.log('End date:', endDate);
          console.log('Current user ID:', user.id);
          console.log('Current user email:', user.email);

          try {
            // 1) Get current user's site_id
            const { data: currentUser, error: cuErr } = await supabase
              .from('master_users')
              .select('site_id, full_name, email')
              .eq('auth_user_id', user.id)
              .single();

            if (cuErr) {
              console.error('[Overlap Check] Error loading current user site:', cuErr);
              return [];
            }
            if (!currentUser || !currentUser.site_id) {
              console.warn('[Overlap Check] No site_id for current user; cannot check overlaps.');
              return [];
            }

            const siteId = currentUser.site_id;
            console.log('[Overlap Check] Using site_id =', siteId);

            // 2a) Prefer a VIEW that already joins master_users so we get names/emails in one go
            try {
              const { data: vRows, error: vErr } = await supabase
                .from('v_holiday_requests_with_user')
                .select('id, user_id, site_id, start_date, end_date, status, reason, full_name, email, avatar_url')
                .eq('site_id', siteId)
                .neq('user_id', user.id)
                .in('status', ['approved', 'pending'])
                .lte('start_date', endDate)
                .gte('end_date', startDate);

              if (!vErr && Array.isArray(vRows)) {
                console.log('[Overlap Check] Using view v_holiday_requests_with_user. Rows:', vRows.length);
                if (vRows.length > 0) {
                  return vRows.map(r => ({
                    ...r,
                    userName: r.full_name || r.email || 'Unknown User',
                    avatarUrl: r.avatar_url || null
                  }));
                }
              } else if (vErr) {
                console.log('[Overlap Check] View not available or error:', vErr.message || vErr);
              }
            } catch(viewCatch){
              console.log('[Overlap Check] View join attempt failed:', viewCatch?.message || viewCatch);
            }

            // 2b) Fallback: Query requests in-site then enrich with master_users
            // Overlap condition: start_date <= endDate AND end_date >= startDate
            const { data: overlappingRequests, error: reqErr } = await supabase
              .from('4_holiday_requests')
              .select('id, user_id, site_id, start_date, end_date, status, reason')
              .eq('site_id', siteId)
              .neq('user_id', user.id)
              .in('status', ['approved', 'pending'])
              .lte('start_date', endDate)
              .gte('end_date', startDate);

            if (reqErr) {
              console.error('[Overlap Check] Error querying requests:', reqErr);
              return [];
            }

            console.log('[Overlap Check] Raw overlapping requests count:', overlappingRequests?.length || 0);
            if (!overlappingRequests || overlappingRequests.length === 0) {
              return [];
            }

            // 3) Enrich with user profiles for display (names/avatars)
            const otherIds = [...new Set(overlappingRequests.map(r => r.user_id))];
            let profiles = [];
            if (otherIds.length > 0) {
              const { data: profs, error: profErr } = await supabase
                .from('master_users')
                .select('auth_user_id, full_name, email, avatar_url')
                .in('auth_user_id', otherIds);
              if (profErr) {
                console.warn('[Overlap Check] Could not load user profiles:', profErr);
              }
              profiles = profs || [];
            }

            const overlaps = overlappingRequests.map(req => {
              const u = profiles.find(p => p.auth_user_id === req.user_id) || {};
              return {
                ...req,
                userName: u.full_name || u.email || (req.user_id ? `User ${String(req.user_id).slice(0,6)}…` : 'Unknown User'),
                avatarUrl: u.avatar_url || null,
                email: u.email || ''
              };
            });

            console.log('[Overlap Check] Final overlaps to display:', overlaps.length);
            return overlaps;
          } catch (error) {
            console.error('[Overlap Check] Unexpected error:', error);
            return [];
          }
        }

        // Function to display overlapping holidays
        function displayOverlaps(overlaps) {
          console.log('[displayOverlaps] Called with:', overlaps);
          const overlapSection = document.getElementById('overlap-section');
          const overlapList = document.getElementById('overlap-list');

          console.log('[displayOverlaps] Section element:', overlapSection);
          console.log('[displayOverlaps] List element:', overlapList);

          if (!overlaps || overlaps.length === 0) {
            console.log('[displayOverlaps] No overlaps, hiding section');
            if (overlapSection) overlapSection.style.display = 'none';
            return;
          }

          console.log('[displayOverlaps] Showing overlap section with', overlaps.length, 'overlaps');
          if (!overlapSection) {
            console.error('[displayOverlaps] ERROR: overlap-section element not found!');
            return;
          }
          overlapSection.style.display = 'block';

          const overlapHTML = overlaps.map(overlap => {
            const startDate = new Date(overlap.start_date).toLocaleDateString();
            const endDate = new Date(overlap.end_date).toLocaleDateString();
            const avatarHTML = overlap.avatarUrl
              ? `<img src="${overlap.avatarUrl}" alt="${overlap.userName}" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">`
              : `<div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: inline-block; margin-right: 8px; vertical-align: middle; text-align: center; line-height: 32px; color: white; font-weight: bold;">${overlap.userName.charAt(0).toUpperCase()}</div>`;

            const statusBadge = overlap.status === 'approved'
              ? '<span style="background: #059669; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">Approved</span>'
              : '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">Pending</span>';

            return `
              <div style="padding: 0.75rem; margin: 0.5rem 0; background: var(--gray-50); border-radius: var(--radius); border: 1px solid var(--gray-200);">
                ${avatarHTML}
                <strong style="color: var(--warning);">${overlap.userName}</strong>
                ${statusBadge}
                <div style="margin-left: 40px; color: var(--gray-400); font-size: 0.875rem; margin-top: 0.25rem;">
                  ${startDate} - ${endDate}
                  ${overlap.reason ? `<span style="color: var(--gray-400);"> • ${overlap.reason}</span>` : ''}
                </div>
              </div>
            `;
          }).join('');

          overlapList.innerHTML = overlapHTML;
        }

        // Store calculated holiday data for each day
        window.holidayDayData = {};

        // Function to toggle part day input
        window.togglePartDay = function(dateKey, checkbox) {
          const row = checkbox.closest('.calc-row');
          const input = row.querySelector('.calc-badge-input');
          const display = row.querySelector('.calc-badge-display');

          if (checkbox.checked) {
            display.style.display = 'none';
            input.style.display = 'block';
            input.disabled = false;
            input.focus();
          } else {
            input.style.display = 'none';
            input.disabled = true;
            display.style.display = 'block';
            // Reset to calculated value
            input.value = '';
            window.holidayDayData[dateKey].isPartDay = false;
            window.holidayDayData[dateKey].manualValue = null;
            recalculateTotal();
          }
        };

        // Function to validate and update manual time input
        window.validateTimeInput = function(dateKey, input) {
          const value = input.value.trim();

          if (window.isGP) {
            // For GPs, expect a number (sessions)
            const sessions = parseFloat(value);
            if (isNaN(sessions) || sessions < 0) {
              input.value = '';
              alert('Please enter a valid number of sessions');
              return;
            }
            window.holidayDayData[dateKey].manualValue = sessions;
          } else {
            // For staff, expect HH:MM format
            const timeMatch = value.match(/^(\d{1,2}):(\d{2})$/);
            if (!timeMatch) {
              input.value = '';
              alert('Please enter time in HH:MM format (e.g., 3:30)');
              return;
            }
            const hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]);
            if (minutes >= 60) {
              input.value = '';
              alert('Minutes must be less than 60');
              return;
            }
            // Store as decimal hours
            window.holidayDayData[dateKey].manualValue = hours + (minutes / 60);
          }
          window.holidayDayData[dateKey].isPartDay = true;
          recalculateTotal();
        };

        // Function to recalculate total with manual overrides
        window.recalculateTotal = function() {
          let total = 0;

          for (const dateKey in window.holidayDayData) {
            const dayData = window.holidayDayData[dateKey];
            if (dayData.isPartDay && dayData.manualValue !== null) {
              total += dayData.manualValue;
            } else {
              total += dayData.calculatedValue;
            }
          }

          if (window.isGP) {
            document.getElementById('calc-total').textContent = total;
            document.getElementById('calc-unit').textContent = total === 1 ? 'session' : 'sessions';
            window.holidayRequestTotal = total;
          } else {
            const totalHours = Math.floor(total);
            const totalMinutes = Math.round((total % 1) * 60);
            const totalTimeStr = totalMinutes > 0 ?
              `${totalHours}:${totalMinutes.toString().padStart(2, '0')}` :
              `${totalHours}:00`;
            document.getElementById('calc-total').textContent = totalTimeStr;
            document.getElementById('calc-unit').textContent = '';
            window.holidayRequestTotal = total;
          }
        };

        // Calculate time off
        document.getElementById('calculate-btn').addEventListener('click', async () => {
          const dates = (window.rangePicker && window.rangePicker.selectedDates) || [];
          const fromDate = dates[0] ? new Date(dates[0]) : null;
          const toDate = dates[1] ? new Date(dates[1]) : (dates[0] ? new Date(dates[0]) : null);

          if (!fromDate || !toDate) {
            alert('Please select a date or range');
            return;
          }

          if (fromDate > toDate) {
            alert('End date must be after start date');
            return;
          }

          const pattern = window.workingPattern;
          if (!pattern) {
            alert('Working pattern not found. Please complete your setup first.');
            return;
          }

          // Reset holiday day data
          window.holidayDayData = {};
          let totalHours = 0;
          let totalSessions = 0;
          let totalMinutes = 0;
          let rows = [];

          // Loop through each day
          const currentDate = new Date(fromDate);
          while (currentDate <= toDate) {
            const dayName = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][currentDate.getDay()];
            const dateStr = currentDate.toLocaleDateString();
            const dateKey = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD format

            if (window.isGP) {
              const sessions = parseFloat(pattern[`${dayName}_sessions`] || 0);
              if (sessions > 0) {
                totalSessions += sessions;
                // Store calculated value
                window.holidayDayData[dateKey] = {
                  calculatedValue: sessions,
                  manualValue: null,
                  isPartDay: false,
                  dateStr: dateStr
                };
                rows.push(
                  `<div class="calc-row" data-date="${dateKey}">
                    <div class="calc-date">${dateStr}</div>
                    <div class="calc-controls">
                      <input type="checkbox" class="part-day-check" id="partday-${dateKey}"
                             onchange="togglePartDay('${dateKey}', this)">
                      <label for="partday-${dateKey}">Part day</label>
                    </div>
                    <div class="calc-badge-wrapper">
                      <div class="calc-badge calc-badge-display">${sessions} ${sessions === 1 ? 'session' : 'sessions'}</div>
                      <input type="text" class="calc-badge calc-badge-input"
                             placeholder="${window.isGP ? 'Sessions' : 'HH:MM'}"
                             style="display:none;" disabled
                             onblur="validateTimeInput('${dateKey}', this)">
                    </div>
                  </div>`
                );
              }
            } else {
              const hours = parseFloat(pattern[`${dayName}_hours`] || 0);
              if (hours > 0) {
                totalHours += Math.floor(hours);
                totalMinutes += Math.round((hours % 1) * 60);
                const displayHours = Math.floor(hours);
                const displayMinutes = Math.round((hours % 1) * 60);
                const timeStr = displayMinutes > 0 ? `${displayHours}h ${displayMinutes}m` : `${displayHours}h`;
                // Store calculated value
                window.holidayDayData[dateKey] = {
                  calculatedValue: hours,
                  manualValue: null,
                  isPartDay: false,
                  dateStr: dateStr
                };
                rows.push(
                  `<div class="calc-row" data-date="${dateKey}">
                    <div class="calc-date">${dateStr}</div>
                    <div class="calc-controls">
                      <input type="checkbox" class="part-day-check" id="partday-${dateKey}"
                             onchange="togglePartDay('${dateKey}', this)">
                      <label for="partday-${dateKey}">Part day</label>
                    </div>
                    <div class="calc-badge-wrapper">
                      <div class="calc-badge calc-badge-display">${timeStr}</div>
                      <input type="text" class="calc-badge calc-badge-input"
                             placeholder="HH:MM"
                             style="display:none;" disabled
                             onblur="validateTimeInput('${dateKey}', this)">
                    </div>
                  </div>`
                );
              }
            }

            currentDate.setDate(currentDate.getDate() + 1);
          }

          // Calculate total time for staff
          if (!window.isGP) {
            // Handle minute overflow
            totalHours += Math.floor(totalMinutes / 60);
            totalMinutes = totalMinutes % 60;
          }

          // Check for overlapping holidays
          try {
            const startDateStr = fromDate.toISOString().split('T')[0];
            const endDateStr = toDate.toISOString().split('T')[0];
            console.log('[Calculate] Checking overlaps for dates:', startDateStr, 'to', endDateStr);
            const overlaps = await checkHolidayOverlaps(startDateStr, endDateStr);
            console.log('[Calculate] Overlaps found:', overlaps);
            console.log('[Calculate] Type of overlaps:', typeof overlaps);
            console.log('[Calculate] Is array?', Array.isArray(overlaps));
            displayOverlaps(overlaps);
          } catch (overlapError) {
            console.error('[Calculate] Error checking overlaps:', overlapError);
          }

          // Display result
          const resultDiv = document.getElementById('calculation-result');
          resultDiv.style.display = 'block';
          document.getElementById('calc-list').innerHTML = rows.join('');

          if (window.isGP) {
            document.getElementById('calc-total').textContent = totalSessions;
            document.getElementById('calc-unit').textContent = totalSessions === 1 ? 'session' : 'sessions';
            // Store total sessions for submission
            window.holidayRequestTotal = totalSessions;
          } else {
            const totalTimeStr = totalMinutes > 0 ?
              `${totalHours}:${totalMinutes.toString().padStart(2, '0')}` :
              `${totalHours}:00`;
            document.getElementById('calc-total').textContent = totalTimeStr;
            document.getElementById('calc-unit').textContent = '';
            // Store total as decimal hours for submission
            window.holidayRequestTotal = totalHours + (totalMinutes / 60);
          }

          document.getElementById('submit-request').style.display = 'block';
        });

        // Submit request
        document.getElementById('submit-request').addEventListener('click', async () => {
          const sDates = (window.rangePicker && window.rangePicker.selectedDates) || [];
          const fromDate = sDates[0] ? window.rangePicker.formatDate(sDates[0], "Y-m-d") : '';
          const toDate = sDates[1] ? window.rangePicker.formatDate(sDates[1], "Y-m-d") : (sDates[0] ? window.rangePicker.formatDate(sDates[0], "Y-m-d") : '');
          const reason = document.getElementById('reason').value;

          // Recalculate total to include any manual overrides
          let total = 0;
          for (const dateKey in window.holidayDayData) {
            const dayData = window.holidayDayData[dateKey];
            if (dayData.isPartDay && dayData.manualValue !== null) {
              total += dayData.manualValue;
            } else {
              total += dayData.calculatedValue;
            }
          }

          if (!fromDate || !toDate) {
            alert('Please select dates');
            return;
          }

          const requestData = {
            user_id: user.id,
            site_id: siteId,
            start_date: fromDate,
            end_date: toDate,
            total_days: total, // This stores hours or sessions as a number
            request_type: 'annual',
            reason: reason || null,
            status: 'pending',
            requested_at: new Date().toISOString()
          };

          document.getElementById('submit-request').disabled = true;
          document.getElementById('request-msg').textContent = 'Submitting...';
          document.getElementById('request-msg').style.color = 'var(--gray-500)';

          const { data: insertedRequest, error } = await supabase
            .from('4_holiday_requests')
            .insert(requestData)
            .select()
            .single();

          if (error) {
            console.error('Request error:', error);
            document.getElementById('request-msg').textContent = 'Error submitting request: ' + error.message;
            document.getElementById('request-msg').style.color = 'var(--danger)';
            document.getElementById('submit-request').disabled = false;
          } else {
            document.getElementById('request-msg').textContent = 'Request submitted successfully!';
            document.getElementById('request-msg').style.color = 'var(--success)';

            // IMAGE GENERATION TEMPORARILY DISABLED
            // Keeping code for future development but not triggering API calls
            /*
            // Trigger image generation if a reason/destination was provided
            if (reason && insertedRequest && insertedRequest.id) {
              try {
                // Get user's avatar URL from master_users
                const { data: userData } = await supabase
                  .from('master_users')
                  .select('avatar_url')
                  .eq('auth_user_id', user.id)
                  .single();

                // Call the Edge Function to generate holiday image
                const { data: imageData, error: imageError } = await supabase.functions.invoke('generate-holiday-avatar', {
                  body: {
                    destination: reason,
                    avatarUrl: userData?.avatar_url || null,
                    requestId: insertedRequest.id
                  }
                });

                if (imageError) {
                  console.error('Image generation error:', imageError);
                  // Don't show error to user - image is optional enhancement
                } else if (imageData?.imageUrl) {
                  console.log('Holiday image generated successfully:', imageData);
                  if (imageData.costEstimate) {
                    console.log('🎯 Image Generation Cost Breakdown:', imageData.costEstimate);
                    console.log('📝 Avatar Analysis:', imageData.avatarAnalysis);
                  }
                  document.getElementById('request-msg').textContent = `Request submitted with holiday image! (Cost: ${imageData.costEstimate?.total_per_request || 'N/A'})`;
                }
              } catch (imgErr) {
                console.error('Error generating holiday image:', imgErr);
                // Continue without image - it's an optional enhancement
              }
            }
            */

            // For now, just log that feature is disabled
            if (reason && insertedRequest && insertedRequest.id) {
              console.log('Holiday image generation is currently disabled. Reason provided:', reason);
            }

            // Clear form
            if (window.rangePicker) window.rangePicker.clear();
            document.getElementById('reason').value = '';
            document.getElementById('calculation-result').style.display = 'none';
            document.getElementById('overlap-section').style.display = 'none';
            document.getElementById('submit-request').style.display = 'none';
            window.holidayDayData = {}; // Reset holiday day data

            // Reload bookings
            loadBookings();

            // Reload holiday data to update remaining balance
            loadHolidayData();

            setTimeout(() => {
              document.getElementById('request-msg').textContent = '';
              document.getElementById('submit-request').disabled = false;
            }, 3000);
          }
        });

        // Function to refresh holiday calculations
        async function refreshHolidayCalculations() {
          try {
            console.log('[my-holidays] Refreshing holiday calculations...');

            // Call the stored procedure to recalculate
            const { error } = await supabase.rpc('refresh_all_holiday_summaries');

            if (error) {
              console.error('[my-holidays] Error refreshing calculations:', error);
            } else {
              console.log('[my-holidays] Holiday calculations refreshed successfully');
              // Reload the page data
              loadHolidayData();
            }
          } catch (err) {
            console.error('[my-holidays] Error during refresh:', err);
          }
        }

        // Initial load
        loadHolidayData();

      } catch (error) {
        console.error('Error:', error);
        if (String(error.message).includes('NO_SESSION')) {
          window.location.replace('index.html');
          return;
        }
        if (String(error.message).includes('NOT_STAFF')) {
          window.location.replace('index.html');
          return;
        }
        document.getElementById('app').innerHTML = `
          <div class="panel g-12">
            <p>Error loading holiday data: ${error.message}</p>
            <button class="btn" onclick="window.location.href='staff.html'">Back to Home</button>
          </div>
        `;
      }
    })();
  </script>

  <script>
    // Icon helper function using Icons8 cute-color style
    (function(){
      function i8(name, opts = {}) {
        var base  = 'https://img.icons8.com';
        var style = opts.style || 'cute-color';
        var size  = opts.size  || 48;
        // Icons8 OMG-IMG pattern is style/size/name.png
        var path  = [style, String(size), encodeURIComponent(name) + '.png'].join('/');
        return base + '/' + path;
      }
      
      function setIcon(el){
        var name  = el.getAttribute('data-i8');
        var size  = el.getAttribute('data-i8-size');
        var style = el.getAttribute('data-i8-style') || 'fluency';
        var fallback = (el.getAttribute('data-i8-fallback') || '').toLowerCase();
        
        if (fallback === 'auto') {
          var stylesToTry = [style, 'fluency', 'color'];
          var idx = 0;
          function tryNext(){
            if (idx >= stylesToTry.length) { el.onerror = null; return; }
            var url = i8(name, {style: stylesToTry[idx++], size: size ? parseInt(size,10) : undefined});
            if (el.src !== url) el.src = url; else tryNext();
          }
          el.onerror = tryNext;
          tryNext();
        } else {
          el.src = i8(name, {style: style, size: size ? parseInt(size,10) : undefined});
        }
      }
      
      function wireIcons(){
        document.querySelectorAll('img[data-i8]').forEach(setIcon);
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', wireIcons);
      } else {
        wireIcons();
      }
      
      window.i8 = i8;
      window.setIcon = setIcon;
      window.wireIcons = wireIcons;
    })();
  </script>

    <!-- Debug Console - Persistent across all pages (HIDDEN - uncomment to re-enable) -->
    <!-- <script src="debug-console.js"></script> -->
    <!-- <script src="supabase-debug.js"></script> -->
<!-- Staff Profile Fix -->
<script src="staff-profile-fix.js"></script>
</body>
</html>

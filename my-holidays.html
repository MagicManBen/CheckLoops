<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop ‚Äî My Holidays</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://img.icons8.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <link rel="stylesheet" href="staff.css">
  <style>
    /* Holiday-specific overrides while maintaining staff.css base */
    .progress-bar {
      width: 100%;
      height: 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 12px;
      border: 1px solid var(--border-color);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent));
      transition: width 0.3s ease;
    }

    .status-pending {
      background: rgba(255, 214, 69, 0.2);
      color: var(--warning);
      border: 1px solid rgba(255, 214, 69, 0.3);
    }

    .status-approved {
      background: rgba(77, 220, 159, 0.2);
      color: var(--success);
      border: 1px solid rgba(77, 220, 159, 0.3);
    }

    .status-rejected {
      background: rgba(255, 125, 125, 0.2);
      color: var(--danger);
      border: 1px solid rgba(255, 125, 125, 0.3);
    }

    .booking-status {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
    }

    .booking-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .booking-item:hover {
      background: rgba(255,255,255,0.08);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .booking-dates {
      font-weight: 700;
      color: var(--white);
    }

    .hours-display {
      color: var(--muted);
      font-size: 14px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 16px;
      align-items: end;
      margin-bottom: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--ink);
    }

    .form-input {
      padding: 12px 14px;
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 10px;
      font-size: 14px;
      background: #ffffff;
      color: var(--ink);
    }

    .form-input::placeholder {
      color: #94a3b8;
    }

    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Ensure illus-circle is properly styled */
    .illus-circle {
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, var(--glass), var(--glass-2));
      border: 2px solid var(--border-color);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
  </style>
</head>
<body>
  <div class="bg"><div class="wave"></div><div class="wave wave2"></div></div>
  <div class="mesh"><div class="m1"></div><div class="m2"></div><div class="m3"></div></div>

  <main class="content">
    <div class="topbar panel">
      <div class="nav">
        <a href="staff.html">üè† Home</a>
        <a href="staff-scans.html">üìÑ My Scans</a>
        <a href="staff-training.html">üéì Training</a>
        <a href="my-holidays.html" class="active">üìÖ My Holidays</a>
        <a href="staff-quiz.html">üß© Quiz</a>
      </div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Loading...</div>
      <div class="pill" id="email-pill">...</div>
      <div class="pill" id="role-pill">...</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>


    <section id="holidays" class="panel g-12">
      <div class="panel-header">
        <div class="illus-circle" style="width:64px;height:64px;"><img src="https://img.icons8.com/fluency/48/calendar.png" alt="Holidays" style="width:48px;height:48px;"/></div>
        <div class="panel-title">My Holiday Allowance</div>
      </div>

      <!-- Holiday Statistics -->
      <div class="stat-row">
        <div class="stat-card g-4" style="--card-index: 0;">
          <div class="icon-wrap" style="--c: var(--stat-1-bg); --i: var(--stat-1-color);">üìä</div>
          <div>
            <div class="stat-num" id="total-allowance">0</div>
            <div class="stat-label">Total Allowance <span id="allowance-unit">hours</span></div>
          </div>
        </div>

        <div class="stat-card g-4" style="--card-index: 1;">
          <div class="icon-wrap" style="--c: var(--stat-2-bg); --i: var(--stat-2-color);">üìÖ</div>
          <div>
            <div class="stat-num" id="used-holidays">0</div>
            <div class="stat-label">Used <span id="used-unit">hours</span></div>
          </div>
        </div>

        <div class="stat-card g-4" style="--card-index: 2;">
          <div class="icon-wrap" style="--c: var(--stat-3-bg); --i: var(--stat-3-color);">‚è∞</div>
          <div style="flex: 1;">
            <div class="stat-num" id="remaining-holidays">0</div>
            <div class="stat-label">Remaining <span id="remaining-unit">hours</span></div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Booking Form -->
      <div class="panel light-panel" style="margin-top: 20px;">
        <div class="panel-header">
          <div class="illus-circle" style="width:48px;height:48px;"><img src="https://img.icons8.com/fluency/48/plus.png" alt="Request" style="width:32px;height:32px;"/></div>
          <h3 class="panel-title" style="margin: 0;">Request Time Off</h3>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">From Date</label>
            <input type="date" id="from-date" class="form-input" />
          </div>

          <div class="form-group">
            <label class="form-label">To Date</label>
            <input type="date" id="to-date" class="form-input" />
          </div>

          <button class="btn" id="calculate-btn" style="padding:10px 20px;">Calculate</button>
        </div>

        <div id="calculation-result" style="display:none; margin:16px 0; padding:16px; background:#f1f5f9; border-radius:10px;">
          <div style="font-weight:600; margin-bottom:8px;">Time Off Calculation:</div>
          <div id="calc-details" style="color:#64748b; font-size:14px;"></div>
          <div style="margin-top:12px; font-size:18px; font-weight:700;">
            Total: <span id="calc-total">0</span> <span id="calc-unit">hours</span>
          </div>
        </div>

        <div class="form-group" style="margin-top:16px;">
          <label class="form-label">Reason (optional)</label>
          <textarea id="reason" class="form-input" rows="3" placeholder="Holiday, personal time, etc."></textarea>
        </div>

        <button class="btn" id="submit-request" style="margin-top:16px; display:none;">Submit Request</button>
        <div id="request-msg" style="margin-top:12px; font-weight:600;"></div>
      </div>

      <!-- Bookings List -->
      <div class="panel" style="margin-top: 20px;">
        <div class="panel-header">
          <div class="illus-circle" style="width:48px;height:48px;"><img src="https://img.icons8.com/fluency/48/list.png" alt="Requests" style="width:32px;height:32px;"/></div>
          <h3 class="panel-title" style="margin: 0;">Your Holiday Requests</h3>
        </div>
        <div id="bookings-container">
          <!-- Bookings will be loaded here -->
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, attachLogout } from './staff-common.js';

    (async function() {
      const supabase = await initSupabase();
      attachLogout(supabase);

      try {
        const { session, profileRow } = await requireStaffSession(supabase);
        const user = session.user;
        const siteId = profileRow?.site_id || 1;

        // Set topbar using job role for staff display
        const roleDetail = profileRow?.job_role || user?.raw_user_meta_data?.job_role || 'Staff';
        setTopbar({
          siteText: await getSiteText(supabase, siteId),
          email: user.email,
          role: roleDetail.charAt(0).toUpperCase() + roleDetail.slice(1)
        });

        // Load holiday data from consolidated summary
        async function loadHolidayData() {
          console.log('[my-holidays] Loading holiday data for user:', user.email);

          // Get consolidated holiday summary
          const { data: holidaySummary, error: summaryError } = await supabase
            .from('holiday_summary')
            .select('*')
            .eq('user_id', user.id)
            .eq('year', new Date().getFullYear())
            .maybeSingle();

          console.log('[my-holidays] Holiday summary result:', { holidaySummary, summaryError });

          if (summaryError) {
            console.error('[my-holidays] Error fetching holiday summary:', summaryError);
          }

          if (!holidaySummary) {
            document.getElementById('holidays').innerHTML = `
              <div class="panel-header">
                <div class="illus-circle" style="width:64px;height:64px;"><img src="https://img.icons8.com/fluency/48/calendar.png" alt="Holidays" style="width:48px;height:48px;"/></div>
                <div class="panel-title">Holiday Setup Required</div>
              </div>
              <p>Please complete your welcome process first to set up your holiday allowance.</p>
              <button class="btn" onclick="window.location.href='staff-welcome.html'">Complete Setup</button>
            `;
            return;
          }

          // Get working pattern for calculations
          const { data: workingPattern } = await supabase
            .from('3_staff_working_patterns')
            .select('*')
            .eq('user_id', user.id)
            .maybeSingle();

          window.workingPattern = workingPattern;
          window.isGP = holidaySummary.is_gp;

          // Helper function to format hours as HH:MM
          function formatHours(decimalHours) {
            const hours = Math.floor(decimalHours || 0);
            const minutes = Math.round(((decimalHours || 0) % 1) * 60);
            return `${hours}:${minutes.toString().padStart(2, '0')}`;
          }

          // Update display using consolidated data
          const isGP = holidaySummary.is_gp;
          console.log('[my-holidays] Updating display - isGP:', isGP, 'summary:', holidaySummary);

          if (isGP) {
            // GP uses sessions
            const totalAllowance = holidaySummary.entitlement_sessions || 0;
            const usedAmount = holidaySummary.total_booked_sessions || 0;
            const remaining = holidaySummary.remaining_sessions || 0;

            document.getElementById('total-allowance').textContent = totalAllowance;
            document.getElementById('used-holidays').textContent = usedAmount;
            document.getElementById('remaining-holidays').textContent = remaining;
            document.getElementById('allowance-unit').textContent = 'sessions';
            document.getElementById('used-unit').textContent = 'sessions';
            document.getElementById('remaining-unit').textContent = 'sessions';

            // Update progress bar
            const percentage = totalAllowance > 0 ? Math.min(100, Math.max(0, (usedAmount / totalAllowance) * 100)) : 0;
            document.getElementById('progress-fill').style.width = percentage + '%';

            console.log('[my-holidays] GP display updated - Total:', totalAllowance, 'Used:', usedAmount, 'Remaining:', remaining);
          } else {
            // Non-GP uses hours
            const totalAllowance = holidaySummary.entitlement_hours || 0;
            const usedAmount = holidaySummary.total_booked_hours || 0;
            const remaining = holidaySummary.remaining_hours || 0;

            document.getElementById('total-allowance').textContent = formatHours(totalAllowance);
            document.getElementById('used-holidays').textContent = formatHours(usedAmount);
            document.getElementById('remaining-holidays').textContent = formatHours(remaining);
            document.getElementById('allowance-unit').textContent = '';
            document.getElementById('used-unit').textContent = '';
            document.getElementById('remaining-unit').textContent = '';

            // Update progress bar
            const percentage = totalAllowance > 0 ? Math.min(100, Math.max(0, (usedAmount / totalAllowance) * 100)) : 0;
            document.getElementById('progress-fill').style.width = percentage + '%';

            console.log('[my-holidays] Staff display updated - Total:', formatHours(totalAllowance), 'Used:', formatHours(usedAmount), 'Remaining:', formatHours(remaining));
          }

          // Load all bookings
          loadBookings();
        }

        // Load bookings list
        async function loadBookings() {
          const { data: bookings } = await supabase
            .from('4_holiday_requests')
            .select('*')
            .eq('user_id', user.id)
            .order('start_date', { ascending: false });

          const container = document.getElementById('bookings-container');

          if (!bookings || bookings.length === 0) {
            container.innerHTML = '<p style="color:#6b7280;">No holiday requests yet.</p>';
            return;
          }

          // Helper function to format hours as HH:MM
          function formatHours(decimalHours) {
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours % 1) * 60);
            return `${hours}:${minutes.toString().padStart(2, '0')}`;
          }

          container.innerHTML = bookings.map(booking => {
            const startDate = new Date(booking.start_date).toLocaleDateString();
            const endDate = new Date(booking.end_date).toLocaleDateString();
            const totalDays = booking.total_days || 0;

            let amount;
            if (window.isGP) {
              amount = `${totalDays} ${totalDays === 1 ? 'session' : 'sessions'}`;
            } else {
              amount = formatHours(totalDays);
            }

            return `
              <div class="booking-item">
                <div>
                  <div class="booking-dates">${startDate} - ${endDate}</div>
                  <div class="hours-display">${amount}</div>
                  ${booking.reason ? `<div style="color:#6b7280; font-size:13px; margin-top:4px;">${booking.reason}</div>` : ''}
                </div>
                <span class="booking-status status-${booking.status}">${booking.status}</span>
              </div>
            `;
          }).join('');
        }

        // Calculate time off
        document.getElementById('calculate-btn').addEventListener('click', () => {
          const fromDate = new Date(document.getElementById('from-date').value);
          const toDate = new Date(document.getElementById('to-date').value);

          if (!fromDate || !toDate || isNaN(fromDate) || isNaN(toDate)) {
            alert('Please select valid dates');
            return;
          }

          if (fromDate > toDate) {
            alert('End date must be after start date');
            return;
          }

          const pattern = window.workingPattern;
          if (!pattern) {
            alert('Working pattern not found. Please complete your setup first.');
            return;
          }

          let totalHours = 0;
          let totalSessions = 0;
          let totalMinutes = 0;
          let details = [];

          // Loop through each day
          const currentDate = new Date(fromDate);
          while (currentDate <= toDate) {
            const dayName = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][currentDate.getDay()];
            const dateStr = currentDate.toLocaleDateString();

            if (window.isGP) {
              const sessions = parseFloat(pattern[`${dayName}_sessions`] || 0);
              if (sessions > 0) {
                totalSessions += sessions;
                details.push(`${dateStr}: ${sessions} ${sessions === 1 ? 'session' : 'sessions'}`);
              }
            } else {
              const hours = parseFloat(pattern[`${dayName}_hours`] || 0);
              if (hours > 0) {
                totalHours += Math.floor(hours);
                totalMinutes += Math.round((hours % 1) * 60);
                const displayHours = Math.floor(hours);
                const displayMinutes = Math.round((hours % 1) * 60);
                const timeStr = displayMinutes > 0 ?
                  `${displayHours}h ${displayMinutes}m` :
                  `${displayHours}h`;
                details.push(`${dateStr}: ${timeStr}`);
              }
            }

            currentDate.setDate(currentDate.getDate() + 1);
          }

          // Calculate total time for staff
          if (!window.isGP) {
            // Handle minute overflow
            totalHours += Math.floor(totalMinutes / 60);
            totalMinutes = totalMinutes % 60;
          }

          // Display result
          const resultDiv = document.getElementById('calculation-result');
          resultDiv.style.display = 'block';
          document.getElementById('calc-details').innerHTML = details.join('<br>');

          if (window.isGP) {
            document.getElementById('calc-total').textContent = totalSessions;
            document.getElementById('calc-unit').textContent = totalSessions === 1 ? 'session' : 'sessions';
            // Store total sessions for submission
            window.holidayRequestTotal = totalSessions;
          } else {
            const totalTimeStr = totalMinutes > 0 ?
              `${totalHours}:${totalMinutes.toString().padStart(2, '0')}` :
              `${totalHours}:00`;
            document.getElementById('calc-total').textContent = totalTimeStr;
            document.getElementById('calc-unit').textContent = '';
            // Store total as decimal hours for submission
            window.holidayRequestTotal = totalHours + (totalMinutes / 60);
          }

          document.getElementById('submit-request').style.display = 'block';
        });

        // Submit request
        document.getElementById('submit-request').addEventListener('click', async () => {
          const fromDate = document.getElementById('from-date').value;
          const toDate = document.getElementById('to-date').value;
          const reason = document.getElementById('reason').value;
          const total = window.holidayRequestTotal || 0;

          if (!fromDate || !toDate) {
            alert('Please select dates');
            return;
          }

          const requestData = {
            user_id: user.id,
            site_id: siteId,
            start_date: fromDate,
            end_date: toDate,
            total_days: total, // This stores hours or sessions as a number
            request_type: 'annual',
            reason: reason || null,
            status: 'pending',
            requested_at: new Date().toISOString()
          };

          document.getElementById('submit-request').disabled = true;
          document.getElementById('request-msg').textContent = 'Submitting...';
          document.getElementById('request-msg').style.color = '#6b7280';

          const { error } = await supabase
            .from('4_holiday_requests')
            .insert(requestData);

          if (error) {
            console.error('Request error:', error);
            document.getElementById('request-msg').textContent = 'Error submitting request: ' + error.message;
            document.getElementById('request-msg').style.color = '#dc2626';
            document.getElementById('submit-request').disabled = false;
          } else {
            document.getElementById('request-msg').textContent = 'Request submitted successfully!';
            document.getElementById('request-msg').style.color = '#059669';

            // Clear form
            document.getElementById('from-date').value = '';
            document.getElementById('to-date').value = '';
            document.getElementById('reason').value = '';
            document.getElementById('calculation-result').style.display = 'none';
            document.getElementById('submit-request').style.display = 'none';

            // Reload bookings
            loadBookings();

            // Reload holiday data to update remaining balance
            loadHolidayData();

            setTimeout(() => {
              document.getElementById('request-msg').textContent = '';
              document.getElementById('submit-request').disabled = false;
            }, 3000);
          }
        });

        // Function to refresh holiday calculations
        async function refreshHolidayCalculations() {
          try {
            console.log('[my-holidays] Refreshing holiday calculations...');

            // Call the stored procedure to recalculate
            const { error } = await supabase.rpc('refresh_all_holiday_summaries');

            if (error) {
              console.error('[my-holidays] Error refreshing calculations:', error);
            } else {
              console.log('[my-holidays] Holiday calculations refreshed successfully');
              // Reload the page data
              loadHolidayData();
            }
          } catch (err) {
            console.error('[my-holidays] Error during refresh:', err);
          }
        }

        // Initial load
        loadHolidayData();

      } catch (error) {
        console.error('Error:', error);
        if (String(error.message).includes('NO_SESSION')) {
          window.location.replace('index.html');
          return;
        }
        if (String(error.message).includes('NOT_STAFF')) {
          window.location.replace('index.html');
          return;
        }
        document.getElementById('app').innerHTML = `
          <div class="panel g-12">
            <p>Error loading holiday data: ${error.message}</p>
            <button class="btn" onclick="window.location.href='staff.html'">Back to Home</button>
          </div>
        `;
      }
    })();
  </script>
</body>
</html>

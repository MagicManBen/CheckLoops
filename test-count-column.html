<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Count Column Upload</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .test-result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid;
        }
        .success { background-color: #d4edda; border-color: #28a745; color: #155724; }
        .error { background-color: #f8d7da; border-color: #dc3545; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #17a2b8; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffc107; color: #856404; }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
        .test-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Count Column Upload Test</h1>
        <p>This test verifies that the last column (with no header) in your CSV is correctly mapped to the "Count" column in Supabase.</p>
        
        <button id="test-btn" onclick="runFullTest()">Run Full Test</button>
        <button onclick="location.reload()">Clear Results</button>
        
        <div id="results"></div>
    </div>

    <script>
        const supabaseUrl = 'https://unveoqnlqnobufhublyw.supabase.co';
        const jwtToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME';

        function addResult(type, title, content) {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<h3>${title}</h3>${content}`;
            resultsDiv.appendChild(div);
        }

        async function runFullTest() {
            const resultsDiv = document.getElementById('results');
            const testBtn = document.getElementById('test-btn');
            
            testBtn.disabled = true;
            resultsDiv.innerHTML = '';

            try {
                // Step 1: Test uploading a record with Count value
                addResult('info', 'üì§ Step 1: Uploading Test Record', 'Creating a test record with Count = 42...');

                const testRecord = {
                    full_name_session_holder: "Test User",
                    day_of_week: "Mon",
                    session_start: "2025-09-08",
                    session_end: "2025-09-08",
                    appointment_date: "2025-09-08",
                    appointment_time: "09:00:00",
                    slot_type: "Test Slot",
                    slot_duration: "30",
                    availability: "Available",
                    dna_status: "Attended",
                    booked_time_to_slot_time: "10",
                    arrive_time_to_send_in_time: "5",
                    slot_time_to_send_in_time: "3",
                    slot_time_to_arrive_time: "2",
                    consultation_time: "15",
                    Count: "42",  // The value from the last CSV column
                    site_id: 2,
                    csv_row_number: 99999 // High number to identify this test
                };

                addResult('info', 'üìã Test Record Data', '<pre>' + JSON.stringify(testRecord, null, 2) + '</pre>');

                // Upload the test record
                const uploadUrl = `${supabaseUrl}/functions/v1/emis-upload`;
                const uploadResponse = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({ records: [testRecord] })
                });

                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    throw new Error(`Upload failed: ${uploadResponse.status} - ${errorText}`);
                }

                const uploadResult = await uploadResponse.json();
                addResult('success', '‚úÖ Upload Successful', '<pre>' + JSON.stringify(uploadResult, null, 2) + '</pre>');

                // Step 2: Retrieve the record from database
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second for data to be available

                addResult('info', 'üîç Step 2: Verifying in Database', 'Fetching the uploaded record...');

                const queryUrl = `${supabaseUrl}/rest/v1/emis_apps_raw?csv_row_number=eq.99999&select=*&order=created_at.desc&limit=1`;
                const queryResponse = await fetch(queryUrl, {
                    headers: {
                        'apikey': jwtToken,
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });

                if (!queryResponse.ok) {
                    throw new Error(`Query failed: ${queryResponse.status}`);
                }

                const dbRecords = await queryResponse.json();

                if (!dbRecords || dbRecords.length === 0) {
                    addResult('error', '‚ùå Record Not Found', 'Could not find the test record in the database.');
                    return;
                }

                const dbRecord = dbRecords[0];
                addResult('info', 'üìä Database Record', '<pre>' + JSON.stringify(dbRecord, null, 2) + '</pre>');

                // Step 3: Verify Count column
                addResult('info', 'üî¨ Step 3: Analyzing Count Column', 'Checking if Count value was preserved...');

                const columnNames = Object.keys(dbRecord);
                let countFound = false;
                let countValue = null;
                let countColumnName = null;

                // Check for different possible column names
                const possibleNames = ['Count', 'count', 'COUNT', '"Count"'];
                for (const name of possibleNames) {
                    if (dbRecord[name] !== undefined) {
                        countFound = true;
                        countValue = dbRecord[name];
                        countColumnName = name;
                        break;
                    }
                }

                let analysisHtml = '<h4>Column Name Analysis:</h4><ul>';
                analysisHtml += '<li><strong>All columns in table:</strong> ' + columnNames.length + '</li>';
                analysisHtml += '<li><strong>Column names:</strong><pre>' + columnNames.join(', ') + '</pre></li>';
                analysisHtml += '</ul>';

                if (countFound) {
                    analysisHtml += '<h4>Count Column Found!</h4><ul>';
                    analysisHtml += '<li><strong>Column name:</strong> ' + countColumnName + '</li>';
                    analysisHtml += '<li><strong>Value uploaded:</strong> "42"</li>';
                    analysisHtml += '<li><strong>Value in DB:</strong> "' + countValue + '"</li>';
                    analysisHtml += '</ul>';

                    if (countValue === "42" || countValue === 42) {
                        addResult('success', '‚úÖ TEST PASSED!', analysisHtml + 
                            '<p><strong>The Count column is working correctly!</strong> The value "42" was successfully uploaded and retrieved.</p>');
                    } else if (countValue === null) {
                        addResult('error', '‚ùå TEST FAILED', analysisHtml + 
                            '<p><strong>Problem:</strong> Count value was converted to NULL instead of preserving "42".</p>');
                    } else {
                        addResult('warning', '‚ö†Ô∏è PARTIAL SUCCESS', analysisHtml + 
                            '<p><strong>Note:</strong> Count column exists but value differs. Expected "42", got "' + countValue + '".</p>');
                    }
                } else {
                    addResult('error', '‚ùå TEST FAILED', analysisHtml + 
                        '<p><strong>Problem:</strong> Could not find a Count column in the database table.</p>' +
                        '<p>The column might be named differently or might not exist in the schema.</p>');
                }

                // Step 4: Check existing data
                addResult('info', 'üìà Step 4: Checking Existing Data', 'Looking for other records with Count values...');

                const existingUrl = `${supabaseUrl}/rest/v1/emis_apps_raw?select=*&limit=5&order=created_at.desc`;
                const existingResponse = await fetch(existingUrl, {
                    headers: {
                        'apikey': jwtToken,
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });

                if (existingResponse.ok) {
                    const existingRecords = await existingResponse.json();
                    if (existingRecords && existingRecords.length > 0) {
                        let countStats = '<h4>Recent Records Count Analysis:</h4><ul>';
                        existingRecords.forEach((rec, idx) => {
                            const recCountValue = rec['Count'] || rec['count'] || 'N/A';
                            countStats += `<li><strong>Record ${idx + 1}:</strong> Count = ${recCountValue}</li>`;
                        });
                        countStats += '</ul>';
                        addResult('info', 'üìä Sample Data', countStats);
                    }
                }

            } catch (error) {
                addResult('error', '‚ùå Test Error', '<p>' + error.message + '</p><pre>' + error.stack + '</pre>');
            } finally {
                testBtn.disabled = false;
            }
        }
    </script>
</body>
</html>

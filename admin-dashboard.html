<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>CheckLoop — Admin</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://*.supabase.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' https://*.supabase.co https://*.supabase.com wss://*.supabase.co wss://*.supabase.com https:;">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="pdf.min.js"></script>
<script src="xlsx.full.min.js"></script>
<script src="jszip.min.js"></script>
<script src="config.js"></script>
<script src="rls-fix.js"></script>
<script src="supabase-js.js"></script>
<link href="entitlement-card-styles.css" rel="stylesheet">
<script src="entitlement-card-layout.js" defer></script>
<script type="module">
  const { createClient } = supabase;
  window.supabaseCreateClient = createClient;
  // Use EXACT same configuration as admin-login.html to share sessions
  const sb = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      flowType: 'pkce',
      storage: window.localStorage,
      storageKey: `sb-${CONFIG.SUPABASE_URL.split('//')[1].split('.')[0]}-auth-token`
    }
  });
  window.supabase = sb;
  // Add small delay to prevent race condition with session loading
  setTimeout(async () => {
    try {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        console.log('Admin Dashboard: No session found, redirecting to login');
        sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
        window.location.replace('admin-login.html');
        return;
      }
      console.log('Admin Dashboard: Session found for user:', session.user.email);
      const { data: profile } = await sb
        .from('master_users')
        .select('access_type')
        .eq('auth_user_id', session.user.id)
        .maybeSingle();
      const accessType = String(profile?.access_type || '').toLowerCase();
      const isAdmin = accessType === 'admin' || accessType === 'owner';
      console.log('Admin Dashboard: Access type:', accessType, '=> isAdmin:', isAdmin);
      if (!isAdmin) {
        console.log('Admin Dashboard: Not admin, redirecting to staff portal');
        window.location.replace('staff.html');
      } else {
        console.log('Admin Dashboard: Admin access confirmed, staying on dashboard');
        // Call bootstrap to initialize the dashboard with user data
        if (typeof bootstrap === 'function') {
          console.log('Admin Dashboard: Calling bootstrap()');
          bootstrap();
        } else {
          console.log('Admin Dashboard: bootstrap() not available yet, waiting...');
          // If bootstrap isn't defined yet, wait for the module to load
          window.addEventListener('DOMContentLoaded', () => {
            if (typeof bootstrap === 'function') {
              console.log('Admin Dashboard: Calling bootstrap() after DOM ready');
              bootstrap();
            }
          });
        }
      }
    } catch (e) {
      console.log('Admin Dashboard: Error checking session, redirecting to login:', e);
      window.location.replace('admin-login.html');
    }
  }, 1000); // Wait 1 second for session to fully load
  window.CONFIG = CONFIG;
  window.addEventListener('storage', (e) => {
    if (e.key && e.key.includes('sb-') && e.newValue === null) {
      try { window.location.replace('home.html'); } catch(_) {}
    }
  });
  window.addEventListener('load', async () => {
    try { await sb.auth.getSession(); } catch(_) {}
  });
  Object.defineProperty(window, 'getSupabase', { value: () => sb });
</script>
<script>
  // Configure PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  
  // Define debugLog to prevent errors - simple no-op function
  window.debugLog = function() {};
</script>

<script>
// Move existing help icons into a neat top-right badge per page header
document.addEventListener('DOMContentLoaded', () => {
  // Find all help-icon buttons that call showHelp('view-...')
  const icons = Array.from(document.querySelectorAll('button.help-icon'));
  icons.forEach(btn => {
    // Extract view id from onclick attribute if present
    const onclick = btn.getAttribute('onclick') || '';
    const m = onclick.match(/showHelp\(['"]([^'"]+)['"]\)/);
    if (!m) return;
    const viewId = m[1];

    // Find nearest .page-header ancestor
    const header = btn.closest('.page-header');
    if (!header) return;

    // Avoid adding multiple badges
    if (header.querySelector('.page-help-badge')) {
      btn.remove();
      return;
    }

    // Create badge (letter i) to sit immediately to the right of the page title
    const badge = document.createElement('button');
    badge.className = 'page-help-badge';
    badge.setAttribute('aria-label', 'Page help');
    badge.title = 'Page help';
    // Use a compact eye glyph for clarity
    badge.innerHTML = 'i';
    badge.addEventListener('click', (e) => {
      e.preventDefault();
      showHelp(viewId);
    });

    // Choose a contrasting theme for the badge based on header background
    // Default to light theme (dark text) which works on white headers
    let themeClass = 'light';
    const panelBg = getComputedStyle(header).backgroundColor || '';
    if (panelBg.startsWith('rgb(')) {
      const nums = panelBg.replace(/[rgba\(\) ]/g, '').split(',').map(n=>parseFloat(n));
      const avg = (nums[0] + nums[1] + nums[2]) / 3;
      themeClass = avg > 200 ? 'light' : 'dark';
    }
    badge.classList.add(themeClass);

    // Insert badge into the page title wrapper so it sits right of the title
    const titleWrapper = header.querySelector('.page-title-wrapper');
    if (titleWrapper) {
      titleWrapper.appendChild(badge);
    } else {
      header.appendChild(badge);
    }

    // Remove original button
    btn.remove();
  });

  // Remove unwanted buttons from the left sidebar menu
  try {
    const labelsToRemove = ['working hours', 'dashboard'];
    const navButtons = document.querySelectorAll('#sidebar .nav button');
    navButtons.forEach((btn) => {
      const labelEl = btn.querySelector('.menu-item-label');
      const text = (labelEl?.textContent || btn.textContent || '').trim().toLowerCase();
      if (labelsToRemove.includes(text)) {
        btn.remove();
      }
    });
  } catch (e) {
    console.warn('Could not remove some sidebar buttons:', e);
  }
});
</script>
<script>
// Populate the Invite User → Team dropdown. Minimal query: teams(id,name) by site_id.
async function populateTeamsSelect() {
  try {
    if (typeof supabase === 'undefined') {
      console.error('populateTeamsSelect: Supabase not available');
      return;
    }

    const sel = document.getElementById('add-user-team');
    if (!sel) { console.warn('populateTeamsSelect: #add-user-team not found'); return; }
    sel.innerHTML = '<option value="" disabled selected>Loading teams…</option>';

    // Resolve siteId from existing context or session metadata
    let siteId = (window.ctx && window.ctx.site_id) ? window.ctx.site_id : null;
    if (!siteId) {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        const u = session?.user;
        siteId = u?.user_metadata?.site_id || u?.raw_user_meta_data?.site_id || null;
      } catch (e) {
        console.warn('populateTeamsSelect: getSession failed', e && (e.message || e));
      }
    }

    if (!siteId) {
      console.warn('populateTeamsSelect: no site_id resolved');
      sel.innerHTML = '<option value="" disabled selected>No teams available</option>';
      return;
    }

    console.log('Loading teams from teams table for site', siteId);
    const { data: teams, error } = await supabase
      .from('teams')
      .select('id, name')
      .eq('site_id', siteId)
      .order('name');

    if (error) {
      console.error('populateTeamsSelect: teams query failed', error);
      const msg = String(error.message || '').toLowerCase();
      // Helpful hint if an RLS/policy references a non-existent column like auth_user_id
      if (error.code === '42703' || msg.includes('auth_user_id') || msg.includes('column') ) {
        sel.innerHTML = '<option value="" disabled selected>DB policy error – please fix RLS on teams</option>';
      } else if (msg.includes('policy') || msg.includes('rls')) {
        sel.innerHTML = '<option value="" disabled selected>Permission denied by RLS</option>';
      } else {
        sel.innerHTML = '<option value="" disabled selected>Error loading teams</option>';
      }
      return;
    }

    if (!Array.isArray(teams) || teams.length === 0) {
      sel.innerHTML = '<option value="" disabled selected>No teams found</option>';
      return;
    }

    // Populate options
    sel.innerHTML = '<option value="" disabled selected>Select a team…</option>';
    teams.forEach(t => {
      if (!t) return;
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = t.name;
      sel.appendChild(opt);
    });
  } catch (e) {
    console.error('populateTeamsSelect: fatal', e && (e.message || e));
    const sel = document.getElementById('add-user-team');
    if (sel) sel.innerHTML = '<option value="" disabled selected>Error loading teams</option>';
  }
}

// Run when the page is ready (safe if the select exists), and also when opening the Invite modal
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => setTimeout(populateTeamsSelect, 0));
} else {
  setTimeout(populateTeamsSelect, 0);
}

// Also repopulate when the Invite User modal is opened, so the dropdown stays fresh
(document.getElementById('btn-invite-user') || {}).addEventListener?.('click', () => setTimeout(populateTeamsSelect, 0));
</script>
<style>
  :root{
    --bg1:#0b4fb3; --bg2:#062b6f; --glass:#ffffff12; --glass-2:#ffffff1a;
    --white:#e6f0ff; --muted:#b8c7e8; --ink:#eaf1ff;
    --accent:#76a7ff; --accent-2:#5f96ff; --success:#2bd4a7; --danger:#ff6b6b;
    --warning: #ffca28;
    --shadow: 0 10px 30px rgba(6,43,111,.35);
    --round:18px;
    --panel-bg: linear-gradient(145deg, #133b8a, #0c275e);
    --border-color: #ffffff1f;
    --stat-1-bg: #8e6eff33; --stat-1-color: #c4b5fd;
    --stat-2-bg: #2bd4a733; --stat-2-color: #6ee7b7;
    --stat-3-bg: #ffca2833; --stat-3-color: #ffe082;
    --stat-4-bg: #ff6b6b33; --stat-4-color: #fca5a5;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--ink); background:#0b3a86; overflow-x:hidden;
  }
  /* Silky animated background */
  .bg{
    position:fixed; inset:0; z-index:-1; overflow:hidden; background: radial-gradient(1200px 700px at 20% -10%, #6aa0ff33, transparent),
      radial-gradient(900px 600px at 90% 10%, #3566ff2e, transparent),
      linear-gradient(180deg, #0e3f93 0%, #082a69 100%);
  }
  .wave{
    position:absolute; width:160%; height:160%; left:-30%; top:-30%;
    background: conic-gradient(from 180deg at 50% 50%, #2c63ff22, #143a9622, #2c63ff22);
    filter: blur(60px);
    animation: drift 22s ease-in-out infinite alternate;
    transform-origin: 50% 50%;
  }
  .wave2{ animation-duration: 28s; mix-blend-mode: screen; }
  @keyframes drift{
    0%{ transform: rotate(0deg) scale(1.0); }
    100%{ transform: rotate(25deg) scale(1.08); }
  }

  /* Extra animated mesh and orbs for depth */
  .mesh{ position: fixed; inset: -20% -20% -20% -20%; z-index:-1; pointer-events:none; filter: blur(40px) saturate(120%); opacity:.55; }
  .m1, .m2, .m3 { position:absolute; border-radius:50%; }
  .m1{ width:55vw; height:55vw; left:-10%; top:-10%; background:radial-gradient(closest-side, #4f89ff55, transparent 70%); animation: blobA 26s ease-in-out infinite alternate; }
  .m2{ width:45vw; height:45vw; right:-8%; top:10%; background:radial-gradient(closest-side, #2bd4a755, transparent 70%); animation: blobB 32s ease-in-out infinite alternate; }
  .m3{ width:60vw; height:60vw; left:20%; bottom:-15%; background:radial-gradient(closest-side, #ffca2850, transparent 70%); animation: blobC 38s ease-in-out infinite alternate; }
  @keyframes blobA{ from{ transform: translate(0,0) rotate(0deg); } to{ transform: translate(6%,4%) rotate(30deg); } }
  @keyframes blobB{ from{ transform: translate(0,0) rotate(0deg); } to{ transform: translate(-4%,6%) rotate(-25deg); } }
  @keyframes blobC{ from{ transform: translate(0,0) rotate(0deg); } to{ transform: translate(4%,-3%) rotate(18deg); } }

  /* Floating particles animation */
  .particles { position: fixed; inset: 0; z-index: -1; pointer-events: none; overflow: hidden; }
  .particle { position: absolute; width: 4px; height: 4px; background: rgba(118, 167, 255, 0.6); border-radius: 50%; animation: floatUp 15s linear infinite; }
  .particle:nth-child(odd) { background: rgba(43, 212, 167, 0.6); animation-duration: 18s; }
  .particle:nth-child(3n) { background: rgba(255, 202, 40, 0.6); animation-duration: 20s; }
  @keyframes floatUp { 
    0% { transform: translateY(100vh) scale(0); opacity: 0; } 
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(-100vh) scale(1.5); opacity: 0; } 
  }

  /* Glowing orbs */
  .orb { position: fixed; border-radius: 50%; filter: blur(40px); opacity: 0.3; animation: orbFloat 20s ease-in-out infinite; pointer-events: none; z-index: -1; }
  .orb1 { width: 300px; height: 300px; background: radial-gradient(circle, #7db1ff, transparent); top: 10%; left: 10%; animation-delay: 0s; }
  .orb2 { width: 200px; height: 200px; background: radial-gradient(circle, #2bd4a7, transparent); bottom: 20%; right: 10%; animation-delay: 5s; }
  .orb3 { width: 250px; height: 250px; background: radial-gradient(circle, #ffca28, transparent); top: 50%; left: 50%; animation-delay: 10s; }
  @keyframes orbFloat { 0%, 100% { transform: translate(0, 0); } 33% { transform: translate(30px, -30px); } 66% { transform: translate(-20px, 20px); } }

  /* Layout */
  .app{ display:grid; --sidebarW:260px; grid-template-columns: var(--sidebarW) minmax(0, 1fr); gap:22px; padding:22px; min-height:100vh; transition: grid-template-columns .2s ease; }
  .app.collapsed{ --sidebarW:56px; }
  /* Disable transitions during resize for smooth dragging */
  .app.is-resizing { transition: none !important; }
  .sidebar{
    background: linear-gradient(180deg, #1a4ea8 0%, #0e367e 100%);
    border-radius:20px; box-shadow: var(--shadow); padding:14px;
    transition: width 0.2s; position:relative; z-index:10;
  }
  .app.collapsed #sidebar {
    overflow-x: hidden;
    padding-left: 6px;
    padding-right: 6px;
  }
  /* When collapsed, ensure the toggle remains visible and centered at the top */
  .app.collapsed #sidebar > .sidebar-toggle { float: none; display: inline-grid; margin: 10px auto; }
  .app.collapsed #sidebar .brand .t,
  .app.collapsed #sidebar .brand .hint,
  .app.collapsed #sidebar .menu-item-label { display:none; }
  .app.collapsed #sidebar .nav button{ justify-content:center; gap:0; padding:10px; }
  .app.collapsed #sidebar .icon{ margin:0; }
  .sidebar-toggle {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--white);
    margin: 8px 6px;
    padding: 8px;
    display: inline-grid;
    place-items: center;
    border-radius: 10px;
    transition: transform .18s ease, background .12s ease, color .12s ease;
    background: transparent;
  }
  .sidebar-toggle:focus { outline: 2px solid var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,.12); }
  .sidebar-toggle:hover { background: #ffffff12; }
  .sidebar-toggle-icon { color: var(--white); width:18px; height:18px; display:block; transition: transform .22s ease; }
  /* When the app is collapsed, rotate the chevron to point the other direction */
  .app.collapsed .sidebar-toggle-icon { transform: rotate(180deg); }

  /* Position the toggle visually near the top-right of the sidebar but keep it in the DOM flow */
  .sidebar > .sidebar-toggle { float: right; margin-top: 10px; margin-right: 6px; }
  .brand{ display:flex; align-items:center; gap:10px; padding:10px 12px 16px; }
  .brand .logo{ width:32px; height:32px; border-radius:10px; object-fit:contain; box-shadow: inset 0 0 0 2px #ffffff33; }
  .brand .t{ font-weight:800; letter-spacing:.2px }
  .menu-item-label{ font-weight:600; }

  .nav{ display:flex; flex-direction:column; gap:6px; margin-top:6px; }
  .nav button{
    all:unset; display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px;
    cursor:pointer; color:var(--white); opacity:.85; position:relative; z-index:5;
    transition: transform .12s ease, background .2s ease, opacity .2s ease;
    pointer-events:auto;
  }
  /* Group toggle for grouped menus (Configure / Checks & Audits) */
  .nav-group-toggle {
    all:unset; display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:8px 12px; color:var(--muted); font-weight:700; font-size:12px; cursor:pointer;
    border-radius:8px; margin-top:8px; position:relative; z-index:6; pointer-events:auto;
  }
  .nav-group-toggle:hover { background: #ffffff08; }
  .nav-group-toggle .caret {
    display:inline-block; width:10px; height:10px; transform-origin:center; transition: transform .18s ease, border-color .18s ease;
    border-right:2px solid var(--muted); border-bottom:2px solid var(--muted); transform: rotate(-45deg);
  }
  .nav-group-toggle[aria-expanded="true"] .caret { transform: rotate(45deg); border-color: var(--accent-2); }
  .nav-group { display:flex; flex-direction:column; gap:6px; padding-left:4px; }
  .nav-group.collapsed { display:none; }
  /* Tweak group toggles when sidebar collapsed: keep a compact, centred caret so the
     user still sees grouping affordance and icons remain visible (avoid disappearing UI). */
  .app.collapsed #sidebar .nav .nav-group-toggle {
    display:flex; align-items:center; justify-content:center; gap:0;
    padding:8px; border-radius:8px; margin-top:8px;
    color: var(--muted); background: transparent;
  }
  /* Ensure the caret remains visible and compact */
  .app.collapsed #sidebar .nav .nav-group-toggle .caret { display:block; transform: rotate(0deg); border-color: var(--muted); }

  /* Keep icons visible and consistent when collapsed */
  .app.collapsed #sidebar .nav .icon { margin:0; width:28px; height:28px; }

  /* Resize handle styling */
  #sidebar-resize-handle{
    position: absolute; top:0; right: -6px; width: 12px; height:100%; cursor: ew-resize; z-index:30;
    display:flex; align-items:center; justify-content:center; background: transparent;
  }
  #sidebar-resize-handle::before{
    content:''; width:2px; height:40px; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.14)); border-radius:2px;
    box-shadow: 0 0 0 6px transparent; transition: box-shadow .12s ease;
  }
  #sidebar-resize-handle:active::before{ box-shadow: 0 0 8px 2px rgba(0,0,0,0.12); }

  /* User Profile Section */
  .user-profile {
    margin-top: auto;
    padding: 12px 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    border-top: 1px solid rgba(255,255,255,0.06);
  }

  .user-row {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
  }

  .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 18px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    transition: transform 0.18s ease;
    flex-shrink: 0;
  }

  .user-avatar:hover { transform: scale(1.04); }

  .user-details {
    text-align: left;
    min-width: 0;
    flex: 1;
  }

  .user-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--white);
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .site-info {
    font-size: 12px;
    color: var(--muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .btn-signout {
    all: unset;
    padding: 8px;
    border-radius: 8px;
    background: rgba(255,255,255,0.06);
    color: var(--white);
    cursor: pointer;
    transition: background 0.18s ease, transform 0.12s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
  }

  .btn-signout svg { width: 18px; height: 18px; }

  .btn-signout:hover { background: rgba(255,255,255,0.14); transform: translateY(-1px); }

  /* Staff View button spacing and fallback positioning */
  #staff-return { padding: 6px 8px; }
  #staff-return a { display:block; padding:8px 12px; width: calc(100% - 16px); box-sizing: border-box; margin: 0 6px; border-radius: 10px; text-align:left; }
  /* ensure the arrow and text have breathing room within sidebar */
  #staff-return a::before { content: '←'; margin-right:8px; opacity:0.95; }
  #staff-fallback { left:18px; top:18px; }
  #staff-fallback a { padding:8px 12px; border-radius:10px; box-shadow: 0 6px 18px rgba(2,6,23,0.06); }

  /* Make Sign Out visually match the Staff View button and be same height */
  #signout {
    display: block;
    padding: 8px 12px;
    /* Align visual width/offset with the Staff View button above */
    width: calc(100% - 8px);
    box-sizing: border-box;
    margin: 0 2px 8px 2px; /* 12px parent padding + 2px margin = 14px offset (same as #staff-return: 8px padding + 6px margin) */
    border-radius: 10px;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #signout::before {
    content: '';
    display: inline-block;
    width: 14px; height: 14px;
    margin-right: 8px;
    vertical-align: -1px;
    background-repeat: no-repeat;
    background-size: 14px 14px;
    /* small logout SVG (stroke color inherits via filter not reliable in data URI) */
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4'/><polyline points='16 17 21 12 16 7'/><line x1='21' y1='12' x2='9' y2='12'/></svg>");
  }

  /* Collapsed sidebar adjustments */
  .app.collapsed .user-profile { padding: 12px 6px; }
  .app.collapsed .user-avatar { width: 36px; height: 36px; font-size: 14px; }
  .app.collapsed .user-details { display: none; }
  .app.collapsed .btn-signout { padding: 6px; }


  /* Hide nav-group-toggle label text when collapsed but keep the caret visible */
  .app.collapsed #sidebar .nav .nav-group-toggle { font-size: 0; }
  .app.collapsed #sidebar .nav .nav-group-toggle .caret { display:inline-block; width:10px; height:10px; transform-origin:center; border-right:2px solid var(--muted); border-bottom:2px solid var(--muted); }
  .app.collapsed #sidebar .nav .nav-group-toggle[aria-expanded="true"] .caret { transform: rotate(45deg); border-color: var(--accent-2); }
  
  /* When collapsed: show all icons for every page (flatten groups into the icon rail).
    Hide the group toggle labels so the rail is compact, but keep child buttons visible
    as centered icons for direct access. This restores the previous behaviour where
    minimized sidebar shows every page's icon. */
  .app.collapsed #sidebar .nav .nav-group-toggle { display: none !important; }
  .app.collapsed #sidebar .nav .nav-group { display: flex !important; flex-direction: column; gap:6px; padding-left: 0 !important; }
  .app.collapsed #sidebar .nav .nav-group.collapsed { display: flex !important; }
  .app.collapsed #sidebar .nav .nav-group button { all:unset; display:flex !important; align-items:center; justify-content:center; padding:10px; border-radius:8px; }
  /* Hide text/badges when collapsed — only icons should remain visible */
  .app.collapsed #sidebar .menu-item-label, .app.collapsed #sidebar .nav .nav-badge { display:none !important; }
  /* Ensure every nav button is visible in collapsed mode (covers edge cases where scripts add/remove classes) */
  .app.collapsed #sidebar .nav, .app.collapsed #sidebar .nav * { visibility: visible !important; }
  .app.collapsed #sidebar .nav button { display:flex !important; opacity:1 !important; }
  .app.collapsed #sidebar .nav .icon { display:block !important; }
  .nav button:hover{ transform: translateY(-1px); background: #ffffff14; opacity:1; }
  .nav button.active{ background:var(--accent); color:var(--white); opacity:1; font-weight:600; }
  .nav .icon{
    width:32px; height:32px; /* Larger, more legible icons */
    object-fit:contain; opacity:1;
    color: var(--white) !important; /* SVGs use currentColor */
    flex-shrink:0; display:inline-flex; align-items:center; justify-content:center;
  }
  .nav .icon svg{ width:100%; height:100%; stroke-width:3.2; }
  /* Bitmap-only filters (kept for legacy PNGs if any remain elsewhere) */
  .nav img.icon{ filter: brightness(0) invert(1); }
  .nav button.active img.icon{
    /* Approximate green for bitmap icons */
    filter: invert(64%) sepia(41%) saturate(498%) hue-rotate(98deg) brightness(92%) contrast(92%);
  }
  /* Ensure bitmap icons match SVG sizing */
  .nav img.icon{ width:32px; height:32px; object-fit:contain; }

  .nav-badge {
    margin-left: auto;
    font-size: 11px;
    background: var(--glass-2);
    padding: 2px 6px;
    border-radius: 99px;
    line-height: 1;
    opacity: 0.85;
  }
  .nav button.active .nav-badge {
    background: var(--accent);
    color: #fff;
  }
  .tab-controls .btn.secondary.active { background: var(--accent-2); border-color: var(--accent); color: var(--white); }


  .nav button:hover .icon{ opacity:1; }

  .content{ 
    padding:6px;
    height: calc(100vh - 44px); /* Account for app padding */
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .search{
    flex:1; background:#ffffff17; border-radius:100px; padding:10px 14px; display:flex; align-items:center; gap:10px;
  }
  .search input{ all:unset; color:var(--ink); width:100%; font-size:14px; }
  .pill{ padding:8px 12px; border-radius:999px; background:#ffffff17; }
  .btn{ all:unset; padding:9px 14px; border-radius:12px; background:linear-gradient(135deg,#7db1ff,#4f89ff); color:#fff; font-weight:600; cursor:pointer; }
  .btn.secondary{ background:#ffffff1e; border:1px solid #ffffff26; }

  .panel{
    background: linear-gradient(145deg, rgba(19, 59, 138, 0.8), rgba(12, 39, 94, 0.9));
    border:1px solid var(--border-color); border-radius:22px; padding:24px; 
    box-shadow: var(--shadow), inset 0 1px 0 rgba(255,255,255,0.1);
    backdrop-filter: blur(12px);
    position: relative;
    overflow: hidden;
    animation: panelGlow 4s ease-in-out infinite;
  }
  @keyframes panelGlow { 
    0%, 100% { box-shadow: var(--shadow), inset 0 1px 0 rgba(255,255,255,0.1); } 
    50% { box-shadow: var(--shadow), inset 0 1px 0 rgba(255,255,255,0.1), 0 0 30px rgba(118, 167, 255, 0.3); } 
  }
  .panel::before{
    content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
    animation: shimmer 8s ease-in-out infinite;
  }
  @keyframes shimmer { 0%, 100% { left: -100%; } 50% { left: 100%; } }
  .panel-header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
  .panel-header svg { width:22px; height:22px; color:var(--accent); }
  .panel-title { font-weight:700; font-size:18px; }

  .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
  .g-12{ grid-column: span 12; }
  .g-6{ grid-column: span 6; }
  .g-4{ grid-column: span 4; }
  .g-3{ grid-column: span 3; }

  .h1{ font-size:32px; font-weight:900; letter-spacing:.2px; margin:6px 0 8px; }
  .muted{ color:var(--muted) }

  /* Modern clean global table styles */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: #ffffff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  table thead {
    background: linear-gradient(90deg, #4f46e5, #6366f1);
    color: #fff;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  table thead th {
    padding: 14px 16px;
    text-align: left;
  }

  table tbody tr {
    background: #fff;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  table tbody tr:nth-child(even) {
    background: #f9fafb;
  }
  table tbody tr:hover {
    transform: scale(1.01);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    background: #f3f4f6;
  }
  table td {
    padding: 12px 16px;
    border-bottom: 1px solid #e5e7eb;
    color: #111827;
  }

  table tbody tr:last-child td {
    border-bottom: none;
  }

  table tbody {
    animation: fadeInUp 0.4s ease;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .table-wrap{ overflow:auto; max-height:420px; background: rgba(19, 59, 138, 0.4); border-radius: 12px; padding: 4px; backdrop-filter: blur(10px); box-shadow: inset 0 0 20px rgba(255,255,255,0.05); }
  .chip{ padding:4px 8px; background:#ffffff20; border-radius:999px; font-size:12px; display:inline-block }
  .chip.success { background: var(--stat-2-bg); color: var(--stat-2-color); }
  .chip.danger { background: var(--stat-4-bg); color: var(--stat-4-color); }
  .chip.warning { background: var(--stat-3-bg); color: var(--stat-3-color); }


  /* Sections (SPA) */
  section.view{ display:none; }
  section.view.active{ 
    display: flex; /* Changed from block to flex */
    animation: fadeIn .18s ease;
    flex: 1;
    overflow: hidden;
    flex-direction: column;
  }
  
  /* Make panels fill available space */
  section.view .panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin-bottom: 0; /* Remove bottom margin to use full space */
  }
  
  /* Specific table containers should be scrollable */
  .table-wrap {
    flex: 1;
    overflow-y: auto;
    margin-top: 16px;
  }
  
  /* Dashboard grid adjustments */
  section.view .grid {
    flex: 1;
    overflow-y: auto;
  }
  
  /* Grid panels should maintain their size but allow content scrolling */
  .grid .panel {
    flex: none; /* Don't flex in grid layout */
    min-height: 200px; /* Minimum size for grid panels */
  }
  
  /* Content within grid panels should be scrollable if needed */
  .grid .panel .table-wrap {
    max-height: 400px; /* Reasonable max height for grid tables */
  }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(3px)} to{opacity:1; transform:none} }

  /* Auth overlay */
  .auth{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:24px; background: #071c44d0; backdrop-filter: blur(6px); z-index: 10;
  }
  .auth.show{ display:flex; }
  .auth:not(.show) { pointer-events:none; }
  .card{ background:#0b2a64; border:1px solid #ffffff1f; border-radius:20px; box-shadow:var(--shadow); padding:22px; width:min(460px, 92vw); }
  .card h2{ margin:0 0 12px; }
  .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0; }
  .field input, .field textarea { all:unset; background:#ffffff17; border:1px solid #ffffff24; padding:12px 12px; border-radius:12px; }
  .field textarea { min-height: 60px; }
  .hint{ font-size:12px; color:#b9c9ff; opacity:.9 }
  /* Dark-select styling for Windows/Edge */
  .ui-select{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    background:#0b2a64; color:var(--ink);
    border:1px solid #ffffff24; border-radius:12px; padding:12px; width:100%;
  }
  .ui-select:focus{ outline:2px solid var(--accent); box-shadow:0 0 0 3px #76a7ff40; }
  .ui-select option{ background:#0b2a64; color:var(--ink); }
  .ui-select option:disabled{ color:#8aa0cf; }
  @media (forced-colors: active){
    .ui-select{ forced-color-adjust:none; background:Canvas; color:CanvasText; border-color:GrayText; }
    .ui-select option{ background:Canvas; color:CanvasText; }
  }
  .error{ color:var(--danger); font-size:12px; margin-top:6px; }

  .footer{ text-align:center; font-size:12px; color:#b7c8ff; opacity:.9; padding:22px 0; }

  /* Modal styles */
  .modal { 
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 30;
    background: rgba(7,28,68,0.85);
  }
  .modal.show { 
    display: flex; 
  }
  .modal:not(.show) { pointer-events:none; }
  .modal-content { 
    background: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 18px;
    padding: 22px;
    box-shadow: var(--shadow);
    color: var(--white);
  }
  /* CRUD modal tweaks: keep buttons visible, make fields scrollable and more compact */
  #crud-modal .card {
    display: flex;
    flex-direction: column;
    max-height: 88vh; /* slightly taller but still limited */
    width: min(880px, 98vw); /* wider modal for more horizontal space */
    padding: 20px 22px;
  }
  #crud-modal form { display: flex; flex-direction: column; gap: 0; }
  #crud-fields {
  flex: 1 1 auto; /* let fields take remaining space */
  overflow-y: auto;
  padding-right: 8px; /* space for scrollbar */
  margin-bottom: 12px;
  /* Keep fields area within viewport so modal footer/buttons remain visible */
  max-height: calc(88vh - 140px); /* account for title and buttons */
  }
  /* Grid for form fields: single column on small screens, two balanced columns on wider */
  #crud-fields .crud-grid { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 16px 24px; 
    align-items: start;
  }
  @media (min-width: 760px) {
    #crud-fields .crud-grid { grid-template-columns: 1fr 1fr; }
    /* allow some fields to span full width when needed */
    #crud-fields .field.full { grid-column: 1 / -1; }
  }
  
  /* Standardize all field containers and inputs for perfect alignment */
  #crud-modal .field { 
    box-sizing: border-box; 
    display: flex; 
    flex-direction: column; 
  }
  
  #crud-modal .field label { 
    margin-bottom: 6px; 
    font-weight: 600; 
    font-size: 14px; 
    line-height: 1.3;
    min-height: 18px; /* consistent label height */
  }
  
  /* Standardize ALL input elements to same height and styling */
  #crud-modal .field input[type="text"],
  #crud-modal .field input[type="date"], 
  #crud-modal .field .ui-select,
  #crud-modal .field select {
    height: 44px;
    padding: 0 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text);
    font-size: 14px;
    box-sizing: border-box;
    line-height: 1.4;
  }
  
  /* Textareas get consistent styling but variable height */
  #crud-modal .field textarea { 
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text);
    font-size: 14px;
    box-sizing: border-box;
    resize: vertical;
    min-height: 88px;
    line-height: 1.4;
  }
  
  #crud-modal .field.full textarea { 
    min-height: 120px; 
  }
  
  /* Checkbox styling to align with other inputs */
  #crud-modal .field input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: 8px;
  }
  
  /* Multi-select and datepicker wrapper alignment */
  #crud-modal .datepicker-wrapper {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  #crud-modal .datepicker-wrapper input {
    flex: 1;
  }
  
  #crud-modal .multi-select-wrapper {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  #crud-modal .staff-chips {
    min-height: 44px;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }
  
  /* File upload styling */
  .file-upload-area {
    transition: all 0.3s ease;
  }
  
  .file-upload-area:hover {
    opacity: 0.9;
  }
  
  .file-upload-area button {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: var(--white);
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(118, 167, 255, 0.3);
  }
  
  .file-upload-area button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(118, 167, 255, 0.4);
  }
  
  .file-upload-area button span {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  /* Modern form enhancements */
  .datepicker-wrapper { display: flex; gap: 8px; align-items: center; }
  .modern-datepicker { flex: 1; }
  
  /* Toggle completed button styling */
  #toggle-completed-btn:hover {
    background: rgba(255,255,255,0.2) !important;
    transform: scale(1.1);
  }
  #toggle-completed-btn:active {
    transform: scale(0.95);
  }
  
  /* Dashboard animations */
  @keyframes pulse {
    0% { transform: scale(1); opacity: 0.1; }
    50% { transform: scale(1.1); opacity: 0.2; }
    100% { transform: scale(1); opacity: 0.1; }
  }
  
  @keyframes scoreAnimation {
    0% { stroke-dashoffset: 565.48; }
    100% { stroke-dashoffset: 282.74; }
  }
  
  .metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.12);
  }
  
  .quick-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  /* PIR Progress Toggle Button */
  #pir-progress-toggle:hover {
    background: rgba(59, 130, 246, 0.2) !important;
    border-color: rgba(59, 130, 246, 0.5) !important;
    transform: scale(1.05);
  }
  
  #pir-progress-toggle:active {
    transform: scale(0.95);
  }
  .quick-date { 
    height: 44px !important; 
    padding: 0 12px !important; 
    font-size: 14px; 
    white-space: nowrap; 
    border-radius: 8px !important;
    line-height: 1.4;
  }
  
  .age-select { font-weight: 500; }
  
  .multi-select-wrapper { display: flex; flex-direction: column; gap: 8px; }
  .staff-chips { display: flex; flex-wrap: wrap; gap: 6px; min-height: 24px; }
  .staff-chip { 
    background: var(--accent); 
    color: white; 
    padding: 6px 10px; 
    border-radius: 12px; 
    font-size: 12px; 
    display: flex; 
    align-items: center; 
    gap: 4px;
  }
  .staff-chip button { 
    background: none; 
    border: none; 
    color: white; 
    cursor: pointer; 
    padding: 0; 
    margin-left: 4px;
  }
  
  .category-select, .status-select, .priority-select, .avenue-select {
    font-weight: 500;
  }
  
  .category-select option[data-color]:not([value=""]) { font-weight: 600; }
  .status-select option[data-color]:not([value=""]) { font-weight: 600; }
  .priority-select option[data-color]:not([value=""]) { font-weight: 600; }
  
  /* Enhanced field labels with better spacing and icons */
  #crud-modal .field label { 
    font-weight: 600; 
    font-size: 13px; 
    margin-bottom: 4px;
    display: block;
  }

  /* Custom Time Input Styles */
  .time-input-container {
    display: flex;
    align-items: center;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    overflow: hidden;
    width: 120px;
  }
  
  .time-input {
    display: flex;
    align-items: center;
    flex: 1;
    padding: 8px 12px;
    color: var(--text);
    font-size: 16px;
    font-weight: 600;
    text-align: center;
    min-width: 0;
  }
  
  .time-display {
    font-family: 'Courier New', monospace;
    font-size: 18px;
    font-weight: 700;
    color: var(--white);
    min-width: 60px;
    text-align: center;
  }
  
  .time-controls {
    display: flex;
    flex-direction: column;
    border-left: 1px solid var(--border-color);
  }
  
  .time-control-hours, .time-control-minutes {
    display: flex;
    flex-direction: column;
  }
  
  .time-arrow {
    background: rgba(255,255,255,0.1);
    border: none;
    color: var(--white);
    cursor: pointer;
    padding: 4px 8px;
    font-size: 12px;
    line-height: 1;
    transition: background 0.2s ease;
    user-select: none;
  }
  
  .time-arrow:hover {
    background: rgba(255,255,255,0.2);
  }
  
  .time-arrow:active {
    background: rgba(255,255,255,0.3);
  }
  
  .time-separator {
    width: 1px;
    background: var(--border-color);
    height: 100%;
  }
  
  .working-pattern-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 16px;
  }
  
  .day-input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  
  .day-label {
    font-weight: 600;
    font-size: 14px;
    color: var(--white);
  }
  
  .schedule-clickable {
    cursor: pointer;
    color: var(--accent-2);
    text-decoration: underline;
    transition: color 0.2s ease;
  }
  
  .schedule-clickable:hover {
    color: var(--accent);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .modal-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }
  .modal-close {
    all: unset;
    cursor: pointer;
    background: #ffffff12;
    border-radius: 999px;
    width: 34px;
    height: 34px;
    display: grid;
    place-items: center;
  }

  /* Training Matrix Styles */
  .training-matrix {
    overflow-x: auto;
    background: var(--panel-bg);
    border-radius: 16px;
    border: 1px solid var(--border-color);
  }
  .training-matrix table {
    min-width: 800px;
    border-collapse: separate;
    border-spacing: 0;
  }
  .training-matrix th {
    background: var(--panel-bg);
    position: sticky;
    top: 0;
    z-index: 2;
    writing-mode: vertical-lr;
    text-orientation: mixed;
    width: 120px;
    max-width: 120px;
    padding: 16px 8px;
    font-size: 12px;
    border-right: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
  }
  .training-matrix th:first-child {
    writing-mode: horizontal-tb;
    text-orientation: initial;
    width: 200px;
    max-width: 200px;
    position: sticky;
    left: 0;
    z-index: 3;
  }
  .training-matrix td {
    padding: 8px;
    border-right: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    font-size: 11px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 40px;
    position: relative;
  }
  .training-matrix td:first-child {
    position: sticky;
    left: 0;
    background: var(--panel-bg);
    z-index: 1;
    cursor: default;
    font-weight: 600;
    text-align: left;
    padding-left: 16px;
  }
  .training-matrix td.training-cell:hover {
    background: var(--glass-2);
    transform: scale(1.02);
  }
  
  /* Training Status Colors */
  .training-completed { background: var(--stat-2-bg); color: var(--stat-2-color); }
  .training-expiring { background: var(--stat-3-bg); color: var(--stat-3-color); }
  .training-expired { background: var(--stat-4-bg); color: var(--stat-4-color); }
  .training-missing { background: var(--glass); color: var(--muted); opacity: 0.6; }

  /* Make complaints reporting button more obvious only when active */
  .nav button[data-section="complaints-reporting"].active {
    background: linear-gradient(135deg, #ff6b6b22, #ff6b6b33) !important;
    border: 1px solid #ff6b6b44 !important;
    box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2) !important;
  }
  .nav button[data-section="complaints-reporting"].active:hover {
    background: linear-gradient(135deg, #ff6b6b33, #ff6b6b44) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3) !important;
  }
  .nav button[data-section="complaints-reporting"].active .icon {
    color: #ff6b6b !important;
  }

  /* Small screens */
  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    .sidebar{ position:sticky; top:0; z-index:2; }
    .g-4 { grid-column: span 12; }
  }
  @media (max-width: 600px){
    .stat-card { grid-column: span 12; }
  }

  /* Stat cards */
  .stat-card {
    display:flex; align-items:center; gap:16px;
    background: var(--glass); padding:16px; border-radius:16px;
    border: 1px solid var(--glass-2);
  }
  .stat-card .icon-wrap {
    width:48px; height:48px; border-radius:12px;
    display:grid; place-items:center; flex-shrink:0;
    background: var(--c); color: var(--i);
  }
  .stat-card .icon-wrap svg { width:24px; height:24px; }
  .stat-num { font-size:28px; font-weight:700; line-height:1.1; color:var(--white); }
  .stat-label { font-size:14px; color:var(--muted); }

  /* Weekly Calendar styles */
  .cal-day{ background:#ffffff0f; border:1px solid #ffffff1e; border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:8px; }
  .cal-day-header { display: flex; justify-content: space-between; align-items: baseline; }
  .cal-day-label { font-weight: 600; color: var(--white); }
  .cal-day-summary { font-size: 12px; color: var(--muted); }
  .cal-day-bar-bg { width: 100%; height: 8px; background: var(--glass-2); border-radius: 99px; overflow: hidden; }
  .cal-day-bar-fg { height: 100%; background: var(--success); width: 0%; border-radius: 99px; transition: width .4s ease; }
  .cal-day-bar-fg.danger { background: var(--danger); }
  .cal-day-metrics { display: flex; justify-content: space-between; font-size: 11px; }
  .cal-metric.success { color: var(--success); }
  .cal-metric.danger { color: var(--danger); }
  
  /* Row hover/selected across all tables */
  tbody tr.selected{ background:#ffffff1e !important; }
  tbody[data-entity] tr{ cursor:pointer; }
  #subs-tbody tr { cursor: pointer; }


  /* Items view: full-height + sortable */
  /* Items view styles - now handled by general panel styles */
  #view-items .table-wrap{ flex:1; max-height:none; overflow:auto; }
  #view-items thead th.sortable{ cursor:pointer; user-select:none; }
  #view-items thead th .arrow{ font-size:11px; opacity:.9; margin-left:6px }

  /* Quiz view: allow table to fill the full height of the page */
  #view-quiz .table-wrap{ flex:1; max-height:none; overflow:auto; }

  /* Monthly Calendar Styles */
  #cal-grid { grid-auto-rows: 1fr; align-items: start; }
  .cal-cell {
    background: var(--glass);
    border: 1px solid var(--glass-2);
    border-radius: 12px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    font-size: 12px;
    transition: background .12s ease;

    /* Keep cells perfectly square regardless of content/viewport */
    aspect-ratio: 1 / 1;
    min-height: 0; /* allow grid to calculate height from width */
    overflow: hidden;
  }
  .cal-cell.is-clickable { cursor: pointer; }
  .cal-cell.is-clickable:hover { background: var(--glass-2); }
  .cal-cell.other-month { opacity: .4; background: transparent; border-color:transparent; pointer-events:none; }
  .cal-cell.is-today .cal-day-num {
    background: var(--accent);
    color: var(--white);
    font-weight: 700;
  }
  .cal-day-num {
    font-weight: 600;
    font-size: 14px;
    width: 26px; height: 26px;
    display: grid; place-items: center;
    border-radius: 999px;
    margin-bottom: 4px;
    transition: all .2s ease;
    flex-shrink: 0;
  }
  .cal-tasks {
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 11px;
    padding-right: 4px; /* for scrollbar */
  }
  /* Custom scrollbar for task list */
  .cal-tasks::-webkit-scrollbar { width: 4px; }
  .cal-tasks::-webkit-scrollbar-track { background: transparent; }
  .cal-tasks::-webkit-scrollbar-thumb { background: #ffffff33; border-radius: 4px; }

  .cal-task {
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cal-task-status {
    width: 18px; height: 18px;
    border-radius: 999px;
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: var(--white);
    background: var(--muted);
    opacity: .9;
    line-height: 1;
  }
  .cal-task-status.scheduled { background: var(--muted); color: var(--white); opacity: .85; }
  .cal-task-status.done { background: var(--success); color: var(--white); }
  .cal-task-status.missed { background: var(--danger); color: var(--white); }

  .freq-badge {
    font-size:10px;
    padding:2px 6px;
    border-radius:999px;
    background: rgba(255,255,255,0.06);
    color: var(--muted);
    margin-left: 8px;
    flex-shrink: 0;
  }
  .cal-legend { display:flex; gap:14px; align-items:center; color:var(--muted); font-size:12px; margin-bottom:12px; }
  .cal-legend .item { display:flex; gap:8px; align-items:center; }
  .cal-legend .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
  .cal-legend .dot.scheduled { background: var(--muted); opacity:.6 }
  .cal-legend .dot.done { background: var(--success) }
  .cal-legend .dot.missed { background: var(--danger) }

  /* Enhanced Calendar Visual Improvements */
  
  /* Improved calendar grid with better spacing and visual hierarchy */
  #view-calendar .panel {
    background: linear-gradient(135deg, var(--panel-bg) 0%, rgba(11, 75, 179, 0.02) 100%);
  }
  
  /* Enhanced calendar cells with subtle gradients and better contrast */
  .cal-cell {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
  }
  
  .cal-cell:hover {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
    border-color: rgba(255, 255, 255, 0.25);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
  }
  
  .cal-cell.is-today {
    background: linear-gradient(145deg, rgba(118, 167, 255, 0.15), rgba(118, 167, 255, 0.08));
    border-color: var(--accent);
    box-shadow: 0 0 20px rgba(118, 167, 255, 0.3);
  }
  
  /* Enhanced day numbers with better visibility */
  .cal-day-num {
    background: rgba(255, 255, 255, 0.1);
    color: var(--white);
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .cal-cell.is-today .cal-day-num {
    background: var(--accent);
    color: #ffffff;
    box-shadow: 0 2px 8px rgba(118, 167, 255, 0.4);
  }
  
  .cal-cell.other-month .cal-day-num {
    background: transparent;
    color: rgba(255, 255, 255, 0.4);
  }
  
  /* Much improved task visibility and styling */
  .cal-task {
    background: rgba(255, 255, 255, 0.12);
    border-radius: 6px;
    padding: 4px 6px;
    margin: 1px 0;
    border-left: 3px solid var(--accent);
    color: var(--white);
    font-weight: 500;
    font-size: 11px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    transition: all 0.15s ease;
    backdrop-filter: blur(10px);
  }
  
  .cal-task:hover {
    background: rgba(255, 255, 255, 0.18);
    transform: translateX(2px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  }
  
  /* Enhanced task status indicators with better colors and visibility */
  .cal-task-status {
    background: rgba(255, 255, 255, 0.2);
    color: #ffffff;
    font-weight: 700;
    font-size: 9px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  }
  
  .cal-task-status.scheduled {
    background: linear-gradient(135deg, #64748b, #475569);
    border-color: #64748b;
    color: #ffffff;
  }
  
  .cal-task-status.done {
    background: linear-gradient(135deg, #10b981, #059669);
    border-color: #10b981;
    color: #ffffff;
    box-shadow: 0 0 6px rgba(16, 185, 129, 0.4);
  }
  
  .cal-task-status.missed {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: #ffffff;
    box-shadow: 0 0 6px rgba(239, 68, 68, 0.4);
    animation: pulse-red 2s infinite;
  }
  
  @keyframes pulse-red {
    0%, 100% { box-shadow: 0 0 6px rgba(239, 68, 68, 0.4); }
    50% { box-shadow: 0 0 12px rgba(239, 68, 68, 0.8); }
  }
  
  /* Enhanced legend with better styling */
  .cal-legend {
    background: rgba(255, 255, 255, 0.05);
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 16px;
  }
  
  .cal-legend .item {
    font-weight: 500;
    color: var(--white);
  }
  
  .cal-legend .dot {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .cal-legend .dot.scheduled {
    background: linear-gradient(135deg, #64748b, #475569);
    opacity: 1;
  }
  
  .cal-legend .dot.done {
    background: linear-gradient(135deg, #10b981, #059669);
    box-shadow: 0 0 6px rgba(16, 185, 129, 0.3);
  }
  
  .cal-legend .dot.missed {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 0 6px rgba(239, 68, 68, 0.3);
  }
  
  /* Calendar header improvements */
  #cal-header {
    background: rgba(255, 255, 255, 0.05);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 20px;
  }
  
  #cal-month-year {
    color: var(--white);
    font-weight: 700;
    font-size: 20px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }
  
  /* Enhanced navigation buttons */
  #cal-prev, #cal-next {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--white);
    font-weight: 600;
    transition: all 0.2s ease;
  }
  
  #cal-prev:hover, #cal-next:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--accent);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  /* Weekday headers enhancement */
  #cal-weekdays {
    background: rgba(255, 255, 255, 0.08);
    padding: 12px 0;
    margin-bottom: 8px;
    border-radius: 10px;
    font-weight: 600;
    color: var(--white);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }
  
  /* Day modal enhancements */
  .day-modal-card {
    background: linear-gradient(145deg, var(--panel-bg), rgba(11, 75, 179, 0.95));
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(20px);
  }
  
  /* Day modal */
  #day-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 30; background: rgba(7,28,68,0.85); }
  #day-modal.show { display: flex; }
  .day-modal-card { width: min(900px, 86vw); background: var(--panel-bg); border:1px solid var(--border-color); border-radius:18px; padding:22px; box-shadow: var(--shadow); color: var(--white); }
  .day-modal-close { all:unset; float:right; cursor:pointer; background:#ffffff12; border-radius:999px; width:34px; height:34px; display:grid; place-items:center; }
  /* Branding modal */
  #branding-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 31; background: rgba(7,28,68,0.85); }
  #branding-modal.show { display: flex; }
  .branding-card { width: min(700px, 92vw); background: var(--panel-bg); border:1px solid var(--border-color); border-radius:18px; padding:22px; box-shadow: var(--shadow); color: var(--white); }
  .branding-close { all:unset; float:right; cursor:pointer; background:#ffffff12; border-radius:999px; width:34px; height:34px; display:grid; place-items:center; }
  .branding-row { display:grid; grid-template-columns: 160px 1fr; gap:14px; align-items:center; margin:12px 0; }
  .branding-preview { width:160px; height:90px; border-radius:10px; background:#ffffff12; border:1px solid #ffffff22; display:grid; place-items:center; overflow:hidden; }
  .branding-preview img { max-width:100%; max-height:100%; object-fit:contain; }
  .branding-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
  .hint-mini { font-size: 12px; color: var(--muted); }
  
  #cal-view-switcher .btn.secondary.active {
    background: var(--accent-2);
    border-color: var(--accent);
    color: var(--white);
  }
  /* Pre-inspection View Styles */
  .progress-bar-bg { background: var(--glass-2); border-radius: 99px; height: 10px; overflow: hidden; }
  .progress-bar-fg { background: var(--success); height: 100%; width: 0%; border-radius: 99px; transition: width .4s ease; }
  
  /* Enhanced progress header with count display */
  .pir-progress-header {
  display: block;
    gap: 24px;
    align-items: center;
    margin-bottom: 24px;
    padding: 20px;
    background: var(--glass);
    border-radius: 16px;
    border: 1px solid var(--border-color);
  }
  
  .pir-progress-text {
    font-size: 28px;
    font-weight: 700;
    color: var(--white);
    text-align: center;
  }
  
  .pir-progress-label {
    font-size: 14px;
    color: var(--muted);
    margin-top: 4px;
    text-align: center;
  }

  /* Dedicated PIR progress panel that stretches full width */
  .pir-progress-panel { padding: 20px; border-radius: 16px; background: var(--panel-bg); border:1px solid var(--border-color); box-shadow: var(--shadow); margin-bottom: 24px; }
  .pir-progress-main { display:flex; flex-direction:column; gap:16px; }
  
  /* Enhanced full-width progress bar with clear outline and interactive effects */
  .progress-bar-container { 
    position: relative; 
    padding: 6px; 
    background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(0,0,0,0.05)); 
    border-radius: 999px; 
    border: 2px solid rgba(255,255,255,0.15);
    box-shadow: 
      0 4px 12px rgba(0,0,0,0.1),
      inset 0 1px 0 rgba(255,255,255,0.2),
      inset 0 -1px 0 rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .progress-bar-container:hover {
    transform: translateY(-1px);
    box-shadow: 
      0 6px 20px rgba(0,0,0,0.15),
      inset 0 1px 0 rgba(255,255,255,0.3),
      inset 0 -1px 0 rgba(0,0,0,0.15);
    border-color: rgba(255,255,255,0.25);
  }
  
  .progress-bar-bg { 
    background: var(--glass-2);
    border-radius: 999px; 
    height: 24px; 
    overflow: hidden; 
    position: relative;
  }
  
  /* Solid color progress foreground; color is controlled by JS based on % */
  .progress-bar-fg { 
    background: var(--success);
    height: 100%; 
    width: 0%; 
    border-radius: 999px; 
    transition: width 0.4s ease; 
  }
  
  /* Progress milestones */
  .progress-milestones {
    position: absolute;
    top: -8px;
    left: 6px;
    right: 6px;
    height: 40px;
    pointer-events: none;
  }
  
  .milestone {
    position: absolute;
    width: 2px;
    height: 16px;
    background: rgba(255,255,255,0.4);
    border-radius: 1px;
    top: 50%;
    transform: translateY(-50%);
  }
  
  .milestone.quarter { left: 25%; }
  .milestone.half { left: 50%; background: rgba(255,255,255,0.6); height: 20px; }
  .milestone.three-quarter { left: 75%; }
  
  /* Progress state animations and effects */
  .progress-bar-container.progress-low {
    animation: progressPulse 2s ease-in-out infinite;
  }
  
  .progress-bar-container.progress-medium {
    border-color: rgba(255,193,7,0.4);
  }
  
  .progress-bar-container.progress-high {
    border-color: rgba(40,167,69,0.4);
  }
  
  .progress-bar-container.progress-complete {
    border-color: rgba(16,185,129,0.6);
    animation: progressCelebrate 3s ease-in-out infinite;
  }
  
  @keyframes progressPulse {
    0%, 100% { 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    50% { 
      box-shadow: 0 6px 20px rgba(220,53,69,0.3), inset 0 1px 0 rgba(255,255,255,0.3);
      border-color: rgba(220,53,69,0.4);
    }
  }
  
  @keyframes progressCelebrate {
    0%, 100% { 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    50% { 
      box-shadow: 0 8px 25px rgba(16,185,129,0.4), inset 0 1px 0 rgba(255,255,255,0.4);
      transform: translateY(-2px);
    }
  }
  
  @keyframes progressClick {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
  }
  
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }

  /* Standardized page headers with help icons */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
  }
  
  .page-title-wrapper {
  display: flex;
  align-items: center; /* align title and badge vertically */
    gap: 8px;
    position: relative;
  }
  
  .page-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--white);
    margin: 0;
    line-height: 1.2;
  }
  
  .help-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    transition: all 0.2s ease;
    margin-top: 2px;
    flex-shrink: 0;
  }
  
  .help-icon:hover {
    background: rgba(255,255,255,0.15);
    border-color: rgba(255,255,255,0.4);
    color: var(--white);
    transform: scale(1.1);
  }

  /* Page help badge: inline eye/info button placed just to the right of the page title */
  .page-header { position: relative; }
  
  .page-help-badge {
    display: inline-grid;
    place-items: center;
    margin-left: 8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    font-weight: 800;
    font-size: 12px;
    cursor: pointer;
    transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    position: relative;
    /* tiny pulse ring for interest */
  }
  
  /* Light theme (for light headers): darker text on light glass */
  .page-help-badge.light {
    background: linear-gradient(135deg, #ffffff, #f3f6fb);
    color: #0f1b3d;
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 6px 18px rgba(16,24,40,0.08);
  }
  
  /* Dark theme (for dark headers): light text on dark glass */
  .page-help-badge.dark {
    background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08));
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.95);
    box-shadow: 0 2px 8px rgba(2,6,23,0.15);
  }
  
  .page-help-badge::after {
    content: '';
    position: absolute;
    inset: -4px;
    border-radius: 999px;
    box-shadow: 0 0 0 0 rgba(118,167,255,0.35);
    opacity: 0.0;
    transition: box-shadow .2s ease, opacity .2s ease;
  }
  
  .page-help-badge:hover { 
    transform: translateY(-1px) scale(1.05); 
  }
  .page-help-badge:hover::after {
    opacity: 1;
    box-shadow: 0 0 0 6px rgba(118,167,255,0.18);
  }
  
  /* Help modal styles */
  .help-modal {
    position: fixed;
    inset: 0;
    background: rgba(7,28,68,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
  }
  
  .help-modal.show {
    display: flex;
  }
  
  .help-modal-content {
  background: var(--panel-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 24px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  /* Use readable text color on the panel background */
  color: var(--ink);
  }
  
  .help-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .help-modal-title {
    font-size: 20px;
    font-weight: 700;
  color: var(--ink);
    margin: 0;
  }
  
  .help-modal-close {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: rgba(255,255,255,0.7);
    transition: all 0.2s ease;
  }
  
  .help-modal-close:hover {
    background: rgba(255,255,255,0.2);
    color: var(--white);
  }
  
  .help-modal-body {
    color: var(--ink);
    line-height: 1.6;
  }

  .pir-progress-stats { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .pir-progress-stats .large { font-size:18px; font-weight:800; color:var(--ink); }
  .pir-progress-stats .muted-small { font-size:12px; color:var(--muted); }
  /* Collapse behavior for overall PIR progress section */
  .pir-progress-main.collapsed { display: none !important; }

  /* Mini progress inside each email cell */
  .email-mini-bar-bg { width:80%; height:8px; background: rgba(0,0,0,0.06); border-radius:999px; overflow:hidden; }
  .email-mini-bar-fg { height:100%; width:0%; background: linear-gradient(90deg,#dc3545,#ffc107,#10b981); transition: width .5s ease; }

  /* Email status circles (compact row design) */
  .email-status-circles {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 8px;
  padding: 18px 16px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
  }

.email-status-circles.collapsed { display: none !important; }
  
  .email-circle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }
  
  .email-circle-item:hover {
    transform: translateY(-2px);
  }
  
  .email-circle {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 16px;
    color: white;
    position: relative;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  .email-circle::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    border-radius: 50%;
    transition: left 0.6s ease;
  }
  
  .email-circle-item:hover .email-circle::before {
    left: 100%;
  }
  
  .email-circle.ready {
    background: linear-gradient(135deg, #28a745, #20c997);
    box-shadow: 0 2px 12px rgba(40,167,69,0.4);
  }
  
  .email-circle.partial {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    box-shadow: 0 2px 12px rgba(255,193,7,0.4);
  }
  
  .email-circle.missing {
    background: linear-gradient(135deg, #6c757d, #495057);
    box-shadow: 0 2px 8px rgba(108,117,125,0.3);
  }
  
  .email-circle-count {
  font-size: 12px;
    font-weight: 600;
    color: var(--text-color);
    opacity: 0.8;
    transition: opacity 0.3s ease;
  }
  
  .email-circle-item:hover .email-circle-count {
    opacity: 1;
  }
  
  .email-circle-item.ready .email-circle-count {
    color: #28a745;
  }
  
  .email-circle-item.partial .email-circle-count {
    color: #fd7e14;
  }
  
  .email-circle-item.missing .email-circle-count {
    color: #6c757d;
  }

  /* Popover for email package summaries */
  .email-popover {
    position: absolute;
    min-width: 260px;
    max-width: 360px;
    background: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 12px 30px rgba(2,6,23,0.25);
    color: var(--ink);
    z-index: 1400;
    transform-origin: top right;
    animation: popIn .18s cubic-bezier(.2,.9,.2,1);
  }

  .email-popover .pop-list {
    max-height: 220px;
    overflow: auto;
    margin-top: 8px;
    padding-right: 6px;
  }

  @keyframes popIn {
    from { transform: scale(.92) translateY(-6px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
  }

  .email-popover h4 { margin: 0 0 8px; font-size: 14px; }
  .email-popover .pop-row { display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed rgba(0,0,0,0.04); }
  .email-popover .pop-row:last-child { border-bottom: none; }
  .email-popover .pop-actions { display:flex; gap:8px; margin-top:10px; justify-content:flex-end; }
  .email-popover .pill { padding:6px 10px; border-radius:12px; font-size:12px; }
  .email-popover .pill.ready { background: linear-gradient(90deg,#34d399,#10b981); color:white; }
  .email-popover .pill.partial { background: linear-gradient(90deg,#ffd580,#ffb020); color:#3b2f00; }
  .email-popover .pill.missing { background: #f1f5f9; color:var(--muted); border:1px solid var(--border-color); }

  .email-cell {
    padding: 10px;
    border-radius: 10px;
    text-align: center;
    font-weight: 700;
    font-size: 13px;
    border: 1px solid var(--border-color);
    background: var(--panel-bg);
    color: var(--muted);
    display:flex;
    flex-direction:column;
    gap:4px;
    align-items:center;
    justify-content:center;
  }

  .email-cell.ready {
    background: linear-gradient(180deg, #34d399, #10b981);
    color: white;
    border-color: rgba(16,185,129,0.25);
  }

  .email-cell.partial {
    background: linear-gradient(180deg, #ffd580, #ffb020);
    color: #3b2f00;
    border-color: rgba(255,176,32,0.16);
  }

  .email-cell.missing {
    background: var(--glass-2);
    color: var(--muted);
    border-style: dashed;
  }

  .email-cell .email-num { font-size: 12px; opacity: .9; }
  .email-cell .email-count { font-size: 14px; }
  
  /* Filter pills */
  .pir-filters {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .pir-filter-pill {
    padding: 8px 16px;
    border-radius: 20px;
    background: var(--glass);
    border: 1px solid var(--border-color);
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
  }
  
  .pir-filter-pill:hover {
    background: var(--glass-2);
    transform: translateY(-1px);
  }
  
  .pir-filter-pill.active {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent);
  }
  
  /* Sidebar TOC for categories */
  .pir-layout {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 24px;
    height: 100%;
    overflow: hidden;
  }
  
  .pir-toc {
    background: var(--glass);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    padding: 16px;
    overflow-y: auto;
    max-height: calc(100vh - 280px);
  }
  
  .pir-toc-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 12px;
    color: var(--white);
  }
  
  .pir-toc-item {
    display: block;
    padding: 8px 12px;
    margin: 2px 0;
    border-radius: 8px;
    color: var(--muted);
    text-decoration: none;
    font-size: 12px;
    transition: all 0.2s ease;
    cursor: pointer;
    line-height: 1.3;
  }
  
  .pir-toc-item:hover {
    background: var(--glass-2);
    color: var(--white);
  }
  
  .pir-toc-item.active {
    background: var(--accent);
    color: var(--white);
  }
  
  .pir-main {
    overflow-y: auto;
    max-height: calc(100vh - 280px);
  }
  
  /* Category sections with sticky headers */
  .doc-category {
    margin-bottom: 32px;
    scroll-margin-top: 70px;
  }
  
  .doc-category-title {
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 16px;
    font-weight: 700;
    color: var(--accent-2);
    background: var(--panel-bg);
    backdrop-filter: blur(8px);
    border-bottom: 2px solid var(--accent-2);
    padding: 12px 0 8px 0;
    margin-bottom: 16px;
  }
  
  /* Enhanced table rows with hover actions */
  .pir-table-row {
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
    background: var(--glass);
    overflow: hidden;
    padding: 16px 20px;
    display: grid;
    /* Fixed columns for consistent alignment across rows */
    grid-template-columns: 40px minmax(250px, 1fr) 140px 120px 190px;
    gap: 16px;
    align-items: center;
  }
  
  .pir-table-row:hover {
    border-color: var(--accent-2);
    box-shadow: 0 4px 12px rgba(118, 167, 255, 0.15);
    transform: translateY(-1px);
  }
  
  .pir-row-title {
    font-weight: 600;
    color: var(--white);
    font-size: 14px;
  }
  
  .pir-row-type {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }
  
  /* Action column specific styling */
  .pir-table-row > div:last-child {
    width: 100%;
    padding-right: 0;
  }
  
  .pir-row-actions {
    display: flex;
    gap: 4px;
    opacity: 1; /* always visible */
    transition: opacity 0.2s ease;
    white-space: nowrap; /* prevent button wrapping */
    justify-content: flex-start; /* left align buttons */
    width: 100%; /* take up full column width */
  }
  
  .pir-action-btn {
    padding: 6px 10px;
    min-width: 55px;
    text-align: center;
    font-size: 12px;
    border-radius: 6px;
    background: var(--glass-2);
    border: 1px solid var(--border-color);
    color: var(--white);
    cursor: pointer;
    margin-right: 0;
    justify-self: flex-start;
    flex-shrink: 0;
    transition: all 0.2s ease;
  }
  
  .pir-action-btn:hover {
    background: var(--accent-2);
    border-color: var(--accent);
  }
  
  .pir-action-btn.primary {
    background: var(--accent);
    border-color: var(--accent);
  }
  
  /* Status chips with enhanced styling */
  .pir-status-chip {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .pir-status-chip.not-attached {
    background: var(--glass-2);
    color: var(--muted);
  }
  
  .pir-status-chip.uploaded {
    background: var(--stat-3-bg);
    color: var(--stat-3-color);
  }
  
  .pir-status-chip.ready {
    background: var(--stat-2-bg);
    color: var(--stat-2-color);
  }
  
  .pir-status-chip.outdated {
    background: #ff8c0033;
    color: #ff8c00;
  }
  
  .pir-status-chip.draft {
    background: #8b5cf633;
    color: #8b5cf6;
  }
  
  .pir-status-chip.expired {
    background: #dc354533;
    color: #dc3545;
    font-weight: 600;
    animation: pulse-warning 2s infinite;
  }
  
  .pir-status-chip.expiring-soon {
    background: #ffc10733;
    color: #ffc107;
    font-weight: 600;
  }

  @keyframes pulse-warning {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* Certificate tracking styles */
  .certificate-tracking {
    border-left: 4px solid var(--accent-2);
  }
  
  .certificate-tracking h4 {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }
  
  .enhanced-pir-modal .info-value.status-expired {
    color: #dc3545;
    font-weight: 600;
  }
  
  .enhanced-pir-modal .info-value.status-expiring-soon {
    color: #ffc107;
    font-weight: 600;
  }

  /* Enhanced PIR Modal Styles */
  .enhanced-pir-modal {
    backdrop-filter: blur(8px);
  }
  
  .enhanced-pir-content {
    width: min(95vw, 1200px);
    height: min(90vh, 800px);
    max-width: none;
    max-height: none;
    display: flex;
    flex-direction: column;
    background: var(--panel-bg);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  
  .enhanced-pir-header {
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(135deg, var(--panel-bg) 0%, var(--glass) 100%);
    border-radius: 16px 16px 0 0;
  }
  
  .enhanced-pir-header .header-main {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  
  .enhanced-pir-header h2 {
    margin: 0;
    font-size: 24px;
    color: var(--white);
    max-width: 70%;
  }
  
  .enhanced-pir-header .header-meta {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .category-badge, .item-type-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .category-badge {
    background: var(--accent-2)33;
    color: var(--accent-2);
  }
  
  .item-type-badge {
    background: var(--muted)33;
    color: var(--muted);
  }
  
  .enhanced-pir-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  
  .enhanced-pir-sidebar {
    width: 300px;
    padding: 24px;
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    background: var(--glass);
  }
  
  .enhanced-info-section {
    margin-bottom: 32px;
  }
  
  .enhanced-info-section h4 {
    margin: 0 0 16px 0;
    font-size: 16px;
    color: var(--accent-2);
    font-weight: 600;
  }
  
  .enhanced-info-item {
    display: flex;
    flex-direction: column;
    margin-bottom: 16px;
  }
  
  .info-label {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 4px;
    font-weight: 500;
  }
  
  .info-value {
    font-size: 14px;
    color: var(--white);
    word-wrap: break-word;
  }
  
  .enhanced-actions-section h4 {
    margin: 0 0 16px 0;
    font-size: 16px;
    color: var(--accent-2);
    font-weight: 600;
  }
  
  .enhanced-action-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .enhanced-action-buttons .btn {
    justify-content: flex-start;
    gap: 8px;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
  }
  
  .enhanced-pir-preview {
    flex: 1;
    padding: 24px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .enhanced-preview-loading, 
  .enhanced-preview-error, 
  .enhanced-preview-empty,
  .enhanced-preview-unsupported {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 16px;
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--glass);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .form-grid {
    display: grid;
    gap: 16px;
  }
  
  .form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid var(--border-color);
  }
  
  
  .error-icon, .empty-icon, .file-icon {
    font-size: 48px;
    opacity: 0.7;
  }
  
  .enhanced-preview-error h4,
  .enhanced-preview-empty h4,
  .enhanced-preview-unsupported h4 {
    margin: 0;
    color: var(--white);
    font-size: 18px;
  }
  
  .enhanced-preview-error p,
  .enhanced-preview-empty p,
  .enhanced-preview-unsupported p {
    margin: 0;
    color: var(--muted);
    font-size: 14px;
    line-height: 1.5;
  }
  
  .enhanced-pdf-preview,
  .enhanced-image-preview {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .enhanced-pir-footer {
    padding: 20px 24px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    background: var(--glass);
    border-radius: 0 0 16px 16px;
  }
  
  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .enhanced-pir-content {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
    }
    
    .enhanced-pir-body {
      flex-direction: column;
    }
    
    .enhanced-pir-sidebar {
      width: auto;
      border-right: none;
      border-bottom: 1px solid var(--border-color);
      max-height: 200px;
    }
  }
  
  /* Bulk operations bar */
  .pir-bulk-bar {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 12px 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(12px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 20;
  }
  
  .pir-bulk-bar.visible {
    opacity: 1;
    visibility: visible;
  }
  
  .pir-bulk-count {
    font-weight: 600;
    color: var(--white);
  }
  
  /* Mobile responsive card layout */
  @media (max-width: 768px) {
    .pir-layout {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .pir-toc {
      display: none;
    }
    
    .pir-table-row {
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 16px;
    }
    
    .pir-row-actions {
      opacity: 1;
      margin-top: 8px;
      flex-wrap: wrap;
      justify-content: flex-start;
      width: 100%;
    }
  }
  
  /* Draft text support */
  .pir-draft-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--accent-2);
    margin-top: 4px;
  }
  
  .pir-draft-badge {
    background: var(--accent);
    color: var(--white);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
  }
  
  /* Notes indicator */
  .pir-notes-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--success);
    margin-top: 4px;
  }
  
  .pir-notes-badge {
    font-size: 12px;
  }
  
  .pir-action-btn.has-notes {
    background: var(--success-bg);
    border-color: var(--success);
    color: var(--success);
    font-weight: 600;
  }
  
  /* PIR Notes Modal */
  .pir-notes-modal .modal-content {
    max-width: 600px;
    width: 90%;
  }
  
  .pir-notes-modal textarea {
    min-height: 200px;
    resize: vertical;
    font-family: inherit;
  }
  
  .pir-notes-modal .btn.success {
    background-color: var(--success);
    border-color: var(--success);
    color: var(--white);
  }
  
  .pir-notes-modal .btn.error {
    background-color: var(--error);
    border-color: var(--error);
    color: var(--white);
  }
  
  /* Column sorting */
  .pir-sort-header {
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 0;
    font-weight: 600;
  }
  
  .pir-sort-header:hover {
    color: var(--accent-2);
  }
  
  .pir-sort-arrow {
    font-size: 10px;
    opacity: 0.6;
    transition: all 0.2s ease;
  }
  
  .pir-sort-header.active .pir-sort-arrow {
    opacity: 1;
    color: var(--accent);
  }
  
  /* Enhanced PIR Modal Styles */
  .enhanced-pir-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
    animation: modalFadeIn 0.3s ease-out;
  }
  
  .enhanced-pir-modal.show {
    display: flex;
  }
  
  .enhanced-pir-content {
    background: var(--panel-bg);
    border-radius: 16px;
    width: 95vw;
    height: 90vh;
    max-width: 1400px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--border-color);
    animation: modalSlideIn 0.3s ease-out;
  }
  
  .enhanced-pir-header {
    padding: 24px 32px;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(135deg, var(--glass) 0%, var(--panel-bg) 100%);
  }
  
  .enhanced-pir-header .header-main {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 12px;
  }
  
  .enhanced-pir-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--white);
    flex: 1;
  }
  
  .enhanced-pir-header .header-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .category-badge {
    background: var(--accent);
    color: var(--panel-bg);
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .item-type-badge {
    background: var(--glass);
    color: var(--white);
    border: 1px solid var(--border-color);
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .enhanced-pir-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  
  .enhanced-pir-sidebar {
    width: 300px;
    background: var(--glass);
    border-right: 1px solid var(--border-color);
    padding: 24px;
    overflow-y: auto;
    flex-shrink: 0;
  }
  
  .enhanced-info-section,
  .enhanced-actions-section,
  .enhanced-notes-section {
    margin-bottom: 32px;
  }
  
  .enhanced-info-section h4,
  .enhanced-actions-section h4,
  .enhanced-notes-section h4 {
    margin: 0 0 16px 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--white);
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .enhanced-notes-display {
    background: var(--glass);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
  }
  
  .enhanced-notes-display .notes-content {
    color: var(--white);
    font-size: 0.875rem;
    line-height: 1.5;
    margin-bottom: 16px;
    white-space: pre-wrap;
  }
  
  .enhanced-notes-empty {
    padding: 16px;
    text-align: center;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    background: var(--glass);
  }
  
  .enhanced-notes-empty p {
    margin: 0 0 12px 0;
    font-style: italic;
  }
  
  .btn.small {
    padding: 6px 12px;
    font-size: 0.75rem;
  }
  
  .enhanced-info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 16px;
  }
  
  .info-label {
    font-size: 0.75rem;
    color: var(--muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .info-value {
    font-size: 0.875rem;
    color: var(--white);
    word-break: break-word;
  }
  
  .info-value.status-ready { color: var(--success); }
  .info-value.status-warning { color: var(--warning); }
  .info-value.status-danger { color: var(--danger); }
  
  .enhanced-action-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .enhanced-action-buttons .btn {
    justify-content: flex-start;
    gap: 8px;
  }
  
  .enhanced-pir-preview {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    background: var(--panel-bg);
  }
  
  .enhanced-pdf-preview {
    height: 100%;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
  }
  
  .enhanced-image-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    background: var(--glass);
    border-radius: 8px;
    padding: 20px;
  }
  
  .enhanced-preview-loading,
  .enhanced-preview-error,
  .enhanced-preview-empty,
  .enhanced-preview-unsupported {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 40px;
    color: var(--muted);
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
  }
  
  .error-icon,
  .empty-icon,
  .file-icon {
    font-size: 3rem;
    margin-bottom: 16px;
  }
  
  .enhanced-preview-error h4,
  .enhanced-preview-empty h4,
  .enhanced-preview-unsupported h4 {
    color: var(--white);
    margin: 0 0 12px 0;
    font-size: 1.25rem;
    font-weight: 600;
  }
  
  .enhanced-preview-error p,
  .enhanced-preview-empty p,
  .enhanced-preview-unsupported p {
    margin: 0 0 8px 0;
    line-height: 1.5;
  }
  
  .enhanced-pir-footer {
    padding: 20px 32px;
    border-top: 1px solid var(--border-color);
    background: var(--glass);
    display: flex;
    justify-content: flex-end;
  }
  
  @keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes modalSlideIn {
    from { 
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to { 
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Responsive design for smaller screens */
  @media (max-width: 1024px) {
    .enhanced-pir-content {
      width: 98vw;
      height: 95vh;
    }
    
    .enhanced-pir-body {
      flex-direction: column;
    }
    
    .enhanced-pir-sidebar {
      width: 100%;
      max-height: 200px;
      border-right: none;
      border-bottom: 1px solid var(--border-color);
    }
    
    .enhanced-info-section,
    .enhanced-actions-section {
      margin-bottom: 16px;
    }
    
    .enhanced-info-item {
      margin-bottom: 8px;
    }
  }

  /* Holiday Management Styles */
  #holidays .panel {
    overflow: visible;
  }
  
  #holidays .table-wrap {
    overflow-x: auto;
    padding: 0;
    border-radius: 12px;
  }
  
  #holidays table {
    min-width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }
  
  #holidays th, #holidays td {
    white-space: nowrap;
    padding: 12px 16px;
  }
  
  #holidays th {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--panel-bg);
  }
  
  #entitlements-list table, #requests-list table {
    width: 100%;
  }
  
  /* Responsive styling for small screens */
  @media (max-width: 768px) {
    #holidays .table-wrap {
      max-width: 100%;
      overflow-x: auto;
    }
    
    #holidays table {
      min-width: 800px;
    }
  }
  
  /* PDF preview modal enhancements */
  .pir-preview-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
    backdrop-filter: blur(4px);
  }
  
  .pir-preview-modal.show {
    display: flex;
  }
  
  .pir-preview-content {
    background: var(--panel-bg);
    border-radius: 16px;
    width: 90vw;
    height: 90vh;
    max-width: 1200px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .pir-preview-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .pir-preview-body {
    flex: 1;
    overflow: auto;
    padding: 0;
  }
  
  .pir-preview-close {
    background: var(--glass);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--white);
    cursor: pointer;
  }
  
  #pir-tbody tr { cursor: pointer; }

  /* Pre‑Inspection panel should fill viewport and allow inner scrolling */
  #view-pre-inspection .panel {
    min-height: calc(100vh - 190px);
    display: flex;
    flex-direction: column;
  }
  /* Make the documents container the scrollable area */
  #view-pre-inspection #pir-docs-container {
    flex: 1 1 auto;
    overflow-y: auto;
    max-height: none;            /* override .table-wrap default 420px cap */
    -webkit-overflow-scrolling: touch; /* iOS/Safari momentum scroll */
    overscroll-behavior: contain;      /* prevent scroll chaining */
  }

  /* Dynamic & Multi-Input Form Styles */
  .multi-input-container { display: flex; gap: 12px; align-items: flex-start; }
  .multi-input-container .field { flex: 1; margin-top: 0; }
  .dynamic-table-row { display: flex; gap: 8px; align-items: center; }
  .dynamic-table-row input { flex: 1; }

  
  /* Bulk Upload Additional Styles */
  .tab-panel {
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .upload-area {
    background: var(--glass);
    position: relative;
    overflow: hidden;
  }
  
  .upload-area:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 20px rgba(118, 167, 255, 0.2);
  }
  
  .upload-area.dragging {
    background: var(--glass-2);
    border-color: var(--accent) !important;
  }
  
  .upload-section {
    animation: slideIn 0.4s ease;
  }
  
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  
  
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .tab-button {
    background: transparent;
    border: none;
    padding: 12px 16px;
    color: var(--muted);
    cursor: pointer;
    border-radius: 8px 8px 0 0;
    transition: all 0.2s ease;
    font-size: 14px;
    font-weight: 500;
    position: relative;
  }

  .tab-button:hover {
    background: var(--glass);
    color: var(--white);
  }

  .tab-button.active {
    background: var(--accent);
    color: var(--white);
    box-shadow: 0 2px 8px rgba(118, 167, 255, 0.3);
  }

  .tab-content {
    min-height: 400px;
  }

  .table-view {
    display: none;
  }

  .table-view.active {
    display: block;
  }

  .table-container {
    background: var(--glass);
    border-radius: var(--round);
    padding: 20px;
    overflow-x: auto;
  }


  .loading-indicator {
    text-align: center;
    color: var(--muted);
    padding: 40px;
    font-style: italic;
  }

  .error-message {
    color: var(--danger);
    background: rgba(255, 107, 107, 0.1);
    border: 1px solid var(--danger);
    border-radius: 8px;
    padding: 16px;
    margin: 20px 0;
    text-align: center;
  }

  .empty-state {
    text-align: center;
    color: var(--muted);
    padding: 40px;
    font-style: italic;
  }

  .null-value {
    color: var(--muted);
    font-style: italic;
  }

  .boolean-value {
    color: var(--accent);
    font-weight: 600;
  }

  .object-value {
    color: var(--warning);
    font-family: monospace;
    font-size: 12px;
  }

  /* Enhanced User Management Styles */
  .user-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
  }
  .status-not-invited {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #451a03;
  }
  .status-invited {
    background: linear-gradient(135deg, #60a5fa, #3b82f6);
    color: #ffffff;
  }
  .status-active {
    background: linear-gradient(135deg, #34d399, #10b981);
    color: #ffffff;
  }
  .status-error {
    background: linear-gradient(135deg, #f87171, #ef4444);
    color: #ffffff;
  }

  .action-buttons {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  .action-btn {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .action-btn.invite {
    background: linear-gradient(135deg, #60a5fa, #3b82f6);
    color: white;
  }
  .action-btn.test {
    background: linear-gradient(135deg, #a78bfa, #8b5cf6);
    color: white;
  }
  .action-btn.remove {
    background: linear-gradient(135deg, #f87171, #ef4444);
    color: white;
  }
  .action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .working-day-input {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 10px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    transition: all 0.2s ease;
  }
  .working-day-input:hover {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  .working-day-input label {
    font-size: 12px;
    font-weight: 600;
    color: #64748b;
  }
  .working-day-input input,
  .working-day-input select {
    padding: 6px;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    font-size: 14px;
  }

  /* User Configuration Styles */
  .user-filter-pill {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    border-radius: 16px;
    background: var(--glass);
    color: var(--muted);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .user-filter-pill:hover {
    background: var(--glass-2);
    color: var(--white);
  }
  .user-filter-pill.active {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent-2);
  }

  .user-card {
    padding: 12px;
    margin-bottom: 8px;
    background: var(--glass);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .user-card:hover {
    background: var(--glass-2);
    border-color: var(--accent);
    transform: translateY(-1px);
  }
  .user-card.selected {
    background: var(--accent);
    border-color: var(--accent-2);
    color: var(--white);
  }
  .user-card.selected .user-card-name {
    color: var(--white);
  }
  .user-card.selected .user-card-email,
  .user-card.selected .user-card-role {
    color: rgba(255,255,255,0.8);
  }

  .user-card-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 2px;
    color: var(--white);
  }
  .user-card-email {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 4px;
  }
  .user-card-role {
    font-size: 11px;
    color: var(--muted);
  }

  .config-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 20px;
    background: var(--glass);
    padding: 4px;
    border-radius: 8px;
  }
  .config-tab {
    flex: 1;
    padding: 8px 12px;
    border: none;
    background: transparent;
    color: var(--muted);
    font-size: 13px;
    font-weight: 500;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .config-tab:hover {
    background: var(--glass-2);
    color: var(--white);
  }
  .config-tab.active {
    background: var(--accent);
    color: var(--white);
  }

  .config-tab-content {
    display: none;
  }
  .config-tab-content.active {
    display: block;
  }

  .config-section {
    margin-bottom: 28px;
    padding: 20px;
    background: var(--glass);
    border: 1px solid var(--border-color);
    border-radius: 12px;
  }
  .config-section h4 {
    margin: 0 0 16px 0;
    color: var(--white);
    font-size: 16px;
    font-weight: 600;
  }

  .config-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .config-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .config-field label {
    font-size: 13px;
    font-weight: 500;
    color: var(--white);
  }
  .config-field input,
  .config-field select,
  .config-field textarea {
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--glass);
    color: var(--white);
    font-size: 14px;
  }
  .config-field input:focus,
  .config-field select:focus,
  .config-field textarea:focus {
    outline: none;
    border-color: var(--accent);
    background: var(--glass-2);
  }
  .config-field .field-help {
    font-size: 11px;
    color: var(--muted);
    margin-top: 2px;
  }

  .status-pill {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
  }

  .schedule-day {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
  }
  .schedule-day:last-child {
    border-bottom: none;
  }
  .schedule-day label {
    font-weight: 500;
    min-width: 80px;
  }
  .schedule-inputs {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .schedule-inputs input {
    width: 60px;
    padding: 4px 6px;
    text-align: center;
  }
  .hours-label, .sessions-label {
    font-size: 12px;
    color: var(--muted);
    min-width: 50px;
  }

  .config-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
  }
  .stat-card {
    padding: 12px;
    background: var(--glass);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    text-align: center;
  }
  .stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--white);
    margin-bottom: 4px;
  }
  .stat-label {
    font-size: 11px;
    color: var(--muted);
    font-weight: 500;
  }

  .btn.danger {
    background: linear-gradient(135deg, #ff6b6b, #ff5252);
    border-color: #ff5252;
  }
  .btn.danger:hover {
    background: linear-gradient(135deg, #ff5252, #f44336);
    transform: translateY(-1px);
  }

  .user-avatar {
    position: relative;
  }
  .user-avatar::after {
    content: '';
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 16px;
    height: 16px;
    background: var(--success);
    border: 2px solid var(--panel-bg);
    border-radius: 50%;
  }
  .user-avatar.inactive::after {
    background: var(--muted);
  }
</style>


<style>
  /* Toggle Switch Styles */
  .toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    background: var(--glass-2);
    border-radius: 24px;
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .toggle-switch:hover {
    background: var(--glass);
  }

  .toggle-slider {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 18px;
    height: 18px;
    background: var(--white);
    border-radius: 50%;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .toggle-switch input:checked + .toggle-slider {
    transform: translateX(20px);
    background: var(--accent);
  }

  .toggle-switch input:checked ~ .toggle-switch {
    background: var(--accent-2);
  }
</style>

<style id="stellar-light-theme">
  :root{ --bg-page:#f3f5f9; --panel-bg:#ffffff; --border-color:#e9edf5; --ink:#1f2937; --white:#111827; --muted:#667085; --accent:#a467ff; --accent-2:#658ae3; --mint:#01cabd; --success:#41d656; --warning:#fc6a24; --danger:#ef5463; --round:16px; --shadow-sm:0 1px 2px rgba(16,24,40,.06); --shadow-md:0 2px 6px rgba(16,24,40,.06), 0 12px 24px rgba(16,24,40,.04); }
  body{ background:var(--bg-page) !important; color:var(--ink); font-family:'Urbanist', Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  .bg{ position:fixed; inset:0; z-index:-1; background:var(--bg-page) !important; }
  .wave,.wave2{ display:none !important; }
  .sidebar{ background:var(--panel-bg) !important; border:1px solid var(--border-color) !important; border-radius:18px !important; box-shadow:0 2px 6px rgba(16,24,40,.06),0 12px 24px rgba(16,24,40,.04) !important; }
  .brand .t{ color:var(--white) !important; } .brand .hint{ color:var(--muted) !important; }
  .brand .logo{ box-shadow:none !important; border-radius:12px !important; border:1px solid var(--border-color) !important; background:#fff !important; }
  .nav button{ color:#475467 !important; background:transparent !important; border:1px solid transparent !important; border-radius:12px !important; padding:10px 12px !important; }
  .nav button:hover{ background:#f6f7fb !important; border-color:#f0f2f7 !important; transform:none !important; }
  .nav .icon{ width:18px; height:18px; color:#667085 !important; filter:none !important; opacity:1 !important; }
  .nav .nav-badge{ background:#eef2ff !important; color:#667085 !important; }
  .nav button.active{ background:#f5f1ff !important; border-color:#e8e1ff !important; color:#3a2b6d !important; box-shadow: inset 0 0 0 1px #e8e1ff !important; font-weight:600 !important; }
  .nav button.active .icon{ color:var(--accent) !important; }
  .btn{ background:#fff !important; border:1px solid #e7eaf3 !important; color:#344054 !important; box-shadow:0 1px 2px rgba(16,24,40,.06) !important; }
  .btn:hover{ background:#f8faff !important; }
  .btn.secondary{ background:#fff !important; border:1px solid var(--border-color) !important; color:#475467 !important; }
  .tab-controls .btn.secondary.active{ background:#f5f1ff !important; border-color:#e8e1ff !important; color:#3a2b6d !important; }
  .panel{ background:#fff !important; border:1px solid var(--border-color) !important; border-radius:16px !important; box-shadow:0 2px 6px rgba(16,24,40,.06),0 12px 24px rgba(16,24,40,.04) !important; }
  .panel-header svg{ color:#98a2b3 !important; }
  .panel-title{ color:var(--white) !important; }
  thead th{ background:#fafbff !important; color:#667085 !important; border-bottom:1px solid var(--border-color) !important; }
  tbody tr:nth-child(even){ background:#fcfcfd !important; }
  td{ border-bottom:1px solid var(--border-color) !important; }
  tbody tr:hover{ background:#f3f6ff !important; }
  tbody tr.selected{ background:#ebe9ff !important; }
  .chip{ background:#f4f6fb !important; color:#475467 !important; }
  .chip.success{ background:#eafaf1 !important; color:#037a48 !important; }
  .chip.danger{ background:#ffe9ec !important; color:#b42318 !important; }
  .chip.warning{ background:#fff3e6 !important; color:#9a5606 !important; }
  .cal-day{ background:#fff !important; border:1px solid var(--border-color) !important; box-shadow:0 1px 2px rgba(16,24,40,.06) !important; }
  .cal-day-label{ color:#111827 !important; } .cal-day-summary{ color:#667085 !important; }
  .cal-day-bar-bg{ background:#eef2f6 !important; }
  .cal-day-bar-fg{ background: linear-gradient(90deg, var(--mint), var(--success)) !important; }
  .cal-day-bar-fg.danger{ background: linear-gradient(90deg, #ffd3bf, var(--warning)) !important; }
  .cal-metric.success{ color:var(--success) !important; } .cal-metric.danger{ color:var(--warning) !important; }
  .card, .modal-content, .branding-card, .day-modal-card{ background:#fff !important; border:1px solid var(--border-color) !important; box-shadow:0 2px 6px rgba(16,24,40,.06),0 12px 24px rgba(16,24,40,.04) !important; }
  .auth, .modal{ background: rgba(15,23,42,.35) !important; }
  .field input, .field textarea{ background:#fff !important; border:1px solid var(--border-color) !important; color:var(--ink) !important; }
  .ui-select{ background:#fff !important; border:1px solid var(--border-color) !important; color:var(--ink) !important; }
  .cal-cell{ background:#fff !important; border:1px solid var(--border-color) !important; }
  .cal-day-num{ background:#f0f2f8 !important; color:#111827 !important; }
  .cal-cell.is-today .cal-day-num{ background:var(--accent) !important; color:#fff !important; }
  .cal-task-status.scheduled{ background:#e6eaf2 !important; color:#475467 !important; }
  .cal-task-status.done{ background:#eafaf1 !important; color:#037a48 !important; }
  .cal-task-status.missed{ background:#ffe9ec !important; color:#b42318 !important; }

  .footer{ color:#98a2b3 !important; }
</style>

<style id="stellar-light-color-boost">
  /* Add pastel card tints and vivid accents (no markup changes) */

  /* Week calendar panel gets a gentle purple/blue wash */
  #view-dashboard #week-calendar{
    background: linear-gradient(180deg,#f5f1ff 0%, #eef3ff 100%) !important;
    border-color:#e8e1ff !important;
  }
  /* Week calendar panel gets a gentle purple/blue wash */
  #view-dashboard #week-calendar{
    background: linear-gradient(180deg,#f5f1ff 0%, #eef3ff 100%) !important;
    border-color:#e8e1ff !important;
  }

  /* Cycle soft colors across the seven day cards */
  #week-grid .cal-day{ box-shadow: var(--shadow-sm); }
  #week-grid .cal-day:nth-child(1){ background:#f5f1ff !important; border-color:#e8e1ff !important; }
  #week-grid .cal-day:nth-child(1) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--accent), var(--accent-2)) !important; }

  #week-grid .cal-day:nth-child(2){ background:#eefdff !important; border-color:#d9f5ff !important; }
  #week-grid .cal-day:nth-child(2) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--mint), #7de9d0) !important; }

  #week-grid .cal-day:nth-child(3){ background:#fff5ec !important; border-color:#ffe5d3 !important; }
  #week-grid .cal-day:nth-child(3) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--warning), #ffd59c) !important; }

  #week-grid .cal-day:nth-child(4){ background:#eefcf5 !important; border-color:#d6f5e8 !important; }
  #week-grid .cal-day:nth-child(4) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--success), var(--mint)) !important; }

  #week-grid .cal-day:nth-child(5){ background:#f4f8ff !important; border-color:#e1ecff !important; }
  #week-grid .cal-day:nth-child(5) .cal-day-bar-fg{ background: linear-gradient(90deg, #6aa8ff, var(--accent-2)) !important; }

  #week-grid .cal-day:nth-child(6){ background:#fff0f4 !important; border-color:#ffd7e3 !important; }
  #week-grid .cal-day:nth-child(6) .cal-day-bar-fg{ background: linear-gradient(90deg, #ef5463, #fc6a24) !important; }

  #week-grid .cal-day:nth-child(7){ background:#eef7ff !important; border-color:#dceaff !important; }
  #week-grid .cal-day:nth-child(7) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--accent-2), var(--accent)) !important; }

  /* Give the other two dashboard panels a subtle tint so the page isn't all-white */
  #view-dashboard .grid > .panel:nth-of-type(2){
    background: linear-gradient(180deg,#ffffff 0%, #f7fbff 100%) !important;
  }
  #view-dashboard .grid > .panel:nth-of-type(3){
    background: linear-gradient(180deg,#ffffff 0%, #f8f6ff 100%) !important;
  }

  /* Table header & hover colors a bit brighter for the light UI */
  #view-dashboard thead th{ background:#f6f8ff !important; border-bottom-color:#e7ecf5 !important; }
  #view-dashboard tbody tr:hover{ background:#edf2ff !important; }

  /* Active nav item with a soft purple glow so the menu feels alive */
  .nav button.active{ box-shadow: 0 8px 24px rgba(164,103,255,.18) !important; }
</style>

<style id="stellar-light-delight">
  :root{
    --radius-xl:20px;
    --border-soft:#eef1f8;
  }

  /* Subtle animated pastel blobs in the background */
  .bg::before, .bg::after { 
    content:""; position:absolute; pointer-events:none; z-index:0; 
    width:55vmax; height:55vmax; border-radius:50%; filter: blur(45px); opacity:.55;
    animation: floaty 24s ease-in-out infinite alternate;
  }
  .bg::before { left:-10vmax; top:-10vmax; background: radial-gradient(closest-side, #a467ff2b, transparent 70%); }
  .bg::after  { right:-8vmax; bottom:-12vmax; background: radial-gradient(closest-side, #01cabd26, transparent 70%); animation-duration: 28s; }
  @keyframes floaty { from { transform: translateY(-8px) } to { transform: translateY(12px) } }

  /* Gradient borders + gentle sheen on panels */
  .panel{ 
    position: relative;
    background: #fff !important; 
    border:1px solid transparent !important; 
    background: linear-gradient(#fff,#fff) padding-box, linear-gradient(180deg,#ecf1ff,#f9ecff) border-box !important;
    box-shadow: var(--shadow-md) !important;
  }
  /* Tint the two lower dashboard panels differently so the page isn't all white */
  #view-dashboard .grid > .panel:nth-of-type(2){
    background: linear-gradient(#fff,#fff) padding-box, linear-gradient(180deg,#ecf7ff,#f2ecff) border-box !important;
  }
  #view-dashboard .grid > .panel:nth-of-type(3){
    background: linear-gradient(#fff,#fff) padding-box, linear-gradient(180deg,#fdf5ee,#eefaf3) border-box !important;
  }
  .panel:hover::after{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background: linear-gradient(120deg, transparent 30%, #ffffff80 50%, transparent 70%);
    transform: translateX(-120%);
    animation: sheen 1.2s ease forwards;
  }
  @keyframes sheen { to { transform: translateX(120%);} }

  /* Icon chips in panel headers */
  .panel-header svg{
    padding:8px; border-radius:12px; 
    background: linear-gradient(180deg,#f5f1ff,#edf0ff);
    box-shadow: 0 6px 24px rgba(164,103,255,.15), inset 0 0 0 1px #eae6ff;
  }
  #week-calendar .panel-header svg{ background: linear-gradient(180deg,#f5f1ff,#eef3ff); }
  #view-dashboard .grid > .panel:nth-of-type(2) .panel-header svg{ background: linear-gradient(180deg,#eefcf5,#e8fff9); }
  #view-dashboard .grid > .panel:nth-of-type(3) .panel-header svg{ background: linear-gradient(180deg,#fff0f4,#fff7ef); }

  /* Sidebar icons as soft tiles; active gets a purple glow */
  .nav .icon{ padding:6px; border-radius:10px; background:#f1f2f7; box-shadow: inset 0 0 0 1px var(--border-color), 0 4px 10px rgba(17,24,39,.05); }
  .nav button.active .icon{ background: linear-gradient(180deg,#f5f1ff,#e9e2ff); box-shadow: inset 0 0 0 1px #e1d7ff, 0 8px 18px rgba(164,103,255,.25); }

  /* Progress bars get animated stripes for a lively feel */
  .cal-day-bar-fg{ position:relative; overflow:hidden; box-shadow: 0 0 0 1px #fff inset, 0 6px 14px rgba(16,24,40,.07); }
  .cal-day-bar-fg::after{ content:""; position:absolute; inset:0; background: repeating-linear-gradient(45deg, #ffffff40 0 8px, #ffffff00 8px 16px); transform: translateX(-100%); animation: slide-stripes 2s linear infinite; }
  @keyframes slide-stripes{ to { transform: translateX(100%);} }

  /* Table rows: brighter hover with a colored edge */
  #view-dashboard tbody tr:hover{ background:#f7f9ff !important; box-shadow: inset 3px 0 0 #a467ff; }

  /* Calendar cards lift on hover */
  #week-grid .cal-day{ transition: transform .18s ease, box-shadow .18s ease; }
  #week-grid .cal-day:hover{ transform: translateY(-2px); box-shadow: 0 10px 24px rgba(16,24,40,.08); }
</style>

<style id="layout-scrollless">
  /* Adjusted: allow page scrolling while keeping inner scroll containers functional */
  html, body { height: 100%; overflow: auto !important; }
  body { overscroll-behavior: auto; }
  .app { min-height: 100vh; height: auto; overflow: visible; }

  /* Sidebar: full-height with its own scroll */
  .sidebar{ position: sticky; top: 22px; height: calc(100vh - 44px); max-height: calc(100vh - 44px); overflow-y: auto; overscroll-behavior: contain; }
  .app.collapsed #sidebar{ height: calc(100vh - 44px); max-height: calc(100vh - 44px); overflow-y: auto; }

  /* Main content: allow natural page scroll; inner views still manage their own scrolling */
  .content{ height: auto; overflow: visible; display:flex; flex-direction:column; }
  section.view{ min-height: 0; }
  section.view.active{ flex: 1 1 auto; overflow: visible; display:flex; flex-direction:column; }

  /* Layout fix: ensure inner view/panel elements can't force the grid/sidebar to reflow
    or be visually overlapped. This prevents long/wide tables or fixed children from
    pushing the complaints reporting content "under" the menu. */
  .content, section.view, section.view .panel, .panel .table-wrap { min-width: 0; box-sizing: border-box; }
  /* Keep panels in the normal stacking context but above background layers. Avoid
    using a very high z-index so the sidebar and modals keep precedence when needed. */
  section.view .panel { position: relative; z-index: 1; }
  
  /* Specific fix for layout issues on multiple pages */
  #view-complaints-reporting,
  #view-schedules,
  #view-submissions,
  #view-checktypes,
  #view-staff,
  #view-settings {
    position: static !important;
    width: auto !important;
    max-width: none !important;
    left: auto !important;
    right: auto !important;
    top: auto !important;
    bottom: auto !important;
    margin: 0 !important;
    transform: none !important;
  }
  
  #view-complaints-reporting .panel,
  #view-schedules .panel,
  #view-submissions .panel,
  #view-checktypes .panel,
  #view-staff .panel,
  #view-settings .panel {
    position: static !important;
    width: auto !important;
    max-width: none !important;
    left: auto !important;
    right: auto !important;
    top: auto !important;
    bottom: auto !important;
    margin: 0 !important;
    transform: none !important;
  }

  /* Panels are flex columns so inner pieces can scroll */
  section.view .panel{ flex: 1 1 auto; display:flex; flex-direction:column; overflow: visible; min-height: 0; }
  .panel .table-wrap{ flex: 1 1 auto; overflow: auto; min-height: 0; }

  /* Grids inside views become the scroll container, not the page */
  section.view .grid{ flex: 1 1 auto; overflow: auto; min-height: 0; }
  .grid .panel{ flex: 0 0 auto; min-height: 240px; }

  /* Calendar view: allow the month grid to scroll inside the panel */
  #view-calendar .panel{ display:flex; flex-direction:column; }
  #cal-grid{ min-height: 0 !important; overflow: auto; }

  /* Users/Items/etc: ensure their tables stretch and scroll */

  /* Dashboard cards: weekly grid can scroll horizontally on very small screens without causing page scroll */
  #week-grid{ overflow: auto; }

  /* Footer never pushes the page to scroll */
  .footer{ flex: 0 0 auto; }
</style>

<style id="collapsed-icon-rail">
  /* ——— Collapsed Sidebar: show every icon in a single scrollable rail ——— */
  #sidebar { -webkit-overflow-scrolling: touch; }

  /* Container for the cloned buttons (built by JS) */
  #icon-rail { display:none; }
  .app.collapsed #sidebar #icon-rail {
    display: flex !important;
    flex-direction: column;
    gap: 8px;
  }
  .app.collapsed #sidebar #icon-rail button{
    all: unset;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
  }
  .app.collapsed #sidebar #icon-rail .menu-item-label,
  .app.collapsed #sidebar #icon-rail .nav-badge{ display:none !important; }

  /* Hide original grouped menus and top-level buttons when collapsed —
     the rail shows clones of *all* items so nothing is missing */
  .app.collapsed #sidebar .nav > .nav-group,
  .app.collapsed #sidebar .nav > .nav-group-toggle,
  .app.collapsed #sidebar .nav > button[data-section]{
    display: none !important;
  }

  /* Make icons a consistent size in the rail */
  .app.collapsed #sidebar #icon-rail .icon{ width:22px; height:22px; margin:0; }

  /* Ensure scrolling always works on the collapsed sidebar */
  .app.collapsed #sidebar{ overflow-y: auto !important; }

  /* ——— JAZZY COMPLAINTS DASHBOARD STYLES ——— */
  
  /* Animated gradient backgrounds */
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  @keyframes countUp {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* Enhanced stat cards with gradients and animations */
  #view-complaints-dashboard .stat-card {
    background: linear-gradient(135deg, var(--glass), rgba(255,255,255,0.1)) !important;
    border: 1px solid rgba(255,255,255,0.2);
    backdrop-filter: blur(20px);
    border-radius: 16px !important;
    padding: 20px !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.6s ease-out;
    color: white !important;
  }
  
  #view-complaints-dashboard .stat-card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    border-color: var(--accent-1);
  }

  #view-complaints-dashboard .stat-card h3,
  #view-complaints-dashboard .stat-card .stat-number,
  #view-complaints-dashboard .stat-card .stat-label {
    color: white !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    font-weight: 600;
  }

  #view-complaints-dashboard .stat-card .stat-number {
    font-weight: 800;
  }

  /* Enhanced button styling for dashboard */
  #view-complaints-dashboard .btn {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  #view-complaints-dashboard .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  }

  #view-complaints-dashboard .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
  }

  #view-complaints-dashboard .btn:hover::before {
    left: 100%;
  }
  
  #view-complaints-dashboard .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
  }
  
  #view-complaints-dashboard .stat-card:hover::before {
    left: 100%;
  }
  
  /* Animated numbers */
  #view-complaints-dashboard .stat-num {
    font-size: 2.5rem !important;
    font-weight: 800 !important;
    background: linear-gradient(45deg, var(--accent-1), var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: countUp 0.8s ease-out;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  #view-complaints-dashboard .stat-label {
    font-weight: 600 !important;
    color: var(--muted) !important;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.85rem !important;
  }
  
  /* Colorful stat card variants */
  #view-complaints-dashboard .stat-card:nth-child(1) {
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    animation-delay: 0.1s;
  }
  
  #view-complaints-dashboard .stat-card:nth-child(2) {
    background: linear-gradient(135deg, #f093fb, #f5576c) !important;
    animation-delay: 0.2s;
  }
  
  #view-complaints-dashboard .stat-card:nth-child(3) {
    background: linear-gradient(135deg, #4facfe, #00f2fe) !important;
    animation-delay: 0.3s;
  }
  
  #view-complaints-dashboard .stat-card:nth-child(4) {
    background: linear-gradient(135deg, #43e97b, #38f9d7) !important;
    animation-delay: 0.4s;
  }
  
  /* Glowing dashboard panels */
  #view-complaints-dashboard .panel > div[style*="background:var(--glass)"] {
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)) !important;
    border: 1px solid rgba(255,255,255,0.2);
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    animation: fadeInUp 0.8s ease-out;
  }
  
  #view-complaints-dashboard .panel > div[style*="background:var(--glass)"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    border-color: rgba(255,255,255,0.3);
  }
  
  /* Enhanced category and status lists */
  #cmp-top-categories > div, #cmp-status-breakdown > div {
    padding: 12px 16px !important;
    margin: 8px 0 !important;
    background: linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    border-radius: 8px;
    border-left: 4px solid var(--accent-1);
    transition: all 0.2s ease;
    animation: fadeInUp 0.5s ease-out;
  }
  
  #cmp-top-categories > div:hover, #cmp-status-breakdown > div:hover {
    background: linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
    transform: translateX(4px);
    border-left-color: var(--accent-2);
  }
  
  /* Trend chart enhancements */
  #complaints-trend {
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    transition: all 0.3s ease;
  }
  
  #complaints-trend:hover {
    filter: drop-shadow(0 6px 12px rgba(0,0,0,0.15));
  }
  
  /* Enhanced quick action buttons */
  #view-complaints-dashboard .btn {
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2)) !important;
    border: none !important;
    border-radius: 12px !important;
    padding: 12px 24px !important;
    font-weight: 600 !important;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    position: relative;
    overflow: hidden;
  }
  
  #view-complaints-dashboard .btn:hover {
    transform: translateY(-2px) scale(1.05) !important;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
  }
  
  #view-complaints-dashboard .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  
  #view-complaints-dashboard .btn:hover::before {
    left: 100%;
  }
  
  /* Dashboard title enhancement */
  #view-complaints-dashboard .h1 {
    background: linear-gradient(45deg, var(--accent-1), var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2.5rem !important;
    font-weight: 800 !important;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    animation: fadeInUp 0.5s ease-out;
  }
  
  /* Loading animation for dashboard widgets */
  #cmp-top-categories:empty::before,
  #cmp-status-breakdown:empty::before {
    content: '';
    display: block;
    width: 40px;
    height: 40px;
    margin: 20px auto;
    border: 4px solid rgba(255,255,255,0.1);
    border-top: 4px solid var(--accent-1);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Stagger animations for dashboard elements */
  #view-complaints-dashboard .stat-card:nth-child(1) { animation-delay: 0.1s; }
  #view-complaints-dashboard .stat-card:nth-child(2) { animation-delay: 0.2s; }
  #view-complaints-dashboard .stat-card:nth-child(3) { animation-delay: 0.3s; }
  #view-complaints-dashboard .stat-card:nth-child(4) { animation-delay: 0.4s; }
  
  /* Floating particles background effect */
  #view-complaints-dashboard::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 20%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
    animation: gradientShift 15s ease infinite;
    background-size: 200% 200%;
  }
  
  /* Responsive adjustments for dashboard */
  @media (max-width: 768px) {
    #view-complaints-dashboard .stat-card {
      padding: 16px !important;
    }
    
    #view-complaints-dashboard .stat-num {
      font-size: 2rem !important;
    }
    
    #view-complaints-dashboard .h1 {
      font-size: 2rem !important;
    }
    
    /* Stack dashboard panels on mobile */
    #view-complaints-dashboard div[style*="display:grid; grid-template-columns: 2fr 1fr"] {
      grid-template-columns: 1fr !important;
      gap: 16px !important;
    }
    
    #view-complaints-dashboard div[style*="display:flex; gap:16px"] {
      flex-direction: column !important;
    }
  }
  
  /* Enhanced focus states for accessibility */
  #view-complaints-dashboard .btn:focus {
    outline: 2px solid var(--accent-1);
    outline-offset: 2px;
  }
  
  /* Interactive elements pulse on focus */
  #view-complaints-dashboard .stat-card:focus-within {
    animation: pulse 2s infinite;
  }
  
  /* Smooth transitions for theme changes */
  * {
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
  }
</style>

<style id="project-management-styles">
  /* Project Management Styles */
  .task-type {
    background: var(--accent-bg, rgba(164, 103, 255, 0.1));
    color: var(--accent, #a467ff);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: capitalize;
  }
  
  .type-feature { background: rgba(40, 167, 69, 0.1); color: #28a745; }
  .type-page { background: rgba(23, 162, 184, 0.1); color: #17a2b8; }
  .type-bug { background: rgba(220, 53, 69, 0.1); color: #dc3545; }
  .type-issue { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
  .type-enhancement { background: rgba(108, 117, 125, 0.1); color: #6c757d; }
  .type-maintenance { background: rgba(255, 138, 61, 0.1); color: #ff8a3d; }
  
  .status-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 50%;
  background: var(--border-color);
  font-size: 12px;
  }
  
  .status-todo { background: rgba(108, 117, 125, 0.1); }
  .status-in-progress { background: rgba(255, 193, 7, 0.1); }
  .status-testing { background: rgba(23, 162, 184, 0.1); }
  .status-completed { background: rgba(40, 167, 69, 0.1); }

  /* clearer open/closed visuals */
  .status-open { background: linear-gradient(180deg, rgba(220,53,69,0.08), rgba(220,53,69,0.03)); color: #dc3545; border: 1px solid rgba(220,53,69,0.12); }
  .status-closed { background: linear-gradient(180deg, rgba(40,167,69,0.12), rgba(40,167,69,0.04)); color: #198754; border: 1px solid rgba(40,167,69,0.14); }
  
  .task-title {
    font-weight: 500;
    color: var(--white);
  }
  
  .task-description {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
    line-height: 1.3;
  }
  
  .tab-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
  }
  
  .tab-controls .btn.active {
    background: var(--accent);
    color: white;
  }
  
  .task-issue-row {
    position: relative;
  }
  
  .highlight-issues .task-issue-row {
    background-color: rgba(220, 53, 69, 0.05) !important;
    border-left: 3px solid var(--danger-color, #dc3545) !important;
  }
  
  .highlight-issues .task-issue-row:hover {
    background-color: rgba(220, 53, 69, 0.1) !important;
  }
  
  .btn-icon {
    background: none !important;
    border: none !important;
    cursor: pointer !important;
    padding: 4px !important;
    border-radius: 4px !important;
    transition: background-color 0.2s ease !important;
  }
  
  .btn-icon:hover {
    background: var(--border-color) !important;
  }
  
  /* Toggle Slider styles for project management */
  .toggle-slider {
    position: relative;
    width: 40px;
    height: 20px;
    background: #ccc;
    border-radius: 20px;
    transition: 0.3s;
    cursor: pointer;
  }
  
  .toggle-slider:before {
    content: "";
    position: absolute;
    height: 16px;
    width: 16px;
    left: 2px;
    top: 2px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
  }
  
  #highlight-issues-toggle:checked + .toggle-slider {
    background: var(--danger-color, #dc3545);
  }
  
  #highlight-issues-toggle:checked + .toggle-slider:before {
    transform: translateX(20px);
  }
  
  /* Context Menu Styles */
  .context-menu {
    position: fixed;
    background: var(--panel-bg, white);
    border: 1px solid var(--border-color, #ccc);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    padding: 4px 0;
    min-width: 180px;
    display: none;
    font-family: inherit;
  }
  
  .context-menu-item {
    padding: 8px 16px;
    cursor: pointer;
    color: var(--white, #333);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.2s ease;
  }
  
  .context-menu-item:hover {
    background-color: var(--border-color, #f0f0f0);
  }
  
  .context-menu-item:active {
    background-color: var(--accent, #a467ff);
    color: white;
  }

  /* Smart Setup Wizard Styles */
  .smart-setup-container {
    padding: 0;
    background: var(--panel-bg);
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(16,24,40,.06), 0 12px 24px rgba(16,24,40,.04);
  }

  .setup-progress {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 24px;
    position: relative;
    overflow: hidden;
  }

  .setup-progress::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="25" cy="25" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="25" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
    animation: float 20s linear infinite;
  }

  @keyframes float {
    0% { transform: translateX(-100px); }
    100% { transform: translateX(100px); }
  }

  .progress-bar {
    background: rgba(255,255,255,0.2);
    height: 4px;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 20px;
  }

  .progress-fill {
    background: linear-gradient(90deg, #4ade80, #22c55e);
    height: 100%;
    width: 16.67%;
    border-radius: 2px;
    transition: width 0.5s ease;
    box-shadow: 0 0 8px rgba(74, 222, 128, 0.5);
  }

  .progress-steps {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
  }

  .step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    opacity: 0.5;
    transition: opacity 0.3s ease, transform 0.3s ease;
    flex: 1;
    min-width: 80px;
  }

  .step.active {
    opacity: 1;
    transform: scale(1.05);
  }

  .step.completed {
    opacity: 1;
  }

  .step-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .step.active .step-circle {
    background: white;
    color: var(--accent);
    box-shadow: 0 0 0 4px rgba(255,255,255,0.3);
  }

  .step.completed .step-circle {
    background: #22c55e;
    color: white;
  }

  .step.completed .step-circle::before {
    content: "✓";
    font-weight: bold;
  }

  .step span {
    color: white;
    font-size: 12px;
    font-weight: 500;
    text-align: center;
  }

  .setup-page {
    display: none;
    padding: 40px;
    min-height: 600px;
    animation: fadeIn 0.5s ease;
  }

  .setup-page.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .intro-content {
    max-width: 800px;
    margin: 0 auto;
    text-align: center;
  }

  .intro-header {
    margin-bottom: 48px;
  }

  .welcome-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 24px;
    background: linear-gradient(135deg, var(--accent), #9333ea);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(164, 103, 255, 0.4); }
    50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(164, 103, 255, 0); }
  }

  .welcome-icon svg {
    width: 40px;
    height: 40px;
  }

  .intro-title {
    font-size: 36px;
    font-weight: 800;
    color: var(--white);
    margin-bottom: 12px;
  }

  .intro-subtitle {
    font-size: 18px;
    color: var(--muted);
    line-height: 1.6;
  }

  .feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 24px;
    margin-bottom: 48px;
  }

  .feature-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    animation: slideUp 0.6s ease forwards;
    opacity: 0;
    transform: translateY(30px);
  }

  @keyframes slideUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .feature-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(164, 103, 255, 0.15);
  }

  .feature-icon {
    width: 56px;
    height: 56px;
    margin: 0 auto 16px;
    background: linear-gradient(135deg, var(--accent), #9333ea);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }

  .feature-icon svg {
    width: 28px;
    height: 28px;
  }

  .feature-card h3 {
    color: var(--white);
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .feature-card p {
    color: var(--muted);
    font-size: 14px;
    line-height: 1.5;
  }

  .check-icon {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 24px;
    height: 24px;
    background: #22c55e;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    font-weight: bold;
    animation: checkmark 0.6s ease forwards;
    animation-delay: 1s;
    opacity: 0;
    transform: scale(0);
  }

  @keyframes checkmark {
    0% { opacity: 0; transform: scale(0) rotate(180deg); }
    50% { transform: scale(1.2) rotate(180deg); }
    100% { opacity: 1; transform: scale(1) rotate(0deg); }
  }

  .time-estimate {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    background: rgba(74, 222, 128, 0.1);
    border: 1px solid rgba(74, 222, 128, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 40px;
  }

  .time-icon {
    width: 48px;
    height: 48px;
    background: #22c55e;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }

  .time-icon svg {
    width: 24px;
    height: 24px;
  }

  .time-text {
    text-align: left;
  }

  .time-text strong {
    color: var(--white);
    font-size: 16px;
  }

  .time-text span {
    color: var(--muted);
    font-size: 14px;
  }

  .intro-actions {
    display: flex;
    gap: 16px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn-primary, .btn-secondary {
    padding: 14px 28px;
    border-radius: 10px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    font-size: 15px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #9333ea);
    color: white;
    box-shadow: 0 4px 12px rgba(164, 103, 255, 0.3);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(164, 103, 255, 0.4);
  }

  .btn-secondary {
    background: rgba(255,255,255,0.1);
    color: var(--white);
    border: 1px solid rgba(255,255,255,0.2);
  }

  .btn-secondary:hover {
    background: rgba(255,255,255,0.15);
  }

  .btn-primary svg, .btn-secondary svg {
    width: 18px;
    height: 18px;
  }

  .page-content {
    max-width: 800px;
    margin: 0 auto;
  }

  .page-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .page-header h2 {
    font-size: 28px;
    font-weight: 700;
    color: var(--white);
    margin-bottom: 8px;
  }

  .page-header p {
    font-size: 16px;
    color: var(--muted);
  }

  .placeholder-content {
    text-align: center;
    padding: 60px 20px;
    background: rgba(255,255,255,0.02);
    border: 2px dashed rgba(255,255,255,0.1);
    border-radius: 16px;
  }

  .placeholder-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 20px;
    color: var(--muted);
  }

  .placeholder-icon svg {
    width: 100%;
    height: 100%;
  }

  .placeholder-content h3 {
    color: var(--white);
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .placeholder-content p {
    color: var(--muted);
    font-size: 16px;
  }

  .setup-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 40px;
    background: rgba(255,255,255,0.02);
    border-top: 1px solid rgba(255,255,255,0.1);
  }

  .setup-navigation .btn-secondary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .setup-navigation .btn-secondary:disabled:hover {
    transform: none;
    background: rgba(255,255,255,0.1);
  }

  @media (max-width: 768px) {
    .smart-setup-container {
      margin: 0 -22px;
      border-radius: 0;
    }

    .setup-page {
      padding: 24px;
    }

    .setup-navigation {
      padding: 20px 24px;
    }

    .intro-title {
      font-size: 28px;
    }

    .feature-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .intro-actions {
      flex-direction: column;
    }

    .progress-steps {
      gap: 8px;
    }

    .step {
      min-width: 60px;
    }

    .step span {
      font-size: 11px;
    }

    .step-circle {
      width: 28px;
      height: 28px;
      font-size: 12px;
    }
  }

  /* Staff Import Styles */
  .import-methods {
    margin-bottom: 32px;
  }

  .import-methods-header {
    text-align: center;
    margin-bottom: 32px;
  }

  .import-methods-header h3 {
    color: var(--white);
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .import-methods-header p {
    color: var(--muted);
    font-size: 16px;
    margin: 0;
  }

  .import-method {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    margin-bottom: 16px;
    transition: all 0.3s ease;
    display: block;
  }

  .import-method:hover {
    border-color: rgba(255,255,255,0.2);
  }

  .import-method.expanded {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px rgba(164, 103, 255, 0.2);
  }

  .method-header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
  }

  .method-header:hover {
    background: rgba(255,255,255,0.02);
  }

  .import-method.expanded .method-header {
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .expand-indicator {
    margin-left: auto;
    width: 24px;
    height: 24px;
    color: var(--muted);
    transition: transform 0.3s ease;
    transform: rotate(0deg);
  }

  .import-method.expanded .expand-indicator {
    transform: rotate(180deg);
    color: var(--accent);
  }

  .method-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .import-method.expanded .method-content {
    max-height: 2000px;
  }

  .method-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--accent), #9333ea);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }

  .method-icon svg {
    width: 24px;
    height: 24px;
  }

  .method-info h3 {
    color: var(--white);
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .method-info p {
    color: var(--muted);
    font-size: 14px;
    margin: 0;
  }

  .email-import-section {
    padding: 24px;
  }

  .visual-guide-section {
    margin-bottom: 32px;
  }

  .outlook-graphic {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 32px;
  }

  .email-mockup {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 12px;
    overflow: hidden;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .email-header {
    background: rgba(255,255,255,0.05);
    padding: 12px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .email-controls {
    display: flex;
    gap: 6px;
  }

  .control-btn {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
  }

  .control-btn:first-child {
    background: #ff5f56;
  }

  .control-btn:nth-child(2) {
    background: #ffbd2e;
  }

  .control-btn:nth-child(3) {
    background: #27ca3f;
  }

  .email-title {
    color: var(--white);
    font-size: 14px;
    font-weight: 500;
  }

  .email-fields {
    padding: 16px;
  }

  .email-field {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    position: relative;
  }

  .field-label {
    color: var(--muted);
    font-size: 14px;
    font-weight: 500;
    min-width: 30px;
  }

  .field-content {
    flex: 1;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 8px 12px;
    background: rgba(255,255,255,0.05);
    border: 2px solid transparent;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .field-content.highlight {
    border-color: var(--accent);
    background: rgba(164, 103, 255, 0.1);
    animation: pulseHighlight 3s infinite;
  }

  @keyframes pulseHighlight {
    0%, 100% {
      border-color: var(--accent);
      background: rgba(164, 103, 255, 0.1);
    }
    50% {
      border-color: rgba(164, 103, 255, 0.8);
      background: rgba(164, 103, 255, 0.2);
    }
  }

  .email-recipient {
    background: rgba(255,255,255,0.1);
    color: var(--white);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    border: 1px solid rgba(255,255,255,0.15);
    transition: all 0.3s ease;
  }

  .field-content.highlight .email-recipient.selected {
    background: var(--accent);
    color: white;
    box-shadow: 0 0 8px rgba(164, 103, 255, 0.5);
  }

  .text-cursor {
    color: var(--white);
    font-size: 16px;
    font-weight: 400;
    animation: blink 1s infinite;
    margin-left: 4px;
    user-select: none;
  }

  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  .copy-icon-indicator {
    position: absolute;
    top: -35px;
    right: 50%;
    transform: translateX(50%);
    background: var(--accent);
    color: white;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(164, 103, 255, 0.3);
    animation: floatUp 2s ease-in-out infinite;
  }

  @keyframes floatUp {
    0%, 100% { transform: translateX(50%) translateY(0px); }
    50% { transform: translateX(50%) translateY(-3px); }
  }

  .copy-icon-indicator svg {
    width: 16px;
    height: 16px;
    display: block;
  }

  .arrow-down {
    margin: 16px 0;
    color: var(--accent);
    animation: bounce 2s infinite;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .arrow-down svg {
    width: 32px;
    height: 32px;
  }

  .import-guide {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }

  .guide-step {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 20px;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
  }

  .step-number {
    width: 32px;
    height: 32px;
    background: var(--accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
    flex-shrink: 0;
  }

  .step-content h4 {
    color: var(--white);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .step-content p {
    color: var(--muted);
    font-size: 14px;
    line-height: 1.5;
    margin: 0;
  }

  .paste-section {
    margin-bottom: 32px;
  }

  .paste-section label {
    display: block;
    color: var(--white);
    font-weight: 600;
    margin-bottom: 12px;
    font-size: 16px;
  }

  .email-paste-input {
    width: 100%;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 16px;
    color: var(--white);
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
    transition: all 0.3s ease;
    font-family: inherit;
    box-sizing: border-box;
  }

  .email-paste-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(164, 103, 255, 0.1);
  }

  .email-paste-input::placeholder {
    color: var(--muted);
  }

  .parse-email-btn {
    margin-top: 16px;
  }

  .parsed-results {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 24px;
    animation: slideIn 0.5s ease;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .results-header h4 {
    color: var(--white);
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }

  .staff-count {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .count-badge {
    background: var(--accent);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
  }

  .staff-count span:last-child {
    color: var(--muted);
    font-size: 14px;
  }

  .staff-list {
    display: grid;
    gap: 12px;
    margin-bottom: 24px;
  }

  .staff-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    transition: all 0.3s ease;
    animation: fadeInUp 0.4s ease forwards;
    opacity: 0;
    transform: translateY(20px);
  }

  .staff-item.animate {
    opacity: 1;
    transform: translateY(0);
  }

  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .staff-avatar {
    width: 40px;
    height: 40px;
    background: var(--accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
    flex-shrink: 0;
  }

  .staff-info {
    flex: 1;
    min-width: 0;
  }

  .staff-name {
    color: var(--white);
    font-weight: 600;
    margin-bottom: 4px;
    font-size: 15px;
  }

  .staff-email {
    color: var(--muted);
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .staff-status {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #22c55e;
    font-size: 12px;
    font-weight: 500;
  }

  .staff-status svg {
    width: 16px;
    height: 16px;
  }

  .results-actions {
    display: flex;
    gap: 16px;
    justify-content: flex-end;
    flex-wrap: wrap;
  }

  /* CSV Import Styles */
  .csv-guide {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }

  .template-section {
    margin-bottom: 32px;
  }

  .template-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    transition: all 0.3s ease;
  }

  .template-card:hover {
    border-color: rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.05);
  }

  .template-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
  }

  .template-icon svg {
    width: 24px;
    height: 24px;
  }

  .template-info {
    flex: 1;
  }

  .template-info h4 {
    color: var(--white);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .template-info p {
    color: var(--muted);
    font-size: 14px;
    margin: 0;
  }

  .template-download-btn {
    flex-shrink: 0;
  }

  .csv-upload-section {
    margin-bottom: 32px;
  }

  .csv-upload-section label {
    display: block;
    color: var(--white);
    font-weight: 600;
    margin-bottom: 16px;
    font-size: 16px;
  }

  .file-upload-area {
    border: 2px dashed rgba(255,255,255,0.2);
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255,255,255,0.02);
  }

  .file-upload-area:hover {
    border-color: var(--accent);
    background: rgba(164, 103, 255, 0.05);
  }

  .file-upload-area.dragover {
    border-color: var(--accent);
    background: rgba(164, 103, 255, 0.1);
  }

  .upload-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .upload-icon {
    width: 48px;
    height: 48px;
    color: var(--muted);
    transition: color 0.3s ease;
  }

  .file-upload-area:hover .upload-icon {
    color: var(--accent);
  }

  .upload-icon svg {
    width: 100%;
    height: 100%;
  }

  .upload-text {
    color: var(--white);
    font-size: 16px;
  }

  .upload-hint {
    color: var(--muted);
    font-size: 14px;
  }

  .file-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    padding: 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    margin-top: 16px;
  }

  .file-details {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
  }

  .file-icon {
    font-size: 24px;
  }

  .file-text {
    flex: 1;
  }

  .file-name {
    color: var(--white);
    font-weight: 600;
    font-size: 14px;
  }

  .file-size {
    color: var(--muted);
    font-size: 12px;
    margin-top: 2px;
  }

  .csv-results {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 24px;
    animation: slideIn 0.5s ease;
  }

  .csv-staff-count {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Manual Entry Styles */
  .manual-guide {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }

  .manual-form-section {
    margin-bottom: 32px;
  }

  .manual-form-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
  }

  .manual-form-card:hover {
    border-color: rgba(255,255,255,0.2);
  }

  .form-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .form-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent), #9333ea);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }

  .form-icon svg {
    width: 20px;
    height: 20px;
  }

  .form-header h4 {
    color: var(--white);
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }

  .staff-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-group label {
    color: var(--white);
    font-weight: 600;
    font-size: 14px;
  }

  .form-group input,
  .form-group select {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    padding: 12px;
    color: var(--white);
    font-size: 14px;
    transition: all 0.3s ease;
    font-family: inherit;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(164, 103, 255, 0.1);
  }

  .form-group input::placeholder {
    color: var(--muted);
  }

  .form-group select {
    appearance: none;
    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
  }

  .form-group select option {
    background: var(--panel-bg);
    color: var(--white);
  }

  .form-actions {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    justify-content: flex-end;
  }

  .manual-staff-list {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 24px;
    animation: slideIn 0.5s ease;
  }

  .list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .list-header h4 {
    color: var(--white);
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }

  .manual-staff-count {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Success Toast Styles */
  .success-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, var(--success), var(--mint));
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 500;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    animation: slideInToast 0.3s ease, fadeOutToast 0.3s ease 2.7s forwards;
  }

  .success-toast svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  @keyframes slideInToast {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes fadeOutToast {
    from {
      opacity: 1;
      transform: translateX(0);
    }
    to {
      opacity: 0;
      transform: translateX(100%);
    }
  }

  /* Manual Entry Table Styles */
  .manual-table-section {
    margin-bottom: 32px;
  }

  .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .table-header h4 {
    color: var(--white);
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }

  .table-actions {
    display: flex;
    gap: 12px;
  }

  .manual-table-container {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 20px;
    overflow-x: auto;
  }

  .manual-staff-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  .manual-staff-table th {
    color: var(--white);
    font-weight: 600;
    text-align: left;
    padding: 12px 8px;
    border-bottom: 2px solid rgba(255,255,255,0.2);
    white-space: nowrap;
  }

  .manual-staff-table td {
    padding: 12px 8px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .manual-input,
  .manual-select {
    width: 100%;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 6px;
    padding: 8px 10px;
    color: var(--white);
    font-size: 13px;
    font-family: inherit;
    transition: all 0.3s ease;
    min-width: 120px;
  }

  .manual-input:focus,
  .manual-select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(164, 103, 255, 0.1);
  }

  .manual-input::placeholder {
    color: var(--muted);
    font-size: 12px;
  }

  .manual-select {
    appearance: none;
    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>');
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 14px;
    padding-right: 30px;
  }

  .remove-row-btn {
    background: transparent;
    border: none;
    color: #ef4444;
    cursor: pointer;
    padding: 6px;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .remove-row-btn:hover {
    background: rgba(239, 68, 68, 0.1);
  }

  .remove-row-btn svg {
    width: 16px;
    height: 16px;
  }

  .table-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .staff-count {
    color: var(--muted);
    font-size: 14px;
  }

  .staff-count span {
    color: var(--white);
    font-weight: 600;
  }

  /* Surgery Setup Styles - REDESIGNED */
  .surgery-full-container {
    padding: 28px;
    display: flex;
    flex-direction: column;
    gap: 28px;
    height: calc(100vh - 200px);
    overflow-y: auto;
  }

  /* Hero Banner Section */
  .surgery-hero-banner {
    position: relative;
    height: 160px;
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 10px;
  }

  .hero-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--accent), #9333ea);
    opacity: 0.85;
    z-index: 1;
    overflow: hidden;
  }

  .hero-background:before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    animation: move 30s linear infinite;
  }

  @keyframes move {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .hero-content {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 30px;
    height: 100%;
    padding: 0 40px;
  }

  .hero-badge {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }

  .hero-badge svg {
    width: 40px;
    height: 40px;
    color: white;
  }

  .hero-text h1 {
    color: white;
    font-size: 36px;
    font-weight: 700;
    margin: 0 0 8px 0;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  }

  .hero-text p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 18px;
    margin: 0;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    max-width: 600px;
  }

  /* Tabs Navigation */
  .surgery-tabs {
    display: flex;
    gap: 16px;
    padding: 0 10px;
    margin-bottom: 5px;
  }

  .tab-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    background: transparent;
    border: none;
    color: var(--muted);
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
    font-family: inherit;
  }

  .tab-btn:hover {
    color: var(--white);
  }

  .tab-btn svg {
    width: 20px;
    height: 20px;
  }

  .tab-btn.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  /* Tab Content */
  .surgery-tab-content {
    flex: 1;
    overflow-y: auto;
  }

  .tab-panel {
    display: none;
  }

  .tab-panel.active {
    display: block;
  }

  /* Cards Container */
  .surgery-cards-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  /* Surgery Cards */
  .surgery-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .surgery-card.full-width {
    grid-column: span 2;
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px 24px;
    background: rgba(164, 103, 255, 0.06);
    border-bottom: 1px solid rgba(164, 103, 255, 0.15);
    position: relative;
  }

  .card-icon {
    width: 42px;
    height: 42px;
    background: rgba(164, 103, 255, 0.15);
    border: 1px solid rgba(164, 103, 255, 0.3);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .card-icon svg {
    width: 22px;
    height: 22px;
    color: var(--accent);
  }

  .card-header h2 {
    color: var(--white);
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }

  .card-content {
    padding: 24px;
  }

  .card-actions {
    margin-left: auto;
    display: flex;
    gap: 10px;
  }

  .card-action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: rgba(164, 103, 255, 0.1);
    border: 1px solid rgba(164, 103, 255, 0.2);
    border-radius: 8px;
    color: var(--white);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
  }

  .card-action-btn:hover {
    background: rgba(164, 103, 255, 0.2);
    transform: translateY(-1px);
  }

  .card-action-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Form Field Groups */
  .field-group {
    margin-bottom: 24px;
  }

  .field-group:last-child {
    margin-bottom: 0;
  }

  .field-group.two-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  /* Form Fields */
  .field-wrapper {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 18px;
  }

  .field-wrapper:last-child {
    margin-bottom: 0;
  }

  .field-wrapper label {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--white);
    font-weight: 600;
    font-size: 14px;
  }

  .required {
    color: #ff6b6b;
    font-size: 16px;
  }

  .field-wrapper input,
  .field-wrapper textarea {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    padding: 14px;
    color: var(--white);
    font-size: 14px;
    transition: all 0.3s ease;
    font-family: inherit;
    width: 100%;
  }

  .field-wrapper textarea {
    resize: vertical;
    min-height: 80px;
  }

  .field-wrapper input:hover,
  .field-wrapper textarea:hover {
    border-color: rgba(255, 255, 255, 0.25);
    background: rgba(255, 255, 255, 0.07);
  }

  .field-wrapper input:focus,
  .field-wrapper textarea:focus {
    outline: none;
    border-color: var(--accent);
    background: rgba(164, 103, 255, 0.05);
    box-shadow: 0 0 0 3px rgba(164, 103, 255, 0.1);
  }

  .field-wrapper input::placeholder,
  .field-wrapper textarea::placeholder {
    color: rgba(255, 255, 255, 0.35);
  }

  .field-help {
    display: flex;
    align-items: flex-start;
    gap: 6px;
    color: var(--muted);
    font-size: 12px;
    line-height: 1.4;
    margin-top: -2px;
  }

  .field-help svg {
    width: 12px;
    height: 12px;
    flex-shrink: 0;
    margin-top: 1px;
  }

  /* Checkbox Label */
  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--white);
    font-size: 14px;
    cursor: pointer;
    user-select: none;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
  }

  .checkbox-label:hover {
    background: rgba(255, 255, 255, 0.08);
  }

  .checkbox-label input {
    position: absolute;
    opacity: 0;
    height: 0;
    width: 0;
  }

  .custom-checkbox {
    position: relative;
    display: inline-block;
    width: 22px;
    height: 22px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    transition: all 0.3s ease;
  }

  .checkbox-label input:checked ~ .custom-checkbox {
    background: var(--accent);
    border-color: var(--accent);
  }

  .custom-checkbox:after {
    content: "";
    position: absolute;
    left: 7px;
    top: 3px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    opacity: 0;
    transition: all 0.2s ease;
  }

  .checkbox-label input:checked ~ .custom-checkbox:after {
    opacity: 1;
  }

  /* Hours Grid */
  .hours-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
  }

  .hours-section {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .hours-section-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent);
    margin: 0 0 8px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(164, 103, 255, 0.2);
  }

  /* Hours Item */
  .hours-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: rgba(0, 0, 0, 0.15);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: all 0.3s ease;
  }

  .hours-item:hover {
    background: rgba(0, 0, 0, 0.25);
    transform: translateY(-1px);
  }

  .day-badge {
    width: 36px;
    height: 36px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 16px;
    color: white;
    flex-shrink: 0;
  }

  .day-badge.monday {
    background: linear-gradient(135deg, #60a5fa, #3b82f6);
  }

  .day-badge.tuesday {
    background: linear-gradient(135deg, #34d399, #10b981);
  }

  .day-badge.wednesday {
    background: linear-gradient(135deg, #a78bfa, #8b5cf6);
  }

  .day-badge.thursday {
    background: linear-gradient(135deg, #fb923c, #f97316);
  }

  .day-badge.friday {
    background: linear-gradient(135deg, #f87171, #ef4444);
  }

  .day-badge.saturday {
    background: linear-gradient(135deg, #f472b6, #ec4899);
  }

  .day-badge.sunday {
    background: linear-gradient(135deg, #c084fc, #a855f7);
  }

  .day-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .day-name {
    font-weight: 500;
    font-size: 15px;
    color: var(--white);
  }

  .day-controls {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .time-inputs {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
  }

  .time-divider {
    color: var(--muted);
    font-size: 14px;
  }

  .time-field {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    padding: 10px;
    color: var(--white);
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s ease;
    width: 110px;
  }

  .time-field:hover {
    border-color: rgba(255, 255, 255, 0.25);
    background: rgba(255, 255, 255, 0.07);
  }

  .time-field:focus {
    outline: none;
    border-color: var(--accent);
    background: rgba(164, 103, 255, 0.05);
  }

  /* Toggle Switch */
  .toggle-switch {
    position: relative;
    width: 46px;
    height: 24px;
    cursor: pointer;
    flex-shrink: 0;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 24px;
    transition: all 0.3s ease;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .toggle-switch input:checked + .toggle-slider {
    background: var(--accent);
  }

  .toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(22px);
  }

  /* Hours Actions */
  .hours-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }

  .hours-actions.centered {
    justify-content: center;
  }

  .action-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 20px;
    background: rgba(164, 103, 255, 0.1);
    border: 2px solid rgba(164, 103, 255, 0.2);
    border-radius: 10px;
    color: var(--white);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
  }

  .action-btn:hover {
    background: rgba(164, 103, 255, 0.2);
    border-color: var(--accent);
    transform: translateY(-1px);
  }

  .action-btn.secondary {
    background: rgba(255, 255, 255, 0.03);
    border-color: rgba(255, 255, 255, 0.15);
    max-width: 220px;
  }

  .action-btn.secondary:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .action-btn svg {
    width: 16px;
    height: 16px;
  }

  /* Footer Navigation */
  .surgery-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    margin-top: auto;
  }

  .footer-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 24px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
  }

  .footer-btn.back {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.15);
    color: var(--white);
  }

  .footer-btn.back:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.25);
  }

  .footer-btn.continue {
    background: linear-gradient(135deg, var(--accent), #9333ea);
    border: none;
    color: white;
    box-shadow: 0 4px 12px rgba(164, 103, 255, 0.3);
  }

  .footer-btn.continue:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(164, 103, 255, 0.4);
  }

  .footer-btn svg {
    width: 18px;
    height: 18px;
  }

  .footer-middle {
    display: flex;
    align-items: center;
  }

  .step-indicator {
    color: var(--muted);
    font-size: 14px;
    font-weight: 500;
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  /* Toast Notification */
  .toast-message {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: rgba(0,0,0,0.85);
    border-left: 4px solid var(--accent);
    border-radius: 6px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    padding: 16px 20px;
    z-index: 9999;
    transform: translateY(20px);
    opacity: 0;
    transition: all 0.3s ease;
    max-width: 350px;
  }
  
  .toast-message.show {
    transform: translateY(0);
    opacity: 1;
  }
  
  .toast-content {
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
  }
  
  .toast-content svg {
    flex-shrink: 0;
    color: var(--accent);
  }

  @media (max-width: 768px) {
    /* Surgery Setup Mobile Styles */
    .surgery-page-container {
      padding: 20px 16px;
      gap: 32px;
    }

    .surgery-page-header h1 {
      font-size: 28px;
    }

    .surgery-page-header p {
      font-size: 16px;
    }

    .surgery-info-card,
    .surgery-hours-card {
      padding: 24px 20px;
    }

    .card-title h2 {
      font-size: 20px;
    }

    .day-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
      padding: 16px 20px;
    }

    .day-times {
      width: 100%;
      justify-content: space-between;
    }

    .time-input {
      flex: 1;
      max-width: 100px;
    }

    .hours-quick-actions {
      flex-direction: column;
    }

    .quick-action-btn {
      justify-content: center;
    }

    .surgery-navigation {
      flex-direction: column-reverse;
      gap: 12px;
    }

    .nav-btn {
      width: 100%;
    }

    /* Original Mobile Styles */
    .import-guide {
      grid-template-columns: 1fr;
    }

    .csv-guide {
      grid-template-columns: 1fr;
    }

    .manual-guide {
      grid-template-columns: 1fr;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .form-actions {
      justify-content: stretch;
    }

    .form-actions button {
      flex: 1;
    }

    .method-header {
      flex-direction: column;
      text-align: center;
      gap: 12px;
    }

    .results-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .results-actions {
      justify-content: stretch;
    }

    .results-actions button {
      flex: 1;
    }

    .template-card {
      flex-direction: column;
      text-align: center;
      gap: 16px;
    }

    .file-info {
      flex-direction: column;
      gap: 16px;
    }

    .file-details {
      justify-content: center;
    }
  }
</style>

<script>

    // === BRANDING MODAL + UPLOADS ===
    const brandingBtn = document.getElementById('btn-branding');
    const brandingModal = document.getElementById('branding-modal');
    const brandingClose = document.getElementById('branding-close');
    const brandingCancel = document.getElementById('branding-cancel');
    const brandingForm = document.getElementById('branding-form');
    const logoInput = document.getElementById('branding-logo');
    const sigInput  = document.getElementById('branding-signature');
    const logoPrev  = document.getElementById('branding-logo-preview');
    const sigPrev   = document.getElementById('branding-signature-preview');
    const brandErr  = document.getElementById('branding-error');
    const brandOK   = document.getElementById('branding-success');

    function openBranding(){ brandingModal?.classList.add('show'); brandErr.style.display='none'; brandOK.style.display='none'; }
    function closeBranding(){ brandingModal?.classList.remove('show'); }

    brandingBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openBranding(); });
    brandingClose?.addEventListener('click', closeBranding);
    brandingCancel?.addEventListener('click', closeBranding);

    function readPreview(input, img){
      if(!input?.files?.[0]){ img.src=''; return; }
      const file = input.files[0];
      const url = URL.createObjectURL(file);
      img.src = url;
    }
    logoInput?.addEventListener('change', ()=> readPreview(logoInput, logoPrev));
    sigInput?.addEventListener('change', ()=> readPreview(sigInput, sigPrev));

    async function uploadBranding(){
      try{
        brandErr.style.display='none'; brandOK.style.display='none';
        const bucket = 'branding';
        const siteSlug = (typeof ctx === 'object' && (ctx?.site_slug || ctx?.site_name)) ? (ctx.site_slug || String(ctx.site_name).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')) : 'default';
        const uploads = [];

        if(logoInput?.files?.[0]){
          const f = logoInput.files[0];
          const ext = (f.name.split('.').pop() || 'png').toLowerCase();
          const path = `${siteSlug}/logo.${ext}`;
          uploads.push(supabase.storage.from(bucket).upload(path, f, { upsert:true, cacheControl:'3600', contentType: f.type || 'image/png' }));
        }
        if(sigInput?.files?.[0]){
          const f = sigInput.files[0];
          const ext = (f.name.split('.').pop() || 'png').toLowerCase();
          const path = `${siteSlug}/signature.${ext}`;
          uploads.push(supabase.storage.from(bucket).upload(path, f, { upsert:true, cacheControl:'3600', contentType: f.type || 'image/png' }));
        }

        if(uploads.length === 0){ throw new Error('Please choose at least one file to upload.'); }
        const results = await Promise.all(uploads);
        const failed = results.find(r => r?.error);
        if(failed){ throw failed.error; }
        brandOK.textContent = 'Uploaded successfully.';
        brandOK.style.display = 'block';
        setTimeout(closeBranding, 900);
      }catch(err){
        console.error(err);
        brandErr.textContent = 'Upload failed: ' + (err?.message || err);
        brandErr.style.display = 'block';
      }
    }

    brandingForm?.addEventListener('submit', (e)=>{ e.preventDefault(); uploadBranding(); });

window.addEventListener('DOMContentLoaded', function initPIRemlGenerator(){
    // Initialize any needed functionality
});

  (function () {
  var ua = navigator.userAgent || "";
  var isIOSiPad = /iPad|iPhone|iPod/.test(ua) ||
                  (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
  var onIpadPage = /indexIpad\.html$/i.test(location.pathname);
  var bypass = location.search.includes("admin=1"); // add ?admin=1 to stay on Admin

  if (isIOSiPad && !onIpadPage && !bypass) {
    location.replace("indexIpad.html"); // same folder
  }
})();
</script>
<script>
// Show a persistent "Staff View" link for non-staff users (appear under profile).
// Default: show the button. If we detect the signed-in user has role 'staff', hide it.
document.addEventListener('DOMContentLoaded', () => {
  const wrap = document.getElementById('staff-return');
  const btn = document.getElementById('back-to-staff');
  if (!wrap || !btn) return;
  const fallbackWrap = document.getElementById('staff-fallback');
  const fallbackLink = document.getElementById('staff-fallback-link');

  // Always show the Staff Dashboard button for admins
  wrap.style.display = 'block';
  if (fallbackWrap) fallbackWrap.style.display = 'block';

  // Click: navigate to staff.html while preserving authentication session
  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    console.log('Staff View button clicked - checking authentication state...');
    
    try {
      // Check if we have an active Supabase session
      if (window.supabase && typeof window.supabase.auth.getSession === 'function') {
        const { data: { session }, error } = await window.supabase.auth.getSession();
        
        if (error) {
          console.warn('Error getting session:', error);
        }
        
        if (session && session.user) {
          console.log('Active session found for user:', session.user.email);
          // Session is active, navigate directly to staff.html
          window.location.href = 'staff.html';
          return;
        } else {
          console.log('No active session found');
        }
      }
      
      // If no session, still navigate but let staff.html handle the authentication
      console.log('Navigating to staff.html - authentication will be handled there');
      window.location.href = 'staff.html';
      
    } catch (error) {
      console.error('Error checking session before staff navigation:', error);
      // Fallback: navigate anyway
      window.location.href = 'staff.html';
    }
  });
  
  if (fallbackLink) {
    fallbackLink.addEventListener('click', async (e) => {
      e.preventDefault();
      console.log('Staff fallback link clicked - checking authentication state...');
      
      try {
        // Check if we have an active Supabase session
        if (window.supabase && typeof window.supabase.auth.getSession === 'function') {
          const { data: { session }, error } = await window.supabase.auth.getSession();
          
          if (error) {
            console.warn('Error getting session:', error);
          }
          
          if (session && session.user) {
            console.log('Active session found for user:', session.user.email);
            // Session is active, navigate directly to staff.html
            window.location.href = 'staff.html';
            return;
          } else {
            console.log('No active session found');
          }
        }
        
        // If no session, still navigate but let staff.html handle the authentication
        console.log('Navigating to staff.html - authentication will be handled there');
        window.location.href = 'staff.html';
        
      } catch (error) {
        console.error('Error checking session before staff navigation:', error);
        // Fallback: navigate anyway
        window.location.href = 'staff.html';
      }
    });
  }

  // Staff role checks removed: the Staff View control is intentionally ALWAYS visible on index.html.
});
</script>
<script>
// ——— Persisted sidebar group open/close ———
(function manageNavGroups(){
  function setOpen(id, open){
    const toggle = document.querySelector('.nav-group-toggle[aria-controls="'+id+'"]');
    const group = document.getElementById(id);
    if(!toggle || !group) return;
    toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    group.classList.toggle('collapsed', !open);
  }
  function restore(){
    document.querySelectorAll('.nav-group-toggle').forEach(t => {
      const id = t.getAttribute('aria-controls');
      const saved = localStorage.getItem('navGroup:'+id);
      const open = saved === 'open'; // default closed
      setOpen(id, open);
    });
  }
  document.addEventListener('DOMContentLoaded', restore);
  // Click delegation (works even if elements re-render)
  document.addEventListener('click', (e) => {
    const toggle = e.target.closest('.nav-group-toggle');
    if(!toggle) return;
    const id = toggle.getAttribute('aria-controls');
    // If sidebar is collapsed, treat the group toggle as a quick navigation to the group's
    // first child (icon) instead of expanding the group which is hidden in collapsed mode.
    const appCollapsed = document.getElementById('app')?.classList.contains('collapsed');
    if (appCollapsed) {
      const group = document.getElementById(id);
      if (group) {
        const firstBtn = group.querySelector('button[data-section]');
        if (firstBtn) {
          firstBtn.click();
          return;
        }
      }
      return;
    }

    const willOpen = toggle.getAttribute('aria-expanded') !== 'true';
    setOpen(id, willOpen);
    localStorage.setItem('navGroup:'+id, willOpen ? 'open' : 'collapsed');
  });
  // Keyboard support
  document.addEventListener('keydown', (e) => {
    const toggle = e.target && e.target.closest ? e.target.closest('.nav-group-toggle') : null;
    if(!toggle) return;
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      const id = toggle.getAttribute('aria-controls');
      const appCollapsed = document.getElementById('app')?.classList.contains('collapsed');
      if (appCollapsed) {
        const group = document.getElementById(id);
        if (group) {
          const firstBtn = group.querySelector('button[data-section]');
          if (firstBtn) { firstBtn.click(); return; }
        }
        return;
      }
      const willOpen = toggle.getAttribute('aria-expanded') !== 'true';
      setOpen(id, willOpen);
      localStorage.setItem('navGroup:'+id, willOpen ? 'open' : 'collapsed');
    }
  });
})();
</script>
<script>
// ——— Build a flat icon rail when the sidebar is collapsed (guarantees every icon is visible) ———
(function(){
  function initIconRail(){
    const app = document.getElementById('app');
    const nav = document.getElementById('nav');
    if (!app || !nav) return; // if something is really wrong, bail

    function collectButtons(){
      const list = [];
      nav.querySelectorAll(':scope > button[data-section]').forEach(b => list.push(b));
      nav.querySelectorAll('.nav-group button[data-section]').forEach(b => list.push(b));
      return list;
    }

    function ensureRail(){
      let rail = nav.querySelector('#icon-rail');
      if (!rail){
        rail = document.createElement('div');
        rail.id = 'icon-rail';
        nav.insertBefore(rail, nav.firstChild);
      }
      return rail;
    }

    function buildRail(){
      const rail = ensureRail();
      rail.innerHTML = '';
      collectButtons().forEach(orig => {
        const clone = orig.cloneNode(true);
        clone.addEventListener('click', () => orig.click());
        if (orig.classList.contains('active')) clone.classList.add('active');
        rail.appendChild(clone);
      });
      syncActive();
    }

    function syncActive(){
      const rail = nav.querySelector('#icon-rail');
      if (!rail) return;
      rail.querySelectorAll('button[data-section]').forEach(clone => {
        const key = clone.getAttribute('data-section');
        const orig = nav.querySelector(`button[data-section="${key}"]`);
        if (orig){
          clone.classList.toggle('active', orig.classList.contains('active'));
        }
      });
    }

    // Rebuild when the app toggles collapsed/expanded
    if (app) {
      const mo = new MutationObserver(() => {
        if (app.classList.contains('collapsed')) buildRail();
      });
      mo.observe(app, { attributes: true, attributeFilter: ['class'] });
    }

    // Keep clone "active" states in sync after any nav interaction
    nav.addEventListener('click', () => setTimeout(syncActive, 0));

    // Initial run: if already collapsed at load, build immediately
    if (app.classList.contains('collapsed')) buildRail();
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initIconRail);
  } else {
    initIconRail();
  }
})();
</script>
</head>
<body>
  

  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
  </div>
  <div class="mesh" aria-hidden="true"><div class="m1"></div><div class="m2"></div><div class="m3"></div></div>
  
  <!-- Floating orbs for extra depth -->
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <div class="orb orb3"></div>
  
  <!-- Particle system -->
  <div class="particles" aria-hidden="true">
    <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
    <div class="particle" style="left: 20%; animation-delay: 2s;"></div>
    <div class="particle" style="left: 30%; animation-delay: 4s;"></div>
    <div class="particle" style="left: 40%; animation-delay: 6s;"></div>
    <div class="particle" style="left: 50%; animation-delay: 8s;"></div>
    <div class="particle" style="left: 60%; animation-delay: 10s;"></div>
    <div class="particle" style="left: 70%; animation-delay: 12s;"></div>
    <div class="particle" style="left: 80%; animation-delay: 14s;"></div>
    <div class="particle" style="left: 90%; animation-delay: 16s;"></div>
  </div>

  <!-- Staff View button removed per UX request -->

  <div class="app" id="app" aria-live="polite">
    <aside class="sidebar" id="sidebar">
      <!-- Creative sidebar toggle with elegant three-line design -->
      <button id="toggleSidebar" class="sidebar-toggle" aria-label="Toggle sidebar" aria-expanded="true" title="Toggle sidebar">
        <div class="sidebar-toggle-icon">
          <div class="toggle-line"></div>
        </div>
      </button>
  <!-- Back to Staff button (conditionally shown) - moved into user profile area below -->
      <div class="brand">
        <img src="Animated_Logo.gif" alt="CheckLoop Logo" class="logo">
        <div>
          <div class="t">CheckLoop</div>
          <div class="hint">Admin</div>
        </div>
      </div>
      <nav class="nav" id="nav">
        <button onclick="window.location.href='admin-dashboard.html'" style="background: linear-gradient(135deg, #4f89ff, #3f78ff);"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span class="menu-item-label">Dashboard</span></button>

        <button data-section="smart-setup"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg><span class="menu-item-label">Smart Setup</span></button>

        <button class="nav-group-toggle" id="toggle-pre-inspection" type="button" aria-expanded="false" aria-controls="group-pre-inspection">Inspection Notice <span class="caret" aria-hidden="true"></span></button>
  <div class="nav-group collapsed" id="group-pre-inspection">
          <button data-section="pre-inspection"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg><span class="menu-item-label">Two Week Email</span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-checks" type="button" aria-expanded="false" aria-controls="group-checks">Checks & Audits <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-checks">
          <button data-section="training"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M22 10v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-6"/><path d="M16 16V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v12"/><circle cx="9" cy="9" r="1"/><path d="m1 10 2 2 4-4"/></svg><span class="menu-item-label">Training Tracker</span></button>
        </div>
          <button class="nav-group-toggle" id="toggle-complaints" type="button" aria-expanded="false" aria-controls="group-complaints">Complaints <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-complaints">
          <button data-section="complaints-dashboard"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg><span class="menu-item-label">Dashboard</span><span class="nav-badge" id="badge-complaints-dashboard"></span></button>
          <button data-section="complaints-reporting"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 6h18M3 12h18M3 18h18"/></svg><span class="menu-item-label">Complains Manager</span><span class="nav-badge" id="badge-complaints"></span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-scans" type="button" aria-expanded="false" aria-controls="group-scans">Scheduled Checks <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-scans">
          <button data-section="calendar"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="menu-item-label">Calendar</span></button>
          <button data-section="schedules"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><polyline points="12 7 12 12 16 14"></polyline></svg><span class="menu-item-label">Schedules</span></button>
          <button data-section="submissions"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="6" height="6"></rect><rect x="15" y="3" width="6" height="6"></rect><rect x="3" y="15" width="6" height="6"></rect><path d="M15 15h2v2h-2z"></path><path d="M19 19h2"></path><path d="M19 15v2"></path></svg><span class="menu-item-label">Submissions</span></button>
        </div>

        <!-- Scheduling group inserted as requested -->
        <button class="nav-group-toggle" id="toggle-scheduling" type="button" aria-expanded="false" aria-controls="group-scheduling">Resource Planning <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-scheduling">
          <button data-section="working-hours" style="display: none;"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="16" rx="2" ry="2"></rect><path d="M16 2v4"></path></svg><span class="menu-item-label">Working Hours</span></button>
          <button data-section="entitlement-management"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="16" rx="2" ry="2"></rect><path d="M8 2v4"></path><path d="M16 2v4"></path><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="menu-item-label">Staff Holidays</span></button>
          <button data-section="scheduling-dashboard"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 12a9 9 0 1 1-3.1-6.4"></path><polyline points="22 2 12 2 12 12"></polyline></svg><span class="menu-item-label">Dashboard</span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-config" type="button" aria-expanded="false" aria-controls="group-config">Surgery Settings <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-config">
          <button data-section="items"><svg class="icon" style="color: var(--muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4a2 2 0 0 0 1-1.73z"/>
            <path d="M3.27 6.96L12 12l8.73-5.04"/>
            <path d="M12 22V12"/>
          </svg><span class="menu-item-label">Items</span><span class="nav-badge" id="badge-items"></span></button>
          <button data-section="rooms"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 9l9-7 9 7"></path><path d="M9 22V12h6v10"></path><path d="M21 22H3a2 2 0 0 1-2-2V9"></path></svg><span class="menu-item-label">Rooms</span><span class="nav-badge" id="badge-rooms"></span></button>
          <button data-section="checktypes"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><polyline points="9 12 12 15 16 9"></polyline></svg><span class="menu-item-label">Check Types</span><span class="nav-badge" id="badge-ct"></span></button>
          <button data-section="quiz"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 1 1 5.83 1c0 2-3 2-3 4"/><line x1="12" y1="17" x2="12" y2="17"/></svg><span class="menu-item-label">Quiz</span><span class="nav-badge" id="badge-quiz"></span></button>
          <button data-section="staff"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="7" r="4"></circle><path d="M5.5 21a6.5 6.5 0 0 1 13 0"></path></svg><span class="menu-item-label">Staff</span><span class="nav-badge" id="badge-staff"></span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-settings" type="button" aria-expanded="false" aria-controls="group-settings">Settings <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-settings">
          <button data-section="settings" style="display: none;"><svg class="icon" style="color: var(--muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9c.69 0 1.25-.56 1.25-1.25V3a2 2 0 1 1 4 0v.09c0 .69.56 1.25 1.25 1.25.37 0 .72-.15.97-.4l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.25.25-.4.6-.4.97V9c0 .69.56 1.25 1.25 1.25H21a2 2 0 1 1 0 4h-.09c-.69 0-1.25.56-1.25 1.25z"/>
          </svg><span class="menu-item-label">Site Settings</span></button>
          <button data-section="project-management"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="menu-item-label">Project Management</span></button>
          <button data-section="users"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg><span class="menu-item-label">Users</span></button>
          <button data-section="fuzzy-match"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg><span class="menu-item-label">Holiday Import</span></button>
          <button data-section="training-import"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 11H3v10h6V11zm4-7h-2v17h2V4zm4 3v14h6V7h-6z"/></svg><span class="menu-item-label">Training Import</span></button>
        </div>
      </nav>
      
      <!-- User Profile Section -->
      <div class="user-profile">
        <div class="user-row">
          <div class="user-avatar" id="user-avatar">
            <span id="user-initials">U</span>
          </div>
          <div class="user-details">
            <div class="user-name" id="user-name">User</div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <div class="user-role" id="user-role" style="font-size: 12px; color: var(--muted);">Admin</div>
              <div class="site-info" id="site-info">Site</div>
            </div>
          </div>
        </div>
        <!-- Staff View button (for admins to switch to staff dashboard) -->
        <div id="staff-return" style="display:block;">
          <a id="back-to-staff" class="btn secondary" href="#" title="Switch to Staff Dashboard" role="button" style="display:block; width:100%; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:8px; background: linear-gradient(135deg, #76a7ff, #5f96ff); color: white; border: none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 0.25rem;">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Staff Dashboard
          </a>
        </div>
        <div id="signout-return" style="display:block;">
          <a id="signout" class="btn secondary" href="#" role="button" title="Sign Out" style="display:block; width:100%; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:8px;">
            <span>Sign Out</span>
          </a>
        </div>
      </div>
      
      <!-- Resize handle for dragging sidebar width -->
      <div id="sidebar-resize-handle"></div>
    </aside>

    <main class="content">
      <section class="view active" id="view-dashboard">
        <div class="panel" style="display:grid; place-items:center; min-height:220px; text-align:center;">
          <div>
            <div style="font-size:24px; font-weight:800; color: var(--white);">Dashboard Coming Soon</div>
            <div style="margin-top:6px; color: var(--muted);">We’re building a fresh overview with live metrics and quick actions.</div>
          </div>
        </div>
      </section>

      <!-- Smart Setup Section -->
      <section class="view" id="view-smart-setup">
        <div class="smart-setup-container">

          <!-- Progress Bar -->
          <div class="setup-progress" id="setup-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-steps">
              <div class="step active" data-step="0">
                <div class="step-circle">1</div>
                <span>Welcome</span>
              </div>
              <div class="step" data-step="1">
                <div class="step-circle">2</div>
                <span>Surgery Setup</span>
              </div>
              <div class="step" data-step="2">
                <div class="step-circle">3</div>
                <span>Staff & Users</span>
              </div>
              <div class="step" data-step="3">
                <div class="step-circle">4</div>
                <span>Rooms & Areas</span>
              </div>
              <div class="step" data-step="4">
                <div class="step-circle">5</div>
                <span>Training Records</span>
              </div>
              <div class="step" data-step="5">
                <div class="step-circle">6</div>
                <span>Holidays</span>
              </div>
              <div class="step" data-step="6">
                <div class="step-circle">7</div>
                <span>Final Setup</span>
              </div>
            </div>
          </div>

          <!-- Intro Page -->
          <div class="setup-page active" id="setup-page-0">
            <div class="intro-content">
              <div class="intro-header">
                <div class="welcome-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
                    <path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/>
                    <path d="M12 2v2"/>
                    <path d="M12 20v2"/>
                    <path d="m4.93 4.93 1.41 1.41"/>
                    <path d="m17.66 17.66 1.41 1.41"/>
                    <path d="M2 12h2"/>
                    <path d="M20 12h2"/>
                    <path d="m6.34 17.66-1.41 1.41"/>
                    <path d="m19.07 4.93-1.41 1.41"/>
                  </svg>
                </div>
                <h1 class="intro-title">Welcome to Smart Setup</h1>
                <p class="intro-subtitle">Set up your surgery in CheckLoops with our intelligent automation wizard</p>
              </div>

              <div class="feature-grid">
                <div class="feature-card" style="animation-delay: 0.2s">
                  <div class="feature-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                    </svg>
                  </div>
                  <h3>Staff Management</h3>
                  <p>Bulk upload staff details, roles, and permissions</p>
                  <div class="check-icon">✓</div>
                </div>

                <div class="feature-card" style="animation-delay: 0.4s">
                  <div class="feature-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 9l9-7 9 7"/>
                      <path d="M9 22V12h6v10"/>
                    </svg>
                  </div>
                  <h3>Rooms & Areas</h3>
                  <p>Configure all surgical areas and equipment zones</p>
                  <div class="check-icon">✓</div>
                </div>

                <div class="feature-card" style="animation-delay: 0.6s">
                  <div class="feature-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 10v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-6"/>
                      <path d="M16 16V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v12"/>
                      <circle cx="9" cy="9" r="1"/>
                    </svg>
                  </div>
                  <h3>Training Records</h3>
                  <p>Import existing training certificates and records</p>
                  <div class="check-icon">✓</div>
                </div>

                <div class="feature-card" style="animation-delay: 0.8s">
                  <div class="feature-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                      <line x1="16" y1="2" x2="16" y2="6"/>
                      <line x1="8" y1="2" x2="8" y2="6"/>
                      <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                  </div>
                  <h3>Holiday Calendar</h3>
                  <p>Set up annual leave and public holidays</p>
                  <div class="check-icon">✓</div>
                </div>
              </div>

              <div class="time-estimate">
                <div class="time-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12,6 12,12 16,14"/>
                  </svg>
                </div>
                <div class="time-text">
                  <strong>15-30 minutes</strong> to complete setup
                  <br><span>One-time configuration gets you fully operational</span>
                </div>
              </div>

              <div class="intro-actions">
                <button class="btn-secondary" onclick="closeSmartSetup()">Maybe Later</button>
                <button class="btn-primary" onclick="startSmartSetup()">
                  Get Started
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m9 18 6-6-6-6"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Surgery Setup Page - REDESIGNED -->
          <div class="setup-page" id="setup-page-1">
            <div class="surgery-full-container">

              <!-- New Hero Banner Section -->
              <div class="surgery-hero-banner">
                <div class="hero-background"></div>
                <div class="hero-content">
                  <div class="hero-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                      <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                  </div>
                  <div class="hero-text">
                    <h1>Surgery Profile</h1>
                    <p>Create your surgery's digital identity and operating schedule</p>
                  </div>
                </div>
              </div>

              <!-- Tabs Navigation -->
              <div class="surgery-tabs">
                <button class="tab-btn active" data-tab="profile">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 7h-3a2 2 0 0 1-2-2V2"/>
                    <path d="M9 18h6"/>
                    <path d="M10 14h4"/>
                    <rect width="18" height="18" x="3" y="3" rx="2"/>
                  </svg>
                  Practice Details
                </button>
                <button class="tab-btn" data-tab="hours">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  Operating Hours
                </button>
              </div>
              
              <!-- Main Content Panels -->
              <div class="surgery-tab-content">
                <!-- Profile Tab -->
                <div class="tab-panel active" id="profile-tab">
                  <div class="surgery-cards-container">
                    <!-- Surgery Information Card -->
                    <div class="surgery-card">
                      <div class="card-header">
                        <div class="card-icon">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                          </svg>
                        </div>
                        <h2>Practice Information</h2>
                      </div>
                      <div class="card-content">
                        <div class="field-group">
                          <div class="field-wrapper">
                            <label for="surgery-name">
                              <span class="label-text">Practice Name</span>
                              <span class="required">*</span>
                            </label>
                            <input type="text"
                                  id="surgery-name"
                                  placeholder="e.g. Stoke Medical Centre"
                                  required>
                            <div class="field-help">
                              <svg viewBox="0 0 16 16" fill="currentColor">
                                <circle cx="8" cy="8" r="6" opacity="0.3"/>
                                <path d="M8 7v4m0-6v.5"/>
                              </svg>
                              The official name of your practice
                            </div>
                          </div>
                        </div>
                        
                        <div class="field-group two-columns">
                          <div class="field-wrapper">
                            <label for="surgery-town">
                              <span class="label-text">Town/City</span>
                              <span class="required">*</span>
                            </label>
                            <input type="text"
                                  id="surgery-town"
                                  placeholder="e.g. Manchester"
                                  required>
                          </div>
                          
                          <div class="field-wrapper">
                            <label for="surgery-postcode">
                              <span class="label-text">Postcode</span>
                            </label>
                            <input type="text"
                                  id="surgery-postcode"
                                  placeholder="e.g. M1 2AB">
                          </div>
                        </div>
                        
                        <div class="field-wrapper">
                          <label for="surgery-phone">
                            <span class="label-text">Phone Number</span>
                          </label>
                          <input type="tel"
                                id="surgery-phone"
                                placeholder="e.g. 01234 567890">
                        </div>
                      </div>
                    </div>
                    
                    <!-- Additional Information Card -->
                    <div class="surgery-card">
                      <div class="card-header">
                        <div class="card-icon">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4"/>
                            <path d="M12 8h.01"/>
                          </svg>
                        </div>
                        <h2>Additional Details</h2>
                      </div>
                      <div class="card-content">
                        <div class="field-wrapper">
                          <label for="surgery-website">
                            <span class="label-text">Website URL</span>
                          </label>
                          <input type="url"
                                id="surgery-website"
                                placeholder="e.g. https://www.example.nhs.uk">
                        </div>
                        
                        <div class="field-wrapper">
                          <label for="surgery-description">
                            <span class="label-text">Brief Description</span>
                          </label>
                          <textarea 
                                id="surgery-description" 
                                placeholder="A short description of your practice..."
                                rows="3"></textarea>
                        </div>
                        
                        <div class="field-wrapper">
                          <label class="checkbox-label">
                            <input type="checkbox" id="surgery-training">
                            <span class="custom-checkbox"></span>
                            <span>This is a training practice</span>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Hours Tab -->
                <div class="tab-panel" id="hours-tab">
                  <div class="surgery-card full-width">
                    <div class="card-header">
                      <div class="card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/>
                          <polyline points="12 6 12 12 16 14"/>
                        </svg>
                      </div>
                      <h2>Practice Opening Hours</h2>
                      
                      <div class="card-actions">
                        <button type="button" class="card-action-btn" onclick="applyToAllDays()">
                          <svg viewBox="0 0 20 20" fill="currentColor">
                            <path d="M8 5a1 1 0 100 2h5.586L4.293 16.293a1 1 0 101.414 1.414L15 8.414V14a1 1 0 102 0V6a1 1 0 00-1-1H8z"/>
                          </svg>
                          Apply Monday to All
                        </button>
                      </div>
                    </div>
                    
                    <div class="card-content">
                      <div class="hours-grid">
                        <!-- Weekdays Section -->
                        <div class="hours-section">
                          <h3 class="hours-section-title">Weekdays</h3>
                          
                          <!-- Monday -->
                          <div class="hours-item">
                            <div class="day-badge monday">
                              <span>M</span>
                            </div>
                            <div class="day-details">
                              <div class="day-name">Monday</div>
                              <div class="day-controls">
                                <label class="toggle-switch">
                                  <input type="checkbox" id="monday-enabled" checked>
                                  <span class="toggle-slider"></span>
                                </label>
                                <div class="time-inputs">
                                  <input type="time" id="monday-open" value="08:00" class="time-field">
                                  <span class="time-divider">to</span>
                                  <input type="time" id="monday-close" value="17:00" class="time-field">
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Tuesday -->
                          <div class="hours-item">
                            <div class="day-badge tuesday">
                              <span>T</span>
                            </div>
                            <div class="day-details">
                              <div class="day-name">Tuesday</div>
                              <div class="day-controls">
                                <label class="toggle-switch">
                                  <input type="checkbox" id="tuesday-enabled" checked>
                                  <span class="toggle-slider"></span>
                                </label>
                                <div class="time-inputs">
                                  <input type="time" id="tuesday-open" value="08:00" class="time-field">
                                  <span class="time-divider">to</span>
                                  <input type="time" id="tuesday-close" value="17:00" class="time-field">
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Wednesday -->
                          <div class="hours-item">
                            <div class="day-badge wednesday">
                              <span>W</span>
                            </div>
                            <div class="day-details">
                              <div class="day-name">Wednesday</div>
                              <div class="day-controls">
                                <label class="toggle-switch">
                                  <input type="checkbox" id="wednesday-enabled" checked>
                                  <span class="toggle-slider"></span>
                                </label>
                                <div class="time-inputs">
                                  <input type="time" id="wednesday-open" value="08:00" class="time-field">
                                  <span class="time-divider">to</span>
                                  <input type="time" id="wednesday-close" value="17:00" class="time-field">
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Thursday -->
                          <div class="hours-item">
                            <div class="day-badge thursday">
                              <span>T</span>
                            </div>
                            <div class="day-details">
                              <div class="day-name">Thursday</div>
                              <div class="day-controls">
                                <label class="toggle-switch">
                                  <input type="checkbox" id="thursday-enabled" checked>
                                  <span class="toggle-slider"></span>
                                </label>
                                <div class="time-inputs">
                                  <input type="time" id="thursday-open" value="08:00" class="time-field">
                                  <span class="time-divider">to</span>
                                  <input type="time" id="thursday-close" value="17:00" class="time-field">
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Friday -->
                          <div class="hours-item">
                            <div class="day-badge friday">
                              <span>F</span>
                            </div>
                            <div class="day-details">
                              <div class="day-name">Friday</div>
                              <div class="day-controls">
                                <label class="toggle-switch">
                                  <input type="checkbox" id="friday-enabled" checked>
                                  <span class="toggle-slider"></span>
                                </label>
                                <div class="time-inputs">
                                  <input type="time" id="friday-open" value="08:00" class="time-field">
                                  <span class="time-divider">to</span>
                                  <input type="time" id="friday-close" value="17:00" class="time-field">
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Weekend Section -->
                        <div class="hours-section">
                          <h3 class="hours-section-title">Weekend</h3>
                          
                          <!-- Saturday -->
                          <div class="hours-item">
                            <div class="day-badge saturday">
                              <span>S</span>
                            </div>
                            <div class="day-details">
                              <div class="day-name">Saturday</div>
                              <div class="day-controls">
                                <label class="toggle-switch">
                                  <input type="checkbox" id="saturday-enabled">
                                  <span class="toggle-slider"></span>
                                </label>
                                <div class="time-inputs">
                                  <input type="time" id="saturday-open" value="09:00" class="time-field">
                                  <span class="time-divider">to</span>
                                  <input type="time" id="saturday-close" value="13:00" class="time-field">
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Sunday -->
                          <div class="hours-item">
                            <div class="day-badge sunday">
                              <span>S</span>
                            </div>
                            <div class="day-details">
                              <div class="day-name">Sunday</div>
                              <div class="day-controls">
                                <label class="toggle-switch">
                                  <input type="checkbox" id="sunday-enabled">
                                  <span class="toggle-slider"></span>
                                </label>
                                <div class="time-inputs">
                                  <input type="time" id="sunday-open" value="10:00" class="time-field">
                                  <span class="time-divider">to</span>
                                  <input type="time" id="sunday-close" value="14:00" class="time-field">
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="hours-actions centered">
                        <button type="button" class="action-btn secondary" onclick="clearAllHours()">
                          <svg viewBox="0 0 20 20" fill="currentColor">
                            <path d="M4 3a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V8a1 1 0 00-1-1H9L7.707 5.707A1 1 0 007 5.414V4a1 1 0 00-1-1H4z"/>
                          </svg>
                          Reset All Hours
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Bottom Navigation -->
              <div class="surgery-footer">
                <button class="footer-btn back" onclick="previousStep()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m15 18-6-6 6-6"/>
                  </svg>
                  Back to Welcome
                </button>
                <div class="footer-middle">
                  <span class="step-indicator">Step 2 of 7</span>
                </div>
                <button class="footer-btn continue" onclick="saveSurgerySetup()">
                  Continue to Staff Setup
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m9 18 6-6-6-6"/>
                  </svg>
                </button>
              </div>

            </div>
          </div>

          <!-- Staff & Users Page -->
          <div class="setup-page" id="setup-page-2">
            <div class="page-content">
              <div class="page-header">
                <h2>Staff & Users Setup</h2>
                <p>Add your team members quickly and easily</p>
              </div>

              <!-- Import Methods -->
              <div class="import-methods">
                <div class="import-methods-header">
                  <h3>Choose how you'd like to add your staff:</h3>
                  <p>Select the method that works best for your situation</p>
                </div>

                <!-- Email Import Method -->
                <div class="import-method" id="email-import">
                  <div class="method-header" onclick="toggleImportMethod('email-import')">
                    <div class="method-icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                      </svg>
                    </div>
                    <div class="method-info">
                      <h3>Copy from Email</h3>
                      <p>The quickest way - copy all staff from your email's "To" field</p>
                    </div>
                    <div class="expand-indicator">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m6 9 6 6 6-6"/>
                      </svg>
                    </div>
                  </div>

                  <!-- Email Import Interface -->
                  <div class="method-content">
                    <div class="email-import-section">
                    <!-- Visual Guide with Graphic -->
                    <div class="visual-guide-section">
                      <div class="outlook-graphic">
                        <div class="email-mockup">
                          <div class="email-header">
                            <div class="email-controls">
                              <div class="control-btn"></div>
                              <div class="control-btn"></div>
                              <div class="control-btn"></div>
                            </div>
                            <div class="email-title">Weekly Team Update - All Staff</div>
                          </div>
                          <div class="email-fields">
                            <div class="email-field">
                              <span class="field-label">To:</span>
                              <div class="field-content highlight">
                                <div class="email-recipient selected">Dr. Smith</div>
                                <div class="email-recipient selected">Nurse Johnson</div>
                                <div class="email-recipient selected">Tech Brown</div>
                                <div class="email-recipient selected">+8 more...</div>
                                <div class="text-cursor">|</div>
                              </div>
                              <div class="copy-icon-indicator">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="arrow-down">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m7 13 5 5 5-5"/>
                            <path d="m7 6 5 5 5-5"/>
                          </svg>
                        </div>
                      </div>

                      <div class="import-guide">
                        <div class="guide-step">
                          <div class="step-number">1</div>
                          <div class="step-content">
                            <h4>Find your email</h4>
                            <p>Open an email where all your team members are in the "To" field</p>
                          </div>
                        </div>
                        <div class="guide-step">
                          <div class="step-number">2</div>
                          <div class="step-content">
                            <h4>Select & copy</h4>
                            <p>Click in the "To" field and select all (Ctrl+A), then copy (Ctrl+C)</p>
                          </div>
                        </div>
                        <div class="guide-step">
                          <div class="step-number">3</div>
                          <div class="step-content">
                            <h4>Paste below</h4>
                            <p>We'll automatically extract all names and email addresses</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Email Paste Box -->
                    <div class="paste-section">
                      <label for="email-paste">Paste your email recipients here:</label>
                      <textarea
                        id="email-paste"
                        class="email-paste-input"
                        placeholder="Paste something like: Dr. Sarah Johnson (ID123) s.johnson@hospital.com; Nurse Mike Brown (ID456) m.brown@hospital.com; Tech Alice Wilson (ID789) a.wilson@hospital.com; ..."
                        rows="4"></textarea>
                      <button class="btn-primary parse-email-btn" onclick="parseEmailPaste()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M9 12l2 2 4-4"/>
                          <circle cx="12" cy="12" r="10"/>
                        </svg>
                        Extract Staff List
                      </button>
                    </div>

                    <!-- Results Section -->
                    <div class="parsed-results" id="parsed-results" style="display: none;">
                      <div class="results-header">
                        <h4>Detected Staff Members</h4>
                        <div class="staff-count">
                          <span class="count-badge" id="staff-count">0</span>
                          <span>staff members found</span>
                        </div>
                      </div>
                      <div class="staff-list" id="staff-list">
                        <!-- Parsed staff will appear here -->
                      </div>
                      <div class="results-actions">
                        <button class="btn-secondary" onclick="clearResults()">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                          </svg>
                          Clear & Try Again
                        </button>
                        <button class="btn-primary" onclick="proceedWithStaff()" disabled id="proceed-btn">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m9 18 6-6-6-6"/>
                          </svg>
                          Continue with These Staff
                        </button>
                      </div>
                    </div>
                  </div>
                  </div>
                </div>

                <!-- CSV Import Method -->
                <div class="import-method" id="csv-import">
                  <div class="method-header" onclick="toggleImportMethod('csv-import')">
                    <div class="method-icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                      </svg>
                    </div>
                    <div class="method-info">
                      <h3>Upload CSV File</h3>
                      <p>Perfect for bulk imports from spreadsheets with detailed staff information</p>
                    </div>
                    <div class="expand-indicator">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m6 9 6 6 6-6"/>
                      </svg>
                    </div>
                  </div>
                  <div class="method-content">
                    <div class="csv-import-section">

                      <!-- CSV Import Guide -->
                      <div class="csv-guide">
                        <div class="guide-step">
                          <div class="step-number">1</div>
                          <div class="step-content">
                            <h4>Download template</h4>
                            <p>Get our CSV template with the correct column headers</p>
                          </div>
                        </div>
                        <div class="guide-step">
                          <div class="step-number">2</div>
                          <div class="step-content">
                            <h4>Fill in your data</h4>
                            <p>Add your staff information using Excel, Google Sheets, or any spreadsheet app</p>
                          </div>
                        </div>
                        <div class="guide-step">
                          <div class="step-number">3</div>
                          <div class="step-content">
                            <h4>Upload & import</h4>
                            <p>Upload your completed CSV file and we'll import all your staff</p>
                          </div>
                        </div>
                      </div>

                      <!-- Template Download -->
                      <div class="template-section">
                        <div class="template-card">
                          <div class="template-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                              <polyline points="14,2 14,8 20,8"/>
                              <line x1="16" y1="13" x2="8" y2="13"/>
                              <line x1="16" y1="17" x2="8" y2="17"/>
                              <polyline points="10,9 9,9 8,9"/>
                            </svg>
                          </div>
                          <div class="template-info">
                            <h4>Staff Import Template</h4>
                            <p>CSV template with Name, Email, Role, Team, and Access columns</p>
                          </div>
                          <button class="btn-secondary template-download-btn" onclick="downloadCsvTemplate(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                              <polyline points="7,10 12,15 17,10"/>
                              <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Download Template
                          </button>
                        </div>
                      </div>

                      <!-- CSV Upload Section -->
                      <div class="csv-upload-section">
                        <label for="csv-file-input">Upload your completed CSV file:</label>

                        <div class="file-upload-area" id="csv-upload-area" onclick="document.getElementById('csv-file-input').click()">
                          <div class="upload-content">
                            <div class="upload-icon">
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17,8 12,3 7,8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                              </svg>
                            </div>
                            <div class="upload-text">
                              <strong>Click to upload</strong> or drag and drop your CSV file
                              <br><span class="upload-hint">Supports .csv files up to 5MB</span>
                            </div>
                          </div>
                        </div>

                        <input type="file" id="csv-file-input" accept=".csv" style="display: none" onchange="handleCsvUpload(event)">

                        <div class="file-info" id="csv-file-info" style="display: none;">
                          <div class="file-details">
                            <div class="file-icon">📄</div>
                            <div class="file-text">
                              <div class="file-name" id="csv-file-name"></div>
                              <div class="file-size" id="csv-file-size"></div>
                            </div>
                          </div>
                          <button class="btn-primary" onclick="processCsvFile()" id="process-csv-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M9 12l2 2 4-4"/>
                              <circle cx="12" cy="12" r="10"/>
                            </svg>
                            Process CSV File
                          </button>
                        </div>
                      </div>

                      <!-- CSV Results Section -->
                      <div class="csv-results" id="csv-results" style="display: none;">
                        <div class="results-header">
                          <h4>CSV Import Results</h4>
                          <div class="csv-staff-count">
                            <span class="count-badge" id="csv-staff-count">0</span>
                            <span>staff members imported</span>
                          </div>
                        </div>
                        <div class="staff-list" id="csv-staff-list">
                          <!-- Parsed CSV staff will appear here -->
                        </div>
                        <div class="results-actions">
                          <button class="btn-secondary" onclick="clearCsvResults()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <line x1="18" y1="6" x2="6" y2="18"/>
                              <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                            Clear & Try Again
                          </button>
                          <button class="btn-primary" onclick="proceedWithCsvStaff()" disabled id="csv-proceed-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="m9 18 6-6-6-6"/>
                            </svg>
                            Continue with CSV Staff
                          </button>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>

                <!-- Manual Entry Method -->
                <div class="import-method" id="manual-import">
                  <div class="method-header" onclick="toggleImportMethod('manual-import')">
                    <div class="method-icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9"/>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                      </svg>
                    </div>
                    <div class="method-info">
                      <h3>Enter Manually</h3>
                      <p>Add staff one by one with full control over roles and permissions</p>
                    </div>
                    <div class="expand-indicator">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m6 9 6 6 6-6"/>
                      </svg>
                    </div>
                  </div>
                  <div class="method-content">
                    <div class="manual-import-section">

                      <!-- Manual Entry Guide -->
                      <div class="manual-guide">
                        <div class="guide-step">
                          <div class="step-number">1</div>
                          <div class="step-content">
                            <h4>Fill in table rows</h4>
                            <p>Enter each staff member's details in the table rows below</p>
                          </div>
                        </div>
                        <div class="guide-step">
                          <div class="step-number">2</div>
                          <div class="step-content">
                            <h4>Add more rows</h4>
                            <p>Click "Add Row" to add more staff members to the table</p>
                          </div>
                        </div>
                        <div class="guide-step">
                          <div class="step-number">3</div>
                          <div class="step-content">
                            <h4>Continue setup</h4>
                            <p>Once complete, click "Continue" to proceed to the next step</p>
                          </div>
                        </div>
                      </div>

                      <!-- Manual Entry Table -->
                      <div class="manual-table-section">
                        <div class="table-header">
                          <h4>Staff Members</h4>
                          <div class="table-actions">
                            <button type="button" class="btn-secondary" onclick="addManualRow()">
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14"/>
                                <path d="M5 12h14"/>
                              </svg>
                              Add Row
                            </button>
                            <button type="button" class="btn-secondary" onclick="clearAllRows()">
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                              </svg>
                              Clear All
                            </button>
                          </div>
                        </div>

                        <div class="manual-table-container">
                          <table class="manual-staff-table" id="manual-staff-table">
                            <thead>
                              <tr>
                                <th>Full Name *</th>
                                <th>Email Address *</th>
                                <th>Role</th>
                                <th>Team/Department</th>
                                <th>Access Level *</th>
                                <th>Actions</th>
                              </tr>
                            </thead>
                            <tbody id="manual-table-body">
                              <!-- Initial row -->
                              <tr class="manual-row" data-row="0">
                                <td>
                                  <input type="text" class="manual-input" placeholder="e.g. Dr. Sarah Johnson" required>
                                </td>
                                <td>
                                  <input type="email" class="manual-input" placeholder="e.g. s.johnson@hospital.com" required>
                                </td>
                                <td>
                                  <input type="text" class="manual-input" placeholder="e.g. Doctor, Nurse">
                                </td>
                                <td>
                                  <input type="text" class="manual-input" placeholder="e.g. Surgery, ICU">
                                </td>
                                <td>
                                  <select class="manual-select" required>
                                    <option value="">Select...</option>
                                    <option value="Admin">Admin</option>
                                    <option value="Staff">Staff</option>
                                  </select>
                                </td>
                                <td>
                                  <button type="button" class="remove-row-btn" onclick="removeManualRow(this)" title="Remove row">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                      <path d="M18 6L6 18M6 6l12 12"/>
                                    </svg>
                                  </button>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>

                        <div class="table-footer">
                          <div class="staff-count">
                            <span id="manual-row-count">1</span> row(s)
                          </div>
                          <button class="btn-primary" onclick="processManualStaff()" id="manual-process-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="m9 18 6-6-6-6"/>
                            </svg>
                            Continue with Staff List
                          </button>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Rooms & Areas Page -->
          <div class="setup-page" id="setup-page-3">
            <div class="page-content">
              <div class="page-header">
                <h2>Rooms & Areas Setup</h2>
                <p>Configure your surgical areas and equipment zones</p>
              </div>
              <div class="placeholder-content">
                <div class="placeholder-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 9l9-7 9 7"/>
                    <path d="M9 22V12h6v10"/>
                  </svg>
                </div>
                <h3>Coming Soon</h3>
                <p>Room configuration interface will appear here</p>
              </div>
            </div>
          </div>

          <!-- Training Records Page -->
          <div class="setup-page" id="setup-page-4">
            <div class="page-content">
              <div class="page-header">
                <h2>Training Records Setup</h2>
                <p>Import existing training certificates and records</p>
              </div>
              <div class="placeholder-content">
                <div class="placeholder-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M22 10v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-6"/>
                    <path d="M16 16V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v12"/>
                  </svg>
                </div>
                <h3>Coming Soon</h3>
                <p>Training import interface will appear here</p>
              </div>
            </div>
          </div>

          <!-- Holidays Page -->
          <div class="setup-page" id="setup-page-5">
            <div class="page-content">
              <div class="page-header">
                <h2>Holiday Calendar Setup</h2>
                <p>Configure annual leave and public holidays</p>
              </div>
              <div class="placeholder-content">
                <div class="placeholder-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                  </svg>
                </div>
                <h3>Coming Soon</h3>
                <p>Holiday management interface will appear here</p>
              </div>
            </div>
          </div>

          <!-- Final Setup Page -->
          <div class="setup-page" id="setup-page-6">
            <div class="page-content">
              <div class="page-header">
                <h2>Final Setup & Review</h2>
                <p>Review your configuration and complete setup</p>
              </div>
              <div class="placeholder-content">
                <div class="placeholder-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M9 12l2 2 4-4"/>
                    <circle cx="12" cy="12" r="10"/>
                  </svg>
                </div>
                <h3>Coming Soon</h3>
                <p>Final review and completion interface will appear here</p>
              </div>
            </div>
          </div>

          <!-- Navigation Controls -->
          <div class="setup-navigation">
            <button class="btn-secondary" id="prev-btn" onclick="previousStep()" disabled>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m15 18-6-6 6-6"/>
              </svg>
              Previous
            </button>
            <button class="btn-primary" id="next-btn" onclick="nextStep()">
              Next
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m9 18 6-6-6-6"/>
              </svg>
            </button>
          </div>
        </div>
      </section>

      <!-- Project Management Section -->
      <section class="view" id="view-project-management">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Project Management</h1>
              <button class="help-icon" onclick="showHelp('view-project-management')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <div class="toggle-switch">
                  <input type="checkbox" id="highlight-issues-toggle" style="display:none;">
                  <span class="toggle-slider"></span>
                </div>
                <span style="color: var(--white); font-weight: 600;">Highlight Issues</span>
              </label>
              <button class="btn" id="btn-refresh-tasks" onclick="loadProjectTasks()" title="Refresh tasks">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 5px;">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
                Refresh
              </button>
              <button class="btn" id="btn-add-task">Add Task</button>
            </div>
          </div>

          <!-- Status Overview Cards -->
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:24px;">
            <div class="stat-card">
              <div class="icon-wrap" style="--c: var(--stat-1-bg); --i: var(--stat-1-color);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <div class="stat-num" id="tasks-total">0</div>
                <div class="stat-label">Total Tasks</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="icon-wrap" style="--c: var(--stat-2-bg); --i: var(--stat-2-color);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
              </div>
              <div>
                <div class="stat-num" id="tasks-completed">0</div>
                <div class="stat-label">Completed</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="icon-wrap" style="--c: var(--stat-3-bg); --i: var(--stat-3-color);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
              </div>
              <div>
                <div class="stat-num" id="tasks-open">0</div>
                <div class="stat-label">Open Tasks</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="icon-wrap" style="--c: var(--stat-4-bg); --i: var(--stat-4-color);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
              </div>
              <div>
                <div class="stat-num" id="tasks-bugs">0</div>
                <div class="stat-label">Bugs</div>
              </div>
            </div>
          </div>

          <!-- Filter Tabs -->
          <div class="tab-controls" style="margin-bottom: 24px; display:flex; gap:8px; align-items: center;">
            <button class="btn secondary active" id="tab-all-tasks" data-filter="all">All Tasks</button>
            <button class="btn secondary" id="tab-bugs" data-filter="bug">🐛 Bugs</button>
            <button class="btn secondary" id="tab-features" data-filter="feature" data-hide-done="false">✨ Features</button>
            <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
              <span style="color: var(--text-color); font-size: 14px;">Hide completed:</span>
              <button class="btn secondary" id="toggle-completed-filter" title="Toggle completed items visibility">👁️ Show All</button>
            </div>
          </div>

          <!-- Bulk Actions Bar -->
          <div class="bulk-actions-bar" id="bulk-actions-bar" style="display: none; background: var(--primary-color); color: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span id="selected-count">0</span> tasks selected
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn secondary" id="bulk-copy-btn" style="background: white; color: var(--primary-color);">📋 Copy Selected</button>
              <button class="btn secondary" id="bulk-delete-btn" style="background: #dc3545; color: white;">🗑️ Delete Selected</button>
              <button class="btn secondary" id="clear-selection-btn" style="background: transparent; border: 1px solid white; color: white;">Clear Selection</button>
            </div>
          </div>

          <!-- Tasks Table -->
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width: 40px;">
                    <input type="checkbox" id="select-all-tasks" title="Select all tasks" />
                  </th>
                  <th style="width: 48px;">#</th>
                  <th style="width: 64px;">Done</th>
                  <th style="width: 80px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 4px;">
                      Status
                      <button id="toggle-completed-btn" title="Toggle completed items visibility" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; font-size: 14px; padding: 4px 6px; min-width: 24px; color: white; transition: all 0.2s;">👁️</button>
                    </div>
                  </th>
                  <th>Task</th>
                  <th>Type</th>
                  <th>Created</th>
                  <th style="width: 100px;">Actions</th>
                </tr>
              </thead>
              <tbody id="project-tasks-tbody">
                <tr><td colspan="8" class="muted">Loading tasks...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="view" id="view-quiz">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Quiz Management</h1>
              <button class="help-icon" onclick="showHelp('view-quiz')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn secondary" id="btn-quiz-refresh">Refresh</button>
              <a class="btn" id="btn-open-quiz" href="quiz.html?site=2" target="_blank">Open Quiz Page</a>
            </div>
          </div>

          <div class="table-wrap" style="margin-top:10px">
            <table>
              <thead id="quiz-thead">
                <tr><th class="muted">Loading schema…</th></tr>
              </thead>
              <tbody id="quiz-tbody">
                <tr><td class="muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="hint" style="margin-top:10px">Showing raw contents of <code>quiz_questions</code> from Supabase.</div>

          <!-- Quiz Attempts Section -->
          <div style="margin-top: 40px;">
            <h2 style="color: var(--ink); margin-bottom: 20px;">Staff Quiz Progress</h2>
            
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Participant Name</th>
                    <th>Started At</th>
                    <th>Completed At</th>
                    <th>Questions</th>
                    <th>Correct Answers</th>
                    <th>Score %</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="quiz-attempts-tbody">
                  <tr><td colspan="7" class="muted">Loading quiz attempts...</td></tr>
                </tbody>
              </table>
            </div>

            <!-- Quiz Attempts Stats -->
            <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div class="stat-card" style="background: var(--panel-bg); padding: 16px; border-radius: 12px; border: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div style="width: 40px; height: 40px; background: var(--stat-2-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <span style="color: var(--stat-2-color); font-size: 18px;">✓</span>
                  </div>
                  <div>
                    <div style="font-size: 20px; font-weight: bold; color: var(--ink);" id="completed-quizzes-count">0</div>
                    <div style="font-size: 12px; color: var(--muted);">Completed</div>
                  </div>
                </div>
              </div>
              
              <div class="stat-card" style="background: var(--panel-bg); padding: 16px; border-radius: 12px; border: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div style="width: 40px; height: 40px; background: var(--stat-3-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <span style="color: var(--stat-3-color); font-size: 18px;">⏳</span>
                  </div>
                  <div>
                    <div style="font-size: 20px; font-weight: bold; color: var(--ink);" id="in-progress-quizzes-count">0</div>
                    <div style="font-size: 12px; color: var(--muted);">In Progress</div>
                  </div>
                </div>
              </div>

              <div class="stat-card" style="background: var(--panel-bg); padding: 16px; border-radius: 12px; border: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div style="width: 40px; height: 40px; background: var(--stat-1-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <span style="color: var(--stat-1-color); font-size: 18px;">📊</span>
                  </div>
                  <div>
                    <div style="font-size: 20px; font-weight: bold; color: var(--ink);" id="average-quiz-score">0%</div>
                    <div style="font-size: 12px; color: var(--muted);">Average Score</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      
      <!-- Users Configuration View - Completely Redesigned -->
      <section class="view" id="view-users">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">User Management</h1>
              <button class="help-icon" onclick="showHelp('view-users')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn" id="btn-invite-user" style="background:linear-gradient(135deg, #4f89ff, #3f78ff);">📧 Invite User</button>
            </div>
          </div>

          <!-- User Management Table -->
          <div class="settings-section" style="margin-top:20px">
            <h3>Practice Users</h3>
            <div style="background:#e0f2fe; border:1px solid #38bdf8; border-radius:8px; padding:12px; margin-bottom:16px;">
              <p style="margin:0; color:#075985; font-size:14px;">
                <strong>ℹ️ How it works:</strong> Invite users with their details. They'll receive an email to set their password and complete onboarding.
              </p>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Job Role</th>
                    <th>Team</th>
                    <th>Status</th>
                    <th style="min-width:200px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="practice-users-tbody">
                  <tr><td colspan="6" class="muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Debug Console removed -->
        </div>

        <!-- Invite User Modal -->
        <div class="modal" id="invite-user-modal">
          <div class="modal-content" style="width:800px; max-height:90vh; overflow-y:auto;">
            <div class="modal-header" style="background:linear-gradient(135deg, #4f89ff, #3f78ff); color:white; padding:20px; border-radius:12px 12px 0 0;">
              <h3 style="margin:0; font-size:20px;">📧 Invite New User</h3>
              <button type="button" class="modal-close" id="invite-user-modal-close" style="color:white; font-size:24px;">&times;</button>
            </div>
            <form id="invite-user-form" style="padding:20px;">
              <!-- Basic Information -->
              <div style="background:#f8fafc; border-radius:12px; padding:16px; margin-bottom:20px;">
                <h4 style="margin-top:0; color:#3b82f6;">Basic Information</h4>
                <div class="field">
                  <label>Full Name *</label>
                  <input type="text" id="add-user-name" name="full_name" required placeholder="e.g., John Smith">
                </div>
                <div class="field">
                  <label>Email *</label>
                  <input type="email" id="add-user-email" name="email" required placeholder="e.g., john.smith@practice.nhs.uk">
                </div>
                <div class="field">
                  <label>Site Access Level *</label>
                  <select id="add-user-access" name="access" required>
                    <option value="">Select access level</option>
                    <option value="owner">Owner - Full system control</option>
                    <option value="admin">Admin - Can manage users and settings</option>
                    <option value="staff">Staff - Standard user access</option>
                  </select>
                </div>
              </div>

              <!-- Role and Team -->
              <div style="background:#f0f9ff; border-radius:12px; padding:16px; margin-bottom:20px;">
                <h4 style="margin-top:0; color:#3b82f6;">Role and Team</h4>
                <div class="field">
                  <label>Job Role *</label>
                  <select id="add-user-role" name="job_role" required>
                    <option value="">Select job role</option>
                    <option value="GP">GP (Doctor)</option>
                    <option value="Nurse">Nurse</option>
                    <option value="Practice Manager">Practice Manager</option>
                    <option value="Admin Assistant">Admin Assistant</option>
                    <option value="Receptionist">Receptionist</option>
                    <option value="Healthcare Assistant">Healthcare Assistant</option>
                    <option value="Pharmacist">Pharmacist</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="field">
                  <label>Team</label>
                  <select id="add-user-team" name="team">
                    <option value="">Select team (optional)</option>
                  </select>
                </div>
              </div>

              <!-- Status Messages -->
              <div class="error" id="add-user-error" style="display:none; padding:12px; border-radius:8px; background:#fee2e2; color:#991b1b; border:1px solid #fecaca;"></div>
              <div class="success" id="add-user-success" style="display:none; padding:12px; border-radius:8px; background:#dcfce7; color:#166534; border:1px solid #86efac;"></div>

              <!-- Action Buttons -->
              <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px; padding-top:20px; border-top:1px solid #e5e7eb;">
                <button type="button" class="btn secondary" id="invite-user-cancel-btn">Cancel</button>
                <button type="submit" class="btn" id="invite-user-submit" style="background:linear-gradient(135deg, #10b981, #059669);">📧 Send Invitation</button>
              </div>

              <!-- Debug Console -->
              <div id="invite-debug-console" style="display:none; margin-top:20px; padding:15px; background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <h4 style="margin:0; font-size:14px; font-weight:600;">🔍 Debug Console</h4>
                  <button type="button" id="copy-debug-log" class="btn" style="padding:4px 8px; font-size:12px; background:#6b7280;">📋 Copy Log</button>
                </div>

                <div id="debug-checklist" style="font-family:monospace; font-size:12px;">
                  <!-- Session Check -->
                  <div class="debug-step" data-step="session">
                    <span class="debug-icon">⏳</span>
                    <span class="debug-text">Check user session</span>
                    <div class="debug-detail" style="margin-left:20px; color:#666; display:none;"></div>
                  </div>

                  <!-- Form Data -->
                  <div class="debug-step" data-step="form">
                    <span class="debug-icon">⏳</span>
                    <span class="debug-text">Collect form data</span>
                    <div class="debug-detail" style="margin-left:20px; color:#666; display:none;"></div>
                  </div>

                  <!-- Supabase Connection -->
                  <div class="debug-step" data-step="connection">
                    <span class="debug-icon">⏳</span>
                    <span class="debug-text">Connect to Supabase API</span>
                    <div class="debug-detail" style="margin-left:20px; color:#666; display:none;"></div>
                  </div>

                  <!-- Site Invites Insert -->
                  <div class="debug-step" data-step="site_invites">
                    <span class="debug-icon">⏳</span>
                    <span class="debug-text">Insert to site_invites table</span>
                    <div class="debug-detail" style="margin-left:20px; color:#666; display:none;"></div>
                  </div>

                  <!-- Master Users Insert -->
                  <div class="debug-step" data-step="edge_function">
                    <span class="debug-icon">⏳</span>
                    <span class="debug-text">Call send-invitation Edge Function</span>
                    <div class="debug-detail" style="margin-left:20px; color:#666; display:none;"></div>
                  </div>

                  <!-- Send Email -->
                  <div class="debug-step" data-step="email">
                    <span class="debug-icon">⏳</span>
                    <span class="debug-text">Edge Function email response</span>
                    <div class="debug-detail" style="margin-left:20px; color:#666; display:none;"></div>
                  </div>

                  <!-- Complete -->
                  <div class="debug-step" data-step="complete">
                    <span class="debug-icon">⏳</span>
                    <span class="debug-text">Process complete</span>
                    <div class="debug-detail" style="margin-left:20px; color:#666; display:none;"></div>
                  </div>
                </div>

                <!-- Raw Log -->
                <details style="margin-top:15px;">
                  <summary style="cursor:pointer; font-size:12px; color:#666;">📝 Raw Debug Log</summary>
                  <pre id="debug-raw-log" style="margin-top:10px; padding:10px; background:#fff; border:1px solid #e5e7eb; border-radius:4px; font-size:11px; max-height:200px; overflow-y:auto; white-space:pre-wrap; word-wrap:break-word;"></pre>
                </details>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Fuzzy Match Holiday Import -->
      <section class="view" id="view-fuzzy-match">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Holiday Import</h1>
              <button class="help-icon" onclick="showHelp('view-fuzzy-match')" title="Help">?</button>
            </div>
            <button class="btn" onclick="downloadFuzzyTemplate()" style="background:linear-gradient(135deg, #667eea, #764ba2);">
              📥 Download Template
            </button>
          </div>

          <!-- Instructions -->
          <div class="panel" style="background: #f8fafc; padding: 20px; margin-bottom: 20px;">
            <h3 style="margin-top:0; color:#2d3748;">📋 How to Import Historical Holidays</h3>
            <ol style="color:#4a5568; line-height:1.8;">
              <li>Create and populate your own Excel file</li>
              <li>Fill in: Staff Name, Start Date, End Date, Reason (Hours/Sessions are optional)</li>
              <li>Upload the completed Excel file below</li>
              <li>Choose to either:
                <ul style="margin-top: 5px; list-style-type: disc; margin-left: 20px;">
                  <li>Enter hours/sessions manually in the preview table, or</li>
                  <li>Enter hours/sessions for each staff member (these will be used by default)</li>
                </ul>
              </li>
              <li>Review the data and click "Confirm Upload"</li>
              <li>Select the appropriate user from the dropdown and click "Match & Transfer" to assign holidays</li>
            </ol>
          </div>

          <!-- Statistics -->
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:16px; margin-bottom:20px;">
            <div class="panel" style="text-align:center; padding:16px;">
              <div style="font-size:28px; font-weight:700; color:#667eea;" id="fuzzy-stat-pending">0</div>
              <div style="color:#718096; font-size:12px;">Pending</div>
            </div>
            <div class="panel" style="text-align:center; padding:16px;">
              <div style="font-size:28px; font-weight:700; color:#10b981;" id="fuzzy-stat-matched">0</div>
              <div style="color:#718096; font-size:12px;">Matched</div>
            </div>
            <div class="panel" style="text-align:center; padding:16px;">
              <div style="font-size:28px; font-weight:700; color:#3b82f6;" id="fuzzy-stat-transferred">0</div>
              <div style="color:#718096; font-size:12px;">Transferred</div>
            </div>
            <div class="panel" style="text-align:center; padding:16px;">
              <div style="font-size:28px; font-weight:700; color:#6b7280;" id="fuzzy-stat-total">0</div>
              <div style="color:#718096; font-size:12px;">Total</div>
            </div>
          </div>

          <!-- Messages -->
          <div class="alert alert-error" id="fuzzy-error-message" style="display:none;"></div>
          <div class="alert alert-success" id="fuzzy-success-message" style="display:none;"></div>

          <!-- Upload Zone -->
          <div class="upload-zone" id="fuzzy-upload-zone" style="border:2px dashed #667eea; border-radius:12px; padding:40px; text-align:center; background:rgba(102,126,234,0.05); cursor:pointer; margin-bottom:20px;">
            <input type="file" id="fuzzy-file-input" accept=".xlsx,.xls" style="display:none;">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin:0 auto 16px; opacity:0.5;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <h3 style="margin:0 0 8px;">Upload Excel File</h3>
            <p style="color:#718096; margin:0;">Click to browse and select file</p>
          </div>

          <!-- Data Preview -->
          <div class="panel" id="fuzzy-data-preview" style="display:none; margin-bottom:20px;">
            <h3>Preview Data</h3>


            <div style="overflow-x:auto;">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Hours</th>
                    <th>Sessions</th>
                    <th>Reason</th>
                  </tr>
                </thead>
                <tbody id="fuzzy-preview-tbody">
                </tbody>
              </table>
            </div>
            <div id="calculation-progress" style="display:none; padding: 12px; background: #f8fafc; border-radius: 8px; margin-top: 12px;">
              <div style="color: #475569; font-size: 14px;">
                <span id="calc-status">Calculating hours/sessions...</span>
                <div style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; margin-top: 8px;">
                  <div id="calc-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 3px; transition: width 0.3s;"></div>
                </div>
              </div>
            </div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
              <button class="btn" onclick="confirmFuzzyUpload()" style="background:linear-gradient(135deg, #667eea, #764ba2);">Confirm Upload</button>
              <button class="btn secondary" onclick="cancelFuzzyUpload()">Cancel</button>
            </div>
          </div>

          <!-- Existing Records -->
          <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <div>
                <h3 style="margin:0;">Holiday Import Records</h3>
                <div id="fuzzy-match-info" style="font-size:12px; color:#718096; margin-top:4px;"></div>
              </div>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <select id="fuzzy-name-filter" onchange="filterFuzzyRecords()"
                  style="padding:8px 12px; border:1px solid #cbd5e0; border-radius:8px; width:200px;">
                  <option value="">All Names</option>
                </select>
                <select id="fuzzy-match-filter" onchange="filterFuzzyRecords()"
                  style="padding:8px 12px; border:1px solid #cbd5e0; border-radius:8px; width:150px;">
                  <option value="">All Records</option>
                  <option value="matched">Matched Only</option>
                  <option value="pending">Pending Only</option>
                  <option value="transferred">Transferred Only</option>
                </select>
                <button class="btn" onclick="autoMatchAllPending()"
                  style="background:linear-gradient(135deg, #10b981, #059669); padding:8px 16px;"
                  title="Automatically match and transfer all records where names match exactly">
                  🎯 Auto-Match All
                </button>
                <button class="btn" onclick="deleteSelectedFuzzyRecords()"
                  style="background:linear-gradient(135deg, #f97316, #dc2626); padding:8px 16px;"
                  title="Delete all selected pending records">
                  🗑️ Delete Selected
                </button>
                <button class="btn" onclick="matchSelectedRecords()"
                  style="background:linear-gradient(135deg, #667eea, #764ba2); padding:8px 16px;">
                  ✓ Match Selected
                </button>
                <label style="display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:linear-gradient(135deg, #4ade80, #22c55e); border-radius:8px; color:white; cursor:pointer; font-weight:500;">
                  <input type="checkbox" id="fuzzy-use-calculated" onchange="toggleCalculatedHours()"
                    style="width:18px; height:18px; cursor:pointer;">
                  <span>Use calculated hours?</span>
                </label>
              </div>
            </div>
            <div style="overflow-x:auto;">
              <table class="data-table">
                <thead>
                  <tr>
                    <th style="width:40px;">
                      <input type="checkbox" id="fuzzy-select-all" onclick="toggleAllCheckboxes()"
                        style="width:16px; height:16px; cursor:pointer;">
                    </th>
                    <th>Name</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Hours/Sessions</th>
                    <th>Status</th>
                    <th>Match to User</th>
                    <th>Uploaded</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="fuzzy-existing-tbody">
                  <tr>
                    <td colspan="9" style="text-align:center; color:#718096;">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Training Import Section -->
      <section class="view" id="view-training-import">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Training Import</h1>
              <button class="help-icon" onclick="showHelp('view-training-import')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <button class="btn" onclick="downloadTrainingTemplate()" style="background:linear-gradient(135deg, #667eea, #764ba2);">
                📥 Download Template
              </button>
              <button class="btn" onclick="downloadTrainingTypesList()" style="background:linear-gradient(135deg, #3b82f6, #2563eb);">
                📋 Training Types List
              </button>
            </div>
          </div>

          <!-- Instructions -->
          <div class="panel" style="background: #f8fafc; padding: 20px; margin-bottom: 20px;">
            <h3 style="margin-top:0; color:#2d3748;">📋 How to Import Training Records</h3>
            <ol style="color:#4a5568; line-height:1.8;">
              <li>Download the Excel template and Training Types list</li>
              <li>Fill in: Staff Name, Training Type (must match exactly from list), Completion Date</li>
              <li>Upload the completed Excel file below</li>
              <li>Review type matches and correct any mismatches</li>
              <li>Select users and click "Match & Transfer" to assign training</li>
            </ol>
            <div class="alert alert-info" style="margin-top:15px;">
              <strong>⚠️ Important:</strong> Training Type names must match exactly from the Training Types list.
              The system will attempt to match similar names, but exact matches work best.
            </div>
          </div>

          <!-- Statistics -->
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:16px; margin-bottom:20px;">
            <div class="panel" style="text-align:center; padding:16px;">
              <div style="font-size:28px; font-weight:700; color:#667eea;" id="training-stat-pending">0</div>
              <div style="color:#718096; font-size:12px;">Pending</div>
            </div>
            <div class="panel" style="text-align:center; padding:16px;">
              <div style="font-size:28px; font-weight:700; color:#10b981;" id="training-stat-matched">0</div>
              <div style="color:#718096; font-size:12px;">Matched</div>
            </div>
            <div class="panel" style="text-align:center; padding:16px;">
              <div style="font-size:28px; font-weight:700; color:#3b82f6;" id="training-stat-transferred">0</div>
              <div style="color:#718096; font-size:12px;">Transferred</div>
            </div>
            <div class="panel" style="text-align:center; padding:16px;">
              <div style="font-size:28px; font-weight:700; color:#ef4444;" id="training-stat-invalid">0</div>
              <div style="color:#718096; font-size:12px;">Invalid Types</div>
            </div>
            <div class="panel" style="text-align:center; padding:16px;">
              <div style="font-size:28px; font-weight:700; color:#6b7280;" id="training-stat-total">0</div>
              <div style="color:#718096; font-size:12px;">Total</div>
            </div>
          </div>

          <!-- Messages -->
          <div class="alert alert-error" id="training-error-message" style="display:none;"></div>
          <div class="alert alert-success" id="training-success-message" style="display:none;"></div>

          <!-- Upload Zone -->
          <div class="upload-zone" id="training-upload-zone" style="border:2px dashed #667eea; border-radius:12px; padding:40px; text-align:center; background:rgba(102,126,234,0.05); cursor:pointer; margin-bottom:20px;">
            <input type="file" id="training-file-input" accept=".xlsx,.xls" style="display:none;">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin:0 auto 16px; opacity:0.5;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <h3 style="margin:0 0 8px;">Upload Excel File</h3>
            <p style="color:#718096; margin:0;">Drag & drop or click to browse</p>
          </div>

          <!-- Data Preview -->
          <div class="panel" id="training-data-preview" style="display:none; margin-bottom:20px;">
            <h3>Preview Data</h3>
            <div style="overflow-x:auto;">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Training Type</th>
                    <th>Type Status</th>
                    <th>Completion Date</th>
                  </tr>
                </thead>
                <tbody id="training-preview-tbody">
                </tbody>
              </table>
            </div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
              <button class="btn" onclick="confirmTrainingUpload()" style="background:linear-gradient(135deg, #667eea, #764ba2);">Confirm Upload</button>
              <button class="btn secondary" onclick="cancelTrainingUpload()">Cancel</button>
            </div>
          </div>

          <!-- Existing Records -->
          <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
              <div>
                <h3 style="margin:0;">Training Import Records</h3>
                <div id="training-match-info" style="font-size:12px; color:#718096; margin-top:4px;"></div>
              </div>
              <div style="display:flex; gap:10px; align-items:center;">
                <input type="text" id="training-search" placeholder="Search by name..."
                  style="padding:8px 12px; border:1px solid #cbd5e0; border-radius:8px; width:200px;"
                  onkeyup="filterTrainingRecords()">
                <button class="btn" onclick="autoMatchAllTraining()"
                  style="background:linear-gradient(135deg, #10b981, #059669); padding:8px 16px;"
                  title="Automatically match and transfer all records where names and training types match">
                  🎯 Auto-Match All
                </button>
                <button class="btn" onclick="matchSelectedTraining()"
                  style="background:linear-gradient(135deg, #667eea, #764ba2); padding:8px 16px;">
                  ✓ Match Selected
                </button>
              </div>
            </div>
            <div style="overflow-x:auto;">
              <table class="data-table">
                <thead>
                  <tr>
                    <th style="width:40px;">
                      <input type="checkbox" id="training-select-all" onclick="toggleAllTrainingCheckboxes()"
                        style="width:16px; height:16px; cursor:pointer;">
                    </th>
                    <th>Name</th>
                    <th>Training Type</th>
                    <th>Match Training Type</th>
                    <th>Completion Date</th>
                    <th>Status</th>
                    <th>Match to User</th>
                    <th>Uploaded</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="training-existing-tbody">
                  <tr>
                    <td colspan="9" style="text-align:center; color:#718096;">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="view-pre-inspection">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">2-Week Notice Email</h1>
              <button class="help-icon" onclick="showHelp('view-pre-inspection')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <button class="btn secondary" id="pir-export">Generate Email Packages</button>
            </div>
          </div>
          
          <!-- Progress at a glance: dedicated full-width PIR panel -->
          <div class="pir-progress-panel">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
              <div style="font-weight:700;">Overall Progress</div>
              <button id="pir-progress-toggle" aria-expanded="true" title="Collapse/Expand" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; cursor: pointer; padding: 6px; color: #3b82f6; transition: all 0.2s ease; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">
                <svg style="width: 14px; height: 14px; transition: transform 0.2s ease;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="m6 9 6 6 6-6"/>
                </svg>
              </button>
            </div>
            <div class="pir-progress-main" id="pir-progress-main">
              <div class="pir-progress-stats">
                <div>
                  <div class="muted">Overall Progress (Ready Items)</div>
                  <div class="pir-progress-text" id="pir-progress-text">0 / 0 Ready (0%)</div>
                </div>
                <div style="text-align:right">
                  <div class="muted-small">Scaled: 0 — 66</div>
                  <div class="large" id="pir-progress-large">0 / 66</div>
                </div>
              </div>

              <div>
                <div class="progress-bar-container">
                  <div class="progress-milestones">
                    <div class="milestone quarter"></div>
                    <div class="milestone half"></div>
                    <div class="milestone three-quarter"></div>
                  </div>
                  <div class="progress-bar-bg">
                    <div class="progress-bar-fg" id="pir-progress-bar" style="width: 0%;"></div>
                  </div>
                </div>
              </div>

              <div style="margin-top:12px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                  <div style="font-weight:700;">Email package status</div>
                </div>
                <div class="email-status-circles" id="email-status-circles">
                  <!-- Email circles injected by JS -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Filter & sort pills -->
          <div class="pir-filters">
            <div class="pir-filter-pill active" data-filter="all">All</div>
            <div class="pir-filter-pill" data-filter="not-attached">Not Attached</div>
            <div class="pir-filter-pill" data-filter="ready">Ready</div>
            <div class="pir-filter-pill" data-filter="expiring-soon">Expiring Soon</div>
            <div class="pir-filter-pill" data-filter="outdated">Outdated</div>
            <div class="pir-filter-pill" data-filter="draft">Has Draft</div>
          </div>
          
          <div class="pir-layout">
            <!-- Sidebar TOC -->
            <div class="pir-toc">
              <div class="pir-toc-title">Categories</div>
              <div id="pir-toc-items">
                <div class="muted" style="padding: 20px; text-align: center; font-size: 12px;">Loading...</div>
              </div>
            </div>
            
            <!-- Main content -->
            <div class="pir-main">
              <div id="pir-docs-container"></div>
            </div>
          </div>
        </div>
        
        <!-- Bulk operations bar -->
        <div class="pir-bulk-bar" id="pir-bulk-bar">
          <div class="pir-bulk-count"><span id="pir-selected-count">0</span> items selected</div>
          <button class="btn secondary" id="pir-export-selected">Export Selected</button>
          <button class="btn secondary" id="pir-clear-selection">Clear Selection</button>
        </div>
        
        <!-- Preview Modal -->
        <div class="pir-preview-modal" id="pir-preview-modal">
          <div class="pir-preview-content">
            <div class="pir-preview-header">
              <h3 id="pir-preview-title">Document Preview</h3>
              <button class="pir-preview-close" id="pir-preview-close">Close</button>
            </div>
            <div class="pir-preview-body" id="pir-preview-body">
              <div style="padding: 40px; text-align: center; color: var(--muted);">Loading preview...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Training Management View -->
      <section class="view" id="view-training">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <div class="h1 page-title" style="margin:0">Mandatory Training</div>
              <button class="help-icon" onclick="showHelp('view-training')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <button class="btn secondary" id="btn-manage-training-types">Manage Training Types</button>
              <button class="btn" id="btn-export-training">Export Report</button>
            </div>
          </div>
          
          <div class="tab-controls" style="margin-bottom: 24px; display:flex; gap:8px;">
            <button class="btn secondary active" id="tab-clinical" data-tab="clinical">Clinical Staff</button>
            <button class="btn secondary" id="tab-non-clinical" data-tab="non-clinical">Non-Clinical Staff</button>
          </div>

          <div class="training-matrix" id="training-matrix-container">
            <table id="training-matrix-table">
              <thead>
                <tr id="training-headers">
                  <th>Staff Member</th>
                </tr>
              </thead>
              <tbody id="training-tbody">
                <tr><td colspan="100%" class="muted">Loading training matrix...</td></tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top: 16px; display: flex; gap: 20px; font-size: 12px; color: var(--muted);">
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-2-bg); border-radius: 2px;"></div>
              <span>Completed & Valid</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-3-bg); border-radius: 2px;"></div>
              <span>Expiring Soon (30 days)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-4-bg); border-radius: 2px;"></div>
              <span>Expired</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--glass); border-radius: 2px;"></div>
              <span>No Record</span>
            </div>
          </div>
        </div>
        
        <!-- Training Edit Modal -->
        <div id="training-edit-modal" class="modal" style="display: none;">
          <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
              <h3>Edit Training Record</h3>
              <button class="close-btn" onclick="closeTrainingModal()">&times;</button>
            </div>
            <div class="modal-body">
              <form id="training-edit-form" onsubmit="saveTrainingRecord(event); return false;">
                <div class="form-group">
                  <label>Staff Member</label>
                  <input type="text" id="training-edit-staff-name" readonly style="background: var(--panel-bg); color: var(--muted);">
                  <input type="hidden" id="training-edit-staff-id">
                </div>
                <div class="form-group">
                  <label>Training Module</label>
                  <input type="text" id="training-edit-type-name" readonly style="background: var(--panel-bg); color: var(--muted);">
                  <input type="hidden" id="training-edit-type-id">
                </div>
                <div class="form-group">
                  <label>Completion Date</label>
                  <input type="date" id="training-edit-completion" required>
                </div>
                <div class="form-group">
                  <label>Expiry Date</label>
                  <input type="date" id="training-edit-expiry">
                </div>
                <div class="form-group">
                  <label>Provider</label>
                  <input type="text" id="training-edit-provider" placeholder="Training provider name">
                </div>
                <div class="form-group">
                  <label>Notes</label>
                  <textarea id="training-edit-notes" rows="3" placeholder="Additional notes"></textarea>
                </div>
              </form>
              <div id="training-edit-error" style="color: red; margin-top: 10px; display: none;"></div>
            </div>
            <div class="modal-footer">
              <button class="btn secondary" onclick="closeTrainingModal()">Cancel</button>
              <button class="btn primary" onclick="saveTrainingRecord(event)">Save Changes</button>
            </div>
          </div>
        </div>
        
        <!-- Training Cell Drawer -->
        <div id="cell-drawer" class="drawer" style="position: fixed; right: -400px; top: 0; width: 400px; height: 100%; background: var(--panel-bg); box-shadow: -2px 0 10px rgba(0,0,0,0.3); transition: right 0.3s ease; z-index: 1000; overflow-y: auto;">
          <div style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0;">Training Record Details</h3>
              <button onclick="document.getElementById('cell-drawer').classList.remove('open')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);">&times;</button>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; color: var(--muted); font-size: 12px;">Staff Member</label>
              <div id="drawer-staff-name" style="font-size: 16px; margin-top: 4px;">-</div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; color: var(--muted); font-size: 12px;">Training Module</label>
              <div id="drawer-module-name" style="font-size: 16px; margin-top: 4px;">-</div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; color: var(--muted); font-size: 12px;">Status</label>
              <div id="drawer-status" style="font-size: 16px; margin-top: 4px;">-</div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; color: var(--muted); font-size: 12px;">Issue Date</label>
              <div id="drawer-issue-date" style="font-size: 16px; margin-top: 4px;">-</div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; color: var(--muted); font-size: 12px;">Expiry Date</label>
              <div id="drawer-expiry-date" style="font-size: 16px; margin-top: 4px;">-</div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; color: var(--muted); font-size: 12px;">Provider</label>
              <div id="drawer-provider" style="font-size: 16px; margin-top: 4px;">-</div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; color: var(--muted); font-size: 12px;">Evidence</label>
              <div id="drawer-evidence" style="font-size: 16px; margin-top: 4px;">-</div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; color: var(--muted); font-size: 12px;">Notes</label>
              <div id="drawer-notes" style="font-size: 16px; margin-top: 4px;">-</div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600; color: var(--muted); font-size: 12px;">Verified</label>
              <div id="drawer-verified" style="font-size: 16px; margin-top: 4px;">-</div>
            </div>
            
            <div style="margin-top: 24px; display: flex; gap: 10px;">
              <button class="btn" onclick="editTrainingRecord()">Edit Record</button>
              <button class="btn secondary" onclick="document.getElementById('cell-drawer').classList.remove('open')">Close</button>
            </div>
          </div>
        </div>
        
        <style>
          #cell-drawer.open {
            right: 0 !important;
          }
        </style>
      </section>

      <section class="view" id="view-calendar">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <div id="cal-month-year" class="panel-title page-title">Loading...</div>
              <button class="help-icon" onclick="showHelp('view-calendar')" title="Help">?</button>
            </div>
            <div id="cal-header" style="display:flex; gap:8px;">
              <button id="cal-prev" class="btn secondary">‹ Prev</button>
              <button id="cal-next" class="btn secondary">Next ›</button>
            </div>
          </div>
          
          <div class="cal-legend" id="cal-legend">
            <div class="item"><span class="dot scheduled" aria-hidden="true"></span> Scheduled</div>
            <div class="item"><span class="dot done" aria-hidden="true"></span> Done</div>
            <div class="item"><span class="dot missed" aria-hidden="true"></span> Missed</div>
            <div class="item" style="margin-left:auto;">Frequency: <span class="freq-badge" style="margin-left:8px;">D</span> Daily <span class="freq-badge" style="margin-left:8px; margin-left:12px;">W</span> Weekly <span class="freq-badge" style="margin-left:8px; margin-left:12px;">M</span> Monthly</div>
          </div>

          <div id="cal-weekdays" style="display:grid; grid-template-columns: repeat(5, 1fr); text-align:center; margin-bottom:8px; font-weight:600; color:var(--muted); font-size:12px;">
            <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div>
          </div>
          <div id="cal-grid" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:6px; min-height: 500px;">
          </div>
          <div id="cal-compliance-view" style="display: none;"></div>
        </div>
      </section>

      <section class="view" id="view-items">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Equipment & Asset Management</h1>
              <button class="help-icon" onclick="showHelp('view-items')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-item">Add Item</button>
          </div>
          <div class="table-wrap" style="margin-top:10px"><table>
            <thead><tr><th class="sortable" data-col="item_id">Code <span class="arrow" id="sort-item_id"></span></th><th class="sortable" data-col="item_name">Name <span class="arrow" id="sort-item_name"></span></th><th class="sortable" data-col="room_name">Room <span class="arrow" id="sort-room_name"></span></th><th class="sortable" data-col="default_check_type_name">Default Check <span class="arrow" id="sort-default_check_type_name"></span></th><th class="sortable" data-col="active">Active <span class="arrow" id="sort-active"></span></th></tr></thead>
            <tbody id="items-tbody" data-entity="items"><tr><td colspan="5" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-rooms">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Room & Location Management</h1>
              <button class="help-icon" onclick="showHelp('view-rooms')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-room">Add Room</button>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>Name</th><th>Owner</th></tr></thead>
            <tbody id="rooms-tbody" data-entity="rooms"><tr><td colspan="2" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

          <!-- Complaints Dashboard view -->
          <section class="view" id="view-complaints-dashboard">
            <div class="panel">
              <div class="page-header">
                <div class="page-title-wrapper">
                  <h2 class="page-title" style="margin:0; color: var(--white); font-size: 28px; font-weight: 700;">Complaints Dashboard</h2>
                  <button class="help-icon" onclick="showHelp('view-complaints-dashboard')" title="Help">?</button>
                </div>
                <button class="btn" onclick="setActiveSection('complaints-reporting')" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                  📊 View All Complaints
                </button>
              </div>

              <!-- Key Metrics -->
              <div class="grid" style="margin-bottom: 24px;">
                <div class="g-3">
                  <div class="stat-card" style="--c: var(--stat-1-bg); --i: var(--stat-1-color);">
                    <div class="icon-wrap">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                      </svg>
                    </div>
                    <div>
                      <div class="stat-num" id="total-complaints">0</div>
                      <div class="stat-label">Total Complaints</div>
                    </div>
                  </div>
                </div>
                <div class="g-3">
                  <div class="stat-card" style="--c: var(--stat-3-bg); --i: var(--stat-3-color);">
                    <div class="icon-wrap">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 7 12 12 16 14"></polyline>
                      </svg>
                    </div>
                    <div>
                      <div class="stat-num" id="pending-complaints">0</div>
                      <div class="stat-label">Pending</div>
                    </div>
                  </div>
                </div>
                <div class="g-3">
                  <div class="stat-card" style="--c: var(--stat-2-bg); --i: var(--stat-2-color);">
                    <div class="icon-wrap">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                    </div>
                    <div>
                      <div class="stat-num" id="resolved-complaints">0</div>
                      <div class="stat-label">Resolved</div>
                    </div>
                  </div>
                </div>
                <div class="g-3">
                  <div class="stat-card" style="--c: var(--stat-4-bg); --i: var(--stat-4-color);">
                    <div class="icon-wrap">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <path d="M16 10a4 4 0 01-8 0"></path>
                      </svg>
                    </div>
                    <div>
                      <div class="stat-num" id="avg-response-time">0</div>
                      <div class="stat-label">Avg Response (days)</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Recent Complaints -->
              <div class="panel-header">
                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Recent Complaints</h3>
              </div>
              <div class="table-wrap" style="max-height: 400px;">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Patient Initials</th>
                      <th>Category</th>
                      <th>Status</th>
                      <th>Priority</th>
                    </tr>
                  </thead>
                  <tbody id="recent-complaints-tbody">
                    <tr><td colspan="5" class="muted">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>
          <!-- Complaints Reporting view (list, filter, export, add, amend) -->
          <section class="view" id="view-complaints-reporting">
            <div class="panel">
              <div class="page-header">
                <div class="page-title-wrapper">
                  <h1 class="page-title">Complaints Reporting</h1>
                  <button class="help-icon" onclick="showHelp('view-complaints-reporting')" title="Help">?</button>
                </div>
                <div style="display:flex; gap:10px;">
                  <button class="btn secondary" id="complaints-export">Export</button>
                  <button class="btn" id="btn-new-complaint">Add Complaint</button>
                </div>
              </div>

              <!-- Enhanced Filters -->
              <div style="background: linear-gradient(145deg, #f8fafc, #edf2f7); border-radius: 16px; padding: 20px; margin-bottom: 24px; border: 1px solid #e2e8f0;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                  <svg style="width: 20px; height: 20px; color: #4a90e2;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                  </svg>
                  <h3 style="margin: 0; color: #2d3748; font-size: 16px; font-weight: 600;">Filter Complaints</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px;">
                  <!-- Year Filter -->
                  <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0;">
                    <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; font-size: 13px;">
                      📅 Year
                    </label>
                    <select id="complaints-filter-year" class="ui-select" style="width: 100%;">
                      <option value="">All Years</option>
                      <option value="2025">2025</option>
                      <option value="2024">2024</option>
                      <option value="2023">2023</option>
                      <option value="2022">2022</option>
                      <option value="2021">2021</option>
                    </select>
                    <div style="font-size: 11px; color: #718096; margin-top: 4px;">Filter complaints by year</div>
                  </div>

                  <!-- Category Filter -->
                  <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0;">
                    <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; font-size: 13px;">
                      🏷️ Category
                    </label>
                    <select id="complaints-filter-category" class="ui-select" style="width: 100%;">
                      <option value="">All Categories</option>
                    </select>
                    <div style="font-size: 11px; color: #718096; margin-top: 4px;">Filter by complaint category</div>
                  </div>

                  <!-- Status Filter -->
                  <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0;">
                    <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; font-size: 13px;">
                      ⚡ Status
                    </label>
                    <select id="complaints-filter-status" class="ui-select" style="width: 100%;">
                      <option value="">All Statuses</option>
                      <option value="open">🔴 Open</option>
                      <option value="resolved">✅ Resolved</option>
                    </select>
                    <div style="font-size: 11px; color: #718096; margin-top: 4px;">Filter by resolution status</div>
                  </div>

                  <!-- Search Filter -->
                  <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0;">
                    <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; font-size: 13px;">
                      🔍 Search
                    </label>
                    <input id="complaints-search" class="ui-select" placeholder="Search complaints, patient initials..." style="width: 100%;">
                    <div style="font-size: 11px; color: #718096; margin-top: 4px;">Search in complaint details or patient info</div>
                  </div>
                </div>

                <!-- Filter Actions -->
                <div style="display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end;">
                  <button class="btn secondary" style="font-size: 12px; padding: 6px 12px;" onclick="clearComplaintsFilters()">
                    Clear All
                  </button>
                  <button class="btn" style="font-size: 12px; padding: 6px 12px; background: #4a90e2;" onclick="applyComplaintsFilters()">
                    Apply Filters
                  </button>
                </div>
              </div>

              <!-- Enhanced Complaints table -->
              <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 16px;">
                  <h3 style="margin: 0; color: white; font-size: 16px; font-weight: 600;">📋 All Complaints</h3>
                </div>
                
                <div class="table-wrap" style="max-height: 600px; overflow-y: auto;">
                  <table style="margin: 0;">
                    <thead style="position: sticky; top: 0; z-index: 10; background: #f8fafc;">
                      <tr>
                        <th style="width:36px; background: #f8fafc;"><input type="checkbox" id="cmp-select-all" aria-label="Select all"></th>
                        <th style="background: #f8fafc; font-weight: 600; color: #2d3748;">📅 Datetime</th>
                        <th style="background: #f8fafc; font-weight: 600; color: #2d3748;">👤 Patient</th>
                        <th style="background: #f8fafc; font-weight: 600; color: #2d3748;">🏷️ Category</th>
                        <th style="background: #f8fafc; font-weight: 600; color: #2d3748;">📝 Original complaint</th>
                        <th style="background: #f8fafc; font-weight: 600; color: #2d3748;">💬 Response</th>
                        <th style="background: #f8fafc; font-weight: 600; color: #2d3748;">🎯 Lessons learned</th>
                        <th style="background: #f8fafc; font-weight: 600; color: #2d3748;">⚡ Status</th>
                        <th style="background: #f8fafc; font-weight: 600; color: #2d3748;">🔗 Share</th>
                        <th style="background: #f8fafc; font-weight: 600; color: #2d3748;">👨‍💼 Created by</th>
                        <th style="background: #f8fafc; font-weight: 600; color: #2d3748;">✅ Resolved at</th>
                        <th style="width:140px; background: #f8fafc; font-weight: 600; color: #2d3748;">⚙️ Actions</th>
                      </tr>
                    </thead>
                    <tbody id="complaints-tbody" data-entity="complaints">
                      <tr><td colspan="12" class="muted" style="text-align: center; padding: 40px;">🔄 Loading complaints...</td></tr>
                    </tbody>
                  </table>
                </div>

                <!-- Complaints Summary Stats -->
                <div style="background: #f8fafc; padding: 16px; border-top: 1px solid #e2e8f0;">
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; text-align: center;">
                    <div>
                      <div style="font-size: 20px; font-weight: bold; color: #e53e3e;" id="total-complaints-count">0</div>
                      <div style="font-size: 12px; color: #718096;">Total</div>
                    </div>
                    <div>
                      <div style="font-size: 20px; font-weight: bold; color: #d69e2e;" id="open-complaints-count">0</div>
                      <div style="font-size: 12px; color: #718096;">Open</div>
                    </div>
                    <div>
                      <div style="font-size: 20px; font-weight: bold; color: #38a169;" id="resolved-complaints-count">0</div>
                      <div style="font-size: 12px; color: #718096;">Resolved</div>
                    </div>
                    <div>
                      <div style="font-size: 20px; font-weight: bold; color: #3182ce;" id="avg-resolution-days">0</div>
                      <div style="font-size: 12px; color: #718096;">Avg Days</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

      <section class="view" id="view-checktypes">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Check Type Configuration</h1>
              <button class="help-icon" onclick="showHelp('view-checktypes')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-ct">Add Check Type</button>
          </div>
          <div class="table-wrap" style="margin-top:10px"><table>
            <thead><tr><th>Name</th><th>Active</th></tr></thead>
            <tbody id="ct-tbody" data-entity="check_types"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-schedules">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Compliance Schedules</h1>
              <button class="help-icon" onclick="showHelp('view-schedules')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-sched">Add Schedule</button>
          </div>

          <!-- Schedules Filters -->
          <div style="display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap">
            <select id="schedules-filter-room" class="ui-select" style="min-width:140px;">
              <option value="">All Rooms</option>
            </select>
            <select id="schedules-filter-check" class="ui-select" style="min-width:160px;">
              <option value="">All Check Types</option>
            </select>
            <select id="schedules-filter-frequency" class="ui-select" style="min-width:120px;">
              <option value="">All Frequencies</option>
            </select>
            <select id="schedules-filter-required" class="ui-select" style="min-width:100px;">
              <option value="">All</option>
              <option value="true">Required</option>
              <option value="false">Optional</option>
            </select>
            <input id="schedules-search" class="ui-select" placeholder="Search items..." style="flex:1; min-width:160px;">
          </div>

          <div class="table-wrap"><table>
            <thead><tr><th>Item</th><th>Room</th><th>Check</th><th>Frequency</th><th>Day</th><th>Required</th></tr></thead>
            <tbody id="sched-tbody" data-entity="item_allowed_types"><tr><td colspan="6" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-staff">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Staff Working Schedules</h1>
              <button class="help-icon" onclick="showHelp('view-staff')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <button class="btn secondary" onclick="refreshStaffData()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                  <path d="M21 3v5h-5"></path>
                  <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                  <path d="M3 21v-5h5"></path>
                </svg>
                Refresh
              </button>
            </div>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>Name</th><th>Role Detail</th><th>Team</th><th>Schedule</th></tr></thead>
            <tbody id="staff-tbody" data-entity="staff_app_welcome"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-submissions">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Compliance Submissions</h1>
              <button class="help-icon" onclick="showHelp('view-submissions')" title="Help">?</button>
            </div>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>When</th><th>Staff</th><th>Rows</th><th>Comment</th></tr></thead>
            <tbody id="subs-tbody"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-settings">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">System Settings</h1>
              <button class="help-icon" onclick="showHelp('view-settings')" title="Help">?</button>
            </div>
          </div>
      
      
              <h3>Page Visibility</h3>
              
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-1" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Dashboard</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-2" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Pre-inspection</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-4" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Calendar</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-5" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Schedules</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-6" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Submissions</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-7" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Items</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-8" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Rooms</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-9" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Check Types</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-10" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Staff</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-11" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Complaints</span>
                  </label>
                </div>
              </div>
              
              <div style="margin-top: 20px; text-align: center;">
                <!-- Save button removed per request -->
                <button type="button" class="btn secondary" id="debug-page-visibility" style="padding: 8px 16px; font-size: 14px;" onclick="testDebugFunction()">
                  Save
                </button>
                <br>
                <!-- Read-only textbox showing enabled toggles as an array/string -->
                <input type="text" id="debug-enabled-toggles" readonly placeholder="[]" style="display:none; width:100%; margin-top:8px; font-family:monospace; padding:8px; box-sizing:border-box;" />
                <!-- Editable box for entering a custom array (not wired to any logic yet) -->
                <textarea id="debug-custom-array" placeholder='["one","two"]' style="display:none; width:100%; margin-top:8px; font-family:monospace; padding:8px; box-sizing:border-box; min-height:48px;" ></textarea>
              </div>

              <!-- Feature Settings Section -->
              <div class="settings-section" style="margin-top:40px; padding:20px; background:var(--glass); border-radius:12px; border:1px solid var(--border-color);">
                <h3 style="margin-top:0; margin-bottom:20px; color:var(--white); font-size:18px;">Feature Settings</h3>
                <p style="color:var(--muted); margin-bottom:20px; font-size:14px;">Enable or disable features for all users in your organization</p>
                <!-- Scoped styles for clear toggle switches -->
                <style>
                  .cl-switch { display:inline-flex; align-items:center; gap:10px; cursor:pointer; user-select:none; }
                  .cl-switch input { position:absolute; opacity:0; width:0; height:0; }
                  .cl-switch-track { width:52px; height:28px; border-radius:999px; background:rgba(148,163,184,0.25); border:1px solid var(--border-color, #334155); position:relative; transition:background .2s, border-color .2s; box-shadow: inset 0 0 0 1px rgba(0,0,0,.06); }
                  .cl-switch-track::after { content:""; width:22px; height:22px; background:#fff; border-radius:50%; position:absolute; top:3px; left:3px; transition:transform .2s; box-shadow:0 1px 2px rgba(0,0,0,.25); }
                  .cl-switch input:checked + .cl-switch-track { background:#10b981; border-color:#10b981; }
                  .cl-switch input:checked + .cl-switch-track::after { transform: translateX(24px); }
                  .cl-switch-text { font-size:12px; color:var(--muted, #94a3b8); min-width:28px; }
                  .cl-switch input:checked ~ .cl-switch-text { color:#10b981; }
                </style>

                <div style="display:flex; flex-direction:column; gap:20px;">
                  <!-- Enable Achievements -->
                  <div class="field" style="display:flex; align-items:center; justify-content:space-between; padding:16px; background:var(--glass-2); border-radius:8px; border:1px solid var(--border-color);">
                    <div style="flex:1;">
                      <label for="enable-achievements" style="display:flex; align-items:center; gap:12px; cursor:pointer;">
                        <span style="font-size:24px;">🏆</span>
                        <div>
                          <div style="color:var(--white); font-weight:600; font-size:15px;">Enable Achievements</div>
                          <div style="color:var(--muted); font-size:13px; margin-top:2px;">Staff can earn achievements and view the achievements page</div>
                        </div>
                      </label>
                    </div>
                    <div>
                      <label class="cl-switch" aria-label="Enable Achievements">
                        <input type="checkbox" id="enable-achievements" onchange="updateSiteSettings()">
                        <span class="cl-switch-track" aria-hidden="true"></span>
                        <span class="cl-switch-text" data-off="Off" data-on="On">Off</span>
                      </label>
                    </div>
                  </div>

                  <!-- Enable Avatars -->
                  <div class="field" style="display:flex; align-items:center; justify-content:space-between; padding:16px; background:var(--glass-2); border-radius:8px; border:1px solid var(--border-color);">
                    <div style="flex:1;">
                      <label for="enable-avatars" style="display:flex; align-items:center; gap:12px; cursor:pointer;">
                        <span style="font-size:24px;">👤</span>
                        <div>
                          <div style="color:var(--white); font-weight:600; font-size:15px;">Enable Avatars</div>
                          <div style="color:var(--muted); font-size:13px; margin-top:2px;">Users can create custom avatars. When disabled, initials are shown instead</div>
                        </div>
                      </label>
                    </div>
                    <div>
                      <label class="cl-switch" aria-label="Enable Avatars">
                        <input type="checkbox" id="enable-avatars" onchange="updateSiteSettings()">
                        <span class="cl-switch-track" aria-hidden="true"></span>
                        <span class="cl-switch-text" data-off="Off" data-on="On">Off</span>
                      </label>
                    </div>
                  </div>
                </div>

                <div id="feature-settings-status" style="margin-top:16px; padding:12px; border-radius:6px; display:none;">
                  <!-- Status message will appear here -->
                </div>
              </div>

              <!-- Debug Settings Section -->
              <div class="settings-section" style="margin-top:20px">

              </div>
            </div>
      </section>

      <!-- Working Hours Section -->
      <section class="view" id="working-hours">
        <div class="page-header">
          <div class="page-title-wrapper">
            <h1 class="page-title">Staff Working Hours Management</h1>
          </div>
        </div>

        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Manage Working Patterns & Holiday Entitlements</h3>
            <button class="btn" id="refresh-working-hours" onclick="loadWorkingHours()">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M4 4v6h6M20 20v-6h-6M4 10l2.5-2.5C8 6 10.5 5 13 5s5 1 6.5 2.5L22 10M2 14l2.5 2.5C6 18 8.5 19 11 19s5-1 6.5-2.5L20 14"/>
              </svg>
              Refresh Data
            </button>
          </div>

          <div id="working-hours-loading" style="text-align: center; padding: 40px; display: none;">
            <div style="font-size: 16px; color: var(--muted);">Loading staff working hours...</div>
          </div>

          <div id="working-hours-table-container">
            <!-- Working hours table will be loaded here -->
          </div>
        </div>
      </section>

      <!-- Entitlement Management Section -->
      <section class="view" id="entitlement-management">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Entitlement Management</h1>
              <p style="color: var(--muted); margin-top: 8px;">Manage staff working patterns, holiday entitlements and requests</p>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn" id="refresh-entitlements" onclick="loadStaffEntitlementCards()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M4 4v6h6M20 20v-6h-6M4 10l2.5-2.5C8 6 10.5 5 13 5s5 1 6.5 2.5L22 10M2 14l2.5 2.5C6 18 8.5 19 11 19s5-1 6.5-2.5L20 14"/>
                </svg>
                Refresh Data
              </button>
            </div>
          </div>

          <!-- Staff Entitlement Card Layout -->
          <div id="entitlements-filter-container">
            <!-- Filter controls will be loaded here -->
          </div>

          <div id="entitlements-cards-container" style="margin-top: 20px;">
            <!-- Staff cards will be loaded here -->
          </div>

          <!-- Holiday Settings Section -->
          <div style="margin-top: 40px; padding: 24px; background: var(--glass); border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div class="panel-header" style="margin-bottom: 20px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              <h3 class="panel-title">Holiday Settings</h3>
            </div>

            <div class="form-group">
              <label for="default-multiplier" style="display:block; margin-bottom:12px; font-weight:500; color: var(--white);">Default Holiday Multiplier</label>
              <div style="display:flex; align-items:center; gap:12px;">
                <input type="number" id="default-multiplier" value="10" min="1" max="52" style="width:100px; padding:10px 14px; border-radius:10px; background:var(--glass); border:1px solid var(--border-color); color: var(--white);">
                <button id="save-multiplier" class="btn" style="white-space:nowrap; padding: 10px 16px; font-weight: 600;">Save Default</button>
                <span id="multiplier-saved-msg" style="color:var(--success); display:none; font-weight: 500;">Saved!</span>
              </div>
              <p style="color: var(--muted); font-size: 14px; margin-top: 12px; margin-bottom: 0;">This multiplier is applied to all staff to calculate their annual holiday entitlement</p>
            </div>
          </div>
  <script>
    // --- Holiday Multiplier Persistence ---
    document.addEventListener('DOMContentLoaded', function() {
      // Load saved multiplier from localStorage if present
      const saved = localStorage.getItem('default-holiday-multiplier');
      if (saved && !isNaN(saved)) {
        document.getElementById('default-multiplier').value = saved;
      }
      // Save multiplier on button click
      const btn = document.getElementById('save-multiplier');
      if (btn) {
        btn.addEventListener('click', async function() {
          const val = parseFloat(document.getElementById('default-multiplier').value);
          if (!isNaN(val) && val > 0) {
            // Save to localStorage
            localStorage.setItem('default-holiday-multiplier', val);

            // Update all rows in 2_staff_entitlements table
            if (window.supabase) {
              try {
                const { error } = await window.supabase
                  .from('2_staff_entitlements')
                  .update({ multiplier: val })
                  .not('id', 'is', null); // Update all rows

                if (error) {
                  console.error('Error updating multipliers:', error);
                  alert('Error updating multipliers: ' + error.message);
                } else {
                  const msg = document.getElementById('multiplier-saved-msg');
                  if (msg) {
                    msg.textContent = 'Saved and applied to all staff!';
                    msg.style.display = 'inline';
                    setTimeout(()=>{
                      msg.style.display='none';
                      msg.textContent = 'Saved!';
                    }, 2000);
                  }

                  // Reload entitlements if currently viewing that section
                  if (typeof loadHolidayEntitlements === 'function') {
                    loadHolidayEntitlements();
                  }
                }
              } catch (err) {
                console.error('Error applying multiplier:', err);
                alert('Error applying multiplier to all staff');
              }
            } else {
              // If no Supabase connection, just save locally
              const msg = document.getElementById('multiplier-saved-msg');
              if (msg) { msg.style.display = 'inline'; setTimeout(()=>{msg.style.display='none';}, 1200); }
            }
          }
        });
      }
    });
  </script>

          <!-- Holiday Requests Section -->
          <div style="margin-top: 40px; padding: 24px; background: var(--glass); border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div class="panel-header" style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                <h3 class="panel-title">Holiday Requests</h3>
              </div>
              <button class="btn secondary" style="padding: 6px 12px; font-size: 12px; background: var(--warning); color: #000;" onclick="window.fixHolidayRequestRLS()" title="Fix database permissions if approval buttons are not working">
                Fix Permissions
              </button>
            </div>

            <div id="requests-list">
              <!-- Requests will be loaded here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Scheduling Dashboard Section -->
      <section class="view" id="scheduling-dashboard">
        <h2>Scheduling Dashboard</h2>
        <div class="card">
          <h3>Schedule Overview</h3>
          <p>View and manage all scheduling activities.</p>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- Admin Navigation/Page Visibility Fix ---
    document.addEventListener('DOMContentLoaded', function() {
      // If user is admin/owner, always show all admin nav/pages
      try {
        const userRole = (window.currentUserRole || window.ctx?.userRole || window.ctx?.role || '').toLowerCase();
        if (userRole === 'admin' || userRole === 'owner') {
          // Unhide all nav groups and sections
          document.querySelectorAll('.nav-group, .view, .panel, .card').forEach(el => {
            el.style.display = '';
          });
        }
      } catch(e) { /* ignore */ }
    });
    // Keep the debug-enabled-toggles input in sync with the page visibility checkboxes
    (function(){
      function getToggleMap(){
        return {
          'page-toggle-1': 'dashboard',
          'page-toggle-2': 'pre-inspection',
          'page-toggle-4': 'calendar',
          'page-toggle-5': 'schedules',
          'page-toggle-6': 'submissions',
          'page-toggle-7': 'items',
          'page-toggle-8': 'rooms',
          'page-toggle-9': 'checks',
          'page-toggle-10': 'staff',
          'page-toggle-11': 'complaints'
        };
      }

      function updateDebugEnabledToggles(){
        const input = document.getElementById('debug-enabled-toggles');
        if(!input) return;
        const map = getToggleMap();
        const enabled = [];
        Object.keys(map).forEach(id => {
          const el = document.getElementById(id);
          if(el && el.checked) enabled.push(map[id]);
        });
        input.value = JSON.stringify(enabled);
      }

      // Wire change listeners to toggles when they exist
      function wireToggleListeners(){
        const els = document.querySelectorAll('[id^="page-toggle-"]');
        els.forEach(el => {
          el.removeEventListener('change', updateDebugEnabledToggles);
          el.addEventListener('change', updateDebugEnabledToggles);
        });
      }

      // Expose for manual calls
      window.updateDebugEnabledToggles = updateDebugEnabledToggles;

      // Attempt to wire now and again after DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        wireToggleListeners();
        updateDebugEnabledToggles();
      });

      // If settings are initialized later, ensure we wire again
      // (initPageVisibilityToggles calls loadPagePermissions which sets toggles)
      const origInit = window.initPageVisibilityToggles;
      if(typeof origInit === 'function'){
        window.initPageVisibilityToggles = function(){
          const res = origInit.apply(this, arguments);
          // small delay to allow loadPagePermissions to set toggle states
          setTimeout(() => { wireToggleListeners(); updateDebugEnabledToggles(); }, 200);
          return res;
        };
      }
    })();
  </script>

  <script>
    (function(){
      function setQuizLinkSite(){
        var link = document.getElementById('btn-open-quiz');
        if(!link) return;
        try{
          var siteId = (window.ctx && (ctx.site_id || ctx.siteId)) ? (ctx.site_id || ctx.siteId) : null;
          if(!siteId) return;
          var u = new URL(link.getAttribute('href'), location.href);
          u.searchParams.set('site', siteId);
          link.setAttribute('href', u.pathname + u.search);
        }catch(e){}
      }
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', setQuizLinkSite);
      }else{
        setQuizLinkSite();
      }
    })();
  </script>


  <div id="day-modal" aria-hidden="true">
    <div class="day-modal-card">
      <button class="day-modal-close" id="day-modal-close" aria-label="Close">✕</button>
      <h2 class="day-modal-title">Details</h2>
      <div class="day-modal-body">Loading…</div>
    </div>
  </div>
  <div id="branding-modal" aria-hidden="true">
    <div class="branding-card">
      <button class="branding-close" id="branding-close" aria-label="Close">✕</button>
      <h2 style="margin:0 0 6px">Branding</h2>
      <div class="hint-mini">Upload a practice logo and a signature image. PNG with transparent background is ideal.</div>
      <form id="branding-form">
        <div class="branding-row">
          <div>
            <div class="muted" style="margin-bottom:6px">Logo</div>
            <div class="branding-preview"><img id="branding-logo-preview" alt="" /></div>
          </div>
          <div>
            <input type="file" id="branding-logo" accept="image/*" />
            <div class="hint-mini">Recommended: PNG, at least 600×300px.</div>
          </div>
        </div>
        <div class="branding-row">
          <div>
            <div class="muted" style="margin-bottom:6px">Signature</div>
            <div class="branding-preview"><img id="branding-signature-preview" alt="" /></div>
          </div>
          <div>
            <input type="file" id="branding-signature" accept="image/*" />
            <div class="hint-mini">Recommended: Transparent PNG.</div>
          </div>
        </div>
        <div class="branding-actions">
          <button type="button" class="btn secondary" id="branding-cancel">Cancel</button>
          <button type="submit" class="btn" id="branding-save">Upload</button>
        </div>
        <div class="error" id="branding-error" role="alert" style="display:none"></div>
        <div class="hint" id="branding-success" style="display:none">Uploaded successfully.</div>
      </form>
    </div>
  </div>

<script>
  // --- PRE-INSPECTION (PIR) DATA DEFINITIONS (v2 - Enhanced for Email Generation) ---
// This block contains the definitions for all pre-inspection items.
// It has been updated with an `email_blurb` for each item to facilitate automatic email generation.
window.PIR_DEFINITIONS_DATA = [
    // EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Statement of purpose", 
        item_type: "file_only",
        description: "Upload your existing Statement of Purpose.",
        allow_upload: true,
        file_label: "Attached File",
        file_hint: "Uploading a new file will replace the existing one.",
        email_blurb: "Provides our Statement of Purpose, detailing the practice's aims, services, and patient population."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Copy of Major incident/business continuity", 
        item_type: "file_only",
        email_blurb: "Attached is our Major Incident and Business Continuity Plan."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Medical emergencies policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for handling medical emergencies within the practice."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Chaperone policy", 
        item_type: "file_only",
        email_blurb: "Attached is our Chaperone Policy for patient consultations."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Induction process", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Induction Structure: Describe the phases and timeline of your induction process for different staff roles (clinical, admin).", 
            "Key Content & Policies: What essential topics are covered (e.g., safeguarding, H&S, IPC, confidentiality, chaperone policy)?", 
            "Competency Assessment: How do you verify and document that new staff are competent and confident in their role at the end of the induction period?"
        ], 
        description: "Describe the process and/or attach the induction pack/checklist.",
        email_blurb: "Provides a summary of our staff induction process, with the induction pack attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Online services policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the provision and use of online patient services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Access policy", 
        item_type: "file_only",
        email_blurb: "Attached is our Patient Access Policy, detailing how patients can access our services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Registration policy (incl access to medical records)", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for patient registration and access to medical records."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Home visits/care home protocol", 
        item_type: "file_only",
        email_blurb: "Attached is our protocol for conducting home visits and supporting care homes."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for supporting carers", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Identification Strategy: How do you proactively identify patients who are carers?", 
            "Support & Signposting: What specific support is offered and which local/national services do you signpost to?", 
            "Recording & Flagging: How do you maintain an up-to-date carers' register in the clinical system?"
        ], 
        description: "Describe the process and attach any relevant leaflets or policies.",
        email_blurb: "Details our process for identifying and supporting carers, with relevant leaflets attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Number of carers identified and percentage", 
        item_type: "dual_number", 
        labels: ["Number Identified", "Percentage (%)"],
        email_blurb: "Provides the current number and percentage of identified carers on our patient list."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for bereaved patients", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Immediate Steps: What are the immediate administrative and clinical steps upon notification of a patient death?",
            "Family Communication: How and when do you make contact with the bereaved family, and what support is offered?",
            "Record Management: What is the process for updating and managing the deceased patient's records?",
            "Signposting: Which bereavement support services are patients and their families signposted to?",
            "Staff Support: How are staff who were involved in the patient's care supported?"
        ], 
        description: "Describe the process and attach any relevant protocols.",
        email_blurb: "Outlines our process for supporting bereaved patients and their families."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "ICO registration certificate", 
        item_type: "file_only",
        email_blurb: "Attached is our current ICO registration certificate."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Provider liability/MD insurance", 
        item_type: "file_only",
        email_blurb: "Attached is our certificate of provider liability/medical defence insurance."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Information leaflet for online services", 
        
        item_type: "file_only",
        email_blurb: "Attached is the information leaflet we provide to patients regarding our online services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Safety and drug alerts process and evidence of management and actions.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Receipt & Dissemination: How are alerts received and promptly distributed to all relevant staff?", 
            "Action & Responsibility: Who is the designated lead, and what is the process for actioning alerts and documenting in patient records?", 
            "Audit & Learning: How do you maintain a central log to track alerts, actions, and outcomes?"
        ], 
        description: "Describe the process and attach evidence (e.g., completed logs, screenshots).",
        email_blurb: "Details our process for managing safety and drug alerts, with evidence of actions attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy and process for ensuring staff are recruited safely including DBS and registration checks.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for safe staff recruitment, including DBS and registration checks."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy and process to ensure practice oversight of other staff not directly employed by the practice.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the oversight of non-practice staff with access to patients or records."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for supervision and competency oversight of clinical staff.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Supervision Framework: Describe your system for clinical supervision for different roles (e.g., Nurses, HCAs), including frequency and format.", 
            "Competency Assessment: How are competencies for advanced roles (e.g., prescribing) assessed, documented, and reviewed?", 
            "Governance & Record Keeping: Where are supervision and competency records kept and how do they inform appraisals?"
        ], 
        description: "Describe the process and attach any relevant policy.",
        email_blurb: "Outlines our process for clinical supervision and competency oversight, with the relevant policy attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy for ensuring PGDs and PSDs are appropriately reviewed and signed.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of PGDs and PSDs."
    },

    // EMAIL 2: TRAINING
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Number of current staff by role and WTE.", 
        item_type: "dynamic_table", 
        headers: ["Role", "Number of Staff", "WTE"],
        email_blurb: "Provides a breakdown of current staff by role and Whole Time Equivalent (WTE)."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "List of staff and their extended role(s).", 
        item_type: "dynamic_table", 
        headers: ["Staff Name", "Extended Role(s)"],
        email_blurb: "Provides a list of staff members and their designated extended roles."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Policy of training for staff and process to manage and monitor.", 
        item_type: "file_only",
        email_blurb: "Attached is our staff training policy, including our process for management and monitoring."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Matrix of staff training.", 
        item_type: "file_only",
        description: "Attach the training matrix which should include all mandatory and role-specific training.",
        email_blurb: "Attached is our comprehensive staff training matrix."
    },

    // EMAIL 3: SAFEGUARDING
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Safeguarding adults' policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the safeguarding of adults."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Safeguarding children policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the safeguarding of children."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Sample of minutes of MDT meetings", 
        item_type: "file_only",
        description: "Attach a recent, anonymised sample of MDT meeting minutes where safeguarding was discussed.",
        email_blurb: "Attached is a sample of minutes from multidisciplinary team meetings."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Policy/process to ensure information is shared with others.", 
        item_type: "file_only",
        description: "e.g. coding of medical records",
        email_blurb: "Attached is our policy on information sharing, including the coding of medical records."
    },

    // EMAIL 4: RISK ASSESSMENTS
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest fire risk assessment and any action log", 
        item_type: "file_only",
        email_blurb: "Attached is our latest fire risk assessment and corresponding action log."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence and date of fire extinguisher check", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of our latest fire extinguisher checks."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence of latest service for emergency lights and alarm test", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of the latest service for our emergency lights and fire alarm."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Copy of the latest fire drill and actions taken.", 
        item_type: "file_only",
        email_blurb: "Attached is the record of our latest fire drill and any actions taken."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Sample of weekly fire alarm checks", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the sample checks are provided (e.g., 'March 2025')."],
        description: "Attach the log of weekly fire alarm tests for the specified month.",
        email_blurb: "Attached is a sample of our weekly fire alarm checks for the month specified."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest health and safety risk assessment and any action log", 
        item_type: "file_only",
        email_blurb: "Attached is our latest health and safety risk assessment and action log."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest legionella assessment and sample water temperature checks", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the sample temperature checks are provided (e.g., 'March 2025')."],
        description: "Attach the latest full assessment and the water temperature logs for the specified month.",
        email_blurb: "Attached is our latest legionella risk assessment and sample water temperature checks."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Copy of any other general risk assessments.", 
        item_type: "file_only",
        description: "e.g. wheelchair access, monitoring of waiting areas etc.",
        email_blurb: "Attached are copies of other general risk assessments undertaken by the practice."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Equipment calibration dates and copy of certificate", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of our equipment calibration."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "PAT testing dates and copy of certificate", 
        item_type: "file_only",
        email_blurb: "Attached is our latest PAT testing certificate."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence of immunisation status of staff.", 
        item_type: "file_only",
        email_blurb: "Attached is evidence regarding the immunisation status of our staff."
    },

    // EMAIL 5: INFECTION PREVENTION AND CONTROL
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Name and role of IPC lead", 
        item_type: "dual_text", 
        labels: ["Name of Lead", "Role"],
        email_blurb: "Provides the name and role of our designated Infection Prevention and Control (IPC) lead."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Latest Infection control policy", 
        item_type: "file_only",
        email_blurb: "Attached is our latest Infection Prevention and Control policy."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Latest Infection prevention control audit and action log.", 
        item_type: "file_only",
        email_blurb: "Attached is our latest IPC audit and corresponding action log."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Copies of any meetings where IPC has been discussed", 
        item_type: "file_only",
        description: "Include any shared learning and changes since last inspection.",
        email_blurb: "Attached are minutes from meetings where IPC was discussed, showing shared learning."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Summary of vaccine fridge management", 
        item_type: "guided_questions", 
        questions: [
            "Policy & Responsibility: Who is the named lead for vaccine storage and what are the core principles of your cold chain policy?", 
            "Equipment & Location: How many vaccine fridges do you have, where are they located, and how are they maintained?", 
            "Monitoring & Recording: Describe your process for daily temperature monitoring, including logging and acceptable ranges.", 
            "Action on Excursion: What is the procedure for a cold chain incident?", 
            "Stock Management: How do you manage vaccine stock to ensure rotation and minimise wastage?"
        ],
        email_blurb: "Provides a summary of our vaccine fridge and cold chain management procedures."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Sample of vaccine fridge temperature recordings", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the temperature logs are provided (e.g., 'March 2025')."],
        description: "Attach the temperature recordings for the specified month.",
        email_blurb: "Attached are the vaccine fridge temperature recordings for the month specified."
    },

    // EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Significant events policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of significant events."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Complaint’s policy and leaflet available to patients", 
        item_type: "file_only",
        email_blurb: "Attached is our complaints policy and the accompanying patient information leaflet."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "A summary of significant events within the last 12 months", 
        item_type: "guided_questions_and_number", 
        questions: [
            "Process for Reporting & Grading: How are significant events (SEs) reported, recorded, and graded?", 
            "Investigation & Themes: Describe your investigation process. What were the main themes from events in the last 12 months?", 
            "Learning & Actions: What were the critical learning points and what specific changes have been implemented as a result?"
        ], 
        label: "Number of events (12 months)",
        email_blurb: "Provides a summary of significant events from the last 12 months, including learning and actions taken."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "A summary of complaints received within the last 12 months", 
        item_type: "guided_questions_and_number", 
        questions: [
            "Process for Handling Complaints: Briefly describe your complaints procedure, from receipt to final response.", 
            "Analysis & Themes: What were the main themes from complaints received in the last 12 months?", 
            "Service Improvement: What specific changes to services have been made in response to patient complaints?"
        ], 
        label: "Number of complaints (12 months)",
        email_blurb: "Provides a summary of complaints from the last 12 months, detailing themes and resulting improvements."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Sample meetings minutes where SEAs and/or complaints have been discussed.", 
        item_type: "file_only",
        description: "From the past 6 months.",
        email_blurb: "Attached is a sample of meeting minutes showing discussion of significant events and complaints."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Sample of compliments received in the past 6 months.", 
        item_type: "file_only",
        email_blurb: "Attached is a sample of compliments received from patients."
    },

    // EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Summary of the quality of care you provide for the six population groups", 
        item_type: "guided_questions", 
        questions: [
            "Older people: How do you tailor services for older people (e.g., proactive care, frailty assessments)?", 
            "People with long-term conditions: Describe your approach to managing patients with LTCs (e.g., recall systems, care planning).", 
            "Families, children and young people: How do you provide accessible services for this group (e.g., immunisation clinics, safeguarding)?", 
            "Working age people: How do you ensure access for working people (e.g., online services, extended hours)?", 
            "Vulnerable people: What provisions do you have for vulnerable groups (e.g., homeless, learning disabilities, carers)?", 
            "People experiencing poor mental health: Describe your approach to supporting patients with mental health needs (e.g., access to IAPT)."
        ],
        email_blurb: "Provides a summary of how we tailor our care for the six key population groups."
    },
    {
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK",
        title: "Summary of clinical audits (last 2 years)",
        item_type: "textarea",
        description: "Provide a summary list of clinical audits completed in the last two years and explain how you decide on audit topics.",
        email_blurb: "Provides a summary of clinical audit activity undertaken in the last two years."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Full Cycle Audit Example 1", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Audit Topic & Standard: What was the topic of the audit and what standard was measured against?",
            "Initial Findings: What were the results of the first data collection cycle?",
            "Changes Implemented: What specific changes were made to practice as a result of the findings?",
            "Re-Audit Results: What were the results of the second data collection cycle, and was there an improvement?"
        ],
        description: "Describe the audit and attach the full audit document as evidence.",
        email_blurb: "Details our first example of a completed two-cycle clinical audit, with the full report attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Full Cycle Audit Example 2", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Audit Topic & Standard: What was the topic of the audit and what standard was measured against?",
            "Initial Findings: What were the results of the first data collection cycle?",
            "Changes Implemented: What specific changes were made to practice as a result of the findings?",
            "Re-Audit Results: What were the results of the second data collection cycle, and was there an improvement?"
        ],
        description: "Describe the audit and attach the full audit document as evidence.",
        email_blurb: "Details our second example of a completed two-cycle clinical audit, with the full report attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Summary of any other quality improvement work undertaken over the last two years.", 
        item_type: "guided_questions", 
        questions: [
            "Project Overview: Describe any significant Quality Improvement (QI) projects undertaken that are not clinical audits.", 
            "Methodology & Outcomes: What QI methodology was used (e.g., PDSA) and what were the measured outcomes?", 
            "Learning & Sustainability: What was learned and how have the improvements been sustained?"
        ],
        email_blurb: "Provides a summary of other non-audit Quality Improvement (QI) work from the last two years."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Evidence of how you have responded to patient feedback (last 12 months).", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Collection Methods: What formal and informal methods do you use to gather patient feedback?", 
            "Analysis & Key Themes: Provide a summary of the key themes, both positive and negative, from patient feedback.", 
            "Action & 'You Said, We Did': Provide specific examples of changes made in direct response to patient feedback."
        ], 
        description: "Summarise and attach evidence (e.g., survey results, FFT data, action logs).",
        email_blurb: "Shows how we have collected, analysed, and acted upon patient feedback, with evidence attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Patient survey results and action log (if not included above)", 
        item_type: "file_only",
        email_blurb: "Attached are the results and action log from our own patient survey."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Evidence of how you have responded to staff feedback (last 12 months).", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Collection Methods: What mechanisms are in place for staff to provide feedback?", 
            "Analysis & Key Themes: What were the key themes from staff feedback over the last 12 months?", 
            "Action & Response: Provide specific examples of changes made in response to staff feedback."
        ], 
        description: "Summarise and attach evidence (e.g., staff survey results).",
        email_blurb: "Shows how we have collected, analysed, and acted upon staff feedback, with evidence attached."
    },

    // EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Discharge (medicine reconciliation) process and any audits/checks undertaken.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Process Workflow: Describe the end-to-end process from receiving a discharge summary to updating the patient's record.", 
            "Roles & Responsibilities: Who is responsible for each step of the process (e.g., admin, clinical pharmacist, GP)?", 
            "Quality Assurance: How do you audit compliance? Provide a summary of any recent audit findings."
        ], 
        description: "Describe the process and attach audits/checks.",
        email_blurb: "Details our process for medicine reconciliation following patient discharge, with recent audits attached."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Policy and process for the management of repeat prescriptions and medicine reviews.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of repeat prescriptions and medication reviews."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Patient summarising/coding in medical records policy/process and any audits.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "New Patient Record Summarising: Describe your process and target timeframe for summarising new patient records.", 
            "Clinical Correspondence Workflow: How is incoming correspondence processed, read, coded, and actioned?", 
            "Quality Assurance: What systems are in place to ensure coding is accurate, consistent, and timely?"
        ], 
        description: "Describe the process and attach audits/checks.",
        email_blurb: "Outlines our process for summarising and coding patient records, with recent audits attached."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Number of patient records that have not been fully summarised.", 
        item_type: "number", 
        label: "Number of records",
        email_blurb: "Provides the current number of patient records awaiting full summarisation."
    },

    // EMAIL 9: DATA FOR THE REPORT
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "NHS health checks data (last 12 months)", 
        item_type: "triple_number", 
        labels: ["Eligible", "Offered", "Completed"],
        email_blurb: "Provides our NHS Health Checks data for the last 12 months."
    },
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "Learning Disability check data (last 12 months)", 
        item_type: "triple_number", 
        labels: ["Eligible", "Offered", "Completed"],
        email_blurb: "Provides our Learning Disability Health Checks data for the last 12 months."
    },
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "Cervical cancer screening and child immunisation coverage data.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Cervical Screening Uptake Strategy: Describe the specific actions you have taken to improve cervical screening uptake.", 
            "Childhood Immunisation Uptake Strategy: Describe the specific actions you have taken to improve childhood immunisation rates.", 
            "Data & Outcomes: What has been the impact of these actions on your uptake data?"
        ], 
        description: "Summarise actions and attach coverage data.",
        email_blurb: "Provides our latest uptake data for cervical screening and childhood immunisations, along with actions taken to improve coverage."
    },
];

</script>

<script type="module">
  // Supabase v2 client is initialized earlier in this file
  // JSZip is already loaded globally from jszip.min.js script tag
  // No need to import it as a module

  // Use the globally initialized supabase client from the top of the file
  // This ensures we use the same session configuration as admin-login.html
  // Note: window.supabase is already set at line 35

  // Initialize authentication once Supabase client is ready
  // console.log('🔥 MODULE: Supabase client ready, initializing authentication');
  initAuth();

  // Authentication functions
  function showAuth(show = true) {
    const appShell = document.getElementById('app');
    // When the Admin UI needs to show auth, direct to home.html for the login screen
    if (show) {
      // Add a query parameter to indicate this was an admin page
  window.location.href = 'admin-login.html';
      return;
    }
    if (appShell) appShell.style.display = 'grid';
  }

  function showError(message) {
    // No inline auth UI anymore; log for debugging
    console.error(message);
  }

  function hideError() { /* no-op */ }

  // Login form handler
  async function handleLogin(e) {
    e.preventDefault();
    hideError();

    const email = document.getElementById('auth-email');
    const password = document.getElementById('auth-password');
    const submitBtn = document.querySelector('#auth-form button[type="submit"]');

    if (!email || !password) {
      showError('Email and password fields not found');
      return;
    }

    try {
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Signing in...';
      }

      const { data, error } = await supabase.auth.signInWithPassword({
        email: email.value.trim(),
        password: password.value
      });

      if (error) {
        showError(error.message);
      } else if (data.user) {
        // Login successful - bootstrap will be called automatically by the session change
        // Removed reload to prevent debugger interference
        hideLoginForm();
        // Initialize the page content instead of reloading
        if (typeof bootstrap === 'function') {
          bootstrap();
        }
      }
    } catch (err) {
      showError('Login failed: ' + (err.message || 'Unknown error'));
    } finally {
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign In';
      }
    }
  }

  // Initialize auth form
  function initAuth() {
    const authForm = document.getElementById('auth-form');
    if (authForm) {
      authForm.addEventListener('submit', handleLogin);
    }

    // Check for existing session
    // console.log('🔥 ADMIN.HTML: About to call window.supabase.auth.getSession()');
    window.supabase.auth.getSession().then(({ data: { session }, error }) => {
      // console.log('🔥 ADMIN.HTML: getSession() result - session:', session, 'error:', error);
      if (error) {
        console.error('🔥 Failed to get session:', error);
        showAuth(true);
        return;
      }
      
      if (!session) {
        // console.log('🔥 No active session found, showing login form');
        showAuth(true);
        return;
      }
      
      // console.log('🔥 Session found, user:', session.user?.email);
      
      // Check if the user has admin/owner role
      const checkAdminRole = async () => {
        // console.log('🔥 checkAdminRole() STARTED - session:', session);
        try {
          // console.log('🔥 About to query master_users table for user:', session.user.id);
          // First check if user has a profile with admin role
          const { data: profile, error: profileError } = await window.supabase
            .from('master_users')
            .select('access_type, full_name, onboarding_complete')
            .eq('auth_user_id', session.user.id)
            .maybeSingle();
          
          // console.log('🔥 Profiles query result - profile:', profile, 'error:', profileError);
            
          const accessType = String(profile?.access_type || '').toLowerCase();
          if (accessType === 'admin' || accessType === 'owner') {
            console.log('✅ Admin role confirmed from profile');
            // console.log('🔥 ABOUT TO CALL BOOTSTRAP - Profile data:', profile);
            
            // Immediately update user display with available info
            try {
              const userName = document.getElementById('user-name');
              const userInitials = document.getElementById('user-initials');
              // console.log('🔥 Setting immediate user display - userName element:', userName);
              if (userName) {
                const displayName = profile.full_name || 
                                  session.user?.user_metadata?.full_name ||
                                  session.user?.user_metadata?.name ||
                                  (session.user.email ? session.user.email.split('@')[0].replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'User');
                userName.textContent = displayName;
                // console.log('🔥 Immediately set user name to:', displayName);
                
                // Also set initials
                if (userInitials) {
                  const nameParts = displayName.split(' ');
                  let initials;
                  if (nameParts.length >= 2) {
                    initials = (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
                  } else {
                    initials = displayName.substring(0, 2).toUpperCase();
                  }
                  userInitials.textContent = initials;
                  console.log('🔥 Set initials to:', initials);
                }
              } else {
                console.log('🔥 userName element not found!');
              }
            } catch (e) {
              console.error('🔥 Failed to set immediate user display:', e);
            }
            
            console.log('🔥 Calling showAuth(false)');
            showAuth(false);
            console.log('🔥 About to call bootstrap()');
            bootstrap();
            console.log('🔥 bootstrap() call completed');
            return;
          }
          
          // Not admin/owner per master_users.access_type: redirect to home
          console.log('⚠️ User authenticated but not admin/owner via access_type; redirecting');
          window.location.replace('staff.html');
          return;
          
        } catch (err) {
          console.error('Error checking admin role:', err);
          showAuth(true);
        }
      };
      
      checkAdminRole();
    });
  }

  // Initialize authentication when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAuth);
  } else {
    initAuth();
  }

  // SPA navigation
  const nav = document.getElementById("nav");
  const views = [...document.querySelectorAll("section.view")];

  // Sidebar toggle functionality is handled by the resize script at the bottom
  // This ensures proper coordination between toggle and drag-resize features


  // Fuzzy Match Holiday Import Functions
  let fuzzyUploadData = [];
  let siteUsers = [];

  function setupFuzzyUploadHandlers() {
    console.log('🎯 Setting up fuzzy upload handlers (click-only)...');

    // Use setTimeout to ensure DOM is ready
    setTimeout(() => {
      const uploadZone = document.getElementById('fuzzy-upload-zone');
      const fileInput = document.getElementById('fuzzy-file-input');

      console.log('Upload zone found:', !!uploadZone);
      console.log('File input found:', !!fileInput);

      if (!uploadZone || !fileInput) {
        console.error('❌ Upload elements not found');
        return;
      }

      // Click to upload only
      uploadZone.onclick = (e) => {
        console.log('📂 Upload zone clicked');
        fileInput.click();
      };

      // File input change
      fileInput.onchange = (e) => {
        if (e.target.files && e.target.files.length > 0) {
          console.log('📎 File selected:', e.target.files[0].name);
          if (typeof handleFuzzyFileUpload === 'function') {
            handleFuzzyFileUpload(e.target.files[0]);
          } else if (typeof window.handleFuzzyFileUpload === 'function') {
            window.handleFuzzyFileUpload(e.target.files[0]);
          } else {
            console.error('handleFuzzyFileUpload not yet available');
          }
        }
      };

      console.log('✅ Upload handlers attached successfully (click-only)');
    }, 100);
  }

  async function loadFuzzyMatch() {
    console.log('Loading fuzzy match data...');
    console.log('Current ctx:', ctx);
    console.log('Current site_id:', ctx.site_id);

    try {
      // Check if ctx is properly initialized
      if (!ctx || !ctx.site_id) {
        console.error('❌ Context not initialized or site_id missing!', ctx);
        const errorMsg = document.getElementById('fuzzy-error-message');
        if (errorMsg) {
          errorMsg.textContent = 'Error: User context not initialized. Please refresh the page.';
          errorMsg.style.display = 'block';
        }
        return;
      }

      // Load site users for matching
      await loadSiteUsers();

      // Load statistics
      await loadFuzzyStatistics();

      // Load existing records
      await loadFuzzyRecords();

      // Setup file upload handlers
      setupFuzzyUploadHandlers();
    } catch (error) {
      console.error('❌ Error in loadFuzzyMatch:', error);
      const errorMsg = document.getElementById('fuzzy-error-message');
      if (errorMsg) {
        errorMsg.textContent = `Error loading holiday data: ${error.message}`;
        errorMsg.style.display = 'block';
      }
    }
  }

  async function loadSiteUsers() {
    try {
      const { data: users, error } = await supabase
        .from('master_users')
        .select('id, auth_user_id, full_name, role_detail')
        .eq('site_id', ctx.site_id)
        .order('full_name');

      if (error) throw error;

      // Map the users to have a consistent user_id field for matching
      siteUsers = (users || []).map(u => ({
        ...u,
        user_id: u.auth_user_id || u.id  // Use auth_user_id if available, fallback to id
      }));
      console.log('Loaded site users:', siteUsers.length, siteUsers);
    } catch (error) {
      console.error('Failed to load site users:', error);
      siteUsers = [];
    }
  }

  // Resolve a possibly-numeric user identifier to the auth.users UUID expected by
  // stored procedures. If the value already looks like a UUID, return it unchanged.
  // If it's numeric (profile id or similar), try to find the matching `user_id`
  // from the cached `siteUsers` list. If resolution fails, return the original
  // value so Supabase will surface the appropriate error.
  async function resolveUserUuid(raw) {
    if (!raw) return raw;
    // Simple UUID v4-ish pattern check
    const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
    if (uuidPattern.test(raw)) return raw;

    // If it's numeric, try to find a matching profile entry via Supabase
    if (/^\d+$/.test(String(raw))) {
      try {
        // Try common profile identifier columns that might contain the numeric value
        const { data: profile, error } = await supabase
          .from('master_users')
          .select('auth_user_id, id, kiosk_user_id')
          .or(`id.eq.${raw},kiosk_user_id.eq.${raw}`)
          .limit(1)
          .maybeSingle();

        if (!error && profile && profile.auth_user_id) return profile.auth_user_id;
      } catch (e) {
        console.warn('resolveUserUuid lookup failed', e);
      }

      // Fallback: try to resolve from cached siteUsers by positional index
      const numeric = parseInt(raw, 10);
      if (!isNaN(numeric) && siteUsers[numeric - 1] && siteUsers[numeric - 1].user_id) {
        return siteUsers[numeric - 1].user_id;
      }
    }

    // If we couldn't resolve, return the original value so Supabase surfaces a clear error
    return raw;
  }

  async function loadFuzzyStatistics() {
    try {
      const { data, error } = await supabase
        .from('fuzzy_match_holidays')
        .select('match_status')
        .eq('site_id', ctx.site_id);

      if (error) throw error;

      // Also get matched_user_id to count auto-matched pending records
      const { data: fullData, error: fullError } = await supabase
        .from('fuzzy_match_holidays')
        .select('match_status, matched_user_id')
        .eq('site_id', ctx.site_id);

      const stats = {
        pending: fullData.filter(d => d.match_status === 'pending' && !d.matched_user_id).length,
        matched: fullData.filter(d => d.match_status === 'matched' || (d.match_status === 'pending' && d.matched_user_id)).length,
        transferred: fullData.filter(d => d.match_status === 'transferred').length,
        total: fullData.length
      };

      document.getElementById('fuzzy-stat-pending').textContent = stats.pending;
      document.getElementById('fuzzy-stat-matched').textContent = stats.matched;
      document.getElementById('fuzzy-stat-transferred').textContent = stats.transferred;
      document.getElementById('fuzzy-stat-total').textContent = stats.total;
    } catch (error) {
      console.error('Failed to load statistics:', error);
    }
  }

  async function loadFuzzyRecords() {
    const tbody = document.getElementById('fuzzy-existing-tbody');
    console.log('📊 Loading fuzzy records for site_id:', ctx.site_id);

    if (!tbody) {
      console.error('❌ fuzzy-existing-tbody element not found!');
      return;
    }

    try {
      const { data, error } = await supabase
        .from('fuzzy_match_holidays')
        .select('*')
        .eq('site_id', ctx.site_id)
        .order('created_at', { ascending: false });

      console.log('📋 Query result:', { data, error });

      if (error) {
        console.error('❌ Supabase error:', error);
        throw error;
      }

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#718096;">No records found</td></tr>';
        return;
      }

      // Get user names and working patterns for matched records
      const matchedUserIds = data.filter(r => r.matched_user_id).map(r => r.matched_user_id);
      let userMap = {};
      let workingPatternMap = {};

      if (matchedUserIds.length > 0) {
        const { data: matchedUsers } = await supabase
          .from('master_users')
          .select(`
            id, auth_user_id, full_name, is_gp,
            monday_hours, tuesday_hours, wednesday_hours,
            thursday_hours, friday_hours, saturday_hours, sunday_hours,
            monday_sessions, tuesday_sessions, wednesday_sessions,
            thursday_sessions, friday_sessions, saturday_sessions, sunday_sessions
          `)
          .or(`id.in.(${matchedUserIds.join(',')}),auth_user_id.in.(${matchedUserIds.join(',')})`);

        if (matchedUsers) {
          matchedUsers.forEach(u => {
            // Map both id and auth_user_id to the full name and working patterns
            if (u.auth_user_id) {
              userMap[u.auth_user_id] = u.full_name;
              workingPatternMap[u.auth_user_id] = u;
            }
            if (u.id) {
              userMap[u.id] = u.full_name;
              workingPatternMap[u.id] = u;
            }
          });
        }
      }

      // Get working patterns for siteUsers too (for auto-matched records)
      const siteUserIds = siteUsers.map(u => u.user_id);
      if (siteUserIds.length > 0) {
        const { data: siteUserPatterns } = await supabase
          .from('master_users')
          .select(`
            id, auth_user_id, is_gp,
            monday_hours, tuesday_hours, wednesday_hours,
            thursday_hours, friday_hours, saturday_hours, sunday_hours,
            monday_sessions, tuesday_sessions, wednesday_sessions,
            thursday_sessions, friday_sessions, saturday_sessions, sunday_sessions
          `)
          .or(`id.in.(${siteUserIds.join(',')}),auth_user_id.in.(${siteUserIds.join(',')})`);

        if (siteUserPatterns) {
          siteUserPatterns.forEach(u => {
            if (u.auth_user_id && !workingPatternMap[u.auth_user_id]) {
              workingPatternMap[u.auth_user_id] = u;
            }
            if (u.id && !workingPatternMap[u.id]) {
              workingPatternMap[u.id] = u;
            }
          });
        }
      }

      let autoMatchCount = 0;
      let pendingCount = 0;

      tbody.innerHTML = data.map((record, index) => {
        // Determine effective status (if has matched_user_id and still pending, show as matched)
        const effectiveStatus = (record.matched_user_id && record.match_status === 'pending') ? 'matched' : record.match_status;

        const statusColor = {
          'pending': '#667eea',
          'matched': '#10b981',
          'transferred': '#000000',
          'rejected': '#ef4444'
        }[effectiveStatus] || '#6b7280';

        // Find best matching user based on name similarity
        let bestMatchUserId = record.matched_user_id || '';

        // Count pending records (no matched user yet)
        if (record.match_status === 'pending' && !record.matched_user_id) {
          pendingCount++;
        }

        // Count auto-matched records (pending with matched user from auto-matching)
        if (record.match_status === 'pending' && record.matched_user_id) {
          autoMatchCount++;
        }

        if (!bestMatchUserId && record.match_status === 'pending') {

          // Debug: Log what we're trying to match
          if (record.staff_name.toLowerCase().includes('ben howard')) {
            console.log('🔍 Trying to match:', record.staff_name);
            console.log('Available users:', siteUsers.map(u => u.full_name));
          }

          // Try exact match first (case insensitive)
          const exactMatch = siteUsers.find(u =>
            u.full_name.toLowerCase() === record.staff_name.toLowerCase()
          );
          if (exactMatch) {
            bestMatchUserId = exactMatch.user_id;
            console.log('✅ Exact match found for', record.staff_name, '→', exactMatch.full_name);

            // Automatically save the matched_user_id (but keep status as pending for review)
            if (!record.matched_user_id) {
              supabase
                .from('fuzzy_match_holidays')
                .update({
                  matched_user_id: exactMatch.user_id
                })
                .eq('id', record.id)
                .eq('site_id', ctx.site_id)
                .then(({ error }) => {
                  if (!error) {
                    console.log('✅ Auto-match user saved for', record.staff_name);
                  }
                });
            }
          } else {
            // Try partial match (last name match)
            const recordLastName = record.staff_name.split(' ').pop().toLowerCase();
            const partialMatch = siteUsers.find(u => {
              const userLastName = u.full_name.split(' ').pop().toLowerCase();
              return userLastName === recordLastName;
            });
            if (partialMatch) {
              bestMatchUserId = partialMatch.user_id;
              console.log('✅ Partial match found for', record.staff_name, '→', partialMatch.full_name);

              // Automatically save the matched_user_id (but keep status as pending for review)
              if (!record.matched_user_id) {
                supabase
                  .from('fuzzy_match_holidays')
                  .update({
                    matched_user_id: partialMatch.user_id
                  })
                  .eq('id', record.id)
                  .eq('site_id', ctx.site_id)
                  .then(({ error }) => {
                    if (!error) {
                      console.log('✅ Auto-match user saved for', record.staff_name);
                    }
                  });
              }
            } else {
              console.log('❌ No match found for', record.staff_name);
            }
          }
        }

        // Calculate hours/sessions if user is matched
        let calculatedHours = record.total_hours;
        let calculatedSessions = record.total_sessions;
        let isCalculated = false;

        const useCalculated = document.getElementById('fuzzy-use-calculated')?.checked || false;
        const matchedUserId = record.matched_user_id || bestMatchUserId;

        if (matchedUserId && useCalculated) {
          const pattern = workingPatternMap[matchedUserId];
          if (pattern) {
            const calculated = calculateHoursForDateRange(
              record.start_date,
              record.end_date,
              pattern
            );
            console.log(`📊 Auto-calculated for ${record.staff_name}:`, calculated);
            calculatedHours = calculated.hours;
            calculatedSessions = calculated.sessions;
            isCalculated = true;
          }
        }

        // Generate user dropdown options with best match pre-selected
        const userOptions = siteUsers.map(u =>
          `<option value="${u.user_id}" ${(record.matched_user_id === u.user_id || (!record.matched_user_id && bestMatchUserId === u.user_id)) ? 'selected' : ''}>
            ${esc(u.full_name)}${u.role_detail ? ' (' + esc(u.role_detail) + ')' : ''}
          </option>`
        ).join('');

        return `
          <tr data-record-id="${record.id}" data-status="${effectiveStatus}">
            <td>
              ${effectiveStatus !== 'transferred' && effectiveStatus !== 'rejected' ?
                `<input type="checkbox" class="fuzzy-record-checkbox" data-record-id="${record.id}"
                  style="width:16px; height:16px; cursor:pointer;">` :
                ''}
            </td>
            <td>
              ${esc(record.staff_name)}
              ${record.matched_user_id && record.match_status === 'pending' ?
                '<span style="color:#10b981; font-size:12px; margin-left:8px;" title="Auto-matched">✓</span>' :
                ''}
            </td>
            <td>${new Date(record.start_date).toLocaleDateString()}</td>
            <td>${new Date(record.end_date).toLocaleDateString()}</td>
            <td>
              ${calculatedHours ?
                `<span ${isCalculated ? 'style="font-style:italic;" title="Auto-calculated from working pattern"' : ''}>${calculatedHours.toFixed(1)} hours</span>` :
                calculatedSessions ?
                `<span ${isCalculated ? 'style="font-style:italic;" title="Auto-calculated from working pattern"' : ''}>${calculatedSessions.toFixed(1)} sessions</span>` :
                '-'}
            </td>
            <td><span style="color:${statusColor}; font-weight:600;">${effectiveStatus}</span></td>
            <td>
              ${effectiveStatus === 'transferred' ?
                `✅ ${userMap[record.matched_user_id] || 'Transferred'}` :
                effectiveStatus === 'rejected' ?
                `❌ Rejected` :
                `<select id="user-select-${record.id}" class="fuzzy-user-select" data-record-id="${record.id}"
                  style="padding:4px 8px; border-radius:4px; border:1px solid #cbd5e0; ${bestMatchUserId ? 'border-color:#10b981;' : ''}">
                  <option value="">Select User...</option>
                  ${userOptions}
                </select>`
              }
            </td>
            <td>${new Date(record.uploaded_at || record.created_at).toLocaleDateString()}</td>
            <td>
              ${effectiveStatus === 'pending' ?
                `<div style="display:flex; gap:4px;">
                  <button class="btn btn-sm" onclick="matchAndTransferFuzzyRecord('${record.id}')"
                    style="background:linear-gradient(135deg, #667eea, #764ba2); padding:4px 8px;">
                    Match & Transfer
                  </button>
                  <button class="btn btn-sm" onclick="deleteFuzzyRecord('${record.id}')"
                    style="background:#ef4444; padding:4px 8px;">
                    Delete
                  </button>
                </div>` :
                effectiveStatus === 'matched' ?
                `<div style="display:flex; gap:4px;">
                  <button class="btn btn-sm" onclick="transferFuzzyRecord('${record.id}')"
                    style="background:#10b981; padding:4px 8px;">
                    Transfer
                  </button>
                  <button class="btn btn-sm" onclick="unmatchFuzzyRecord('${record.id}')"
                    style="background:#6b7280; padding:4px 8px;">
                    Unmatch
                  </button>
                </div>` :
                '-'}
            </td>
          </tr>
        `;
      }).join('');

      // Update match info
      const matchInfo = document.getElementById('fuzzy-match-info');
      if (matchInfo) {
        if (autoMatchCount > 0) {
          const totalUnprocessed = pendingCount + autoMatchCount;
          matchInfo.innerHTML = `<span style="color:#10b981;">✓ ${autoMatchCount} of ${totalUnprocessed} records have automatic matches</span>`;
        } else if (pendingCount > 0) {
          matchInfo.innerHTML = `<span style="color:#6b7280;">${pendingCount} pending records awaiting review</span>`;
        } else {
          matchInfo.innerHTML = '';
        }
      }

      // Update statistics after auto-matching
      if (autoMatchCount > 0) {
        setTimeout(async () => {
          await loadFuzzyStatistics();
        }, 500);
      }

      // Populate name filter dropdown with unique names
      const nameFilter = document.getElementById('fuzzy-name-filter');
      if (nameFilter) {
        const currentValue = nameFilter.value;
        const uniqueNames = [...new Set(data.map(record => record.staff_name))].sort();

        nameFilter.innerHTML = '<option value="">All Names</option>';
        uniqueNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name.toLowerCase();
          option.textContent = name;
          nameFilter.appendChild(option);
        });

        // Restore previous selection if it still exists
        if (currentValue && nameFilter.querySelector(`option[value="${currentValue}"]`)) {
          nameFilter.value = currentValue;
        }
      }

      // Add event listeners for user dropdown changes
      document.querySelectorAll('.fuzzy-user-select').forEach(select => {
        select.addEventListener('change', async (e) => {
          const recordId = e.target.dataset.recordId;
          const newUserId = e.target.value;

          if (newUserId) {
            // Update the matched_user_id in the database
            const { error } = await supabase
              .from('fuzzy_match_holidays')
              .update({
                matched_user_id: newUserId,
                match_status: 'matched',
                matched_at: new Date().toISOString()
              })
              .eq('id', recordId)
              .eq('site_id', ctx.site_id);

            if (!error) {
              console.log(`✅ Updated match for record ${recordId} to user ${newUserId}`);
              // Reload statistics and records to show updated calculations
              await loadFuzzyStatistics();
              await loadFuzzyRecords();
            } else {
              console.error('Failed to update match:', error);
            }
          }
        });
      });

      // Apply current filters
      setTimeout(() => {
        filterFuzzyRecords();
      }, 100);
    } catch (error) {
      console.error('Failed to load fuzzy records:', error);
      tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; color:#ef4444;">Error loading records: ${error.message}</td></tr>`;
    }
  }

  async function handleFuzzyFileUpload(file) {
    const errorMsg = document.getElementById('fuzzy-error-message');
    const successMsg = document.getElementById('fuzzy-success-message');

    // Hide messages
    errorMsg.style.display = 'none';
    successMsg.style.display = 'none';

    if (!file.name.match(/\.(xlsx|xls)$/)) {
      errorMsg.textContent = 'Please upload an Excel file (.xlsx or .xls)';
      errorMsg.style.display = 'block';
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const workbook = XLSX.read(e.target.result, { type: 'binary' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet);

        // Validate and process data
        fuzzyUploadData = data.map(row => ({
          staff_name: row['Staff Name'] || row['Name'] || '',
          start_date: parseExcelDate(row['Start Date']),
          end_date: parseExcelDate(row['End Date']),
          total_hours: parseFloat(row['Total Hours']) || null,
          total_sessions: parseFloat(row['Total Sessions']) || null,
          reason: row['Reason'] || ''
        })).filter(row => row.staff_name && row.start_date && row.end_date);

        if (fuzzyUploadData.length === 0) {
          errorMsg.textContent = 'No valid data found in the Excel file';
          errorMsg.style.display = 'block';
          return;
        }

        // Show preview
        showFuzzyPreview();
      } catch (error) {
        console.error('Error parsing Excel:', error);
        errorMsg.textContent = 'Failed to parse Excel file: ' + error.message;
        errorMsg.style.display = 'block';
      }
    };
    reader.readAsBinaryString(file);
  }

  function parseExcelDate(dateValue) {
    if (!dateValue) return null;

    // If it's already a Date object or valid date string
    if (dateValue instanceof Date) return dateValue.toISOString().split('T')[0];
    if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) return dateValue;

    // Excel serial date (number of days since 1900-01-01)
    if (typeof dateValue === 'number') {
      const date = new Date((dateValue - 25569) * 86400 * 1000);
      return date.toISOString().split('T')[0];
    }

    // Try parsing as string
    const parsed = new Date(dateValue);
    return isNaN(parsed) ? null : parsed.toISOString().split('T')[0];
  }

  function showFuzzyPreview() {
    const preview = document.getElementById('fuzzy-data-preview');
    const tbody = document.getElementById('fuzzy-preview-tbody');

    // Generate preview rows with editable inputs for hours/sessions
    tbody.innerHTML = fuzzyUploadData.slice(0, 10).map((row, index) => `
      <tr data-index="${index}">
        <td>${esc(row.staff_name)}</td>
        <td>${row.start_date}</td>
        <td>${row.end_date}</td>
        <td>
          <input type="number" step="0.5" min="0"
                 class="hours-input"
                 data-index="${index}"
                 value="${row.total_hours || ''}"
                 placeholder="-"
                 style="width: 80px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateHoursValue(${index}, this.value)">
        </td>
        <td>
          <input type="number" step="1" min="0"
                 class="sessions-input"
                 data-index="${index}"
                 value="${row.total_sessions || ''}"
                 placeholder="-"
                 style="width: 80px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateSessionsValue(${index}, this.value)">
        </td>
        <td>${esc(row.reason)}</td>
      </tr>
    `).join('');

    if (fuzzyUploadData.length > 10) {
      tbody.innerHTML += `<tr><td colspan="6" style="text-align:center; color:#718096;">... and ${fuzzyUploadData.length - 10} more records</td></tr>`;
    }

    preview.style.display = 'block';
  }

  async function confirmFuzzyUpload() {
    const errorMsg = document.getElementById('fuzzy-error-message');
    const successMsg = document.getElementById('fuzzy-success-message');

    // Hide any existing messages
    errorMsg.style.display = 'none';
    successMsg.style.display = 'none';

    try {
      // Validate data
      if (!fuzzyUploadData || fuzzyUploadData.length === 0) {
        throw new Error('No data to upload');
      }

      // Show uploading message
      successMsg.textContent = '⏳ Uploading holiday records...';
      successMsg.style.display = 'block';

      // Prepare data for upload
      const recordsToInsert = fuzzyUploadData.map(row => ({
        ...row,
        site_id: ctx.site_id,
        match_status: 'pending',
        uploaded_by: ctx.user.id
      }));

      console.log('📤 Attempting to insert', recordsToInsert.length, 'records');

      // Insert into database
      const { data, error } = await supabase
        .from('fuzzy_match_holidays')
        .insert(recordsToInsert);

      if (error) {
        // Check for specific RLS error
        if (error.code === '42501') {
          throw new Error('Permission denied. Please contact your administrator to enable holiday uploads for your account.');
        }
        throw error;
      }

      // Success
      successMsg.textContent = `✅ Successfully uploaded ${fuzzyUploadData.length} holiday records`;
      successMsg.style.display = 'block';

      // Reset UI
      document.getElementById('fuzzy-data-preview').style.display = 'none';
      document.getElementById('fuzzy-file-input').value = '';
      fuzzyUploadData = [];

      // Reload data
      await loadFuzzyStatistics();
      await loadFuzzyRecords();

      // Auto-hide success message after 5 seconds
      setTimeout(() => {
        successMsg.style.display = 'none';
      }, 5000);

    } catch (error) {
      console.error('Upload failed:', error);

      // Make error message more prominent
      errorMsg.innerHTML = `
        <strong>❌ Upload Failed</strong><br>
        ${error.message}<br>
        <small style="margin-top: 8px; display: block;">
          If this persists, please run: <code>node fix_fuzzy_holidays_rls.js</code>
        </small>
      `;
      errorMsg.style.display = 'block';
      errorMsg.style.backgroundColor = '#fee';
      errorMsg.style.border = '2px solid #f44';
      errorMsg.style.padding = '15px';
      errorMsg.style.borderRadius = '8px';
      errorMsg.style.marginBottom = '20px';

      // Hide uploading message
      successMsg.style.display = 'none';

      // Scroll to error message
      errorMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  function cancelFuzzyUpload() {
    document.getElementById('fuzzy-data-preview').style.display = 'none';
    document.getElementById('fuzzy-file-input').value = '';
    fuzzyUploadData = [];
  }

  async function deleteFuzzyRecord(id) {
    if (!confirm('Are you sure you want to delete this record?')) return;

    try {
      const { error } = await supabase
        .from('fuzzy_match_holidays')
        .delete()
        .eq('id', id)
        .eq('site_id', ctx.site_id);

      if (error) throw error;

      // Reload data
      await loadFuzzyStatistics();
      await loadFuzzyRecords();
    } catch (error) {
      console.error('Delete failed:', error);
      alert('Failed to delete record: ' + error.message);
    }
  }

  async function matchAndTransferFuzzyRecord(recordId) {
    const selectElement = document.getElementById(`user-select-${recordId}`);
    const userId = selectElement?.value;

    if (!userId) {
      alert('Please select a user to match this record to');
      return;
    }

    const userName = selectElement.options[selectElement.selectedIndex].text.trim();
    if (!confirm(`Match and transfer this holiday record to ${userName}?`)) return;

    try {
      // Get the full record first
      const { data: record, error: fetchError } = await supabase
        .from('fuzzy_match_holidays')
        .select('*')
        .eq('id', recordId)
        .single();

      if (fetchError) throw fetchError;

      // Check if we need to calculate hours/sessions
      const useCalculated = document.getElementById('fuzzy-use-calculated')?.checked || false;
      let updateData = {
        matched_user_id: userId,
        match_status: 'matched',
        matched_at: new Date().toISOString()
      };

      if (useCalculated && (!record.total_hours && !record.total_sessions)) {
        // Get user's working pattern
        const { data: userData, error: userError } = await supabase
          .from('master_users')
          .select(`
            full_name, is_gp,
            monday_hours, tuesday_hours, wednesday_hours,
            thursday_hours, friday_hours, saturday_hours, sunday_hours,
            monday_sessions, tuesday_sessions, wednesday_sessions,
            thursday_sessions, friday_sessions, saturday_sessions, sunday_sessions
          `)
          .or(`id.eq.${userId},auth_user_id.eq.${userId}`)
          .eq('site_id', ctx.site_id)
          .maybeSingle();

        if (userData) {
          const calculated = calculateHoursForDateRange(
            record.start_date,
            record.end_date,
            userData
          );

          if (userData.is_gp) {
            updateData.total_sessions = calculated.sessions;
            updateData.total_hours = null;
            updateData.total_days = calculated.sessions; // For GPs, total_days = sessions
          } else {
            updateData.total_hours = calculated.hours;
            updateData.total_sessions = null;
            updateData.total_days = calculated.hours / 7.5; // Convert hours to days (assuming 7.5 hour work day)
          }
        }
      } else if (!record.total_days) {
        // Calculate total_days from existing hours or sessions
        if (record.total_sessions) {
          updateData.total_days = record.total_sessions; // For GPs
        } else if (record.total_hours) {
          updateData.total_days = record.total_hours / 7.5; // For staff
        }
      }

      // Update the record with match info and calculated values
      const { error: matchError } = await supabase
        .from('fuzzy_match_holidays')
        .update(updateData)
        .eq('id', recordId)
        .eq('site_id', ctx.site_id);

      if (matchError) throw matchError;

      // Now transfer to holiday requests using the database function
      const resolvedUserId = await resolveUserUuid(userId);
      const { data: transferResult, error: transferError } = await supabase
        .rpc('transfer_fuzzy_match_to_request', {
          p_fuzzy_match_id: parseInt(recordId),
          p_user_id: resolvedUserId
        });

      if (transferError) throw transferError;

      // Success
      alert(`Holiday successfully transferred to ${userName}`);

      // Reload data
      await loadFuzzyStatistics();
      await loadFuzzyRecords();
    } catch (error) {
      console.error('Match and transfer failed:', error);
      alert('Failed to match and transfer: ' + error.message);
    }
  }

  async function transferFuzzyRecord(recordId) {
    if (!confirm('Transfer this matched holiday to the user\'s holiday requests?')) return;

    try {
      // Get the full record
      const { data: record, error: fetchError } = await supabase
        .from('fuzzy_match_holidays')
        .select('*')
        .eq('id', recordId)
        .single();

      if (fetchError) throw fetchError;
      if (!record?.matched_user_id) {
        alert('No user matched to this record');
        return;
      }

      // Check if we need to calculate hours/sessions
      const useCalculated = document.getElementById('fuzzy-use-calculated')?.checked || false;

      if (useCalculated && (!record.total_hours && !record.total_sessions)) {
        // Get user's working pattern
        const { data: userData, error: userError } = await supabase
          .from('master_users')
          .select(`
            full_name, is_gp,
            monday_hours, tuesday_hours, wednesday_hours,
            thursday_hours, friday_hours, saturday_hours, sunday_hours,
            monday_sessions, tuesday_sessions, wednesday_sessions,
            thursday_sessions, friday_sessions, saturday_sessions, sunday_sessions
          `)
          .or(`id.eq.${record.matched_user_id},auth_user_id.eq.${record.matched_user_id}`)
          .eq('site_id', ctx.site_id)
          .maybeSingle();

        if (userData) {
          const calculated = calculateHoursForDateRange(
            record.start_date,
            record.end_date,
            userData
          );

          // Update record with calculated values
          const updateData = {};
          if (userData.is_gp) {
            updateData.total_sessions = calculated.sessions;
            updateData.total_hours = null;
            updateData.total_days = calculated.sessions; // For GPs, total_days = sessions
          } else {
            updateData.total_hours = calculated.hours;
            updateData.total_sessions = null;
            updateData.total_days = calculated.hours / 7.5; // Convert hours to days (assuming 7.5 hour work day)
          }

          // Update the record first
          const { error: updateError } = await supabase
            .from('fuzzy_match_holidays')
            .update(updateData)
            .eq('id', recordId);

          if (updateError) {
            console.error('Failed to update calculated values:', updateError);
            throw updateError;
          }
        }
      } else if (!record.total_days) {
        // Calculate total_days from existing hours or sessions
        const updateData = {};
        if (record.total_sessions) {
          updateData.total_days = record.total_sessions; // For GPs
        } else if (record.total_hours) {
          updateData.total_days = record.total_hours / 7.5; // For staff
        }

        if (updateData.total_days) {
          const { error: updateError } = await supabase
            .from('fuzzy_match_holidays')
            .update(updateData)
            .eq('id', recordId);

          if (updateError) {
            console.error('Failed to update total_days:', updateError);
          }
        }
      }

      // Transfer using the database function
      const resolvedUserId = await resolveUserUuid(record.matched_user_id);
      const { data: transferResult, error: transferError } = await supabase
        .rpc('transfer_fuzzy_match_to_request', {
          p_fuzzy_match_id: parseInt(recordId),
          p_user_id: resolvedUserId
        });

      if (transferError) throw transferError;

      alert('Holiday successfully transferred');

      // Reload data
      await loadFuzzyStatistics();
      await loadFuzzyRecords();
    } catch (error) {
      console.error('Transfer failed:', error);
      alert('Failed to transfer: ' + error.message);
    }
  }

  async function unmatchFuzzyRecord(recordId) {
    if (!confirm('Remove the user match from this record?')) return;

    try {
      const { error } = await supabase
        .from('fuzzy_match_holidays')
        .update({
          matched_user_id: null,
          match_status: 'pending',
          matched_at: null
        })
        .eq('id', recordId)
        .eq('site_id', ctx.site_id);

      if (error) throw error;

      // Reload data
      await loadFuzzyStatistics();
      await loadFuzzyRecords();
    } catch (error) {
      console.error('Unmatch failed:', error);
      alert('Failed to unmatch: ' + error.message);
    }
  }

  // Bulk operation functions
  function toggleAllCheckboxes() {
    const selectAll = document.getElementById('fuzzy-select-all');
    const allCheckboxes = document.querySelectorAll('.fuzzy-record-checkbox');

    // Only toggle checkboxes in visible rows
    allCheckboxes.forEach(cb => {
      const row = cb.closest('tr');
      if (row && row.style.display !== 'none') {
        cb.checked = selectAll.checked;
      }
    });
  }

  async function deleteSelectedFuzzyRecords() {
    const allSelectedCheckboxes = document.querySelectorAll('.fuzzy-record-checkbox:checked');

    // Only include checkboxes from visible rows
    const selectedCheckboxes = Array.from(allSelectedCheckboxes).filter(cb => {
      const row = cb.closest('tr');
      return row && row.style.display !== 'none';
    });

    if (selectedCheckboxes.length === 0) {
      alert('Please select records to delete');
      return;
    }

    if (!confirm(`Delete ${selectedCheckboxes.length} selected record(s)?`)) {
      return;
    }

    const recordIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.recordId, 10));

    try {
      const { error } = await supabase
        .from('fuzzy_match_holidays')
        .delete()
        .eq('site_id', ctx.site_id)
        .in('id', recordIds);

      if (error) throw error;

      await loadFuzzyStatistics();
      await loadFuzzyRecords();
    } catch (error) {
      console.error('Bulk delete failed:', error);
      alert('Failed to delete selected records: ' + error.message);
    }
  }

  function filterFuzzyRecords() {
    const nameFilter = document.getElementById('fuzzy-name-filter').value.toLowerCase();
    const matchFilter = document.getElementById('fuzzy-match-filter').value;
    const rows = document.querySelectorAll('#fuzzy-existing-tbody tr');

    rows.forEach(row => {
      if (!row.dataset.recordId) return; // Skip header/empty rows

      const nameCell = row.cells[1]; // Name is in the second column (after checkbox)
      const statusAttr = row.dataset.status;

      let showRow = true;

      // Name filter
      if (nameFilter && nameCell) {
        const name = nameCell.textContent.toLowerCase();
        if (!name.includes(nameFilter)) {
          showRow = false;
        }
      }

      // Match status filter
      if (matchFilter) {
        // Check if row has matched_user_id set (for pending records that are matched)
        const userSelect = row.querySelector('.fuzzy-user-select');
        const hasMatchedUser = userSelect && userSelect.value;

        if (matchFilter === 'matched') {
          if (!(statusAttr === 'matched' || (statusAttr === 'pending' && hasMatchedUser))) {
            showRow = false;
          }
        } else if (matchFilter === 'pending') {
          if (!(statusAttr === 'pending' && !hasMatchedUser)) {
            showRow = false;
          }
        } else if (matchFilter !== statusAttr) {
          showRow = false;
        }
      }

      row.style.display = showRow ? '' : 'none';
    });
  }

  async function autoMatchAllPending() {
    const allPendingRecords = document.querySelectorAll('tr[data-status="pending"]');

    // Only include visible pending records
    const pendingRecords = Array.from(allPendingRecords).filter(row => {
      return row.style.display !== 'none';
    });

    if (pendingRecords.length === 0) {
      alert('No pending records to match');
      return;
    }

    if (!confirm(`Auto-match ${pendingRecords.length} pending record(s)?\n\nThis will match records where names exactly match existing users and transfer them immediately.`)) {
      return;
    }

    let matchedCount = 0;
    let failedCount = 0;
    const errors = [];

    for (const row of pendingRecords) {
      const recordId = row.dataset.recordId;
      const selectElement = document.getElementById(`user-select-${recordId}`);

      if (selectElement && selectElement.value) {
        // Only process if a user is selected (auto-matched)
        try {
          // Match and transfer
          const { error: matchError } = await supabase
            .from('fuzzy_match_holidays')
            .update({
              matched_user_id: selectElement.value,
              match_status: 'matched',
              matched_at: new Date().toISOString()
            })
            .eq('id', recordId)
            .eq('site_id', ctx.site_id);

          if (matchError) throw matchError;

          // Transfer to holiday requests
          const resolvedUserId = await resolveUserUuid(selectElement.value);
          const { error: transferError } = await supabase
            .rpc('transfer_fuzzy_match_to_request', {
              p_fuzzy_match_id: parseInt(recordId),
              p_user_id: resolvedUserId
            });

          if (transferError) throw transferError;

          matchedCount++;
        } catch (error) {
          failedCount++;
          errors.push(`Record ${recordId}: ${error.message}`);
        }
      }
    }

    // Show results
    let message = `Auto-match complete!\n`;
    message += `✅ Successfully matched and transferred: ${matchedCount}\n`;
    if (failedCount > 0) {
      message += `❌ Failed: ${failedCount}\n`;
      if (errors.length > 0) {
        message += `\nErrors:\n${errors.slice(0, 5).join('\n')}`;
      }
    }
    alert(message);

    // Reload data
    await loadFuzzyStatistics();
    await loadFuzzyRecords();
  }

  async function matchSelectedRecords() {
    const allSelectedCheckboxes = document.querySelectorAll('.fuzzy-record-checkbox:checked');

    // Only include checkboxes from visible rows
    const selectedCheckboxes = Array.from(allSelectedCheckboxes).filter(cb => {
      const row = cb.closest('tr');
      return row && row.style.display !== 'none';
    });

    if (selectedCheckboxes.length === 0) {
      alert('Please select records to match');
      return;
    }

    // Check that all selected records have users selected
    let missingUsers = [];
    selectedCheckboxes.forEach(cb => {
      const recordId = cb.dataset.recordId;
      const selectElement = document.getElementById(`user-select-${recordId}`);
      if (!selectElement || !selectElement.value) {
        const row = cb.closest('tr');
        const name = row.cells[1].textContent;
        missingUsers.push(name);
      }
    });

    if (missingUsers.length > 0) {
      alert(`Please select users for the following records:\n${missingUsers.join('\n')}`);
      return;
    }

    if (!confirm(`Match and transfer ${selectedCheckboxes.length} selected record(s)?`)) {
      return;
    }

    let successCount = 0;
    let failedCount = 0;
    const errors = [];

    for (const checkbox of selectedCheckboxes) {
      const recordId = checkbox.dataset.recordId;
      const selectElement = document.getElementById(`user-select-${recordId}`);
      const userId = selectElement.value;

      try {
        // Match and transfer
        const { error: matchError } = await supabase
          .from('fuzzy_match_holidays')
          .update({
            matched_user_id: userId,
            match_status: 'matched',
            matched_at: new Date().toISOString()
          })
          .eq('id', recordId)
          .eq('site_id', ctx.site_id);

        if (matchError) throw matchError;

        // Transfer to holiday requests
        const { error: transferError } = await supabase
          .rpc('transfer_fuzzy_match_to_request', {
            p_fuzzy_match_id: parseInt(recordId),
            p_user_id: await resolveUserUuid(userId)
          });

        if (transferError) throw transferError;

        successCount++;
      } catch (error) {
        failedCount++;
        errors.push(`Record ${recordId}: ${error.message}`);
      }
    }

    // Show results
    let message = `Batch processing complete!\n`;
    message += `✅ Successfully matched and transferred: ${successCount}\n`;
    if (failedCount > 0) {
      message += `❌ Failed: ${failedCount}\n`;
      if (errors.length > 0) {
        message += `\nErrors:\n${errors.slice(0, 5).join('\n')}`;
      }
    }
    alert(message);

    // Reload data
    await loadFuzzyStatistics();
    await loadFuzzyRecords();
  }

  function downloadFuzzyTemplate() {
    // Create workbook
    const wb = XLSX.utils.book_new();

    // Create sample data
    const data = [
      ['Staff Name', 'Start Date', 'End Date', 'Total Hours', 'Total Sessions', 'Reason'],
      ['John Smith', '2024-01-01', '2024-01-05', '40', '', 'Annual Leave'],
      ['Jane Doe', '2024-02-15', '2024-02-16', '', '2', 'Sick Leave'],
      ['Example: Use either Hours OR Sessions', '', '', '', '', ''],
    ];

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(data);

    // Set column widths
    ws['!cols'] = [
      { wch: 20 }, // Staff Name
      { wch: 15 }, // Start Date
      { wch: 15 }, // End Date
      { wch: 12 }, // Total Hours
      { wch: 15 }, // Total Sessions
      { wch: 30 }  // Reason
    ];

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Holiday Import Template');

    // Generate and download file
    XLSX.writeFile(wb, 'holiday_import_template.xlsx');
  }

  // New functions for auto-calculate functionality
  function updateHoursValue(index, value) {
    if (index < fuzzyUploadData.length) {
      fuzzyUploadData[index].total_hours = value ? parseFloat(value) : null;
    }
  }

  function updateSessionsValue(index, value) {
    if (index < fuzzyUploadData.length) {
      fuzzyUploadData[index].total_sessions = value ? parseFloat(value) : null;
    }
  }

  // Old auto-calculate functions removed - moved to Holiday Import Records section

  async function toggleCalculatedHours() {
    // Store current filter values
    const nameFilter = document.getElementById('fuzzy-name-filter').value;
    const matchFilter = document.getElementById('fuzzy-match-filter').value;

    // Reload records to apply the calculation toggle
    await loadFuzzyRecords();

    // Restore filter values
    setTimeout(() => {
      document.getElementById('fuzzy-name-filter').value = nameFilter;
      document.getElementById('fuzzy-match-filter').value = matchFilter;
      filterFuzzyRecords();
    }, 100);
  }

  async function calculateHoursForImported() {
    // Show confirmation dialog
    if (!confirm('Calculate hours/sessions from user working patterns?\n\nThis will update records where users have been matched.')) {
      return;
    }

    // Show processing message
    const successMsg = document.getElementById('fuzzy-success-message');
    const errorMsg = document.getElementById('fuzzy-error-message');

    successMsg.style.display = 'block';
    successMsg.textContent = '⏳ Calculating hours/sessions from working patterns...';
    errorMsg.style.display = 'none';

    try {
      // Get all pending and matched records with matched users
      const { data: records, error: fetchError } = await supabase
        .from('fuzzy_match_holidays')
        .select('*')
        .eq('site_id', ctx.site_id)
        .in('match_status', ['pending', 'matched'])
        .not('matched_user_id', 'is', null);

      if (fetchError) throw fetchError;

      if (!records || records.length === 0) {
        successMsg.textContent = '⚠️ No matched records found to calculate';
        setTimeout(() => { successMsg.style.display = 'none'; }, 3000);
        return;
      }

      let updatedCount = 0;
      let errors = [];

      // Process each record
      for (const record of records) {
        try {
          // Get the user's working pattern (try both id and auth_user_id)
          const { data: userData, error: userError } = await supabase
            .from('master_users')
            .select(`
              full_name,
              is_gp,
              monday_hours, tuesday_hours, wednesday_hours,
              thursday_hours, friday_hours, saturday_hours, sunday_hours,
              monday_sessions, tuesday_sessions, wednesday_sessions,
              thursday_sessions, friday_sessions, saturday_sessions, sunday_sessions
            `)
            .or(`id.eq.${record.matched_user_id},auth_user_id.eq.${record.matched_user_id}`)
            .eq('site_id', ctx.site_id)
            .maybeSingle();

          if (userError) {
            errors.push(`Error for ${record.staff_name}: ${userError.message}`);
            continue;
          }

          if (!userData) {
            console.log(`❌ No user data found for matched_user_id: ${record.matched_user_id}`);
            errors.push(`No user found for ${record.staff_name} (ID: ${record.matched_user_id})`);
            continue;
          }

          console.log(`📊 Calculating for ${userData.full_name}, is_gp: ${userData.is_gp}`);

          // Calculate hours/sessions for the date range
          const calculated = calculateHoursForDateRange(
            record.start_date,
            record.end_date,
            userData
          );

          console.log(`📅 Calculated result:`, calculated);

          // Update the record with calculated values
          const updateData = {};

          // Determine whether to use hours or sessions based on is_gp flag
          if (userData.is_gp) {
            updateData.total_sessions = calculated.sessions;
            updateData.total_hours = null;
            console.log(`🩺 GP user - using sessions: ${calculated.sessions}`);
          } else {
            updateData.total_hours = calculated.hours;
            updateData.total_sessions = null;
            console.log(`👤 Non-GP user - using hours: ${calculated.hours}`);
          }

          const { error: updateError } = await supabase
            .from('fuzzy_match_holidays')
            .update(updateData)
            .eq('id', record.id);

          if (updateError) {
            errors.push(`Failed to update ${record.staff_name}: ${updateError.message}`);
          } else {
            updatedCount++;
            console.log(`✅ Updated ${userData.full_name}: ${userData.is_gp ? calculated.sessions + ' sessions' : calculated.hours + ' hours'}`);
          }
        } catch (err) {
          errors.push(`Error processing ${record.staff_name}: ${err.message}`);
        }
      }

      // Show results
      if (updatedCount > 0) {
        successMsg.textContent = `✅ Successfully calculated hours/sessions for ${updatedCount} record${updatedCount > 1 ? 's' : ''}`;
        // Reload the records to show updated values
        await loadFuzzyRecords();
      }

      if (errors.length > 0) {
        errorMsg.style.display = 'block';
        errorMsg.textContent = `⚠️ Some errors occurred: ${errors.join(', ')}`;
        setTimeout(() => { errorMsg.style.display = 'none'; }, 5000);
      }

      setTimeout(() => {
        successMsg.style.display = 'none';
      }, 3000);

    } catch (error) {
      console.error('Failed to calculate hours:', error);
      errorMsg.style.display = 'block';
      errorMsg.textContent = `❌ Failed to calculate: ${error.message}`;
      successMsg.style.display = 'none';
      setTimeout(() => { errorMsg.style.display = 'none'; }, 5000);
    }
  }

  async function getUserWorkingPattern(staffName) {
    try {
      // Clean and prepare the staff name for search
      const originalName = staffName.trim();
      console.log(`🔍 Looking up working pattern for: "${originalName}"`);

      // Normalize the name for better matching - remove punctuation and normalize spacing
      const normalizedName = originalName
        .replace(/[.,]/g, ' ')  // Replace periods and commas with spaces
        .replace(/\s+/g, ' ')   // Normalize spaces
        .trim();

      // Try different name formats
      // 1. Original name
      // 2. Normalized name
      // 3. Name parts (for handling "LastName, FirstName" format or partial matches)
      
      // Get name parts
      const nameParts = normalizedName.split(' ');
      const firstName = nameParts[0] || '';
      const lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
      
      // For known users like "Ben Howard", add specific handling
      const knownUsers = {
        "ben howard": true,
        "benhoward": true,
        "ben.howard": true,
        "howard ben": true,
        "howard, ben": true
      };
      
      const lowerName = normalizedName.toLowerCase();
      const isKnownUser = knownUsers[lowerName] || 
                          (firstName.toLowerCase() === 'ben' && lastName.toLowerCase() === 'howard') ||
                          lowerName.includes('ben') && lowerName.includes('howard');
      
      console.log(`Name parts: First="${firstName}", Last="${lastName}", Known user? ${isKnownUser}`);
      
      // If it's a known problematic name like Ben Howard, do a direct lookup
      let userData = null;
      
      if (isKnownUser) {
        console.log(`Using specific lookup for known user (Ben Howard)`);
        const { data, error } = await supabase
          .from('master_users')
          .select(`
            email,
            is_gp,
            total_hours,
            total_sessions,
            monday_hours, tuesday_hours, wednesday_hours,
            thursday_hours, friday_hours, saturday_hours, sunday_hours,
            monday_sessions, tuesday_sessions, wednesday_sessions,
            thursday_sessions, friday_sessions, saturday_sessions, sunday_sessions
          `)
          .or(`full_name.ilike.%Ben Howard%,full_name.ilike.%Benjamin Howard%,email.eq.benhowardmagic@hotmail.com`)
          .eq('site_id', ctx.site_id)
          .limit(5);
          
        if (!error && data) {
          if (Array.isArray(data) && data.length > 0) {
            // Prefer the admin account (benhowardmagic@hotmail.com) for calculations
            const adminAccount = data.find(u => u.email === 'benhowardmagic@hotmail.com');
            if (adminAccount) {
              userData = adminAccount;
              console.log(`✅ Found Ben Howard admin account for calculations`);
            } else {
              userData = data[0];
              console.log(`✅ Found Ben Howard with direct lookup: ${data[0].email}`);
            }
          } else {
            userData = data;
            console.log(`✅ Found Ben Howard with direct lookup`);
          }
        }
      }
      
      // If still no data, try the general search approaches
      if (!userData) {
        // Try multiple query approaches
        const { data, error } = await supabase
          .from('master_users')
          .select(`
            full_name,
            is_gp,
            monday_hours, tuesday_hours, wednesday_hours,
            thursday_hours, friday_hours, saturday_hours, sunday_hours,
            monday_sessions, tuesday_sessions, wednesday_sessions,
            thursday_sessions, friday_sessions, saturday_sessions, sunday_sessions
          `)
          .or(`full_name.ilike.%${normalizedName}%,nickname.ilike.%${normalizedName}%,full_name.ilike.%${firstName}%${lastName}%,full_name.ilike.%${lastName}%${firstName}%`)
          .eq('site_id', ctx.site_id)
          .limit(10);  // Get a few results to find the best match

        if (error) {
          console.error(`❌ Error looking up ${originalName}:`, error);
        } else if (data && data.length > 0) {
          // Try to find exact match first
          const exactMatch = data.find(u => 
            u.full_name.toLowerCase() === normalizedName.toLowerCase()
          );
          
          if (exactMatch) {
            userData = exactMatch;
            console.log(`✅ Found exact match: ${exactMatch.full_name}`);
          } else {
            // Find the best match using similarity calculation
            let bestMatch = null;
            let bestScore = 0;
            
            for (const user of data) {
              const score = calculateSimilarity(normalizedName.toLowerCase(), user.full_name.toLowerCase());
              console.log(`Similarity score for ${user.full_name}: ${score}`);
              
              if (score > bestScore) {
                bestScore = score;
                bestMatch = user;
              }
            }
            
            if (bestMatch && bestScore > 0.5) { // Threshold for acceptable match
              userData = bestMatch;
              console.log(`✅ Found fuzzy match: ${bestMatch.full_name} (score: ${bestScore})`);
            }
          }
        }
      }

      if (!userData) {
        console.log(`⚠️ No working pattern found for ${originalName}, using default pattern`);
        // Return default working pattern (8 hours per weekday for staff, 2 sessions for GP)
        return {
          is_gp: false,
          monday_hours: 8, tuesday_hours: 8, wednesday_hours: 8,
          thursday_hours: 8, friday_hours: 8, saturday_hours: 0, sunday_hours: 0,
          monday_sessions: 2, tuesday_sessions: 2, wednesday_sessions: 2,
          thursday_sessions: 2, friday_sessions: 2, saturday_sessions: 0, sunday_sessions: 0
        };
      }

      console.log(`✅ Found working pattern for ${userData.full_name || originalName}:`, userData.is_gp ? 'GP' : 'Staff');
      return userData;
    } catch (err) {
      console.error('❌ Error fetching working pattern:', err);
      // Return default pattern on error
      return {
        is_gp: false,
        monday_hours: 8, tuesday_hours: 8, wednesday_hours: 8,
        thursday_hours: 8, friday_hours: 8, saturday_hours: 0, sunday_hours: 0,
        monday_sessions: 2, tuesday_sessions: 2, wednesday_sessions: 2,
        thursday_sessions: 2, friday_sessions: 2, saturday_sessions: 0, sunday_sessions: 0
      };
    }
  }

  function calculateHoursForDateRange(startDate, endDate, pattern) {
    if (!pattern) return { hours: null, sessions: null };

    const start = new Date(startDate);
    const end = new Date(endDate);
    let totalHours = 0;
    let totalSessions = 0;
    let daysCalculated = 0;

    const currentDate = new Date(start);
    while (currentDate <= end) {
      const dayName = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][currentDate.getDay()];

      if (pattern.is_gp) {
        const sessions = parseFloat(pattern[`${dayName}_sessions`] || 0);
        totalSessions += sessions;
        if (sessions > 0) daysCalculated++;
      } else {
        const hours = parseFloat(pattern[`${dayName}_hours`] || 0);
        totalHours += hours;
        if (hours > 0) daysCalculated++;
      }

      currentDate.setDate(currentDate.getDate() + 1);
    }

    console.log(`📊 Calculated for ${daysCalculated} working days:`, pattern.is_gp ? `${totalSessions} sessions` : `${totalHours} hours`);

    return {
      hours: pattern.is_gp ? null : (totalHours > 0 ? totalHours : null),
      sessions: pattern.is_gp ? (totalSessions > 0 ? totalSessions : null) : null
    };
  }

  // Export fuzzy match functions
  window.loadFuzzyMatch = loadFuzzyMatch;
  window.handleFuzzyFileUpload = handleFuzzyFileUpload;
  window.showFuzzyPreview = showFuzzyPreview;
  window.parseExcelDate = parseExcelDate;
  window.confirmFuzzyUpload = confirmFuzzyUpload;
  window.cancelFuzzyUpload = cancelFuzzyUpload;
  window.deleteFuzzyRecord = deleteFuzzyRecord;
  window.downloadFuzzyTemplate = downloadFuzzyTemplate;
  window.matchAndTransferFuzzyRecord = matchAndTransferFuzzyRecord;
  window.transferFuzzyRecord = transferFuzzyRecord;
  window.unmatchFuzzyRecord = unmatchFuzzyRecord;
  window.toggleAllCheckboxes = toggleAllCheckboxes;
  window.filterFuzzyRecords = filterFuzzyRecords;
  window.autoMatchAllPending = autoMatchAllPending;
  window.deleteSelectedFuzzyRecords = deleteSelectedFuzzyRecords;
  window.matchSelectedRecords = matchSelectedRecords;
  window.updateHoursValue = updateHoursValue;
  window.updateSessionsValue = updateSessionsValue;
  window.calculateHoursForImported = calculateHoursForImported;
  window.toggleCalculatedHours = toggleCalculatedHours;
  // Removed toggleAutoCalculate - functionality moved to Holiday Import Records


  function setActiveSection(id){
    if(!id) return;
    
    // Permission check removed - all sections accessible once logged in
    
    console.log('setActiveSection called with:', id);
    const btn = nav.querySelector(`button[data-section="${id}"]`);
    if(!btn) return;
    // active state
    nav.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    // show view
    views.forEach(v => v.classList.remove("active"));
    // Check both with and without "view-" prefix for backward compatibility
    let viewEl = document.getElementById("view-"+id);
    if(!viewEl) viewEl = document.getElementById(id);
    if(viewEl) viewEl.classList.add("active");
    
    // Load section data
    switch(id) {
      case 'dashboard':
        Promise.all([
          loadCounts(),
          loadDue(),
          loadActivity(),
          loadWeekCalendar()
        ]);
        break;
      case 'items':
        loadItems();
        break;
      case 'rooms':
        loadRooms();
        break;
      case 'complaints':
        loadComplaints();
        break;
      case 'checktypes':
        loadCheckTypes();
        
        // Fix layout issue: ensure checktypes view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-checktypes');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'schedules':
        loadSchedules();
        
        // Fix layout issue: ensure schedules view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-schedules');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'staff':
        loadStaff();
        
        // Fix layout issue: ensure staff view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-staff');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'submissions':
        loadSubmissions();
        
        // Fix layout issue: ensure submissions view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-submissions');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'pre-inspection':
        loadAndRenderPIR();
        break;
      case 'complaints-dashboard':
        // Load complaints list (for dashboard widgets) and dashboard stats
        loadComplaintsDashboard();
        break;
      case 'complaints-reporting':
        // Load complaints list for reporting (table/filter/export)
        loadComplaints();
        
        // Fix layout issue: ensure complaints-reporting view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-complaints-reporting');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'calendar':
        loadAndRenderCalendar();
        break;
      case 'settings':
        // Initialize debug features on Site Settings page
        initPageVisibilityToggles();
        // Load site feature settings
        loadSiteSettings();

        // Fix layout issue: ensure settings view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-settings');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'users':
        // Users page hosts practice users listing and invite management
        loadPracticeUsers();
        break;
      case 'fuzzy-match':
        // Check if loadFuzzyMatch is available
        if (typeof loadFuzzyMatch === 'function') {
          console.log('✅ Calling loadFuzzyMatch function');
          loadFuzzyMatch();
        } else if (typeof window.loadFuzzyMatch === 'function') {
          console.log('✅ Calling window.loadFuzzyMatch function');
          window.loadFuzzyMatch();
        } else {
          console.error('❌ loadFuzzyMatch function not found!');
          console.log('Available functions:', Object.keys(window).filter(k => k.includes('Fuzzy')));
          // Try to call it directly in case of scope issues
          setTimeout(() => {
            if (typeof window.loadFuzzyMatch === 'function') {
              console.log('✅ Found loadFuzzyMatch after delay, loading now...');
              window.loadFuzzyMatch();
            } else {
              console.error('❌ loadFuzzyMatch still not available after delay');
              // Show error to user
              const content = document.querySelector('.fuzzy-match-content');
              if (content) {
                content.innerHTML = '<div class="p-4 bg-red-50 border border-red-200 rounded text-red-700">Error: Failed to load Holiday Import Records. Please refresh the page (Ctrl+Shift+R or Cmd+Shift+R).</div>';
              }
            }
          }, 1000);
        }
        break;
      case 'training-import':
        // Check if loadTrainingImport is defined (it's defined later in the script)
        if (typeof loadTrainingImport === 'function') {
          loadTrainingImport();
        } else if (typeof window.loadTrainingImport === 'function') {
          window.loadTrainingImport();
        } else {
          console.error('❌ loadTrainingImport function not found!');
          // Try to load it after a delay when the script has fully loaded
          setTimeout(() => {
            if (typeof window.loadTrainingImport === 'function') {
              console.log('✅ Found loadTrainingImport after delay, loading now...');
              window.loadTrainingImport();
            } else {
              console.error('❌ loadTrainingImport still not available after delay');
            }
          }, 1000);
        }
        break;
      case 'training':
        // Ensure proper tab state initialization
        currentTrainingTab = 'clinical';
        document.querySelectorAll('#view-training .tab-controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('tab-clinical')?.classList.add('active');
        // Check if loadTrainingMatrix is defined, otherwise wait for it
        if (typeof loadTrainingMatrix === 'function') {
          loadTrainingMatrix();
        } else if (typeof window.loadTrainingMatrix === 'function') {
          window.loadTrainingMatrix();
        } else {
          console.log('loadTrainingMatrix not yet defined, will be called by shim');
        }
        break;
      case 'entitlement-management':
        loadHolidayData();
        // Ensure card layout is loaded
        if (typeof loadStaffEntitlementCards === 'function') {
          loadStaffEntitlementCards();
        }
        break;
      case 'working-hours':
        loadWorkingHours();
        break;
      case 'scheduling-dashboard':
        loadSchedulingDashboard();
        break;
    }
    
    // persist
    try { localStorage.setItem("cl_active_section", id); } catch(_) {}
  }

  nav.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-section]");
    if(!btn) return;
    const id = btn.getAttribute("data-section");
    
    // Permission check removed - all sections accessible once logged in
    
    setActiveSection(id);
    
    // Special handling for settings and users sections
    if (id === 'settings') {
      setTimeout(() => {
        // initDebugToggle(); // Removed - debug window no longer exists
      }, 100);
    }
    if (id === 'users') {
      setTimeout(() => {
        loadPracticeUsers();
      }, 100);
    }
    
    // Special handling for training section
    if (id === 'training') {
      setTimeout(() => {
        // Ensure proper tab state initialization
        currentTrainingTab = 'clinical';
        document.querySelectorAll('#view-training .tab-controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('tab-clinical')?.classList.add('active');
        // Check if loadTrainingMatrix is defined, otherwise wait for it
        if (typeof loadTrainingMatrix === 'function') {
          loadTrainingMatrix();
        } else if (typeof window.loadTrainingMatrix === 'function') {
          window.loadTrainingMatrix();
        } else {
          console.log('loadTrainingMatrix not yet defined, will be called by shim');
        }
      }, 100); // Small delay to ensure context is loaded
    }
  });

  // Helper function to check if user has access to a page
  // MODIFIED: Always returns true to remove all access restrictions
  function hasPageAccess(pageName) {
    return true; // All pages are accessible once logged in
  }

  // Fetch dashboard-specific stats (most common categories, statuses, counts)
  async function fetchComplaintsDashboardStats(){
    try{
      if(!ctx.site_id) return;
      // fetch last 30 days complaints
      const start = new Date(); start.setDate(start.getDate()-29);
      const { data, error } = await supabase.from('complaints').select('id, category, status, datetime, share_with_team').eq('site_id', ctx.site_id).gte('datetime', start.toISOString());
      if(error) return console.warn('dashboard stats fetch error', error.message);
      const counts = { total: 0, open:0, resolved:0, shared:0 };
      const byCategory = {};
      const byStatus = {};
      (data||[]).forEach(r=>{
        counts.total++;
        if((r.status||'').toLowerCase() === 'resolved') counts.resolved++; else counts.open++;
        if(r.share_with_team) counts.shared++;
        const cat = r.category || 'Unspecified'; byCategory[cat] = (byCategory[cat]||0)+1;
        const st = r.status || 'unknown'; byStatus[st] = (byStatus[st]||0)+1;
      });
      
      // Animate the counter numbers
      animateCounter('cmp-total', counts.total);
      animateCounter('cmp-open', counts.open);
      animateCounter('cmp-resolved', counts.resolved);
      animateCounter('cmp-share', counts.shared);
      
      // render top categories with animations
      const catEl = document.getElementById('cmp-top-categories');
      if(catEl){
        const items = Object.entries(byCategory).sort((a,b)=>b[1]-a[1]).slice(0,8);
        if(items.length === 0) {
          catEl.innerHTML = '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 40px 20px; font-style: italic;">No complaints in the last 30 days - Excellent service delivery! 🌟</div>';
        } else {
          catEl.innerHTML = items.map((i,idx)=>`
            <div style="display:flex; justify-content:space-between; align-items: center; padding:14px 18px; margin:10px 0; background:linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); border-radius:12px; border-left:4px solid var(--accent-1); transition:all 0.3s ease; animation:fadeInUp 0.6s ease-out; animation-delay:${idx*0.1}s; opacity:0; animation-fill-mode:forwards; cursor: pointer;" onmouseover="this.style.transform='translateX(4px)'; this.style.background='linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1))'" onmouseout="this.style.transform='translateX(0)'; this.style.background='linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08))'">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-weight:600; color: white; font-size: 1rem;">${esc(i[0])}</div>
                <div style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; color: white;">Priority</div>
              </div>
              <div style="font-weight:800; color:var(--accent-1); font-size: 1.4rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${i[1]}</div>
            </div>
          `).join('');
        }
      }
      const stEl = document.getElementById('cmp-status-breakdown');
      if(stEl){
        const items = Object.entries(byStatus).sort((a,b)=>b[1]-a[1]);
        if(items.length === 0) {
          stEl.innerHTML = '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px; font-style: italic;">No status data available</div>';
        } else {
          stEl.innerHTML = items.map((i,idx)=>{
            const statusColors = {
              'resolved': '#22c55e',
              'closed': '#22c55e', 
              'open': '#f59e0b',
              'investigating': '#3b82f6',
              'pending': '#ef4444'
            };
            const color = statusColors[i[0].toLowerCase()] || 'var(--accent-2)';
            const statusEmoji = {
              'resolved': '✅',
              'closed': '✅',
              'open': '🔍', 
              'investigating': '⚠️',
              'pending': '⏳'
            };
            const emoji = statusEmoji[i[0].toLowerCase()] || '📋';
            
            return `
            <div style="display:flex; justify-content:space-between; align-items: center; padding:14px 18px; margin:10px 0; background:linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); border-radius:12px; border-left:4px solid ${color}; transition:all 0.3s ease; animation:fadeInUp 0.6s ease-out; animation-delay:${idx*0.1}s; opacity:0; animation-fill-mode:forwards; cursor: pointer;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.2rem;">${emoji}</span>
                <div style="font-weight:600; color: white; text-transform: capitalize;">${esc(i[0])}</div>
              </div>
              <div style="font-weight:800; color:${color}; font-size: 1.4rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${i[1]}</div>
            </div>
            `;
          }).join('');
        }
      }

      // Generate trend data for last 30 days
      const trendData = {};
      for(let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const key = date.toISOString().slice(0, 10);
        trendData[key] = 0;
      }
      
      // Count complaints by day
      (data||[]).forEach(r => {
        if(r.datetime) {
          const day = r.datetime.slice(0, 10);
          if(trendData.hasOwnProperty(day)) {
            trendData[day]++;
          }
        }
      });

      // Draw trend chart
      drawDashboardTrend(trendData);
    }catch(err){ console.error('fetchComplaintsDashboardStats failed', err); }
  }

  // Draw trend chart specifically for dashboard
  function drawDashboardTrend(trendData) {
    const trendSvg = document.getElementById('dashboard-trend-chart');
    if (!trendSvg) return;

    const days = Object.keys(trendData).sort();
    const values = days.map(day => trendData[day]);
    const w = 600, h = 120;
    const max = Math.max(1, ...values);
    
    const points = values.map((v,i)=> (i*(w/(values.length-1))) + ',' + (h - (v/max)*(h-20))).join(' ');
    
    trendSvg.setAttribute('viewBox','0 0 '+w+' '+h);
    trendSvg.innerHTML = `
      <defs>
        <linearGradient id="dashboardTrendGradient" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
          <stop offset="50%" style="stop-color:#764ba2;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="dashboardAreaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#667eea;stop-opacity:0.3" />
          <stop offset="100%" style="stop-color:#667eea;stop-opacity:0.05" />
        </linearGradient>
        <filter id="dashboardGlow">
          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
          <feMerge> 
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      
      <!-- Area fill -->
      <path fill="url(#dashboardAreaGradient)" d="M0,${h} L${points.split(' ').map(p => p.replace(',', ' L')).join(' ')} L${w},${h} Z" opacity="0">
        <animate attributeName="opacity" from="0" to="1" dur="1.5s" fill="freeze"/>
      </path>
      
      <!-- Main trend line with glow -->
      <polyline fill="none" stroke="url(#dashboardTrendGradient)" stroke-width="4" 
                points="${points}" stroke-linejoin="round" stroke-linecap="round"
                filter="url(#dashboardGlow)" stroke-dasharray="${w*2}" stroke-dashoffset="${w*2}">
        <animate attributeName="stroke-dashoffset" from="${w*2}" to="0" dur="2s" fill="freeze"/>
      </polyline>
      
      <!-- Animated data points -->
      ${values.map((v,i) => {
        const x = i*(w/(values.length-1));
        const y = h - (v/max)*(h-20);
        return `
          <circle cx="${x}" cy="${y}" r="0" fill="#fff" stroke="url(#dashboardTrendGradient)" stroke-width="2">
            <animate attributeName="r" from="0" to="4" dur="0.5s" begin="${0.1*i}s" fill="freeze"/>
          </circle>
          <circle cx="${x}" cy="${y}" r="0" fill="url(#dashboardTrendGradient)" opacity="0.3">
            <animate attributeName="r" from="0" to="8" dur="0.8s" begin="${0.1*i}s" fill="freeze"/>
            <animate attributeName="opacity" from="0.5" to="0" dur="2s" begin="${0.1*i}s" repeatCount="indefinite"/>
          </circle>
        `;
      }).join('')}
    `;
  }

  // Animated counter function
  function animateCounter(elementId, targetValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const startValue = 0;
    const duration = 1500; // 1.5 seconds
    const startTime = performance.now();
    
    function updateCounter(currentTime) {
      const elapsedTime = currentTime - startTime;
      const progress = Math.min(elapsedTime / duration, 1);
      
      // Easing function for smooth animation
      const easedProgress = 1 - Math.pow(1 - progress, 3);
      const currentValue = Math.floor(startValue + (targetValue - startValue) * easedProgress);
      
      element.textContent = currentValue;
      element.style.transform = `scale(${1 + Math.sin(progress * Math.PI) * 0.1})`;
      
      if (progress < 1) {
        requestAnimationFrame(updateCounter);
      } else {
        element.style.transform = 'scale(1)';
        // Add a subtle pulse effect when done
        element.style.animation = 'pulse 2s ease-in-out infinite';
      }
    }
    
    requestAnimationFrame(updateCounter);
  }

  // Add dashboard interactivity
  document.addEventListener('DOMContentLoaded', function() {
    // Wire up dashboard navigation buttons
    const openReportingBtn = document.getElementById('btn-open-complaints-reporting');
    const refreshBtn = document.getElementById('btn-refresh-complaints-dashboard');
    
    if (openReportingBtn) {
      openReportingBtn.addEventListener('click', () => {
        setActiveSection('complaints-reporting');
      });
    }
    
    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        // Add loading animation
        refreshBtn.style.transform = 'rotate(360deg)';
        refreshBtn.style.transition = 'transform 0.8s ease';
        
        // Refresh dashboard data
        setTimeout(() => {
          if (document.getElementById('view-complaints-dashboard').classList.contains('active')) {
            loadComplaints();
            fetchComplaintsDashboardStats();
          }
          refreshBtn.style.transform = 'rotate(0deg)';
        }, 800);
      });
    }
    
    // Add hover effects for stat cards
    const statCards = document.querySelectorAll('#view-complaints-dashboard .stat-card');
    statCards.forEach((card, index) => {
      card.addEventListener('mouseenter', () => {
        card.style.transform = 'translateY(-8px) scale(1.02)';
        card.style.boxShadow = '0 25px 50px rgba(0,0,0,0.15)';
      });
      
      card.addEventListener('mouseleave', () => {
        card.style.transform = 'translateY(0) scale(1)';
        card.style.boxShadow = '0 8px 32px rgba(0,0,0,0.1)';
      });
    });

    // Wire up schedules filter event listeners
    const schedulesFilters = [
      'schedules-filter-room',
      'schedules-filter-check', 
      'schedules-filter-frequency',
      'schedules-filter-required'
    ];
    
    schedulesFilters.forEach(filterId => {
      const filter = document.getElementById(filterId);
      if (filter) {
        filter.addEventListener('change', () => {
          if (schedulesData && schedulesData.length > 0) {
            applySchedulesFilters();
          }
        });
      }
    });

    const schedulesSearch = document.getElementById('schedules-search');
    if (schedulesSearch) {
      schedulesSearch.addEventListener('input', () => {
        if (schedulesData && schedulesData.length > 0) {
          applySchedulesFilters();
        }
      });
    }
  });

  // Add particle effects for dashboard background
  function createParticles() {
    const dashboard = document.getElementById('view-complaints-dashboard');
    if (!dashboard) return;
    
    for (let i = 0; i < 20; i++) {
      const particle = document.createElement('div');
      particle.style.cssText = `
        position: absolute;
        width: 4px;
        height: 4px;
        background: linear-gradient(45deg, var(--accent-1), var(--accent-2));
        border-radius: 50%;
        pointer-events: none;
        opacity: 0.6;
        animation: float 6s ease-in-out infinite;
        animation-delay: ${Math.random() * 6}s;
        left: ${Math.random() * 100}%;
        top: ${Math.random() * 100}%;
      `;
      dashboard.appendChild(particle);
    }
  }
  
  // Float animation for particles
  const style = document.createElement('style');
  style.textContent = `
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-20px) rotate(120deg); }
      66% { transform: translateY(-10px) rotate(240deg); }
    }
  `;
  document.head.appendChild(style);

  // (Removed duplicate nav group toggle logic to avoid conflicts with manageNavGroups above)

  // User Management System
  const inviteUserModal = document.getElementById('invite-user-modal');
  const inviteUserForm = document.getElementById('invite-user-form');
  // Debug console removed; `window.debugLog` is a noop defined in the page head

  // Load job roles from kiosk_roles table
  async function loadJobRolesFromKiosk() {
    try {
      console.log('Loading job roles from kiosk_roles table');
      const roleSelect = document.getElementById('add-user-role');
      
      if (!roleSelect) {
        console.error('Job role select element not found!');
        return;
      }

      // Clear existing options, keep the first placeholder option
      roleSelect.innerHTML = '<option value="">Select job role</option>';

      // Fetch roles from kiosk_roles table
      const { data: roles, error } = await supabase
        .from('kiosk_roles')
        .select('role')
        .order('role');

      if (error) {
        console.error('Failed to load job roles from kiosk_roles table', error);
        // Fall back to default roles
        const defaultRoles = [
          'GP',
          'Nurse',
          'Practice Manager',
          'Admin Assistant',
          'Receptionist',
          'Healthcare Assistant',
          'Pharmacist',
          'Other'
        ];
        
        defaultRoles.forEach(role => {
          roleSelect.innerHTML += `<option value="${role}">${esc(role)}</option>`;
        });
      } else if (roles && roles.length > 0) {
        // Add roles from database to the dropdown
        roles.forEach(role => {
          roleSelect.innerHTML += `<option value="${esc(role.role)}">${esc(role.role)}</option>`;
        });
      } else {
        console.warn('No job roles found in kiosk_roles table');
      }
    } catch (error) {
      console.error('Error loading job roles:', error);
    }
  }

  // Show Invite User Modal
  function showInviteUserModal() {
    inviteUserModal.classList.add('show');
    
    // Hide error and success messages
    const errorElement = document.getElementById('add-user-error');
    const successElement = document.getElementById('add-user-success');
    if (errorElement) errorElement.style.display = 'none';
    if (successElement) successElement.style.display = 'none';
    
    // Make sure we have valid references to all elements
    const form = document.getElementById('invite-user-form');
    const submitBtn = document.getElementById('invite-user-submit');
    
    if (!form) {
      console.error('Invite user form element not found!');
    }
    
    if (!submitBtn) {
      console.error('Submit button not found!');
    } else {
      // Ensure button is enabled
      submitBtn.disabled = false;
      submitBtn.textContent = '📧 Send Invitation';
    }
    
    if (form) {
      form.reset();
      
      // Re-attach the submit event listener to be safe
      form.removeEventListener('submit', handleInviteUserFormSubmit);
      form.addEventListener('submit', handleInviteUserFormSubmit);
    }

    // Load teams and job roles for dropdowns
    loadTeamsForDropdown();
    loadJobRolesFromKiosk();

    console.log('Invite User modal opened');
  }

  function closeInviteUserModal() {
    inviteUserModal.classList.remove('show');
  }

  document.getElementById('btn-invite-user')?.addEventListener('click', showInviteUserModal);
  document.getElementById('invite-user-modal-close')?.addEventListener('click', closeInviteUserModal);
  document.getElementById('invite-user-cancel-btn')?.addEventListener('click', closeInviteUserModal);
  
  // Add a direct click handler for the submit button as a fallback
  document.addEventListener('DOMContentLoaded', () => {
    const submitBtn = document.getElementById('invite-user-submit');
      if (submitBtn) {
      console.log('Adding backup click handler to invite-user-submit button');
      submitBtn.addEventListener('click', (e) => {
        console.log('Submit button clicked directly');
        const form = submitBtn.closest('form');
        if (form) {
          e.preventDefault(); // Prevent double submission
          console.log('Manually submitting the form');
          form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        }
      });
    } else {
      console.error('Could not find invite-user-submit button for backup handler');
    }
  });

  // Load teams from teams table
  async function loadTeamsForDropdown() {
    const teamSelect = document.getElementById('add-user-team');
    if (!teamSelect) {
      console.error('Team select element not found!');
      return;
    }
    teamSelect.innerHTML = '<option value="">Select team (optional)</option>';

    try {
      // Ensure context is loaded
      if (!window.ctx || !ctx.site_id) {
        console.log('Context not loaded, attempting to load...');
        try {
          await loadContext();
          console.log('Context loaded successfully, site_id:', ctx?.site_id);
        } catch (e) {
          console.error('Failed to load context:', e);
        }
      }

      if (!window.ctx || !ctx.site_id) {
        console.warn('No site_id in context; cannot load teams');
        // Try to load teams without site filter as fallback
        console.log('Attempting to load all teams as fallback...');
        const { data: allTeams, error: allError } = await supabase
          .from('teams')
          .select('id, name, site_id')
          .order('name');

        if (!allError && allTeams && allTeams.length > 0) {
          console.log(`Found ${allTeams.length} teams across all sites`);
          teamSelect.innerHTML = '<option value="">Select team</option>';
          allTeams.forEach(t => {
            teamSelect.innerHTML += `<option value="${t.id}">${esc(t.name)} ${t.site_id ? `(Site ${t.site_id})` : ''}</option>`;
          });
          return;
        }
        teamSelect.innerHTML = '<option value="">No teams available</option>';
        return;
      }

      console.log('Loading teams from teams table for site', ctx.site_id);
      const { data: teams, error } = await supabase
        .from('teams')
        .select('id, name')
        .eq('site_id', ctx.site_id)
        .order('name');

      if (error) {
        console.error('Failed to load teams for site', ctx.site_id, error);

        // Try without site filter as fallback
        console.log('Trying to load teams without site filter...');
        const { data: allTeams, error: allError } = await supabase
          .from('teams')
          .select('id, name')
          .order('name');

        if (!allError && allTeams && allTeams.length > 0) {
          console.log(`Loaded ${allTeams.length} teams (all sites)`);
          teamSelect.innerHTML = '<option value="">Select team</option>';
          allTeams.forEach(t => {
            teamSelect.innerHTML += `<option value="${t.id}">${esc(t.name)}</option>`;
          });
        } else {
          const msg = (error && (error.message || error.error_description)) || '';
          if (String(msg).toLowerCase().includes('policy') || String(msg).toLowerCase().includes('rls')) {
            console.warn('RLS/policy prevented team select; showing fallback teams');
            // Show newly created teams with correct IDs
            [
              { id: 'clinical', name: 'Clinical Team' },
              { id: 'admin', name: 'Admin Team' },
              { id: 'reception', name: 'Reception' },
              { id: 'management', name: 'Management' },
              { id: 'nursing', name: 'Nursing' },
              { id: 'support', name: 'Support Staff' }
            ].forEach(t => teamSelect.innerHTML += `<option value="${t.id}">${esc(t.name)}</option>`);
          } else {
            teamSelect.innerHTML = '<option value="">Error loading teams</option>';
            console.error('All attempts to load teams failed');
          }
        }
        return;
      }

      if (Array.isArray(teams) && teams.length > 0) {
        console.log(`Successfully loaded ${teams.length} teams for site ${ctx.site_id}`);
        teams.forEach(t => teamSelect.innerHTML += `<option value="${t.id}">${esc(t.name)}</option>`);
      } else {
        console.log('No teams returned for site', ctx.site_id);
        // Try to load all teams as fallback
        const { data: allTeams } = await supabase
          .from('teams')
          .select('id, name')
          .order('name');

        if (allTeams && allTeams.length > 0) {
          console.log(`Loading ${allTeams.length} teams from all sites as fallback`);
          allTeams.forEach(t => {
            teamSelect.innerHTML += `<option value="${t.id}">${esc(t.name)}</option>`;
          });
        }
      }
    } catch (err) {
      console.error('Unexpected error loading teams:', err);
      // Show generic teams as last resort
      [
        { id: 'clinical', name: 'Clinical Team' },
        { id: 'admin', name: 'Admin Team' },
        { id: 'reception', name: 'Reception' },
        { id: 'management', name: 'Management' }
      ].forEach(t => teamSelect.innerHTML += `<option value="${t.id}">${esc(t.name)}</option>`);
    }
  }

  // Role change handler - working pattern removed, staff will set during welcome
  document.getElementById('add-user-role')?.addEventListener('change', function() {
    console.log('Role changed to:', this.value);
  });

  // Training stub functions
  function openTrainingTypesModal() {
    // Create a modal for managing training types
    let modal = document.getElementById('training-types-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'training-types-modal';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h3>Manage Training Types</h3>
            <button class="modal-close" onclick="closeTrainingTypesModal()">&times;</button>
          </div>
          <div class="modal-body">
            <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
              <button class="btn" onclick="addTrainingType()">Add New Type</button>
              <button class="btn secondary" onclick="refreshTrainingTypes()">Refresh</button>
            </div>
            <div id="training-types-list">
              <p>Loading training types...</p>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn secondary" onclick="closeTrainingTypesModal()">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    // Load training types
    loadTrainingTypesForManagement();
    modal.classList.add('show');
  }
  
  function closeTrainingTypesModal() {
    const modal = document.getElementById('training-types-modal');
    if (modal) modal.classList.remove('show');
  }
  
  async function loadTrainingTypesForManagement() {
    const container = document.getElementById('training-types-list');
    try {
      const { data, error } = await supabase
        .from('training_types')
        .select('*')
        .eq('site_id', ctx.site_id)
        .order('name');
      
      if (error) throw error;
      
      if (!data || data.length === 0) {
        container.innerHTML = '<p>No training types found.</p>';
        return;
      }
      
      const table = `
        <table style="width: 100%; margin-top: 12px;">
          <thead>
            <tr style="background: var(--glass-2);">
              <th style="padding: 12px; text-align: left;">Name</th>
              <th style="padding: 12px; text-align: left;">Description</th>
              <th style="padding: 12px; text-align: center;">Active</th>
              <th style="padding: 12px; text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(type => `
              <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: 12px;">${esc(type.name || '')}</td>
                <td style="padding: 12px;">${esc(type.description || 'No description')}</td>
                <td style="padding: 12px; text-align: center;">
                  <span style="color: ${type.active ? '#10b981' : '#ef4444'};">
                    ${type.active ? '✅ Yes' : '❌ No'}
                  </span>
                </td>
                <td style="padding: 12px; text-align: center;">
                  <button class="btn secondary" style="margin-right: 8px;" onclick="editTrainingType(${type.id})">Edit</button>
                  <button class="btn" style="background: #ef4444;" onclick="toggleTrainingTypeActive(${type.id}, ${!type.active})">${type.active ? 'Deactivate' : 'Activate'}</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = table;
      
    } catch (error) {
      container.innerHTML = `<p style="color: red;">Error loading training types: ${error.message}</p>`;
    }
  }
  
  function addTrainingType() {
    const name = prompt('Enter training type name:');
    if (!name) return;
    
    const description = prompt('Enter description (optional):') || '';
    
    createTrainingType(name, description);
  }
  
  async function createTrainingType(name, description) {
    try {
      const { error } = await supabase
        .from('training_types')
        .insert({
          name: name,
          description: description,
          site_id: ctx.site_id,
          active: true
        });
      
      if (error) throw error;
      
      alert('Training type created successfully!');
      loadTrainingTypesForManagement();
      // Refresh the main training matrix
      if (typeof loadTrainingMatrix === 'function') {
        loadTrainingMatrix();
      }
    } catch (error) {
      alert('Failed to create training type: ' + error.message);
    }
  }
  
  async function toggleTrainingTypeActive(id, newActiveState) {
    try {
      const { error } = await supabase
        .from('training_types')
        .update({ active: newActiveState })
        .eq('id', id);
      
      if (error) throw error;
      
      alert(`Training type ${newActiveState ? 'activated' : 'deactivated'} successfully!`);
      loadTrainingTypesForManagement();
      // Refresh the main training matrix
      if (typeof loadTrainingMatrix === 'function') {
        loadTrainingMatrix();
      }
    } catch (error) {
      alert('Failed to update training type: ' + error.message);
    }
  }
  
  function editTrainingType(id) {
    // This could open a more detailed editing modal
    alert(`Edit functionality for training type ID ${id} would be implemented here. For now, use the Activate/Deactivate buttons to manage training types.`);
  }
  
  async function exportTrainingReport() {
    try {
      if (!window.trainingData || !window.trainingData.staff || !window.trainingData.types || !window.trainingData.records) {
        alert('No training data available to export. Please ensure the training matrix has loaded.');
        return;
      }
      
      const { staff, types, records } = window.trainingData;
      
      if (!staff.length || !types.length) {
        alert('Insufficient training data to export.');
        return;
      }
      
      // Prepare export data
      const exportData = [];
      
      staff.forEach(staffMember => {
        const row = {
          'Staff Name': staffMember.full_name || '',
          'Role': staffMember.role || '',
          'Department': staffMember.department || ''
        };
        
        // Add training status for each training type
        types.forEach(trainingType => {
          const record = records.find(r => 
            r.staff_id === staffMember.id && r.training_type_id === trainingType.id
          );
          
          if (record) {
            const completionDate = record.completion_date ? new Date(record.completion_date).toLocaleDateString() : '';
            const expiryDate = record.expiry_date ? new Date(record.expiry_date).toLocaleDateString() : '';
            const status = record.expiry_date && new Date(record.expiry_date) < new Date() ? 'Expired' : 
                          record.expiry_date && new Date(record.expiry_date) < new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) ? 'Expiring Soon' : 'Valid';
            
            row[trainingType.name] = `${status} (Completed: ${completionDate}, Expires: ${expiryDate})`;
          } else {
            row[trainingType.name] = 'Not Completed';
          }
        });
        
        exportData.push(row);
      });
      
      // Use the existing downloadCSV function
      downloadCSV(exportData, `training-matrix-export-${new Date().toISOString().split('T')[0]}.csv`);
      
    } catch (error) {
      console.error('Training export failed:', error);
      alert('Failed to export training report: ' + (error.message || error));
    }
  }

  // Training event listeners
  document.getElementById('tab-clinical')?.addEventListener('click', () => switchTrainingTab('clinical'));
  document.getElementById('tab-non-clinical')?.addEventListener('click', () => switchTrainingTab('non-clinical'));
  document.getElementById('btn-manage-training-types')?.addEventListener('click', openTrainingTypesModal);
  document.getElementById('btn-export-training')?.addEventListener('click', exportTrainingReport);
  document.getElementById('training-modal-close')?.addEventListener('click', closeTrainingModal);
  document.getElementById('training-cancel-btn')?.addEventListener('click', closeTrainingModal);
  document.getElementById('training-form')?.addEventListener('submit', saveTrainingRecord);
  document.getElementById('training-certificate')?.addEventListener('change', handleTrainingFileUpload);
  document.getElementById('training-completion-date')?.addEventListener('change', calculateTrainingExpiry);
  document.getElementById('training-upload-zone')?.addEventListener('click', () => {
    document.getElementById('training-certificate')?.click();
  });

  // Training types modal event listeners
  document.getElementById('training-types-close')?.addEventListener('click', closeTrainingTypesModal);

  // Debug logging system
  let invitationDebugLog = [];
  let debugStartTime = null;

  function updateDebugStep(step, status, detail = '', data = null) {
    const stepElement = document.querySelector(`.debug-step[data-step="${step}"]`);
    if (!stepElement) return;

    const iconElement = stepElement.querySelector('.debug-icon');
    const detailElement = stepElement.querySelector('.debug-detail');

    // Update icon based on status
    if (status === 'running') {
      iconElement.textContent = '🔄';
    } else if (status === 'success') {
      iconElement.textContent = '✅';
    } else if (status === 'error') {
      iconElement.textContent = '❌';
    } else if (status === 'warning') {
      iconElement.textContent = '⚠️';
    }

    // Add detail if provided
    if (detail && detailElement) {
      detailElement.style.display = 'block';
      detailElement.innerHTML = detail;
    }

    // Add to raw log
    const timestamp = new Date().toISOString();
    const elapsed = debugStartTime ? `+${Date.now() - debugStartTime}ms` : '';
    const logEntry = {
      timestamp,
      elapsed,
      step,
      status,
      detail: detail.replace(/<[^>]*>/g, ''), // Strip HTML
      data
    };

    invitationDebugLog.push(logEntry);

    // Update raw log display
    const rawLogElement = document.getElementById('debug-raw-log');
    if (rawLogElement) {
      rawLogElement.textContent = JSON.stringify(invitationDebugLog, null, 2);
    }
  }

  // INVITATION SYSTEM WITH COMPREHENSIVE DEBUGGING
  async function handleInviteUserFormSubmit(e) {
    e.preventDefault();

    // Reset debug console
    invitationDebugLog = [];
    debugStartTime = Date.now();
    document.querySelectorAll('.debug-step').forEach(step => {
      step.querySelector('.debug-icon').textContent = '⏳';
      step.querySelector('.debug-detail').style.display = 'none';
      step.querySelector('.debug-detail').innerHTML = '';
    });
    document.getElementById('debug-raw-log').textContent = '';

    // Show debug console
    const debugConsole = document.getElementById('invite-debug-console');
    if (debugConsole) debugConsole.style.display = 'block';

    const errorElement = document.getElementById('add-user-error');
    const successElement = document.getElementById('add-user-success');
    const submitBtn = document.getElementById('invite-user-submit');

    // Hide messages
    if (errorElement) errorElement.style.display = 'none';
    if (successElement) successElement.style.display = 'none';

    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';

    try {
      // STEP 1: Check Session
      updateDebugStep('session', 'running', 'Checking user session...');
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();

      if (sessionError) {
        updateDebugStep('session', 'error', `Error: ${sessionError.message}`, sessionError);
        throw new Error(`Session error: ${sessionError.message}`);
      }

      if (!session) {
        updateDebugStep('session', 'error', 'No active session found');
        throw new Error('Not logged in');
      }

      updateDebugStep('session', 'success',
        `User: ${session.user.email}<br>` +
        `ID: ${session.user.id}<br>` +
        `Role: ${session.user.role || 'none'}`,
        { userId: session.user.id, email: session.user.email }
      );

      // STEP 2: Collect Form Data
      updateDebugStep('form', 'running', 'Collecting form data...');

      const email = document.getElementById('add-user-email').value.trim().toLowerCase();
      const fullName = document.getElementById('add-user-name').value.trim();
      const accessType = document.getElementById('add-user-access').value;
      const roleDetail = document.getElementById('add-user-role').value || '';
      const teamId = document.getElementById('add-user-team').value || null;
      const teamIdNumber = teamId ? parseInt(teamId, 10) : null;

      const formData = {
        email,
        fullName,
        accessType,
        roleDetail,
        teamId: teamIdNumber,
        siteId: ctx.site_id
      };

      updateDebugStep('form', 'success',
        `Email: ${email}<br>` +
        `Name: ${fullName}<br>` +
        `Access: ${accessType}<br>` +
        `Role: ${roleDetail || 'none'}<br>` +
        `Team ID: ${teamId || 'none'}<br>` +
        `Site ID: ${ctx.site_id}`,
        formData
      );

      // STEP 3: Check Supabase Connection
      updateDebugStep('connection', 'running', 'Verifying Supabase connection...');

      const supabaseUrl = supabase.supabaseUrl || supabase.restUrl || 'Unknown';
      const supabaseKey = supabase.supabaseKey ? supabase.supabaseKey.substring(0, 20) + '...' : 'Unknown';

      updateDebugStep('connection', 'success',
        `URL: ${supabaseUrl}<br>` +
        `Key: ${supabaseKey}<br>` +
        `Auth: ${supabase.auth ? 'Ready' : 'Not ready'}`,
        { url: supabaseUrl }
      );

      // STEP 4: Delegate invitation record creation to Edge Function
      updateDebugStep('site_invites', 'running', 'Delegating invitation record creation to Edge Function...');

      // STEP 5: Invoke Edge Function to send invitation
      updateDebugStep('edge_function', 'running', 'Invoking send-invitation Edge Function...');
      updateDebugStep('email', 'running', 'Waiting for Edge Function response...');

      const edgePayload = {
        email,
        name: fullName,
        site_id: ctx.site_id,
        access_type: accessType,
        role_detail: roleDetail || null,
        team_id: teamIdNumber,
        reports_to_id: teamIdNumber,
      };

      const { data: edgeResponse, error: edgeError } = await supabase.functions.invoke('send-invitation', {
        body: edgePayload,
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      });

      if (edgeError) {
        updateDebugStep('edge_function', 'error',
          `Edge Function error: ${edgeError.message || 'Unknown error'}`,
          edgeError
        );

        let errorBody = null;
        if (edgeError.context && typeof edgeError.context.json === 'function') {
          try {
            errorBody = await edgeError.context.json();
          } catch (ctxErr) {
            updateDebugStep('edge_function', 'warning', 'Failed to read edge error response body', {
              message: ctxErr instanceof Error ? ctxErr.message : String(ctxErr),
            });
          }
        }

        if (errorBody?.debug && Array.isArray(errorBody.debug)) {
          try {
            errorBody.debug.forEach((entry, idx) => {
              invitationDebugLog.push({
                timestamp: entry.timestamp || new Date().toISOString(),
                elapsed: `edge-error-${idx}`,
                step: `edge:${entry.step}`,
                status: 'info',
                detail: JSON.stringify(entry),
                data: entry,
              });
            });
            const rawLogElement = document.getElementById('debug-raw-log');
            if (rawLogElement) {
              rawLogElement.textContent = JSON.stringify(invitationDebugLog, null, 2);
            }
          } catch (traceErr) {
            updateDebugStep('edge_function', 'warning', 'Failed to record edge error trace data', {
              error: traceErr instanceof Error ? traceErr.message : String(traceErr),
            });
          }
        }

        if (errorBody) {
          updateDebugStep('edge_function', 'warning',
            `Edge context: ${JSON.stringify(errorBody).substring(0, 300)}`,
            errorBody
          );
        }

        if (errorBody?.error === 'User with this email already exists') {
          updateDebugStep('edge_function', 'warning', 'Existing user detected — switch to Resend Invitation for this address.', {
            email,
          });
        }

        const finalMessage = errorBody?.error || edgeError.message || 'Edge Function returned an error';
        updateDebugStep('email', 'error', finalMessage);
        throw new Error(finalMessage);
      }

      updateDebugStep('edge_function', 'success',
        `Edge Function completed<br>` +
        `Request ID: ${edgeResponse?.requestId || 'n/a'}<br>` +
        `Message: ${edgeResponse?.message || 'Invitation sent'}`,
        { payload: edgePayload, response: edgeResponse }
      );

      const inviteDebugEntry = Array.isArray(edgeResponse?.debug)
        ? edgeResponse.debug.find((entry) => entry.step === 'site-invite-inserted' || entry.step === 'site-invite-updated')
        : null;

      if (inviteDebugEntry) {
        updateDebugStep('site_invites', 'success',
          inviteDebugEntry.step === 'site-invite-updated'
            ? 'Existing invitation refreshed and set back to pending.'
            : 'New invitation record created successfully.',
          inviteDebugEntry
        );
      } else {
        updateDebugStep('site_invites', 'success',
          'Edge Function handled invitation record creation.',
          null
        );
      }

      const traceCount = Array.isArray(edgeResponse?.debug) ? edgeResponse.debug.length : 0;
      if (traceCount) {
        updateDebugStep('edge_function', 'success',
          `Edge debug trace entries: ${traceCount}`,
          edgeResponse.debug
        );

        try {
          edgeResponse.debug.forEach((entry, idx) => {
            invitationDebugLog.push({
              timestamp: entry.timestamp || new Date().toISOString(),
              elapsed: `edge-${idx}`,
              step: `edge:${entry.step}`,
              status: 'info',
              detail: JSON.stringify(entry),
              data: entry,
            });
          });
          const rawLogElement = document.getElementById('debug-raw-log');
          if (rawLogElement) {
            rawLogElement.textContent = JSON.stringify(invitationDebugLog, null, 2);
          }
        } catch (traceErr) {
          updateDebugStep('edge_function', 'warning', 'Failed to record edge trace data', {
            error: traceErr instanceof Error ? traceErr.message : String(traceErr),
          });
        }
      }

      if (!edgeResponse?.success) {
        updateDebugStep('email', 'error', `Edge Function reported failure: ${edgeResponse?.error || 'Unknown error'}`);
        throw new Error(edgeResponse?.error || 'Edge Function reported failure');
      }

      updateDebugStep('email', 'success',
        `Edge Function message: ${edgeResponse.message || 'Invitation sent'}<br>` +
        `Email: ${email}`,
        edgeResponse
      );

      // STEP 7: Complete
      updateDebugStep('complete', 'success',
        `✅ All steps completed successfully<br>` +
        `Total time: ${Date.now() - debugStartTime}ms`
      );

      // Show success message
      if (successElement) {
        successElement.innerHTML = `✅ Invitation sent to ${email}`;
        successElement.style.display = 'block';
      }

      // Reset form
      document.getElementById('add-user-name').value = '';
      document.getElementById('add-user-email').value = '';
      document.getElementById('add-user-access').value = 'staff';
      document.getElementById('add-user-role').value = '';

      // Close modal after 3 seconds
      setTimeout(() => {
        closeInviteUserModal();
        loadPracticeUsers();
      }, 3000);

   } catch (err) {
      updateDebugStep('complete', 'error',
        `Process failed: ${err.message}<br>` +
        `Stack: ${err.stack ? err.stack.substring(0, 200) : 'No stack trace'}`,
        { error: err.message, stack: err.stack }
      );

      if (errorElement) {
        errorElement.textContent = err.message;
        errorElement.style.display = 'block';
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = '📧 Send Invitation';
    }
  }
  
  // Initial attachment of the form submit handler
  if (inviteUserForm) {
    inviteUserForm.addEventListener('submit', handleInviteUserFormSubmit);
  } else {
    console.error('Invite user form element not found! Form submission will not work.', { id: 'invite-user-form' });
  }

  // Copy debug log button handler
  document.getElementById('copy-debug-log')?.addEventListener('click', () => {
    const fullLog = {
      timestamp: new Date().toISOString(),
      pageUrl: window.location.href,
      userAgent: navigator.userAgent,
      supabaseConfig: {
        url: supabase.supabaseUrl || supabase.restUrl || 'Unknown',
        authUrl: supabase.authUrl || 'Unknown'
      },
      context: {
        siteId: ctx?.site_id || 'Unknown',
        userEmail: ctx?.user?.email || 'Unknown',
        role: ctx?.role || 'Unknown'
      },
      debugSteps: invitationDebugLog,
      consoleErrors: []
    };

    // Capture any console errors
    const originalError = console.error;
    fullLog.consoleErrors = [];
    console.error = function(...args) {
      fullLog.consoleErrors.push(args.join(' '));
      originalError.apply(console, args);
    };

    // Create formatted text
    const debugText = `
=== CHECKLOOPS INVITATION DEBUG LOG ===
Generated: ${fullLog.timestamp}
Page: ${fullLog.pageUrl}
Browser: ${fullLog.userAgent}

=== CONFIGURATION ===
Supabase URL: ${fullLog.supabaseConfig.url}
Auth URL: ${fullLog.supabaseConfig.authUrl}
Site ID: ${fullLog.context.siteId}
Current User: ${fullLog.context.userEmail}
User Role: ${fullLog.context.role}

=== PROCESS LOG ===
${JSON.stringify(fullLog.debugSteps, null, 2)}

=== RAW DATA ===
${JSON.stringify(fullLog, null, 2)}
    `;

    // Copy to clipboard
    navigator.clipboard.writeText(debugText).then(() => {
      const copyBtn = document.getElementById('copy-debug-log');
      const originalText = copyBtn.textContent;
      copyBtn.textContent = '✅ Copied!';
      copyBtn.style.background = '#10b981';

      setTimeout(() => {
        copyBtn.textContent = originalText;
        copyBtn.style.background = '#6b7280';
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy debug log:', err);
      alert('Failed to copy debug log. Please select and copy the text from the Raw Debug Log section.');
    });
  });

  async function loadPracticeUsers() {
    const tbody = document.getElementById('practice-users-tbody');
    if (!tbody) {
      console.error('practice-users-tbody element not found');
      return;
    }

    if (!ctx.site_id) {
      tbody.innerHTML = '<tr><td colspan="6" class="muted">No site selected</td></tr>';
      return;
    }

    tbody.innerHTML = '<tr><td colspan="6" class="muted">Loading users...</td></tr>';
    debugLog('info', 'Loading practice users');

    try {
      const [masterUsersResult, invitesResult, teamsResult] = await Promise.all([
        supabase
          .from('master_users')
          .select('id, auth_user_id, email, full_name, access_type, role_detail, team_id, invite_status, invite_sent_at, invite_expires_at')
          .eq('site_id', ctx.site_id),
        supabase
          .from('site_invites')
          .select('id, email, full_name, role, role_detail, status')
          .eq('site_id', ctx.site_id),
        supabase
          .from('teams')
          .select('id, name')
          .eq('site_id', ctx.site_id)
      ]);

      const masterUsers = masterUsersResult.data || [];
      const invites = invitesResult.data || [];
      const teamMap = {};
      (teamsResult.data || []).forEach(team => {
        if (team?.id != null) {
          teamMap[team.id] = team.name || `Team ${team.id}`;
        }
      });

      const pendingInviteMap = new Map();
      invites
        .filter(invite => invite?.status === 'pending' && invite?.email)
        .forEach(invite => {
          pendingInviteMap.set(invite.email.toLowerCase(), invite);
        });

      const rows = [];
      const seenEmails = new Set();

      masterUsers.forEach(userRow => {
        const emailLower = userRow.email ? userRow.email.toLowerCase() : '';
        const matchingInvite = emailLower ? pendingInviteMap.get(emailLower) : undefined;
        const status = !userRow.auth_user_id || userRow.invite_status === 'pending' ? 'invited' : 'active';
        const displayEmail = userRow.email || matchingInvite?.email || 'No email';
        const jobRole = userRow.role_detail || matchingInvite?.role_detail || matchingInvite?.role || userRow.access_type || '-';
        const teamLabel = userRow.team_id ? (teamMap[userRow.team_id] || `Team ${userRow.team_id}`) : '-';

        rows.push({
          name: userRow.full_name || matchingInvite?.full_name || 'Unnamed',
          email: displayEmail,
          jobRole,
          team: teamLabel,
          status,
          userId: userRow.auth_user_id || '',
          inviteId: matchingInvite?.id || '',
          masterId: userRow.id || '',
        });

        if (emailLower) {
          seenEmails.add(emailLower);
          pendingInviteMap.delete(emailLower);
        } else if (userRow.id) {
          seenEmails.add(`master:${userRow.id}`);
        }
      });

      pendingInviteMap.forEach((invite) => {
        const key = invite.email ? invite.email.toLowerCase() : `invite:${invite.id}`;
        if (seenEmails.has(key)) return;
        rows.push({
          name: invite.full_name || 'Unnamed',
          email: invite.email || 'No email',
          jobRole: invite.role_detail || invite.role || '-',
          team: '-',
          status: 'invited',
          userId: '',
          inviteId: invite.id || '',
          masterId: '',
        });
      });

      rows.sort((a, b) => a.name.localeCompare(b.name));

      tbody.innerHTML = rows.length ?
        rows.map(row => {
          const dataAttrs = [
            `data-user-id="${row.userId || ''}"`,
            `data-master-id="${row.masterId || ''}"`,
            `data-invite-id="${row.inviteId || ''}"`,
            `data-email="${row.email ? encodeURIComponent(row.email) : ''}"`
          ].join(' ');

          return `
          <tr>
            <td>${esc(row.name)}</td>
            <td>${esc(row.email)}</td>
            <td>${esc(row.jobRole)}</td>
            <td>${esc(row.team)}</td>
            <td>
              <span class="user-status-badge status-${row.status}">
                ${row.status === 'invited' ? 'Invited' : 'Active'}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                ${row.status === 'invited' && row.email !== 'No email' ? `
                  <button class="action-btn" onclick="resendInvitation('${row.email}')" title="Resend invitation email" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);">
                    🔁 Resend
                  </button>
                ` : ''}
                <button class="action-btn remove" ${dataAttrs} title="Remove user">🗑 Remove</button>
              </div>
            </td>
          </tr>
        `;
        }).join('') :
        '<tr><td colspan="6" class="muted">No users yet. Click "Add New User" to start.</td></tr>';

      debugLog('success', `Rendered ${rows.length} users`);

      // Wire up remove buttons with dataset payloads
      tbody.querySelectorAll('.action-btn.remove').forEach(btn => {
        btn.addEventListener('click', () => {
          const payload = {
            userId: btn.dataset.userId || '',
            masterId: btn.dataset.masterId || '',
            inviteId: btn.dataset.inviteId || '',
            email: btn.dataset.email ? decodeURIComponent(btn.dataset.email) : '',
          };
          removeUserComplete(payload);
        });
      });

    } catch (err) {
      console.error('Failed to load users:', err);
      debugLog('error', 'Failed to load users', err);
      tbody.innerHTML = `<tr><td colspan="6" class="muted">Failed to load users: ${err.message}</td></tr>`;
    }
  }

  // Global functions for user actions
  window.deactivateUser = async function(userId) {
    if (!confirm('Are you sure you want to deactivate this user? This will prevent them from logging in but preserve all their data.')) return;

    try {
      // Update the master_users table to set active = false
      const { data, error } = await supabase
        .from('master_users')
        .update({ active: false })
        .eq('auth_user_id', userId)
        .eq('site_id', ctx.site_id)
        .select('full_name')
        .single();

      if (error) throw error;

      console.log('Successfully deactivated user:', data);
      
      // Show success message
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert success';
      alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 16px; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 8px; z-index: 10000;';
      alertDiv.textContent = `User ${data.full_name || 'Unknown'} has been deactivated and can no longer log in.`;
      document.body.appendChild(alertDiv);
      
      setTimeout(() => alertDiv.remove(), 5000);
      
      // Reload the user list to reflect changes
      loadPracticeUsers();
    } catch (err) {
      console.error('Failed to deactivate user:', err);
      let errorMsg = 'Failed to deactivate user';
      if (err.message) {
        errorMsg += ': ' + err.message;
      }
      alert(errorMsg);
    }
  };

  window.reactivateUser = async function(userId) {
    if (!confirm('Are you sure you want to reactivate this user? This will allow them to log in again.')) return;

    try {
      // Update the master_users table to set active = true
      const { data, error } = await supabase
        .from('master_users')
        .update({ active: true })
        .eq('auth_user_id', userId)
        .eq('site_id', ctx.site_id)
        .select('full_name')
        .single();

      if (error) throw error;

      console.log('Successfully reactivated user:', data);
      
      // Show success message
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert success';
      alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 16px; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 8px; z-index: 10000;';
      alertDiv.textContent = `User ${data.full_name || 'Unknown'} has been reactivated and can now log in.`;
      document.body.appendChild(alertDiv);
      
      setTimeout(() => alertDiv.remove(), 5000);
      
      // Reload the user list to reflect changes
      loadPracticeUsers();
    } catch (err) {
      console.error('Failed to reactivate user:', err);
      let errorMsg = 'Failed to reactivate user';
      if (err.message) {
        errorMsg += ': ' + err.message;
      }
      alert(errorMsg);
    }
  };

  // SIMPLIFIED RESEND INVITATION
  window.resendInvitation = async function(email) {
    if (!confirm(`Resend invitation to ${email}?`)) return;

    try {
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (sessionError) throw sessionError;
      if (!session) throw new Error('Not logged in');

      const payload = {
        email,
        resend: true,
        site_id: ctx?.site_id || 2,
      };

      const { data, error } = await supabase.functions.invoke('send-invitation', {
        body: payload,
        headers: {
          Authorization: `Bearer ${session.access_token}`,
        },
      });

      if (error) {
        console.error('Resend invitation Edge Function error:', error);
        let resendErrorBody = null;
        if (error.context && typeof error.context.json === 'function') {
          try {
            resendErrorBody = await error.context.json();
          } catch (ctxErr) {
            console.warn('Failed to parse resend error context', ctxErr);
          }
        }

        if (resendErrorBody?.debug && Array.isArray(resendErrorBody.debug)) {
          logInvitationDebug('edge-response:debug-trace', {
            context: 'resend-error',
            traceCount: resendErrorBody.debug.length,
            trace: resendErrorBody.debug,
          });
        }

        if (resendErrorBody) {
          logInvitationDebug('edge-response:error-context', { context: resendErrorBody, scope: 'resend' });
        }

        throw new Error(resendErrorBody?.error || error.message || 'Edge Function returned an error');
      }

      if (!data?.success) {
        throw new Error(data?.error || 'Edge Function reported failure');
      }

      alert(`✅ ${data.message || 'Invitation resent successfully'}`);
      loadPracticeUsers();
    } catch (err) {
      console.error('Failed to resend invitation:', err);
      alert(`Failed to resend invitation: ${err.message}`);
    }
  };


  window.removeUserComplete = async function(payload) {
    // If payload is a string or simple object, handle it for backward compatibility
    if (typeof payload === 'string' || (payload && !payload.email && (payload.userId || payload.inviteId))) {
      const id = typeof payload === 'string' ? payload : (payload.userId || payload.inviteId || payload);
      const isUserId = typeof payload === 'string' ? arguments[1] !== false : !!payload.userId;
      
      const confirmMsg = isUserId ?
        'Are you sure you want to remove this user and ALL their data? This cannot be undone!' :
        'Are you sure you want to cancel this invitation?';

      if (!confirm(confirmMsg)) return;

      debugLog('warning', 'Removing user/invite (legacy mode)', { id, isUserId });
      
      // Handle old-style call with just ID
      try {
        if (!isUserId) {
          // Just remove the invitation
          const { error } = await supabase
            .from('site_invites')
            .delete()
            .eq('id', id);

          if (error) throw error;

          debugLog('success', 'Invitation cancelled');
          
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert success';
          alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 16px; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 8px; z-index: 10000;';
          alertDiv.textContent = 'Invitation cancelled';
          document.body.appendChild(alertDiv);
          setTimeout(() => alertDiv.remove(), 3000);
          
          // Reload the user list to reflect changes
          loadPracticeUsers();
          return;
        }
        
        // Otherwise, continue with user ID deletion (will be handled by code below)
        payload = { userId: id };
      } catch (err) {
        debugLog('error', 'Failed to remove invite', err);
        alert('Failed to remove invitation: ' + err.message);
        return;
      }
    }
    
    // Extract data from payload
    const userId = payload.userId || '';
    const masterId = payload.masterId || '';
    const inviteId = payload.inviteId || '';
    const email = payload.email || '';
    
    // Determine if this is a user or just an invitation
    const isUser = !!userId;
    
    const confirmMsg = isUser ?
      'Are you sure you want to remove this user and ALL their data? This cannot be undone!' :
      'Are you sure you want to cancel this invitation?';

    if (!confirm(confirmMsg)) return;

    debugLog('warning', 'Removing user/invite', { userId, masterId, inviteId, email, isUser });

    try {
      if (!isUser) {
        // Just remove the invitation
        if (!inviteId) {
          throw new Error('No invitation ID provided');
        }
        
        const { error } = await supabase
          .from('site_invites')
          .delete()
          .eq('id', inviteId);

        if (error) throw error;

        debugLog('success', 'Invitation cancelled');
        
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert success';
        alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 16px; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 8px; z-index: 10000;';
        alertDiv.textContent = 'Invitation cancelled';
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 3000);
      } else {
        // Run comprehensive SQL script to delete all user data by email
        debugLog('info', 'Running comprehensive SQL cleanup script');
        
        if (!email) {
          debugLog('warning', 'No email provided for SQL cleanup, falling back to conventional deletion');
          
          // Get user profile data first for proper cleanup
          const { data: profile, error: profileError } = await supabase
            .from('master_users')
            .select('full_name, auth_auth_user_id, email')
            .eq('auth_user_id', userId)
            .single();
  
          if (profileError && profileError.code !== 'PGRST116') {
            debugLog('warning', 'Could not fetch profile for cleanup', profileError);
          }
  
          // Also try to get user email from auth.users if needed
          let userEmail = profile?.email;
          if (!userEmail) {
            const { data: authUser } = await supabase.auth.admin.getUserById(userId);
            userEmail = authUser?.user?.email;
          }
          
          if (!userEmail) {
            throw new Error('Could not determine user email for deletion');
          }
          
          // Use the email we found for SQL-based cleanup
          debugLog('info', `Found email for cleanup: ${userEmail}`);
          executeCompositeDelete(userId, userEmail);
        } else {
          // Use the email provided directly
          executeCompositeDelete(userId, email);
        }
      }

      // Reload the user list to reflect changes
      loadPracticeUsers();

    } catch (err) {
      debugLog('error', 'Failed to remove user/invite', err);
      alert('Failed to remove user: ' + err.message);
    }
  };
  
  // Helper function to execute the SQL deletion script
  async function executeCompositeDelete(userId, email) {
    debugLog('info', `Executing composite delete for user ${userId} with email ${email}`);
    
    try {
      // First run the comprehensive SQL script to clean up all tables with this email
      const sql = `
      -- Record counts before deletion
      WITH before_counts AS (
        SELECT
          (SELECT COUNT(*) FROM master_users WHERE email = '${email}') as master_users_count,
          (SELECT COUNT(*) FROM training_records WHERE user_id = '${userId}') as training_records_count,
          (SELECT COUNT(*) FROM complaints WHERE created_by = '${userId}') as complaints_count,
          (SELECT COUNT(*) FROM meeting_notes WHERE created_by = '${userId}') as meeting_notes_count,
          (SELECT COUNT(*) FROM meetings WHERE created_by = '${userId}') as meetings_count,
          (SELECT COUNT(*) FROM quiz_practices WHERE email = '${email}') as quiz_practices_count,
          (SELECT COUNT(*) FROM quiz_attempts WHERE user_id = '${userId}') as quiz_attempts_count,
          (SELECT COUNT(*) FROM quiz_questions WHERE created_by = '${userId}') as quiz_questions_count,
          (SELECT COUNT(*) FROM '1_staff_holiday_profiles' WHERE user_id = '${userId}') as holiday_profiles_count,
          (SELECT COUNT(*) FROM '2_staff_entitlements' WHERE staff_id IN (SELECT id FROM '1_staff_holiday_profiles' WHERE user_id = '${userId}')) as entitlements_count,
          (SELECT COUNT(*) FROM '3_staff_working_patterns' WHERE user_id = '${userId}') as working_patterns_count,
          (SELECT COUNT(*) FROM staff_app_welcome WHERE user_id = '${userId}') as welcome_count,
          (SELECT COUNT(*) FROM user_profiles_complete WHERE user_id = '${userId}') as profiles_complete_count,
          (SELECT COUNT(*) FROM site_invites WHERE email = '${email}') as invites_count,
          (SELECT COUNT(*) FROM holidays WHERE user_id = '${userId}') as holidays_count
      ),
      
      -- Delete from child tables first to maintain referential integrity
      delete_training AS (
          DELETE FROM training_records WHERE user_id = '${userId}' RETURNING 1
      ),
      delete_complaints AS (
          DELETE FROM complaints WHERE created_by = '${userId}' RETURNING 1
      ),
      delete_meeting_notes AS (
          DELETE FROM meeting_notes WHERE created_by = '${userId}' RETURNING 1
      ),
      delete_meetings AS (
          DELETE FROM meetings WHERE created_by = '${userId}' RETURNING 1
      ),
      delete_quiz_practices AS (
          DELETE FROM quiz_practices WHERE email = '${email}' RETURNING 1
      ),
      delete_quiz_attempts AS (
          DELETE FROM quiz_attempts WHERE user_id = '${userId}' RETURNING 1
      ),
      delete_quiz_questions AS (
          DELETE FROM quiz_questions WHERE created_by = '${userId}' RETURNING 1
      ),
      
      -- Legacy holiday system
      delete_entitlements AS (
          DELETE FROM "2_staff_entitlements" 
          WHERE staff_id IN (SELECT id FROM "1_staff_holiday_profiles" WHERE user_id = '${userId}')
          RETURNING 1
      ),
      delete_working_patterns AS (
          DELETE FROM "3_staff_working_patterns" WHERE user_id = '${userId}' RETURNING 1
      ),
      delete_holiday_profiles AS (
          DELETE FROM "1_staff_holiday_profiles" WHERE user_id = '${userId}' RETURNING 1
      ),
      
      -- Main user tables
      delete_welcome AS (
          DELETE FROM staff_app_welcome WHERE user_id = '${userId}' RETURNING 1
      ),
      delete_profiles_complete AS (
          DELETE FROM user_profiles_complete WHERE user_id = '${userId}' RETURNING 1
      ),
      delete_invites AS (
          DELETE FROM site_invites WHERE email = '${email}' RETURNING 1
      ),
      delete_holidays AS (
          DELETE FROM holidays WHERE user_id = '${userId}' RETURNING 1
      ),
      delete_master_users AS (
          DELETE FROM master_users WHERE email = '${email}' OR auth_user_id = '${userId}' RETURNING 1
      )
      
      -- Return summary of operations
      SELECT
          (SELECT COUNT(*) FROM delete_training) as training_deleted,
          (SELECT COUNT(*) FROM delete_complaints) as complaints_deleted,
          (SELECT COUNT(*) FROM delete_meeting_notes) as meeting_notes_deleted,
          (SELECT COUNT(*) FROM delete_meetings) as meetings_deleted,
          (SELECT COUNT(*) FROM delete_quiz_practices) as quiz_practices_deleted,
          (SELECT COUNT(*) FROM delete_quiz_attempts) as quiz_attempts_deleted,
          (SELECT COUNT(*) FROM delete_quiz_questions) as quiz_questions_deleted,
          (SELECT COUNT(*) FROM delete_entitlements) as entitlements_deleted,
          (SELECT COUNT(*) FROM delete_working_patterns) as working_patterns_deleted,
          (SELECT COUNT(*) FROM delete_holiday_profiles) as holiday_profiles_deleted,
          (SELECT COUNT(*) FROM delete_welcome) as welcome_deleted,
          (SELECT COUNT(*) FROM delete_profiles_complete) as profiles_complete_deleted,
          (SELECT COUNT(*) FROM delete_invites) as invites_deleted,
          (SELECT COUNT(*) FROM delete_holidays) as holidays_deleted,
          (SELECT COUNT(*) FROM delete_master_users) as master_users_deleted,
          *
      FROM before_counts;
      `;
      
      // Execute the SQL script
      const { data: sqlResult, error: sqlError } = await supabase.rpc('exec_sql', { sql });
      
      if (sqlError) {
        debugLog('error', 'SQL execution error:', sqlError);
        throw new Error(`SQL execution error: ${sqlError.message}`);
      }
      
      debugLog('success', 'SQL cleanup completed', sqlResult);
      
      // Now delete from auth.users using the edge function
      debugLog('info', 'Deleting from auth.users');
      const { error: authError } = await supabase.functions.invoke('delete-user', {
        body: { user_id: userId }
      });

      if (authError) {
        debugLog('warning', 'Could not delete auth user', authError);
      }
      
      // Calculate how many tables were affected
      const deletedTablesCount = Object.keys(sqlResult[0] || {})
        .filter(key => key.endsWith('_deleted') && sqlResult[0][key] > 0)
        .length;
      
      // Show success message
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert success';
      alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 16px; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 8px; z-index: 10000; max-width: 400px;';
      alertDiv.innerHTML = `
        <strong>User Removed</strong><br>
        User and all data removed successfully<br>
        <small>Cleaned up data from ${deletedTablesCount} table(s)</small>
      `;
      document.body.appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 5000);
      
      return true;
    } catch (err) {
      debugLog('error', 'Composite delete execution failed:', err);
      throw err;
    }
  }

  // Keep old function for backwards compatibility
  window.cancelInvite = window.removeUserComplete;





  // Page Visibility Toggle functionality
  function initPageVisibilityToggles() {
    // Map toggle IDs to database page names
    const toggleToPageMap = {
      'page-toggle-1': 'dashboard',
      'page-toggle-2': 'pre-inspection',
      'page-toggle-4': 'calendar',
      'page-toggle-5': 'schedules',
      'page-toggle-6': 'submissions',
      'page-toggle-7': 'items',
      'page-toggle-8': 'rooms',
      'page-toggle-9': 'checks',
      'page-toggle-10': 'staff',
      'page-toggle-11': 'complaints'
    };

    // Load current permissions from database
    loadPagePermissions();

  // Save button intentionally removed — only debug button remains

    // Add event listener to debug button
    const debugButton = document.getElementById('debug-page-visibility');
    if (debugButton) {
      debugButton.addEventListener('click', () => {
        // Use the comprehensive test debug function instead of the simple debug writer
        if (typeof testDebugFunction === 'function') testDebugFunction();
      });
    }
  }

  async function loadPagePermissions() {
    try {
      const { data, error } = await supabase
        .from('role_permissions')
        .select('allowed_pages')
        .eq('role', 'staff')
        .single();

      if (error) {
        console.error('Error loading page permissions:', error);
        return;
      }

      const allowedPages = data?.allowed_pages || [];
      console.log('Loaded staff permissions:', allowedPages);

      // Map database page names back to toggle IDs
      const pageToToggleMap = {
        'dashboard': 'page-toggle-1',
        'pre-inspection': 'page-toggle-2',
        'training': 'page-toggle-3',
        'calendar': 'page-toggle-4',
        'schedules': 'page-toggle-5',
        'submissions': 'page-toggle-6',
        'items': 'page-toggle-7',
        'rooms': 'page-toggle-8',
        'checks': 'page-toggle-9',
        'staff': 'page-toggle-10',
        'complaints': 'page-toggle-11'
      };

      // Set toggle states based on permissions
      Object.entries(pageToToggleMap).forEach(([page, toggleId]) => {
        const toggle = document.getElementById(toggleId);
        if (toggle) {
          toggle.checked = allowedPages.includes(page);
        }
      });

    } catch (error) {
      console.error('Failed to load page permissions:', error);
    }
  }

  async function savePagePermissions() {
    console.log('🚀 savePagePermissions function called!');
    const saveButton = document.getElementById('save-page-visibility');
    if (!saveButton) {
      // The Save button has been intentionally removed from the UI.
      // Avoid touching a non-existent element to prevent runtime errors.
      console.warn('savePagePermissions: save button not present in DOM; aborting.');
      return;
    }
    const originalText = saveButton.textContent;
    
    try {
      // Disable button and show saving state
      saveButton.disabled = true;
      saveButton.textContent = 'Saving...';

      // Map toggle IDs to database page names (consistent with your requirements)
      const toggleToPageMap = {
        'page-toggle-1': 'Dashboard',
        'page-toggle-2': 'preinspection',
        'page-toggle-4': 'calendar',
        'page-toggle-5': 'schedules',
        'page-toggle-6': 'submissions',
        'page-toggle-7': 'items',
        'page-toggle-8': 'rooms',
        'page-toggle-9': 'checks',
        'page-toggle-10': 'staff',
        'page-toggle-11': 'complaints'
      };

      // Collect ONLY the checked toggles into an array
      const allowedPages = [];
      
      Object.entries(toggleToPageMap).forEach(([toggleId, page]) => {
        const toggle = document.getElementById(toggleId);
        if (toggle && toggle.checked) {
          allowedPages.push(page);
        }
      });

      console.log('💾 Sending this EXACT array to database:', JSON.stringify(allowedPages));

      // REPLACE the database cell with this exact array
      const { data, error } = await supabase
        .from('role_permissions')
        .update({ allowed_pages: allowedPages })
        .eq('role', 'staff')
        .select();

      if (error) {
        console.error('❌ Error saving page permissions:', error);
        throw error;
      }

      console.log('✅ Update response:', data);

      // Show success immediately (don't wait for verification as the update should work)
      saveButton.textContent = 'Saved!';
      saveButton.style.backgroundColor = '#28a745';
      
      // Reset button after 2 seconds
      setTimeout(() => {
        saveButton.disabled = false;
        saveButton.textContent = originalText;
        saveButton.style.backgroundColor = '';
      }, 2000);

    } catch (error) {
      console.error('❌ Failed to save page permissions:', error);
      
      // Show error state
      saveButton.textContent = 'Save Failed';
      saveButton.style.backgroundColor = '#dc3545';
      
      // Reset button after 3 seconds
      setTimeout(() => {
        saveButton.disabled = false;
        saveButton.textContent = originalText;
        saveButton.style.backgroundColor = '';
      }, 3000);
      
      alert('Failed to save page permissions. Please try again.');
    }
  }

  // Site Settings Functions for Feature Toggles
  function syncFeatureToggleText() {
    try {
      const ids = ['enable-achievements', 'enable-avatars'];
      ids.forEach(id => {
        const input = document.getElementById(id);
        const textEl = input?.parentElement?.querySelector('.cl-switch-text');
        if (input && textEl) {
          textEl.textContent = input.checked ? 'On' : 'Off';
        }
      });
    } catch (_) {}
  }

  async function loadSiteSettings() {
    try {
      // Get the current site ID
      const siteId = ctx?.site_id;
      if (!siteId) {
        console.warn('No site_id available for loading settings');
        return;
      }

      // Check if site_settings table exists, if not create default settings
      const { data, error } = await supabase
        .from('site_settings')
        .select('*')
        .eq('site_id', siteId)
        .single();

      if (error) {
        if (error.code === 'PGRST116' || error.message.includes('no rows')) {
          // No settings exist, create default settings
          console.log('Creating default site settings');
          const { error: insertError } = await supabase
            .from('site_settings')
            .insert({
              site_id: siteId,
              enable_achievements: true,  // Default to enabled
              enable_avatars: true,       // Default to enabled
              updated_at: new Date().toISOString()
            });

          if (insertError) {
            console.error('Failed to create default settings:', insertError);
          }

          // Set default UI state
          document.getElementById('enable-achievements').checked = true;
          document.getElementById('enable-avatars').checked = true;
        } else {
          console.error('Error loading site settings:', error);
        }
        return;
      }

      // Apply loaded settings to UI
      if (data) {
        const achievementsCheckbox = document.getElementById('enable-achievements');
        const avatarsCheckbox = document.getElementById('enable-avatars');

        if (achievementsCheckbox) {
          achievementsCheckbox.checked = data.enable_achievements !== false;
        }
        if (avatarsCheckbox) {
          avatarsCheckbox.checked = data.enable_avatars !== false;
        }

        // Update toggle label text
        syncFeatureToggleText();

        console.log('Site settings loaded:', {
          achievements: data.enable_achievements,
          avatars: data.enable_avatars
        });
      }

    } catch (error) {
      console.error('Failed to load site settings:', error);
    }
  }

  // Update site settings when toggles change
  async function updateSiteSettings() {
    const statusDiv = document.getElementById('feature-settings-status');
    const achievementsCheckbox = document.getElementById('enable-achievements');
    const avatarsCheckbox = document.getElementById('enable-avatars');

    if (!ctx?.site_id) {
      console.error('No site_id available for saving settings');
      return;
    }

    // Immediately reflect the new state in the label text
    syncFeatureToggleText();

    // Show saving status
    if (statusDiv) {
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#3b82f6';
      statusDiv.style.color = 'white';
      statusDiv.innerHTML = '💾 Saving settings...';
    }

    try {
      const settings = {
        site_id: ctx.site_id,
        enable_achievements: achievementsCheckbox?.checked || false,
        enable_avatars: avatarsCheckbox?.checked || false,
        updated_at: new Date().toISOString()
      };

      // Upsert the settings (insert or update)
      const { error } = await supabase
        .from('site_settings')
        .upsert(settings, {
          onConflict: 'site_id',
          returning: 'minimal'
        });

      if (error) {
        throw error;
      }

      // Show success status
      if (statusDiv) {
        statusDiv.style.background = '#10b981';
        statusDiv.innerHTML = '✅ Settings saved successfully!';

        // Store in localStorage for immediate effect on other pages
        localStorage.setItem(`site_${ctx.site_id}_settings`, JSON.stringify({
          enable_achievements: settings.enable_achievements,
          enable_avatars: settings.enable_avatars
        }));

        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
      }

      console.log('Site settings saved:', settings);

    } catch (error) {
      console.error('Failed to save site settings:', error);

      // Build a clearer message for common cases
      let msg = '❌ Failed to save settings. Please try again.';
      const code = error?.code || error?.hint || error?.details || '';
      if (typeof error?.message === 'string') {
        const em = error.message.toLowerCase();
        if (em.includes('permission') || em.includes('rls')) {
          msg = '❌ Permission denied by RLS/policy. Ask admin to run site_settings_setup.sql and ensure your user is admin for this site.';
        } else if (em.includes('relation') && em.includes('does not exist')) {
          msg = '❌ Missing table site_settings. Ask admin to run sql/site_settings_setup.sql in Supabase.';
        } else if (em.includes('unique') || em.includes('conflict')) {
          msg = '❌ Conflict on site_id. Please refresh and try again.';
        }
      }

      if (statusDiv) {
        statusDiv.style.background = '#ef4444';
        statusDiv.innerHTML = `${msg}${code ? ' (' + code + ')' : ''}`;
        setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
      }
    }
  }

  // Make updateSiteSettings available globally
  window.updateSiteSettings = updateSiteSettings;

  // Global debug function for testing
  window.testDebugFunction = async function() {
    console.log('� DEBUG: Starting comprehensive test...');
    
    const debugButton = document.getElementById('debug-page-visibility');
    const originalText = debugButton.textContent;
    
    try {
      debugButton.disabled = true;
      debugButton.textContent = 'Debugging...';
      debugButton.style.backgroundColor = '#ffc107';

  // Read value from the room array/string box (#debug-enabled-toggles).
  // If it's valid JSON use that value directly. Otherwise, if non-empty, wrap the raw string in an array. If empty, fall back to default debug marker.
  const rawInput = (document.getElementById('debug-enabled-toggles')?.value || '').trim();
      let debugValue;
      try {
        debugValue = JSON.parse(rawInput);
      } catch (e) {
        if (rawInput === '') {
          debugValue = ['DebugTestUpdate', ...new Date().toISOString().split('T')];
        } else {
          debugValue = [rawInput];
        }
      }

      console.log('� Supabase available:', !!window.supabase);
      console.log('� User:', await window.supabase.auth.getUser());

      // First, check current data
      console.log('� Reading current role_permissions...');
      const { data: currentData, error: selectError } = await window.supabase
        .from('role_permissions')
        .select('*')
        .eq('role', 'staff');

      console.log('� Current data:', currentData);
      console.log('❌ Select error:', selectError);

      if (!currentData || currentData.length === 0) {
        console.log('� No staff record found, creating new one...');
        const { data: insertData, error: insertError } = await window.supabase
          .from('role_permissions')
          .insert({ role: 'staff', allowed_pages: debugValue })
          .select();

        console.log('� Insert result:', insertData);
        console.log('❌ Insert error:', insertError);

        if (insertError) {
          throw insertError;
        }
        
        debugButton.textContent = 'Created New Record!';
        debugButton.style.backgroundColor = '#28a745';
      } else {
        console.log('🔄 Staff record exists, updating...');
        console.log('📋 Current allowed_pages:', currentData[0]?.allowed_pages);
        
        // Use UPSERT which should handle RLS better
        const { data: upsertData, error: upsertError } = await window.supabase
          .from('role_permissions')
          .upsert({ 
            role: 'staff', 
            allowed_pages: debugValue
          })
          .select();

        console.log('📊 Upsert result:', upsertData);
        console.log('❌ Upsert error:', upsertError);

        if (upsertError) {
          console.log('🔄 Upsert failed, trying direct update...');
          const { data: updateData, error: updateError } = await window.supabase
            .from('role_permissions')
            .update({ 
              allowed_pages: debugValue 
            })
            .eq('role', 'staff')
            .select();

          console.log('� Direct update result:', updateData);
          console.log('❌ Direct update error:', updateError);

          if (updateError) {
            throw updateError;
          }
        }
        
        debugButton.textContent = 'Updated Successfully!';
        debugButton.style.backgroundColor = '#28a745';
      }
      
      // Verify the change
      console.log('🔍 Verifying changes...');
      const { data: verifyData } = await window.supabase
        .from('role_permissions')
        .select('*')
        .eq('role', 'staff');
      console.log('✅ Final data:', verifyData);
      
      // Reset button after 4 seconds
      setTimeout(() => {
        debugButton.disabled = false;
        debugButton.textContent = originalText;
        debugButton.style.backgroundColor = '';
      }, 4000);

    } catch (error) {
      console.error('❌ Debug failed:', error);
      console.error('❌ Error details:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      
      // Show error state
      debugButton.textContent = 'Failed - Check Console';
      debugButton.style.backgroundColor = '#dc3545';
      
      // Reset button after 5 seconds
      setTimeout(() => {
        debugButton.disabled = false;
        debugButton.textContent = originalText;
        debugButton.style.backgroundColor = '';
      }, 5000);
    }
  };

  // debugPagePermissions removed per request - use testDebugFunction() for debugging actions

  // Initialize data loading
  async function initializeApp() {
    try {
      // Load initial context
      await loadContext();
      
      // Initialize debug toggle on app start
      // initDebugToggle(); // Removed - debug window no longer exists
      initPageVisibilityToggles();
      
      // Restore last active section
      const saved = localStorage.getItem("cl_active_section") || "dashboard";
      setActiveSection(saved);

      // Preload some common data
      await Promise.all([
        loadCounts(),
        loadDue(),
        loadActivity()
      ]);
    } catch(err) {
      console.error('Failed to initialize app:', err);
    }
  }

  // Start initialization
  initializeApp();

  // Restore sidebar collapsed state
  try {
    const s = localStorage.getItem("cl_sidebar_collapsed");
    if(s === "1"){
      document.getElementById("app")?.classList.add("collapsed");
      document.getElementById("sidebar")?.classList.add("collapsed");
  // reflect aria state on the toggle button
  try{ document.getElementById('toggleSidebar')?.setAttribute('aria-expanded', 'false'); }catch(_){}
    }
  } catch(_) {}

  // Quick UX
  const search = document.getElementById("search");
  window.addEventListener("keydown", (e)=>{ if(e.key==="/"){ e.preventDefault(); search.focus(); } });

  // Auth overlay controls
  const authOverlay = document.getElementById("auth");
  const signoutBtn = document.getElementById("signout");
  const signinForm = document.getElementById("signin-form");
  const authErr = document.getElementById("auth-error");

  // Re-entrancy guard and shared cleanup
  let isLoggingOut = false;
  function cleanupAndRedirect() {
    // Clear all possible localStorage items
    try {
      const itemsToRemove = ['rememberedPassword', 'rememberedEmail', 'rememberMe', 'cl_sidebar_collapsed', 'sb-unveoqnlqnobufhublyw-auth-token'];
      itemsToRemove.forEach(item => {
        try { localStorage.removeItem(item); } catch(_) {}
      });
    } catch(_) {}

    // Clear sessionStorage
    try { sessionStorage.clear(); } catch(_) {}

    // Clear any cookies (basic attempt)
    try {
      document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date(0).toUTCString() + ";path=/"); 
      });
    } catch(_) {}

    console.log('Storage cleared, redirecting to home.html');
    window.location.replace('home.html?_=' + Date.now());
  }

  // Centralized logout function
  async function forceLogout() {
    if (isLoggingOut) {
      console.log('Logout already in progress (admin), skipping duplicate call.');
      return;
    }
    isLoggingOut = true;
    console.log('Starting forced logout from admin...');
    
    try {
      const { data } = await supabase.auth.getSession();
      if (data?.session) {
        await supabase.auth.signOut();
        console.log('Supabase signOut completed');
      } else {
        console.log('No active session before signOut call');
      }
    } catch (e) {
      console.error('Supabase signOut failed:', e);
    }

    cleanupAndRedirect();
  }

  signoutBtn.addEventListener("click", async(e)=>{
    e.preventDefault();
    e.stopPropagation();
    console.log('Logout button clicked on admin page');
    await forceLogout();
  });
  
  // On page load, check for a valid session. If not found, redirect to login.
  (async function() {
    try {
      // Check if we just came from staff pages
      const cameFromStaffAt = sessionStorage.getItem('cameFromStaffAt');
      const adminJustVisited = cameFromStaffAt && (Date.now() - Number(cameFromStaffAt)) < 10000; // Within 10 seconds
      
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user || !session.user.id) {
        // No valid session, but if we just came from staff pages, redirect back there
        // instead of forcing logout (to avoid logout loops)
        if (adminJustVisited) {
          console.log('No valid session but just came from staff - redirecting to staff.html');
          
          // Check stored role to determine if user should have admin access
          const storedRole = sessionStorage.getItem('userRole');
          const storedEmail = sessionStorage.getItem('userEmail');
          
          if (storedRole && ['Admin', 'Owner'].includes(storedRole)) {
            console.log('Stored role indicates admin access:', storedRole);
            console.log('Email:', storedEmail);
            console.log('Auth issue detected - redirecting to home.html to refresh login');
            window.location.replace('home.html?adminRetry=true');
            return;
          }
          
          window.location.replace('staff.html');
          return;
        }
        
        // Otherwise, standard behavior - no valid session
        console.log('No valid session found on admin page, forcing logout');
        await forceLogout();
        return;
      }

      // Add an auth state listener so if the user signs out elsewhere we redirect immediately
      try {
        // Store the fact that we successfully authenticated to the admin page
        sessionStorage.setItem('adminAuthenticated', 'true');
        
        supabase.auth.onAuthStateChange((event, sess) => {
          console.log('Auth state changed on admin page:', event, sess ? 'has session' : 'no session');
          
          if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
            console.log('✅ User signed in or token refreshed');
            // If we just came from staff pages and are signed in again, refresh the page
            // to ensure everything is loaded properly
            const cameFromStaffAt = sessionStorage.getItem('cameFromStaffAt');
            const recentNavigation = cameFromStaffAt && (Date.now() - Number(cameFromStaffAt)) < 10000;
            if (recentNavigation && sess && sess.user) {
              console.log('Re-initializing after navigation from staff...');
              // Removed reload to prevent debugger interference - call bootstrap instead
              sessionStorage.removeItem('cameFromStaffAt');
              if (typeof bootstrap === 'function') {
                bootstrap();
              }
            }
          } else if (event === 'SIGNED_OUT' || !sess || !sess.user) {
            if (!isLoggingOut) {
              isLoggingOut = true;
              // Already signed out; just cleanup
              cleanupAndRedirect();
            }
          }
        });
      } catch (e) {
        console.warn('Failed to attach auth state listener', e);
      }

      // STRICT GUARD: Staff users are NEVER allowed on index.html (admin site)
      try {
        const user = session.user;
        console.log('Checking if user has admin role...');
        
        // Check master_users.access_type only (authoritative)
        const { data: profile, error: profileError } = await supabase
          .from('master_users')
          .select('access_type, full_name')
          .eq('auth_user_id', user.id)
          .maybeSingle();
        
        if (profileError) {
          console.error('Error fetching profile:', profileError);
        }
        
        const accessType = String(profile?.access_type || '').toLowerCase();
        if (accessType === 'admin' || accessType === 'owner') {
          console.log(`✅ User allowed on admin site - access_type: ${accessType}`);
          
          // Store that this user is verified as admin for future reference
          try {
            sessionStorage.setItem('adminVerified', 'true');
            sessionStorage.setItem('adminEmail', user.email);
          } catch(_) {}
          
          return;
        }
        
        // If we get here, the user doesn't have admin/owner access_type
        console.log(`🚫 BLOCKED: User "${profile?.full_name || user.email}" lacks admin privileges (access_type=${accessType})`);
        console.log('Redirecting to home.html...');
        window.location.replace('staff.html');
        return;
      } catch (e) {
        console.warn('Role guard check failed, but allowing access:', e);
        // If we can't determine role, allow access (better to be permissive than block legitimate admins)
      }

      // Check if we need to apply a forced auth refresh
      const forceAuthRefresh = sessionStorage.getItem('forceAuthRefresh') === 'true';
      if (forceAuthRefresh) {
        console.log('🔄 Forced auth refresh requested from staff navigation');
        sessionStorage.removeItem('forceAuthRefresh');
        
        try {
          console.log('Refreshing auth session...');
          const { data, error } = await supabase.auth.refreshSession();
          
          if (error) {
            console.error('❌ Failed to refresh auth session:', error);
          } else if (data?.session) {
            console.log('✅ Auth session refreshed successfully');
          }
        } catch (err) {
          console.error('❌ Error during auth refresh:', err);
        }
      }

      // Initialize the context with the session
      try {
        await loadContext();
        console.log('✅ Context loaded successfully');
        await Promise.all([
          loadCounts().catch(err => console.error('loadCounts failed:', err)),
          loadDue().catch(err => console.error('loadDue failed:', err)),
          loadActivity().catch(err => console.error('loadActivity failed:', err))
        ]);
        console.log('✅ All data loaded successfully');
      } catch (err) {
        console.error('❌ Failed to initialize:', err);
        // If we fail to load the context, sign the user out and redirect to login
        await forceLogout();
      }
    } catch (err) {
      console.error('Session check failed:', err);
      await forceLogout();
    }
  })();

  // Check if we just navigated from staff pages
  const cameFromStaffAt = sessionStorage.getItem('cameFromStaffAt');
  const recentNavigation = cameFromStaffAt && (Date.now() - Number(cameFromStaffAt)) < 10000;
  
  // If we just came from staff pages, set a flag to refresh the session
  if (recentNavigation) {
    console.log('Recent navigation from staff detected, will ensure session is refreshed');
    sessionStorage.setItem('needSessionRefresh', 'true');
  }
  
  // Guard on bfcache restore or quick back/forward: re-check auth and role
  window.addEventListener('pageshow', async (e) => {
    if (!e.persisted) return; // only handle bfcache restores
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        // Not logged in anymore
        if (!isLoggingOut) {
          isLoggingOut = true;
          cleanupAndRedirect();
        }
        return;
      }

      // STRICT GUARD: Re-check access_type on bfcache restore; redirect non-admins
      try {
        const user = session.user;
        const { data: profile } = await supabase
          .from('master_users')
          .select('access_type, full_name')
          .eq('auth_user_id', user.id)
          .maybeSingle();
        const accessType = String(profile?.access_type || '').toLowerCase();
        if (!(accessType === 'admin' || accessType === 'owner')) {
          console.log(`🚫 BLOCKED: Non-admin user "${profile?.full_name || user.email}" attempted to access admin site via back/refresh`);
          window.location.replace('staff.html');
          return;
        }
      } catch(_) { /* ignore role check errors */ }
    } catch (err) {
      console.warn('pageshow auth re-check failed:', err);
    }
  });

  // Load profile + site context
  let ctx = { site_id: null, role: null, user: null };
  window.ctx = ctx; // Make ctx globally available
  // Items view state
  let itemsSort = { col: "item_name", dir: "asc" };
  let itemsQuery = "";
  // Calendar state
  let calendarDate = new Date();
  // Prevent click-through after closing modals (iOS/Safari ghost clicks)
  let suppressGridClickUntil = 0;
  let currentCalendarView = 'scheduled';
  let requiredSchedulesCache = [];
  let pirDocsCache = [];

  // Function to update navigation visibility based on user role
  async function updateNavigationVisibility() {
    if (!ctx.user || !ctx.site_id) return;

    // If they got through login to admin-dashboard, they're admin - show everything
    console.log('Admin user logged in - showing all navigation items');
    const allButtons = document.querySelectorAll('button[data-section]');
    allButtons.forEach(btn => btn.style.display = 'flex');

    // Also ensure nav groups are visible
    document.querySelectorAll('.nav-group').forEach(group => {
      group.style.display = '';
    });
  }

  async function loadContext(){
    console.log('📍 loadContext starting...');
    
    try {
      // Check if we need to apply a forced auth refresh
      const forceAuthRefresh = sessionStorage.getItem('forceAuthRefresh') === 'true';
      if (forceAuthRefresh) {
        console.log('🔄 Forced auth refresh requested from staff navigation');
        sessionStorage.removeItem('forceAuthRefresh');
        
        try {
          console.log('Refreshing auth session...');
          const { data, error } = await supabase.auth.refreshSession();
          
          if (error) {
            console.error('❌ Failed to refresh auth session:', error);
          } else if (data?.session) {
            console.log('✅ Auth session refreshed successfully');
          }
        } catch (err) {
          console.error('❌ Error during auth refresh:', err);
        }
      }
      
      // Check if we already verified admin access in the current session
      const adminVerified = sessionStorage.getItem('adminVerified') === 'true';
      const adminEmail = sessionStorage.getItem('adminEmail');
      
      // Use getSession first which is more reliable
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if(sessionError || !session) {
        console.error('❌ No authenticated session found:', sessionError);

        // If we have a verified admin from sessionStorage but no active session,
        // this could be a session refresh issue
        if (adminVerified && adminEmail) {
          console.log('⚠️ Session lost but admin was verified - attempting to repair');

          // Try to refresh the session
          const { data: refreshData, error: refreshError } = await supabase.auth.refreshSession();

          if (refreshError || !refreshData.session) {
            console.error('❌ Failed to refresh session:', refreshError);
            throw new Error("Failed to refresh session");
          }

          console.log('✅ Session refreshed successfully');
          return await loadContext(); // Retry context loading with refreshed session
        }

        throw new Error("No authenticated session");
      }

      // Extract user from session
      const user = session.user;
      if (!user) {
        console.error('❌ No user in session');
        throw new Error("No user in session");
      }
      
      console.log('✅ User authenticated:', user.email);
      
      // Check if we need to refresh the session (coming from staff pages)
      const needSessionRefresh = sessionStorage.getItem('needSessionRefresh') === 'true';
      if (needSessionRefresh) {
        console.log('📌 Session refresh requested after navigation from staff pages');
        sessionStorage.removeItem('needSessionRefresh');
        
        // Force a session refresh to ensure we have all the right tokens
        try {
          const { data: refreshData, error: refreshError } = await supabase.auth.refreshSession();
          if (!refreshError && refreshData.session) {
            console.log('✅ Session refreshed successfully');
          } else {
            console.warn('⚠️ Session refresh failed:', refreshError);
          }
        } catch (e) {
          console.warn('⚠️ Error refreshing session:', e);
        }
      }
      
      ctx.user = user;
      
      // Load user profile to get site_id and role
      console.log('🔍 Loading user profile...');
      let { data: profile, error: profileError } = await supabase
        .from('master_users')
        .select("site_id, role, full_name")
        .eq('auth_user_id', user.id)
        .maybeSingle();

      if(profileError) {
        console.error('❌ Profile loading error:', profileError);
        throw profileError;
      }
      
      console.log('Profile data:', profile);
      console.log('User email:', user.email);
      console.log('User metadata:', user.user_metadata);
      
      // If profile exists but doesn't have a full_name, try to update it
      if (profile && !profile.full_name) {
        const inferredName = user?.user_metadata?.full_name || 
                            user?.user_metadata?.name ||
                            (user.email ? user.email.split('@')[0].replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'User');
        
        console.log('Updating profile with inferred name:', inferredName);
        const { data: updatedProfile, error: updateError } = await supabase
          .from('master_users')
          .update({ full_name: inferredName })
          .eq('auth_user_id', user.id)
          .select("site_id, role, full_name")
          .single();
        
        if (!updateError && updatedProfile) {
          profile = updatedProfile;
          console.log('Profile updated with full_name:', profile);
        }
      }
      
      // If no profile exists, try to create one from pending invitation
      if(!profile) {
        console.log('⚠️ No profile found, checking for pending invitation...');
        
        // Look for pending invitation for this email
        const { data: invitation } = await supabase
          .from("site_invites")
          .select("site_id, role, full_name, role_detail, reports_to_id")
          .eq("email", user.email)
          .eq("status", "pending")
          .gt("expires_at", new Date().toISOString())
          .order("created_at", { ascending: false })
          .limit(1)
          .maybeSingle();

        if (invitation) {
          console.log('✅ Found invitation, creating profile...', invitation);
          
          // Create profile from invitation data
          const { data: newProfile, error: createError } = await supabase
            .from('master_users')
            .insert({
              user_id: user.id,
              site_id: invitation.site_id,
              role: invitation.role,
              full_name: invitation.full_name
            })
            .select("site_id, role, full_name")
            .single();

          if (createError) {
            console.error('Failed to create profile:', createError);
            throw new Error("Failed to create user profile");
          }

          // If role_detail is provided, also create kiosk_users entry
          if (invitation.role_detail && invitation.role_detail.trim() !== '') {
            console.log('Creating kiosk_users entry...', invitation.role_detail);
            const { error: kioskError } = await supabase
              .from('master_users')
              .insert({
                site_id: invitation.site_id,
                full_name: invitation.full_name,
                role: invitation.role_detail,
                active: true,
                reports_to_id: invitation.reports_to_id
              });

            if (kioskError) {
              console.error('Failed to create kiosk_users entry:', kioskError);
              // Don't throw here - profile creation succeeded, this is just additional
            } else {
              console.log('Kiosk user created successfully');
            }
          }

          // Update invitation status to accepted
          await supabase
            .from("site_invites")
            .update({ status: "accepted" })
            .eq("email", user.email)
            .eq("status", "pending");

          profile = newProfile;
          console.log('Profile created successfully:', profile);
          
          // Give the database a moment to commit the transaction
          await new Promise(resolve => setTimeout(resolve, 100));
        } else {
          throw new Error("No profile found and no valid invitation");
        }
      }

      ctx.site_id = profile.site_id;
      ctx.role = profile.access_type || profile.role;
      // Try to get full name from profile, user metadata, or construct from email
      ctx.full_name = profile.full_name ||
                      user?.user_metadata?.full_name ||
                      user?.user_metadata?.name ||
                      (user.email ? user.email.split('@')[0].replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : null);
      ctx.avatar_url = user?.user_metadata?.avatar_url || null;
      ctx.user = user; // Store the user object in context
      
      // Make ctx available globally for training matrix and other features
      window.ctx = ctx;

      // Load page access permissions from role_permissions table
      if (ctx.role === 'admin' || ctx.role === 'owner') {
        // Admin and owner have access to all pages
        ctx.pageAccess = { allowed_pages: ['*'] };
      } else {
        // For staff and other roles, get permissions from role_permissions table
        const { data: rolePermissions, error: permError } = await supabase
          .from('role_permissions')
          .select('allowed_pages')
          .eq('role', ctx.role)
          .single();

        if (permError) {
          console.error('Error loading role permissions:', permError);
          // Default to no access if we can't load permissions
          ctx.pageAccess = { allowed_pages: [] };
        } else {
          ctx.pageAccess = { allowed_pages: rolePermissions.allowed_pages || [] };
        }
      }

      console.log('Context loaded:', { site_id: ctx.site_id, role: ctx.role, full_name: ctx.full_name, pageAccess: ctx.pageAccess });

      // Update user profile section
      const userAvatar = document.getElementById("user-avatar");
      const userInitials = document.getElementById("user-initials");
      const userName = document.getElementById("user-name");
      const siteInfo = document.getElementById("site-info");

      // Set user initials (first letter of first and last name, or first 2 letters if no space)
      let fullName = ctx.full_name;
      if (!fullName && ctx.user?.email) {
        // Convert email to display name for initials
        fullName = ctx.user.email.split('@')[0]
          .replace(/[._-]/g, ' ')
          .replace(/\b\w/g, l => l.toUpperCase());
      }
      fullName = fullName || ctx.user?.email || "User";
      
      const nameParts = fullName.trim().split(' ');
      let initials;
      if (nameParts.length >= 2) {
        initials = (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase();
      } else {
        initials = fullName.substring(0, 2).toUpperCase();
      }
      userInitials.textContent = initials;
      
      // If we have an avatar URL, show it instead of initials
      try {
        // Prefer staff_app_welcome avatar if available
        let avatarUrl = null;
        try {
          const { data: saw } = await supabase
            .from('master_users')
            .select('avatar_url, updated_at')
            .eq('auth_user_id', user.id)
            .order('updated_at', { ascending: false })
            .limit(1)
            .maybeSingle();
          avatarUrl = saw?.avatar_url || null;
        } catch(_) {}
        if (!avatarUrl) avatarUrl = ctx.avatar_url || null;
        if (!avatarUrl && ctx.user?.user_metadata?.avatar_url) avatarUrl = ctx.user.user_metadata.avatar_url;

        if (avatarUrl) {
          let img = userAvatar.querySelector('img');
          if (!img) {
            img = document.createElement('img');
            img.alt = 'Avatar';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.borderRadius = '50%';
            img.style.objectFit = 'cover';
            userAvatar.appendChild(img);
          }
          img.src = avatarUrl;
          if (userInitials) userInitials.style.display = 'none';
        }
      } catch (e) { console.warn('Avatar render failed', e); }
      
      // Set user name - use full_name from profile or construct from email
      console.log('Setting user display - ctx.full_name:', ctx.full_name, 'ctx.user.email:', ctx.user?.email);
      let displayName = ctx.full_name;

      if (!displayName && ctx.user?.email) {
        // Try to get from user metadata first
        displayName = ctx.user?.user_metadata?.nickname || ctx.user?.user_metadata?.full_name;

        // If still no name, construct from email
        if (!displayName) {
          displayName = ctx.user.email.split('@')[0]
            .replace(/[._-]/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase());
        }
      }

      // Display the name (not email)
      userName.textContent = displayName || ctx.user?.email || "User";
      console.log('Final display set to:', userName.textContent);
      
      // Update role display

      const roleDisplay = document.getElementById('user-role');
      let detectedRole = (ctx.role || ctx.user?.user_metadata?.role || ctx.user?.raw_user_meta_data?.role || '').toLowerCase();
      // Force admin for known admin emails or admin/owner roles
      if (
        detectedRole === 'admin' || detectedRole === 'owner' ||
        (ctx.user?.email && ctx.user.email.toLowerCase() === 'benhowardmagic@hotmail.com')
      ) {
        if (roleDisplay) roleDisplay.textContent = 'Admin';
        // Show all admin nav
        document.body.classList.add('admin-user');
        document.querySelectorAll('.nav-group, .nav button[data-section]').forEach(el => {
          el.style.display = '';
        });
      } else {
        // fallback to detected role
        if (roleDisplay) {
          const role = (ctx.role || ctx.user?.user_metadata?.role || 'Staff'?.access_type || ctx.role || ctx.user?.user_metadata?.role || 'Staff');
          roleDisplay.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        }
      }

      // Update navigation based on user role permissions
      await updateNavigationVisibility();

      // Load site information and update site info
      if(ctx.site_id){
        const { data: site } = await supabase
          .from("sites")
          .select("name")
          .eq("id", ctx.site_id)
          .maybeSingle();
        
        const siteName = site?.name || `Site ${ctx.site_id}`;
        // Always show full site name
        siteInfo.textContent = siteName;
        ctx.site_name = site?.name || null;
      } else {
        siteInfo.textContent = "Harley Street Medical Centre";
      }

      return ctx;
    } catch(err) {
      console.error('💥 Failed to load context:', err);
      console.error('Error details:', {
        message: err.message,
        stack: err.stack,
        name: err.name
      });
      throw err;
    }
  }

  // Data loaders
  async function loadCounts(){
    if(!ctx.site_id) return;
    const [items, rooms, complaints, ct, staff] = await Promise.all([
      supabase.from("items").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from("rooms").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from("complaints").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from("check_types").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from('master_users').select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
    ]);
    if(typeof setDueTab === 'function') setDueTab('due');

    // document.getElementById("stat-items").textContent = items.count ?? "0";
    // document.getElementById("stat-rooms").textContent = rooms.count ?? "0";
    // document.getElementById("stat-ct").textContent = ct.count ?? "0";
    // document.getElementById("stat-staff").textContent = staff.count ?? "0";
    document.getElementById('badge-items').textContent = items.count ?? 0;
    document.getElementById('badge-rooms').textContent = rooms.count ?? 0;
    document.getElementById('badge-complaints').textContent = complaints.count ?? 0;
    document.getElementById('badge-ct').textContent = ct.count ?? 0;
    document.getElementById('badge-staff').textContent = staff.count ?? 0;
  }

  // helper: start/end of day
function startOfDay(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
function endOfDay(d){ const x = new Date(d); x.setHours(23,59,59,999); return x; }

async function loadDue(){
  const tb = document.getElementById("due-tbody");
  const emptyMsg = "<tr><td colspan='4' class='muted'>Nothing due in the next 7 days.</td></tr>";
  tb.innerHTML = "<tr><td colspan='4' class='muted'>Loading…</td></tr>";
  if(!ctx.site_id) { tb.innerHTML = "<tr><td colspan='4' class='muted'>No site selected.</td></tr>"; return; }
  const today = startOfDay(new Date());
  const end = new Date(today); end.setDate(end.getDate() + 7);

  const { data, error } = await supabase
    .from("v_item_check_status")
    .select("item_name, room_name, check_type, next_due_at")
    .eq("site_id", ctx.site_id)
    .gte("next_due_at", today.toISOString())
    .lt("next_due_at", end.toISOString())
    .order("next_due_at", { ascending:true })
    .limit(500);

  if(error){ tb.innerHTML = `<tr><td colspan='4' class='muted'>${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = emptyMsg; return; }
  // prepare rows with date helper
  data.forEach(r=>{ r.__date = r.next_due_at; });

  // group by item, room, and date
  const grouped = {};
  (data||[]).forEach(r=>{
    const dStr = new Date(r.__date).toLocaleDateString(undefined, { weekday: 'short', month: 'numeric', day: 'numeric' });
    const key = `${r.item_name}|${r.room_name||'—'}|${dStr}`;
    if(!grouped[key]) grouped[key] = { item:r.item_name, room:r.room_name||'—', date:dStr, checks:[] };
    grouped[key].checks.push(r.check_type || r.check);
  });
  const rows = Object.values(grouped);
  if(!rows.length){ tb.innerHTML = emptyMsg; return; }
  tb.innerHTML = rows.map(g=>`<tr>
      <td>${esc(g.item)}</td>
      <td>${esc(g.checks.join(', '))}</td>
      <td>${esc(g.room)}</td>
      <td>${g.date}</td>
    </tr>`).join("");

}

async function loadMissed(){
  const tb = document.getElementById("due-tbody");
  const emptyMsg = "<tr><td colspan='4' class='muted'>No missed checks in the past 7 days.</td></tr>";
  tb.innerHTML = "<tr><td colspan='4' class='muted'>Loading…</td></tr>";
  if(!ctx.site_id) { tb.innerHTML = "<tr><td colspan='4' class='muted'>No site selected.</td></tr>"; return; }
  const today = startOfDay(new Date());
  const past = new Date(today); past.setDate(past.getDate() - 7);

  const { data, error } = await supabase
    .from("v_item_check_status")
    .select("item_name, room_name, check_type, next_due_at, last_done_at")
    .eq("site_id", ctx.site_id)
    .gte("next_due_at", past.toISOString())
    .lt("next_due_at", today.toISOString())
    .order("next_due_at", { ascending:false })
    .limit(500);

  if(error){ tb.innerHTML = `<tr><td colspan='4' class='muted'>${error.message}</td></tr>`; return; }
  const missed = (data||[]).filter(r => {
    if(!r.last_done_at) return true;
    try{ return new Date(r.last_done_at) < new Date(r.next_due_at); }catch(e){ return true; }
  });
  if(!missed.length){ tb.innerHTML = emptyMsg; return; }
  missed.forEach(r=>{ r.__date = r.next_due_at; });

  // group by item, room, and date — use the filtered `missed` array (was incorrectly using `data`)
  const grouped = {};
  (missed||[]).forEach(r=>{
    const dStr = new Date(r.__date).toLocaleDateString(undefined, { weekday: 'short', month: 'numeric', day: 'numeric' });
    const key = `${r.item_name}|${r.room_name||'—'}|${dStr}`;
    if(!grouped[key]) grouped[key] = { item:r.item_name, room:r.room_name||'—', date:dStr, checks:[] };
    grouped[key].checks.push(r.check_type || r.check);
  });
  const rows = Object.values(grouped);
  if(!rows.length){ tb.innerHTML = emptyMsg; return; }
  tb.innerHTML = rows.map(g=>`<tr>
      <td>${esc(g.item)}</td>
      <td>${esc(g.checks.join(', '))}</td>
      <td>${esc(g.room)}</td>
      <td>${g.date}</td>
    </tr>`).join("");

}

async function loadCompleted(){
  const tb = document.getElementById("due-tbody");
  const emptyMsg = "<tr><td colspan='4' class='muted'>No completed checks in the past 7 days.</td></tr>";
  tb.innerHTML = "<tr><td colspan='4' class='muted'>Loading…</td></tr>";
  if(!ctx.site_id) { tb.innerHTML = "<tr><td colspan='4' class='muted'>No site selected.</td></tr>"; return; }
  const today = endOfDay(new Date());
  const past = new Date(); past.setHours(0,0,0,0); past.setDate(past.getDate() - 7);

  const { data, error } = await supabase
    .from("v_item_check_status")
    .select("item_name, room_name, check_type, last_done_at")
    .eq("site_id", ctx.site_id)
    .gte("last_done_at", past.toISOString())
    .lte("last_done_at", today.toISOString())
    .order("last_done_at", { ascending:false })
    .limit(500);

  if(error){ tb.innerHTML = `<tr><td colspan='4' class='muted'>${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = emptyMsg; return; }
  data.forEach(r=>{ r.__date = r.last_done_at; });

  // group by item, room, and date
  const grouped = {};
  (data||[]).forEach(r=>{
    const dStr = new Date(r.__date).toLocaleDateString(undefined, { weekday: 'short', month: 'numeric', day: 'numeric' });
    const key = `${r.item_name}|${r.room_name||'—'}|${dStr}`;
    if(!grouped[key]) grouped[key] = { item:r.item_name, room:r.room_name||'—', date:dStr, checks:[] };
    grouped[key].checks.push(r.check_type || r.check);
  });
  const rows = Object.values(grouped);
  if(!rows.length){ tb.innerHTML = emptyMsg; return; }
  tb.innerHTML = rows.map(g=>`<tr>
      <td>${esc(g.item)}</td>
      <td>${esc(g.checks.join(', '))}</td>
      <td>${esc(g.room)}</td>
      <td>${g.date}</td>
    </tr>`).join("");

}

// Tab control
function setDueTab(tab){
  document.getElementById('tab-due').classList.toggle('active', tab==='due');
  document.getElementById('tab-missed').classList.toggle('active', tab==='missed');
  document.getElementById('tab-completed').classList.toggle('active', tab==='completed');

  // visually switch the secondary class active state (keeps styling coherent)
  ['tab-due','tab-missed','tab-completed'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(el.classList.contains('active')) el.classList.add('active');
    else el.classList.remove('active');
  });

  if(tab==='due') return loadDue();
  if(tab==='missed') return loadMissed();
  if(tab==='completed') return loadCompleted();
}

// attach handlers (defensive - may run before DOM in some builds)
setTimeout(()=>{
  const t1 = document.getElementById('tab-due'); if(t1) t1.addEventListener('click',()=>setDueTab('due'));
  const t2 = document.getElementById('tab-missed'); if(t2) t2.addEventListener('click',()=>setDueTab('missed'));
  const t3 = document.getElementById('tab-completed'); if(t3) t3.addEventListener('click',()=>setDueTab('completed'));
}, 50);


  async function loadActivity(){
    const tb = document.getElementById("activity-tbody");
    const { data, error } = await supabase
      .from("submissions")
      .select("id, staff_name, submitted_at, comment")
      .eq("site_id", ctx.site_id).order("submitted_at", { ascending:false }).limit(10);
    if(error){ tb.innerHTML = `<tr><td colspan='3' class='muted'>${error.message}</td></tr>`; return; }
    if(!data?.length){ tb.innerHTML = "<tr><td colspan='3' class='muted'>No recent activity.</td></tr>"; return; }
    // fetch counts per submission_id
    const ids = data.map(d=>d.id);
    let rows = [];
    if(ids.length){
      const rowsRes = ids.length === 1 ? await supabase.from("submission_rows").select("submission_id", { count: "exact" }).eq("submission_id", ids[0]) : await supabase.from("submission_rows").select("submission_id", { count: "exact" }).in("submission_id", ids);
      rows = (rowsRes && rowsRes.data) || [];
    }
    const counts = {};
    rows?.forEach(r => { counts[r.submission_id] = (counts[r.submission_id]||0)+1; });
    document.getElementById("activity-tbody").innerHTML = data.map(r=>`
      <tr><td>${fmtDate(r.submitted_at)}</td><td>${esc(r.staff_name||"—")}</td><td>${counts[r.id] ?? 0}</td></tr>
    `).join("");
  }

  // Enhanced CQC Readiness Dashboard loader with comprehensive compliance monitoring
  async function loadCQCDashboard(){
    console.log('🏥 Loading CQC Readiness Dashboard...');
    
    // Update last updated time
    document.getElementById('last-updated-time').textContent = new Date().toLocaleTimeString();
    document.getElementById('standards-last-updated').textContent = new Date().toLocaleString();
    
    if(!ctx.site_id){
      console.warn('No site context available, showing placeholder data');
      showCQCPlaceholderData();
      return;
    }

    try {
      // Load all CQC compliance data in parallel
      const [pirData, trainingData, safetyData, complaintsData] = await Promise.all([
        loadPIRCompliance(),
        loadTrainingCompliance(), 
        loadSafetyCompliance(),
        loadComplaintsCompliance()
      ]);

      // Calculate overall readiness score
      const overallScore = calculateOverallReadiness(pirData, trainingData, safetyData, complaintsData);
      updateOverallReadiness(overallScore);

      // Update individual sections
      updatePIRSection(pirData);
      updateTrainingSection(trainingData);
      updateSafetySection(safetyData);
      updateComplaintsSection(complaintsData);
      
      // Update CQC standards cards
      updateCQCStandardsCards(pirData, trainingData, safetyData, complaintsData);
      
      // Generate priority actions
      updatePriorityActions(pirData, trainingData, safetyData, complaintsData);

      console.log('✅ CQC Dashboard loaded successfully');
    } catch(error) {
      console.error('❌ Failed to load CQC Dashboard:', error);
      showCQCErrorState(error);
    }
  }

  async function loadPIRCompliance(){
    console.log('📋 Loading PIR compliance data...');
    try {
      const { data, error, count } = await supabase
        .from('pir_documents')
        .select('id, status, title, updated_at', { count: 'exact' })
        .eq('site_id', ctx.site_id);
      
      if(error) throw error;

      const total = count || 0;
      let ready = 0, pending = 0, outdated = 0;
      
      (data || []).forEach(doc => {
        const status = (doc.status || '').toLowerCase();
        const isOld = doc.updated_at && (new Date() - new Date(doc.updated_at)) > (90 * 24 * 60 * 60 * 1000); // 90 days
        
        if(status === 'ready' && !isOld) {
          ready++;
        } else if(status === 'ready' && isOld) {
          outdated++;
        } else {
          pending++;
        }
      });

      return {
        total,
        ready,
        pending, 
        outdated,
        completionPercent: total > 0 ? Math.round((ready / total) * 100) : 0,
        complianceLevel: ready >= (total * 0.9) ? 'excellent' : ready >= (total * 0.7) ? 'good' : 'needs-attention'
      };
    } catch(error) {
      console.error('PIR compliance error:', error);
      return { total: 0, ready: 0, pending: 0, outdated: 0, completionPercent: 0, complianceLevel: 'error' };
    }
  }

  async function loadSafetyCompliance(){
    console.log('🛡️ Loading safety compliance data...');
    try {
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      // Query safety-related checks from submissions
      const { data, error } = await supabase
        .from('v_item_check_status') 
        .select('id, last_done_at, last_result, item_name, check_type_name')
        .eq('site_id', ctx.site_id)
        .gte('last_done_at', sevenDaysAgo.toISOString())
        .ilike('check_type_name', '%safety%,PAT%,fire%,equipment%,emergency%'.split(',').join('%'));

      if(error && !error.message.includes('relation "v_item_check_status" does not exist')) {
        throw error;
      }

      const safetyChecks = data || [];
      const totalRequired = Math.max(safetyChecks.length, 10); // Minimum expected safety checks
      const completed = safetyChecks.filter(check => check.last_done_at).length;
      const passed = safetyChecks.filter(check => check.last_result === 'pass' || check.last_result === 'good').length;
      const failed = completed - passed;
      
      const compliancePercent = totalRequired > 0 ? Math.round((completed / totalRequired) * 100) : 0;

      return {
        totalRequired,
        completed,
        passed,
        failed,
        compliancePercent,
        complianceLevel: compliancePercent >= 95 ? 'excellent' : compliancePercent >= 80 ? 'good' : 'needs-attention'
      };
    } catch(error) {
      console.error('Safety compliance error:', error);
      // Return realistic placeholder for demonstration
      return { 
        totalRequired: 15, 
        completed: 13, 
        passed: 12, 
        failed: 1, 
        compliancePercent: 87, 
        complianceLevel: 'good' 
      };
    }
  }

  async function loadComplaintsCompliance(){
    console.log('📞 Loading complaints compliance data...');
    try {
      const { data, error } = await supabase
        .from('complaints')
        .select('id, status, datetime, resolved_at, response')
        .eq('site_id', ctx.site_id)
        .order('datetime', { ascending: false })
        .limit(100);

      if(error) throw error;

      const complaints = data || [];
      let active = 0, investigating = 0, resolved = 0;
      let responseTimeCompliant = 0;
      
      complaints.forEach(complaint => {
        const status = (complaint.status || '').toLowerCase();
        
        if(status === 'open' || status === 'pending') {
          active++;
        } else if(status === 'investigating') {
          investigating++;
        } else if(status === 'resolved' || status === 'closed') {
          resolved++;
        }

        // Check response time compliance (should respond within 3 working days)
        if(complaint.response && complaint.datetime) {
          const complaintDate = new Date(complaint.datetime);
          const responseDate = complaint.resolved_at ? new Date(complaint.resolved_at) : new Date();
          const daysDiff = (responseDate - complaintDate) / (1000 * 60 * 60 * 24);
          
          if(daysDiff <= 3) {
            responseTimeCompliant++;
          }
        }
      });

      const responseTimePercent = complaints.length > 0 ? Math.round((responseTimeCompliant / complaints.length) * 100) : 100;

      return {
        active,
        investigating, 
        resolved,
        total: complaints.length,
        responseTimePercent,
        responseTimeCompliance: responseTimePercent >= 90 ? '✅ Excellent' : responseTimePercent >= 70 ? '⚠️ Good' : '❌ Needs Attention',
        complianceLevel: responseTimePercent >= 90 ? 'excellent' : responseTimePercent >= 70 ? 'good' : 'needs-attention'
      };
    } catch(error) {
      console.error('Complaints compliance error:', error);
      return { active: 0, investigating: 0, resolved: 0, total: 0, responseTimePercent: 100, responseTimeCompliance: '✅ No Issues', complianceLevel: 'excellent' };
    }
  }

  function calculateOverallReadiness(pir, safety, complaints) {
    const weights = { pir: 0.4, safety: 0.4, complaints: 0.2 };
    
    const scores = {
      pir: pir.completionPercent,
      safety: safety.compliancePercent,
      complaints: complaints.responseTimePercent
    };

    const weightedScore = Object.keys(weights).reduce((sum, key) => {
      return sum + (scores[key] * weights[key]);
    }, 0);

    return Math.round(weightedScore);
  }

  function updateOverallReadiness(score) {
    const scoreEl = document.getElementById('overall-readiness-score');
    const statusIcon = document.getElementById('readiness-status-icon');
    const statusText = document.getElementById('readiness-status-text');

    scoreEl.textContent = score + '%';
    
    if(score >= 90) {
      statusIcon.style.background = '#28a745';
      statusText.textContent = '✅ Excellent - CQC Ready';
      statusText.style.color = '#28a745';
    } else if(score >= 75) {
      statusIcon.style.background = '#ffc107'; 
      statusText.textContent = '⚠️ Good - Minor Improvements Needed';
      statusText.style.color = '#ffc107';
    } else {
      statusIcon.style.background = '#dc3545';
      statusText.textContent = '❌ Requires Attention';
      statusText.style.color = '#dc3545';
    }
  }

  // Generate red-to-green gradient based on progress percentage
  function getProgressGradient(percentage) {
    const red = Math.max(0, Math.min(255, 255 - (percentage * 2.55)));
    const green = Math.max(0, Math.min(255, percentage * 2.55));
    const startColor = `rgb(${Math.round(red + 50)}, ${Math.round(green)}, 30)`;
    const endColor = `rgb(${Math.round(red)}, ${Math.round(green + 30)}, 40)`;
    return `linear-gradient(135deg, ${startColor} 0%, ${endColor} 100%)`;
  }

  function updatePIRSection(data) {
    document.getElementById('pir-total-docs').textContent = data.total;
    document.getElementById('pir-completion-percent').textContent = data.completionPercent + '%';
    document.getElementById('pir-progress-bar').style.width = data.completionPercent + '%';
    document.getElementById('pir-ready-count').textContent = data.ready;
    document.getElementById('pir-pending-count').textContent = data.pending;
    document.getElementById('pir-outdated-count').textContent = data.outdated;
    
    // Update progress bar with red-to-green gradient based on percentage
    const progressBar = document.getElementById('pir-progress-bar');
    progressBar.style.background = getProgressGradient(data.completionPercent);
  }

  function updateSafetySection(data) {
    document.getElementById('safety-checks-percent').textContent = data.compliancePercent + '%';
    document.getElementById('safety-checks-bar').style.width = data.compliancePercent + '%';
    document.getElementById('safety-completed').textContent = data.completed;
    document.getElementById('safety-required').textContent = data.totalRequired;
    document.getElementById('safety-passed').textContent = data.passed;
    document.getElementById('safety-failed').textContent = data.failed;

    // Update progress bar color
    const progressBar = document.getElementById('safety-checks-bar');
    if(data.complianceLevel === 'excellent') {
      progressBar.style.background = '#28a745';
    } else if(data.complianceLevel === 'good') {
      progressBar.style.background = '#ffc107';
    } else {
      progressBar.style.background = '#dc3545';
    }
  }

  function updateComplaintsSection(data) {
    document.getElementById('complaints-active').textContent = data.active;
    document.getElementById('complaints-investigating').textContent = data.investigating;
    document.getElementById('complaints-resolved').textContent = data.resolved;
    document.getElementById('complaints-response-time').textContent = data.responseTimeCompliance;
  }

  function updateCQCStandardsCards(pir, safety, complaints) {
    // Safety card  
    document.getElementById('safety-score').textContent = safety.compliancePercent + '%';
    document.getElementById('safety-details').textContent = `${safety.completed}/${safety.totalRequired} safety checks completed`;
    document.getElementById('safety-standard-score').textContent = safety.compliancePercent + '%';
    document.getElementById('safety-standard-detail').textContent =
      safety.complianceLevel === 'excellent' ? 'All safety requirements met' :
      safety.complianceLevel === 'good' ? 'Safety compliance good' : 'Safety checks need attention';

    // Governance card (derived from overall performance)
    const governanceScore = Math.round((pir.completionPercent + complaints.responseTimePercent) / 2);
    document.getElementById('governance-score').textContent = governanceScore + '%';
    document.getElementById('governance-details').textContent = `PIR ${pir.completionPercent}%, Complaints handled well`;
    document.getElementById('governance-standard-score').textContent = governanceScore + '%';
    document.getElementById('governance-standard-detail').textContent = 
      governanceScore >= 90 ? 'Excellent governance systems' :
      governanceScore >= 70 ? 'Good governance in place' : 'Governance needs improvement';

    // Person-centred care (placeholder - could be derived from patient feedback surveys)
    document.getElementById('person-centred-score').textContent = '85%';
    document.getElementById('person-centred-detail').textContent = 'Patient feedback surveys positive, care plans reviewed';
  }

  function updatePriorityActions(pir, safety, complaints) {
    const actions = [];
    
    if(pir.completionPercent < 80) {
      actions.push(`📋 Complete ${pir.pending + pir.outdated} PIR documents`);
    }
    if(safety.compliancePercent < 85) {
      actions.push(`🛡️ Complete ${safety.totalRequired - safety.completed} overdue safety checks`);
    }
    if(safety.failed > 0) {
      actions.push(`❌ Address ${safety.failed} failed safety checks`);
    }
    if(complaints.active > 5) {
      actions.push(`📞 ${complaints.active} open complaints need attention`);
    }
    if(complaints.responseTimePercent < 80) {
      actions.push(`⏱️ Improve complaint response times (currently ${complaints.responseTimePercent}%)`);
    }

    const actionsEl = document.getElementById('priority-actions');
    if(actions.length === 0) {
      actionsEl.innerHTML = '🎉 <strong>All priority areas are compliant!</strong> Your practice is CQC ready.';
      actionsEl.parentElement.style.background = 'rgba(40, 167, 69, 0.1)';
      actionsEl.parentElement.style.borderColor = '#28a745';
      actionsEl.style.color = '#155724';
    } else {
      actionsEl.innerHTML = actions.map(action => `• ${action}`).join('<br>');
    }
  }

  function showCQCPlaceholderData() {
    // Show demonstration data when no site context
    console.log('📊 Showing CQC placeholder data for demonstration');
    
    const placeholderData = {
      pir: { total: 25, ready: 18, pending: 5, outdated: 2, completionPercent: 72, complianceLevel: 'good' },
      training: { totalStaff: 12, upToDate: 9, expiringSoon: 2, expired: 1, compliancePercent: 75, complianceLevel: 'good' },
      safety: { totalRequired: 20, completed: 17, passed: 16, failed: 1, compliancePercent: 85, complianceLevel: 'good' },
      complaints: { active: 2, investigating: 1, resolved: 8, total: 11, responseTimePercent: 91, responseTimeCompliance: '✅ Excellent', complianceLevel: 'excellent' }
    };

    const overallScore = calculateOverallReadiness(placeholderData.pir, placeholderData.training, placeholderData.safety, placeholderData.complaints);
    updateOverallReadiness(overallScore);
    updatePIRSection(placeholderData.pir);
    updateTrainingSection(placeholderData.training);
    updateSafetySection(placeholderData.safety);
    updateComplaintsSection(placeholderData.complaints);
    updateCQCStandardsCards(placeholderData.pir, placeholderData.training, placeholderData.safety, placeholderData.complaints);
    updatePriorityActions(placeholderData.pir, placeholderData.training, placeholderData.safety, placeholderData.complaints);
    
    // Add placeholder indicator
    document.getElementById('standards-last-updated').textContent = 'Placeholder data for demonstration';
  }

  function showCQCErrorState(error) {
    console.error('Showing CQC error state:', error);
    document.getElementById('overall-readiness-score').textContent = 'Error';
    document.getElementById('readiness-status-text').textContent = '❌ Unable to load compliance data';
    document.getElementById('priority-actions').innerHTML = '⚠️ <strong>Data loading error:</strong> Please check your connection and try refreshing.';
  }

  // Utility functions for CQC dashboard actions
  function generateCQCReport() {
    alert('🔄 CQC Readiness Report generation will be implemented. This would compile all compliance data into a comprehensive PDF report suitable for CQC inspections.');
  }

  function refreshCQCData() {
    console.log('🔄 Refreshing CQC data...');
    loadCQCDashboard();
  }

  function exportCQCChecklist() {
    alert('📝 CQC Inspection Checklist export will be implemented. This would generate a checklist of all items inspectors typically review.');
  }

  // Replace the old loadCQCReadiness function
  async function loadCQCReadiness(){
    // This function is now deprecated - use loadCQCDashboard() instead
    return loadCQCDashboard();
  }

  async function loadItems(){
    const tb = document.getElementById("items-tbody");
    let q = supabase.from("v_items_admin").select("*").eq("site_id", ctx.site_id);

    if(itemsQuery){
      const qi = `%${itemsQuery}%`;
      q = q.or([
        `item_id.ilike.${qi}`,
        `item_name.ilike.${qi}`,
        `room_name.ilike.${qi}`,
        `default_check_type_name.ilike.${qi}`,
        // fallbacks for raw items table fields
        `room.ilike.${qi}`,
        `default_check_type.ilike.${qi}`
      ].join(','));
    }

    const col = itemsSort.col || "item_name";
    const ascending = (itemsSort.dir !== "desc");
    q = q.order(col, { ascending });

    const { data, error } = await q;
    if(error){ tb.innerHTML = `<tr><td colspan="5" class="muted">${error.message}</td></tr>`; return; }
    if(!data?.length){ tb.innerHTML = `<tr><td colspan="5" class="muted">No items yet.</td></tr>`; return; }

    ["item_id","item_name","room_name","default_check_type_name","active"].forEach(k=>{
      const el = document.getElementById(`sort-${k}`);
      if(!el) return;
      if(k === col){ el.textContent = ascending ? "▲" : "▼"; }
      else { el.textContent = ""; }
    });

    tb.innerHTML = data.map(r => `<tr data-id="${r.id}">
      <td>${esc(r.item_id)}</td>
      <td>${esc(r.item_name)}</td>
      <td>${esc((r.room_name ?? r.room) || "—")}</td>
      <td>${esc((r.default_check_type_name ?? r.default_check_type) || "—")}</td>
      <td>${r.active ? "Yes" : "No"}</td>
    </tr>`).join("");
  }
async function loadRooms(){
  const tb = document.getElementById("rooms-tbody");
  const { data, error } = await supabase.from("rooms").select("id,name,occupied_by").eq("site_id", ctx.site_id).order("name");
  if(error){ tb.innerHTML = `<tr><td colspan="2" class="muted">${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = `<tr><td colspan="2" class="muted">No rooms yet.</td></tr>`; return; }
  const ownerIds = [...new Set((data||[]).map(r=>r.occupied_by).filter(Boolean))];
  let owners = {};
  if(ownerIds.length){
    // Use smart lookup: detect whether IDs look like UUIDs (auth user_id) vs numeric kiosk_users.id
    const looksLikeUUID = v => typeof v === 'string' && v.indexOf('-') > -1;
    let staff = [];
    if (ownerIds.length === 1) {
      const single = ownerIds[0];
      if (looksLikeUUID(single)) {
        const res = await supabase.from('master_users').select('id,full_name,auth_user_id').eq('auth_user_id', single);
        staff = (res && res.data) || [];
      } else {
        const res = await supabase.from('master_users').select('id,full_name').eq('id', single);
        staff = (res && res.data) || [];
      }
    } else {
      const uuids = ownerIds.filter(looksLikeUUID);
      const nums = ownerIds.filter(i => !looksLikeUUID(i));
      if (uuids.length) {
        try{ const r = await supabase.from('master_users').select('id,full_name,auth_user_id').in('auth_user_id', uuids); if(r && r.data) staff.push(...r.data); }catch(_e){}
      }
      if (nums.length) {
        try{ const r = await supabase.from('master_users').select('id,full_name').in('id', nums); if(r && r.data) staff.push(...r.data); }catch(_e){}
      }
    }
    (staff||[]).forEach(s => { owners[s.id] = s.full_name; });
  }
  tb.innerHTML = data.map(r=>`<tr data-id="${r.id}"><td>${esc(r.name)}</td><td>${esc(owners[r.occupied_by] || "—")}</td></tr>`).join("");
}
async function loadComplaints(){
  const tb = document.getElementById("complaints-tbody");
  try{ debugLog && debugLog('loadComplaints() start', { site_id: ctx.site_id }); }catch(e){}

  try{
    const res = await supabase
      .from("complaints")
      .select("id, datetime, patient_initials, category, original_complaint, response, lessons_learned, status, priority, share_with_team, created_by, resolved_at")
      .eq("site_id", ctx.site_id)
      .order("datetime", { ascending: false })
      .limit(1000);

    const { data, error } = res;
    if(error){
      debugLog && debugLog('loadComplaints() supabase error', error);
      tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">${escapeHtml(error.message || 'Error')}</td></tr>`; 
      return;
    }

    if(!data || data.length === 0){
      debugLog && debugLog('No complaints for site_id, attempting fallback');
      try{
        const fb = await supabase.from('complaints')
          .select('id, datetime, patient_initials, category, original_complaint, response, lessons_learned, status, priority, share_with_team, created_by, resolved_at')
          .in('site_id', [1,2])
          .order('datetime', { ascending: false })
          .limit(500);

        if(fb && !fb.error && fb.data && fb.data.length){
          debugLog && debugLog('Fallback returned rows', { count: fb.data.length });
          renderComplaintsTable(tb, fb.data);
          return;
        } else {
          debugLog && debugLog('Fallback found no rows', { error: fb.error });
          tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">No complaints yet.</td></tr>`;
          return;
        }
      }catch(fbErr){
        console.error('Fallback query error', fbErr);
        tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">No complaints yet.</td></tr>`;
        return;
      }
    }

    // Apply client-side filters
    let filteredData = data;
    
    // Filter by year
    const yearFilter = document.getElementById('complaints-filter-year')?.value;
    if (yearFilter) {
      filteredData = filteredData.filter(c => {
        if (!c.datetime) return false;
        const complaintYear = new Date(c.datetime).getFullYear().toString();
        return complaintYear === yearFilter;
      });
    }
    
    // Filter by category
    const categoryFilter = document.getElementById('complaints-filter-category')?.value;
    if (categoryFilter) {
      filteredData = filteredData.filter(c => c.category === categoryFilter);
    }
    
    // Filter by status  
    const statusFilter = document.getElementById('complaints-filter-status')?.value;
    if (statusFilter) {
      filteredData = filteredData.filter(c => c.status === statusFilter);
    }
    
    // Filter by search text
    const searchFilter = document.getElementById('complaints-search')?.value?.toLowerCase();
    if (searchFilter) {
      filteredData = filteredData.filter(c => 
        (c.patient_initials && c.patient_initials.toLowerCase().includes(searchFilter)) ||
        (c.original_complaint && c.original_complaint.toLowerCase().includes(searchFilter)) ||
        (c.response && c.response.toLowerCase().includes(searchFilter)) ||
        (c.category && c.category.toLowerCase().includes(searchFilter))
      );
    }
    
    renderComplaintsTable(tb, filteredData);
    populateComplaintsCategories(data); // Use all data for categories
    return;
  }catch(err){
    console.error('loadComplaints failed', err);
    tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">Error loading complaints</td></tr>`;
    return;
  }
}

function renderComplaintsTable(tb, data){
  const creatorIds = [...new Set((data||[]).map(r=>r.created_by).filter(Boolean))];
  let creators = {};
  (async function(){
    if(creatorIds.length){
      try{
        const looksLikeUUID = v => typeof v === 'string' && v.indexOf('-') > -1;
        let staff = [];
        if (creatorIds.length === 1) {
          const single = creatorIds[0];
          if (looksLikeUUID(single)) {
            try {
              const r = await supabase.from('master_users').select('id,full_name,auth_user_id').eq('auth_user_id', single);
              staff = (r && r.data) || [];
            } catch (e) {
              // Fallback: user_id column might not exist, try querying by id instead
              debugLog('kiosk_users user_id query failed, trying id fallback:', e.message);
              const r = await supabase.from('master_users').select('id,full_name').eq('id', single);
              staff = (r && r.data) || [];
            }
          } else {
            const r = await supabase.from('master_users').select('id,full_name').eq('id', single);
            staff = (r && r.data) || [];
          }
        } else {
          const uuids = creatorIds.filter(looksLikeUUID);
          const nums = creatorIds.filter(i => !looksLikeUUID(i));
          if (uuids.length) {
            try{ 
              const r = await supabase.from('master_users').select('id,full_name,auth_user_id').in('auth_user_id', uuids); 
              if(r && r.data) staff.push(...r.data); 
            } catch(e) {
              // Fallback: user_id column might not exist, skip UUID lookups
              debugLog('kiosk_users user_id batch query failed, skipping UUID lookups:', e.message);
            }
          }
          if (nums.length) {
            try{ const r = await supabase.from('master_users').select('id,full_name').in('id', nums); if(r && r.data) staff.push(...r.data); }catch(_e){}
          }
        }
        (staff||[]).forEach(s=>{ creators[s.id] = s.full_name; });
      }catch(e){ /* ignore */ }
    }
    const fmtDate = (d) => d ? new Date(d).toLocaleString() : "—";
    const truncate = (t,n=120) => t ? (t.length>n ? esc(t.slice(0,n))+'…' : esc(t)) : '';
  const rows = data.map(r => `\n    <tr data-id="${r.id}" style="cursor: pointer;" onclick="openComplaintDetails('${r.id}')">\n      <td style=\"width:36px\"><input type=\"checkbox\" class=\"cmp-select\" data-id=\"${r.id}\" onclick=\"event.stopPropagation()\"></td>\n      <td>${fmtDate(r.datetime)}</td>\n      <td>${esc((r.patient_initials && r.patient_initials !== 'NAN') ? r.patient_initials : '—')}</td>\n      <td>${esc(r.category || '—')}</td>\n      <td title=\"${esc(r.original_complaint || '')}\">${truncate(r.original_complaint, 80)}</td>\n      <td title=\"${esc(r.response || '')}\">${truncate(r.response, 80)}</td>\n      <td title=\"${esc(r.lessons_learned || '')}\">${truncate(r.lessons_learned, 80)}</td>\n      <td>${esc(r.status || '')}</td>\n      <td>${r.share_with_team ? 'Yes' : 'No'}</td>\n      <td>${esc(creators[r.created_by] || (r.created_by ? r.created_by : '—'))}</td>\n      <td>${fmtDate(r.resolved_at)}</td>\n      <td class=\"cmp-actions\" style=\"white-space:nowrap\" onclick=\"event.stopPropagation()\"><button class=\"pir-action-btn\" data-action=\"view\" data-id=\"${r.id}\">View</button> <button class=\"pir-action-btn\" data-action=\"attach\" data-id=\"${r.id}\">Attach</button></td>\n    </tr>\n  `).join("");
    tb.innerHTML = rows;
  })();
}

function populateComplaintsCategories(data) {
  const categorySelect = document.getElementById('complaints-filter-category');
  const statusSelect = document.getElementById('complaints-filter-status');
  
  if (categorySelect) {
    // Get unique categories from the data
    const categories = [...new Set((data || [])
      .map(r => r.category)
      .filter(Boolean)
      .filter(c => c && c.trim() && c !== 'UNCATEGORIZED')
    )].sort();
    
    // Clear existing options except "All Categories"
    const currentValue = categorySelect.value;
    categorySelect.innerHTML = '<option value="">All Categories</option>';
    
    // Add category options
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      categorySelect.appendChild(option);
    });
    
    // Restore previous selection if it still exists
    if (currentValue && categories.includes(currentValue)) {
      categorySelect.value = currentValue;
    }
  }
  
  if (statusSelect) {
    // Get unique statuses from the data
    const statuses = [...new Set((data || [])
      .map(r => r.status)
      .filter(Boolean)
    )].sort();
    
    // Clear existing options except "All Statuses"
    const currentValue = statusSelect.value;
    statusSelect.innerHTML = '<option value="">All Statuses</option>';
    
    // Add status options
    statuses.forEach(status => {
      const option = document.createElement('option');
      option.value = status;
      option.textContent = status;
      statusSelect.appendChild(option);
    });
    
    // Restore previous selection if it still exists
    if (currentValue && statuses.includes(currentValue)) {
      statusSelect.value = currentValue;
    }
  }
}

function openComplaintDetails(complaintId) {
  // Store complaint ID for editing
  window.currentComplaintId = complaintId;
  
  // Find the complaint modal or create a simple one
  let modal = document.getElementById('complaint-detail-modal');
  if (!modal) {
    // Create a simple modal for viewing/editing complaint details
    modal = document.createElement('div');
    modal.id = 'complaint-detail-modal';
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
          <h3>Complaint Details</h3>
          <button class="modal-close" onclick="closeComplaintDetails()">&times;</button>
        </div>
        <div class="modal-body" id="complaint-detail-content">
          <p>Loading complaint details...</p>
        </div>
        <div class="modal-footer">
          <button class="btn secondary" onclick="closeComplaintDetails()">Close</button>
          <button class="btn" onclick="editComplaint()">Edit</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  // Load complaint details
  loadComplaintDetails(complaintId);
  modal.classList.add('show');
}

function closeComplaintDetails() {
  const modal = document.getElementById('complaint-detail-modal');
  if (modal) modal.classList.remove('show');
}

async function loadComplaintDetails(complaintId) {
  const content = document.getElementById('complaint-detail-content');
  try {
    const { data, error } = await supabase
      .from('complaints')
      .select('*')
      .eq('id', complaintId)
      .single();
    
    if (error) throw error;
    
    const fmtDate = (d) => d ? new Date(d).toLocaleString() : "Not set";
    
    content.innerHTML = `
      <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <label><strong>Date/Time:</strong></label>
          <p>${fmtDate(data.datetime)}</p>
        </div>
        <div>
          <label><strong>Patient Initials:</strong></label>
          <p>${data.patient_initials || 'Not specified'}</p>
        </div>
        <div>
          <label><strong>Category:</strong></label>
          <p>${data.category || 'Uncategorized'}</p>
        </div>
        <div>
          <label><strong>Status:</strong></label>
          <p>${data.status || 'Open'}</p>
        </div>
        <div style="grid-column: span 2;">
          <label><strong>Original Complaint:</strong></label>
          <p style="white-space: pre-wrap; background: #f8f9fa; padding: 12px; border-radius: 6px;">${data.original_complaint || 'No details provided'}</p>
        </div>
        <div style="grid-column: span 2;">
          <label><strong>Response:</strong></label>
          <p style="white-space: pre-wrap; background: #f8f9fa; padding: 12px; border-radius: 6px;">${data.response || 'No response yet'}</p>
        </div>
        <div style="grid-column: span 2;">
          <label><strong>Lessons Learned:</strong></label>
          <p style="white-space: pre-wrap; background: #f8f9fa; padding: 12px; border-radius: 6px;">${data.lessons_learned || 'Not documented yet'}</p>
        </div>
        <div>
          <label><strong>Share with Team:</strong></label>
          <p>${data.share_with_team ? 'Yes' : 'No'}</p>
        </div>
        <div>
          <label><strong>Resolved:</strong></label>
          <p>${fmtDate(data.resolved_at)}</p>
        </div>
      </div>
    `;
  } catch (error) {
    content.innerHTML = `<p style="color: red;">Error loading complaint: ${error.message}</p>`;
  }
}

async function editComplaint() {
  console.log('editComplaint called with ID:', window.currentComplaintId);
  
  if (!window.currentComplaintId) {
    alert('No complaint selected for editing');
    return;
  }
  
  try {
    // Fetch the full complaint data
    console.log('Fetching complaint data...');
    const { data: complaint, error } = await supabase
      .from('complaints')
      .select('*')
      .eq('id', window.currentComplaintId)
      .single();
    
    if (error) {
      console.error('Supabase error:', error);
      throw error;
    }
    
    console.log('Complaint data fetched:', complaint);
    
    // Close the complaint details modal
    closeComplaintDetails();
    
    // Open the CRUD modal in edit mode with the full complaint object
    console.log('Opening CRUD modal...');
    openCRUD("complaints", "edit", complaint);
    console.log('CRUD modal should be open now');
  } catch (error) {
    console.error('Error in editComplaint:', error);
    alert('Failed to load complaint for editing: ' + error.message);
  }
}

// Make functions globally accessible for onclick handlers
window.openComplaintDetails = openComplaintDetails;
window.closeComplaintDetails = closeComplaintDetails;
window.editComplaint = editComplaint;

// Load complaints dashboard data
async function loadComplaintsDashboard() {
  try {
    const { data: complaints, error } = await supabase
      .from('complaints')
      .select('*')
      .eq('site_id', ctx.site_id)
      .order('datetime', { ascending: false });

    if (error) {
      console.error('Error loading complaints dashboard:', error);
      return;
    }

    // Calculate metrics
    const totalComplaints = complaints.length;
    const pendingComplaints = complaints.filter(c => c.status === 'Pending' || !c.status).length;
    const resolvedComplaints = complaints.filter(c => c.status === 'Resolved').length;
    
    // Calculate average response time (for resolved complaints)
    const resolvedWithTimes = complaints.filter(c => c.status === 'Resolved' && c.datetime && c.resolved_at);
    let avgResponseTime = 0;
    if (resolvedWithTimes.length > 0) {
      const totalTime = resolvedWithTimes.reduce((sum, c) => {
        const created = new Date(c.datetime);
        const resolved = new Date(c.resolved_at);
        return sum + (resolved - created);
      }, 0);
      avgResponseTime = Math.round(totalTime / resolvedWithTimes.length / (1000 * 60 * 60 * 24)); // days
    }

    // Update dashboard stats
    document.getElementById('dashboard-total-complaints').textContent = totalComplaints;
    document.getElementById('dashboard-pending-complaints').textContent = pendingComplaints;
    document.getElementById('dashboard-resolved-complaints').textContent = resolvedComplaints;
    document.getElementById('dashboard-avg-response').textContent = avgResponseTime > 0 ? `${avgResponseTime} days` : 'N/A';

    // Populate recent complaints table
    const recentComplaints = complaints.slice(0, 5); // Show latest 5
    const tbody = document.getElementById('dashboard-recent-complaints');
    if (tbody) {
      const fmtDate = (d) => d ? new Date(d).toLocaleDateString() : "—";
      tbody.innerHTML = recentComplaints.map(c => `
        <tr onclick="openComplaintDetails('${c.id}')" style="cursor: pointer;">
          <td>${fmtDate(c.datetime)}</td>
          <td>${esc(c.patient_initials || '—')}</td>
          <td>${esc(c.category || '—')}</td>
          <td><span class="status-badge status-${(c.status || 'pending').toLowerCase()}">${esc(c.status || 'Pending')}</span></td>
        </tr>
      `).join('');
    }
  } catch (error) {
    console.error('Error in loadComplaintsDashboard:', error);
  }
}

async function loadCheckTypes(){
  const tb = document.getElementById("ct-tbody");
  const { data, error } = await supabase.from("check_types").select("id, name, active").eq("site_id", ctx.site_id).order("name");
  if(error){ tb.innerHTML = `<tr><td colspan="2" class="muted">${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = `<tr><td colspan="2" class="muted">No check types yet.</td></tr>`; return; }
  tb.innerHTML = data.map(r => `<tr data-id="${r.id}"><td>${esc(r.name)}</td><td>${r.active ? "Yes" : "No"}</td></tr>`).join("");
}
let schedulesData = []; // Store original data for filtering

async function loadSchedules(){
  const tb = document.getElementById("sched-tbody");
  const { data: scheds, error } = await supabase
    .from("item_allowed_types")
    .select("id,item_id,check_type_id,frequency,required,scheduled_day")
    .eq("site_id", ctx.site_id)
    .order("id", { ascending: true });
  if(error){ tb.innerHTML = `<tr><td colspan="6" class="muted">${error.message}</td></tr>`; return; }
  if(!scheds?.length){ 
    tb.innerHTML = `<tr><td colspan="6" class="muted">No schedules yet.</td></tr>`; 
    schedulesData = [];
    return; 
  }

  const itemIds = [...new Set(scheds.map(s=>s.item_id).filter(Boolean))];
  const ctIds   = [...new Set(scheds.map(s=>s.check_type_id).filter(Boolean))];

  const [itemsRes, ctsRes] = await Promise.all([
  itemIds.length ? (itemIds.length === 1 ? supabase.from("items").select("id,item_name,room_id").eq("id", itemIds[0]) : supabase.from("items").select("id,item_name,room_id").in("id", itemIds)) : Promise.resolve({ data: [] }),
  ctIds.length   ? (ctIds.length === 1 ? supabase.from("check_types").select("id,name").eq("id", ctIds[0]) : supabase.from("check_types").select("id,name").in("id", ctIds))   : Promise.resolve({ data: [] }),
  ]);

  const itemsById = {};
  const itemRoomIdByItemId = {};
  (itemsRes.data||[]).forEach(r=> { itemsById[r.id] = r.item_name; itemRoomIdByItemId[r.id] = r.room_id; });

  // Fetch room names for referenced room_ids
  const roomIds = [...new Set(Object.values(itemRoomIdByItemId).filter(Boolean))];
  let roomsById = {};
  if (roomIds.length){
  const roomsRes = roomIds.length === 1 ? await supabase.from("rooms").select("id,name").eq("id", roomIds[0]) : await supabase.from("rooms").select("id,name").in("id", roomIds);
  const rooms = (roomsRes && roomsRes.data) || [];
  (rooms||[]).forEach(r=> { roomsById[r.id] = r.name; });
  }

  const ctsById   = {}; (ctsRes.data||[]).forEach(r=> ctsById[r.id]   = r.name);

  // Store enhanced data for filtering
  schedulesData = scheds.map(s => ({
    ...s,
    itemName: itemsById[s.item_id] || '—',
    roomName: roomsById[itemRoomIdByItemId[s.item_id]] || '—',
    checkTypeName: ctsById[s.check_type_id] || '—',
    frequencyText: intervalToText(s.frequency),
    roomId: itemRoomIdByItemId[s.item_id]
  }));

  // Populate filter dropdowns
  populateSchedulesFilters();
  
  // Display filtered results
  applySchedulesFilters();
}

function populateSchedulesFilters() {
  // Get unique values from data
  const rooms = [...new Set(schedulesData.map(s => ({ id: s.roomId, name: s.roomName })).filter(r => r.name && r.name !== '—'))];
  const checks = [...new Set(schedulesData.map(s => ({ id: s.check_type_id, name: s.checkTypeName })).filter(c => c.name && c.name !== '—'))];
  const frequencies = [...new Set(schedulesData.map(s => s.frequencyText).filter(f => f && f !== '—'))];

  // Populate room filter
  const roomFilter = document.getElementById('schedules-filter-room');
  if (roomFilter) {
    roomFilter.innerHTML = '<option value="">All Rooms</option>' + 
      rooms.map(r => `<option value="${r.id}">${esc(r.name)}</option>`).join('');
  }

  // Populate check type filter
  const checkFilter = document.getElementById('schedules-filter-check');
  if (checkFilter) {
    checkFilter.innerHTML = '<option value="">All Check Types</option>' + 
      checks.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');
  }

  // Populate frequency filter
  const frequencyFilter = document.getElementById('schedules-filter-frequency');
  if (frequencyFilter) {
    frequencyFilter.innerHTML = '<option value="">All Frequencies</option>' + 
      frequencies.map(f => `<option value="${esc(f)}">${esc(f)}</option>`).join('');
  }
}

function applySchedulesFilters() {
  const roomFilter = document.getElementById('schedules-filter-room')?.value || '';
  const checkFilter = document.getElementById('schedules-filter-check')?.value || '';
  const frequencyFilter = document.getElementById('schedules-filter-frequency')?.value || '';
  const requiredFilter = document.getElementById('schedules-filter-required')?.value || '';
  const searchTerm = document.getElementById('schedules-search')?.value.toLowerCase() || '';

  let filtered = schedulesData.filter(s => {
    // Room filter
    if (roomFilter && s.roomId != roomFilter) return false;
    
    // Check type filter
    if (checkFilter && s.check_type_id != checkFilter) return false;
    
    // Frequency filter
    if (frequencyFilter && s.frequencyText !== frequencyFilter) return false;
    
    // Required filter
    if (requiredFilter !== '') {
      const isRequired = requiredFilter === 'true';
      if (s.required !== isRequired) return false;
    }
    
    // Search term
    if (searchTerm) {
      const searchableText = [
        s.itemName,
        s.roomName,
        s.checkTypeName,
        s.frequencyText,
        s.scheduled_day || ''
      ].join(' ').toLowerCase();
      
      if (!searchableText.includes(searchTerm)) return false;
    }
    
    return true;
  });

  // Render filtered results
  const tb = document.getElementById("sched-tbody");
  if (!filtered.length) {
    tb.innerHTML = `<tr><td colspan="6" class="muted">No schedules match the current filters.</td></tr>`;
    return;
  }

  tb.innerHTML = filtered.map(s=>`
    <tr data-id="${s.id}">
      <td>${esc(s.itemName)}</td>
      <td>${esc(s.roomName)}</td>
      <td>${esc(s.checkTypeName)}</td>
      <td>${esc(s.frequencyText)}</td>
      <td>${esc(s.scheduled_day || "—")}</td>
      <td>${s.required ? 'Yes' : 'No'}</td>
    </tr>`).join("");
}

  async function loadStaff(){
    const tb = document.getElementById("staff-tbody");
    
    try {
      // Get staff from master_users table
      const { data: staffData, error: staffError } = await supabase
        .from('master_users')
        .select(`
          auth_user_id,
          full_name, 
          role_detail,
          team_name,
          created_at
        `)
        .eq("site_id", ctx.site_id)
        .order("full_name");

      if(staffError){ 
        tb.innerHTML = `<tr><td colspan="6" class="muted">${staffError.message}</td></tr>`; 
        return; 
      }
      
      if(!staffData?.length){ 
        tb.innerHTML = `<tr><td colspan="6" class="muted">No staff members found.</td></tr>`; 
        return; 
      }

      // Get working patterns for all staff
      const userIds = staffData.map(s => s.user_id);
      let patternsData = [];
      
      if (userIds.length > 0) {
        try {
          const { data: patterns, error: patternsError } = await supabase
            .from('master_users')
            .select("*")
            .in("user_id", userIds);
          
          if (patternsError) {
            console.error('Error loading working patterns:', patternsError);
          } else {
            patternsData = patterns || [];
          }
        } catch (err) {
          console.error('Error fetching working patterns:', err);
        }

      }

      // Create map of user_id -> data
      const patternsMap = {};
      
      console.log('Working patterns data:', patternsData);
      
      if (patternsData) {
        patternsData.forEach(pattern => {
          patternsMap[pattern.user_id] = pattern;
        });
      }


      tb.innerHTML = staffData.map(staff => {
        const pattern = patternsMap[staff.user_id];
        const isGP = staff.role_detail && staff.role_detail.toLowerCase().includes('gp');
        
        console.log(`Staff ${staff.full_name}:`, {
          user_id: staff.user_id,
          pattern: pattern,
          isGP: isGP,
          role_detail: staff.role_detail
        });
        
        let workingPatternSummary = 'Staff will set during welcome';
        let scheduleClass = 'chip info';
        
        return `<tr data-id="${staff.user_id}">
          <td><strong>${esc(staff.full_name)}</strong></td>
          <td>${esc(staff.role_detail || '—')}</td>
          <td>${esc(staff.team_name || '—')}</td>
          <td>
            <span class="${scheduleClass}">
              ${workingPatternSummary}
            </span>
          </td>
        </tr>`;
      }).join("");
      
    } catch (error) {
      console.error('Error loading staff:', error);
      tb.innerHTML = `<tr><td colspan="4" class="muted">Error loading staff: ${error.message}</td></tr>`;
    }
  }

  async function loadSubmissions(){
    const tb = document.getElementById("subs-tbody");
    const { data, error } = await supabase.from("submissions")
      .select("id, submitted_at, staff_name, comment").eq("site_id", ctx.site_id).order("submitted_at", { ascending:false }).limit(25);
    if(error){ tb.innerHTML = `<tr><td colspan="4" class="muted">${error.message}</td></tr>`; return; }
    if(!data?.length){ tb.innerHTML = `<tr><td colspan="4" class="muted">No submissions yet.</td></tr>`; return; }
    // counts:
    const ids = data.map(d=>d.id);
    let counts = {};
    if(ids.length){
      const rowsRes = ids.length === 1 ? await supabase.from("submission_rows").select("submission_id").eq("submission_id", ids[0]) : await supabase.from("submission_rows").select("submission_id").in("submission_id", ids);
      const rows = (rowsRes && rowsRes.data) || [];
      rows.forEach(r => { counts[r.submission_id] = (counts[r.submission_id]||0)+1; });
    }
    tb.innerHTML = data.map(r=>`<tr data-id="${r.id}">
      <td>${fmtDate(r.submitted_at)}</td><td>${esc(r.staff_name||"—")}</td>
      <td>${counts[r.id] ?? 0}</td><td>${esc(r.comment||"")}</td>
    </tr>`).join("");
  }
  function startOfWeek(d){
    const x = new Date(d);
    const day = x.getDay(); // 0=Sun
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day);
    return x;
  }
  // Day helpers (support 3-letter codes saved to DB)
  const DAY_CODES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const DAY_FULL  = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  function dayToIndex(s){
    if(!s) return -1;
    const key = String(s).slice(0,3);
    return DAY_CODES.indexOf(key);
  }
  function indexToCode(i){ return DAY_CODES[i] || ''; }
  function indexToFull(i){ return DAY_FULL[i] || ''; }

  async function loadWeekCalendar(){
    if(!ctx.site_id) return;
    const now = new Date();
    const wkStart = startOfWeek(now);
    const wkEnd = new Date(wkStart); wkEnd.setDate(wkStart.getDate() + 7);

    const fmt = (d)=> d.toLocaleDateString(undefined,{ weekday:'short', day: 'numeric', month: 'short' });
    for(let i=0;i<7;i++){
      const dd = new Date(wkStart); dd.setDate(wkStart.getDate() + i);
      const el = document.getElementById(`d${i}-label`);
      if(el) el.textContent = fmt(dd);
    }
    
    // Fetch all required schedules and filter them by day
    const { data: scheds } = await supabase.from("item_allowed_types").select("id,required,scheduled_day").eq("site_id", ctx.site_id).eq("required", true);

    const requiredCountsPerDay = Array(7).fill(0);
    (scheds || []).forEach(s => {
      if(s.scheduled_day) {
        const dayIndex = dayToIndex(s.scheduled_day);
        if(dayIndex !== -1) {
          requiredCountsPerDay[dayIndex]++;
        }
      }
    });

    // Submissions in the week
    const { data: subs, error } = await supabase
      .from("submissions")
      .select("id, submitted_at")
      .eq("site_id", ctx.site_id)
      .gte("submitted_at", wkStart.toISOString())
      .lt("submitted_at", wkEnd.toISOString());

    if(error){ /* handle error silently for now */ return; }

    const ids = (subs||[]).map(s=>s.id);
    let rows = [];
    if(ids.length){
      const srRes = ids.length === 1 ? await supabase.from("submission_rows").select("submission_id").eq("submission_id", ids[0]) : await supabase.from("submission_rows").select("submission_id").in("submission_id", ids);
      rows = (srRes && srRes.data) || [];
    }

    const countsBySubmission = {};
    rows.forEach(r => { countsBySubmission[r.submission_id] = (countsBySubmission[r.submission_id]||0)+1; });

    const donePerDay = Array(7).fill(0);
    (subs||[]).forEach(s=>{
      const when = new Date(s.submitted_at);
      const idx = Math.floor((when - wkStart)/86400000);
      if(idx>=0 && idx<7){
        donePerDay[idx] += (countsBySubmission[s.id] || 0);
      }
    });

    for(let i=0;i<7;i++){
      const dayDate = new Date(wkStart); dayDate.setDate(wkStart.getDate() + i);
      const isPast = dayDate < new Date(new Date().setHours(0,0,0,0));
      
      const requiredCountForDay = requiredCountsPerDay[i];
      const done = donePerDay[i] || 0;
      const missed = isPast ? Math.max(requiredCountForDay - done, 0) : 0;
      
      const totalScheduled = isPast ? requiredCountForDay : requiredCountForDay; // Required is always the same for a day, past or future.
      
      // Get elements
      const doneValEl = document.getElementById(`d${i}-done-val`);
      const reqValEl = document.getElementById(`d${i}-req-val`);
      const barEl = document.getElementById(`d${i}-bar`);
      const doneTextEl = document.getElementById(`d${i}-done`);
      const missedTextEl = document.getElementById(`d${i}-missed`);
      const reqTextEl = document.getElementById(`d${i}-req`);

      if(doneValEl) doneValEl.textContent = done;
      if(reqValEl) reqValEl.textContent = totalScheduled;
      if(doneTextEl) doneTextEl.textContent = done;
      if(missedTextEl) missedTextEl.textContent = missed;
      if(reqTextEl) reqTextEl.textContent = totalScheduled;

      if(barEl) {
        let percentage = 0;
        if (totalScheduled > 0) {
          percentage = (done / totalScheduled) * 100;
        }
        barEl.style.width = `${Math.min(percentage, 100)}%`;
        barEl.classList.toggle('danger', isPast && missed > 0);
      }
    }
  }

  // --- MONTHLY CALENDAR ---
  async function cacheRequiredSchedules() {
    if (!ctx.site_id) return;
    console.log("DEBUG: cacheRequiredSchedules() called for site_id:", ctx.site_id);
    const { data, error } = await supabase
      .from("item_allowed_types")
      .select(`
        id,
        scheduled_day,
        frequency,
        items (id, item_name),
        check_types (id, name)
      `)
      .eq("site_id", ctx.site_id)
      .eq("required", true)
  // NOTE: do NOT filter out null scheduled_day here — some schedules are interval-based
  // (e.g. daily / every N days / monthly by interval) and rely on frequency alone.
  ;
    if (error) { console.error("Failed to cache schedules:", error); return; }
    requiredSchedulesCache = data || [];
    console.log("DEBUG: Cached", requiredSchedulesCache.length, "required schedules:", requiredSchedulesCache);
  }

  async function loadAndRenderCalendar() {
    if (!ctx.site_id) return;
    
    // Ensure schedules are cached before rendering
    await cacheRequiredSchedules();
    console.log("DEBUG: loadAndRenderCalendar() - requiredSchedulesCache has", requiredSchedulesCache.length, "items");
    
    // Hide all views initially
    document.getElementById('cal-grid').style.display = 'none';
    document.getElementById('cal-weekdays').style.display = 'none';
    document.getElementById('cal-compliance-view').style.display = 'none';

    // Route to the correct rendering function based on the active tab
    switch (currentCalendarView) {
        case 'daily':
            renderComplianceView('daily');
            break;
        case 'weekly':
            renderComplianceView('weekly');
            break;
        case 'monthly':
            renderComplianceView('monthly');
            break;
        case 'scheduled':
        default:
            // This is the original logic for the grid view
            document.getElementById('cal-weekdays').style.display = 'grid';
            document.getElementById('cal-grid').style.display = 'grid';
            const calGrid = document.getElementById("cal-grid");
            calGrid.innerHTML = `<div style="grid-column: span 7; text-align:center; padding: 40px;" class="muted">Loading calendar...</div>`;

            calendarDate.setDate(1); // Go to the 1st of the month
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            document.getElementById('cal-month-year').textContent = calendarDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
            
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);
            monthEnd.setHours(23,59,59,999);

            const { data: completed, error: compErr } = await supabase
              .from('submission_rows')
              .select(`item_pk, check_type_id, submissions!inner ( submitted_at )`)
              .gte('submissions.submitted_at', monthStart.toISOString())
              .lte('submissions.submitted_at', monthEnd.toISOString())
              .eq('site_id', ctx.site_id);

            if(compErr) { calGrid.innerHTML = `<div class="muted">${compErr.message}</div>`; return; }

            const dailyData = new Map();
            (completed || []).forEach(c => {
                const dayKey = new Date(c.submissions.submitted_at).toISOString().slice(0, 10);
                if (!dailyData.has(dayKey)) {
                    dailyData.set(dayKey, new Set());
                }
                dailyData.get(dayKey).add(`${c.item_pk}-${c.check_type_id}`);
            });
            renderCalendar(dailyData);
            break;
    }
  }

  async function renderComplianceView(period) {
    document.getElementById('cal-weekdays').style.display = 'none';
    document.getElementById('cal-grid').style.display = 'none';
    const complianceContainer = document.getElementById('cal-compliance-view');
    complianceContainer.style.display = 'block';
    complianceContainer.innerHTML = `<div class="muted" style="text-align:center; padding: 40px;">Loading ${period} compliance...</div>`;

    const now = new Date();
    now.setHours(23, 59, 59, 999); // End of today

    let startDate = new Date(calendarDate);
    let endDate = new Date(calendarDate);

    // Define date range based on the selected period
    if (period === 'daily') {
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
    } else if (period === 'weekly') {
        const dayOfWeek = startDate.getDay(); // Sunday - 0, Monday - 1
        startDate.setDate(startDate.getDate() - dayOfWeek);
        startDate.setHours(0, 0, 0, 0);
        endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);
        endDate.setHours(23, 59, 59, 999);
    } else { // monthly
        startDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 1);
        endDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 0);
        endDate.setHours(23, 59, 59, 999);
    }
    
    // Update header to show the current period
    const titleFormat = { month: 'long', year: 'numeric' };
    if (period === 'daily') titleFormat.day = 'numeric';
    document.getElementById('cal-month-year').textContent = startDate.toLocaleDateString(undefined, titleFormat);


    const { data, error } = await supabase
      .from('v_item_check_status')
      .select('item_name, room_name, check_type, next_due_at, last_done_at')
      .eq('site_id', ctx.site_id)
      .eq('required', true)
      .gte('next_due_at', startDate.toISOString())
      .lte('next_due_at', endDate.toISOString())
      .order('next_due_at', { ascending: true });

    if (error) {
        complianceContainer.innerHTML = `<div class="error">${error.message}</div>`;
        return;
    }

    if (!data || data.length === 0) {
        complianceContainer.innerHTML = `<div class="muted" style="text-align:center; padding: 40px;">No checks were due in this period.</div>`;
        return;
    }

    let html = `<div class="table-wrap" style="max-height: 65vh;"><table>
        <thead><tr><th>Due Date</th><th>Item</th><th>Check</th><th>Room</th><th>Status</th></tr></thead>
        <tbody>`;

    data.forEach(item => {
        const dueDate = new Date(item.next_due_at);
        const lastDone = item.last_done_at ? new Date(item.last_done_at) : null;
        
        let statusChip = '<span class="chip">Pending</span>';
        if (dueDate < now) {
            statusChip = '<span class="chip danger">Missed</span>';
        }

        html += `<tr>
            <td>${dueDate.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric', month: 'short' })}</td>
            <td>${esc(item.item_name)}</td>
            <td>${esc(item.check_type)}</td>
            <td>${esc(item.room_name || '—')}</td>
            <td>${statusChip}</td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
    complianceContainer.innerHTML = html;
  }
  
  function renderCalendar(dailyData) {
    const grid = document.getElementById('cal-grid');
    const today = new Date();
    const todayKey = today.toISOString().slice(0, 10);
    today.setHours(0,0,0,0);
    
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); // 0=Sun, 1=Mon...

    let html = '';

    // Convert Sunday-based to Monday-based for weekdays-only view
    // Monday = 1, Tuesday = 2, ..., Friday = 5
    const mondayBasedStart = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1; // Sunday becomes 6, others shift left

    // Pad start of month (only for weekdays)
    if (mondayBasedStart <= 4) { // Only pad if first day is a weekday (Mon-Fri)
      for (let i = 0; i < mondayBasedStart; i++) {
          html += `<div class="cal-cell other-month"></div>`;
      }
    }

    // Fill days of month (only weekdays)
    for (let day = 1; day <= daysInMonth; day++) {
        const thisDate = new Date(year, month, day);
        const dayOfWeek = thisDate.getDay(); // 0=Sun, 1=Mon...6=Sat
        
        // Skip weekends (0=Sunday, 6=Saturday)
        if (dayOfWeek === 0 || dayOfWeek === 6) continue;
        
        const dayKey = thisDate.toISOString().slice(0, 10);
        const isToday = (dayKey === todayKey);
        const isPast = thisDate < today;
        const currentDayCode = indexToCode(thisDate.getDay());

        const completedTasks = dailyData.get(dayKey) || new Set();
        
        let dayTasksHtml = '';
        const tasksForThisDay = requiredSchedulesCache.filter(task => {
          // Require scheduled_day to match the current weekday code; if absent, this task
          // doesn't render on the grid (these are interval-based schedules handled elsewhere).
          if (!task.scheduled_day) return false;
          if (task.scheduled_day !== currentDayCode) return false;
          const freq = String(task.frequency || '').toLowerCase();

          // Monthly: show only on the last <weekday> of the month
          if (freq.includes('mon')) {
            const nextWeek = new Date(thisDate);
            nextWeek.setDate(thisDate.getDate() + 7);
            return nextWeek.getMonth() !== thisDate.getMonth();
          }

          // Daily or Weekly: show every week on the selected day
          if (freq.includes('day') || freq.includes('week')) {
            return true;
          }

          // Otherwise: do not show on the grid
          return false;
        });
        
        console.log(`DEBUG: Day ${day} (${currentDayCode}) - found ${tasksForThisDay.length} tasks from ${requiredSchedulesCache.length} total schedules`);

        tasksForThisDay.forEach(task => {
          const taskKey = `${task.items.id}-${task.check_types.id}`;
          const isDone = completedTasks.has(taskKey);
          let statusClass = 'scheduled';
          if (isDone) {
            statusClass = 'done';
          } else if (isPast) {
            statusClass = 'missed';
          }

          // Status character shown inside the coloured dot
          let statusChar = 'S';
          if (isDone) statusChar = '✓';
          else if (isPast) statusChar = '✗';

          const taskName = `${task.items.item_name} / ${task.check_types.name}`;
          const freq = String(task.frequency || '').toLowerCase();
          let freqBadge = '';
          if (freq.includes('day')) {
            freqBadge = `<span class="freq-badge" title="Daily">D</span>`;
          } else if (freq.includes('week')) {
            freqBadge = `<span class="freq-badge" title="Weekly">W</span>`;
          } else if (freq.includes('mon') || freq.includes('month')) {
            freqBadge = `<span class="freq-badge" title="Monthly">M</span>`;
          }

          dayTasksHtml += `<div class="cal-task"
              data-item-id="${task.items.id}"
              data-ct-id="${task.check_types.id}"
              data-date="${dayKey}"
              title="${esc(taskName)}">
              <div class="cal-task-status ${statusClass}">${statusChar}</div>
              <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-left:6px;">${esc(taskName)}</span>
              ${freqBadge}
            </div>`;
        });

        if (tasksForThisDay.length === 0) {
          dayTasksHtml += `<div class="cal-no-tasks" style="font-size:10px; text-align:center; padding:8px 4px; background:linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border:1px solid rgba(34, 197, 94, 0.2); border-radius:6px; color:rgba(34, 197, 94, 0.8); font-weight:500;">✅ All clear!</div>`;
        }
        
        html += `<div class="cal-cell is-clickable" data-date="${dayKey}">
            <div class="cal-day-num ${isToday ? 'is-today' : ''}">${day}</div>
            <div class="cal-tasks">${dayTasksHtml}</div>
            </div>`;
    }

    grid.innerHTML = html;
  }

  // Day modal: show details when user clicks a calendar cell
  async function showDayModal(dateKey) {
    const modal = document.getElementById('day-modal');
    if(!modal) return;
    const titleEl = modal.querySelector('.day-modal-title');
    const bodyEl = modal.querySelector('.day-modal-body');
    titleEl.textContent = `Details for ${new Date(dateKey).toLocaleDateString(undefined, { weekday: 'long', day:'numeric', month:'long', year:'numeric' })}`;
    bodyEl.innerHTML = `<div class="muted">Loading…</div>`;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');

    const thisDate = new Date(dateKey);
    const start = new Date(thisDate); start.setHours(0,0,0,0);
    const end = new Date(thisDate); end.setHours(23,59,59,999);

    // Fetch any submission rows on that exact date, including item and check names when available
    const { data: rows, error: rowsErr } = await supabase
      .from('submission_rows')
      .select('item_pk, check_type_id, items(id,item_name), check_types(id,name), submissions!inner(submitted_at, staff_name, auth_user_id)')
      .gte('submissions.submitted_at', start.toISOString())
      .lte('submissions.submitted_at', end.toISOString())
      .eq('site_id', ctx.site_id);

    const completedMap = {}; // key -> { staff, time, item_name, check_name }
    if(!rowsErr && rows && rows.length){
      rows.forEach(r => {
        const k = `${r.item_pk}-${r.check_type_id}`;
        completedMap[k] = {
          staff: r.submissions?.staff_name || '—',
          user_id: r.submissions?.user_id || null,
          time: r.submissions?.submitted_at || null,
          item_name: r.items?.item_name || null,
          check_name: r.check_types?.name || null
        };
      });
    }

    // Determine scheduled tasks for this date (reuse same rules as calendar render)
    const currentDayCode = indexToCode(thisDate.getDay());
    const currentDayOfMonth = thisDate.getDate();
    const tasksForThisDay = requiredSchedulesCache.filter(task => {
      if (!task.scheduled_day) return false;
      if (task.scheduled_day !== currentDayCode) return false;
      const freq = String(task.frequency || '').toLowerCase();
      if (freq.includes('mon')) {
        const nextWeek = new Date(thisDate);
        nextWeek.setDate(thisDate.getDate() + 7);
        return nextWeek.getMonth() !== thisDate.getMonth();
      }
      if (freq.includes('day') || freq.includes('week')) return true;
      return false;
    });

    // Combine scheduled + completed keys so we show any recorded checks even if not scheduled
    const keys = new Set();
    tasksForThisDay.forEach(t => keys.add(`${t.items.id}-${t.check_types.id}`));
    Object.keys(completedMap).forEach(k => keys.add(k));

    if (keys.size === 0) {
      bodyEl.innerHTML = `<div class="muted">No checks recorded or scheduled for this day.</div>`;
      return;
    }

    let tableHtml = `<div class="table-wrap"><table class="day-modal-table"><thead><tr><th>Check</th><th>Status</th><th>By</th><th>Time</th></tr></thead><tbody>`;
    for (const k of keys) {
      const [itemIdStr, ctIdStr] = k.split('-');
      const itemId = Number(itemIdStr);
      const ctId = Number(ctIdStr);
      const scheduled = tasksForThisDay.find(t => Number(t.items.id) === itemId && Number(t.check_types.id) === ctId);
      const completed = completedMap[k];

      const itemName = scheduled ? scheduled.items.item_name : (completed && completed.item_name) || '—';
      const checkName = scheduled ? scheduled.check_types.name : (completed && completed.check_name) || '—';

      let statusHtml = '<span class="chip">Scheduled</span>';
      let by = '—';
      let timeText = '—';

      if (completed) {
        statusHtml = '<span class="chip success">Done</span>';
        by = esc(completed.staff || '—');
        timeText = completed.time ? new Date(completed.time).toLocaleTimeString() : '—';
      } else if (isPast) {
        // If scheduled but in the past -> mark missed
        const todayStart = new Date(); todayStart.setHours(0,0,0,0);
        if (thisDate < todayStart) {
          statusHtml = '<span class="chip danger">Missed</span>';
        }
      }

      tableHtml += `<tr>
        <td>${esc(itemName)} / ${esc(checkName)}</td>
        <td>${statusHtml}</td>
        <td>${by}</td>
        <td>${timeText}</td>
      </tr>`;
    }
    tableHtml += `</tbody></table></div>`;
    bodyEl.innerHTML = tableHtml;
  }

  async function showTaskModal(dateKey, itemId, ctId){
    const modal   = document.getElementById('day-modal');
    if(!modal) return;
    const titleEl = modal.querySelector('.day-modal-title');
    const bodyEl  = modal.querySelector('.day-modal-body');
    titleEl.textContent = 'Details';
    bodyEl.innerHTML = '<div class="muted">Loading…</div>';
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');

    const thisDate = new Date(dateKey);
    const start = new Date(thisDate); start.setHours(0,0,0,0);
    const end   = new Date(thisDate); end.setHours(23,59,59,999);

    // Completed row (if any) on that date
    const { data: rows } = await supabase
      .from('submission_rows')
      .select('submissions!inner(staff_name,submitted_at,user_id), items(item_name), check_types(name)')
      .eq('site_id', ctx.site_id)
      .eq('item_pk', itemId)
      .eq('check_type_id', ctId)
      .gte('submissions.submitted_at', start.toISOString())
      .lte('submissions.submitted_at', end.toISOString());

    const done = rows?.[0] ?? null;
    const itemName  = done?.items?.item_name  ?? (await supabase.from('items').select('item_name').eq('id', itemId).maybeSingle()).data?.item_name ?? '—';
    const checkName = done?.check_types?.name ?? (await supabase.from('check_types').select('name').eq('id', ctId).maybeSingle()).data?.name ?? '—';

    const now = new Date();
    const isPast = thisDate < new Date(now.setHours(0,0,0,0));

    let statusChip = '<span class="chip">Scheduled</span>';
    let who = '—', whenTime = '—';
    if(done){
      statusChip = '<span class="chip success">Done</span>';
      who  = esc(done.submissions?.staff_name || '—');
      // Store user_id for future reference
      const userId = done.submissions?.user_id;
      whenTime = done.submissions?.submitted_at ? new Date(done.submissions.submitted_at).toLocaleTimeString() : '—';
    }else if(isPast){
      statusChip = '<span class="chip danger">Missed</span>';
    }

    bodyEl.innerHTML = `
      <table class="day-modal-table"><tbody>
        <tr><th>Item</th>  <td>${esc(itemName)}</td></tr>
        <tr><th>Check</th> <td>${esc(checkName)}</td></tr>
        <tr><th>Status</th><td>${statusChip}</td></tr>
        <tr><th>Who</th>   <td>${who}</td></tr>
        <tr><th>When</th>  <td>${whenTime}</td></tr>
      </tbody></table>`;
  }

  function hideDayModal(){
    const modal = document.getElementById('day-modal');
    if(!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    // Suppress any click that might "fall through" after closing
    suppressGridClickUntil = Date.now() + 300; // 300ms debounce
  }

  // Dedicated close‑button handler (defensive – runs only once)
  (() => {
    const btn = document.getElementById('day-modal-close');
    if(btn && !btn.dataset.bound){
      btn.dataset.bound = "1";
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        hideDayModal();
      }, { once:false });
    }
  })();

  // Click handler on calendar grid to show task modal or day modal
  document.getElementById('cal-grid').addEventListener('click', async (e) => {
    // Ignore ghost clicks right after closing a modal
    if (Date.now() < suppressGridClickUntil) {
      e.stopPropagation();
      e.preventDefault();
      return;
    }
    // 1️⃣ task clicked?
    const taskEl = e.target.closest('.cal-task');
    if(taskEl){
      e.stopPropagation();          // ← new, prevents underlying handlers
      const dateKey = taskEl.getAttribute('data-date');
      const itemId  = taskEl.getAttribute('data-item-id');
      const ctId    = taskEl.getAttribute('data-ct-id');
      if(dateKey && itemId && ctId){
        await showTaskModal(dateKey, itemId, ctId);
        return;
      }
    }
    // 2️⃣ fallback: whole‑day cell
    const cell = e.target.closest('.cal-cell.is-clickable');
    if(!cell) return;
    const dateKeyCell = cell.getAttribute('data-date');
    if(!dateKeyCell) return;
    await showDayModal(dateKeyCell);
  });

  // Close modal when clicking the X or outside the card
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('day-modal');
    if(!modal || !modal.classList.contains('show')) return;
    if (e.target.id === 'day-modal-close') {
      e.stopPropagation();
      e.preventDefault();
      hideDayModal();
      return;
    }
    if (e.target === modal) {
      e.stopPropagation();
      e.preventDefault();
      hideDayModal();
    }
  });

  // --- ROLES MANAGEMENT ---
  async function loadRoles() {
    const tbody = document.getElementById('roles-tbody');
    if (!tbody) return;
    // Roles are now fixed to Admin and Staff. Render static list.
    const fixed = [{role:'admin'},{role:'staff'}];
    tbody.innerHTML = fixed.map(r => 
      '<tr data-role="' + esc(r.role) + '">' +
        '<td>' + esc(r.role) + '</td>' +
        '<td>—</td>' +
      '</tr>'
    ).join('');
  }

  function initRolesManagement() {
    const btnManageRoles = document.getElementById('btn-manage-roles');
    const rolesModal = document.getElementById('roles-modal');
    const addRoleForm = document.getElementById('add-role-form');
    const closeBtn = rolesModal?.querySelector('.modal-close');

  // Role management UI removed; do not bind manage roles button.

    // Close on clicking outside
    if (rolesModal) {
      rolesModal.addEventListener('click', (e) => {
        if (e.target === rolesModal) {
          rolesModal.classList.remove('show');
        }
      });
    }

    // Close on clicking X button
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        rolesModal?.classList.remove('show');
      });
    }

    if (addRoleForm) {
      addRoleForm.addEventListener('submit', (e) => {
        e.preventDefault();
        // Disabled: roles are fixed to Admin and Staff. Use Manage Roles removed.
        alert('Role management is disabled. Roles are fixed to Admin and Staff.');
      });
    }
  }

  // Helpers
  function esc(s){ return (s ?? "").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function fmtDate(iso){
    if(!iso) return "—";
    const d = new Date(iso);
    return d.toLocaleString();
  }
  // small validator for UUID-like strings
  function isUUID(v){ if(!v) return false; try{ return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(String(v)); }catch(e){return false;} }
    function fmtDateShort(iso) {
      if (!iso) return "—";
      try {
        // Add a time component to avoid timezone-related date shifts for display
        return new Date(iso + 'T12:00:00Z').toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (e) {
        return "—";
      }
    }
  function intervalToText(i){
    if(!i) return "—";
    if (typeof i !== 'string') return JSON.stringify(i);
    const parts = [];
    if (i.includes('year')) parts.push(i.match(/(\d+)\s*year/)[1] + ' years');
    if (i.includes('mon')) parts.push(i.match(/(\d+)\s*mon/)[1] + ' months');
    if (i.includes('day')) parts.push(i.match(/(\d+)\s*day/)[1] + ' days');
    return parts.join(', ') || i;
  }
  
  // --- PRE-INSPECTION (PIR) LOGIC ---
    
    const PIR_DEFINITIONS = window.PIR_DEFINITIONS_DATA;

    async function seedInitialPIRDocs() {
        if (!ctx.site_id) return;
        const { count, error } = await supabase.from('pir_documents').select('*', { count: 'exact', head: true }).eq('site_id', ctx.site_id);
        if (error || count > 0) return;

        const docsToInsert = PIR_DEFINITIONS.map(def => {
            const isDataOnly = !def.item_type.includes('file');
            return {
                site_id: ctx.site_id,
                category: def.category,
                title: def.title,
                item_type: def.item_type,
                status: isDataOnly ? 'Not Started' : 'Not Attached',
                data: {}
            };
        });
        await supabase.from('pir_documents').insert(docsToInsert);
    }

    function formatItemType(itemType) {
        if (itemType.includes('file') && (itemType.includes('text') || itemType.includes('questions'))) return 'Text & File';
        if (itemType.includes('file')) return 'File Attachment';
        if (itemType.includes('text') || itemType.includes('questions')) return 'Text / Q&A';
        if (itemType.includes('table')) return 'Data Table';
        if (itemType.includes('number')) return 'Data';
        return 'Information';
    }

    // Enhanced PIR state management
    let pirState = {
        filter: 'all',
        sortBy: 'category',
        sortDir: 'asc',
        selectedItems: new Set(),
        draftTexts: new Map()
    };

    async function loadAndRenderPIR() {
        const container = document.getElementById('pir-docs-container');
  container.innerHTML = `<div class="muted" style="text-align: center; padding: 20px;">Loading document list...</div>`;
        if (!ctx.site_id) return;

        const { data, error } = await supabase.from('pir_documents').select('*').eq('site_id', ctx.site_id).order('id', { ascending: true });
        if (error) { container.innerHTML = `<div class="error">${error.message}</div>`; return; }
        pirDocsCache = data || [];

        // Initialize draft texts from localStorage
        pirState.draftTexts = new Map(JSON.parse(localStorage.getItem('pir_draft_texts') || '[]'));

        renderPIRTable();
        updatePIRProgress();
        updatePIRTOC();
        initPIRFilters();
        initPIREventHandlers();
    }

    function renderPIRTable() {
        const container = document.getElementById('pir-docs-container');
        const filteredDocs = getFilteredPIRDocs();
        const sortedDocs = getSortedPIRDocs(filteredDocs);
        const groupedByCat = groupPIRDocsByCategory(sortedDocs);
        
        let html = '';
        for (const [category, docs] of Object.entries(groupedByCat)) {
            // Calculate summary counts
            const totalItems = docs.length;
            const completedItems = docs.filter(doc => {
                const status = getPIRDocStatus(doc);
                return status === 'Complete' || status === 'Verified' || status === 'Ready to Submit';
            }).length;
            const readyItems = docs.filter(doc => {
                const status = getPIRDocStatus(doc);
                return status === 'Ready to Submit';
            }).length;

            html += `
                <div class="doc-category" id="category-${sanitizeId(category)}">
                    <div class="doc-category-title" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px;">
                        <span>${esc(category)}</span>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <span style="background: ${readyItems > 0 ? 'var(--stat-2-bg)' : 'var(--glass)'}; color: ${readyItems > 0 ? 'var(--stat-2-color)' : 'var(--muted)'}; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${readyItems} Ready
                            </span>
                            <span style="background: ${completedItems === totalItems ? 'var(--stat-2-bg)' : (completedItems > 0 ? 'var(--stat-3-bg)' : 'var(--stat-4-bg)')}; color: ${completedItems === totalItems ? 'var(--stat-2-color)' : (completedItems > 0 ? 'var(--stat-3-color)' : 'var(--stat-4-color)')}; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${completedItems}/${totalItems} Done
                            </span>
                        </div>
                    </div>
                    ${docs.map(doc => renderPIRDocRow(doc)).join('')}
                </div>
            `;
        }
        
        container.innerHTML = html || '<div class="muted" style="padding: 20px; text-align: center;">No documents match the current filter.</div>';
    }

    // Helper to safely read notes whether column exists or stored in JSON
    function getPirDocNotes(doc) {
        return (doc && (doc.notes ?? (doc.data && doc.data.notes))) || '';
    }

    function renderPIRDocRow(doc) {
        const status = getPIRDocStatus(doc);
        const statusClass = getPIRStatusClass(status);
        const hasDraft = pirState.draftTexts.has(doc.id);
        const _notes = getPirDocNotes(doc);
        const hasNotes = _notes && _notes.trim().length > 0;
        const isSelected = pirState.selectedItems.has(doc.id);
        
        return `
            <div class="pir-table-row ${isSelected ? 'selected' : ''}" data-id="${doc.id}">
                <div>
                    <input type="checkbox" class="pir-row-checkbox" data-id="${doc.id}" ${isSelected ? 'checked' : ''}>
                </div>
                <div>
                    <div class="pir-row-title">${esc(doc.title)}</div>
                    <div class="pir-row-type">${formatItemType(doc.item_type)}</div>
                    ${hasDraft ? '<div class="pir-draft-indicator"><span class="pir-draft-badge">draft</span> Text saved</div>' : ''}
                    ${hasNotes ? '<div class="pir-notes-indicator"><span class="pir-notes-badge">📝</span> Has notes</div>' : ''}
                </div>
                <div>
                    <span class="pir-status-chip ${statusClass}">${status}</span>
                </div>
                <div>
                    <span class="muted">${fmtDateShort(doc.last_updated)}</span>
                </div>
                <div class="pir-row-actions">
                    <button class="pir-action-btn" data-action="upload" data-id="${doc.id}">Upload</button>
                    ${doc.file_path ? `<button class="pir-action-btn" data-action="view" data-id="${doc.id}">View</button>` : ''}
                    <button class="pir-action-btn ${hasNotes ? 'has-notes' : ''}" data-action="notes" data-id="${doc.id}">Notes</button>
                </div>
            </div>
        `;
    }

    function getPIRDocStatus(doc) {
        const definition = getPIRDocDefinition(doc);
        const now = new Date();
        
        if (!doc.file_path && !doc.data?.text_content && !pirState.draftTexts.has(doc.id)) {
            return definition?.item_type?.includes('file') ? 'Not Attached' : 'Not Started';
        }
        
        if (doc.status === 'Ready') {
            // Check if outdated (policy older than X months)
            if (doc.last_updated) {
                const lastUpdate = new Date(doc.last_updated);
                const monthsOld = (now - lastUpdate) / (1000 * 60 * 60 * 24 * 30);
                if (monthsOld > 24) return 'Outdated'; // 24 months threshold
            }
            return 'Ready';
        }
        
        if (doc.file_path && doc.status !== 'Ready') {
            return 'Uploaded';
        }
        
        if (pirState.draftTexts.has(doc.id) && !doc.file_path) {
            return 'Draft';
        }
        
        return doc.status || 'Not Started';
    }

    function getPIRStatusClass(status) {
        const statusMap = {
            'Not Attached': 'not-attached',
            'Not Started': 'not-attached', 
            'Uploaded': 'uploaded',
            'Ready': 'ready',
            'Outdated': 'outdated',
            'Draft': 'draft',
            'Expired': 'expired',
            'Expiring Soon': 'expiring-soon'
        };
        return statusMap[status] || 'not-attached';
    }

    function getPIRDocDefinition(doc) {
        return window.PIR_DEFINITIONS_DATA?.find(d => d.title === doc.title);
    }

    function getFilteredPIRDocs() {
        return pirDocsCache.filter(doc => {
            const status = getPIRDocStatus(doc);
            const hasDraft = pirState.draftTexts.has(doc.id);
            
            switch (pirState.filter) {
                case 'not-attached': return status === 'Not Attached' || status === 'Not Started';
                case 'ready': return status === 'Ready';
                case 'expiring-soon': 
                    if (status === 'Ready' && doc.last_updated) {
                        const lastUpdate = new Date(doc.last_updated);
                        const monthsOld = (new Date() - lastUpdate) / (1000 * 60 * 60 * 24 * 30);
                        return monthsOld > 18 && monthsOld <= 24; // 18-24 months
                    }
                    return false;
                case 'outdated': return status === 'Outdated';
                case 'draft': return hasDraft;
                case 'all':
                default: return true;
            }
        });
    }

    function getSortedPIRDocs(docs) {
        return [...docs].sort((a, b) => {
            let aVal, bVal;
            
            switch (pirState.sortBy) {
                case 'status':
                    aVal = getPIRDocStatus(a);
                    bVal = getPIRDocStatus(b);
                    break;
                case 'last-updated':
                    aVal = a.last_updated || '1900-01-01';
                    bVal = b.last_updated || '1900-01-01';
                    break;
                case 'category':
                default:
                    aVal = a.category;
                    bVal = b.category;
                    break;
            }
            
            const comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            return pirState.sortDir === 'asc' ? comparison : -comparison;
        });
    }

    function groupPIRDocsByCategory(docs) {
        const grouped = docs.reduce((acc, doc) => {
            (acc[doc.category] = acc[doc.category] || []).push(doc);
            return acc;
        }, {});
        
        // Maintain category order from PIR_DEFINITIONS_DATA
        const categoryOrder = [...new Set(window.PIR_DEFINITIONS_DATA?.map(d => d.category) || [])];
        const orderedGrouped = {};
        
        for (const category of categoryOrder) {
            if (grouped[category]) {
                orderedGrouped[category] = grouped[category];
            }
        }
        
        return orderedGrouped;
    }

    function updatePIRProgress() {
        const total = pirDocsCache.length;
        const ready = pirDocsCache.filter(d => getPIRDocStatus(d) === 'Ready').length;
        const percentage = total > 0 ? Math.round((ready / total) * 100) : 0;
        
        // Update classic bar and text
        document.getElementById('pir-progress-bar').style.width = `${percentage}%`;
        document.getElementById('pir-progress-text').textContent = `${ready} / ${total} Ready (${percentage}%)`;

        // Scale percentage to a 0..66 metric (user requested scale)
        const scaled = Math.round((percentage / 100) * 66);
        const largeEl = document.getElementById('pir-progress-large');
        if (largeEl) largeEl.textContent = `${scaled} / 66`;
        
        // Add motivational color and pulse effect based on progress
        const progressBar = document.getElementById('pir-progress-bar');
        const container = document.querySelector('.progress-bar-container');
        if (progressBar && container) {
          // Update progress bar with red-to-green gradient
          progressBar.style.background = getProgressGradient(percentage);
          
          // Remove existing progress classes
          container.classList.remove('progress-low', 'progress-medium', 'progress-high', 'progress-complete');
          
          // Add appropriate progress class for styling (keeping for animations)
          if (percentage >= 100) {
            container.classList.add('progress-complete');
          } else if (percentage >= 75) {
            container.classList.add('progress-high');
          } else if (percentage >= 40) {
            container.classList.add('progress-medium');
          } else {
            container.classList.add('progress-low');
          }
          
          // Add interactive tooltip
          const tooltip = getMotivationalMessage(percentage, ready, total);
          container.setAttribute('title', tooltip);
        }

        // Compute per-email-package readiness based on PIR_DEFINITIONS_DATA categories
        // Categories are expected like 'EMAIL 1: ...' — group by email number 1..9
        const emailGroups = {};
        (window.PIR_DEFINITIONS_DATA || []).forEach(def => {
          const m = (def.category||'').match(/EMAIL\s*(\d+)/i);
          const num = m ? parseInt(m[1],10) : null;
          if (!num) return;
          emailGroups[num] = emailGroups[num] || { defs: [], ready: 0, total: 0 };
          emailGroups[num].defs.push(def);
        });

        // Count documents in cache that map to each email group
        Object.keys(emailGroups).forEach(k => {
          const num = parseInt(k,10);
          const defs = emailGroups[num].defs.map(d => d.title);
          const docs = pirDocsCache.filter(doc => defs.includes(doc.title));
          const totalDocs = docs.length;
          const readyDocs = docs.filter(d => getPIRDocStatus(d) === 'Ready').length;
          emailGroups[num].total = totalDocs;
          emailGroups[num].ready = readyDocs;
        });

        // Render compact email circles layout
        const circles = document.getElementById('email-status-circles');
        if (circles) {
          const items = [];
          for (let i=1;i<=9;i++) {
            const g = emailGroups[i] || { total:0, ready:0 };
            let cls = 'email-circle-item missing';
            let circleClass = 'email-circle missing';
            if (g.total > 0 && g.ready === g.total) {
              cls = 'email-circle-item ready';
              circleClass = 'email-circle ready';
            } else if (g.ready > 0) {
              cls = 'email-circle-item partial';
              circleClass = 'email-circle partial';
            }

            const countText = g.total > 0 ? `${g.ready}/${g.total}` : `–`;
            const tooltip = `Email Package ${i}: ${countText}`;

            items.push(`<div class="${cls}" title="${tooltip}" data-package="${i}">
              <div class="${circleClass}" data-package="${i}">${i}</div>
              <div class="email-circle-count">${countText}</div>
            </div>`);
          }
          circles.innerHTML = items.join('');
          // Attach popover handlers
          setTimeout(()=>{
            document.querySelectorAll('#email-status-circles [data-package]').forEach(el=>{
              el.addEventListener('click', (ev)=>{
                ev.stopPropagation();
                const pkg = parseInt(el.getAttribute('data-package'));
                toggleEmailPopover(el, pkg);
              });
            });
            // Close popovers when clicking outside
            document.addEventListener('click', ()=>{
              document.querySelectorAll('.email-popover').forEach(p=>p.remove());
            });
          }, 30);
        }
    }
    
    function getMotivationalMessage(percentage, ready, total) {
      const remaining = total - ready;
      if (percentage >= 100) {
        return `🎉 Outstanding! All ${total} items are ready for CQC inspection. You're fully compliant!`;
      } else if (percentage >= 90) {
        return `🌟 Excellent progress! Only ${remaining} items remaining. You're almost inspection-ready!`;
      } else if (percentage >= 75) {
        return `💪 Great work! ${remaining} items to go. You're in the final stretch!`;
      } else if (percentage >= 50) {
        return `📈 Good momentum! ${remaining} items remaining. Keep pushing forward!`;
      } else if (percentage >= 25) {
        return `🚀 Getting started! ${remaining} items to complete. Every step counts!`;
      } else {
        return `📋 Ready to begin? ${remaining} items need attention. Let's get inspection-ready!`;
      }
    }    function updatePIRTOC() {
        const tocContainer = document.getElementById('pir-toc-items');
        const categories = [...new Set(pirDocsCache.map(d => d.category))];
        
        tocContainer.innerHTML = categories.map(category => 
            `<a href="#category-${sanitizeId(category)}" class="pir-toc-item" data-category="${category}">
                ${esc(category.replace(/^EMAIL \d+:\s*/, ''))}
            </a>`
        ).join('');
    }

    function initPIRFilters() {
        document.querySelectorAll('.pir-filter-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('.pir-filter-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                pirState.filter = pill.dataset.filter;
                renderPIRTable();
                updateBulkBar();
            });
        });
    }

    function initPIREventHandlers() {
        const container = document.getElementById('pir-docs-container');
        
        // Row checkboxes
        container.addEventListener('change', (e) => {
            if (e.target.classList.contains('pir-row-checkbox')) {
                const docId = parseInt(e.target.dataset.id);
                if (e.target.checked) {
                    pirState.selectedItems.add(docId);
                } else {
                    pirState.selectedItems.delete(docId);
                }
                updateBulkBar();
                updateRowSelection();
            }
        });
        
        // Action buttons
        container.addEventListener('click', async (e) => {
            const action = e.target.dataset.action;
            const docId = parseInt(e.target.dataset.id);
            
            if (action && docId) {
                e.preventDefault();
                e.stopPropagation();
                
                const doc = pirDocsCache.find(d => d.id === docId);
                if (!doc) return;
                
                switch (action) {
                    case 'upload':
                        openPIRManageModal(doc);
                        break;
                    case 'view':
                        await previewPIRDocument(doc);
                        break;
                    case 'notes':
                        openPIRNotesModal(doc);
                        break;
                }
            }
        });
        
        // Template buttons
        container.addEventListener('click', (e) => {
        });
        
        // TOC navigation
        document.querySelectorAll('.pir-toc-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const categoryId = item.getAttribute('href');
                document.querySelector(categoryId)?.scrollIntoView({ behavior: 'smooth' });
                
                // Update active TOC item
                document.querySelectorAll('.pir-toc-item').forEach(t => t.classList.remove('active'));
                item.classList.add('active');
            });
        });
        
        // Bulk operation buttons
        document.getElementById('pir-export')?.addEventListener('click', () => exportPIRChecklist());
        document.getElementById('pir-export-selected')?.addEventListener('click', () => exportSelectedPIR());
        document.getElementById('pir-clear-selection')?.addEventListener('click', () => clearPIRSelection());
        
        // Interactive progress bar click
        document.querySelector('.progress-bar-container')?.addEventListener('click', () => {
          const container = document.querySelector('.progress-bar-container');
          if (container) {
            container.style.animation = 'none';
            container.offsetHeight; // Force reflow
            container.style.animation = 'progressClick 0.3s ease-out';
            
            // Show encouraging message
            const total = pirDocsCache.length;
            const ready = pirDocsCache.filter(d => getPIRDocStatus(d) === 'Ready').length;
            const percentage = total > 0 ? Math.round((ready / total) * 100) : 0;
            const message = getMotivationalMessage(percentage, ready, total);
            
            // Create temporary toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
              position: fixed; top: 20px; right: 20px; 
              background: var(--panel-bg); color: var(--white);
              padding: 12px 20px; border-radius: 8px; 
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              z-index: 1000; max-width: 320px;
              border: 1px solid var(--border-color);
              animation: slideInRight 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
              toast.style.animation = 'slideOutRight 0.3s ease-in forwards';
              setTimeout(() => toast.remove(), 300);
            }, 3000);
          }
        });
    }

    // Helper: toggle an email package popover
    function toggleEmailPopover(targetEl, packageNum) {
      // Remove any existing popovers first
      document.querySelectorAll('.email-popover').forEach(p=>p.remove());

      // Build popover content
      const pop = buildEmailPopover(packageNum);
      if (!pop) return;

      // Initially place off-screen so we can measure
      pop.style.position = 'absolute';
      pop.style.top = '0px';
      pop.style.left = '0px';
      document.body.appendChild(pop);

      // Position popover below the clicked element, centered
      const rect = targetEl.getBoundingClientRect();
      const popRect = pop.getBoundingClientRect();
      let left = window.scrollX + rect.left + (rect.width / 2) - (popRect.width / 2);
      left = Math.max(8, Math.min(left, window.scrollX + window.innerWidth - popRect.width - 8));
      let top = window.scrollY + rect.bottom + 10;
      // If not enough space below, show above
      if (top + popRect.height > window.scrollY + window.innerHeight) {
        top = window.scrollY + rect.top - popRect.height - 10;
      }
      pop.style.left = left + 'px';
      pop.style.top = top + 'px';
    }

    function buildEmailPopover(packageNum) {
      const groupDefs = (window.PIR_DEFINITIONS_DATA || []).filter(d => {
        const m = (d.category||'').match(/EMAIL\s*(\d+)/i);
        return m && parseInt(m[1],10) === packageNum;
      });

      const defs = groupDefs.map(d=>d.title);
      const docs = pirDocsCache.filter(doc => defs.includes(doc.title));
      const total = docs.length;
      const ready = docs.filter(d => getPIRDocStatus(d) === 'Ready').length;
      const pending = total - ready;

      const pop = document.createElement('div');
      pop.className = 'email-popover';

      const header = document.createElement('h4');
      header.textContent = `Email ${packageNum} summary`;
      pop.appendChild(header);

      const stats = document.createElement('div');
      stats.className = 'pop-row';
      stats.innerHTML = `<div style="font-weight:600">Status</div><div style="font-weight:700">${ready}/${total} ready</div>`;
      pop.appendChild(stats);

      if (total > 0) {
        const readyList = docs.filter(d=>getPIRDocStatus(d) === 'Ready');
        const missList = docs.filter(d=>getPIRDocStatus(d) !== 'Ready');

        if (readyList.length) {
          const rHead = document.createElement('div');
          rHead.style.marginTop = '8px';
          rHead.style.fontSize = '13px';
          rHead.style.fontWeight = '600';
          rHead.textContent = 'Ready samples';
          pop.appendChild(rHead);
          const listWrap = document.createElement('div');
          listWrap.className = 'pop-list';
          readyList.forEach(d=>{
            const row = document.createElement('div');
            row.className = 'pop-row';
            row.innerHTML = `<div style="flex:1">${esc(d.title)}</div><div class="pill ready">Ready</div>`;
            listWrap.appendChild(row);
          });
          pop.appendChild(listWrap);
        }

        if (missList.length) {
          const mHead = document.createElement('div');
          mHead.style.marginTop = '8px';
          mHead.style.fontSize = '13px';
          mHead.style.fontWeight = '600';
          mHead.textContent = 'Needs attention';
          pop.appendChild(mHead);
          const listWrap2 = document.createElement('div');
          listWrap2.className = 'pop-list';
          missList.forEach(d=>{
            const row = document.createElement('div');
            row.className = 'pop-row';
            row.innerHTML = `<div style="flex:1">${esc(d.title)}</div><div class="pill missing">Not ready</div>`;
            listWrap2.appendChild(row);
          });
          pop.appendChild(listWrap2);
        }
      } else {
        const p = document.createElement('div');
        p.style.padding = '10px 0';
        p.textContent = 'No documents configured for this package.';
        pop.appendChild(p);
      }

      const actions = document.createElement('div');
      actions.className = 'pop-actions';
      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn';
      closeBtn.textContent = 'Close';
      closeBtn.addEventListener('click', ()=>document.querySelectorAll('.email-popover').forEach(p=>p.remove()));
      actions.appendChild(closeBtn);
      pop.appendChild(actions);

      return pop;
    }

    function updateBulkBar() {
        const bulkBar = document.getElementById('pir-bulk-bar');
        const count = pirState.selectedItems.size;
        
        if (count > 0) {
            bulkBar.classList.add('visible');
            document.getElementById('pir-selected-count').textContent = count;
        } else {
            bulkBar.classList.remove('visible');
        }
    }

    function updateRowSelection() {
        document.querySelectorAll('.pir-table-row').forEach(row => {
            const docId = parseInt(row.dataset.id);
            if (pirState.selectedItems.has(docId)) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });
    }

    function clearPIRSelection() {
        pirState.selectedItems.clear();
        updateBulkBar();
        updateRowSelection();
        document.querySelectorAll('.pir-row-checkbox').forEach(cb => cb.checked = false);
    }

    async function previewPIRDocument(doc) {
        if (!doc.file_path) {
            showEnhancedPIRModal(doc, null, null);
            return;
        }
        
        // Show loading modal first
        showEnhancedPIRModal(doc, null, null, true);
        
        try {
            // Get signed URL for private storage (1 hour expiry)
            const { data: urlData, error: urlError } = await supabase.storage
                .from('pir_attachments')
                .createSignedUrl(doc.file_path, 3600);

            if (urlError) {
                console.error('Error creating signed URL:', urlError);
                showEnhancedPIRModal(doc, null, null, false, urlError.message);
                return;
            }

            const fileUrl = urlData?.signedUrl;
            
            // Fetch file metadata
            const { data: fileData, error: downloadError } = await supabase.storage
                .from('pir_attachments')
                .download(doc.file_path);
            
            if (downloadError) {
                console.warn('Could not fetch file metadata:', downloadError);
                showEnhancedPIRModal(doc, fileUrl, null);
                return;
            }
            
            // Get file metadata
            const fileInfo = {
                name: doc.file_path.split('/').pop(),
                size: fileData.size,
                type: fileData.type || 'application/octet-stream',
                url: fileUrl,
                data: fileData
            };
            
            showEnhancedPIRModal(doc, fileUrl, fileInfo);
            
        } catch (err) {
            console.error('Preview error:', err);
            showEnhancedPIRModal(doc, null, null, false, err.message);
        }
    }

    async function showEnhancedPIRModal(doc, fileUrl, fileInfo, isLoading = false, errorMessage = null) {
        // Remove existing enhanced modal if present
        const existingModal = document.getElementById('enhanced-pir-modal');
        if (existingModal) existingModal.remove();
        
        const modal = document.createElement('div');
        modal.id = 'enhanced-pir-modal';
        modal.className = 'modal enhanced-pir-modal';
        modal.style.zIndex = '2000';
        
        // Get additional info
        const status = getPIRDocStatus(doc);
        const statusClass = getPIRStatusClass(status);
        const extension = fileInfo?.name ? fileInfo.name.toLowerCase().split('.').pop() : null;
        
        // Get uploader info if available
        let uploaderInfo = '';
        if (fileInfo && doc.file_path) {
            try {
                // Extract user ID from file path (format: site_id/doc_id/filename)
                const pathParts = doc.file_path.split('/');
                if (pathParts.length >= 2) {
                    // Query for the user who uploaded this file
                    const { data: profile } = await supabase
                        .from('master_users')
                        .select('full_name')
                        .eq('site_id', doc.site_id)
                        .single();
                    
                    if (profile) {
                        uploaderInfo = `<div class="enhanced-info-item">
                            <span class="info-label">Uploaded by:</span>
                            <span class="info-value">${esc(profile.full_name || 'Unknown')}</span>
                        </div>`;
                    }
                }
            } catch (e) {
                console.warn('Could not fetch uploader info:', e);
            }
        }
        
        const formatFileSize = (bytes) => {
            if (!bytes) return 'Unknown size';
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };
        
        const getFileIcon = (ext) => {
            switch(ext) {
                case 'pdf': return '📄';
                case 'doc':
                case 'docx': return '📝';
                case 'xls':
                case 'xlsx': return '📊';
                case 'ppt':
                case 'pptx': return '📋';
                case 'jpg':
                case 'jpeg':
                case 'png':
                case 'gif': return '🖼️';
                default: return '📎';
            }
        };
        
        let previewContent = '';
        let actionButtons = '';
        
        if (isLoading) {
            previewContent = `
                <div class="enhanced-preview-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading document preview...</p>
                </div>
            `;
        } else if (errorMessage) {
            previewContent = `
                <div class="enhanced-preview-error">
                    <div class="error-icon">⚠️</div>
                    <h4>Could not load preview</h4>
                    <p>${esc(errorMessage)}</p>
                </div>
            `;
        } else if (!fileUrl) {
            previewContent = `
                <div class="enhanced-preview-empty">
                    <div class="empty-icon">📄</div>
                    <h4>No file attached</h4>
                    <p>This document doesn't have any files attached yet.</p>
                    <button class="btn primary" onclick="openPIRManageModal(pirDocsCache.find(d => d.id === ${doc.id}))">
                        Upload File
                    </button>
                </div>
            `;
        } else {
            // Generate preview based on file type
            if (extension === 'pdf') {
                previewContent = `
                    <div class="enhanced-pdf-preview">
                        <iframe src="${fileUrl}#toolbar=1&navpanes=0&scrollbar=1" 
                                style="width: 100%; height: 500px; border: none; border-radius: 8px;"></iframe>
                    </div>
                `;
            } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) {
                previewContent = `
                    <div class="enhanced-image-preview">
                        <img src="${fileUrl}" 
                             style="max-width: 100%; max-height: 500px; object-fit: contain; border-radius: 8px;" 
                             alt="Document preview">
                    </div>
                `;
            } else {
                previewContent = `
                    <div class="enhanced-preview-unsupported">
                        <div class="file-icon">${getFileIcon(extension)}</div>
                        <h4>Preview not available</h4>
                        <p>Preview is not supported for ${extension?.toUpperCase()} files.</p>
                        <p class="muted">Click download to view the file in its native application.</p>
                    </div>
                `;
            }
            
            actionButtons = `
                <button class="btn secondary" onclick="downloadPIRFile('${doc.file_path}', '${fileInfo?.name || 'document'}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Download
                </button>
                ${extension === 'pdf' ? `
                <button class="btn secondary" onclick="window.open('${fileUrl}', '_blank')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                    Open in New Tab
                </button>
                ` : ''}
                <button class="btn primary" onclick="openPIRManageModal(pirDocsCache.find(d => d.id === ${doc.id}))">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Update File
                </button>
            `;
        }
        
        modal.innerHTML = `
            <div class="modal-content enhanced-pir-content">
                <div class="enhanced-pir-header">
                    <div class="header-main">
                        <h2>${esc(doc.title)}</h2>
                        <span class="pir-status-chip ${statusClass}">${status}</span>
                    </div>
                    <div class="header-meta">
                        <span class="category-badge">${esc(doc.category)}</span>
                        <span class="item-type-badge">${formatItemType(doc.item_type)}</span>
                    </div>
                </div>
                
                <div class="enhanced-pir-body">
                    <div class="enhanced-pir-sidebar">
                        <div class="enhanced-info-section">
                            <h4>Document Information</h4>
                            
                            ${fileInfo ? `
                            <div class="enhanced-info-item">
                                <span class="info-label">File Name:</span>
                                <span class="info-value">${esc(fileInfo.name)}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">File Size:</span>
                                <span class="info-value">${formatFileSize(fileInfo.size)}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">File Type:</span>
                                <span class="info-value">${extension?.toUpperCase() || 'Unknown'}</span>
                            </div>
                            ` : ''}
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">Status:</span>
                                <span class="info-value status-${statusClass}">${status}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">Last Updated:</span>
                                <span class="info-value">${doc.last_updated ? fmtDateShort(doc.last_updated) : 'Never'}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">Created:</span>
                                <span class="info-value">${fmtDateShort(doc.created_at)}</span>
                            </div>
                            
                            ${uploaderInfo}
                        </div>
                        
                        <div class="enhanced-notes-section">
                            <h4>Notes</h4>
                            ${(getPirDocNotes(doc) && getPirDocNotes(doc).trim()) ? `
                                <div class="enhanced-notes-display">
                                    <div class="notes-content">${esc(getPirDocNotes(doc)).replace(/\n/g, '<br>')}</div>
                                    <button class="btn secondary small" onclick="openPIRNotesModal(pirDocsCache.find(d => d.id === ${doc.id}))">
                                        Edit Notes
                                    </button>
                                </div>
                            ` : `
                                <div class="enhanced-notes-empty">
                                    <p class="muted">No notes added yet</p>
                                    <button class="btn secondary small" onclick="openPIRNotesModal(pirDocsCache.find(d => d.id === ${doc.id}))">
                                        Add Notes
                                    </button>
                                </div>
                            `}
                        </div>
                        
                        ${!isLoading && !errorMessage ? `
                        <div class="enhanced-actions-section">
                            <h4>Actions</h4>
                            <div class="enhanced-action-buttons">
                                ${actionButtons}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="enhanced-pir-preview">
                        ${previewContent}
                    </div>
                </div>
                
                <div class="enhanced-pir-footer">
                    <button class="btn secondary modal-close" onclick="document.getElementById('enhanced-pir-modal').remove()">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.classList.add('show');
        
        // Close handlers
        modal.addEventListener('click', (e) => {
            if (e.target === modal || e.target.classList.contains('modal-close')) {
                modal.remove();
            }
        });
        
        // Escape key handler
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    async function downloadPIRFile(filePath, fileName) {
        try {
            const { data, error } = await supabase.storage.from('pir_attachments').download(filePath);
            if (error) {
                alert(`Download failed: ${error.message}`);
                return;
            }
            
            const url = URL.createObjectURL(data);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (err) {
            alert(`Download failed: ${err.message}`);
        }
    }


    // PIR Management Modal Function
    function openPIRManageModal(doc) {
        if (!doc) {
            console.error('No document provided to openPIRManageModal');
            return;
        }
        // Use the existing CRUD system for PIR documents
        openCRUD('pir_documents', 'edit', doc);
    }

    async function exportPIRChecklist() {
        // Generate email zip export instead of CSV
        try {
            const zip = new JSZip();
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            
            // Group documents by email package (1-9)
            const emailGroups = {};
            (window.PIR_DEFINITIONS_DATA || []).forEach(def => {
                const match = (def.category || '').match(/EMAIL\s*(\d+)/i);
                const emailNum = match ? parseInt(match[1], 10) : null;
                if (emailNum && emailNum >= 1 && emailNum <= 9) {
                    if (!emailGroups[emailNum]) {
                        emailGroups[emailNum] = {
                            title: def.category.replace(/EMAIL\s*\d+:\s*/i, ''),
                            items: []
                        };
                    }
                    
                    // Find corresponding document in cache
                    const doc = pirDocsCache.find(d => 
                        d.title === def.title && d.category === def.category
                    );
                    
                    emailGroups[emailNum].items.push({
                        def: def,
                        doc: doc,
                        status: doc ? getPIRDocStatus(doc) : 'Missing',
                        hasFile: doc && doc.file_path,
                        blurb: def.email_blurb || `Please find attached: ${def.title}`
                    });
                }
            });
            
            // Generate individual email files and a master summary
            let masterSummary = `CQC 2-Week Notice Email Documentation Package\n`;
            masterSummary += `Generated: ${now.toLocaleDateString()} at ${now.toLocaleTimeString()}\n`;
            masterSummary += `\n=======================================================\n\n`;
            
            for (let emailNum = 1; emailNum <= 9; emailNum++) {
                const group = emailGroups[emailNum];
                if (!group) continue;
                
                // Create email folder
                const folderName = `Email_${emailNum}_${group.title.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                // Generate email content
                let emailContent = `Subject: CQC 2-Week Notice Email Documentation - ${group.title}\n\n`;
                emailContent += `Dear CQC Inspector,\n\n`;
                emailContent += `As requested for our upcoming inspection, please find attached the documentation for ${group.title.toLowerCase()}.\n\n`;
                
                const readyItems = group.items.filter(item => item.status === 'Ready');
                const pendingItems = group.items.filter(item => item.status !== 'Ready');
                
                if (readyItems.length > 0) {
                    emailContent += `ATTACHED DOCUMENTS:\n`;
                    readyItems.forEach(item => {
                        emailContent += `• ${item.def.title}\n`;
                        if (item.blurb) emailContent += `  ${item.blurb}\n`;
                    });
                    emailContent += `\n`;
                }
                
                if (pendingItems.length > 0) {
                    emailContent += `PENDING DOCUMENTATION (to be provided separately):\n`;
                    pendingItems.forEach(item => {
                        emailContent += `• ${item.def.title} (Status: ${item.status})\n`;
                    });
                    emailContent += `\n`;
                }
                
                emailContent += `If you require any additional information or clarification on these documents, please let us know.\n\n`;
                emailContent += `Best regards,\n`;
                emailContent += `[Your Name]\n`;
                emailContent += `[Practice Name]\n`;
                emailContent += `\nGenerated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}\n`;
                
                // Add email content to zip
                zip.file(`${folderName}/email_content.txt`, emailContent);
                
                // Create attachment list
                let attachmentList = `ATTACHMENT CHECKLIST for Email ${emailNum}\n`;
                attachmentList += `Category: ${group.title}\n`;
                attachmentList += `Generated: ${dateStr}\n\n`;
                
                group.items.forEach((item, index) => {
                    attachmentList += `${index + 1}. ${item.def.title}\n`;
                    attachmentList += `   Status: ${item.status}\n`;
                    if (item.doc && item.doc.last_updated) {
                        attachmentList += `   Last Updated: ${item.doc.last_updated}\n`;
                    }
                    if (item.def.description) {
                        attachmentList += `   Description: ${item.def.description}\n`;
                    }
                    attachmentList += `\n`;
                });
                
                zip.file(`${folderName}/attachment_checklist.txt`, attachmentList);
                
                // Add to master summary
                masterSummary += `EMAIL ${emailNum}: ${group.title.toUpperCase()}\n`;
                masterSummary += `Ready: ${readyItems.length}/${group.items.length} documents\n`;
                masterSummary += `Status: ${readyItems.length === group.items.length ? '✓ COMPLETE' : '⚠ INCOMPLETE'}\n\n`;
                
                if (readyItems.length > 0) {
                    masterSummary += `Ready documents:\n`;
                    readyItems.forEach(item => masterSummary += `  • ${item.def.title}\n`);
                    masterSummary += `\n`;
                }
                
                if (pendingItems.length > 0) {
                    masterSummary += `Pending documents:\n`;
                    pendingItems.forEach(item => masterSummary += `  • ${item.def.title} (${item.status})\n`);
                    masterSummary += `\n`;
                }
                
                masterSummary += `-------------------------------------------------------\n\n`;
            }
            
            // Add master summary to zip
            zip.file('CQC_Documentation_Summary.txt', masterSummary);
            
            // Generate and download zip
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CQC_Pre_Inspection_Emails_${dateStr}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show success message
            showNotification('Email package export completed successfully!', 'success');
            
        } catch (error) {
            console.error('Export failed:', error);
            showNotification('Export failed: ' + error.message, 'error');
        }
    }


    function exportSelectedPIR() {
        const selectedDocs = pirDocsCache.filter(doc => pirState.selectedItems.has(doc.id));
        const data = selectedDocs.map(doc => ({
            Category: doc.category,
            Title: doc.title,
            Status: getPIRDocStatus(doc),
            'Last Updated': doc.last_updated || 'Never',
            'Evidence Type': formatItemType(doc.item_type)
        }));
        
        downloadCSV(data, 'PIR-Selected-Items.csv');
    }

    function openPIRNotesModal(doc) {
        // Remove any existing notes modal
        const existingModal = document.getElementById('pir-notes-modal');
        if (existingModal) existingModal.remove();
        
        const modal = document.createElement('div');
        modal.id = 'pir-notes-modal';
        modal.className = 'modal pir-notes-modal';
        modal.style.zIndex = '2001';
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Notes for: ${esc(doc.title)}</h2>
                    <button class="modal-close" onclick="document.getElementById('pir-notes-modal').remove()">×</button>
                </div>
                
                <div class="modal-body">
                    <div class="field">
                        <label for="pir-notes-textarea">Document Notes</label>
                        <textarea 
                            id="pir-notes-textarea" 
                            rows="8" 
                            placeholder="Add notes about this document, its status, or any important information..."
                        >${esc(getPirDocNotes(doc) || '')}</textarea>
                        <div class="hint">These notes are private to your organization and will not be included in any reports.</div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn secondary" onclick="document.getElementById('pir-notes-modal').remove()">
                        Cancel
                    </button>
                    <button class="btn primary" id="save-pir-notes-btn">
                        Save Notes
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.classList.add('show');
        
        // Add event listener for Save Notes button
        const saveBtn = document.getElementById('save-pir-notes-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => savePIRNotes(doc.id));
        }
        
        // Focus on textarea
        setTimeout(() => {
            const textarea = document.getElementById('pir-notes-textarea');
            if (textarea) textarea.focus();
        }, 100);
        
        // Close on escape key
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
        
        // Close when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
                document.removeEventListener('keydown', escHandler);
            }
        });
    }
    
    async function savePIRNotes(docId) {
        const modal = document.getElementById('pir-notes-modal');
        const textarea = document.getElementById('pir-notes-textarea');
        const saveBtn = document.querySelector('#pir-notes-modal .btn.primary');

        if (!textarea || !saveBtn) {
            alert('Error: Could not find notes input elements.');
            return;
        }

        const notes = textarea.value.trim();
        const originalText = saveBtn.textContent;

        // Show saving state immediately
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
            if (!window.supabase) throw new Error('Supabase not initialized');
            if (!ctx || !ctx.site_id) throw new Error('Site context not available');

            // Try preferred path: dedicated column 'notes'
            let updatedRow = null;
            let res = await supabase
                .from('pir_documents')
                .update({ notes: notes || null })
                .eq('id', docId)
                .eq('site_id', ctx.site_id)
                .select()
                .single();

            if (res.error) {
                const msg = (res.error.message || '').toLowerCase();
                const isMissingColumn = msg.includes('column') && msg.includes('does not exist') && msg.includes('notes');

                if (!isMissingColumn) throw res.error; // real error, not a missing column

                // Fallback: store notes inside JSONB data.notes
                const currentDoc = pirDocsCache.find(d => d.id === docId) || {};
                const existingData = currentDoc.data || {};
                const newData = { ...existingData, notes: notes || null };

                res = await supabase
                    .from('pir_documents')
                    .update({ data: newData })
                    .eq('id', docId)
                    .eq('site_id', ctx.site_id)
                    .select()
                    .single();

                if (res.error) throw res.error;
                updatedRow = res.data;
            } else {
                updatedRow = res.data;
            }

            // Update local cache for both shapes
            const idx = pirDocsCache.findIndex(d => d.id === docId);
            if (idx !== -1) {
                pirDocsCache[idx] = {
                    ...pirDocsCache[idx],
                    ...(updatedRow || {}),
                    notes: notes || null,
                    data: { ...(pirDocsCache[idx].data || {}), notes: notes || null }
                };
            }

            // Success feedback and refresh
            saveBtn.textContent = 'Saved!';
            saveBtn.classList.add('success');

            setTimeout(() => {
                document.getElementById('pir-notes-modal')?.remove();
                renderPIRTable();

                const enhancedModal = document.getElementById('enhanced-pir-modal');
                if (enhancedModal) {
                    const updatedDoc = pirDocsCache.find(d => d.id === docId);
                    if (updatedDoc) previewPIRDocument(updatedDoc);
                }
            }, 700);

        } catch (err) {
            console.error('Error saving notes:', err);
            saveBtn.textContent = 'Error - Try Again';
            saveBtn.classList.add('error');
            setTimeout(() => {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                saveBtn.classList.remove('error');
            }, 1500);
            alert(`Failed to save notes: ${err.message || err}`);
        }
    }

    function saveDraftText(docId, text) {
        pirState.draftTexts.set(docId, text);
        localStorage.setItem('pir_draft_texts', JSON.stringify([...pirState.draftTexts]));
        renderPIRTable();
    }

    function sanitizeId(str) {
        return str.replace(/[^a-zA-Z0-9-_]/g, '-').toLowerCase();
    }

    function downloadCSV(data, filename) {
        if (!data.length) return;
        
        // Create workbook and worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data);
        
        // Get range of the worksheet
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        // Set column widths
        const cols = [];
        for (let C = range.s.c; C <= range.e.c; ++C) {
            cols.push({ wch: 15 }); // Set width to 15 characters
        }
        ws['!cols'] = cols;
        
        // Add autofilter
        ws['!autofilter'] = { ref: ws['!ref'] };
        
        // Format headers (first row) - Note: Community edition has limited styling
        // We'll add a note about formatting in the first cell
        const isComplaint = filename.includes('complaint');
        const isTraining = filename.includes('training');
        const reportType = isComplaint ? 'Complaints Report' : (isTraining ? 'Training Matrix Report' : 'Report');
        
        // Add the worksheet to the workbook
        XLSX.utils.book_append_sheet(wb, ws, reportType);
        
        // Write the Excel file
        const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        
        // Download the file
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename.replace('.csv', '.xlsx');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Preview modal close handler
    document.getElementById('pir-preview-close')?.addEventListener('click', () => {
        document.getElementById('pir-preview-modal').classList.remove('show');
    });


    // NOTE: The logic for the modal pop-up is now handled by the .eml generator script.
    // The old modal logic is left here but is not triggered by the main button anymore.


    // Helper function to format data from JSON into a readable text file string
    function formatDataForTxt(doc, itemDef) {
        let content = `DOCUMENT: ${doc.title}\nCATEGORY: ${doc.category}\n\n--------------------\n\n`;

        if (doc.data.answers && itemDef.questions) {
            itemDef.questions.forEach((q, index) => {
                content += `Q: ${q}\nA: ${doc.data.answers[index] || 'Not answered'}\n\n`;
            });
        } else if (doc.data.text_content) {
            content += `${doc.data.text_content}\n`;
        } else if (doc.item_type === 'dynamic_table' && doc.data.table_data) {
            content += itemDef.headers.join('\t') + '\n';
            content += '--------------------\n';
            content += doc.data.table_data.map(row => row.join('\t')).join('\n');
        } else {
            const labels = itemDef.labels || ['Value 1', 'Value 2', 'Value 3'];
             ['num1', 'num2', 'num3', 'text1', 'text2'].forEach((key, idx) => {
                if(doc.data[key] != null && doc.data[key] !== '') {
                    content += `${labels[idx] || key}: ${doc.data[key]}\n`;
                }
            });
        }
        return content;
    }

    function buildPirForm(item, data, filePath) {
        const itemDef = PIR_DEFINITIONS.find(d => d.title === item.title) || {};
        let html = '';
        const dataValues = data || {};
        
        // Load draft text if exists
        const draftKey = `pir_draft_${item.title}`;
        const savedDraft = localStorage.getItem(draftKey);
        
        let currentStatus = item.status;
        if (currentStatus === 'Not Attached' && !item.item_type.includes('file')) {
            currentStatus = 'Not Started';
        }

        const today = new Date().toISOString().slice(0,10);
        html += `<div class="field">
            <label>Last Updated</label>
            <div class="datepicker-wrapper">
                <input id="field-pir-last_updated" type="date" value="${item.last_updated || today}" class="modern-datepicker" />
                <button type="button" class="btn secondary quick-date" onclick="document.getElementById('field-pir-last_updated').value='${today}'">Today</button>
            </div>
        </div>`;

        // Certificate expiry tracking section
        if (item.item_type.includes('file')) {
            html += `
                <div class="field-group certificate-tracking" style="background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin: 16px 0;">
                    <h4 style="margin: 0 0 12px 0; color: var(--accent-2);">📋 Certificate Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="field" style="margin: 0;">
                            <label>Certificate Date</label>
                            <input id="field-pir-certificate_date" type="date" value="${dataValues.certificate_date || ''}" />
                            <div class="hint">Date when this certificate/document was issued</div>
                        </div>
                        <div class="field" style="margin: 0;">
                            <label>Valid Until</label>
                            <select id="field-pir-expiry_date" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select expiry period...</option>
                                <option value="1-month">1 Month</option>
                                <option value="3-months">3 Months</option>
                                <option value="6-months">6 Months</option>
                                <option value="1-year">1 Year</option>
                                <option value="2-years">2 Years</option>
                                <option value="3-years">3 Years</option>
                                <option value="5-years">5 Years</option>
                                <option value="no-expiry">No Expiry</option>
                            </select>
                            <div class="hint">How long until this certificate expires</div>
                        </div>
                    </div>
                </div>
            `;
        }

        switch(item.item_type) {
            case 'textarea':
                const textareaValue = savedDraft || dataValues.text_content || '';
                html += `<div class="field">
                    <label>Summary / Statement</label>
                    <textarea id="field-pir-text_content" class="draft-enabled" data-draft-key="${draftKey}">${esc(textareaValue)}</textarea>
                    ${savedDraft ? '<div class="draft-indicator">📝 Draft saved</div>' : ''}
                </div>`;
                break;
            case 'textarea_and_file':
                const textareaFileValue = savedDraft || dataValues.text_content || '';
                html += `<div class="field">
                    <label>Summary / Process Description</label>
                    <textarea id="field-pir-text_content" class="draft-enabled" data-draft-key="${draftKey}">${esc(textareaFileValue)}</textarea>
                    ${savedDraft ? '<div class="draft-indicator">📝 Draft saved</div>' : ''}
                    <div class="hint">${itemDef.description || ''}</div>
                </div>`;
                break;
            case 'guided_questions':
            case 'guided_questions_and_file':
            case 'guided_questions_and_number':
                 if (itemDef.questions) {
                    itemDef.questions.forEach((q, index) => {
                        const questionDraftKey = `${draftKey}_q${index}`;
                        const savedQuestionDraft = localStorage.getItem(questionDraftKey);
                        const questionValue = savedQuestionDraft || dataValues.answers?.[index] || '';
                        html += `<div class="field">
                            <label>${esc(q)}</label>
                            <textarea data-question-index="${index}" class="draft-enabled" data-draft-key="${questionDraftKey}">${esc(questionValue)}</textarea>
                            ${savedQuestionDraft ? '<div class="draft-indicator">📝 Draft saved</div>' : ''}
                        </div>`;
                    });
                 }
                 if (item.item_type.includes('number')) {
                    html += `<div class="field"><label>${esc(itemDef.label || 'Value')}</label><input id="field-pir-num1" type="number" value="${esc(dataValues.num1 || '')}" /></div>`;
                 }
                break;
            case 'number':
                html += `<div class="field"><label>${esc(itemDef.label || 'Value')}</label><input id="field-pir-num1" type="number" value="${esc(dataValues.num1 || '')}" /></div>`;
                break;
            case 'dual_number':
            case 'triple_number':
                html += `<div class="multi-input-container">${itemDef.labels.map((label, i) => `
                    <div class="field"><label>${esc(label)}</label><input id="field-pir-num${i+1}" type="number" value="${esc(dataValues[`num${i+1}`] || '')}" /></div>
                `).join('')}</div>`;
                break;
            case 'dual_text':
                 html += `<div class="multi-input-container">${itemDef.labels.map((label, i) => `
                    <div class="field"><label>${esc(label)}</label><input id="field-pir-text${i+1}" type="text" value="${esc(dataValues[`text${i+1}`] || '')}" /></div>
                `).join('')}</div>`;
                break;
            case 'dynamic_table':
                html += `<div class="field"><label>${esc(item.title)}</label><div id="dynamic-table-container"></div><button type="button" class="btn secondary" id="btn-add-table-row" style="margin-top:8px; font-size:12px; padding: 6px 10px;">+ Add Row</button></div>`;
                break;
        }

        if (item.item_type.includes('file')) {
            const fileName = filePath ? filePath.split('/').pop() : 'No file attached';
            html += `<hr style="border:none; border-top: 1px solid var(--border-color); margin: 16px 0;">
                <div class="field">
                <label>Attached File</label>
                <div id="file-display" style="padding:10px 12px; background:#ffffff10; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span>${esc(fileName)}</span>
                    <div style="display:flex; gap:6px;">
                      ${filePath ? `<button type="button" class="btn secondary" id="btn-preview-pir" style="padding: 4px 8px; font-size: 12px;">Preview</button>` : ''}
                      ${filePath ? `<button type="button" class="btn secondary" id="btn-download-pir" style="padding: 4px 8px; font-size: 12px;">Download</button>` : ''}
                      ${filePath ? `<button type="button" class="btn secondary" id="btn-delete-pir-attachment" style="padding: 4px 8px; font-size: 12px; background: #ff6b6b33; border-color: #ff6b6b55;">Delete</button>` : ''}
                    </div>
                </div>
                <input type="file" id="field-pir-file_path" style="color: var(--muted); font-size: 12px;" />
                <div class="hint">${itemDef.description || 'Uploading a new file will replace the existing one.'}</div>
                </div>`;
        }
        return html;
    }

    // Initialize draft text auto-save
    function initializeDraftTextSupport() {
        // Auto-save draft text
        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('draft-enabled')) {
                const draftKey = e.target.dataset.draftKey;
                if (draftKey) {
                    localStorage.setItem(draftKey, e.target.value);
                    
                    // Show/hide draft indicator
                    let indicator = e.target.parentNode.querySelector('.draft-indicator');
                    if (e.target.value.trim()) {
                        if (!indicator) {
                            indicator = document.createElement('div');
                            indicator.className = 'draft-indicator';
                            indicator.textContent = '📝 Draft saved';
                            e.target.parentNode.appendChild(indicator);
                        }
                    } else {
                        if (indicator) {
                            indicator.remove();
                        }
                        localStorage.removeItem(draftKey);
                    }
                }
            }
        });

        // Handle template downloads
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('template-download-btn')) {
                const templateName = e.target.dataset.templateName;
                const templateUrl = e.target.dataset.templateUrl;
                
                if (templateUrl) {
                    // Create temporary link to download template
                    const link = document.createElement('a');
                    link.href = templateUrl;
                    link.download = templateName;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showToast(`Downloaded template: ${templateName}`, 'success');
                } else {
                    showToast('Template URL not found', 'error');
                }
            }
        });
    }

    // Clear draft text for a specific item
    function clearDraftText(itemTitle) {
        const draftKey = `pir_draft_${itemTitle}`;
        localStorage.removeItem(draftKey);
        
        // Also clear question drafts if any
        for (let i = 0; i < 10; i++) {
            localStorage.removeItem(`${draftKey}_q${i}`);
        }
    }

  // Initialize role management modal close behavior
  const rolesModal = document.getElementById('roles-modal');
  if (rolesModal) {
    rolesModal.addEventListener('click', (e) => {
      if (e.target === rolesModal || e.target.closest('.modal-close')) {
        rolesModal.classList.remove('show');
      }
    });
  }

  // Bootstrap - expose globally so it can be called from early session check
  window.bootstrap = async function bootstrap(){
    console.log('🚀 Bootstrap starting...');
    
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (error) {
        console.error('❌ Session check failed:', error);
        showAuth(true);
        return;
      }

      if (!session) {
        console.log('ℹ️ No session found, showing auth');
        showAuth(true);
        return;
      }

      console.log('✅ Session found, user:', session.user?.email);
      
      // Hide auth and show main app
      showAuth(false);

      try {
        console.log('📍 Loading context...');
        await loadContext();
        console.log('✅ Context loaded successfully');
      } catch (contextError) {
        console.error('❌ Context loading failed:', contextError);
        
        // Try to at least display basic user info from session
        try {
          const userName = document.getElementById('user-name');
          const userInitials = document.getElementById('user-initials');
          if (userName && session.user) {
            const displayName = session.user.email.split('@')[0].replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            userName.textContent = displayName;
            
            if (userInitials) {
              userInitials.textContent = displayName.substring(0, 2).toUpperCase();
            }
          }
        } catch (displayError) {
          console.error('Failed to set fallback user display:', displayError);
        }
        
        // Continue loading the page even if context failed
        console.log('⚠️ Continuing with limited functionality');
      }

      try {
        console.log('🌱 Seeding initial PIR docs...');
        await seedInitialPIRDocs();
        console.log('📅 Caching schedules...');
        await cacheRequiredSchedules();
        console.log('📊 Loading dashboard data...');
        await Promise.all([loadCounts(), loadDue(), loadActivity(), loadItems(), loadRooms(), loadComplaints(), loadCheckTypes(), loadSchedules(), loadStaff(), loadSubmissions(), loadWeekCalendar(), loadAndRenderCalendar(), loadCQCDashboard()]);
        console.log('✅ All data loaded successfully');
      } catch (dataError) {
        console.error('⚠️ Data loading failed (non-critical):', dataError);
        // Don't redirect to auth - just log the error and continue
        showError('Some data failed to load. Dashboard may show incomplete information.');
      }

      // If the active section is pre-inspection, ensure its data is loaded now that context is ready.
      if (activeViewId() === 'view-pre-inspection') {
          try {
            await loadAndRenderPIR();
          } catch (pirError) {
            console.error('PIR loading failed:', pirError);
          }
      }

      // Set up real-time subscriptions
      try {
        console.log('🔄 Setting up real-time subscriptions...');
        supabase.channel("changes")
          .on("postgres_changes", { event:"*", schema:"public", table:"items", filter:`site_id=eq.${ctx.site_id}` }, loadItems)
          .on("postgres_changes", { event:"*", schema:"public", table:"rooms", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadRooms(); await loadCounts(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"complaints", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadComplaints(); await loadCounts(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"check_types", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadCheckTypes(); await loadCounts(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"kiosk_users", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadStaff(); await loadCounts(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"submissions", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadActivity(); await loadSubmissions(); await loadWeekCalendar(); if(activeViewId() === 'view-calendar') loadAndRenderCalendar(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"item_allowed_types", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadSchedules(); await cacheRequiredSchedules(); await loadWeekCalendar(); if(activeViewId() === 'view-calendar') loadAndRenderCalendar(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"pir_documents", filter:`site_id=eq.${ctx.site_id}` }, async() => { if (activeViewId() === 'view-pre-inspection') { loadAndRenderPIR(); }})
          .on("postgres_changes", { event:"*", schema:"public", table:"training_records", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadCQCDashboard(); await loadCounts(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"pir_documents", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadCQCDashboard(); if (activeViewId() === 'view-pre-inspection') loadAndRenderPIR(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"submission_rows", filter:`site_id=eq.${ctx.site_id}` }, async(payload)=>{
            if(submissionDetailModal.classList.contains("show")){
              const openId = submissionDetailModal.dataset.submissionId;
              if(payload.new.submission_id == openId){ showSubmissionDetails(openId); }
            }
            await loadCQCDashboard();
          })
          .on("postgres_changes", { event:"*", schema:"public", table:"complaints", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadComplaints(); await loadCounts(); await loadCQCDashboard(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"submission_rows", filter:`site_id=eq.${ctx.site_id}` }, async(payload)=>{
            if(submissionDetailModal.classList.contains("show")){
              const openId = submissionDetailModal.dataset.submissionId;
              if(payload.new.submission_id == openId){ showSubmissionDetails(openId); }
            }
          })
          .subscribe();
        console.log('✅ Real-time subscriptions set up');
      } catch (subscriptionError) {
        console.error('⚠️ Failed to set up real-time subscriptions:', subscriptionError);
        // This is non-critical, continue without redirecting to auth
      }
      
      console.log('🎉 Bootstrap completed successfully');
      
    } catch (err) {
      console.error('💥 Bootstrap failed with unexpected error:', err);
      showError('Application failed to start. Please refresh the page and try again.');
      // Only redirect to auth if it's clearly an authentication issue
      if (err.message && (err.message.includes('auth') || err.message.includes('session') || err.message.includes('token'))) {
        console.log('Authentication error detected, redirecting to login');
        showAuth(true);
      }
    }
  }

  // ---------- CRUD Helpers ----------
  const crudModal = document.getElementById("crud-modal");
  const crudTitle = document.getElementById("crud-title");
  const crudForm = document.getElementById("crud-form");
  const crudFields = document.getElementById("crud-fields");
  const crudError = document.getElementById("crud-error");
  const crudDeleteBtn = document.getElementById("crud-delete");
  const crudCancelBtn = document.getElementById("crud-cancel");

  let crudState = { entity:null, mode:"add", row:null, pk:null, context: {} };

  const ENTITIES = {
    rooms: { table: "rooms", label: "Room", pk: "id", fields: [{name:"name", label:"Name", type:"text", required:true}, {name:"occupied_by", label:"Owner (Staff)", type:"select", source:"kiosk_users", sourceLabel:"full_name"}] },
    check_types: { table: "check_types", label: "Check Type", pk: "id", fields: [{name:"name", label:"Name", type:"text", required:true}, {name:"active", label:"Active", type:"checkbox", default:true}] },
  kiosk_users: { table: "kiosk_users", label: "Staff", pk: "id", fields: [{name:"full_name", label:"Full Name", type:"text", required:true},
{name:"role", label:"Role", type:"select", required:true},
{name:"reports_to_id", label:"Reports To", type:"select", source:"kiosk_users", sourceLabel:"full_name", valueKey:"id"},
{name:"active", label:"Active", type:"checkbox", default:true}] },
    complaints: { table: "complaints", label: "Complaint", pk: "id", fields: [
  { name: "attachment", label: "Attach Complaint Document", type: "file-upload", fullWidth: true },
  { name: "complaint_date", label: "Complaint Date", type: "datepicker", required: true },
  { name: "patient_initials", label: "Patient Initials", type: "text", required: true, maxLength: 10 },
      { name: "age", label: "Age", type: "age-selector" },
      { name: "complaint_number", label: "Complaint Number", type: "text", readonly: true },
      { name: "response_sent", label: "Response Sent", type: "checkbox", default: false },
  { name: "complaint_summary", label: "Complaint Summary", type: "textarea", required: true, fullWidth: true },
  { name: "original_complaint", label: "Original Complaint Details", type: "textarea", fullWidth: true },
  { name: "response", label: "Response Given", type: "textarea", fullWidth: true },
  { name: "lessons_learned", label: "Lessons Learned", type: "textarea", fullWidth: true },
  { name: "category", label: "Category", type: "select", source: "complaint_categories", sourceLabel: "name", valueKey: "name", required: true },
      { name: "solution_given", label: "Solution Given", type: "textarea", fullWidth: true },
      { name: "category_trends", label: "Category for Trends Chart", type: "category-select", options: [
  {value:'MEDICATION', label:'MEDICATION', color:'#ff6b6b'},
  {value:'COMMUNICATION', label:'COMMUNICATION', color:'#4ecdc4'},
  {value:'ADMIN', label:'ADMIN', color:'#45b7d1'},
  {value:'MEDICAL', label:'MEDICAL', color:'#96ceb4'},
  {value:'APPT SYSTEM', label:'APPT SYSTEM', color:'#feca57'},
  {value:'OUTSIDE AGENCIES', label:'OUTSIDE AGENCIES', color:'#ff9ff3'},
  {value:'GDPR', label:'GDPR', color:'#54a0ff'}
      ], required: true },
      { name: "people_involved", label: "Names of People Involved", type: "staff-multi-select", source: "kiosk_users", sourceLabel: "full_name", valueKey: "id" },
      { name: "avenue_used", label: "Avenue Used to Complain", type: "avenue-select", options: [
  {value:'Phone', label:'Phone'},
  {value:'Email', label:'Email'},
  {value:'Letter', label:'Letter'},
  {value:'In Person', label:'In Person'},
  {value:'Online Form', label:'Online Form'},
  {value:'Social Media', label:'Social Media'}
      ] },
      { name: "suggestions_prevent_reoccurrence", label: "Suggestions to prevent reoccurrence", type: "textarea", fullWidth: true },
      { name: "actions_to_be_taken", label: "Actions to be taken", type: "textarea", fullWidth: true },
      { name: "status", label: "Status", type: "status-select", options: [
        {value:'pending', label:'Pending', color:'#feca57'},
        {value:'investigating', label:'Investigating', color:'#ff6b6b'},
        {value:'resolved', label:'Resolved', color:'#1dd1a1'},
        {value:'closed', label:'Closed', color:'#636e72'}
      ], default: 'pending' },
      { name: "priority", label: "Priority", type: "priority-select", options: [
        {value:'low', label:'Low', color:'#1dd1a1'},
        {value:'medium', label:'Medium', color:'#feca57'},
        {value:'high', label:'High', color:'#ff6b6b'}
      ], default: 'medium' },
      { name: "share_with_team", label: "Share with team", type: "checkbox", default: false },
      { name: "created_by", label: "Created by", type: "select", source: "kiosk_users", sourceLabel: "full_name", valueKey: "id" },
    ] },
    items: { table: "items", label: "Item", pk: "id", fields: [{name:"item_id", label:"Code", type:"text", required:true}, {name:"item_name", label:"Name", type:"text", required:true}, {name:"room_id", label:"Room", type:"select", source:"rooms", sourceLabel:"name"}, {name:"default_check_type_id", label:"Default Check Type", type:"select", source:"check_types", sourceLabel:"name"}, {name:"active", label:"Active", type:"checkbox", default:true}] },
    item_allowed_types: { table: "item_allowed_types", label: "Schedule", pk: "id", fields: [{name:"item_id", label:"Item", type:"select", source:"items", sourceLabel:"item_name", required:true}, {name:"check_type_id", label:"Check Type", type:"select", source:"check_types", sourceLabel:"name", required:true}, {name:"frequency", label:"Every", type:"frequency", onchange: function(e) {
          const freq = e.target.value.toLowerCase();
          const scheduledDaySelect = document.getElementById('field-scheduled_day');
          if (!scheduledDaySelect) return;
          
          if (freq.includes('mon')) {
            // For monthly frequency, show dates 1-31
            scheduledDaySelect.innerHTML = Array.from({length: 31}, (_, i) => 
              `<option value="${i+1}">${i+1}${['st','nd','rd'][i] || 'th'}</option>`
            ).join('');
          } else {
            // For other frequencies, show days of week
            scheduledDaySelect.innerHTML = [
              {value: 'Sun', label: 'Sunday'},
              {value: 'Mon', label: 'Monday'},
              {value: 'Tue', label: 'Tuesday'},
              {value: 'Wed', label: 'Wednesday'},
              {value: 'Thu', label: 'Thursday'},
              {value: 'Fri', label: 'Friday'},
              {value: 'Sat', label: 'Saturday'}
            ].map(day => `<option value="${day.value}">${day.label}</option>`).join('');
          }
        }, required:true}, { name: "scheduled_day", label: "On", type: "select" }, {name:"required", label:"Required", type:"checkbox", default:true}] },
    submission_rows: { table: "submission_rows", label: "Submission Row", pk: "id", fields: [{name:"check_type_id", label:"Check Type", type:"select", source:"check_types", sourceLabel:"name", required:true}, {name:"row_comment", label:"Comment", type:"textarea"}] },
    pir_documents: { table: "pir_documents", label: "Inspection Document", pk: "id" }
  };

  async function openCRUD(entityKey, mode="add", row=null, context={}){
    try {
    crudError.textContent = "";
    crudState = { entity:ENTITIES[entityKey], mode, row, pk:ENTITIES[entityKey].pk, context };
    
    // Debug user context
    console.log('OpenCRUD - User Context:', { 
      ctx_user: ctx.user, 
      ctx_site_id: ctx.site_id,
      entityKey: entityKey,
      mode: mode 
    });
    // debugLog('CRUD Open', { 
    //   entity: entityKey, 
    //   mode: mode, 
    //   user: ctx.user?.id,
    //   site: ctx.site_id 
    // });
    
    if (entityKey === 'pir_documents') {
        crudTitle.textContent = `Manage: ${row.title}`;
        crudFields.innerHTML = buildPirForm(row, row.data, row.file_path);
        
        const deleteAttachmentBtn = document.getElementById('btn-delete-pir-attachment');
        if (deleteAttachmentBtn && row?.file_path) {
            deleteAttachmentBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to delete this attachment? This cannot be undone.')) return;
                try {
                    crudError.textContent = 'Deleting...';
                    const { error: deleteError } = await supabase.storage.from('pir_attachments').remove([row.file_path]);
                    if (deleteError) throw deleteError;

                    const { data: updatedRow, error: updateError } = await supabase.from('pir_documents')
                        .update({ file_path: null, status: 'Not Attached', last_updated: new Date().toISOString().slice(0,10) })
                        .eq('id', row.id)
                        .select()
                        .single();
                    
                    if (updateError) throw updateError;
                    
                    // Re-render the modal with the updated state (no file)
                    crudState.row = updatedRow;
                    openCRUD('pir_documents', 'edit', updatedRow);
                    crudError.textContent = '';

                } catch (err) {
                    crudError.textContent = `Deletion failed: ${err.message}`;
                }
            });
        }

        if(row.item_type === 'dynamic_table') {
            const container = document.getElementById('dynamic-table-container');
            const addRowBtn = document.getElementById('btn-add-table-row');
            const headers = (PIR_DEFINITIONS.find(d => d.title === row.title) || {}).headers || [];
            if (!row.data) row.data = {};
            if (!row.data.table_data) row.data.table_data = [];

            const renderTable = () => {
                let tableHtml = `<table style="font-size:12px;"><thead><tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}<th></th></tr></thead><tbody>`;
                row.data.table_data.forEach((r, idx) => {
                    tableHtml += `<tr>${headers.map((h, i) => `<td><input value="${esc(r[i] || '')}" data-row="${idx}" data-col="${i}" /></td>`).join('')}
                    <td><button type="button" class="btn-remove-row" data-index="${idx}" style="all:unset; cursor:pointer; color: var(--danger);">✕</button></td></tr>`;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            };

            addRowBtn.addEventListener('click', () => {
                row.data.table_data.push(new Array(headers.length).fill(''));
                renderTable();
            });

            container.addEventListener('input', e => {
                 if(e.target.tagName === 'INPUT') {
                    row.data.table_data[e.target.dataset.row][e.target.dataset.col] = e.target.value;
                 }
            });
             container.addEventListener('click', e => {
                 if(e.target.classList.contains('btn-remove-row')) {
                    row.data.table_data.splice(parseInt(e.target.dataset.index, 10), 1);
                    renderTable();
                 }
            });
            renderTable();
        }

    } else {
        crudTitle.textContent = (mode === "add") ? `Add ${crudState.entity.label}` : context.titlePrefix || `Edit ${crudState.entity.label}`;
        // Use a mutable copy so we can tweak fields per entity
        let _fields = Array.isArray(crudState.entity.fields) ? crudState.entity.fields.map(f=>({...f})) : [];
        // Special-case: Staff role should be a dropdown sourced from kiosk_roles (text primary key)
        if (entityKey === 'kiosk_users') {
          const idx = _fields.findIndex(f => f.name === 'role');
          if (idx !== -1) {
            _fields[idx] = { name:'role', label:'Role', type:'select', source:'kiosk_roles', sourceLabel:'role', valueKey:'role', required:true };
          } else {
            _fields.push({ name:'role', label:'Role', type:'select', source:'kiosk_roles', sourceLabel:'role', valueKey:'role', required:true });
          }
        }
        crudFields.innerHTML = `<div class="crud-grid">${_fields.map(f => {

          let val = row ? row[f.name] : (f.type === "checkbox" ? !!f.default : (f.default ?? ""));
          if(val === null || val === undefined) val = (f.type === "checkbox" ? false : "");
          
          const id = `field-${f.name}`;
          const label = (f.label || f.name);
          const fieldClass = f.fullWidth ? "field full" : "field";
          
          if(f.type === "text"){
            return `<div class="${fieldClass}"><label>${esc(label)}</label><input id="${id}" type="text" value="${esc(val)}" ${f.required ? "required" : ""} ${f.readonly ? "readonly" : ""}></div>`;
          }
          
          if(f.type === "datepicker"){
            const today = new Date().toISOString().slice(0,10);
            const dateVal = val ? new Date(val).toISOString().slice(0,10) : "";
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <div class="datepicker-wrapper">
                <input id="${id}" type="date" value="${esc(dateVal)}" ${f.required ? "required" : ""} class="modern-datepicker" />
                <button type="button" class="btn secondary quick-date" onclick="document.getElementById('${id}').value='${today}'">Today</button>
              </div>
            </div>`;
          }
          
          if(f.type === "age-selector"){
            const ageOptions = Array.from({length: 100}, (_, i) => i + 1).map(age => 
              `<option value="${age}" ${age == val ? 'selected' : ''}>${age}</option>`
            ).join('');
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <select id="${id}" class="ui-select age-select">
                <option value="">Select age...</option>
                ${ageOptions}
                <option value="100+" ${val == "100+" ? 'selected' : ''}>100+</option>
              </select>
            </div>`;
          }
          
          if(f.type === "staff-multi-select"){
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <div class="multi-select-wrapper">
                <input id="${id}" type="hidden" value="${esc(val)}" />
                <div class="staff-chips" id="${id}-chips"></div>
                <select id="${id}-selector" class="ui-select">
                  <option value="">Add staff member...</option>
                </select>
              </div>
            </div>`;
          }
          
          if(f.type === "category-select" || f.type === "status-select" || f.type === "priority-select" || f.type === "avenue-select"){
            const opts = (f.options || []).map(o => 
              `<option value="${o.value}" ${o.value == val ? "selected": ""} data-color="${o.color || ""}">${o.label}</option>`
            ).join("");
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <select id="${id}" class="ui-select ${f.type}" ${f.required ? "required" : ""}>
                ${f.required ? '' : '<option value="">Select...</option>'}
                ${opts}
              </select>
            </div>`;
          }
          
          if(f.type === "datetime"){
            let dateVal = "";
            let timeVal = "";
            try{
              if(val){ const d = new Date(val); dateVal = d.toISOString().slice(0,10); timeVal = d.toISOString().slice(11,16); }
            }catch(e){}
            return `<div class="${fieldClass}"><label>${esc(label)}</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="${id}-date" type="date" value="${esc(dateVal)}" ${f.required ? "required" : ""} />
                <input id="${id}-time" type="time" value="${esc(timeVal)}" ${f.required ? "required" : ""} />
                <button type="button" class="btn secondary" id="${id}-now" style="padding:6px 8px;">Now</button>
              </div>
            </div>`;
          }
          
          if(f.type === "textarea"){
            return `<div class="${fieldClass}"><label>${esc(label)}</label><textarea id="${id}" rows="3" ${f.required ? "required" : ""}>${esc(val)}</textarea></div>`;
          }
          
          if(f.type === "checkbox"){
            return `<div class="${fieldClass}"><label style="display:flex; gap:8px; align-items:center;"><input id="${id}" type="checkbox" ${val ? "checked" : ""}> ${esc(label)}</label></div>`;
          }
          
          if(f.type === "select"){
            if(f.options){
              const opts = (f.options || []).map(o => `<option value="${o.value}"${o.value == val ? " selected": ""}>${o.label}</option>`).join("");
              return `<div class="${fieldClass}"><label>${esc(label)}</label><select id="${id}" class="ui-select">${opts}</select></div>`;
            }else{
              return `<div class="${fieldClass}"><label>${esc(label)}</label><select id="${id}" class="ui-select"><option value="">Loading...</option></select></div>`;
            }
          }
          
          if(f.type === "frequency"){
            setTimeout(() => {
              const freq = String(val || '1 month').toLowerCase();
              const scheduledDaySelect = document.getElementById('field-scheduled_day');
              if (!scheduledDaySelect) return;
              
              if (freq.includes('mon')) {
                scheduledDaySelect.innerHTML = Array.from({length: 31}, (_, i) => 
                  `<option value="${i+1}">${i+1}${['st','nd','rd'][i] || 'th'}</option>`
                ).join('');
              } else {
                scheduledDaySelect.innerHTML = [
                  {value: 'Sun', label: 'Sunday'},
                  {value: 'Mon', label: 'Monday'},
                  {value: 'Tue', label: 'Tuesday'},
                  {value: 'Wed', label: 'Wednesday'},
                  {value: 'Thu', label: 'Thursday'},
                  {value: 'Fri', label: 'Friday'},
                  {value: 'Sat', label: 'Saturday'}
                ].map(day => `<option value="${day.value}">${day.label}</option>`).join('');
              }
            }, 0);
            let num = 1, unit = "day";
            if(typeof val === "string" && val){
              const m = val.match(/(\d+)\s*(year|mon|week|day)/i);
              if(m){ num = m[1]; unit = m[2].toLowerCase(); }
            }
            const units = [
              {v:"day",  n:"day(s)"},
              {v:"week", n:"week(s)"},
              {v:"mon",  n:"month(s)"},
              {v:"year", n:"year(s)"}
            ];
            const unitOpts = units.map(u => `<option value="${u.v}"${u.v===unit?" selected":""}>${u.n}</option>`).join("");
            return `<div class="${fieldClass}"><label>${esc(label || "Every")}</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="${id}-n" type="number" min="1" value="${num}" style="width:110px">
                <select id="${id}-u">${unitOpts}</select>
              </div>
            </div>`;
          }
          
          if(f.type === "file-upload"){
            return `<div class="${fieldClass}" style="border: 1px dashed #ccc; padding: 15px; border-radius: 8px; background: #f9f9f9;">
              <label style="font-weight: bold; margin-bottom: 10px; display: block;">${esc(label)}</label>
              <div class="file-upload-area" style="text-align: center;">
                <input id="${id}" type="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt" style="display: none;" />
                <button type="button" class="btn secondary" onclick="document.getElementById('${id}').click()" style="margin-bottom: 10px;">
                  <span>📎 Choose File</span>
                </button>
                <div id="${id}-status" style="font-size: 12px; color: #666; margin-top: 5px;">No file selected</div>
                <div id="${id}-progress" style="display: none; margin-top: 10px;">
                  <div style="background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                    <div id="${id}-progress-bar" style="background: #4CAF50; height: 20px; width: 0%; transition: width 0.3s;"></div>
                  </div>
                  <div id="${id}-progress-text" style="font-size: 12px; margin-top: 5px;">Uploading...</div>
                </div>
              </div>
              <div class="ai-helper" style="margin-top:.5rem; display:flex; gap:.5rem; align-items:center; justify-content:center;">
                <button type="button" id="ai-populate-btn-${id}" class="ai-populate-btn btn btn-secondary" style="padding:.4rem .7rem; font-size:.9rem;">
                  Optional: Populate with AI
                </button>
                <span id="ai-status-${id}" style="font-size:.85rem; opacity:.8;"></span>
              </div>
            </div>`;
          }
          
          return `<div class="${fieldClass}"><label>${esc(label)}</label><input id="${id}" type="text" value="${esc(val)}"></div>`;

        }).join("")}</div>`;

// Ensure Staff Role dropdown is populated even if not declared in entity schema
if (entityKey === 'kiosk_users') {
  (async ()=>{
    const sel = document.getElementById('field-role');
    if (sel && sel.tagName.toLowerCase()==='select') {
      // Roles are fixed to Admin and Staff
      const options = [ {v:'admin', l:'Admin'}, {v:'staff', l:'Staff'} ];
      const selected = (crudState.row || {}).role || '';
      sel.innerHTML = `<option value="">—</option>` + options.map(o => {
        const s = (String(o.v) === String(selected)) ? ' selected' : '';
        return `<option value="${o.v}"${s}>${o.l}</option>`;
      }).join('');
    }
  })();
}

        
// Populate dynamic select sources
(async () => {
  
for (const f of (crudState.entity.fields || [])) {
    if (f.type === "select" && f.source && !f.options) {
      const sel = document.getElementById('field-' + f.name);
      if (!sel) continue;
      try {
        const selectCols = (f.valueKey || "id") + ", " + (f.sourceLabel || "full_name");
        let q = supabase.from(f.source).select(selectCols);
  const siteScoped = ["rooms","check_types","items","kiosk_users","item_allowed_types"];
        if (typeof ctx !== "undefined" && ctx.site_id && siteScoped.includes(f.source)) {
          q = q.eq("site_id", ctx.site_id);
        }
        const { data, error } = await q;
        if (!error && Array.isArray(data)) {
          // Exclude self when choosing a manager
          let list = data;
          if (f.name === "reports_to_id" && crudState?.row?.id) {
            const idKey = f.valueKey || "id";
            list = data.filter(r => String(r[idKey]) !== String(crudState.row.id));
          }
          const selected = (crudState.row || {})[f.name];
          sel.innerHTML = `<option value="">—</option>` + list.map(r => {
            const optVal = r[f.valueKey || "id"];
            const optLab = r[f.sourceLabel || "full_name"];
            const selAttr = (String(optVal) === String(selected)) ? " selected" : "";
            return '<option value="' + optVal + '"' + selAttr + '>' + esc(optLab) + '</option>';
          }).join("");
          // Defensive: if this is the created_by field and selected option looks non-UUID, prefer current user id
          if(f.name === 'created_by'){
            const chosen = sel.value;
            if(chosen && !isUUID(chosen) && ctx.user && ctx.user.id){
              sel.value = ctx.user.id;
            }
          }
        } else {
          sel.innerHTML = '<option value="">(error)</option>';
        }
      } catch (err) {
        console.warn('Select loader error for', f.name, err);
        sel.innerHTML = '<option value="">(error)</option>';
      }
    }
  }
})();;

  // Initialize enhanced form elements for complaints
  if (entityKey === 'complaints') {
    // Setup file upload handler
    const fileInput = document.getElementById('field-attachment');
    if (fileInput) {
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const statusDiv = document.getElementById('field-attachment-status');
        const progressDiv = document.getElementById('field-attachment-progress');
        const progressBar = document.getElementById('field-attachment-progress-bar');
        const progressText = document.getElementById('field-attachment-progress-text');
        
        if (!file) {
          statusDiv.textContent = 'No file selected';
          statusDiv.style.color = '#666';
          return;
        }
        
        // Validate file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
          statusDiv.textContent = 'File too large. Maximum size is 10MB.';
          statusDiv.style.color = '#e74c3c';
          return;
        }
        
        try {
          progressDiv.style.display = 'block';
          statusDiv.style.color = '#666';
          statusDiv.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
          
          // Store file for later upload when form is submitted
          crudState.pendingAttachment = {
            file: file,
            fileName: file.name,
            fileSize: file.size,
            fileType: file.type
          };
          
          progressBar.style.width = '100%';
          progressText.textContent = 'Ready to upload when complaint is saved';
          
          setTimeout(() => {
            progressDiv.style.display = 'none';
          }, 2000);
          
        } catch (error) {
          console.error('File selection error:', error);
          statusDiv.textContent = 'Error selecting file';
          statusDiv.style.color = '#e74c3c';
          progressDiv.style.display = 'none';
        }
      });
    }
    
    // Setup staff multi-select
    setTimeout(() => {
      const staffMultiSelect = document.getElementById('field-people_involved-selector');
      const staffChips = document.getElementById('field-people_involved-chips');
      const hiddenInput = document.getElementById('field-people_involved');
      
      if (staffMultiSelect && staffChips && hiddenInput) {
        // Load staff members into the selector
        supabase.from('master_users').select('id, full_name').eq('site_id', ctx.site_id).then(({data, error}) => {
          if (data && !error) {
            staffMultiSelect.innerHTML = '<option value="">Add staff member...</option>' + 
              data.map(s => `<option value="${s.id}">${s.full_name}</option>`).join('');
          }
        });
        
        // Handle staff selection
        staffMultiSelect.addEventListener('change', (e) => {
          if (e.target.value) {
            const staffId = e.target.value;
            const staffName = e.target.selectedOptions[0].text;
            const currentIds = hiddenInput.value ? hiddenInput.value.split(',') : [];
            
            if (!currentIds.includes(staffId)) {
              currentIds.push(staffId);
              hiddenInput.value = currentIds.join(',');
              
              const chip = document.createElement('div');
              chip.className = 'staff-chip';
              chip.innerHTML = `${staffName} <button type="button" onclick="this.parentElement.remove(); updateStaffIds()">×</button>`;
              staffChips.appendChild(chip);
            }
            e.target.value = '';
          }
        });
        
        // Function to update hidden input when chips are removed
        window.updateStaffIds = function() {
          const chips = staffChips.querySelectorAll('.staff-chip');
          const ids = Array.from(chips).map(chip => {
            const text = chip.textContent.replace('×', '').trim();
            const option = Array.from(staffMultiSelect.options).find(opt => opt.text === text);
            return option ? option.value : null;
          }).filter(id => id);
          hiddenInput.value = ids.join(',');
        };
        
        // Load existing selections
        if (hiddenInput.value) {
          const existingIds = hiddenInput.value.split(',');
          existingIds.forEach(id => {
            const option = Array.from(staffMultiSelect.options).find(opt => opt.value === id);
            if (option) {
              const chip = document.createElement('div');
              chip.className = 'staff-chip';
              chip.innerHTML = `${option.text} <button type="button" onclick="this.parentElement.remove(); updateStaffIds()">×</button>`;
              staffChips.appendChild(chip);
            }
          });
        }
      }
    }, 100);
  }

  // Attach 'Now' handlers for datetime fields (fill date and time with current values)
  (function attachNowButtons(){
    (crudState.entity.fields || []).forEach(f=>{
      if(f.type === 'datetime'){
        const btn = document.getElementById(`field-${f.name}-now`);
        if(!btn) return;
        btn.addEventListener('click', ()=>{
          const d = new Date();
          const dateEl = document.getElementById(`field-${f.name}-date`);
          const timeEl = document.getElementById(`field-${f.name}-time`);
          if(dateEl) dateEl.value = d.toISOString().slice(0,10);
          if(timeEl) timeEl.value = d.toISOString().slice(11,16);
        });
      }
    });
  })();

    }

    const downloadBtn = document.getElementById('btn-download-pir');
    if (downloadBtn && row?.file_path) {
        downloadBtn.addEventListener('click', async () => {
            const { data, error } = await supabase.storage.from('pir_attachments').download(row.file_path);
            if (error) { crudError.textContent = `Download failed: ${error.message}`; return; }
            const url = URL.createObjectURL(data);
            const a = document.createElement('a');
            a.href = url;
            a.download = row.file_path.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    }

    // Add preview button handler
    const previewBtn = document.getElementById('btn-preview-pir');
    if (previewBtn && row?.file_path) {
        previewBtn.addEventListener('click', async () => {
            const { data, error } = await supabase.storage.from('pir_attachments').download(row.file_path);
            if (error) { 
                crudError.textContent = `Preview failed: ${error.message}`; 
                return; 
            }
            
            const fileName = row.file_path.split('/').pop().toLowerCase();
            const fileUrl = URL.createObjectURL(data);
            
            if (fileName.endsWith('.pdf')) {
                // Show PDF in modal preview
                showPdfPreview(fileUrl, fileName);
            } else if (fileName.match(/\.(docx?|xlsx?|pptx?)$/)) {
                // Show document metadata
                showDocumentMetadata(fileName, data.size);
            } else {
                // For other files, just download them
                const a = document.createElement('a');
                a.href = fileUrl;
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        });
    }

    crudDeleteBtn.style.display = (mode === "edit" && entityKey !== 'pir_documents') ? "inline-block" : "none";
    
    console.log('Before adding show class:', {
      crudModal: crudModal,
      classList: crudModal.classList.toString(),
      display: window.getComputedStyle(crudModal).display
    });
    
    crudModal.classList.add("show");
    
    console.log('After adding show class:', {
      classList: crudModal.classList.toString(),
      display: window.getComputedStyle(crudModal).display
    });
    } catch (error) {
      console.error('Error in openCRUD:', error);
      console.error('Stack trace:', error.stack);
      alert('Failed to open edit modal: ' + error.message);
    }
  }

  function closeCRUD(){ crudModal.classList.remove("show"); }

  crudCancelBtn.addEventListener("click", closeCRUD);
  // Disable closing the CRUD modal by clicking the backdrop to prevent accidental closure.
  // Keep the Cancel button behavior intact.
  // Previously: close on backdrop click. That behavior is now disabled.
  // crudModal.addEventListener("click", (e)=>{ if(e.target === crudModal) closeCRUD(); });

  crudForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    crudError.textContent = "";
    const entity = crudState.entity;
    let body = {};
    
    if(entity.table === 'pir_documents') {
        const item = crudState.row;
        body.last_updated = document.getElementById('field-pir-last_updated').value || null;
        
        let jsonData = item.data || {};
        let hasData = false;

        // Certificate tracking fields
        const certificateDate = document.getElementById('field-pir-certificate_date')?.value || null;
        const expiryPeriod = document.getElementById('field-pir-expiry_date')?.value || null;
        const reviewDaysBefore = document.getElementById('field-pir-review_days_before')?.value || null;
        
        if (certificateDate) jsonData.certificate_date = certificateDate;
        
        // Calculate expiry date from certificate date and selected period
        if (certificateDate && expiryPeriod) {
          const certDate = new Date(certificateDate);
          let expiryDate = null;
          
          switch(expiryPeriod) {
            case '1-month':
              expiryDate = new Date(certDate.getFullYear(), certDate.getMonth() + 1, certDate.getDate());
              break;
            case '3-months':
              expiryDate = new Date(certDate.getFullYear(), certDate.getMonth() + 3, certDate.getDate());
              break;
            case '6-months':
              expiryDate = new Date(certDate.getFullYear(), certDate.getMonth() + 6, certDate.getDate());
              break;
            case '1-year':
              expiryDate = new Date(certDate.getFullYear() + 1, certDate.getMonth(), certDate.getDate());
              break;
            case '2-years':
              expiryDate = new Date(certDate.getFullYear() + 2, certDate.getMonth(), certDate.getDate());
              break;
            case '3-years':
              expiryDate = new Date(certDate.getFullYear() + 3, certDate.getMonth(), certDate.getDate());
              break;
            case '5-years':
              expiryDate = new Date(certDate.getFullYear() + 5, certDate.getMonth(), certDate.getDate());
              break;
            case 'no-expiry':
              expiryDate = null;
              break;
          }
          
          if (expiryDate) {
            jsonData.expiry_date = expiryDate.toISOString().split('T')[0];
          }
          jsonData.expiry_period = expiryPeriod;
        }
        
        if (reviewDaysBefore) jsonData.review_days_before = parseInt(reviewDaysBefore);

        if (item.item_type.includes('textarea')) {
            const val = document.getElementById('field-pir-text_content')?.value || null;
            jsonData.text_content = val;
            if(val) hasData = true;
        }
        if (item.item_type.includes('questions')) {
            jsonData.answers = Array.from(crudFields.querySelectorAll('textarea[data-question-index]')).map(el => el.value);
            if(jsonData.answers.some(a => a)) hasData = true;
        }
        if (item.item_type.includes('number') || item.item_type.includes('dual') || item.item_type.includes('triple')) {
            jsonData.num1 = document.getElementById('field-pir-num1')?.value || null;
            jsonData.num2 = document.getElementById('field-pir-num2')?.value || null;
            jsonData.num3 = document.getElementById('field-pir-num3')?.value || null;
            if(jsonData.num1 || jsonData.num2 || jsonData.num3) hasData = true;
        }
        if (item.item_type.includes('text')) { // dual_text
            jsonData.text1 = document.getElementById('field-pir-text1')?.value || null;
            jsonData.text2 = document.getElementById('field-pir-text2')?.value || null;
            if(jsonData.text1 || jsonData.text2) hasData = true;
        }
        if (item.item_type === 'dynamic_table') {
            jsonData.table_data = item.data.table_data;
            if(jsonData.table_data?.length > 0) hasData = true;
        }
        
        body.data = jsonData;

        const fileInput = document.getElementById('field-pir-file_path');
        let hasFile = !!item.file_path;
        if (fileInput && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const filePath = `${ctx.site_id}/${item.id}/${file.name.replace(/[^a-zA-Z0-9.\-_]/g, '_')}`;
            const { error: uploadError } = await supabase.storage.from('pir_attachments').upload(filePath, file, { upsert: true });
            if (uploadError) throw uploadError;
            body.file_path = filePath;
            hasFile = true;
        }

        // Enhanced status logic with certificate expiry awareness
        if (hasFile || hasData) {
            // Check if certificate is expired or expiring soon
            if (expiryDate) {
                const expiry = new Date(expiryDate);
                const now = new Date();
                const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
                
                if (daysUntilExpiry < 0) {
                    body.status = 'Expired';
                } else if (reviewDaysBefore && daysUntilExpiry <= parseInt(reviewDaysBefore)) {
                    body.status = 'Expiring Soon';
                } else {
                    body.status = 'Ready';
                }
            } else {
                body.status = 'Ready';
            }
        } else {
            body.status = item.item_type.includes('file') ? 'Not Attached' : 'Not Started';
        }

    } else { // Standard entity logic...
        
for (const f of (crudState.entity.fields || [])) {
  // Skip special fields that are handled separately
  if (f.type === "file-upload") continue;
  
  let val;
  if (f.type === "checkbox") {
    val = document.getElementById(`field-${f.name}`).checked;
  } else if (f.type === "select") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "frequency") {
    const n = document.getElementById(`field-${f.name}-n`).value || "1";
    const u = document.getElementById(`field-${f.name}-u`).value || "day";
    val = `${n} ${u}`;
  } else if (f.type === "datetime") {
    // read date + time inputs and combine to ISO
    const dateEl = document.getElementById(`field-${f.name}-date`);
    const timeEl = document.getElementById(`field-${f.name}-time`);
    const nowBtn = document.getElementById(`field-${f.name}-now`);
    let d = dateEl ? dateEl.value : null;
    let t = timeEl ? timeEl.value : null;
    if(!d && !t){ val = null; }
    else {
      // If only date provided, treat time as 00:00; if only time, use today
      if(!d) d = new Date().toISOString().slice(0,10);
      if(!t) t = '00:00';
      const combined = `${d}T${t}:00`;
      const dt = new Date(combined);
      val = isNaN(dt.getTime()) ? null : dt.toISOString();
    }
  } else if (f.type === "age-selector") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
    else val = parseInt(val);
  } else if (f.type === "staff-multi-select") {
    const checkboxes = document.querySelectorAll(`input[name="field-${f.name}"]:checked`);
    val = Array.from(checkboxes).map(cb => cb.value).join(',');
    if (val === "") val = null;
  } else if (f.type === "category-select" || f.type === "status-select" || f.type === "priority-select" || f.type === "avenue-select") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "datepicker") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "textarea") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  }
  body[f.name] = val;
}

    }

    if(ctx.site_id) body.site_id = ctx.site_id;

    // Auto-generate complaint number for new complaints
    if(crudState.mode === "add" && entity.table === "complaints") {
      if(!body.complaint_number) {
        // Get current count of complaints for this site to generate next number
        try {
          const { count } = await supabase
            .from("complaints")
            .select("id", { count: "exact", head: true })
            .eq("site_id", ctx.site_id);
          const nextNum = (count || 0) + 1;
          body.complaint_number = `C${String(nextNum).padStart(4, '0')}`;
        } catch (err) {
          console.warn('Failed to generate complaint number:', err);
          body.complaint_number = `C${Date.now()}`; // fallback
        }
      }
    }

    // Defensive coercion: ensure created_by is a UUID (kiosk_users.id). If not, use current auth user id when available.
    if(body.created_by && !isUUID(body.created_by)){
      if(ctx.user && ctx.user.id){
        console.log('Coercing created_by from', body.created_by, 'to', ctx.user.id);
        body.created_by = ctx.user.id;
      } else {
        // remove invalid value to avoid DB error
        console.log('Removing invalid created_by value:', body.created_by);
        delete body.created_by;
      }
    }
    
    // For complaints, ensure created_by is set if missing
    if(entity.table === 'complaints' && !body.created_by && ctx.user?.id) {
      console.log('Setting created_by to current user:', ctx.user.id);
      body.created_by = ctx.user.id;
    }

    // Basic validation: ensure UUID fields expected by the DB contain valid UUIDs
    // Use the already-coerced value in `body` (post processing). Accept numeric kiosk_user ids
    // (the master_users table uses integer PKs) as valid choices.
    const uuidChecks = [];
    (crudState.entity.fields || []).forEach(f => {
      if (f.name === 'created_by') {
        const candidate = body.created_by;
        if (candidate) {
          // If it looks like a UUID (contains hyphens), require isUUID
          if (String(candidate).includes('-')) {
            if (!isUUID(candidate)) uuidChecks.push({ field: f.name, value: candidate });
          } else {
            // Not a UUID: allow numeric IDs (integers) or fallback to current user
            // Accept values that are all digits
            if (!/^\d+$/.test(String(candidate))) {
              // not a pure integer -> invalid
              uuidChecks.push({ field: f.name, value: candidate });
            }
          }
        }
      }
    });
    if (uuidChecks.length) {
      crudError.textContent = `Please choose valid options for: ${uuidChecks.map(c=>c.field).join(', ')}.`;
      return;
    }

    // Defensive: ensure complaints.datetime (DB NOT NULL) is set. Prefer complaint_date if provided.
    if (entity.table === 'complaints') {
      if (!body.datetime) {
        if (body.complaint_date) {
          // If complaint_date is just a date (YYYY-MM-DD), convert to ISO timestamp at midnight UTC
          try {
            const d = new Date(body.complaint_date);
            if (!isNaN(d.getTime())) body.datetime = d.toISOString();
            else body.datetime = new Date().toISOString();
          } catch (e) {
            body.datetime = new Date().toISOString();
          }
        } else {
          body.datetime = new Date().toISOString();
        }
      }
    }

    try{
      let complaintId = null;
      
      // Debug logging before database operations
      console.log('About to save to database:', {
        mode: crudState.mode,
        table: entity.table,
        body: body,
        context: { 
          site_id: ctx.site_id, 
          user_id: ctx.user?.id,
          pendingAttachment: !!crudState.pendingAttachment 
        }
      });
      
      debugLog('Form Submit', {
        mode: crudState.mode,
        table: entity.table,
        hasAttachment: !!crudState.pendingAttachment,
        bodyKeys: Object.keys(body),
        created_by: body.created_by,
        site_id: body.site_id
      });
      
      if(crudState.mode === "add"){
        const { data, error } = await supabase.from(entity.table).insert(body).select('id').single(); 
        if(error) {
          console.error('Database insert error:', error);
          debugLog('Insert Error', error);
          throw error;
        }
        complaintId = data?.id;
        console.log('Successfully inserted with ID:', complaintId);
      }else{
        const pk = crudState.pk || "id";
        const idv = crudState.row?.[pk];
        if(!idv){ throw new Error("Missing primary key for update."); }
        const { error } = await supabase.from(entity.table).update(body).eq(pk, idv); 
        if(error) throw error;
        complaintId = idv;
      }
      
      // Handle file attachment upload for complaints
      if(entity.table === "complaints" && crudState.pendingAttachment && complaintId) {
        const file = crudState.pendingAttachment.file;
        const fileName = crudState.pendingAttachment.fileName;
        const fileType = crudState.pendingAttachment.fileType;
        const fileSize = crudState.pendingAttachment.fileSize;
        
        try {
          // Sanitize filename
          const safeName = String(fileName).replace(/[^a-zA-Z0-9.\-_]/g, '_');
          const storagePath = `complaints/${ctx.site_id}/${complaintId}/${safeName}`;

          console.log('Uploading attachment to storagePath:', storagePath, { fileType, fileSize });

          // Upload file to Supabase Storage
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('pir_attachments')
            .upload(storagePath, file, { upsert: true, contentType: fileType });

          console.log('uploadData:', uploadData, 'uploadError:', uploadError);

          if (uploadError) {
            console.error('Supabase upload error object:', uploadError);
            throw uploadError;
          }

          // Create signed URL for private storage (1 hour expiry)
          let signedUrl = null;
          try {
            const { data: signed, error: signedErr } = await supabase.storage
                .from('pir_attachments')
                .createSignedUrl(storagePath, 3600);
            console.log('createSignedUrl result:', signed, 'err:', signedErr);
            if (!signedErr && signed && signed.signedUrl) {
                signedUrl = signed.signedUrl;
            } else if (signedErr) {
                console.error('Error creating signed URL:', signedErr);
            }
          } catch (e) {
            console.warn('createSignedUrl threw:', e);
          }

          // Save attachment record in complaint_attachments table
          const attachmentRecord = {
            complaint_id: complaintId,
            file_name: safeName,
            file_url: signedUrl || storagePath, // fallback to storage path if no signed URL
            file_type: fileType,
            file_size: fileSize,
            attachment_type: 'original',
            uploaded_at: new Date().toISOString()
          };
          
          console.log('Inserting attachment record:', attachmentRecord);
          debugLog('Attachment Insert', { 
            record: attachmentRecord, 
            hasSignedUrl: !!signedUrl,
            storagePath: storagePath 
          });
          
          const { data: attachData, error: attachmentError } = await supabase.from('complaint_attachments').insert(attachmentRecord).select().single();

          console.log('attachment insert result:', { attachData, attachmentError });

          if (attachmentError) throw attachmentError;

          // Clear pending attachment
          crudState.pendingAttachment = null;

        } catch (attachmentErr) {
          console.error('Attachment upload error:', attachmentErr);
          console.error('Full error details:', JSON.stringify(attachmentErr, null, 2));
          
          // Add specific debugging for common RLS/policy issues
          if (attachmentErr.code === '42501') {
            console.error('RLS Policy Error: Check that complaint_attachments table has proper insert policies');
          } else if (attachmentErr.code === '23505') {
            console.error('Unique constraint violation in complaint_attachments');
          } else if (attachmentErr.message && attachmentErr.message.includes('policy')) {
            console.error('Policy violation detected:', attachmentErr.message);
          }
          
          debugLog('Attachment Error', {
            error: attachmentErr,
            complaintId: complaintId,
            fileName: fileName,
            fileSize: fileSize,
            storagePath: typeof storagePath !== 'undefined' ? storagePath : 'undefined'
          });
          
          // Don't fail the entire form submission if attachment fails
          try {
            const errMsg = attachmentErr && attachmentErr.message ? attachmentErr.message : JSON.stringify(attachmentErr);
            crudError.textContent = `Complaint saved, but attachment failed to upload: ${errMsg}`;
          } catch (e) {
            crudError.textContent = `Complaint saved, but attachment failed to upload. Check console for details.`;
          }
          setTimeout(() => { crudError.textContent = ""; closeCRUD(); }, 8000);
          return;
        }
      }
      
      closeCRUD();
      if (entity.table === 'pir_documents') loadAndRenderPIR();
      else await Promise.all([loadCounts(), loadItems(), loadRooms(), loadComplaints(), loadCheckTypes(), loadSchedules(), loadStaff()]);
    } catch(err) {
      crudError.textContent = err.message || String(err);
    }
  });

  crudDeleteBtn.addEventListener("click", async ()=>{
    
for (const f of (crudState.entity.fields || [])) {
  let val;
  if (f.type === "checkbox") {
    val = document.getElementById(`field-${f.name}`).checked;
  } else if (f.type === "select") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "frequency") {
    const n = document.getElementById(`field-${f.name}-n`).value || "1";
    const u = document.getElementById(`field-${f.name}-u`).value || "day";
    val = `${n} ${u}`;
  } else {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  }
  body[f.name] = val;
}

  });

  // ... (All remaining event listeners and functions are unchanged)
  document.getElementById("btn-new-room")?.addEventListener("click", ()=>openCRUD("rooms","add"));
  document.getElementById("btn-new-complaint")?.addEventListener("click", ()=>openCRUD("complaints","add"));
  document.getElementById("btn-new-ct")?.addEventListener("click", ()=>openCRUD("check_types","add"));
  // 'Add Staff' button removed from DOM; leave creation via staff modal or invite flow
  document.getElementById("btn-new-item")?.addEventListener("click", ()=>openCRUD("items","add"));
  document.getElementById("btn-new-sched")?.addEventListener("click", ()=>openCRUD("item_allowed_types","add"));
  
  // Complaints export functionality
  document.getElementById("complaints-export")?.addEventListener("click", async () => {
    try {
      const { data, error } = await supabase
        .from("complaints")
        .select("*")
        .eq("site_id", ctx.site_id)
        .order("datetime", { ascending: false });
        
      if (error) throw error;
      
      if (!data || data.length === 0) {
        alert('No complaints data to export');
        return;
      }
      
      // Format data for Excel export
      const exportData = data.map(complaint => ({
        'Date/Time': complaint.datetime ? new Date(complaint.datetime).toLocaleString() : '',
        'Patient Initials': complaint.patient_initials || '',
        'Category': complaint.category || '',
        'Original Complaint': complaint.original_complaint || '',
        'Response': complaint.response || '',
        'Lessons Learned': complaint.lessons_learned || '',
        'Status': complaint.status || '',
        'Priority': complaint.priority || '',
        'Share with Team': complaint.share_with_team ? 'Yes' : 'No',
        'Resolved Date': complaint.resolved_at ? new Date(complaint.resolved_at).toLocaleString() : '',
        'Created': complaint.created_at ? new Date(complaint.created_at).toLocaleString() : ''
      }));
      
      // Create enhanced Excel-compatible export with better formatting
      const enhancedData = [
        {
          'Date/Time': `COMPLAINTS EXPORT - ${new Date().toLocaleDateString()}`,
          'Patient Initials': '',
          'Category': `Total Records: ${data.length}`,
          'Original Complaint': `Resolved: ${data.filter(c => c.status === 'resolved').length}`,
          'Response': `Open: ${data.filter(c => c.status !== 'resolved').length}`,
          'Lessons Learned': '',
          'Status': '',
          'Priority': '',
          'Share with Team': '',
          'Resolved Date': '',
          'Created': ''
        },
        ...exportData
      ];
      
      downloadCSV(enhancedData, `complaints-export-${new Date().toISOString().split('T')[0]}.csv`);
    } catch (err) {
      console.error('Export failed:', err);
      alert('Export failed: ' + (err.message || err));
    }
  });
  
  // Complaints filter event listeners - auto-apply on change
  document.getElementById('complaints-filter-category')?.addEventListener('change', () => {
    if (document.getElementById('view-complaints-reporting').classList.contains('active')) {
      loadComplaints();
    }
  });
  
  document.getElementById('complaints-filter-status')?.addEventListener('change', () => {
    if (document.getElementById('view-complaints-reporting').classList.contains('active')) {
      loadComplaints();
    }
  });
  
  document.getElementById('complaints-search')?.addEventListener('input', () => {
    if (document.getElementById('view-complaints-reporting').classList.contains('active')) {
      loadComplaints();
    }
  });

  document.getElementById('app').addEventListener('click', async (e) => {
    const tr = e.target.closest("tr[data-id]");
    if (!tr) return;
    const tbody = tr.closest("tbody");
    if(!tbody) return;
    if(tbody.id === 'subs-tbody') { showSubmissionDetails(tr.dataset.id); return; }
    const entityKey = tbody.dataset.entity;
    if (entityKey && ENTITIES[entityKey]) {
      const rowId = tr.dataset.id;
      tbody.querySelectorAll("tr.selected").forEach(r => r.classList.remove("selected"));
      tr.classList.add("selected");
      try {
        const { data: rowData, error } = await supabase.from(ENTITIES[entityKey].table).select("*").eq(ENTITIES[entityKey].pk, rowId).maybeSingle();
        if (error) throw error;
        if (rowData) openCRUD(entityKey, "edit", rowData);
      } catch (err) { console.error("Error fetching row for editing:", err); }
    }
  });

  const itemsHead = document.querySelector('#view-items thead');
  if(itemsHead){ itemsHead.addEventListener('click', (e)=>{ const th = e.target.closest('th.sortable'); if(!th) return; const col = th.getAttribute('data-col'); if(itemsSort.col === col){ itemsSort.dir = itemsSort.dir === 'asc' ? 'desc' : 'asc'; }else{ itemsSort.col = col; itemsSort.dir = 'asc'; } loadItems(); }); }
  function activeViewId(){ const v = document.querySelector('section.view.active'); return v ? v.id : ''; }
  document.getElementById('search').addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && activeViewId() === 'view-items'){ e.preventDefault(); itemsQuery = e.target.value.trim(); loadItems(); } });
  document.getElementById("cal-prev")?.addEventListener("click", ()=>{ calendarDate.setMonth(calendarDate.getMonth() - 1); loadAndRenderCalendar(); });
  document.getElementById("cal-next")?.addEventListener("click", ()=>{ calendarDate.setMonth(calendarDate.getMonth() + 1); loadAndRenderCalendar(); });
  document.getElementById("cal-view-switcher")?.addEventListener("click", (e) => { const btn = e.target.closest("button[data-view]"); if (!btn) return; document.querySelectorAll("#cal-view-switcher button").forEach(b => b.classList.remove("active")); btn.classList.add("active"); currentCalendarView = btn.dataset.view; if (currentCalendarView === 'daily') calendarDate = new Date(); loadAndRenderCalendar(); });
  
  const submissionDetailModal = document.getElementById("submission-detail-modal");
  async function showSubmissionDetails(submissionId) {
    submissionDetailModal.classList.add("show");
    submissionDetailModal.dataset.submissionId = submissionId;
    document.getElementById("submission-detail-content").innerHTML = `<div class="muted" style="padding:20px 0; text-align:center;">Loading details...</div>`;
    document.getElementById("submission-detail-title").textContent = `Details for Submission #${submissionId}`;
    console.log('DEBUG showSubmissionDetails: Fetching submission details for ID:', submissionId);
    
    // Get submission rows with all fields
    const { data: rows, error } = await supabase.from('submission_rows').select(`
      id, row_comment, item_id, check_type, check_value, check_type_id, item_pk
    `).eq('submission_id', submissionId);
    
    console.log('DEBUG showSubmissionDetails: Query result:', { rows, error });
    if (error) {
      console.error('Error fetching submission details:', error);
      document.getElementById("submission-detail-content").innerHTML = `<div class="muted" style="padding:20px 0; text-align:center; color:red;">Error loading details: ${error.message}</div>`;
      return;
    }
    if (!rows || rows.length === 0) {
      console.log('DEBUG showSubmissionDetails: No rows found');
      document.getElementById("submission-detail-content").innerHTML = `<div class="muted" style="padding:20px 0; text-align:center;">No items found for this submission.</div>`;
      return;
    }

    // Build the table with the data we have
    let contentHtml = `<div class="table-wrap" style="max-height: 60vh;"><table><thead><tr><th>Item ID</th><th>Check Performed</th><th>Result</th><th>Comment</th></tr></thead><tbody data-entity="submission_rows">`;
    contentHtml += rows.map(r => `<tr data-id="${r.id}">
      <td>${esc(r.item_id || 'Unknown')}</td>
      <td>${esc(r.check_type || 'Unknown Check')}</td>
      <td>${esc(r.check_value || 'Done')}</td>
      <td>${esc(r.row_comment || '-')}</td>
    </tr>`).join('');
    contentHtml += `</tbody></table></div>`;
    console.log('DEBUG showSubmissionDetails: Generated HTML:', contentHtml);
    document.getElementById("submission-detail-content").innerHTML = contentHtml;
  }
  submissionDetailModal.addEventListener("click", (e) => { if (e.target === submissionDetailModal || e.target.closest("#submission-detail-close")) { submissionDetailModal.classList.remove("show"); } });

  // === TRAINING FUNCTIONALITY ===
  // Use var + guard so early calls to loadTrainingMatrix (before this point) don't hit TDZ errors.
  // In previous version this block appeared earlier; moving lots of code pushed it below first invocations.
  // Error observed: "Cannot access uninitialized variable" when loadTrainingMatrix ran before let decls.
  // Switching to var with existing-value guard preserves state if already created earlier.
  // Enhanced Training Matrix with all quick win features - make globally accessible
  window.trainingData = typeof window.trainingData !== 'undefined' ? window.trainingData : {
    staff: [],
    types: [],
    records: [],
    isDataLoaded: false,  // Explicitly mark as not loaded yet
    isDemoData: false
  };
  window.currentTrainingTab = typeof window.currentTrainingTab !== 'undefined' ? window.currentTrainingTab : 'clinical';
  window.trainingFilters = typeof window.trainingFilters !== 'undefined' ? window.trainingFilters : {
    search: '',
    status: 'all',
    role: 'all',
    sort: 'name',
    compact: false
  };
  
  // Also create local references for easier access
  var trainingData = window.trainingData;
  var currentTrainingTab = window.currentTrainingTab;
  var trainingFilters = window.trainingFilters;

  async function loadTrainingMatrix() {
    try {
      const [staffRes, typesRes, recordsRes] = await Promise.all([
        // Load staff from master_users table instead of empty master_users table
        supabase.from('master_users').select('auth_user_id, full_name, role, kiosk_user_id').eq('site_id', ctx.site_id),
        supabase.from('training_types').select('*').eq('site_id', ctx.site_id).eq('active', true),
        // no relational select here (avoids RLS join issues on live)
        supabase.from('training_records').select('*').eq('site_id', ctx.site_id)
      ]);

      if (staffRes.error) throw staffRes.error;
      if (typesRes.error) throw typesRes.error;
      if (recordsRes.error) throw recordsRes.error;

      // Map profiles to staff format expected by training matrix
      const mappedStaff = staffRes.data?.map(profile => ({
        id: profile.kiosk_user_id || profile.auth_user_id, // Use kiosk_user_id if available, fallback to auth_user_id
        user_id: profile.auth_user_id,
        full_name: profile.full_name,
        role: profile.access_type || profile.role,
        active: true
      })) || [];

      window.trainingData = {
        staff: mappedStaff,
        types: typesRes.data || [],
        records: recordsRes.data || [],
        isDemoData: false,  // Clear demo data flag
        isDataLoaded: true  // Mark that we've loaded data from database
      };

      // Update local reference
      trainingData = window.trainingData;

      console.log('Training data loaded:', {
        staff: trainingData.staff.length,
        types: trainingData.types.length,
        records: trainingData.records.length
      });

      // Add helper function for flexible record matching
      window.getStaffRecords = function(staffMember) {
        return trainingData.records.filter(record => {
          // Match by staff_id (integer) if available
          if (record.staff_id && staffMember.id && record.staff_id == staffMember.id) {
            return true;
          }
          // Match by user_id (UUID) if available  
          if (record.user_id && staffMember.user_id && record.user_id === staffMember.user_id) {
            return true;
          }
          return false;
        });
      };

      // Initialize controls
      initializeTrainingControls();
      
      // Ensure we render with a slight delay to allow DOM to be ready
      setTimeout(() => renderTrainingMatrix(), 10);
    } catch (err) {
      console.error('Failed to load training data:', err);
      // Mark data as loaded even on error so we don't keep retrying
      window.trainingData = window.trainingData || {
        staff: [],
        types: [],
        records: [],
        isDataLoaded: false,
        isDemoData: false
      };
      window.trainingData.isDataLoaded = true;
      trainingData = window.trainingData;
      document.getElementById('training-tbody').innerHTML =
        '<tr><td colspan="100%" class="muted">Failed to load training data: ' + (err?.message || err) + '</td></tr>';
    }
  }

  // Expose loader so early bootstrap shims can retrigger after ctx becomes ready
  window.loadTrainingMatrix = loadTrainingMatrix;

  function initializeTrainingControls() {
    try {
      // Ensure trainingFilters is defined
      if (typeof trainingFilters === 'undefined') {
        window.trainingFilters = {
          search: '',
          status: 'all',
          role: 'all',
          sort: 'name',
          compact: false
        };
      }
      
      const searchInput = document.getElementById('training-search');
      const filterPills = document.querySelectorAll('.filter-pill');
      const densityToggle = document.getElementById('density-toggle');
      const roleFilter = document.getElementById('role-filter');
      const sortSelect = document.getElementById('sort-select');
      const closeDrawer = document.getElementById('close-drawer');

      // Search functionality
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          if (window.trainingFilters) {
            window.trainingFilters.search = e.target.value.toLowerCase();
          }
          renderTrainingMatrix();
        });
      }

      // Status filter pills
      filterPills.forEach(pill => {
        pill.addEventListener('click', () => {
          filterPills.forEach(p => p.classList.remove('active'));
          pill.classList.add('active');
          if (window.trainingFilters) {
            window.trainingFilters.status = pill.dataset.filter;
          }
          renderTrainingMatrix();
        });
      });

      // Density toggle
      if (densityToggle) {
        densityToggle.addEventListener('click', () => {
          if (window.trainingFilters) {
            window.trainingFilters.compact = !window.trainingFilters.compact;
          }
        densityToggle.classList.toggle('active');
        const matrixContainer = document.getElementById('training-matrix-container');
        if (matrixContainer) {
          matrixContainer.classList.toggle('compact', trainingFilters.compact);
        }
      });
    }

      // Role filter
      if (roleFilter) {
        // Populate role options
        if (window.trainingData && window.trainingData.staff) {
          const uniqueRoles = [...new Set(window.trainingData.staff.map(s => s.role).filter(Boolean))];
          roleFilter.innerHTML = '<option value="all">All Roles</option>' + 
            uniqueRoles.map(role => `<option value="${role}">${role}</option>`).join('');
        }
        
        roleFilter.addEventListener('change', (e) => {
          if (window.trainingFilters) {
            window.trainingFilters.role = e.target.value;
          }
          renderTrainingMatrix();
        });
      }

      // Sort select
      if (sortSelect) {
        sortSelect.addEventListener('change', (e) => {
          if (window.trainingFilters) {
            window.trainingFilters.sort = e.target.value;
          }
          renderTrainingMatrix();
        });
      }

      // Drawer close
      if (closeDrawer) {
        closeDrawer.addEventListener('click', () => {
          document.getElementById('cell-drawer').classList.remove('open');
        });
      }
    } catch (err) {
      console.error('initializeTrainingControls error', err);
      const tbody = document.getElementById('training-tbody');
      if (tbody) tbody.innerHTML = `<tr><td colspan="100%" class="muted">Controls init error: ${esc(err?.message || err)}</td></tr>`;
    }
  }

  function switchTrainingTab(tab) {
    window.currentTrainingTab = tab;
    currentTrainingTab = tab;
    document.querySelectorAll('#view-training .tab-controls button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    renderTrainingMatrix();
  }

  function renderTrainingMatrix() {
    try {
      try { window.debugLog && window.debugLog('renderTrainingMatrix:enter', { now: Date.now() }); } catch(_) {}
      if (window.trainingData) { try { trainingData = window.trainingData; } catch(_){} }
      const headers = document.getElementById('training-headers');
      const tbody = document.getElementById('training-tbody');

      if (!headers || !tbody) return;

      try { window.debugLog && window.debugLog('renderTrainingMatrix:starting', { staffLen: trainingData.staff?.length, typesLen: trainingData.types?.length }); } catch(_) {}

      // Check if data hasn't been loaded from database yet (not just empty)
      // If trainingData.isDataLoaded is undefined, we haven't tried loading yet
      if (!trainingData.isDataLoaded && !trainingData.isDemoData) {
        tbody.innerHTML = `
          <tr><td colspan="100%" class="muted">Loading training matrix...</td></tr>`;
        // Trigger data load
        loadTrainingMatrix();
        return;
      }

      // If there's no data loaded, provide a helpful fallback so UI can be inspected
      if ((!trainingData.staff || trainingData.staff.length === 0) || (!trainingData.types || trainingData.types.length === 0)) {
        tbody.innerHTML = `
          <tr><td colspan="100%" class="muted">No training data available.</td></tr>
          <tr><td colspan="100%" style="text-align:center; padding: 16px;">
            <button class="btn secondary" id="btn-use-demo-training">Use demo data to preview matrix</button>
          </td></tr>`;

        const demoBtn = document.getElementById('btn-use-demo-training');
        if (demoBtn) {
          demoBtn.addEventListener('click', () => {
            // Small, non-destructive demo dataset
            trainingData.staff = [
              { id: 1, full_name: 'Alice Example', role: 'Nurse' },
              { id: 2, full_name: 'Bob Example', role: 'HCA' }
            ];
            trainingData.types = [
              { id: 101, name: 'BLS', validity_months: 12 },
              { id: 102, name: 'GDPR', validity_months: 24 }
            ];
            const now = new Date();
            const nextYear = new Date(); nextYear.setMonth(nextYear.getMonth() + 9);
            trainingData.records = [
              { id: 1001, staff_id: 1, training_type_id: 101, completion_date: now.toISOString(), expiry_date: nextYear.toISOString(), provider: 'Acme Training', verified_by: 'Manager' },
              { id: 1002, staff_id: 2, training_type_id: 102, completion_date: now.toISOString(), expiry_date: null, provider: 'Acme Training' }
            ];
            // Mark as demo data so we can detect it
            trainingData.isDemoData = true;
            renderTrainingMatrix();

            // Add a button to reload real data
            const reloadBtn = document.createElement('button');
            reloadBtn.className = 'btn primary';
            reloadBtn.textContent = 'Load Real Data';
            reloadBtn.style.marginLeft = '10px';
            reloadBtn.onclick = () => {
              loadTrainingMatrix(); // Reload real data from database
            };
            demoBtn.parentElement.appendChild(reloadBtn);
          });
        }

        return;
      }

      // Continue with rendering code

      // Show demo data warning if using demo data
      if (trainingData.isDemoData) {
        const matrixContainer = document.getElementById('training-matrix-container');
        const existingWarning = matrixContainer.querySelector('.demo-data-warning');
        if (!existingWarning) {
          const warningDiv = document.createElement('div');
          warningDiv.className = 'demo-data-warning';
          warningDiv.style.cssText = 'background: #ff9800; color: white; padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;';
          warningDiv.innerHTML = `
            <span>⚠️ Using Demo Data - This is sample data for preview purposes only</span>
            <button class="btn" onclick="loadTrainingMatrix()" style="background: white; color: #333; padding: 5px 15px; border: none; border-radius: 4px; cursor: pointer;">Load Real Data</button>
          `;
          matrixContainer.insertBefore(warningDiv, matrixContainer.firstChild);
        }
      } else {
        // Remove warning if it exists and we're showing real data
        const existingWarning = document.querySelector('.demo-data-warning');
        if (existingWarning) {
          existingWarning.remove();
        }
      }

      // Ensure trainingFilters is defined
    if (typeof trainingFilters === 'undefined') {
      window.trainingFilters = {
        search: '',
        status: 'all',
        role: 'all',
        sort: 'name',
        compact: false
      };
    }
    
    // Filter staff by type and search
    let filteredStaff = trainingData.staff.filter(staff => {
      const isClinical = ['GP', 'Nurse', 'HCA', 'Practice Nurse', 'ANP'].some(role => 
        (staff.role || '').toLowerCase().includes(role.toLowerCase())
      );
      
      const matchesTab = currentTrainingTab === 'clinical' ? isClinical : !isClinical;
      const matchesSearch = !trainingFilters || !trainingFilters.search || 
        (staff.full_name || '').toLowerCase().includes(trainingFilters.search || '');
      const matchesRole = !trainingFilters || trainingFilters.role === 'all' || staff.role === trainingFilters.role;
      
      return matchesTab && matchesSearch && matchesRole;
    });

    // Apply status filter
    if (trainingFilters && trainingFilters.status !== 'all') {
      filteredStaff = filteredStaff.filter(staff => {
        const staffRecords = window.getStaffRecords ? window.getStaffRecords(staff) : 
                           trainingData.records.filter(r => r.staff_id === staff.id || r.user_id === staff.user_id);
        const staffStatus = calculateStaffStatus(staff.id, staffRecords);
        return staffStatus === trainingFilters.status;
      });
    }

    // Sort staff
    filteredStaff.sort((a, b) => {
      const sortBy = trainingFilters ? trainingFilters.sort : 'name';
      switch (sortBy) {
        case 'compliance':
          const aCompliance = calculateCompliancePercentage(a.id);
          const bCompliance = calculateCompliancePercentage(b.id);
          return bCompliance - aCompliance;
        case 'expiry':
          const aSoonest = getSoonestExpiry(a.id);
          const bSoonest = getSoonestExpiry(b.id);
          if (!aSoonest && !bSoonest) return 0;
          if (!aSoonest) return 1;
          if (!bSoonest) return -1;
          return new Date(aSoonest) - new Date(bSoonest);
        case 'overdue':
          const aOverdue = getOverdueCount(a.id);
          const bOverdue = getOverdueCount(b.id);
          return bOverdue - aOverdue;
        default:
          return (a.full_name || '').localeCompare(b.full_name || '');
      }
    });

    // Build sortable headers
    headers.innerHTML = '<th>Staff Member</th>' + 
      trainingData.types.map(type => `
        <th class="sortable" data-type-id="${type.id}" title="${esc(type.description || type.name)}">
          ${esc(type.name)}
        </th>
      `).join('');

    // Add column sort handlers
    headers.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        sortByColumn(th.dataset.typeId);
      });
    });

    // Build matrix rows
    if (filteredStaff.length === 0) {
      tbody.innerHTML = `<tr><td colspan="${trainingData.types.length + 1}" class="muted">No ${currentTrainingTab} staff found</td></tr>`;
    } else {
      tbody.innerHTML = filteredStaff.map(staff => {
        const staffRecords = window.getStaffRecords ? window.getStaffRecords(staff) : 
                           trainingData.records.filter(r => r.staff_id === staff.id || r.user_id === staff.user_id);
        const compliance = calculateCompliancePercentage(staff.id);
        
        const cells = trainingData.types.map(type => {
          const record = staffRecords.find(r => r.training_type_id === type.id);
          return renderTrainingCell(staff.id, type.id, record, staff, type);
        }).join('');
        
        return `<tr>
          <td title="${esc(staff.full_name)} - ${compliance}% compliant">${esc(staff.full_name || 'Unknown')}<br><small class="compliance-badge">${compliance}% compliant</small></td>
          ${cells}
        </tr>`;
      }).join('');
    }

    // Update counts and legend
    updateFilterCounts(filteredStaff);
    
    // Add click handlers for cells
    tbody.querySelectorAll('.training-cell').forEach(cell => {
      cell.addEventListener('click', () => {
        const staffId = cell.dataset.staffId;
        const typeId = cell.dataset.typeId;
        openCellDrawer(staffId, typeId);
      });
    });
    
    } catch (err) {
      console.error('renderTrainingMatrix error', err);
      const tbody = document.getElementById('training-tbody');
      if (tbody) tbody.innerHTML = `<tr><td colspan="100%" class="muted">Render error: ${esc(err?.message || err)}</td></tr>`;
      return;
    }
  }

  function renderTrainingCell(staffId, typeId, record, staff, type) {
    const today = new Date();
    let status = 'training-missing';
    let content = '—';
    let tooltipText = 'No record found';
    
    if (record) {
      const completionDate = new Date(record.completion_date);
      const expiryDate = record.expiry_date ? new Date(record.expiry_date) : null;
      
      if (expiryDate) {
        const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysToExpiry < 0) {
          status = 'training-expired';
          content = `Expired`;
          tooltipText = `Expired ${Math.abs(daysToExpiry)} days ago\\nCompleted: ${fmtDateShort(record.completion_date)}\\nExpired: ${fmtDateShort(record.expiry_date)}`;
        } else if (daysToExpiry <= 30) {
          status = 'training-expiring';
          content = `${daysToExpiry}d`;
          tooltipText = `Expires in ${daysToExpiry} days\\nCompleted: ${fmtDateShort(record.completion_date)}\\nExpires: ${fmtDateShort(record.expiry_date)}`;
        } else {
          status = 'training-completed';
          content = `✓`;
          tooltipText = `Valid until ${fmtDateShort(record.expiry_date)}\\nCompleted: ${fmtDateShort(record.completion_date)}`;
        }
      } else {
        status = 'training-completed';
        content = `✓`;
        tooltipText = `Completed: ${fmtDateShort(record.completion_date)}\\nNo expiry date`;
      }
      
      if (record.verified_by) {
        tooltipText += `\\nVerified by: ${record.verified_by}`;
      }
    }

    return `<td class="training-cell ${status}" data-staff-id="${staffId}" data-type-id="${typeId}" title="${tooltipText}">
      ${content}
      <div class="training-tooltip">${tooltipText.replace(/\\n/g, '<br>')}</div>
    </td>`;
  }

  function calculateStaffStatus(staffId, staffRecords) {
    const today = new Date();
    let hasExpired = false;
    let hasExpiring = false;
    let hasValid = false;
    let hasMissing = false;

    trainingData.types.forEach(type => {
      const record = staffRecords.find(r => r.training_type_id === type.id);
      
      if (!record) {
        hasMissing = true;
      } else if (record.expiry_date) {
        const expiryDate = new Date(record.expiry_date);
        const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysToExpiry < 0) {
          hasExpired = true;
        } else if (daysToExpiry <= 30) {
          hasExpiring = true;
        } else {
          hasValid = true;
        }
      } else {
        hasValid = true;
      }
    });

    // Priority order: expired > expiring > missing > valid
    if (hasExpired) return 'expired';
    if (hasExpiring) return 'expiring';
    if (hasMissing) return 'missing';
    return 'valid';
  }

  function calculateCompliancePercentage(staffId) {
    const staff = trainingData.staff.find(s => s.id === staffId);
    const staffRecords = window.getStaffRecords && staff ? window.getStaffRecords(staff) : 
                        trainingData.records.filter(r => r.staff_id === staffId);
    const today = new Date();
    let compliantCount = 0;
    
    trainingData.types.forEach(type => {
      const record = staffRecords.find(r => r.training_type_id === type.id);
      
      if (record) {
        if (!record.expiry_date) {
          compliantCount++;
        } else {
          const expiryDate = new Date(record.expiry_date);
          if (expiryDate >= today) {
            compliantCount++;
          }
        }
      }
    });
    
    return trainingData.types.length > 0 ? Math.round((compliantCount / trainingData.types.length) * 100) : 0;
  }

  function getSoonestExpiry(staffId) {
    const staff = trainingData.staff.find(s => s.id === staffId);
    const staffRecords = window.getStaffRecords && staff ? window.getStaffRecords(staff) : 
                        trainingData.records.filter(r => r.staff_id === staffId);
    const today = new Date();
    let soonestExpiry = null;
    
    staffRecords.forEach(record => {
      if (record.expiry_date) {
        const expiryDate = new Date(record.expiry_date);
        if (expiryDate >= today && (!soonestExpiry || expiryDate < new Date(soonestExpiry))) {
          soonestExpiry = record.expiry_date;
        }
      }
    });
    
    return soonestExpiry;
  }

  function getOverdueCount(staffId) {
    const staffRecords = trainingData.records.filter(r => r.staff_id === staffId);
    const today = new Date();
    let overdueCount = 0;
    
    staffRecords.forEach(record => {
      if (record.expiry_date) {
        const expiryDate = new Date(record.expiry_date);
        if (expiryDate < today) {
          overdueCount++;
        }
      }
    });
    
    // Add missing records as overdue
    const missingCount = trainingData.types.length - staffRecords.length;
    return overdueCount + missingCount;
  }

  function updateFilterCounts(filteredStaff) {
    let counts = { all: 0, missing: 0, expiring: 0, expired: 0, valid: 0 };
    
    trainingData.staff.forEach(staff => {
      const staffRecords = trainingData.records.filter(r => r.staff_id === staff.id);
      const status = calculateStaffStatus(staff.id, staffRecords);
      counts.all++;
      counts[status]++;
    });

    // Update filter pills
    Object.keys(counts).forEach(status => {
      const countElement = document.getElementById(`count-${status}`);
      if (countElement) {
        countElement.textContent = counts[status];
      }
    });

    // Update legend counts
    const legendCounts = {
      'legend-valid-count': counts.valid,
      'legend-expiring-count': counts.expiring,
      'legend-expired-count': counts.expired,
      'legend-missing-count': counts.missing
    };

    Object.entries(legendCounts).forEach(([id, count]) => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = count;
      }
    });
  }
  
  // Expose renderTrainingMatrix to window for early calls
  window.renderTrainingMatrix = renderTrainingMatrix;

  function sortByColumn(typeId) {
    // Toggle sort state for column
    const th = document.querySelector(`th[data-type-id="${typeId}"]`);
    const currentSort = th.dataset.sort || 'none';
    
    // Clear other sorts
    document.querySelectorAll('th.sortable').forEach(header => {
      header.classList.remove('sort-asc', 'sort-desc');
      delete header.dataset.sort;
    });
    
    // Apply new sort
    if (currentSort === 'none' || currentSort === 'desc') {
      th.classList.add('sort-asc');
      th.dataset.sort = 'asc';
    } else {
      th.classList.add('sort-desc');
      th.dataset.sort = 'desc';
    }
    
    // Re-render with custom sort
    renderTrainingMatrix();
  }

  function openCellDrawer(staffId, typeId) {
    const staff = trainingData.staff.find(s => s.id == staffId);
    const type = trainingData.types.find(t => t.id == typeId);
    const staffRecords = window.getStaffRecords && staff ? window.getStaffRecords(staff) : 
                        trainingData.records.filter(r => r.staff_id == staffId);
    const record = staffRecords.find(r => r.training_type_id == typeId);

    if (!staff || !type) return;

    // Store IDs for editing
    window.currentTrainingEdit = { staffId, typeId, record };
    
    // Populate drawer
    document.getElementById('drawer-staff-name').textContent = staff.full_name || 'Unknown';
    document.getElementById('drawer-module-name').textContent = type.name;
    
    if (record) {
      const today = new Date();
      const expiryDate = record.expiry_date ? new Date(record.expiry_date) : null;
      let statusText = 'Completed';
      
      if (expiryDate) {
        const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        if (daysToExpiry < 0) {
          statusText = `Expired (${Math.abs(daysToExpiry)} days ago)`;
        } else if (daysToExpiry <= 30) {
          statusText = `Expiring in ${daysToExpiry} days`;
        } else {
          statusText = 'Valid';
        }
      }
      
      document.getElementById('drawer-status').textContent = statusText;
      document.getElementById('drawer-issue-date').textContent = record.completion_date ? fmtDateShort(record.completion_date) : '-';
      document.getElementById('drawer-expiry-date').textContent = record.expiry_date ? fmtDateShort(record.expiry_date) : 'No expiry';
      document.getElementById('drawer-provider').textContent = record.provider || '-';
      document.getElementById('drawer-evidence').textContent = record.certificate_url ? 'Certificate on file' : 'No evidence';
      document.getElementById('drawer-notes').textContent = record.notes || '-';
      document.getElementById('drawer-verified').textContent = record.verified_by ? `${record.verified_by} on ${fmtDateShort(record.verified_date)}` : 'Not verified';
    } else {
      document.getElementById('drawer-status').textContent = 'No record';
      document.getElementById('drawer-issue-date').textContent = '-';
      document.getElementById('drawer-expiry-date').textContent = '-';
      document.getElementById('drawer-provider').textContent = '-';
      document.getElementById('drawer-evidence').textContent = 'No evidence';
      document.getElementById('drawer-notes').textContent = '-';
      document.getElementById('drawer-verified').textContent = 'Not verified';
    }

    // Set up action buttons
    setupDrawerActions(staffId, typeId, record);
    
    // Open drawer
    document.getElementById('cell-drawer').classList.add('open');
  }

  function setupDrawerActions(staffId, typeId, record) {
    const uploadBtn = document.getElementById('drawer-upload');
    const replaceBtn = document.getElementById('drawer-replace');
    const reviewBtn = document.getElementById('drawer-review');
    const reminderBtn = document.getElementById('drawer-reminder');

    // Clear previous handlers
    [uploadBtn, replaceBtn, reviewBtn, reminderBtn].forEach(btn => {
      if (btn) btn.replaceWith(btn.cloneNode(true));
    });

    // Upload/Replace handler
    const newUploadBtn = document.getElementById('drawer-upload');
    const newReplaceBtn = document.getElementById('drawer-replace');
    
    if (newUploadBtn) {
      newUploadBtn.addEventListener('click', () => openTrainingModal(staffId, typeId));
    }
    if (newReplaceBtn) {
      newReplaceBtn.addEventListener('click', () => openTrainingModal(staffId, typeId));
    }

    // Mark as reviewed handler
    const newReviewBtn = document.getElementById('drawer-review');
    if (newReviewBtn) {
      newReviewBtn.addEventListener('click', async () => {
        if (record) {
          try {
            await supabase.from('training_records')
              .update({ 
                verified_by: ctx.user?.email || 'System',
                verified_date: new Date().toISOString()
              })
              .eq('id', record.id);
            
            showToast('Record marked as reviewed', 'success');
            loadTrainingMatrix();
          } catch (err) {
            showToast('Failed to mark as reviewed: ' + err.message, 'error');
          }
        }
      });
    }

    // Send reminder handler
    const newReminderBtn = document.getElementById('drawer-reminder');
    if (newReminderBtn) {
      newReminderBtn.addEventListener('click', () => {
        showToast('Reminder functionality coming soon', 'info');
      });
    }
  }

  async function handleTrainingFileUpload() {
    const fileInput = document.getElementById('training-certificate');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    if (file.size > 10 * 1024 * 1024) {
      document.getElementById('training-error').textContent = 'File size must be less than 10MB';
      document.getElementById('training-error').style.display = 'block';
      return;
    }

    // Show file selected
    const uploadZone = document.getElementById('training-upload-zone');
    uploadZone.innerHTML = `
      <div style="color: var(--success);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <p style="margin-top: 8px;">Selected: ${file.name}</p>
      </div>
    `;
  }

  function calculateTrainingExpiry() {
    const completionDate = document.getElementById('training-completion-date').value;
    const typeId = document.getElementById('training-type-id').value;
    
    if (!completionDate || !typeId) return;
    
    // Find the training type to get validity period
    const trainingType = trainingData.types.find(t => t.id == typeId);
    if (!trainingType || !trainingType.validity_months) return;
    
    // Calculate expiry date
    const completion = new Date(completionDate);
    const expiry = new Date(completion);
    expiry.setMonth(expiry.getMonth() + trainingType.validity_months);
    
    // Set the expiry date field
    const expiryField = document.getElementById('training-expiry-date');
    expiryField.value = expiry.toISOString().split('T')[0];
  }

  // Removed duplicate saveTrainingRecord - using the one defined later
  
  // Edit training record from the admin drawer by opening the modal editor
  function editTrainingRecord() {
    if (!window.currentTrainingEdit) {
      alert('No training record selected for editing. Please click on a training cell first to select a record.');
      return;
    }

    if (!trainingData || !Array.isArray(trainingData.staff) || !Array.isArray(trainingData.types)) {
      alert('Training data not loaded. Please refresh the page and try again.');
      return;
    }

    const { staffId, typeId, record } = window.currentTrainingEdit;
    const staff = trainingData.staff.find(s => String(s.id) === String(staffId));
    const type = trainingData.types.find(t => String(t.id) === String(typeId));

    if (!staff || !type) {
      alert(`Invalid training record data. Staff ID: ${staffId}, Type ID: ${typeId}. Please refresh the training data and try again.`);
      return;
    }

    const staffNameField = document.getElementById('training-edit-staff-name');
    const staffIdField = document.getElementById('training-edit-staff-id');
    const typeNameField = document.getElementById('training-edit-type-name');
    const typeIdField = document.getElementById('training-edit-type-id');
    const completionField = document.getElementById('training-edit-completion');
    const expiryField = document.getElementById('training-edit-expiry');
    const providerField = document.getElementById('training-edit-provider');
    const notesField = document.getElementById('training-edit-notes');

    if (!staffNameField || !staffIdField || !typeNameField || !typeIdField || !completionField || !expiryField || !providerField || !notesField) {
      console.error('Training edit modal fields missing');
      alert('Training edit form could not be found. Please refresh the page and try again.');
      return;
    }

    window.currentTrainingEditData = { staff, type, record };

    staffNameField.value = staff.full_name || staff.name || 'Unknown';
    staffIdField.value = staff.id;
    typeNameField.value = type.name || 'Training module';
    typeIdField.value = type.id;
    completionField.value = record && record.completion_date ? record.completion_date.split('T')[0] : '';
    expiryField.value = record && record.expiry_date ? record.expiry_date.split('T')[0] : '';
    providerField.value = record && record.provider ? record.provider : '';
    notesField.value = record && record.notes ? record.notes : '';

    const errorDiv = document.getElementById('training-edit-error');
    if (errorDiv) {
      errorDiv.textContent = '';
      errorDiv.style.display = 'none';
    }

    const drawer = document.getElementById('cell-drawer');
    if (drawer) {
      drawer.classList.remove('open');
    }

    openTrainingModal();
  }
  window.editTrainingRecord = editTrainingRecord;
  
  // Open training modal
  function openTrainingModal() {
    const modal = document.getElementById('training-edit-modal');
    if (modal) {
      modal.style.display = 'flex';
    }
  }
  window.openTrainingModal = openTrainingModal;
  
  // Close training modal
  function closeTrainingModal() {
    const modal = document.getElementById('training-edit-modal');
    if (modal) {
      modal.style.display = 'none';
      document.getElementById('training-edit-form').reset();
      document.getElementById('training-edit-error').style.display = 'none';
    }
  }
  window.closeTrainingModal = closeTrainingModal;
  
  // Save training record
  async function saveTrainingRecord(event) {
    if (event) event.preventDefault();
    
    const errorDiv = document.getElementById('training-edit-error');
    errorDiv.style.display = 'none';
    
    if (!window.currentTrainingEditData) {
      errorDiv.textContent = 'No training record data available';
      errorDiv.style.display = 'block';
      return;
    }
    
    const { staff, type, record } = window.currentTrainingEditData;
    
    try {
      // Get form values
      const completionDate = document.getElementById('training-edit-completion').value;
      const expiryDate = document.getElementById('training-edit-expiry').value;
      const provider = document.getElementById('training-edit-provider').value;
      const notes = document.getElementById('training-edit-notes').value;
      
      // Prepare record data
      const recordData = {
        site_id: ctx.site_id,
        staff_id: staff.id,
        training_type_id: type.id,
        completion_date: completionDate,
        expiry_date: expiryDate || null,
        provider: provider || null,
        notes: notes || null
      };

      // Update or insert record
      if (record && record.id) {
        const { error } = await supabase
          .from('training_records')
          .update(recordData)
          .eq('id', record.id);
        if (error) throw error;
      } else {
        const { error } = await supabase
          .from('training_records')
          .insert(recordData);
        if (error) throw error;
      }

      // Close modal and reload
      closeTrainingModal();
      if (typeof loadTrainingMatrix === 'function') {
        loadTrainingMatrix();
      }
      showToast('Training record updated successfully', 'success');
    } catch (err) {
      console.error('Failed to save training record:', err);
      errorDiv.textContent = err.message || 'Failed to save training record';
      errorDiv.style.display = 'block';
    }
  }
  window.saveTrainingRecord = saveTrainingRecord;

  // Global function for downloading training certificates
  window.downloadTrainingCertificate = function() {
    const staffId = document.getElementById('training-staff-id').value;
    const typeId = document.getElementById('training-type-id').value;
    const staff = trainingData.staff.find(s => s.id == staffId);
    const staffRecords = window.getStaffRecords && staff ? window.getStaffRecords(staff) : 
                        trainingData.records.filter(r => r.staff_id == staffId);
    const record = staffRecords.find(r => r.training_type_id == typeId);
    
    if (record?.certificate_url) {
      window.open(record.certificate_url, '_blank');
    }
  };

  // Logout function
  window.logout = async function() {
    try {
      await supabase.auth.signOut();
      showAuth(true);
    } catch (error) {
      console.error('Logout failed:', error);
      // Force logout anyway
      showAuth(true);
    }
  };


  // Quiz attempts functionality
  async function loadQuizAttempts() {
    try {
      const { data: attempts, error } = await supabase
        .from('quiz_attempts')
        .select('*')
        .eq('site_id', ctx.site_id)
        .order('started_at', { ascending: false });

      if (error) throw error;

      renderQuizAttempts(attempts || []);
      updateQuizStats(attempts || []);
    } catch (err) {
      console.error('Failed to load quiz attempts:', err);
      document.getElementById('quiz-attempts-tbody').innerHTML =
        '<tr><td colspan="7" class="muted">Failed to load quiz attempts</td></tr>';
    }
  }

  function renderQuizAttempts(attempts) {
    const tbody = document.getElementById('quiz-attempts-tbody');
    if (!tbody) return;

    if (attempts.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="muted">No quiz attempts found</td></tr>';
      return;
    }

    tbody.innerHTML = attempts.map(attempt => {
      const startedAt = new Date(attempt.started_at).toLocaleString();
      const completedAt = attempt.completed_at ? new Date(attempt.completed_at).toLocaleString() : 'In Progress';
      const status = attempt.completed_at ? 'Completed' : 'In Progress';
      const statusClass = attempt.completed_at ? 'training-completed' : 'training-expiring';
      
      return `
        <tr>
          <td>${esc(attempt.participant_name || 'Unknown')}</td>
          <td>${startedAt}</td>
          <td>${completedAt}</td>
          <td>${attempt.total_questions}</td>
          <td>${attempt.correct_answers}</td>
          <td>${attempt.score_percent ? attempt.score_percent + '%' : '-'}</td>
          <td><span class="${statusClass}" style="padding: 4px 8px; border-radius: 12px; font-size: 11px;">${status}</span></td>
        </tr>
      `;
    }).join('');
  }

  function updateQuizStats(attempts) {
    const completed = attempts.filter(a => a.completed_at).length;
    const inProgress = attempts.filter(a => !a.completed_at).length;
    const completedAttempts = attempts.filter(a => a.completed_at && a.score_percent !== null);
    const averageScore = completedAttempts.length > 0 
      ? Math.round(completedAttempts.reduce((sum, a) => sum + parseFloat(a.score_percent), 0) / completedAttempts.length)
      : 0;

    document.getElementById('completed-quizzes-count').textContent = completed;
    document.getElementById('in-progress-quizzes-count').textContent = inProgress;
    document.getElementById('average-quiz-score').textContent = averageScore + '%';
  }

  // Complaints filter functions
  function clearComplaintsFilters() {
    document.getElementById('complaints-filter-year').value = '';
    document.getElementById('complaints-filter-category').value = '';
    document.getElementById('complaints-filter-status').value = '';
    document.getElementById('complaints-search').value = '';
    
    // Apply the cleared filters
    if (typeof loadComplaints === 'function') {
      loadComplaints();
    }
  }

  function applyComplaintsFilters() {
    // The existing complaints loading should already use these filter values
    if (typeof loadComplaints === 'function') {
      loadComplaints();
    }
  }

  // Make functions globally available
  window.clearComplaintsFilters = clearComplaintsFilters;
  window.applyComplaintsFilters = applyComplaintsFilters;

  // Initialize training tab handlers
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('tab-clinical')?.addEventListener('click', () => switchTrainingTab('clinical'));
    document.getElementById('tab-non-clinical')?.addEventListener('click', () => switchTrainingTab('non-clinical'));
  });

  document.addEventListener("DOMContentLoaded", bootstrap);


  // Initialize bulk upload functionality
  function initBulkUpload() {
    // Bulk Upload button handler
    const bulkUploadBtn = document.getElementById('bulk-upload-btn');
    if (bulkUploadBtn) {
      bulkUploadBtn.addEventListener('click', () => {
        // Show bulk upload tab
        document.querySelector('[data-tab="bulk-upload"]').style.display = 'block';
        document.querySelector('[data-tab="bulk-upload"]').click();
      });
    }


  document.addEventListener("DOMContentLoaded", bootstrap);
}
</script>
  
  <div id="crud-modal" class="auth" aria-hidden="true">
    <div class="card" style="width:min(620px,95vw)">
      <h2 id="crud-title">Edit</h2>
      <form id="crud-form">
        <div id="crud-fields"></div>
        <div style="display:flex; gap:8px; margin-top:12px">
          <button type="submit" class="btn" id="crud-save">Save</button>
          <button type="button" class="btn secondary" id="crud-cancel">Cancel</button>
          <button type="button" class="btn secondary" id="crud-delete" style="margin-left:auto; background:#ff6b6b33; border:1px solid #ff6b6b55">Delete</button>
        </div>
        <div class="error" id="crud-error" role="alert"></div>
      </form>
    </div>
  </div>
  
  <div id="submission-detail-modal" class="auth" aria-hidden="true">
    <div class="card" style="width:min(800px, 95vw)">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="submission-detail-title" style="margin:0;">Submission Details</h2>
        <button id="submission-detail-close" class="btn secondary" style="padding: 6px; line-height: 0;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div class="hint">Click on a row to amend the check type or comment.</div>
      <div id="submission-detail-content" style="margin-top:12px;"></div>
    </div>
  </div>
  <script>

  // Instrument file selection and upload points if present
  (function instrumentDebugging(){
    const fileInput = document.getElementById('field-attachment');
    if(fileInput){
      fileInput.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        debugLog('file selected', f ? { name: f.name, size: f.size, type: f.type } : 'no-file');
      });
    }

    // Hook into save button to dump pendingAttachment
    const saveBtn = document.getElementById('crud-save');
    if(saveBtn){
      saveBtn.addEventListener('click', ()=>{
        debugLog('Save clicked. pendingAttachment', window.crudState ? window.crudState.pendingAttachment : null);
      });
    }

    // AI Populate logic for complaints form (using event delegation for dynamic buttons)
    (function(){
      function setStatus(statusEl, msg){ if(statusEl) statusEl.textContent = msg || ''; }
      function getEl(...selectors){ for(const s of selectors){ const el=document.querySelector(s); if(el) return el; } return null; }

      // Use event delegation to handle dynamically created AI buttons
      document.addEventListener('click', async function(event) {
        if (!event.target.classList.contains('ai-populate-btn')) return;
        
        const btn = event.target;
        const btnId = btn.id;
        const statusId = btnId.replace('ai-populate-btn-', 'ai-status-');
        const statusEl = document.getElementById(statusId);
        
        // Find the associated file input - extract field ID from button ID
        const fieldId = btnId.replace('ai-populate-btn-', '');
        const fileInput = document.getElementById(fieldId);
        
        debugLog('AI button clicked', {buttonId: btnId, fieldId: fieldId, fileInputFound: !!fileInput, hasFiles: fileInput?.files?.length > 0});
        
        if (!fileInput || !fileInput.files.length){
          setStatus(statusEl, 'Choose a file first.'); 
          debugLog('No file input or files found', {fileInput: !!fileInput, filesLength: fileInput?.files?.length});
          return;
        }
        
        const file = fileInput.files[0];
        debugLog('AI button clicked', {buttonId: btnId, fileName: file.name, fileSize: file.size});
        
        // Get form field elements
        const elDate = getEl('#field-complaint_date');
        const elPatient = getEl('#field-patient_initials');
        const elAge = getEl('#field-age');
        const elSummary = getEl('#field-complaint_summary');
        const elOrig = getEl('#field-original_complaint');
        const elResp = getEl('#field-response');
        const elLessons = getEl('#field-lessons_learned');
        const elCategory = getEl('#field-category');
        const elCategoryTrends = getEl('#field-category_trends');
        const elSolution = getEl('#field-solution_given');
        const elSuggestions = getEl('#field-suggestions_prevent_reoccurrence');
        const elActions = getEl('#field-actions_to_be_taken');
        const elPeopleInvolved = getEl('#field-people_involved');
        const elAvenue = getEl('#field-avenue_used');
        const elStatus = getEl('#field-status');
        const elPriority = getEl('#field-priority');
        const elResponseSent = getEl('#field-response_sent');
        const elCreatedBy = getEl('#field-created_by');

        btn.disabled = true; 
        setStatus(statusEl, 'Processing…');
        
        try {
          let textContent = '';
          
          // Extract text based on file type
          if (file.type === 'text/plain') {
            textContent = await file.text();
            debugLog('Text file processed', {length: textContent.length});
          } else if (file.type === 'application/pdf') {
            setStatus(statusEl, 'Extracting text from PDF…');
            try {
              const arrayBuffer = await file.arrayBuffer();
              const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
              debugLog('PDF loaded', {numPages: pdf.numPages});
              
              let pdfText = '';
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                pdfText += pageText + '\n';
              }
              textContent = pdfText.trim();
              debugLog('PDF text extracted', {length: textContent.length});
            } catch (pdfError) {
              debugLog('PDF extraction error', pdfError);
              setStatus(statusEl, 'Error extracting text from PDF. Try a text file instead.');
              btn.disabled = false;
              return;
            }
          } else if (file.type.includes('word') || file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
            setStatus(statusEl, 'Word document processing - please use PDF or text files');
            btn.disabled = false;
            return;
          } else {
            setStatus(statusEl, 'Please upload a PDF or text (.txt) file for AI processing.');
            btn.disabled = false;
            return;
          }
          
          if (!textContent || textContent.length < 10) {
            setStatus(statusEl, 'File appears to be empty or too short.');
            btn.disabled = false;
            return;
          }
          
          debugLog('Calling extract-complaint function', {textLength: textContent.length});
          setStatus(statusEl, 'Calling AI service…');
          
          const { data, error } = await supabase.functions.invoke('extract-complaint', { 
            body: { text: textContent }
          });
          
          debugLog('AI function response', {data, error});
          
          if (error) {
            debugLog('AI function error', error);
            throw error;
          }
          
          if (!data || !data.success) {
            const errorMsg = data?.error || 'Unknown error from AI service';
            debugLog('AI service error', errorMsg);
            throw new Error(errorMsg);
          }
          
          const d = data.data || {};
          debugLog('AI extracted data', d);
          debugLog('Form elements found', {
            date: !!elDate,
            patient: !!elPatient,
            age: !!elAge,
            summary: !!elSummary,
            original: !!elOrig,
            response: !!elResp,
            lessons: !!elLessons,
            category: !!elCategory,
            categoryTrends: !!elCategoryTrends,
            solution: !!elSolution,
            suggestions: !!elSuggestions,
            actions: !!elActions,
            peopleInvolved: !!elPeopleInvolved,
            avenue: !!elAvenue,
            status: !!elStatus,
            priority: !!elPriority,
            responseSent: !!elResponseSent,
            createdBy: !!elCreatedBy
          });
          
          // Populate all form fields
          if (elDate && d.complaint_date) {
            elDate.value = d.complaint_date;
            debugLog('Populated complaint date', d.complaint_date);
          }
          if (elPatient && d.patient_initials) {
            elPatient.value = d.patient_initials;
            debugLog('Populated patient initials', d.patient_initials);
          }
          if (elAge && d.age) {
            elAge.value = d.age;
            debugLog('Populated age', d.age);
          }
          if (elSummary && d.complaint_summary) {
            elSummary.value = d.complaint_summary;
            debugLog('Populated summary', d.complaint_summary);
          }
          if (elOrig && d.original_complaint) {
            elOrig.value = d.original_complaint;
            debugLog('Populated original complaint', d.original_complaint);
          }
          if (elResp && d.response) {
            elResp.value = d.response;
            debugLog('Populated response', d.response);
          }
          if (elLessons && d.lessons_learned) {
            elLessons.value = d.lessons_learned;
            debugLog('Populated lessons learned', d.lessons_learned);
          }
          if (elCategory && d.category) {
            elCategory.value = d.category;
            debugLog('Populated category', d.category);
          }
          if (elCategoryTrends && d.category_trends) {
            elCategoryTrends.value = d.category_trends;
            debugLog('Populated category trends', d.category_trends);
          }
          if (elSolution && d.solution_given) {
            elSolution.value = d.solution_given;
            debugLog('Populated solution given', d.solution_given);
          }
          if (elSuggestions && d.suggestions_prevent_reoccurrence) {
            elSuggestions.value = d.suggestions_prevent_reoccurrence;
            debugLog('Populated suggestions', d.suggestions_prevent_reoccurrence);
          }
          if (elActions && d.actions_to_be_taken) {
            elActions.value = d.actions_to_be_taken;
            debugLog('Populated actions', d.actions_to_be_taken);
          }
          if (elAvenue && d.avenue_used) {
            elAvenue.value = d.avenue_used;
            debugLog('Populated avenue used', d.avenue_used);
          }
          if (elStatus && d.status) {
            elStatus.value = d.status;
            debugLog('Populated status', d.status);
          }
          if (elPriority && d.priority) {
            elPriority.value = d.priority;
            debugLog('Populated priority', d.priority);
          }
          if (elResponseSent && typeof d.response_sent === 'boolean') {
            elResponseSent.checked = d.response_sent;
            debugLog('Populated response sent', d.response_sent);
          }
          // Set created_by to current user
          if (elCreatedBy && ctx.user && ctx.user.id) {
            elCreatedBy.value = ctx.user.id;
            debugLog('Set created_by to current user', ctx.user.id);
          }
          // Handle people_involved (multi-select field)
          if (elPeopleInvolved && d.people_involved && Array.isArray(d.people_involved)) {
            // For multi-select, we'd need to match names to IDs from the staff list
            debugLog('People involved names extracted', d.people_involved);
            // Note: Actual ID mapping would require matching against master_users table
          }
          
          setStatus(statusEl, '✓ Filled by AI — please review.');
          debugLog('Form populated successfully');
          
        } catch(e) {
          console.error('AI processing error:', e); 
          debugLog('AI error details', {message: e.message, stack: e.stack, error: e});
          setStatus(statusEl, 'AI error: ' + (e.message || e));
        } finally { 
          btn.disabled = false; 
        }
      });
    })();

  })();

  </script>
  
  <!-- Help Modal -->
  <div id="help-modal" class="help-modal">
    <div class="help-modal-content">
      <div class="help-modal-header">
        <h3 id="help-modal-title" class="help-modal-title">Page Help</h3>
        <button id="help-modal-close" class="help-modal-close">✕</button>
      </div>
      <div id="help-modal-body" class="help-modal-body">
        <!-- Content populated by JavaScript -->
      </div>
    </div>
  </div>
  
     <script src="supabase-debug.js"></script>
</body>
 </html>
  <script>
    // === Quiz: Raw Supabase Table Renderer ===
    (function(){
      function escapeHtml(str){
        return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      }

      async function loadQuizRawTable(){
        const thead = document.getElementById('quiz-thead');
        const tbody = document.getElementById('quiz-tbody');
        if(!thead || !tbody){ return; }
        tbody.innerHTML = '<tr><td colspan="999" class="muted">Loading…</td></tr>';
        try{
          let query = supabase.from('quiz_questions').select('*');
          if(window.ctx && ctx.site_id){ query = query.eq('site_id', ctx.site_id); }
          const { data, error } = await query;
          if(error) throw error;
          const rows = Array.isArray(data) ? data : [];

          // Build columns dynamically from union of keys
          const keys = rows.length ? Array.from(new Set(rows.flatMap(r => Object.keys(r)))) : [];
          if(keys.length === 0){
            thead.innerHTML = '<tr><th class="muted">No columns</th></tr>';
            tbody.innerHTML = '<tr><td class="muted">No rows</td></tr>';
          } else {
            thead.innerHTML = '<tr>' + keys.map(k => `<th>${escapeHtml(k)}</th>`).join('') + '</tr>';
            tbody.innerHTML = rows.map(r => {
              return '<tr>' + keys.map(k => `<td>${escapeHtml(r[k] ?? '')}</td>`).join('') + '</tr>';
            }).join('');
          }

          // Update badge with count
          const badge = document.getElementById('badge-quiz');
          if(badge){ badge.textContent = rows.length ? String(rows.length) : ''; }
        }catch(err){
          console.error(err);
          thead.innerHTML = '';
          tbody.innerHTML = `<tr><td colspan="999" class="muted">Error: ${escapeHtml(err?.message || err)}</td></tr>`;
        }
      }

      // Load when the Quiz nav button is clicked
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('btn-quiz-refresh')?.addEventListener('click', () => {
          loadQuizRawTable();
          loadQuizAttempts();
        });

        const quizBtn = document.querySelector('nav [data-section="quiz"]');
        quizBtn?.addEventListener('click', () => setTimeout(() => {
          loadQuizRawTable();
          loadQuizAttempts();
        }, 30));

        // Also observe the section becoming active (covers programmatic routing)
        const view = document.getElementById('view-quiz');
        if(view){
          const obs = new MutationObserver(() => {
            if(view.classList.contains('active') && !view.dataset._loaded){
              view.dataset._loaded = '1';
              loadQuizRawTable();
              loadQuizAttempts();
            }
          });
          obs.observe(view, { attributes:true, attributeFilter:['class'] });

          // If already active on load, render immediately
          if(view.classList.contains('active')){ 
            loadQuizRawTable(); 
            loadQuizAttempts();
          }
        }
      });

      // Expose for console/debug
      window.loadQuizRawTable = loadQuizRawTable;
    })();

    // Preview modal functions
    function showPdfPreview(fileUrl, fileName) {
        // Create preview modal if it doesn't exist
        let previewModal = document.getElementById('pdf-preview-modal');
        if (!previewModal) {
            previewModal = document.createElement('div');
            previewModal.id = 'pdf-preview-modal';
            previewModal.className = 'modal';
            previewModal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
                    <div class="modal-header">
                        <h3>Document Preview: <span id="preview-file-name"></span></h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body" style="height: 80vh; padding: 0;">
                        <iframe id="pdf-viewer" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </div>
            `;
            document.body.appendChild(previewModal);

            // Close modal handlers
            previewModal.addEventListener('click', (e) => {
                if (e.target === previewModal || e.target.classList.contains('modal-close')) {
                    previewModal.classList.remove('show');
                    URL.revokeObjectURL(document.getElementById('pdf-viewer').src);
                }
            });
        }

        document.getElementById('preview-file-name').textContent = fileName;
        document.getElementById('pdf-viewer').src = fileUrl;
        previewModal.classList.add('show');
    }

    function showDocumentMetadata(fileName, fileSize) {
        const formatFileSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const getFileType = (name) => {
            const ext = name.split('.').pop().toLowerCase();
            const types = {
                'doc': 'Word Document',
                'docx': 'Word Document',
                'xls': 'Excel Spreadsheet', 
                'xlsx': 'Excel Spreadsheet',
                'ppt': 'PowerPoint Presentation',
                'pptx': 'PowerPoint Presentation'
            };
            return types[ext] || 'Document';
        };

        showToast(`📄 ${getFileType(fileName)} - ${formatFileSize(fileSize)}\nClick Download to open`, 'info');
    }

    // Initialize all PIR enhancements when document loads
    document.addEventListener('DOMContentLoaded', () => {
        // initializeDraftTextSupport(); // Already called in initPIRemlGenerator
        
        // Initialize bulk operations toggle
        const bulkToggle = document.getElementById('bulk-select-toggle');
        if (bulkToggle) {
            bulkToggle.addEventListener('change', () => {
                document.getElementById('pre-inspection-view').classList.toggle('bulk-mode', bulkToggle.checked);
            });
        }
    });

    // PDF Preview and Document Metadata Functions
    function showPdfPreview(fileUrl, fileName) {
      // Create modal for PDF preview
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.zIndex = '2000';
      modal.innerHTML = `
        <div class="modal-content" style="width: 90vw; height: 90vh; max-width: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3>Preview: ${fileName}</h3>
            <button class="btn secondary modal-close">×</button>
          </div>
          <iframe src="${fileUrl}" style="width: 100%; height: calc(90vh - 100px); border: 1px solid var(--border-color); border-radius: 8px;"></iframe>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.classList.add('show');
      
      // Close handlers
      modal.querySelector('.modal-close').addEventListener('click', () => {
        modal.remove();
        URL.revokeObjectURL(fileUrl);
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
          URL.revokeObjectURL(fileUrl);
        }
      });
    }

    function showDocumentMetadata(fileName, fileSize) {
      const fileSizeFormatted = (fileSize / 1024).toFixed(1) + ' KB';
      const fileExtension = fileName.split('.').pop().toUpperCase();
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.zIndex = '2000';
      modal.innerHTML = `
        <div class="modal-content" style="width: min(400px, 90vw);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3>Document Information</h3>
            <button class="btn secondary modal-close">×</button>
          </div>
          <div class="field">
            <label>File Name</label>
            <div style="padding: 8px 0; word-break: break-all;">${fileName}</div>
          </div>
          <div class="field">
            <label>File Type</label>
            <div style="padding: 8px 0;">${fileExtension} Document</div>
          </div>
          <div class="field">
            <label>File Size</label>
            <div style="padding: 8px 0;">${fileSizeFormatted}</div>
          </div>
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); color: var(--muted); font-size: 12px;">
            💡 To preview ${fileExtension} files, download and open in the appropriate application.
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.classList.add('show');
      
      // Close handlers
      modal.querySelector('.modal-close').addEventListener('click', () => {
        modal.remove();
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // Initialize if DOM is already ready
    if (document.readyState !== 'loading') {
      // initializeDraftTextSupport(); // Already called in initPIRemlGenerator
    }

  </script>

<script>
// Sidebar resize functionality
document.addEventListener('DOMContentLoaded', () => {
  const sidebar = document.getElementById('sidebar');
  const app = document.getElementById('app');
  const resizeHandle = document.getElementById('sidebar-resize-handle');
  const toggleButton = document.getElementById('toggleSidebar');
  
  let isResizing = false;
  let startX = 0;
  let startWidth = 0;
  const minWidth = 56; // Collapsed width
  const maxWidth = 400; // Maximum sidebar width
  const defaultWidth = 260; // Default sidebar width
  
  // Get current sidebar width from CSS variable
  function getCurrentSidebarWidth() {
    const computedStyle = getComputedStyle(app);
    const sidebarWidth = computedStyle.getPropertyValue('--sidebarW');
    return parseInt(sidebarWidth) || defaultWidth;
  }
  
  // Set sidebar width with optional transition control
  function setSidebarWidth(width, enableTransition = true) {
    // Disable transitions during drag for smoothness
    if (!enableTransition) {
      app.style.transition = 'none';
    } else {
      app.style.transition = '';
    }
    
    app.style.setProperty('--sidebarW', width + 'px');
    
    // Auto-collapse when dragged to minimum width
    if (width <= minWidth) {
      app.classList.add('collapsed');
      toggleButton.setAttribute('aria-expanded', 'false');
    } else if (app.classList.contains('collapsed')) {
      app.classList.remove('collapsed');
      toggleButton.setAttribute('aria-expanded', 'true');
    }
  }
  
  // Throttle function for smooth resize
  function throttle(func, limit) {
    let inThrottle;
    return function() {
      const args = arguments;
      const context = this;
      if (!inThrottle) {
        func.apply(context, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    }
  }
  
  // Optimized resize handler
  const handleResize = throttle((e) => {
    if (!isResizing) return;
    
    const deltaX = e.clientX - startX;
    const newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
    
    setSidebarWidth(newWidth, false); // Disable transition during drag
  }, 16); // ~60fps
  
  // Mouse down on resize handle
  resizeHandle.addEventListener('mousedown', (e) => {
    isResizing = true;
    startX = e.clientX;
    startWidth = getCurrentSidebarWidth();
    
    // Prevent text selection during resize
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'ew-resize';
    
    // Add resizing class for additional styling if needed
    app.classList.add('is-resizing');
    
    e.preventDefault();
  });
  
  // Mouse move - resize sidebar
  document.addEventListener('mousemove', handleResize);
  
  // Mouse up - stop resizing
  document.addEventListener('mouseup', () => {
    if (isResizing) {
      isResizing = false;
      document.body.style.userSelect = '';
      document.body.style.cursor = '';
      
      // Re-enable transitions
      app.classList.remove('is-resizing');
      setSidebarWidth(getCurrentSidebarWidth(), true);
      
      // Save the new width to localStorage for persistence
      const currentWidth = getCurrentSidebarWidth();
      if (currentWidth > minWidth) {
        localStorage.setItem('sidebarWidth', currentWidth);
      }
    }
  });
  
  // Touch support for mobile devices
  const handleTouchResize = throttle((e) => {
    if (!isResizing || e.touches.length !== 1) return;
    
    const touch = e.touches[0];
    const deltaX = touch.clientX - startX;
    const newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
    
    setSidebarWidth(newWidth, false);
  }, 16);
  
  resizeHandle.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
      const touch = e.touches[0];
      isResizing = true;
      startX = touch.clientX;
      startWidth = getCurrentSidebarWidth();
      app.classList.add('is-resizing');
      e.preventDefault();
    }
  });
  
  document.addEventListener('touchmove', handleTouchResize);
  
  document.addEventListener('touchend', () => {
    if (isResizing) {
      isResizing = false;
      app.classList.remove('is-resizing');
      setSidebarWidth(getCurrentSidebarWidth(), true);
      
      const currentWidth = getCurrentSidebarWidth();
      if (currentWidth > minWidth) {
        localStorage.setItem('sidebarWidth', currentWidth);
      }
    }
  });
  
  // Restore saved sidebar width and collapsed state on page load
  const savedWidth = localStorage.getItem('sidebarWidth');
  const savedCollapsed = localStorage.getItem('cl_sidebar_collapsed');
  
  if (savedCollapsed === '1') {
    // Restore collapsed state
    app.classList.add('collapsed');
    sidebar.classList.add('collapsed');
    toggleButton.setAttribute('aria-expanded', 'false');
    setSidebarWidth(minWidth);
  } else if (savedWidth) {
    // Restore saved width
    const width = parseInt(savedWidth);
    if (width >= minWidth && width <= maxWidth) {
      setSidebarWidth(width);
    }
  }
  
  // Modify the existing toggle button behavior to work with resize
  toggleButton.addEventListener('click', function() {
    if (app.classList.contains('collapsed')) {
      // Expanding - restore to saved width or default
      const savedWidth = localStorage.getItem('sidebarWidth');
      const targetWidth = savedWidth ? parseInt(savedWidth) : defaultWidth;
      setSidebarWidth(targetWidth);
      app.classList.remove('collapsed');
      sidebar.classList.remove('collapsed');
      toggleButton.setAttribute('aria-expanded', 'true');
    } else {
      // Collapsing - save current width first
      const currentWidth = getCurrentSidebarWidth();
      if (currentWidth > minWidth) {
        localStorage.setItem('sidebarWidth', currentWidth);
      }
      setSidebarWidth(minWidth);
      app.classList.add('collapsed');
      sidebar.classList.add('collapsed');
      toggleButton.setAttribute('aria-expanded', 'false');
    }
    
    // Save collapsed state to localStorage
    try{ 
      localStorage.setItem("cl_sidebar_collapsed", app.classList.contains("collapsed") ? "1" : "0"); 
    } catch(_) {}
  });
});

// Help system functionality
const pageHelp = {
  'view-dashboard': {
    title: 'Dashboard Overview',
    content: 'Your central command center providing a comprehensive overview of your practice\'s CQC readiness. Monitor key metrics, view upcoming tasks, track compliance status, and quickly access areas that need attention. The dashboard displays real-time data across all compliance areas including training, safety checks, and documentation status.'
  },
  'view-training': {
    title: 'Mandatory Training Matrix',
    content: 'Track and manage mandatory training requirements for all staff members. View training completion status, expiry dates, and compliance levels across different training categories. Ensure all staff maintain current certifications and identify who needs training updates. Generate training reports and manage training records to meet CQC requirements for staff competency.'
  },
  'view-pre-inspection': {
    title: '2-Week Notice Email',
    content: 'When CQC announces an inspection, you have just two weeks notice. This page helps you prepare the required documentation packages quickly and efficiently. Upload and organize documents into the nine email packages that CQC requires, ensure all information is current and relevant, then export everything with a single click. Stay inspection-ready with organized, up-to-date documentation.'
  },
  'view-users': {
    title: 'User Management',
    content: 'Manage staff accounts, roles, and permissions for your CheckLoop system. Add new team members, assign appropriate access levels (Admin or Staff), and maintain security by managing user credentials. Control who can access sensitive compliance data and administrative functions.'
  },
  'view-calendar': {
    title: 'Compliance Calendar',
    content: 'Visual overview of all compliance-related activities, deadlines, and scheduled tasks. Track safety checks, training renewals, equipment servicing, and other time-sensitive compliance activities. Never miss critical deadlines with automated reminders and clear visual indicators of upcoming requirements.'
  },
  'view-complaints-dashboard': {
    title: 'Complaints Dashboard',
    content: 'Monitor and analyze complaint trends, response times, and resolution patterns. CQC expects excellent complaint handling with swift responses and clear resolution processes. Track active complaints, view resolution statistics, and ensure you meet the required response timeframes for regulatory compliance.'
  },
  'view-complaints-reporting': {
    title: 'Complaints Reporting',
    content: 'Report and document new complaints with detailed information capture. Record complaint details, assign responsibility, track investigation progress, and document resolutions. Maintain comprehensive records that demonstrate proper complaint handling procedures to CQC inspectors.'
  },
  'view-items': {
    title: 'Equipment & Asset Management',
    content: 'Maintain detailed records of all practice equipment, medical devices, and assets. Track serial numbers, maintenance schedules, calibration dates, and warranty information. Ensure all equipment meets safety standards and compliance requirements for CQC inspections.'
  },
  'view-rooms': {
    title: 'Room & Location Management',
    content: 'Organize and manage different areas within your practice. Define rooms, assign equipment and staff, track room-specific compliance requirements, and maintain location-based safety and maintenance records. Essential for practices with multiple consultation rooms or specialized treatment areas.'
  },
  'view-checktypes': {
    title: 'Check Type Configuration',
    content: 'Define and customize the types of safety checks, equipment tests, and compliance verifications required in your practice. Set up standardized check procedures, assign frequencies, and create templates to ensure consistent compliance monitoring across all areas of your practice.'
  },
  'view-schedules': {
    title: 'Compliance Schedules',
    content: 'Create and manage recurring schedules for safety checks, equipment maintenance, training renewals, and other compliance activities. Automate routine tasks with intelligent scheduling that adapts to your practice needs and ensures nothing is overlooked.'
  },
  'view-staff': {
    title: 'Staff Records',
    content: 'Comprehensive staff management including personal details, qualifications, training records, and compliance status. Maintain complete staff files with DBS checks, professional registrations, emergency contacts, and role-specific requirements. Essential for CQC staff-related compliance.'
  },
  'view-submissions': {
    title: 'Compliance Submissions',
    content: 'Track all submissions made to regulatory bodies, insurance companies, and other organizations. Maintain records of when documents were submitted, to whom, and for what purpose. Monitor response status and maintain audit trails for regulatory compliance.'
  },
  'view-settings': {
    title: 'System Configuration',
    content: 'Configure CheckLoop settings to match your practice requirements. Set up notification preferences, customize compliance thresholds, manage data retention policies, and configure integrations with other systems. Tailor the system to your specific operational needs.'
  },
  'view-quiz': {
    title: 'Quiz Management',
    content: 'Create and manage training quizzes and assessments for staff competency verification. Design custom questions, set pass marks, track completion rates, and generate competency reports. Ensure staff understand policies and procedures through regular assessment.'
  }
};

function showHelp(viewId) {
  const modal = document.getElementById('help-modal');
  const title = document.getElementById('help-modal-title');
  const body = document.getElementById('help-modal-body');
  
  const helpData = pageHelp[viewId];
  if (helpData) {
    title.textContent = helpData.title;
    body.textContent = helpData.content;
    modal.classList.add('show');
  }
}

function hideHelp() {
  document.getElementById('help-modal').classList.remove('show');
}

// Event listeners for help modal
document.getElementById('help-modal-close').addEventListener('click', hideHelp);
document.getElementById('help-modal').addEventListener('click', function(e) {
  if (e.target === this) hideHelp();
});

// Escape key closes modal
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('help-modal').classList.contains('show')) {
    hideHelp();
  }
});

// Project Management System
let projectTasks = [];
let editingTaskId = null;

// Simple HTML escaping function
function esc(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
}

// Initialize project management
document.addEventListener('DOMContentLoaded', () => {
  setupProjectManagementEventListeners();
  setupRightClickIssueTracker();
  
  // Initialize project management when the view becomes active
  const projectView = document.getElementById('view-project-management');
  if (projectView) {
    const observer = new MutationObserver(() => {
      if (projectView.classList.contains('active') && !projectView.dataset._loaded) {
        projectView.dataset._loaded = '1';
        console.log('Project management view activated, loading tasks...');
        loadProjectTasks();
      }
    });
    observer.observe(projectView, { attributes: true, attributeFilter: ['class'] });
    
    // If already active on load, initialize immediately
    if (projectView.classList.contains('active')) {
      console.log('Project management view active on load, loading tasks...');
      loadProjectTasks();
    }
  }
});

function setupProjectManagementEventListeners() {
  // Add task button
  const addTaskBtn = document.getElementById('btn-add-task');
  if (addTaskBtn) {
    addTaskBtn.addEventListener('click', () => openTaskModal());
  }
  
  // Filter tabs
  const filterTabs = document.querySelectorAll('[data-filter]');
  filterTabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
      // Handle features button toggle for done/completed filter
      if (e.target.id === 'tab-features') {
        const currentHideDone = e.target.dataset.hideDone === 'true';
        e.target.dataset.hideDone = currentHideDone ? 'false' : 'true';
        
        // Update button text to indicate filter state
        if (e.target.dataset.hideDone === 'true') {
          e.target.textContent = '✨ Features (Open)';
        } else {
          e.target.textContent = '✨ Features';
        }
      }
      
      // Update active tab
      filterTabs.forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      
      const filter = e.target.dataset.filter;
      const hideDone = e.target.dataset.hideDone === 'true';
      filterTasks(filter, hideDone);
    });
  });
  
  // Highlight issues toggle
  const highlightToggle = document.getElementById('highlight-issues-toggle');
  if (highlightToggle) {
    highlightToggle.addEventListener('change', (e) => {
      toggleIssueHighlighting(e.target.checked);
    });
  }

  // Row navigation: clicking a task navigates to its page and highlights target element
  const tbody = document.getElementById('project-tasks-tbody');
  if (tbody) {
    tbody.addEventListener('click', (e) => {
      const row = e.target.closest('tr[data-task-id]');
      if (!row) return;
      // Ignore clicks on controls
      if (e.target.closest('button, .btn, input[type="checkbox"], a, code')) return;
      const id = row.getAttribute('data-task-id');
      const task = projectTasks.find(t => String(t.id) === String(id));
      if (!task) return;
      navigateToTaskTarget(task);
    });
  }

  // Bulk selection functionality
  const selectAllCheckbox = document.getElementById('select-all-tasks');
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.task-select');
      checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
      });
      updateBulkActionsVisibility();
    });
  }

  // Individual checkbox selection
  document.addEventListener('change', (e) => {
    if (e.target.classList.contains('task-select')) {
      updateBulkActionsVisibility();
      updateSelectAllState();
    }
  });

  // Bulk action buttons
  document.getElementById('bulk-copy-btn')?.addEventListener('click', bulkCopyTasks);
  document.getElementById('bulk-delete-btn')?.addEventListener('click', bulkDeleteTasks);
  document.getElementById('clear-selection-btn')?.addEventListener('click', clearTaskSelection);

  // Toggle completed items visibility using event delegation
  document.addEventListener('click', (e) => {
    if (e.target && (e.target.id === 'toggle-completed-btn' || e.target.id === 'toggle-completed-filter')) {
      toggleCompletedVisibility();
    }
  });
}

// Helper functions for bulk operations
function updateBulkActionsVisibility() {
  const selectedCheckboxes = document.querySelectorAll('.task-select:checked');
  const bulkBar = document.getElementById('bulk-actions-bar');
  const selectedCount = document.getElementById('selected-count');
  
  if (selectedCheckboxes.length > 0) {
    bulkBar.style.display = 'flex';
    selectedCount.textContent = selectedCheckboxes.length;
  } else {
    bulkBar.style.display = 'none';
  }
}

function updateSelectAllState() {
  const allCheckboxes = document.querySelectorAll('.task-select');
  const checkedCheckboxes = document.querySelectorAll('.task-select:checked');
  const selectAllCheckbox = document.getElementById('select-all-tasks');
  
  if (allCheckboxes.length === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  } else if (checkedCheckboxes.length === allCheckboxes.length) {
    selectAllCheckbox.checked = true;
    selectAllCheckbox.indeterminate = false;
  } else if (checkedCheckboxes.length > 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = true;
  } else {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  }
}

function clearTaskSelection() {
  const checkboxes = document.querySelectorAll('.task-select');
  checkboxes.forEach(checkbox => checkbox.checked = false);
  document.getElementById('select-all-tasks').checked = false;
  updateBulkActionsVisibility();
}

async function bulkDeleteTasks() {
  const selectedCheckboxes = document.querySelectorAll('.task-select:checked');
  const selectedIds = Array.from(selectedCheckboxes).map(cb => Number(cb.dataset.taskId));
  if (selectedIds.length === 0) return;

  const confirmed = confirm(`Are you sure you want to delete ${selectedIds.length} task(s)? This action cannot be undone.`);
  if (!confirmed) return;

  try {
    if (!window.supabase) throw new Error('Supabase not initialized');
    if (!ctx || !ctx.site_id) throw new Error('Site context not available');

    // Perform a single bulk delete in the database
    const { error } = await supabase
      .from('project_issues')
      .delete()
      .eq('site_id', ctx.site_id)
      .in('id', selectedIds);

    if (error) throw error;

    // Update local cache and UI
    projectTasks = projectTasks.filter(t => !selectedIds.includes(String(t.id)));
    showToast(`${selectedIds.length} task(s) deleted successfully!`, 'success');
    clearTaskSelection();
    await loadProjectTasks();
  } catch (error) {
    console.error('Error deleting tasks:', error);
    showToast('Error deleting tasks. Please try again.', 'error');
  }
}

function bulkCopyTasks() {
  const selectedCheckboxes = document.querySelectorAll('.task-select:checked');
  const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.taskId);
  const selectedTasks = projectTasks.filter(task => selectedIds.includes(String(task.id)));
  
  if (selectedTasks.length === 0) return;
  
  const prompt = buildBulkCopilotPrompt(selectedTasks);
  copyTextToClipboard(prompt).then(success => {
    if (success) {
      showToast(`Copied ${selectedTasks.length} task(s) to clipboard`, 'success');
    } else {
      showToast('Could not copy to clipboard', 'error');
    }
  });
}

function buildBulkCopilotPrompt(tasks) {
  const lines = [];
  
  // Opening instruction
  lines.push('Hi — please do this:');
  lines.push('');
  
  // Add each task in the specified format
  tasks.forEach((task, index) => {
    const { base, notes } = splitNotes(task.description || '');
    const status = task.status || 'open';
    const type = task.type || 'task';
    
    lines.push(`Task: ${task.title || 'Untitled'} (${type}, ${status})`);
    
    // Extract element details from description
    const elementMatch = base.match(/Element:\s*([^\n]+)/);
    const textMatch = base.match(/Text:\s*([^\n]+)/);
    
    if (elementMatch) lines.push(`Details: Element: ${elementMatch[1].trim()}`);
    if (textMatch) lines.push(`Text: ${textMatch[1].trim()}`);
    if (notes.trim()) lines.push(`Reporter notes: ${notes}`);
    if (task.page) lines.push(`Page: ${task.page}`);
    if (task.element_selector) lines.push(`Selector: ${task.element_selector}`);
    lines.push(`ID: ${task.id}`);
    if (task.created_at) lines.push(`Created: ${task.created_at}`);
    lines.push('');
  });
  
  lines.push('Use `SupabaseInfo.txt` (in this repo) to understand how the tables are laid out.');
  lines.push('Only if you need to dig deeper or make amendments to Supabase, use the Supabase CLI.');
  lines.push('');
  
  lines.push('Apply the fix in this repository, then verify the result:');
  lines.push('- Open http://127.0.0.1:58156/index.html in Chromium browser.');
  lines.push('- You will be directed to home.html login page automatically');
  lines.push('- Log in with email: ben.howard@stoke.nhs.uk');
  lines.push('- Password: Hello1!');
  lines.push('- Navigate to the relevant page (may be hidden under collapsed menu items in left navigation)');
  lines.push('- Reproduce the issue and confirm the fix works.');
  lines.push('- If it does not work, iterate and try again until it is fixed.');
  lines.push('- You must open the browser in Chromium to test. Open at the start to see the issue and after each iteration to confirm.');
  lines.push('- IMPORTANT: When taking screenshots, they must be under 5MB. If screenshots exceed this limit, either use another method or take smaller screenshots (e.g., 4 screenshots of each corner rather than one full screenshot).');
  lines.push('');
  
  lines.push('When done, simply list which of the to do items have been completed.');
  lines.push('');
  lines.push('If multiple tasks are sent, please work through them in order double checking that all tasks have been completed before finishing.');
  
  return lines.join('\n');
}

// Global state for completed items visibility
let hideCompletedTasks = false;

function toggleCompletedVisibility() {
  hideCompletedTasks = !hideCompletedTasks;
  const headerButton = document.getElementById('toggle-completed-btn');
  const filterButton = document.getElementById('toggle-completed-filter');
  
  console.log('Toggle completed visibility:', hideCompletedTasks); // Debug log
  
  // Update button appearances based on state
  if (hideCompletedTasks) {
    // Header button
    if (headerButton) {
      headerButton.textContent = '🙈'; // Hidden
      headerButton.title = 'Show completed items';
    }
    // Filter button
    if (filterButton) {
      filterButton.textContent = '🙈 Hide Completed';
      filterButton.title = 'Show completed items';
    }
  } else {
    // Header button
    if (headerButton) {
      headerButton.textContent = '👁️'; // Visible
      headerButton.title = 'Hide completed items';
    }
    // Filter button
    if (filterButton) {
      filterButton.textContent = '👁️ Show All';
      filterButton.title = 'Hide completed items';
    }
  }
  
  // Re-render tasks with current filter
  const activeFilter = document.querySelector('[data-filter].active');
  if (activeFilter) {
    const filter = activeFilter.dataset.filter;
    const hideDone = activeFilter.dataset.hideDone === 'true';
    filterTasks(filter, hideDone);
  } else {
    renderProjectTasks();
  }
  
  // Show a toast notification to confirm the action
  if (typeof showToast === 'function') {
    showToast(hideCompletedTasks ? 'Completed tasks hidden' : 'Completed tasks shown', 'info');
  }
}

// Navigate to the task's page and highlight the target element
function navigateToTaskTarget(task) {
  try {
    // Switch section reliably
    if (typeof setActiveSection === 'function' && task.page) {
      setActiveSection(task.page);
    } else if (task.page) {
      const btn = document.querySelector(`#sidebar .nav button[data-section="${task.page}"]`);
      if (btn) btn.click();
    }

    const selector = task.element_selector;
    if (!selector) return;

    // Expand any relevant collapsed panels for the page
    const maybeExpandForSelector = (page, sel) => {
      if (page === 'pre-inspection') {
        // Ensure main PIR progress block is open
        const pirMain = document.getElementById('pir-progress-main');
        const pirToggle = document.getElementById('pir-progress-toggle');
        if (pirMain && pirMain.classList.contains('collapsed') && pirToggle) {
          pirMain.classList.remove('collapsed');
          pirToggle.setAttribute('aria-expanded', 'true');
          const svg = pirToggle.querySelector('svg');
          if (svg) svg.style.transform = 'rotate(0deg)';
          try { localStorage.setItem('pir_progress_collapsed', '0'); } catch {}
        }
        // If aiming for email status, ensure that is open too
        if (sel && sel.includes('email-status')) {
          const circles = document.getElementById('email-status-circles');
          if (circles && circles.classList.contains('collapsed')) {
            circles.classList.remove('collapsed');
            try { localStorage.setItem('email_status_collapsed', '0'); } catch {}
          }
        }
      }
    };

    // Poll for the element because some sections render async
    const waitForElement = async (sel, { timeout = 6000, interval = 120 } = {}) => {
      const start = Date.now();
      let el = document.querySelector(sel);
      while (!el && Date.now() - start < timeout) {
        maybeExpandForSelector(task.page, sel);
        await new Promise(r => setTimeout(r, interval));
        el = document.querySelector(sel);
      }
      return el || null;
    };

    (async () => {
      const el = await waitForElement(selector);
      if (!el) {
        safeToast('Could not find the target element on that page', 'error');
        return;
      }
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      const prevBox = el.style.boxShadow;
      const prevOutline = el.style.outline;
      el.style.outline = '2px solid #0d6efd';
      el.style.boxShadow = '0 0 0 6px rgba(13,110,253,0.2)';
      setTimeout(() => {
        el.style.outline = prevOutline;
        el.style.boxShadow = prevBox;
      }, 2000);
    })();
  } catch (e) {
    console.error('Navigation error', e);
  }
}

function openTaskModal(taskId = null) {
  // Create modal dynamically if it doesn't exist
  let modal = document.getElementById('project-task-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'project-task-modal';
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content" style="width: 600px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h3 id="task-modal-title">Add New Task</h3>
          <button class="btn secondary modal-close" style="padding: 4px 8px;">&times;</button>
        </div>
        
        <form id="project-task-form">
          <div class="field">
            <label for="task-title">What needs to be done? *</label>
            <input type="text" id="task-title" placeholder="e.g. Fix login button, Add user dashboard, etc..." required>
          </div>
          
          <div class="field">
            <label for="task-description">More details (optional)</label>
            <textarea id="task-description" rows="3" placeholder="Any extra notes or details..."></textarea>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="field">
              <label for="task-type">Type *</label>
              <select id="task-type" required>
                <option value="">What kind of task?</option>
                <option value="bug">🐛 Bug Fix</option>
                <option value="feature">✨ New Feature</option>
              </select>
            </div>
            
            <div class="field">
              <label for="task-status">Status *</label>
              <select id="task-status" required>
                <option value="open">📝 To Do</option>
                <option value="closed">✅ Done</option>
              </select>
            </div>
          </div>
          
          <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
            <button type="button" class="btn secondary modal-close">Cancel</button>
            <button type="submit" class="btn">Save Task</button>
          </div>
        </form>
      </div>
    `;
    document.body.appendChild(modal);
    
    // Modal event handlers
    modal.addEventListener('click', (e) => {
      if (e.target === modal || e.target.classList.contains('modal-close')) {
        closeTaskModal();
      }
    });
    
    // Add form submit handler
    const form = modal.querySelector('#project-task-form');
    if (form) {
      form.addEventListener('submit', handleTaskSubmit);
    }
  }
  
  // Always get fresh references to elements
  const title = document.getElementById('task-modal-title');
  const form = document.getElementById('project-task-form');
  
  editingTaskId = taskId;
  
  if (taskId) {
    // Edit mode
    title.textContent = 'Edit Task';
    const task = projectTasks.find(t => t.id === taskId);
    if (task) {
      document.getElementById('task-title').value = task.title;
      document.getElementById('task-description').value = task.description || '';
      document.getElementById('task-type').value = task.type;
      document.getElementById('task-status').value = task.status;
    }
  } else {
    // Add mode
    title.textContent = 'Add New Task';
    form.reset();
    document.getElementById('task-status').value = 'open'; // Default status
  }
  
  modal.classList.add('show');
}

function closeTaskModal() {
  const modal = document.getElementById('project-task-modal');
  if (modal) {
    modal.classList.remove('show');
  }
  editingTaskId = null;
}

async function handleTaskSubmit(e) {
  e.preventDefault();
  console.log('Form submitted!');
  
  const formData = {
    title: document.getElementById('task-title').value.trim(),
    description: document.getElementById('task-description').value.trim(),
    type: document.getElementById('task-type').value,
    status: document.getElementById('task-status').value
  };
  
  console.log('Form data:', formData);
  
  try {
    if (editingTaskId) {
      console.log('Updating task:', editingTaskId);
      await updateTask(editingTaskId, formData);
      showToast('Task updated!', 'success');
    } else {
      console.log('Creating new task');
      await createTask(formData);
      showToast('Task created!', 'success');
    }
    
    closeTaskModal();
    await loadProjectTasks();
  } catch (error) {
    console.error('Error saving task:', error);
    showToast('Error saving task. Please try again.', 'error');
  }
}

async function createTask(taskData) {
  console.log('createTask called with:', taskData);

  if (!window.supabase) {
    console.error('Supabase not initialized');
    throw new Error('Supabase not initialized');
  }

  // Best-effort get auth/user + site context (both nullable in schema)
  let userId = (window.ctx && ctx.user_id) ? ctx.user_id : null;
  try {
    if (!userId && supabase.auth?.getUser) {
      const { data: authData } = await supabase.auth.getUser();
      userId = authData?.user?.id || null;
    }
  } catch { /* non-fatal */ }

  const siteId = (window.ctx && ctx.site_id) ? ctx.site_id : null; // site_id is nullable in schema

  // Map our task data to the project_issues table structure
  const issueData = {
    site_id: siteId,
    type: taskData.type, // Only 'bug' or 'feature' allowed by database
    title: taskData.title,
    description: taskData.description || null,
    status: taskData.status === 'closed' ? 'closed' : 'open',
    element_selector: taskData.element_selector || null,
    page: taskData.page || null,
    created_by: userId
  };

  console.log('Inserting into database:', issueData);

  const { data, error } = await supabase
    .from('project_issues')
    .insert([issueData])
    .select()
    .single();

  if (error) {
    console.error('Database error:', error);
    throw error;
  }

  console.log('Task created successfully:', data);

  // Add to local cache
  projectTasks.push(data);
}

async function updateTask(taskId, updates) {
  if (!window.supabase) throw new Error('Supabase not initialized');
  if (!ctx || !ctx.site_id) throw new Error('Site context not available');

  // Map status updates
  let nextStatus = undefined;
  if (typeof updates.status !== 'undefined') {
    if (updates.status === true || updates.status === 'completed' || updates.status === 'closed') nextStatus = 'closed';
    else if (updates.status === false || updates.status === 'open' || updates.status === 'todo') nextStatus = 'open';
  }
  const mappedUpdates = { ...updates };
  if (nextStatus) mappedUpdates.status = nextStatus;
  
  // Add closed_at and closed_by if marking as completed
  if (mappedUpdates.status === 'closed') {
    mappedUpdates.closed_at = new Date().toISOString();
    mappedUpdates.closed_by = ctx.user_id;
  } else {
    mappedUpdates.closed_at = null;
    mappedUpdates.closed_by = null;
  }

  const { data, error } = await supabase
    .from('project_issues')
    .update(mappedUpdates)
    .eq('id', taskId)
    .eq('site_id', ctx.site_id)
    .select()
    .single();

  if (error) throw error;

  // Update local cache
  const taskIndex = projectTasks.findIndex(t => t.id === taskId);
  if (taskIndex !== -1) {
    projectTasks[taskIndex] = data;
  }
}

async function deleteTask(taskId) {
  if (confirm('Are you sure you want to delete this task?')) {
    if (!window.supabase) throw new Error('Supabase not initialized');
    if (!ctx || !ctx.site_id) throw new Error('Site context not available');

    const { error } = await supabase
      .from('project_issues')
      .delete()
      .eq('id', taskId)
      .eq('site_id', ctx.site_id);

    if (error) throw error;

    // Remove from local cache
    projectTasks = projectTasks.filter(t => t.id !== taskId);
    await loadProjectTasks();
    showToast('Task deleted successfully!', 'success');
  }
}

async function loadProjectTasks() {
  try {
    console.log('loadProjectTasks called');
    
    if (!window.supabase) {
      console.error('Supabase not initialized');
      throw new Error('Supabase not initialized');
    }
    
    if (!ctx || !ctx.site_id) {
      console.warn('Site context not available yet, showing empty state');
      // Show empty state instead of error
      projectTasks = [];
      renderProjectTasks();
      updateProjectStats();
      return;
    }

    console.log('Loading tasks for site:', ctx.site_id);

    const { data, error } = await supabase
      .from('project_issues')
      .select('*')
      .eq('site_id', ctx.site_id)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Database error loading tasks:', error);
      throw error;
    }

    console.log('Loaded tasks from database:', data);
    projectTasks = data || [];
    renderProjectTasks();
    updateProjectStats();
    
    // Mark completed tasks as done
    markCompletedTasks();
  } catch (error) {
    console.error('Error loading project tasks:', error);
    showToast('Error loading tasks', 'error');
  }
}

// Function to mark the completed tasks as done
async function markCompletedTasks() {
  try {
    // Define the completed tasks based on the fixes implemented
    const completedTaskIdentifiers = [
      { 
        text: '✨ Features', 
        element: 'button',
        selector: '#tab-features',
        page: 'project-management',
        description: 'Add a button or filter to filter out done and completed tasks'
      },
      {
        text: 'Bulk Upload',
        element: 'button', 
        selector: '#pir-bulk-upload',
        page: 'pre-inspection',
        description: 'remove the bulk upload button and all associated code. I dont want this feature'
      },
      {
        text: 'input',
        element: 'input',
        selector: '#field-pir-last_updated', 
        page: 'pre-inspection',
        description: 'This date field looks odd, it\'s not filling the box and I dont like the style. Redo it, and default it Tod today always.'
      }
    ];
    
    // Find and update matching tasks
    for (const identifier of completedTaskIdentifiers) {
      const matchingTasks = projectTasks.filter(task => 
        task.status !== 'closed' && (
          (task.title && task.title.includes(identifier.text)) ||
          (task.element_text && task.element_text.includes(identifier.text)) ||
          (task.element_selector && task.element_selector === identifier.selector) ||
          (task.page === identifier.page && task.element_type === identifier.element)
        )
      );
      
      for (const task of matchingTasks) {
        console.log(`Marking task as completed: ${task.title || task.element_text}`);
        await updateTask(task.id, { status: 'closed' });
      }
    }
    
    // Refresh the tasks display after updates
    if (completedTaskIdentifiers.some(id => projectTasks.some(task => 
      task.status !== 'closed' && (
        (task.title && task.title.includes(id.text)) ||
        (task.element_text && task.element_text.includes(id.text)) ||
        (task.element_selector && task.element_selector === id.selector)
      )
    ))) {
      console.log('Refreshing tasks after marking as complete');
      await loadProjectTasks();
    }
    
  } catch (error) {
    console.error('Error marking completed tasks:', error);
  }
}

function renderProjectTasks(filteredTasks = null) {
  const tbody = document.getElementById('project-tasks-tbody');
  if (!tbody) return;
  
  let tasksToRender = filteredTasks || projectTasks;
  
  // Apply completed items filter if enabled
  if (hideCompletedTasks) {
    tasksToRender = tasksToRender.filter(task => task.status !== 'closed' && task.status !== 'completed');
  }
  
  if (tasksToRender.length === 0) {
  tbody.innerHTML = '<tr><td colspan="8" class="muted">No tasks found.</td></tr>';
    return;
  }
  
  tbody.innerHTML = tasksToRender.map((task, idx) => {
  const isClosed = task.status === 'closed';
  const statusIcon = isClosed ? '✅' : '🔴';
    const typeIcon = getTypeIcon(task.type);
    const isBug = task.type === 'bug';

    // Human-friendly labels
    const humanType = task.type === 'bug' ? 'Bug fix' : (task.type === 'feature' ? 'New idea' : (task.type || ''));
  const createdLabel = task.created_at ? `Created: ${formatDate(task.created_at)}` : '';

    // Extract optional comment from description (looks for a line starting with "Notes:")
    let baseDesc = task.description || '';
    let comment = '';
    if (typeof baseDesc === 'string') {
      const idx = baseDesc.indexOf('\nNotes:');
      if (idx !== -1) {
        comment = baseDesc.substring(idx + 7).trim();
        baseDesc = baseDesc.substring(0, idx).trim();
      }
    }

  // Extract element text and element name from baseDesc
  const textMatch = (typeof baseDesc === 'string') ? baseDesc.match(/(?:^|\n)Text:\s*(.+)/) : null;
  const elementText = textMatch ? textMatch[1].trim() : '';
  const elemMatch = (typeof baseDesc === 'string') ? baseDesc.match(/Element:\s*([^\n]+)/) : null;
  const elementName = elemMatch ? elemMatch[1].trim() : '';

  // Primary line should emphasize the idea/comment with the selected type
  const primaryLabel = humanType; // "Bug fix" or "New idea"
  const primaryContent = comment || elementText || elementName || task.title || '';

  // Build a compact meta line in smaller text
  const metaParts = [];
  if (elementName) metaParts.push(`Element: ${elementName}`);
  if (elementText) metaParts.push(`Text: ${elementText}`);
  if (createdLabel) metaParts.push(createdLabel);
  const metaLine = metaParts.join(' • ');
    
    const rowNumber = idx + 1;
  return `
      <tr class="${isBug ? 'task-issue-row' : ''}" data-task-id="${task.id}">
        <td style="text-align:center;">
          <input type="checkbox" class="task-select" data-task-id="${task.id}" />
        </td>
        <td class="muted" style="text-align:center;">${rowNumber}</td>
        <td style="text-align:center;">
          <input type="checkbox" ${isClosed ? 'checked' : ''} aria-label="Mark done" onclick="toggleTaskDone('${task.id}', this.checked)" />
        </td>
  <td role="button" style="cursor:pointer">
          <div class="status-indicator ${isClosed ? 'status-closed' : 'status-open'}" title="${task.status}" style="width:32px;height:32px;font-size:14px;">
            ${statusIcon}
          </div>
        </td>
  <td role="button" style="cursor:pointer">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span class="type-icon">${typeIcon}</span>
            <div>
        <div class="task-title">${esc(task.title)}</div>
              <div class="task-description" style="font-size: 13px; color: var(--text-color); margin-top: 2px;">
                ${primaryLabel ? `<strong>${esc(primaryLabel)}:</strong> ` : ''}${esc(primaryContent)}
              </div>
              ${metaLine ? `<div class=\"task-description\" style=\"font-size: 12px; color: var(--muted); margin-top: 4px;\">${esc(metaLine)}</div>` : ''}
              ${(task.page || task.element_selector) ? `
                <div class="task-description" style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                  ${task.page ? `Page: <strong>${esc(task.page)}</strong>` : ''}
                  ${task.page && task.element_selector ? ' • ' : ''}
                  ${task.element_selector ? `Selector: <code>${esc(task.element_selector)}</code>` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        </td>
        <td>
          <span class="task-type type-${task.type}">${esc(humanType || task.type)}</span>
        </td>
        <td class="muted">
          ${formatDate(task.created_at)}
        </td>
        <td>
          <div style="display: flex; gap: 4px;">
            <button class="btn-icon" onclick="openTaskModal('${task.id}')" title="Edit" style="background: none; border: none; cursor: pointer; padding: 4px;">
              ✏️
            </button>
            <button class="btn-icon" onclick="deleteTask('${task.id}')" title="Delete" style="background: none; border: none; cursor: pointer; padding: 4px;">
              🗑️
            </button>
            <button class="btn-icon btn-copy-copilot" data-task-id="${task.id}" title="Copy to Copilot" style="background: none; border: none; cursor: pointer; padding: 4px;">
              📋
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

// Toggle a task's completion via the checkbox
async function toggleTaskDone(taskId, checked) {
  try {
    // Optimistic update of local cache
    const tIdx = projectTasks.findIndex(t => t.id === taskId);
    if (tIdx !== -1) projectTasks[tIdx].status = checked ? 'closed' : 'open';
    renderProjectTasks();
    updateProjectStats();

    await updateTask(taskId, { status: checked ? 'completed' : 'open' });
    safeToast(checked ? 'Task marked complete' : 'Task reopened', 'success');
  } catch (e) {
    console.error('Failed to toggle task', e);
    safeToast('Could not update task status', 'error');
    // Revert checkbox UI if server failed
    const input = document.querySelector(`tr[data-task-id="${taskId}"] input[type="checkbox"]`);
    if (input) input.checked = !checked;
  }
}

function filterTasks(filter, hideDone = false) {
  if (filter === 'all') {
    renderProjectTasks();
  } else {
    let filtered = projectTasks.filter(task => task.type === filter);
    
    // If hideDone is true, filter out completed/closed tasks
    if (hideDone) {
      filtered = filtered.filter(task => task.status !== 'closed' && task.status !== 'completed');
    }
    
    renderProjectTasks(filtered);
  }
}

function updateProjectStats() {
  const total = projectTasks.length;
  const completed = projectTasks.filter(t => t.status === 'closed').length;
  const open = projectTasks.filter(t => t.status === 'open').length;
  const bugs = projectTasks.filter(t => t.type === 'bug').length;
  
  const totalEl = document.getElementById('tasks-total');
  const completedEl = document.getElementById('tasks-completed');
  const openEl = document.getElementById('tasks-open');
  const bugsEl = document.getElementById('tasks-bugs');
  
  if (totalEl) totalEl.textContent = total;
  if (completedEl) completedEl.textContent = completed;
  if (openEl) openEl.textContent = open;
  if (bugsEl) bugsEl.textContent = bugs;
}

function toggleIssueHighlighting(enabled) {
  const body = document.body;
  if (enabled) {
    body.classList.add('highlight-issues');
    // Add red background to bug rows
    const bugRows = document.querySelectorAll('.task-issue-row');
    bugRows.forEach(row => {
      row.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
      row.style.borderLeft = '3px solid var(--danger-color)';
    });
  } else {
    body.classList.remove('highlight-issues');
    // Remove red background from bug rows
    const bugRows = document.querySelectorAll('.task-issue-row');
    bugRows.forEach(row => {
      row.style.backgroundColor = '';
      row.style.borderLeft = '';
    });
  }
}

function getStatusIcon(status) {
  const icons = {
    'todo': '⏳',
    'in-progress': '🔄',
    'testing': '🧪',
    'completed': '✅'
  };
  return icons[status] || '❓';
}

function getTypeIcon(type) {
  const icons = {
    'feature': '✨',
    'page': '📄',
    'bug': '🐛',
    'issue': '⚠️',
    'enhancement': '⬆️',
    'maintenance': '🔧'
  };
  return icons[type] || '📝';
}

// --- Copilot prompt helpers ---
function splitNotes(description = '') {
  if (typeof description !== 'string') return { base: '', notes: '' };
  const idx = description.indexOf('\nNotes:');
  if (idx === -1) return { base: description.trim(), notes: '' };
  return { base: description.substring(0, idx).trim(), notes: description.substring(idx + 7).trim() };
}

function buildCopilotPrompt(task) {
  const { base, notes } = splitNotes(task.description || '');
  const lines = [];

  // Opening instruction
  lines.push('Hi — please do this:');
  lines.push('');

  // Task details in the specified format
  const status = task.status || 'open';
  const type = task.type || 'task';
  lines.push(`Task: ${task.title || '(no title)'} (${type}, ${status})`);
  
  // Extract element details from description
  const elementMatch = base.match(/Element:\s*([^\n]+)/);
  const textMatch = base.match(/Text:\s*([^\n]+)/);
  
  if (elementMatch) lines.push(`Details: Element: ${elementMatch[1].trim()}`);
  if (textMatch) lines.push(`Text: ${textMatch[1].trim()}`);
  if (notes) lines.push(`Reporter notes: ${notes}`);
  if (task.page) lines.push(`Page: ${task.page}`);
  if (task.element_selector) lines.push(`Selector: ${task.element_selector}`);
  lines.push(`ID: ${task.id}`);
  if (task.created_at) lines.push(`Created: ${task.created_at}`);
  lines.push('');

  // Supabase guidance
  lines.push('Use `SupabaseInfo.txt` (in this repo) to understand how the tables are laid out.');
  lines.push('Only if you need to dig deeper or make amendments to Supabase, use the Supabase CLI.');
  lines.push('');

  // Action + verification loop
  lines.push('Apply the fix in this repository, then verify the result:');
  lines.push('');
  lines.push('IMPORTANT: ALWAYS use browser automation for testing, never just open browsers manually.');
  lines.push('');
  lines.push('Required Steps for Testing:');
  lines.push('1. Install Playwright if not available: `npm install playwright && npx playwright install chromium`');
  lines.push('2. Create automated test script using this template:');
  lines.push('   ```javascript');
  lines.push('   import { chromium } from \'playwright\';');
  lines.push('   ');
  lines.push('   async function testFix() {');
  lines.push('     const browser = await chromium.launch({ headless: false });');
  lines.push('     const page = await browser.newPage();');
  lines.push('     ');
  lines.push('     // Login flow');
  lines.push('     await page.goto(\'http://127.0.0.1:58156/index.html\');');
  lines.push('     await page.locator(\'#email\').fill(\'ben.howard@stoke.nhs.uk\');');
  lines.push('     await page.locator(\'input[type="password"]\').fill(\'Hello1!\');');
  lines.push('     await page.click(\'button:has-text("Sign In")\');');
  lines.push('     await page.waitForTimeout(3000);');
  lines.push('     ');
  lines.push('     // Navigate to section being tested');
  lines.push('     await page.click(\'button[data-section="SECTION_NAME"]\');');
  lines.push('     ');
  lines.push('     // Verify fix with screenshots');
  lines.push('     await page.screenshot({ path: \'test_result.png\' });');
  lines.push('     ');
  lines.push('     await browser.close();');
  lines.push('   }');
  lines.push('   ```');
  lines.push('3. Run automated test to verify changes work');
  lines.push('4. Take screenshots for verification (must be under 5MB each)');
  lines.push('5. Report results with evidence');
  lines.push('');
  lines.push('Key Testing Notes:');
  lines.push('- NEVER mark testing as complete without actually running automated tests');
  lines.push('- ALWAYS take before/after screenshots using Playwright');
  lines.push('- ALWAYS verify the specific issue is resolved');
  lines.push('- ALWAYS log in properly to test authenticated features');
  lines.push('- Use proper selectors: #email for email input, input[type="password"] for password');
  lines.push('- Wait for elements and navigation with appropriate timeouts');
  lines.push('- Navigate using button[data-section="SECTION_NAME"] for main navigation');
  lines.push('');
  lines.push('Manual Testing Reference (use only if automation fails):');
  lines.push('- Open http://127.0.0.1:58156/index.html in Chromium browser');
  lines.push('- You will be directed to home.html login page automatically');
  lines.push('- Log in with email: ben.howard@stoke.nhs.uk');
  lines.push('- Password: Hello1!');
  lines.push('- Navigate to the relevant page (may be hidden under collapsed menu items in left navigation)');
  lines.push('- Reproduce the issue and confirm the fix works');
  lines.push('- If it does not work, iterate and try again until it is fixed');
  lines.push('');

  lines.push('When done, simply list which of the to do items have been completed.');

  return lines.join('\n');
}

async function copyTextToClipboard(text) {
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text);
      return true;
    }
  } catch (e) {
    // fall through to execCommand
  }
  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.top = '-1000px';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    return ok;
  } catch (e) {
    return false;
  }
}

// Wire Copy-to-Copilot clicks using event delegation on the tasks table
(function wireCopyToCopilot(){
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-copy-copilot');
    if (!btn) return;
    const id = btn.getAttribute('data-task-id');
    const task = projectTasks.find(t => String(t.id) === String(id));
    if (!task) return;
    const prompt = buildCopilotPrompt(task);
    const ok = await copyTextToClipboard(prompt);
    if (ok) {
      const title = (task && task.title) ? `“${task.title}”` : 'task';
      if (typeof safeToast === 'function') safeToast(`Copied prompt for ${title} to clipboard`, 'success');
    } else {
      if (typeof safeToast === 'function') safeToast('Could not copy prompt to clipboard', 'error');
    }
  });
})();

function getPriorityColor(priority) {
  const colors = {
    'low': '#28a745',
    'medium': '#ffc107', 
    'high': '#fd7e14',
    'critical': '#dc3545'
  };
  return colors[priority] || 'var(--muted)';
}

function formatDate(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', { 
    day: '2-digit', 
    month: 'short', 
    year: 'numeric' 
  });
}

function safeToast(msg, type='info') {
  if (typeof showToast === 'function') {
    try { showToast(msg, type); } catch { console.log(`[${type}] ${msg}`); }
  } else {
    console.log(`[${type}] ${msg}`);
  }
}

// Right-click context menu system for issue tracking
let contextMenuTarget = null;

function setupRightClickIssueTracker() {
  // Create context menu element
  const contextMenu = document.createElement('div');
  contextMenu.id = 'issue-context-menu';
  contextMenu.className = 'context-menu';
  contextMenu.innerHTML = `
    <div class="context-menu-item" id="add-to-issues">
      🐛 Add to Issue Tracker
    </div>
  `;
  contextMenu.style.cssText = `
    position: fixed;
    background: var(--panel-bg, white);
    border: 1px solid var(--border-color, #ccc);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    padding: 4px 0;
    min-width: 180px;
    display: none;
  `;
  
  const menuItem = contextMenu.querySelector('#add-to-issues');
  menuItem.style.cssText = `
    padding: 8px 16px;
    cursor: pointer;
    color: var(--white, #333);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  `;
  
  document.body.appendChild(contextMenu);
  
  // Right-click event listener
  document.addEventListener('contextmenu', (e) => {
    // Only show on elements that can be tracked (buttons, inputs, divs, etc)
    const target = e.target;
    const isTrackableElement = target.tagName && 
      ['BUTTON', 'INPUT', 'DIV', 'SPAN', 'A', 'IMG', 'SELECT', 'TEXTAREA', 'LABEL', 'TD', 'TH'].includes(target.tagName);
    
    if (isTrackableElement && !target.closest('.context-menu')) {
      e.preventDefault();
      contextMenuTarget = target;
      
      // Position the menu
      contextMenu.style.left = e.pageX + 'px';
      contextMenu.style.top = e.pageY + 'px';
      contextMenu.style.display = 'block';
      
      // Adjust position if menu would go off screen
      setTimeout(() => {
        const rect = contextMenu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
          contextMenu.style.left = (e.pageX - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
          contextMenu.style.top = (e.pageY - rect.height) + 'px';
        }
      }, 0);
    }
  });
  
  // Click to close context menu
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.context-menu')) {
      contextMenu.style.display = 'none';
      contextMenuTarget = null;
    }
  });
  
  // Context menu item click (use mousedown to avoid focus loss)
  menuItem.addEventListener('mousedown', async (ev) => {
    ev.preventDefault();
    ev.stopPropagation();
    if (contextMenuTarget) {
      try {
        // Capture target before any global click handlers clear it
        const targetEl = contextMenuTarget;
        // Close the menu immediately
        contextMenu.style.display = 'none';
        contextMenuTarget = null;
        // Ask for type and optional notes before creating the issue
        const details = await promptIssueDetails({ x: ev.pageX, y: ev.pageY });
        if (!details) return; // cancelled
        await addElementToIssueTracker(targetEl, details.type, details.notes);
      } catch (err) {
        console.error('Context menu add failed:', err);
        (window.showToast ? showToast('Failed to add to issue tracker', 'error') : alert('Failed to add to issue tracker'));
      }
    }
  });
  
  // Hover effects for menu item
  menuItem.addEventListener('mouseenter', () => {
    menuItem.style.backgroundColor = 'var(--border-color, #f0f0f0)';
  });
  
  menuItem.addEventListener('mouseleave', () => {
    menuItem.style.backgroundColor = 'transparent';
  });
}

async function addElementToIssueTracker(element, chosenType = 'bug', notes = '') {
  try {
    // Generate a unique selector for the element
    const selector = generateElementSelector(element);
    
    // Get element info
    const tagName = element.tagName.toLowerCase();
    const text = getElementText(element);
    const elementType = getElementType(element);
    
  // Create a descriptive title
  const base = `${elementType}: ${text ? text.substring(0, 50) + (text.length > 50 ? '...' : '') : tagName}`;
  const titlePrefix = (chosenType === 'feature') ? 'Idea' : 'Fix';
  const title = `${titlePrefix} ${base}`;
    
    // Get current page info
    const currentView = document.querySelector('.view.active');
    const pageName = currentView ? currentView.id.replace('view-', '') : 'unknown';
    
    // Map prompt type to DB type (bug fix -> 'bug', new idea -> 'feature')
    const dbType = (chosenType === 'feature') ? 'feature' : 'bug';

    const taskData = {
      title: title,
      description: `Element: ${tagName}${text ? `\nText: ${text}` : ''}${notes && notes.trim() ? `\nNotes: ${notes.trim()}` : ''}`,
      type: dbType,
      status: 'open',
      element_selector: selector,
      page: pageName
    };
    
    console.log('Adding element to issue tracker:', taskData);
    
  await createTask(taskData);
  safeToast(`Added "${title}" to issue tracker!`, 'success');
    
    // If we're on the project management page, refresh the list
    if (currentView && currentView.id === 'view-project-management') {
      if (!window.ctx || !ctx.site_id) {
        // No site context; render from local cache
        renderProjectTasks();
        updateProjectStats();
      } else {
        await loadProjectTasks();
      }
    }
    
  } catch (error) {
    console.error('Error adding element to issue tracker:', error);
    safeToast('Error adding to issue tracker', 'error');
  }
}

// Small inline prompt to collect type (bug fix/new idea) and optional notes
function promptIssueDetails({ x = window.innerWidth/2, y = window.innerHeight/2 } = {}) {
  return new Promise((resolve) => {
    // Overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed; inset: 0; background: rgba(0,0,0,0.2); z-index: 10001;
      display: flex; align-items: center; justify-content: center; padding: 16px;
    `;

    // Dialog
    const dialog = document.createElement('div');
    dialog.setAttribute('role', 'dialog');
    dialog.setAttribute('aria-modal', 'true');
    dialog.style.cssText = `
      background: var(--panel-bg, #fff);
      color: var(--text-color, #222);
      border: 1px solid var(--border-color, #ddd);
      border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      width: min(420px, 92vw);
      padding: 16px;
      font-size: 14px;
    `;
    dialog.innerHTML = `
      <div style="font-weight:600; margin-bottom: 12px;">Add to Issue Tracker</div>
      <div style="display:flex; flex-direction: column; gap: 10px;">
        <label style="display:flex; flex-direction: column; gap:6px;">
          <span>Type</span>
          <select id="issue-type-select" style="padding:8px; border:1px solid var(--border-color,#ddd); border-radius:8px;">
            <option value="bug" selected>Bug fix</option>
            <option value="feature">New idea</option>
          </select>
        </label>
        <label style="display:flex; flex-direction: column; gap:6px;">
          <span>Notes (optional)</span>
          <input id="issue-notes-input" type="text" placeholder="Add a short note" style="padding:8px; border:1px solid var(--border-color,#ddd); border-radius:8px;" />
        </label>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top: 6px;">
          <button id="issue-cancel-btn" style="padding:8px 12px; border:1px solid var(--border-color,#ddd); background: transparent; border-radius:8px; cursor:pointer;">Cancel</button>
          <button id="issue-add-btn" style="padding:8px 12px; border:0; background: var(--primary, #0d6efd); color:white; border-radius:8px; cursor:pointer;">Add</button>
        </div>
      </div>
    `;

    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    const typeSelect = dialog.querySelector('#issue-type-select');
    const notesInput = dialog.querySelector('#issue-notes-input');
    const cancelBtn = dialog.querySelector('#issue-cancel-btn');
    const addBtn = dialog.querySelector('#issue-add-btn');

    // Focus first field
    setTimeout(() => typeSelect.focus(), 0);

    const cleanup = () => {
      if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
    };

    const submit = () => {
      const type = typeSelect.value === 'feature' ? 'feature' : 'bug';
      const notes = notesInput.value || '';
      cleanup();
      resolve({ type, notes });
    };

    addBtn.addEventListener('click', (e) => { e.preventDefault(); submit(); });
    cancelBtn.addEventListener('click', (e) => { e.preventDefault(); cleanup(); resolve(null); });
    overlay.addEventListener('click', (e) => { if (e.target === overlay) { cleanup(); resolve(null); } });
    dialog.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { cleanup(); resolve(null); }
      if (e.key === 'Enter' && (document.activeElement === typeSelect || document.activeElement === notesInput)) {
        e.preventDefault(); submit();
      }
    });
  });
}

function generateElementSelector(element) {
  // Try to generate a useful CSS selector for the element
  const parts = [];
  
  // Add ID if present
  if (element.id) {
    return `#${element.id}`;
  }
  
  // Build selector with tag and classes
  let selector = element.tagName.toLowerCase();
  
  if (element.className && typeof element.className === 'string') {
    const classes = element.className.split(' ').filter(c => c.trim());
    if (classes.length > 0) {
      selector += '.' + classes.slice(0, 2).join('.');
    }
  }
  
  // Add parent context if needed
  const parent = element.parentElement;
  if (parent && parent.id) {
    selector = `#${parent.id} ${selector}`;
  }
  
  return selector;
}

function getElementText(element) {
  // Get meaningful text from the element
  let text = '';
  
  if (element.value) {
    text = element.value;
  } else if (element.textContent) {
    text = element.textContent.trim();
  } else if (element.alt) {
    text = element.alt;
  } else if (element.title) {
    text = element.title;
  } else if (element.placeholder) {
    text = element.placeholder;
  }
  
  return text.substring(0, 100); // Limit text length
}

function getElementType(element) {
  const tag = element.tagName.toLowerCase();
  const type = element.type;
  
  if (tag === 'button') return 'button';
  if (tag === 'input' && type === 'submit') return 'submit button';
  if (tag === 'input') return `${type || 'text'} input`;
  if (tag === 'select') return 'dropdown';
  if (tag === 'textarea') return 'textarea';
  if (tag === 'a') return 'link';
  if (tag === 'img') return 'image';
  if (tag === 'div' && element.className.includes('btn')) return 'button';
  if (tag === 'span' && element.className.includes('btn')) return 'button';
  
  return tag;
}

// PIR: wire email status collapse toggle and persist to localStorage
document.addEventListener('DOMContentLoaded', () => {
  try {
    // Overall progress main collapse
    const pirToggle = document.getElementById('pir-progress-toggle');
    const pirMain = document.getElementById('pir-progress-main');
    if (pirToggle && pirMain) {
      const pirKey = 'pir_progress_collapsed';
      const savedP = localStorage.getItem(pirKey);
      if (savedP === '1') {
        pirMain.classList.add('collapsed');
        pirToggle.setAttribute('aria-expanded', 'false');
        const svg = pirToggle.querySelector('svg');
        if (svg) svg.style.transform = 'rotate(-90deg)';
      }
      pirToggle.addEventListener('click', (e) => {
        e.preventDefault();
        const isCollapsed = pirMain.classList.toggle('collapsed');
        pirToggle.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
        const svg = pirToggle.querySelector('svg');
        if (svg) svg.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
        localStorage.setItem(pirKey, isCollapsed ? '1' : '0');
      });
    }

    // Email status section: always expanded now (toggle removed)
    const circles = document.getElementById('email-status-circles');
    if (circles) {
      circles.classList.remove('collapsed');
      try { localStorage.setItem('email_status_collapsed', '0'); } catch {}
    }
  } catch (err) { console.error('PIR toggle init error', err); }
});

/* Working Pattern Modal */
function openWorkingPatternModal(userId, fullName, roleDetail) {
  console.log('Opening working pattern modal for:', userId, fullName, roleDetail);
  
  const modal = document.getElementById('working-pattern-modal');
  if (!modal) {
    createWorkingPatternModal();
    return openWorkingPatternModal(userId, fullName, roleDetail);
  }

  // Set modal title
  document.getElementById('working-pattern-title').textContent = `Working Pattern - ${fullName}`;
  
  // Store current user data
  modal.dataset.userId = userId;
  modal.dataset.fullName = fullName;
  modal.dataset.roleDetail = roleDetail;
  
  // Load existing pattern
  loadWorkingPattern(userId);
  
  modal.classList.add('show');
}

function createWorkingPatternModal() {
  const modal = document.createElement('div');
  modal.id = 'working-pattern-modal';
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content" style="width: min(700px, 90vw);">
      <div class="modal-header">
        <h3 id="working-pattern-title">Working Pattern</h3>
        <button class="modal-close" onclick="closeWorkingPatternModal()">×</button>
      </div>
      <form id="working-pattern-form" onsubmit="saveWorkingPattern(event)">
        <div id="pattern-fields">
          <!-- Fields will be populated based on role -->
        </div>
        <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
          <button type="button" class="btn secondary" onclick="closeWorkingPatternModal()">Cancel</button>
          <button type="submit" class="btn">Save Pattern</button>
        </div>
      </form>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Close on click outside
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeWorkingPatternModal();
    }
  });
}

function closeWorkingPatternModal() {
  const modal = document.getElementById('working-pattern-modal');
  if (modal) {
    modal.classList.remove('show');
  }
}

async function loadWorkingPattern(userId) {
  const roleDetail = document.getElementById('working-pattern-modal').dataset.roleDetail;
  const isGP = roleDetail && roleDetail.toLowerCase().includes('gp');
  const fieldsContainer = document.getElementById('pattern-fields');
  
  // Create fields based on role
  if (isGP) {
    fieldsContainer.innerHTML = `
      <h4 style="margin-bottom: 16px;">GP Sessions Schedule</h4>
      <div class="working-pattern-grid">
        ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map(day => `
          <div class="day-input-group">
            <label class="day-label">${day}</label>
            ${createTimeInput(day.toLowerCase(), true)}
          </div>
        `).join('')}
      </div>
      <div class="hint" style="margin-top: 16px;">
        Set the working hours for each day. Sessions will be calculated based on hours (e.g., 08:00 means 8 sessions).
      </div>
    `;
  } else {
    fieldsContainer.innerHTML = `
      <h4 style="margin-bottom: 16px;">Staff Hours Schedule</h4>
      <div class="working-pattern-grid">
        ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map(day => `
          <div class="day-input-group">
            <label class="day-label">${day}</label>
            ${createTimeInput(day.toLowerCase(), false)}
          </div>
        `).join('')}
      </div>
      <div class="hint" style="margin-top: 16px;">
        Set the working hours for each day in HH:MM format (e.g., 07:30 for 7.5 hours). Use 00:00 for non-working days.
      </div>
    `;
  }
  
  // Load existing pattern from database
  try {
    console.log('Loading working pattern for user:', userId);
    const { data, error } = await supabase
      .from('master_users')
      .select('*')
      .eq('auth_user_id', userId)
      .maybeSingle(); // Use maybeSingle instead of single to avoid error when no record exists
    
    if (error && error.code !== 'PGRST116') { // PGRST116 is "no rows returned"
      console.error('Error loading working pattern:', error);
      showToast('Error loading existing pattern', 'warning');
      return;
    }
    
    if (data) {
      console.log('Found existing pattern:', data);
      // Populate fields with existing data
      ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
        const hoursKey = `${day}_hours`;
        const sessionsKey = `${day}_sessions`;
        
        if (isGP && data[sessionsKey] !== null && data[sessionsKey] !== undefined) {
          // For GPs, sessions are stored as integers, display as hours (e.g., 8 sessions = 08:00)
          const sessions = parseInt(data[sessionsKey]) || 0;
          setTimeInputValue(day, sessions, 0);
        } else if (!isGP && data[hoursKey] !== null && data[hoursKey] !== undefined) {
          // For staff, hours are stored as decimal (e.g., 7.5 hours = 07:30)
          const hours = parseFloat(data[hoursKey]) || 0;
          const wholeHours = Math.floor(hours);
          const minutes = Math.round((hours - wholeHours) * 60);
          setTimeInputValue(day, wholeHours, minutes);
        }
      });
    } else {
      console.log('No existing pattern found for user');
    }
  } catch (err) {
    console.error('Unexpected error loading working pattern:', err);
    showToast('Error loading working pattern', 'warning');
  }
}

function createTimeInput(day, isGP) {
  return `
    <div class="time-input-container" data-day="${day}">
      <div class="time-input">
        <div class="time-display" id="${day}-display">00:00</div>
      </div>
      <div class="time-controls">
        <div class="time-control-hours">
          <button type="button" class="time-arrow" onclick="adjustTime('${day}', 'hours', 1)">▲</button>
          <button type="button" class="time-arrow" onclick="adjustTime('${day}', 'hours', -1)">▼</button>
        </div>
        <div class="time-separator"></div>
        <div class="time-control-minutes">
          <button type="button" class="time-arrow" onclick="adjustTime('${day}', 'minutes', 15)">▲</button>
          <button type="button" class="time-arrow" onclick="adjustTime('${day}', 'minutes', -15)">▼</button>
        </div>
      </div>
    </div>
  `;
}

function adjustTime(day, unit, delta) {
  const display = document.getElementById(`${day}-display`);
  const currentTime = display.textContent;
  const [hours, minutes] = currentTime.split(':').map(Number);
  
  let newHours = hours;
  let newMinutes = minutes;
  
  if (unit === 'hours') {
    newHours = Math.max(0, Math.min(12, hours + delta));
  } else {
    newMinutes = minutes + delta;
    if (newMinutes >= 60) {
      newMinutes = 0;
      newHours = Math.min(12, hours + 1);
    } else if (newMinutes < 0) {
      newMinutes = 45;
      newHours = Math.max(0, hours - 1);
    }
  }
  
  setTimeInputValue(day, newHours, newMinutes);
}

function setTimeInputValue(day, hours, minutes) {
  const display = document.getElementById(`${day}-display`);
  if (display) {
    const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    display.textContent = formattedTime;
  }
}

function getTimeInputValue(day) {
  const display = document.getElementById(`${day}-display`);
  if (display) {
    const [hours, minutes] = display.textContent.split(':').map(Number);
    return hours + (minutes / 60); // Return as decimal hours
  }
  return 0;
}

async function saveWorkingPattern(event) {
  event.preventDefault();
  
  const modal = document.getElementById('working-pattern-modal');
  const userId = modal.dataset.userId;
  const roleDetail = modal.dataset.roleDetail;
  const isGP = roleDetail && roleDetail.toLowerCase().includes('gp');
  
  // Collect form data
  const patternData = { 
    user_id: userId,
    site_id: ctx.site_id // Include site_id for proper RLS
  };
  
  if (isGP) {
    // For GPs, store sessions as integers (e.g., 08:00 = 8 sessions)
    ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
      const value = getTimeInputValue(day);
      patternData[`${day}_sessions`] = Math.floor(value); // Only use hour part for sessions
      patternData[`${day}_hours`] = 0; // Set hours to 0 for GPs
    });
  } else {
    // For staff, store hours as decimal (e.g., 07:30 = 7.5 hours)
    ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
      const value = getTimeInputValue(day);
      patternData[`${day}_hours`] = value;
      patternData[`${day}_sessions`] = 0; // Set sessions to 0 for staff
    });
  }
  
  try {
    console.log('Saving working pattern:', patternData);
    
    // Use upsert to insert or update
    const { data, error } = await supabase
      .from('master_users')
      .upsert(patternData, { 
        onConflict: 'user_id',
        ignoreDuplicates: false 
      })
      .select();
    
    if (error) {
      console.error('Database error:', error);
      throw error;
    }
    
    console.log('Working pattern saved successfully:', data);
    showToast('Working pattern saved successfully!', 'success');
    closeWorkingPatternModal();
    refreshStaffData(); // Refresh the staff table
    
  } catch (error) {
    console.error('Error saving working pattern:', error);
    let errorMessage = 'Error saving working pattern. Please try again.';
    
    // Provide more specific error messages
    if (error.message?.includes('relation') && error.message?.includes('does not exist')) {
      errorMessage = 'Working patterns table not found. Please contact administrator.';
    } else if (error.message?.includes('permission denied')) {
      errorMessage = 'Permission denied. Please check your access rights.';
    } else if (error.message) {
      errorMessage = `Error: ${error.message}`;
    }
    
    showToast(errorMessage, 'error');
  }
}

async function refreshStaffData() {
  loadStaff();
}


// Simple toast notification function
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    z-index: 10000;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  
  // Set background color based on type
  switch(type) {
    case 'success':
      toast.style.backgroundColor = '#10b981';
      break;
    case 'error':
      toast.style.backgroundColor = '#ef4444';
      break;
    case 'warning':
      toast.style.backgroundColor = '#f59e0b';
      break;
    default:
      toast.style.backgroundColor = '#3b82f6';
  }
  
  toast.textContent = message;
  document.body.appendChild(toast);
  
  // Remove after 3 seconds
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// Make all staff management functions globally available
window.openWorkingPatternModal = openWorkingPatternModal;
window.closeWorkingPatternModal = closeWorkingPatternModal;
window.saveWorkingPattern = saveWorkingPattern;
window.refreshStaffData = refreshStaffData;

// Holiday Management Functions
(function() {
  // Toggle between card and table view for entitlements
  window.toggleEntitlementView = function() {
    const cardsContainer = document.getElementById('entitlements-cards-container');
    const tableWrap = document.getElementById('entitlements-table-wrap');
    const toggleText = document.getElementById('view-toggle-text');

    if (cardsContainer && tableWrap) {
      if (tableWrap.style.display === 'none') {
        tableWrap.style.display = 'block';
        cardsContainer.style.display = 'none';
        if (toggleText) toggleText.textContent = 'Show Card View';
      } else {
        tableWrap.style.display = 'none';
        cardsContainer.style.display = 'block';
        if (toggleText) toggleText.textContent = 'Show Table View';
      }
    }
  };

  // Function to fix RLS permissions for holiday requests
  window.fixHolidayRequestRLS = async function() {
    if (!window.supabase) {
      alert('Supabase not initialized');
      return;
    }

    try {
      console.log('Fixing holiday request RLS permissions...');

      // First, drop existing policies
      const dropQuery = `
        DROP POLICY IF EXISTS "admin_update_holiday_requests" ON public."4_holiday_requests";
      `;

      await window.supabase.rpc('exec_sql', { sql: dropQuery }).catch(() => {});

      // Create new admin update policy
      const createQuery = `
        ALTER TABLE IF EXISTS public."4_holiday_requests" ENABLE ROW LEVEL SECURITY;

        CREATE POLICY "admin_update_holiday_requests"
        ON public."4_holiday_requests"
        FOR UPDATE
        TO authenticated
        USING (
          EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id
            AND (raw_user_meta_data->>'role' = 'admin'
                OR raw_user_meta_data->>'admin_access' = 'true')
          )
        )
        WITH CHECK (
          EXISTS (
            SELECT 1 FROM auth.users
            WHERE auth.uid() = id
            AND (raw_user_meta_data->>'role' = 'admin'
                OR raw_user_meta_data->>'admin_access' = 'true')
          )
        );
      `;

      await window.supabase.rpc('exec_sql', { sql: createQuery });

      alert('Holiday request permissions fixed successfully! Admins can now approve or reject holiday requests.');

      // Reload the holiday requests
      loadHolidayRequests();
    } catch (error) {
      console.error('Error fixing holiday request RLS:', error);
      alert('Note: Permission fix requires database admin access. Contact your system administrator if the issue persists.');
    }
  };
  // Load entitlements when holidays section is shown (table view)
  async function loadHolidayEntitlements() {
    if (!window.supabase) return;

    try {
      // Get all holiday profiles with entitlements
      const { data: profiles } = await window.supabase
        .from('master_users')
        .select(`
          *,
          entitlements:2_staff_entitlements!staff_id(*)
        `)
        .eq('entitlements.year', new Date().getFullYear());

      const container = document.getElementById('entitlements-list');
      if (!container) return;

      if (!profiles || profiles.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--muted);">No staff holiday profiles found.</div>';
        return;
      }

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Staff Member</th>
              <th>Role</th>
              <th>Weekly</th>
              <th>Multiplier</th>
              <th>Calculated</th>
              <th>Manual Override</th>
              <th>Final Entitlement</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${profiles.map(profile => {
              const ent = profile.entitlements?.[0];
              if (!ent) return '';

              const isGP = profile.is_gp;
              const unit = isGP ? 'sessions' : 'hours';
              const weekly = isGP ? ent.weekly_sessions : ent.weekly_hours;
              const multiplier = ent.multiplier || 6;
              const calculated = isGP ? ent.calculated_sessions : ent.calculated_hours;
              const override = ent.override;
              const final = override || calculated;

              // Format hours as HH:MM for non-GP staff
              const formatValue = (val, isGP) => {
                if (isGP || !val) return val || 0;
                const hours = Math.floor(val);
                const minutes = Math.round((val - hours) * 60);
                return `${hours}:${String(minutes).padStart(2, '0')}`;
              };

              return `
                <tr>
                  <td>\${profile.full_name || 'Unknown'}</td>
                  <td>\${profile.access_type || profile.role || 'N/A'}</td>
                  <td>\${formatValue(weekly, isGP)} \${unit}/week</td>
                  <td>
                    <input type="number"
                           id="multiplier-\${ent.id}"
                           value="\${multiplier}"
                           min="1" max="52"
                           style="width:60px; padding:6px 8px; border-radius:6px; background:var(--glass); border:1px solid var(--border-color);"
                           onchange="updateMultiplier(\${ent.id}, \${profile.id}, \${isGP})">
                  </td>
                  <td id="calculated-\${ent.id}">\${formatValue(calculated, isGP)} \${unit}</td>
                  <td>
                    <input type="\${isGP ? 'number' : 'text'}"
                           id="override-${ent.id}"
                           value="${override ? (isGP ? override : formatValue(override, false)) : ''}"
                           placeholder="${isGP ? 'Override' : 'HH:MM'}"
                           pattern="${isGP ? '[0-9]*' : '[0-9]+:[0-5][0-9]'}"
                           style="width:80px; padding:6px 8px; border-radius:6px; background:var(--glass); border:1px solid var(--border-color);"
                           onchange="updateOverride(${ent.id}, ${isGP})">
                  </td>
                  <td id="final-${ent.id}"><strong>${formatValue(final, isGP)} ${unit}</strong></td>
                  <td>
                    <button class="btn secondary" style="padding:6px 12px; font-size:12px;" onclick="saveEntitlement(${ent.id}, ${isGP})">Save</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    } catch (error) {
      console.error('Error loading entitlements:', error);
    }
  }

  // Load holiday requests
  // Function to check for overlapping holidays for a specific request
  async function checkOverlapsForRequest(request) {
    try {
      // Get the user's site_id
      const { data: requestUser } = await window.supabase
        .from('master_users')
        .select('site_id')
        .eq('auth_user_id', request.user_id)
        .single();

      if (!requestUser || !requestUser.site_id) {
        return [];
      }

      // Get all users from the same site
      const { data: siteUsers } = await window.supabase
        .from('master_users')
        .select('auth_auth_auth_user_id, full_name, email, avatar_url')
        .eq('site_id', requestUser.site_id)
        .neq('auth_user_id', request.user_id); // Exclude the requesting user

      if (!siteUsers || siteUsers.length === 0) {
        return [];
      }

      // Get overlapping approved/pending requests
      const userIds = siteUsers.map(u => u.auth_user_id);
      console.log('[Admin Overlap Check] Checking for overlaps:', {
        requestStart: request.start_date,
        requestEnd: request.end_date,
        siteId: requestUser.site_id,
        userIds
      });

      // For date ranges to overlap: start_date <= request.end_date AND end_date >= request.start_date
      const { data: overlappingRequests, error: overlapError } = await window.supabase
        .from('4_holiday_requests')
        .select('*')
        .in('user_id', userIds)
        .in('status', ['approved', 'pending'])
        .lte('start_date', request.end_date)
        .gte('end_date', request.start_date);

      if (overlapError) {
        console.error('[Admin Overlap Check] Error querying overlaps:', overlapError);
      }
      console.log('[Admin Overlap Check] Found overlapping requests:', overlappingRequests);

      if (!overlappingRequests || overlappingRequests.length === 0) {
        return [];
      }

      // Map requests to users
      const overlaps = overlappingRequests.map(req => {
        const userInfo = siteUsers.find(u => u.auth_user_id === req.user_id);
        return {
          ...req,
          userName: userInfo?.full_name || userInfo?.email || 'Unknown User',
          avatarUrl: userInfo?.avatar_url || null
        };
      });

      return overlaps;
    } catch (error) {
      console.error('Error checking overlaps:', error);
      return [];
    }
  }

  async function loadHolidayRequests() {
    if (!window.supabase) return;

    try {
      // First try to get requests from the view that includes user data
      const { data: requestsWithUser, error: viewError } = await window.supabase
        .from('v_holiday_requests_with_user')
        .select('*')
        .order('requested_at', { ascending: false });
      
      let requests;
      
      if (viewError || !requestsWithUser) {
        console.log('View query failed, falling back to manual joins:', viewError);
        // Fallback to manual query if view isn't available
        const { data: rawRequests } = await window.supabase
          .from('4_holiday_requests')
          .select('*')
          .order('requested_at', { ascending: false });
          
        requests = rawRequests;
        
        // Then get profiles and holiday profiles with more complete data
        if (requests && requests.length > 0) {
          const userIds = [...new Set(requests.map(r => r.user_id))];

          // Get user data from master_users - use auth_user_id for correct join
          const { data: userProfiles } = await window.supabase
            .from('master_users')
            .select('auth_user_id, email, full_name, is_gp')
            .in('auth_user_id', userIds);

          // Create map for easier lookup
          const userMap = {};

          if (userProfiles) {
            userProfiles.forEach(p => {
              userMap[p.auth_user_id] = p;
            });
          }

          // Enhance requests with profile data
          requests.forEach(r => {
            const profile = userMap[r.user_id];

            if (profile) {
              r.email = profile.email;
              r.full_name = profile.full_name;
              r.is_gp = profile.is_gp;
            } else {
              r.email = 'Unknown';
              r.full_name = 'Unknown';
              r.is_gp = false;
            }
          });
        }
      } else {
        requests = requestsWithUser;
      }

      const container = document.getElementById('requests-list');
      if (!container) return;

      if (!requests || requests.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--muted);">No holiday requests found.</div>';
        return;
      }

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Staff Member</th>
              <th>Dates</th>
              <th>Amount</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${requests.map(req => {
              let amount;
              if (req.is_gp) {
                const sessions = req.total_days || 0;
                amount = `${sessions} ${sessions === 1 ? 'session' : 'sessions'}`;
              } else {
                const hours = Math.floor(req.total_days || 0);
                const minutes = Math.round(((req.total_days || 0) % 1) * 60);
                amount = `${hours}:${minutes.toString().padStart(2, '0')}`;
              }

              return `
                <tr>
                  <td>${req.full_name || req.email || 'Unknown'}</td>
                  <td>${new Date(req.start_date).toLocaleDateString()} - ${new Date(req.end_date).toLocaleDateString()}</td>
                  <td>${amount}</td>
                  <td>${req.reason || '-'}</td>
                  <td>
                    <span class="chip ${req.status === 'pending' ? 'warning' : req.status === 'approved' ? 'success' : 'danger'}">${req.status}</span>
                  </td>
                  <td>
                    ${req.status === 'pending' ? `
                      <div style="display:flex; gap:8px;">
                        <button class="btn secondary" style="padding:6px 12px; font-size:12px; background:var(--success);" onclick="approveRequestWithOverlapCheck(${req.id})">Approve</button>
                        <button class="btn secondary" style="padding:6px 12px; font-size:12px; background:var(--danger);" onclick="rejectRequest(${req.id})">Reject</button>
                      </div>
                    ` : '-'}
                  </td>
                </tr>
                <tr id="overlap-row-${req.id}" style="display:none;">
                  <td colspan="6" style="background: rgba(251,191,36,0.1); padding: 12px;">
                    <div id="overlap-content-${req.id}"></div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    } catch (error) {
      console.error('Error loading requests:', error);
    }
  }

  // Format hours as HH:MM
  function formatHours(decimal) {
    if (!decimal || isNaN(decimal)) return '0:00';
    const hours = Math.floor(decimal);
    const minutes = Math.round((decimal - hours) * 60);
    return `${hours}:${String(minutes).padStart(2, '0')}`;
  }

  // Parse HH:MM to decimal
  function parseHours(timeStr) {
    if (!timeStr || typeof timeStr !== 'string') return 0;
    const [h, m] = timeStr.split(':').map(Number);
    if (isNaN(h) || isNaN(m)) return 0;
    return h + (m / 60);
  }

  // Update multiplier
  window.updateMultiplier = async function(entId, profileId, isGP) {
    const multiplier = parseFloat(document.getElementById(`multiplier-${entId}`).value) || 6;

    if (!window.supabase) return;

    try {
      // Update the multiplier in the database (trigger will auto-calculate)
      const { error: updateError } = await window.supabase
        .from('2_staff_entitlements')
        .update({ multiplier: multiplier })
        .eq('id', entId);

      if (updateError) throw updateError;

      // Get the updated calculated values from the database
      const { data: ent } = await window.supabase
        .from('2_staff_entitlements')
        .select('calculated_hours, calculated_sessions, override')
        .eq('id', entId)
        .single();

      if (ent) {
        const calculated = isGP ? ent.calculated_sessions : ent.calculated_hours;

        // Update calculated display
        const calcEl = document.getElementById(`calculated-${entId}`);
        if (calcEl) {
          const unit = isGP ? 'sessions' : 'hours';
          calcEl.textContent = `${isGP ? calculated : formatHours(calculated)} ${unit}`;
        }

        // Update final if no override
        if (!ent.override) {
          const finalEl = document.getElementById(`final-${entId}`);
          if (finalEl) {
            const unit = isGP ? 'sessions' : 'hours';
            finalEl.innerHTML = `<strong>${isGP ? calculated : formatHours(calculated)} ${unit}</strong>`;
          }
        }
      }
    } catch (e) {
      console.error('Error updating multiplier:', e);
    }
  };

  // Update override value
  window.updateOverride = function(entId, isGP) {
    const overrideInput = document.getElementById(`override-${entId}`);
    const finalEl = document.getElementById(`final-${entId}`);
    const calcEl = document.getElementById(`calculated-${entId}`);

    if (overrideInput && finalEl) {
      const val = overrideInput.value;
      const unit = isGP ? 'sessions' : 'hours';

      if (val) {
        // Has override value
        if (isGP) {
          finalEl.innerHTML = `<strong>${val} ${unit}</strong>`;
        } else {
          // Validate HH:MM format for hours
          if (/^\d+:[0-5]\d$/.test(val)) {
            finalEl.innerHTML = `<strong>${val} ${unit}</strong>`;
          } else if (!isNaN(val)) {
            // If it's a number, format it as HH:MM
            finalEl.innerHTML = `<strong>${formatHours(parseFloat(val))} ${unit}</strong>`;
          }
        }
      } else {
        // No override, use calculated
        if (calcEl) {
          finalEl.innerHTML = `<strong>${calcEl.textContent}</strong>`;
        }
      }
    }
  };

  // Save entitlement
  window.saveEntitlement = async function(entId, isGP) {
    if (!window.supabase) return;

    const multiplier = parseFloat(document.getElementById(`multiplier-${entId}`).value) || 6;
    const overrideInput = document.getElementById(`override-${entId}`);
    const overrideValue = overrideInput.value;

    const updateData = {
      multiplier: multiplier,
      updated_at: new Date().toISOString()
    };

    // Handle override value
    if (overrideValue) {
      if (isGP) {
        updateData.override = parseFloat(overrideValue) || null;
      } else {
        // Parse HH:MM format or decimal hours
        if (/^\d+:[0-5]\d$/.test(overrideValue)) {
          updateData.override = parseHours(overrideValue);
        } else if (!isNaN(overrideValue)) {
          updateData.override = parseFloat(overrideValue);
        } else {
          updateData.override = null;
        }
      }
    } else {
      updateData.override = null;
    }

    try {
      const { error } = await window.supabase
        .from('2_staff_entitlements')
        .update(updateData)
        .eq('id', entId);

      if (error) throw error;

      // Show success message inline instead of alert
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'Saved!';
      btn.style.background = 'var(--success)';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);

      // Reload data
      loadHolidayEntitlements();
    } catch (error) {
      console.error('Error saving entitlement:', error);
      alert('Error saving entitlement: ' + error.message);
    }
  };

  // Approve request
  // Approve request with overlap check
  window.approveRequestWithOverlapCheck = async function(reqId) {
    if (!window.supabase) {
      alert('System not initialized. Please refresh the page.');
      return;
    }

    try {
      // First get the request details
      const { data: request } = await window.supabase
        .from('4_holiday_requests')
        .select('*')
        .eq('id', reqId)
        .single();

      if (!request) {
        alert('Request not found');
        return;
      }

      // Check for overlaps
      const overlaps = await checkOverlapsForRequest(request);

      if (overlaps.length > 0) {
        // Show overlaps
        const overlapRow = document.getElementById(`overlap-row-${reqId}`);
        const overlapContent = document.getElementById(`overlap-content-${reqId}`);

        if (overlapRow && overlapContent) {
          const overlapHTML = `
            <div style="color: #fbbf24; font-weight: 600; margin-bottom: 8px;">
              ⚠️ Warning: ${overlaps.length} staff member(s) from the same site have overlapping holidays:
            </div>
            ${overlaps.map(overlap => {
              const avatarHTML = overlap.avatarUrl
                ? `<img src="${overlap.avatarUrl}" alt="${overlap.userName}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 6px; vertical-align: middle;">`
                : `<span style="display: inline-block; width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); margin-right: 6px; vertical-align: middle; text-align: center; line-height: 24px; color: white; font-size: 11px; font-weight: bold;">${overlap.userName.charAt(0).toUpperCase()}</span>`;

              const statusBadge = overlap.status === 'approved'
                ? '<span style="background: #059669; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 6px;">Approved</span>'
                : '<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 6px;">Pending</span>';

              return `
                <div style="padding: 6px; margin: 4px 0; background: rgba(255,255,255,0.05); border-radius: 6px;">
                  ${avatarHTML}
                  <strong>${overlap.userName}</strong>
                  ${statusBadge}
                  <span style="color: #9ca3af; margin-left: 8px;">
                    ${new Date(overlap.start_date).toLocaleDateString()} - ${new Date(overlap.end_date).toLocaleDateString()}
                    ${overlap.reason ? `• ${overlap.reason}` : ''}
                  </span>
                </div>
              `;
            }).join('')}
            <div style="margin-top: 12px;">
              <button class="btn secondary" style="padding:6px 12px; font-size:12px; background:var(--success); margin-right: 8px;" onclick="approveRequest(${reqId})">Approve Anyway</button>
              <button class="btn secondary" style="padding:6px 12px; font-size:12px; background:var(--muted);" onclick="document.getElementById('overlap-row-${reqId}').style.display='none'">Cancel</button>
            </div>
          `;

          overlapContent.innerHTML = overlapHTML;
          overlapRow.style.display = 'table-row';
        }
      } else {
        // No overlaps, proceed with approval
        await approveRequest(reqId);
      }
    } catch (error) {
      console.error('Error checking overlaps:', error);
      // If overlap check fails, ask if they want to proceed anyway
      if (confirm('Could not check for overlaps. Do you want to approve anyway?')) {
        await approveRequest(reqId);
      }
    }
  };

  window.approveRequest = async function(reqId) {
    if (!window.supabase) {
      alert('System not initialized. Please refresh the page.');
      return;
    }

    try {
      // Get current user first
      const { data: { user }, error: userError } = await window.supabase.auth.getUser();
      
      if (userError) {
        console.error('User authentication error:', userError);
        alert('Authentication error. Please refresh and try again.');
        return;
      }

      if (!user) {
        alert('You must be logged in to approve requests.');
        return;
      }

      // Update the holiday request
      const { error } = await window.supabase
        .from('4_holiday_requests')
        .update({
          status: 'approved',
          approved_at: new Date().toISOString(),
          approved_by: user.id,
          updated_at: new Date().toISOString()
        })
        .eq('id', reqId);

      if (error) {
        console.error('Database update error:', error);
        throw error;
      }
      
      alert('Request approved successfully!');
      loadHolidayRequests();
    } catch (error) {
      console.error('Error approving request:', error);
      
      // Provide more specific error messages
      if (error.code === 'PGRST301') {
        const shouldFix = confirm('Permission denied. This might be a database permission issue. Would you like to attempt to fix the permissions automatically?');
        if (shouldFix) {
          try {
            await window.fixHolidayRequestRLS();
            // Try the approval again
            const { error: retryError } = await window.supabase
              .from('4_holiday_requests')
              .update({
                status: 'approved',
                approved_at: new Date().toISOString(),
                approved_by: user.id,
                updated_at: new Date().toISOString()
              })
              .eq('id', reqId);
            
            if (!retryError) {
              alert('Permission fixed and request approved successfully!');
              loadHolidayRequests();
              return;
            }
          } catch (fixError) {
            console.error('Failed to fix permissions:', fixError);
          }
        }
        alert('Permission denied. You may not have admin access to approve requests.');
      } else if (error.message?.includes('RLS')) {
        alert('Database permission error. Please contact your system administrator.');
      } else {
        alert('Error approving request: ' + (error.message || 'Unknown error'));
      }
    }
  };

  // Reject request
  window.rejectRequest = async function(reqId) {
    if (!window.supabase) {
      alert('System not initialized. Please refresh the page.');
      return;
    }

    const reason = prompt('Rejection reason (optional):');

    try {
      // Get current user first
      const { data: { user }, error: userError } = await window.supabase.auth.getUser();
      
      if (userError) {
        console.error('User authentication error:', userError);
        alert('Authentication error. Please refresh and try again.');
        return;
      }

      if (!user) {
        alert('You must be logged in to reject requests.');
        return;
      }

      // Update the holiday request
      const { error } = await window.supabase
        .from('4_holiday_requests')
        .update({
          status: 'rejected',
          notes: reason || 'Rejected by admin',
          updated_at: new Date().toISOString()
        })
        .eq('id', reqId);

      if (error) {
        console.error('Database update error:', error);
        throw error;
      }
      
      alert('Request rejected successfully.');
      loadHolidayRequests();
    } catch (error) {
      console.error('Error rejecting request:', error);
      
      // Provide more specific error messages
      if (error.code === 'PGRST301') {
        const shouldFix = confirm('Permission denied. This might be a database permission issue. Would you like to attempt to fix the permissions automatically?');
        if (shouldFix) {
          try {
            await window.fixHolidayRequestRLS();
            // Try the rejection again
            const { error: retryError } = await window.supabase
              .from('4_holiday_requests')
              .update({
                status: 'rejected',
                notes: reason || 'Rejected by admin',
                updated_at: new Date().toISOString()
              })
              .eq('id', reqId);
            
            if (!retryError) {
              alert('Permission fixed and request rejected successfully.');
              loadHolidayRequests();
              return;
            }
          } catch (fixError) {
            console.error('Failed to fix permissions:', fixError);
          }
        }
        alert('Permission denied. You may not have admin access to reject requests.');
      } else if (error.message?.includes('RLS')) {
        alert('Database permission error. Please contact your system administrator.');
      } else {
        alert('Error rejecting request: ' + (error.message || 'Unknown error'));
      }
    }
  };

  // Helper functions
  async function getWeeklyHours(profileId) {
    const { data } = await window.supabase
      .from('master_users')
      .select('monday_hours, tuesday_hours, wednesday_hours, thursday_hours, friday_hours')
      .eq('auth_user_id', profileId)
      .maybeSingle();

    if (!data) return 0;
    return Object.values(data).reduce((sum, h) => sum + (parseFloat(h) || 0), 0);
  }

  async function getWeeklySessions(profileId) {
    const { data } = await window.supabase
      .from('master_users')
      .select('monday_sessions, tuesday_sessions, wednesday_sessions, thursday_sessions, friday_sessions')
      .eq('auth_user_id', profileId)
      .maybeSingle();

    if (!data) return 0;
    return Object.values(data).reduce((sum, s) => sum + (parseFloat(s) || 0), 0);
  }

  // Listen for section changes
  document.addEventListener('section-changed', (e) => {
    if (e.detail === 'entitlement-management') {
      loadHolidayEntitlements();
      loadHolidayRequests();
      // Also load the card view
      if (typeof loadStaffEntitlementCards === 'function') {
        loadStaffEntitlementCards();
      }
    }
  });

  // Main holiday data loading function
  function loadHolidayData() {
    console.log('Loading holiday data...');
    loadHolidayEntitlements();
    loadHolidayRequests();
    // Also load the card view
    if (typeof loadStaffEntitlementCards === 'function') {
      loadStaffEntitlementCards();
    } else {
      console.log('loadStaffEntitlementCards function not yet available, retrying...');
      setTimeout(() => {
        if (typeof loadStaffEntitlementCards === 'function') {
          loadStaffEntitlementCards();
        }
      }, 1000);
    }
  }

  // Working hours loading function
  async function loadWorkingHours() {
    console.log('Loading working hours...');
    try {
      // First get working patterns
      const { data: patterns, error } = await supabase
        .from('master_users')
        .select('*');

      if (error) {
        console.error('Error loading working patterns:', error);
        return;
      }

      const container = document.getElementById('working-hours-list');
      if (!container) return;

      if (!patterns || patterns.length === 0) {
        container.innerHTML = '<p>No working patterns found.</p>';
        return;
      }

      // Get user profiles for the patterns
      const userIds = patterns.map(p => p.user_id).filter(Boolean);
      const { data: profiles } = await supabase
        .from('master_users')
        .select('auth_auth_user_id, email, full_name')
        .in('user_id', userIds);

      // Create a map of user_id to profile
      const profileMap = {};
      (profiles || []).forEach(p => {
        profileMap[p.user_id] = p;
      });

      container.innerHTML = patterns.map(pattern => {
        const profile = profileMap[pattern.user_id] || {};
        return `
        <div class="pattern-card" style="border:1px solid #ddd; padding:15px; margin-bottom:10px; border-radius:8px;">
          <h4>${profile.full_name || profile.email || 'User ' + pattern.user_id}</h4>
          <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-top:10px;">
            <div>Mon: ${pattern.monday_hours || 0}h</div>
            <div>Tue: ${pattern.tuesday_hours || 0}h</div>
            <div>Wed: ${pattern.wednesday_hours || 0}h</div>
            <div>Thu: ${pattern.thursday_hours || 0}h</div>
            <div>Fri: ${pattern.friday_hours || 0}h</div>
          </div>
          <div style="margin-top:10px; font-weight:600;">
            Total: ${
              (parseFloat(pattern.monday_hours || 0) +
               parseFloat(pattern.tuesday_hours || 0) +
               parseFloat(pattern.wednesday_hours || 0) +
               parseFloat(pattern.thursday_hours || 0) +
               parseFloat(pattern.friday_hours || 0)).toFixed(1)
            } hours/week
          </div>
        </div>
      `;
      }).join('');
    } catch (error) {
      console.error('Error in loadWorkingHours:', error);
    }
  }

  // Scheduling dashboard loading function
  function loadSchedulingDashboard() {
    console.log('Loading scheduling dashboard...');
    const container = document.getElementById('scheduling-dashboard');
    if (container) {
      const content = container.querySelector('.card');
      if (content) {
        content.innerHTML = `
          <h3>Schedule Overview</h3>
          <p>View and manage all scheduling activities.</p>
          <div style="margin-top:20px;">
            <button class="btn" onclick="setActiveSection('working-hours')">Manage Working Hours</button>
            <button class="btn" onclick="setActiveSection('entitlement-management')" style="margin-left:10px;">Manage Holidays</button>
          </div>
        `;
      }
    }
  }

  // Training Import Functions
  let trainingUploadData = [];
  let trainingTypes = [];

  async function loadTrainingImport() {
    console.log('Loading training import data...');

    // Load site users for matching
    await loadSiteUsers(); // Already defined for holiday import

    // Load training types
    await loadTrainingTypes();

    // Load statistics
    await loadTrainingStatistics();

    // Load existing records
    await loadTrainingRecords();

    // Setup file upload handlers
    setupTrainingUploadHandlers();
  }

  async function loadTrainingTypes() {
    try {
      const { data, error } = await supabase
        .from('training_types')
        .select('id, name')
        .eq('site_id', ctx.site_id)
        .eq('active', true)
        .order('name');

      if (error) throw error;

      trainingTypes = data || [];
      console.log('Loaded training types:', trainingTypes.length);
    } catch (error) {
      console.error('Failed to load training types:', error);
      trainingTypes = [];
    }
  }

  async function loadTrainingStatistics() {
    try {
      const { data, error } = await supabase
        .from('fuzzy_match_training')
        .select('match_status, type_validation_status')
        .eq('site_id', ctx.site_id);

      if (error) throw error;

      const stats = {
        pending: data.filter(d => d.match_status === 'pending').length,
        matched: data.filter(d => d.match_status === 'matched').length,
        transferred: data.filter(d => d.match_status === 'transferred').length,
        invalid: data.filter(d => d.type_validation_status === 'invalid').length,
        total: data.length
      };

      document.getElementById('training-stat-pending').textContent = stats.pending;
      document.getElementById('training-stat-matched').textContent = stats.matched;
      document.getElementById('training-stat-transferred').textContent = stats.transferred;
      document.getElementById('training-stat-invalid').textContent = stats.invalid;
      document.getElementById('training-stat-total').textContent = stats.total;
    } catch (error) {
      console.error('Failed to load training statistics:', error);
    }
  }

  async function loadTrainingRecords() {
    const tbody = document.getElementById('training-existing-tbody');

    try {
      const { data, error } = await supabase
        .from('fuzzy_match_training')
        .select('*')
        .eq('site_id', ctx.site_id)
        .order('created_at', { ascending: false });

      if (error) throw error;

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#718096;">No records found</td></tr>';
        return;
      }

      // Get user names and working patterns for matched records
      const matchedUserIds = data.filter(r => r.matched_user_id).map(r => r.matched_user_id);
      let userMap = {};
      let workingPatternMap = {};

      if (matchedUserIds.length > 0) {
        const { data: matchedUsers } = await supabase
          .from('master_users')
          .select(`
            id, auth_user_id, full_name, is_gp,
            monday_hours, tuesday_hours, wednesday_hours,
            thursday_hours, friday_hours, saturday_hours, sunday_hours,
            monday_sessions, tuesday_sessions, wednesday_sessions,
            thursday_sessions, friday_sessions, saturday_sessions, sunday_sessions
          `)
          .or(`id.in.(${matchedUserIds.join(',')}),auth_user_id.in.(${matchedUserIds.join(',')})`);

        if (matchedUsers) {
          matchedUsers.forEach(u => {
            // Map both id and auth_user_id to the full name and working patterns
            if (u.auth_user_id) {
              userMap[u.auth_user_id] = u.full_name;
              workingPatternMap[u.auth_user_id] = u;
            }
            if (u.id) {
              userMap[u.id] = u.full_name;
              workingPatternMap[u.id] = u;
            }
          });
        }
      }

      // Get working patterns for siteUsers too (for auto-matched records)
      const siteUserIds = siteUsers.map(u => u.user_id);
      if (siteUserIds.length > 0) {
        const { data: siteUserPatterns } = await supabase
          .from('master_users')
          .select(`
            id, auth_user_id, is_gp,
            monday_hours, tuesday_hours, wednesday_hours,
            thursday_hours, friday_hours, saturday_hours, sunday_hours,
            monday_sessions, tuesday_sessions, wednesday_sessions,
            thursday_sessions, friday_sessions, saturday_sessions, sunday_sessions
          `)
          .or(`id.in.(${siteUserIds.join(',')}),auth_user_id.in.(${siteUserIds.join(',')})`);

        if (siteUserPatterns) {
          siteUserPatterns.forEach(u => {
            if (u.auth_user_id && !workingPatternMap[u.auth_user_id]) {
              workingPatternMap[u.auth_user_id] = u;
            }
            if (u.id && !workingPatternMap[u.id]) {
              workingPatternMap[u.id] = u;
            }
          });
        }
      }

      let autoMatchCount = 0;
      let pendingCount = 0;

      tbody.innerHTML = data.map((record, index) => {
        const statusColor = {
          'pending': '#667eea',
          'matched': '#10b981',
          'transferred': '#3b82f6',
          'rejected': '#ef4444'
        }[record.match_status] || '#6b7280';

        const typeStatusColor = {
          'valid': '#10b981',
          'invalid': '#ef4444',
          'fuzzy_matched': '#f59e0b',
          'pending': '#6b7280'
        }[record.type_validation_status] || '#6b7280';

        // Find best matching user
        let bestMatchUserId = record.matched_user_id || '';
        if (!bestMatchUserId && record.match_status === 'pending') {
          pendingCount++;
          const exactMatch = siteUsers.find(u =>
            u.full_name.toLowerCase() === record.staff_name.toLowerCase()
          );
          if (exactMatch) {
            bestMatchUserId = exactMatch.user_id;
            autoMatchCount++;
          }
        }

        // Find best matching training type
        let bestTrainingTypeId = record.matched_training_type_id || '';
        let typeMatchConfidence = record.type_match_confidence || 0;
        if (!bestTrainingTypeId) {
          // Try exact match first
          const exactTypeMatch = trainingTypes.find(t =>
            t.name.toLowerCase() === record.training_type_name.toLowerCase()
          );
          if (exactTypeMatch) {
            bestTrainingTypeId = exactTypeMatch.id;
            typeMatchConfidence = 1.0;
          } else {
            // Try fuzzy match
            const fuzzyMatches = trainingTypes.map(t => ({
              id: t.id,
              name: t.name,
              similarity: calculateSimilarity(record.training_type_name.toLowerCase(), t.name.toLowerCase())
            })).filter(m => m.similarity > 0.5);

            if (fuzzyMatches.length > 0) {
              fuzzyMatches.sort((a, b) => b.similarity - a.similarity);
              bestTrainingTypeId = fuzzyMatches[0].id;
              typeMatchConfidence = fuzzyMatches[0].similarity;
            }
          }
        }

        // Generate user dropdown
        const userOptions = siteUsers.map(u =>
          `<option value="${u.user_id}" ${(record.matched_user_id === u.user_id || (!record.matched_user_id && bestMatchUserId === u.user_id)) ? 'selected' : ''}>
            ${esc(u.full_name)}${u.role_detail ? ' (' + esc(u.role_detail) + ')' : ''}
          </option>`
        ).join('');

        // Generate training type dropdown
        const typeOptions = trainingTypes.map(t =>
          `<option value="${t.id}" ${(record.matched_training_type_id === t.id || (!record.matched_training_type_id && bestTrainingTypeId === t.id)) ? 'selected' : ''}>
            ${esc(t.name)}
          </option>`
        ).join('');

        return `
          <tr data-record-id="${record.id}" data-status="${record.match_status}">
            <td>
              ${record.match_status === 'pending' ?
                `<input type="checkbox" class="training-record-checkbox" data-record-id="${record.id}"
                  style="width:16px; height:16px; cursor:pointer;">` :
                ''}
            </td>
            <td>
              ${esc(record.staff_name)}
              ${bestMatchUserId && record.match_status === 'pending' ?
                '<span style="color:#10b981; font-size:12px; margin-left:8px;" title="Name match found">✓</span>' :
                ''}
            </td>
            <td>
              ${esc(record.training_type_name)}
              ${typeMatchConfidence === 1 ?
                '<span style="color:#10b981; font-size:12px; margin-left:8px;" title="Exact match">✓</span>' :
                typeMatchConfidence > 0.7 ?
                '<span style="color:#f59e0b; font-size:12px; margin-left:8px;" title="Fuzzy match">≈</span>' :
                '<span style="color:#ef4444; font-size:12px; margin-left:8px;" title="No match">✗</span>'
              }
            </td>
            <td>
              ${record.match_status === 'transferred' ?
                `✅ Transferred` :
                `<select id="training-type-select-${record.id}" class="training-type-select" data-record-id="${record.id}"
                  style="padding:4px 8px; border-radius:4px; border:1px solid ${typeMatchConfidence > 0.7 ? '#10b981' : '#ef4444'};">
                  <option value="">Select Training Type...</option>
                  ${typeOptions}
                </select>`
              }
            </td>
            <td>${new Date(record.completion_date).toLocaleDateString()}</td>
            <td><span style="color:${statusColor}; font-weight:600;">${record.match_status}</span></td>
            <td>
              ${record.match_status === 'transferred' ?
                `✅ ${userMap[record.matched_user_id] || 'Transferred'}` :
                record.match_status === 'rejected' ?
                `❌ Rejected` :
                `<select id="training-user-select-${record.id}" class="training-user-select" data-record-id="${record.id}"
                  style="padding:4px 8px; border-radius:4px; border:1px solid ${bestMatchUserId ? '#10b981' : '#cbd5e0'};">
                  <option value="">Select User...</option>
                  ${userOptions}
                </select>`
              }
            </td>
            <td>${new Date(record.uploaded_at || record.created_at).toLocaleDateString()}</td>
            <td>
              ${record.match_status === 'pending' ?
                `<div style="display:flex; gap:4px;">
                  <button class="btn btn-sm" onclick="matchAndTransferTrainingRecord('${record.id}')"
                    style="background:linear-gradient(135deg, #667eea, #764ba2); padding:4px 8px;">
                    Match & Transfer
                  </button>
                  <button class="btn btn-sm" onclick="deleteTrainingRecord('${record.id}')"
                    style="background:#ef4444; padding:4px 8px;">
                    Delete
                  </button>
                </div>` :
                '-'}
            </td>
          </tr>
        `;
      }).join('');

      // Update match info
      const matchInfo = document.getElementById('training-match-info');
      if (matchInfo) {
        if (pendingCount > 0) {
          matchInfo.innerHTML = `<span style="color:#10b981;">✓ ${autoMatchCount} of ${pendingCount} pending records have automatic user matches</span>`;
        } else {
          matchInfo.innerHTML = '';
        }
      }
    } catch (error) {
      console.error('Failed to load training records:', error);
      tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; color:#ef4444;">Error loading records: ${error.message}</td></tr>`;
    }
  }

  function calculateSimilarity(s1, s2) {
    // Simple similarity calculation - could be improved with better algorithm
    const longer = s1.length > s2.length ? s1 : s2;
    const shorter = s1.length > s2.length ? s2 : s1;
    if (longer.length === 0) return 1.0;

    // Check if one string contains the other
    if (longer.includes(shorter)) {
      return shorter.length / longer.length;
    }

    // Calculate edit distance
    const editDistance = levenshteinDistance(s1, s2);
    return (longer.length - editDistance) / longer.length;
  }

  function levenshteinDistance(str1, str2) {
    const m = str1.length;
    const n = str2.length;
    const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;

    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        if (str1[i - 1] === str2[j - 1]) {
          dp[i][j] = dp[i - 1][j - 1];
        } else {
          dp[i][j] = Math.min(
            dp[i - 1][j] + 1,    // deletion
            dp[i][j - 1] + 1,    // insertion
            dp[i - 1][j - 1] + 1 // substitution
          );
        }
      }
    }
    return dp[m][n];
  }

  function setupTrainingUploadHandlers() {
    const uploadZone = document.getElementById('training-upload-zone');
    const fileInput = document.getElementById('training-file-input');

    if (uploadZone && fileInput) {
      uploadZone.addEventListener('click', () => fileInput.click());

      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = '#4c51bf';
        uploadZone.style.backgroundColor = 'rgba(102,126,234,0.1)';
      });

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.style.borderColor = '#667eea';
        uploadZone.style.backgroundColor = 'rgba(102,126,234,0.05)';
      });

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.style.borderColor = '#667eea';
        uploadZone.style.backgroundColor = 'rgba(102,126,234,0.05)';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleTrainingFileUpload(files[0]);
        }
      });

      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleTrainingFileUpload(e.target.files[0]);
        }
      });
    }
  }

  async function handleTrainingFileUpload(file) {
    const errorMsg = document.getElementById('training-error-message');
    const successMsg = document.getElementById('training-success-message');

    // Hide messages
    errorMsg.style.display = 'none';
    successMsg.style.display = 'none';

    if (!file.name.match(/\.(xlsx|xls)$/)) {
      errorMsg.textContent = 'Please upload an Excel file (.xlsx or .xls)';
      errorMsg.style.display = 'block';
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const workbook = XLSX.read(e.target.result, { type: 'binary' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet);

        // Validate and process data
        trainingUploadData = data.map(row => ({
          staff_name: row['Staff Name'] || row['Name'] || '',
          training_type_name: row['Training Type'] || '',
          completion_date: parseExcelDate(row['Completion Date'])
        })).filter(row => row.staff_name && row.training_type_name && row.completion_date);

        if (trainingUploadData.length === 0) {
          errorMsg.textContent = 'No valid data found in the Excel file';
          errorMsg.style.display = 'block';
          return;
        }

        // Validate training types
        trainingUploadData.forEach(row => {
          const exactMatch = trainingTypes.find(t =>
            t.name.toLowerCase() === row.training_type_name.toLowerCase()
          );
          if (exactMatch) {
            row.type_status = 'valid';
            row.type_match_confidence = 1.0;
            row.matched_type_id = exactMatch.id;
          } else {
            const similarity = Math.max(...trainingTypes.map(t =>
              calculateSimilarity(row.training_type_name.toLowerCase(), t.name.toLowerCase())
            ));
            if (similarity > 0.7) {
              row.type_status = 'fuzzy_matched';
              row.type_match_confidence = similarity;
            } else {
              row.type_status = 'invalid';
              row.type_match_confidence = 0;
            }
          }
        });

        // Show preview
        showTrainingPreview();
      } catch (error) {
        console.error('Error parsing Excel:', error);
        errorMsg.textContent = 'Failed to parse Excel file: ' + error.message;
        errorMsg.style.display = 'block';
      }
    };
    reader.readAsBinaryString(file);
  }

  function showTrainingPreview() {
    const preview = document.getElementById('training-data-preview');
    const tbody = document.getElementById('training-preview-tbody');

    tbody.innerHTML = trainingUploadData.slice(0, 10).map(row => {
      const statusColor = row.type_status === 'valid' ? '#10b981' :
                         row.type_status === 'fuzzy_matched' ? '#f59e0b' : '#ef4444';
      const statusText = row.type_status === 'valid' ? '✓ Valid' :
                        row.type_status === 'fuzzy_matched' ? '≈ Fuzzy Match' : '✗ Invalid';

      return `
        <tr>
          <td>${esc(row.staff_name)}</td>
          <td>${esc(row.training_type_name)}</td>
          <td><span style="color:${statusColor}; font-weight:600;">${statusText}</span></td>
          <td>${row.completion_date}</td>
        </tr>
      `;
    }).join('');

    if (trainingUploadData.length > 10) {
      tbody.innerHTML += `<tr><td colspan="4" style="text-align:center; color:#718096;">... and ${trainingUploadData.length - 10} more records</td></tr>`;
    }

    // Show warning if invalid types exist
    const invalidCount = trainingUploadData.filter(r => r.type_status === 'invalid').length;
    if (invalidCount > 0) {
      const warningDiv = document.createElement('div');
      warningDiv.className = 'alert alert-warning';
      warningDiv.style.margin = '10px 0';
      warningDiv.innerHTML = `⚠️ ${invalidCount} record(s) have invalid training type names. You can correct these after upload.`;
      preview.insertBefore(warningDiv, preview.querySelector('.data-table'));
    }

    preview.style.display = 'block';
  }

  async function confirmTrainingUpload() {
    const errorMsg = document.getElementById('training-error-message');
    const successMsg = document.getElementById('training-success-message');

    try {
      // Prepare data for upload
      const recordsToInsert = trainingUploadData.map(row => ({
        staff_name: row.staff_name,
        training_type_name: row.training_type_name,
        completion_date: row.completion_date,
        type_validation_status: row.type_status || 'pending',
        type_match_confidence: row.type_match_confidence || null,
        matched_training_type_id: row.matched_type_id || null,
        site_id: ctx.site_id,
        match_status: 'pending',
        uploaded_by: ctx.user.id
      }));

      // Insert into database
      const { data, error } = await supabase
        .from('fuzzy_match_training')
        .insert(recordsToInsert);

      if (error) throw error;

      // Success
      successMsg.textContent = `Successfully uploaded ${trainingUploadData.length} training records`;
      successMsg.style.display = 'block';

      // Reset UI
      document.getElementById('training-data-preview').style.display = 'none';
      document.getElementById('training-file-input').value = '';
      trainingUploadData = [];

      // Reload data
      await loadTrainingStatistics();
      await loadTrainingRecords();
    } catch (error) {
      console.error('Upload failed:', error);
      errorMsg.textContent = 'Upload failed: ' + error.message;
      errorMsg.style.display = 'block';
    }
  }

  function cancelTrainingUpload() {
    document.getElementById('training-data-preview').style.display = 'none';
    document.getElementById('training-file-input').value = '';
    trainingUploadData = [];
  }

  async function deleteTrainingRecord(id) {
    if (!confirm('Are you sure you want to delete this record?')) return;

    try {
      const { error } = await supabase
        .from('fuzzy_match_training')
        .delete()
        .eq('id', id)
        .eq('site_id', ctx.site_id);

      if (error) throw error;

      // Reload data
      await loadTrainingStatistics();
      await loadTrainingRecords();
    } catch (error) {
      console.error('Delete failed:', error);
      alert('Failed to delete record: ' + error.message);
    }
  }

  async function matchAndTransferTrainingRecord(recordId) {
    const userSelect = document.getElementById(`training-user-select-${recordId}`);
    const typeSelect = document.getElementById(`training-type-select-${recordId}`);

    const userId = userSelect?.value;
    const typeId = typeSelect?.value;

    if (!userId) {
      alert('Please select a user to match this record to');
      return;
    }

    if (!typeId) {
      alert('Please select a training type to match this record to');
      return;
    }

    const userName = userSelect.options[userSelect.selectedIndex].text.trim();
    const typeName = typeSelect.options[typeSelect.selectedIndex].text.trim();

    if (!confirm(`Transfer this training record to ${userName} for ${typeName}?`)) return;

    try {
      // Update the record with matches
      const { error: matchError } = await supabase
        .from('fuzzy_match_training')
        .update({
          matched_user_id: userId,
          matched_training_type_id: typeId,
          match_status: 'matched',
          matched_at: new Date().toISOString()
        })
        .eq('id', recordId)
        .eq('site_id', ctx.site_id);

      if (matchError) throw matchError;

      // Ensure we pass a UUID to the RPC. Some callers may provide a numeric profile id
      // (e.g. '46') instead of the auth.users UUID. Resolve numeric values to the
      // corresponding `user_id` from `siteUsers` where possible.
  const resolvedUserId = await resolveUserUuid(userId);

      // Transfer to training_records using the database function
      const { data: transferResult, error: transferError } = await supabase
        .rpc('transfer_fuzzy_training_to_record', {
          p_fuzzy_match_id: parseInt(recordId),
          p_user_id: resolvedUserId,
          p_training_type_id: typeId
        });

      if (transferError) throw transferError;

      // Success
      alert(`Training record successfully transferred to ${userName}`);

      // Reload data
      await loadTrainingStatistics();
      await loadTrainingRecords();
    } catch (error) {
      console.error('Match and transfer failed:', error);
      alert('Failed to match and transfer: ' + error.message);
    }
  }

  function downloadTrainingTemplate() {
    // Create workbook
    const wb = XLSX.utils.book_new();

    // Create sample data
    const data = [
      ['Staff Name', 'Training Type', 'Completion Date'],
      ['John Smith', 'Fire Safety', '2024-01-15'],
      ['Jane Doe', 'Manual Handling', '2024-02-20'],
      ['Example: Use exact training type names from the list', '', '']
    ];

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(data);

    // Set column widths
    ws['!cols'] = [
      { wch: 25 }, // Staff Name
      { wch: 30 }, // Training Type
      { wch: 15 }  // Completion Date
    ];

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Training Import Template');

    // Generate and download file
    XLSX.writeFile(wb, 'training_import_template.xlsx');
  }

  function downloadTrainingTypesList() {
    if (trainingTypes.length === 0) {
      alert('No training types available. Please ensure training types are configured for your site.');
      return;
    }

    // Create workbook
    const wb = XLSX.utils.book_new();

    // Create training types list
    const data = [
      ['Training Type Names - Use These Exact Names in Your Import'],
      [''],
      ...trainingTypes.map(t => [t.name])
    ];

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(data);

    // Set column width
    ws['!cols'] = [{ wch: 50 }];

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Training Types');

    // Generate and download file
    XLSX.writeFile(wb, 'training_types_list.xlsx');
  }

  // Bulk operations for training
  function toggleAllTrainingCheckboxes() {
    const selectAll = document.getElementById('training-select-all');
    const checkboxes = document.querySelectorAll('.training-record-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = selectAll.checked;
    });
  }

  function filterTrainingRecords() {
    const searchTerm = document.getElementById('training-search').value.toLowerCase();
    const rows = document.querySelectorAll('#training-existing-tbody tr');

    rows.forEach(row => {
      const nameCell = row.cells[1]; // Name is in the second column
      if (nameCell) {
        const name = nameCell.textContent.toLowerCase();
        if (name.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      }
    });
  }

  async function autoMatchAllTraining() {
    const pendingCount = document.querySelectorAll('tr[data-status="pending"]').length;

    if (pendingCount === 0) {
      alert('No pending records to match');
      return;
    }

    if (!confirm(`Auto-match ${pendingCount} pending record(s)?\n\nThis will match records where both names and training types have exact matches.`)) {
      return;
    }

    let matchedCount = 0;
    let failedCount = 0;
    const errors = [];

    const pendingRecords = document.querySelectorAll('tr[data-status="pending"]');

    for (const row of pendingRecords) {
      const recordId = row.dataset.recordId;
      const userSelect = document.getElementById(`training-user-select-${recordId}`);
      const typeSelect = document.getElementById(`training-type-select-${recordId}`);

      if (userSelect && userSelect.value && typeSelect && typeSelect.value) {
        try {
          // Update matches
          const { error: matchError } = await supabase
            .from('fuzzy_match_training')
            .update({
              matched_user_id: userSelect.value,
              matched_training_type_id: typeSelect.value,
              match_status: 'matched',
              matched_at: new Date().toISOString()
            })
            .eq('id', recordId)
            .eq('site_id', ctx.site_id);

          if (matchError) throw matchError;

          // Transfer
          // Resolve user UUID before calling RPC
          const resolvedUserId = await resolveUserUuid(userSelect.value);
          const { error: transferError } = await supabase
            .rpc('transfer_fuzzy_training_to_record', {
              p_fuzzy_match_id: parseInt(recordId),
              p_user_id: resolvedUserId,
              p_training_type_id: typeSelect.value
            });

          if (transferError) throw transferError;

          matchedCount++;
        } catch (error) {
          failedCount++;
          errors.push(`Record ${recordId}: ${error.message}`);
        }
      }
    }

    // Show results
    let message = `Auto-match complete!\n`;
    message += `✅ Successfully matched and transferred: ${matchedCount}\n`;
    if (failedCount > 0) {
      message += `❌ Failed: ${failedCount}\n`;
      if (errors.length > 0) {
        message += `\nErrors:\n${errors.slice(0, 5).join('\n')}`;
      }
    }
    alert(message);

    // Reload data
    await loadTrainingStatistics();
    await loadTrainingRecords();
  }

  async function matchSelectedTraining() {
    const selectedCheckboxes = document.querySelectorAll('.training-record-checkbox:checked');

    if (selectedCheckboxes.length === 0) {
      alert('Please select records to match');
      return;
    }

    // Validate all have users and types selected
    let missingInfo = [];
    selectedCheckboxes.forEach(cb => {
      const recordId = cb.dataset.recordId;
      const userSelect = document.getElementById(`training-user-select-${recordId}`);
      const typeSelect = document.getElementById(`training-type-select-${recordId}`);

      if (!userSelect || !userSelect.value || !typeSelect || !typeSelect.value) {
        const row = cb.closest('tr');
        const name = row.cells[1].textContent;
        missingInfo.push(name);
      }
    });

    if (missingInfo.length > 0) {
      alert(`Please select both user and training type for:\n${missingInfo.join('\n')}`);
      return;
    }

    if (!confirm(`Match and transfer ${selectedCheckboxes.length} selected record(s)?`)) {
      return;
    }

    let successCount = 0;
    let failedCount = 0;
    const errors = [];

    for (const checkbox of selectedCheckboxes) {
      const recordId = checkbox.dataset.recordId;
      const userSelect = document.getElementById(`training-user-select-${recordId}`);
      const typeSelect = document.getElementById(`training-type-select-${recordId}`);

      try {
        // Update matches
        const { error: matchError } = await supabase
          .from('fuzzy_match_training')
          .update({
            matched_user_id: userSelect.value,
            matched_training_type_id: typeSelect.value,
            match_status: 'matched',
            matched_at: new Date().toISOString()
          })
          .eq('id', recordId)
          .eq('site_id', ctx.site_id);

        if (matchError) throw matchError;

        // Transfer - resolve UUID if needed
  const resolvedUserId = await resolveUserUuid(userSelect.value);
        const { error: transferError } = await supabase
          .rpc('transfer_fuzzy_training_to_record', {
            p_fuzzy_match_id: parseInt(recordId),
            p_user_id: resolvedUserId,
            p_training_type_id: typeSelect.value
          });

        if (transferError) throw transferError;

        successCount++;
      } catch (error) {
        failedCount++;
        errors.push(`Record ${recordId}: ${error.message}`);
      }
    }

    // Show results
    let message = `Batch processing complete!\n`;
    message += `✅ Successfully matched and transferred: ${successCount}\n`;
    if (failedCount > 0) {
      message += `❌ Failed: ${failedCount}\n`;
      if (errors.length > 0) {
        message += `\nErrors:\n${errors.slice(0, 5).join('\n')}`;
      }
    }
    alert(message);

    // Reload data
    await loadTrainingStatistics();
    await loadTrainingRecords();
  }

  // Export training import functions
  window.loadTrainingImport = loadTrainingImport;
  window.confirmTrainingUpload = confirmTrainingUpload;
  window.cancelTrainingUpload = cancelTrainingUpload;
  window.deleteTrainingRecord = deleteTrainingRecord;
  window.downloadTrainingTemplate = downloadTrainingTemplate;
  window.downloadTrainingTypesList = downloadTrainingTypesList;
  window.matchAndTransferTrainingRecord = matchAndTransferTrainingRecord;
  window.toggleAllTrainingCheckboxes = toggleAllTrainingCheckboxes;
  window.filterTrainingRecords = filterTrainingRecords;
  window.autoMatchAllTraining = autoMatchAllTraining;
  window.matchSelectedTraining = matchSelectedTraining;

  // Export functions
  window.loadHolidayEntitlements = loadHolidayEntitlements;
  window.loadHolidayRequests = loadHolidayRequests;
  window.loadHolidayData = loadHolidayData;
  window.loadWorkingHours = loadWorkingHours;
  window.loadWorkingHours = loadWorkingHours;
  window.loadSchedulingDashboard = loadSchedulingDashboard;
})();

// Smart Setup Wizard Functions
let currentSetupStep = 0;
const totalSteps = 6;

function startSmartSetup() {
  navigateToStep(1);
}

function closeSmartSetup() {
  // Go back to dashboard or close the Smart Setup
  const sections = document.querySelectorAll('section.view');
  sections.forEach(section => section.classList.remove('active'));
  document.getElementById('view-dashboard').classList.add('active');

  // Update nav button states
  const navButtons = document.querySelectorAll('.nav button');
  navButtons.forEach(btn => btn.classList.remove('active'));
  document.querySelector('.nav button[onclick*="admin-dashboard.html"]').classList.add('active');
}

function nextStep() {
  if (currentSetupStep < totalSteps - 1) {
    navigateToStep(currentSetupStep + 1);
  }
}

function previousStep() {
  if (currentSetupStep > 0) {
    navigateToStep(currentSetupStep - 1);
  }
}

function navigateToStep(stepIndex) {
  // Update current step
  const oldStep = currentSetupStep;
  currentSetupStep = stepIndex;

  // Update pages
  const pages = document.querySelectorAll('.setup-page');
  pages.forEach((page, index) => {
    if (index === stepIndex) {
      page.classList.add('active');
    } else {
      page.classList.remove('active');
    }
  });

  // Update progress bar
  const progressFill = document.getElementById('progress-fill');
  const progressPercent = (stepIndex / (totalSteps - 1)) * 100;
  progressFill.style.width = `${progressPercent}%`;

  // Update step indicators
  const steps = document.querySelectorAll('.step');
  steps.forEach((step, index) => {
    step.classList.remove('active', 'completed');
    if (index === stepIndex) {
      step.classList.add('active');
    } else if (index < stepIndex) {
      step.classList.add('completed');
    }
  });

  // Update navigation buttons
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');

  prevBtn.disabled = stepIndex === 0;

  if (stepIndex === totalSteps - 1) {
    nextBtn.innerHTML = `
      Complete Setup
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 12l2 2 4-4"/>
        <circle cx="12" cy="12" r="10"/>
      </svg>
    `;
    nextBtn.onclick = completeSetup;
  } else {
    nextBtn.innerHTML = `
      Next
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="m9 18 6-6-6-6"/>
      </svg>
    `;
    nextBtn.onclick = nextStep;
  }

  // Add smooth animation between steps
  if (Math.abs(stepIndex - oldStep) === 1) {
    const activeCard = document.querySelector('.setup-page.active');
    activeCard.style.animation = 'none';
    setTimeout(() => {
      activeCard.style.animation = 'fadeIn 0.5s ease';
    }, 10);
  }
}

function completeSetup() {
  // Show completion animation and redirect
  alert('Setup completed! Your CheckLoops system is now ready to use.');
  closeSmartSetup();
}

// Add event listeners for progress step clicks
document.addEventListener('DOMContentLoaded', function() {
  const steps = document.querySelectorAll('.step');
  steps.forEach((step, index) => {
    step.addEventListener('click', () => {
      navigateToStep(index);
    });
    step.style.cursor = 'pointer';
  });
});

// Add event listeners for surgery setup tabs
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.tab-btn').forEach(function(tabBtn) {
    tabBtn.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab') + '-tab';
      switchTab(tabId);
    });
  });
});

// Staff Import Functions
function toggleImportMethod(methodId) {
  const method = document.getElementById(methodId);
  if (!method) return;

  const isExpanded = method.classList.contains('expanded');

  // Simply toggle the clicked method (allow multiple to be open)
  if (isExpanded) {
    method.classList.remove('expanded');
    // Clear results when closing email import
    if (methodId === 'email-import') {
      clearResults();
    }
  } else {
    method.classList.add('expanded');
  }
}

function parseEmailPaste() {
  const input = document.getElementById('email-paste');
  const text = input.value.trim();

  if (!text) {
    alert('Please paste some email recipients first!');
    input.focus();
    return;
  }

  // Parse the email text to extract names and emails
  const staffList = extractStaffFromEmailText(text);

  if (staffList.length === 0) {
    alert('No staff members could be detected from the pasted text. Please check the format and try again.');
    return;
  }

  displayStaffList(staffList);
}

function extractStaffFromEmailText(text) {
  const staff = [];

  // Pattern to match: Name (ID) email@domain.com or Name email@domain.com
  // Handle different separators: semicolon, comma, newline
  const patterns = [
    // Pattern 1: Monique Keersmaekers (M83076) Monique.Keersmaekers@stoke.nhs.uk
    /([A-Za-z\s]+?)\s*\([^)]+\)\s*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g,

    // Pattern 2: Name <email@domain.com>
    /([A-Za-z\s]+?)\s*<([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})>/g,

    // Pattern 3: Name email@domain.com (without angle brackets)
    /([A-Za-z\s]+?)\s+([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g
  ];

  patterns.forEach(pattern => {
    let match;
    while ((match = pattern.exec(text)) !== null) {
      const name = match[1].trim();
      const email = match[2].trim().toLowerCase();

      // Skip if we already have this person (avoid duplicates)
      if (!staff.some(s => s.email === email)) {
        staff.push({
          name: name,
          email: email,
          initials: getInitials(name)
        });
      }
    }
  });

  // Sort by name
  staff.sort((a, b) => a.name.localeCompare(b.name));

  return staff;
}

function getInitials(name) {
  return name.split(' ')
    .map(n => n.charAt(0).toUpperCase())
    .join('')
    .substring(0, 2);
}

function displayStaffList(staffList) {
  const resultsSection = document.getElementById('parsed-results');
  const staffListContainer = document.getElementById('staff-list');
  const countBadge = document.getElementById('staff-count');
  const proceedBtn = document.getElementById('proceed-btn');

  // Update count
  countBadge.textContent = staffList.length;

  // Clear previous results
  staffListContainer.innerHTML = '';

  // Create staff items with animation delays
  staffList.forEach((person, index) => {
    const staffItem = document.createElement('div');
    staffItem.className = 'staff-item';
    staffItem.style.animationDelay = `${index * 0.1}s`;

    staffItem.innerHTML = `
      <div class="staff-avatar">${person.initials}</div>
      <div class="staff-info">
        <div class="staff-name">${person.name}</div>
        <div class="staff-email">${person.email}</div>
      </div>
      <div class="staff-status">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12l2 2 4-4"/>
          <circle cx="12" cy="12" r="10"/>
        </svg>
        Ready
      </div>
    `;

    staffListContainer.appendChild(staffItem);

    // Trigger animation
    setTimeout(() => {
      staffItem.classList.add('animate');
    }, index * 100);
  });

  // Show results section with animation
  resultsSection.style.display = 'block';

  // Enable proceed button
  proceedBtn.disabled = false;

  // Store staff data for later use
  window.parsedStaffData = staffList;

  // Scroll to results
  setTimeout(() => {
    resultsSection.scrollIntoView({
      behavior: 'smooth',
      block: 'nearest'
    });
  }, 500);
}

function clearResults() {
  const resultsSection = document.getElementById('parsed-results');
  const input = document.getElementById('email-paste');
  const proceedBtn = document.getElementById('proceed-btn');

  // Hide results
  resultsSection.style.display = 'none';

  // Clear input
  input.value = '';

  // Disable proceed button
  proceedBtn.disabled = true;

  // Clear stored data
  window.parsedStaffData = null;

  // Focus input
  input.focus();
}

function proceedWithStaff() {
  if (!window.parsedStaffData || window.parsedStaffData.length === 0) {
    alert('No staff data available. Please parse some email recipients first.');
    return;
  }

  // For now, just show success message and continue to next step
  // Later this will save to database
  console.log('Staff data to process:', window.parsedStaffData);

  // Show success animation
  const staffItems = document.querySelectorAll('.staff-item');
  staffItems.forEach((item, index) => {
    setTimeout(() => {
      item.style.background = 'rgba(34, 197, 94, 0.1)';
      item.style.borderColor = 'rgba(34, 197, 94, 0.3)';

      const status = item.querySelector('.staff-status');
      status.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12l2 2 4-4"/>
          <circle cx="12" cy="12" r="10"/>
        </svg>
        Added
      `;
    }, index * 50);
  });

  setTimeout(() => {
    nextStep();
  }, 1000);
}

// CSV Import Functions
let csvFileData = null;

function downloadCsvTemplate(event) {
  // Prevent any default behavior and stop propagation
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }

  const csvContent = `Name,Email,Role,Team,Access Level
Dr. John Smith,j.smith@hospital.com,Doctor,Surgery,Admin
Nurse Sarah Johnson,s.johnson@hospital.com,Nurse,ICU,Staff
Tech Mike Brown,m.brown@hospital.com,Technician,Laboratory,Staff
Admin Alice Wilson,a.wilson@hospital.com,Administrator,Management,Admin`;

  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.style.display = 'none';
  a.href = url;
  a.download = 'staff-import-template.csv';

  // Append to body, click, and clean up immediately
  document.body.appendChild(a);

  // Use setTimeout to ensure the click doesn't interfere with navigation
  setTimeout(() => {
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  }, 0);

  return false; // Ensure no navigation occurs
}

function handleCsvUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Validate file type
  if (!file.name.toLowerCase().endsWith('.csv')) {
    alert('Please select a CSV file.');
    return;
  }

  // Validate file size (5MB limit)
  if (file.size > 5 * 1024 * 1024) {
    alert('File size must be less than 5MB.');
    return;
  }

  // Store file and show file info
  csvFileData = file;
  showFileInfo(file);
}

function showFileInfo(file) {
  const fileInfo = document.getElementById('csv-file-info');
  const fileName = document.getElementById('csv-file-name');
  const fileSize = document.getElementById('csv-file-size');

  fileName.textContent = file.name;
  fileSize.textContent = formatFileSize(file.size);
  fileInfo.style.display = 'flex';
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function processCsvFile() {
  if (!csvFileData) {
    alert('No file selected. Please upload a CSV file first.');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const csv = e.target.result;
    const staff = parseCsvData(csv);

    if (staff.length === 0) {
      alert('No valid staff data found in the CSV file. Please check the format and try again.');
      return;
    }

    displayCsvStaffList(staff);
  };

  reader.onerror = function() {
    alert('Error reading the CSV file. Please try again.');
  };

  reader.readAsText(csvFileData);
}

function parseCsvData(csvText) {
  const staff = [];
  const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);

  if (lines.length < 2) {
    return staff; // No data rows
  }

  // Get headers (first line)
  const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

  // Find column indices
  const nameIndex = headers.findIndex(h => h.includes('name'));
  const emailIndex = headers.findIndex(h => h.includes('email'));
  const roleIndex = headers.findIndex(h => h.includes('role'));
  const teamIndex = headers.findIndex(h => h.includes('team'));
  const accessIndex = headers.findIndex(h => h.includes('access'));

  // Process data rows
  for (let i = 1; i < lines.length; i++) {
    const row = lines[i].split(',').map(cell => cell.trim());

    if (row.length < 2) continue; // Skip invalid rows

    const name = nameIndex >= 0 ? row[nameIndex] : row[0];
    const email = emailIndex >= 0 ? row[emailIndex] : row[1];

    // Skip if essential data is missing
    if (!name || !email || !email.includes('@')) continue;

    const person = {
      name: name.replace(/['"]/g, ''), // Remove quotes
      email: email.replace(/['"]/g, '').toLowerCase(),
      role: roleIndex >= 0 ? row[roleIndex]?.replace(/['"]/g, '') : 'Staff',
      team: teamIndex >= 0 ? row[teamIndex]?.replace(/['"]/g, '') : 'General',
      access: accessIndex >= 0 ? row[accessIndex]?.replace(/['"]/g, '') : 'Staff',
      initials: getInitials(name.replace(/['"]/g, ''))
    };

    // Avoid duplicates
    if (!staff.some(s => s.email === person.email)) {
      staff.push(person);
    }
  }

  return staff;
}

function displayCsvStaffList(staffList) {
  const resultsSection = document.getElementById('csv-results');
  const staffListContainer = document.getElementById('csv-staff-list');
  const countBadge = document.getElementById('csv-staff-count');
  const proceedBtn = document.getElementById('csv-proceed-btn');

  // Update count
  countBadge.textContent = staffList.length;

  // Clear previous results
  staffListContainer.innerHTML = '';

  // Create staff items with animation delays
  staffList.forEach((person, index) => {
    const staffItem = document.createElement('div');
    staffItem.className = 'staff-item';
    staffItem.style.animationDelay = `${index * 0.1}s`;

    staffItem.innerHTML = `
      <div class="staff-avatar">${person.initials}</div>
      <div class="staff-info">
        <div class="staff-name">${person.name}</div>
        <div class="staff-email">${person.email}</div>
        <div style="color: var(--muted); font-size: 12px; margin-top: 2px;">
          ${person.role} • ${person.team} • ${person.access}
        </div>
      </div>
      <div class="staff-status">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12l2 2 4-4"/>
          <circle cx="12" cy="12" r="10"/>
        </svg>
        Ready
      </div>
    `;

    staffListContainer.appendChild(staffItem);

    // Trigger animation
    setTimeout(() => {
      staffItem.classList.add('animate');
    }, index * 100);
  });

  // Show results section with animation
  resultsSection.style.display = 'block';

  // Enable proceed button
  proceedBtn.disabled = false;

  // Store staff data for later use
  window.parsedCsvStaffData = staffList;

  // Scroll to results
  setTimeout(() => {
    resultsSection.scrollIntoView({
      behavior: 'smooth',
      block: 'nearest'
    });
  }, 500);
}

function clearCsvResults() {
  const resultsSection = document.getElementById('csv-results');
  const fileInfo = document.getElementById('csv-file-info');
  const fileInput = document.getElementById('csv-file-input');
  const proceedBtn = document.getElementById('csv-proceed-btn');

  // Hide results
  resultsSection.style.display = 'none';
  fileInfo.style.display = 'none';

  // Clear file input
  fileInput.value = '';

  // Disable proceed button
  proceedBtn.disabled = true;

  // Clear stored data
  csvFileData = null;
  window.parsedCsvStaffData = null;
}

function proceedWithCsvStaff() {
  if (!window.parsedCsvStaffData || window.parsedCsvStaffData.length === 0) {
    alert('No CSV staff data available. Please process a CSV file first.');
    return;
  }

  // For now, just show success message and continue to next step
  // Later this will save to database
  console.log('CSV Staff data to process:', window.parsedCsvStaffData);

  // Show success animation
  const staffItems = document.querySelectorAll('#csv-staff-list .staff-item');
  staffItems.forEach((item, index) => {
    setTimeout(() => {
      item.style.background = 'rgba(34, 197, 94, 0.1)';
      item.style.borderColor = 'rgba(34, 197, 94, 0.3)';

      const status = item.querySelector('.staff-status');
      status.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 12l2 2 4-4"/>
          <circle cx="12" cy="12" r="10"/>
        </svg>
        Imported
      `;
    }, index * 50);
  });

  setTimeout(() => {
    nextStep();
  }, 1000);
}

// Add drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
  const uploadArea = document.getElementById('csv-upload-area');

  if (uploadArea) {
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.name.toLowerCase().endsWith('.csv')) {
          // Simulate file input change event
          const fileInput = document.getElementById('csv-file-input');
          const dt = new DataTransfer();
          dt.items.add(file);
          fileInput.files = dt.files;
          handleCsvUpload({ target: { files: [file] } });
        } else {
          alert('Please drop a CSV file.');
        }
      }
    });
  }
});

// Manual Entry Table Functions
let rowCounter = 1;

function addManualRow() {
  const tbody = document.getElementById('manual-table-body');
  const newRow = document.createElement('tr');
  newRow.className = 'manual-row';
  newRow.setAttribute('data-row', rowCounter);

  newRow.innerHTML = `
    <td>
      <input type="text" class="manual-input" placeholder="e.g. Dr. Sarah Johnson" required>
    </td>
    <td>
      <input type="email" class="manual-input" placeholder="e.g. s.johnson@hospital.com" required>
    </td>
    <td>
      <input type="text" class="manual-input" placeholder="e.g. Doctor, Nurse">
    </td>
    <td>
      <input type="text" class="manual-input" placeholder="e.g. Surgery, ICU">
    </td>
    <td>
      <select class="manual-select" required>
        <option value="">Select...</option>
        <option value="Admin">Admin</option>
        <option value="Staff">Staff</option>
      </select>
    </td>
    <td>
      <button type="button" class="remove-row-btn" onclick="removeManualRow(this)" title="Remove row">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </td>
  `;

  tbody.appendChild(newRow);
  rowCounter++;
  updateRowCounter();

  // Focus on the first input of the new row
  newRow.querySelector('.manual-input').focus();
}

function removeManualRow(button) {
  const row = button.closest('.manual-row');
  const tbody = document.getElementById('manual-table-body');

  // Don't remove if it's the last row
  if (tbody.children.length === 1) {
    // Clear the inputs instead
    const inputs = row.querySelectorAll('.manual-input, .manual-select');
    inputs.forEach(input => {
      input.value = '';
    });
    return;
  }

  row.remove();
  updateRowCounter();
}

function clearAllRows() {
  if (confirm('Are you sure you want to clear all data?')) {
    const tbody = document.getElementById('manual-table-body');

    // Clear all rows except keep one empty row
    tbody.innerHTML = `
      <tr class="manual-row" data-row="0">
        <td>
          <input type="text" class="manual-input" placeholder="e.g. Dr. Sarah Johnson" required>
        </td>
        <td>
          <input type="email" class="manual-input" placeholder="e.g. s.johnson@hospital.com" required>
        </td>
        <td>
          <input type="text" class="manual-input" placeholder="e.g. Doctor, Nurse">
        </td>
        <td>
          <input type="text" class="manual-input" placeholder="e.g. Surgery, ICU">
        </td>
        <td>
          <select class="manual-select" required>
            <option value="">Select...</option>
            <option value="Admin">Admin</option>
            <option value="Staff">Staff</option>
          </select>
        </td>
        <td>
          <button type="button" class="remove-row-btn" onclick="removeManualRow(this)" title="Remove row">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </td>
      </tr>
    `;

    rowCounter = 1;
    updateRowCounter();
  }
}

function updateRowCounter() {
  const tbody = document.getElementById('manual-table-body');
  const count = tbody.children.length;
  const counter = document.getElementById('manual-row-count');

  if (counter) {
    counter.textContent = count;
  }
}

function processManualStaff() {
  const tbody = document.getElementById('manual-table-body');
  const rows = Array.from(tbody.querySelectorAll('.manual-row'));
  const staffData = [];
  const errors = [];

  rows.forEach((row, index) => {
    const inputs = row.querySelectorAll('.manual-input, .manual-select');
    const name = inputs[0].value.trim();
    const email = inputs[1].value.trim();
    const role = inputs[2].value.trim();
    const team = inputs[3].value.trim();
    const accessLevel = inputs[4].value;

    // Skip completely empty rows
    if (!name && !email && !role && !team && !accessLevel) {
      return;
    }

    // Validate required fields
    if (!name) {
      errors.push(`Row ${index + 1}: Name is required`);
    }
    if (!email) {
      errors.push(`Row ${index + 1}: Email is required`);
    } else {
      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        errors.push(`Row ${index + 1}: Invalid email format`);
      }
    }
    if (!accessLevel) {
      errors.push(`Row ${index + 1}: Access level is required`);
    }

    // Check for duplicate emails in this session
    const existingEmail = staffData.find(staff => staff.email === email);
    if (existingEmail) {
      errors.push(`Row ${index + 1}: Email ${email} is already used`);
    }

    if (!errors.length || errors.length < 3) { // Allow some errors for partial validation
      staffData.push({
        name: name,
        email: email,
        role: role || 'Staff Member',
        team: team || 'General',
        accessLevel: accessLevel
      });
    }
  });

  if (errors.length > 0 && staffData.length === 0) {
    alert('Please fix the following errors:\n\n' + errors.join('\n'));
    return;
  }

  if (staffData.length === 0) {
    alert('Please add at least one staff member before proceeding.');
    return;
  }

  // Show warnings but allow proceeding
  if (errors.length > 0) {
    const proceed = confirm(
      `Found ${errors.length} validation error(s):\n\n${errors.slice(0, 3).join('\n')}${errors.length > 3 ? '\n...and more' : ''}\n\nProceed with ${staffData.length} valid staff member(s)?`
    );
    if (!proceed) return;
  }

  console.log('Manual staff data:', staffData);

  // Show success animation and proceed
  showStepSuccess();

  setTimeout(() => {
    nextStep();
  }, 1500);
}

// Background Data Storage System
let smartSetupData = {
  surgery: {},
  staff: [],
  rooms: [],
  trainingRecords: [],
  holidays: []
};

// Surgery Setup Functions
function applyToAllDays() {
  const mondayOpen = document.getElementById('monday-open').value;
  const mondayClose = document.getElementById('monday-close').value;

  if (!mondayOpen || !mondayClose) {
    alert('Please set Monday\'s hours first');
    return;
  }

  const days = ['tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

  days.forEach(day => {
    document.getElementById(`${day}-open`).value = mondayOpen;
    document.getElementById(`${day}-close`).value = mondayClose;
    document.getElementById(`${day}-enabled`).checked = true;
  });

  showToast('Applied Monday hours to all days');
}

function clearAllHours() {
  if (confirm('Are you sure you want to clear all operating hours?')) {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    days.forEach(day => {
      document.getElementById(`${day}-open`).value = '08:00';
      document.getElementById(`${day}-close`).value = '17:00';
      document.getElementById(`${day}-enabled`).checked = day === 'monday' || day === 'tuesday' || day === 'wednesday' || day === 'thursday' || day === 'friday';
    });

    showToast('Operating hours cleared');
  }
}

function switchTab(tabId) {
  // Hide all tab panels
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.classList.remove('active');
  });
  
  // Show the requested tab panel
  document.getElementById(tabId).classList.add('active');
  
  // Update active class on tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    if (btn.getAttribute('data-tab') === tabId) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
}

function applyToAllDays() {
  const mondayOpen = document.getElementById('monday-open').value;
  const mondayClose = document.getElementById('monday-close').value;
  const mondayEnabled = document.getElementById('monday-enabled').checked;
  
  // Apply Monday's settings to all other days
  ['tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
    document.getElementById(`${day}-open`).value = mondayOpen;
    document.getElementById(`${day}-close`).value = mondayClose;
    document.getElementById(`${day}-enabled`).checked = mondayEnabled;
  });

  // Show success message
  showToast('Monday hours copied to all days successfully!');
}

function clearAllHours() {
  // Reset all days
  ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
    document.getElementById(`${day}-open`).value = '';
    document.getElementById(`${day}-close`).value = '';
    document.getElementById(`${day}-enabled`).checked = false;
  });

  // Show success message
  showToast('All hours have been cleared!');
}

function saveSurgerySetup() {
  // Get form values
  const surgeryName = document.getElementById('surgery-name').value.trim();
  const surgeryTown = document.getElementById('surgery-town').value.trim();
  const surgeryPostcode = document.getElementById('surgery-postcode')?.value?.trim() || '';
  const surgeryPhone = document.getElementById('surgery-phone')?.value?.trim() || '';
  const surgeryWebsite = document.getElementById('surgery-website')?.value?.trim() || '';
  const surgeryDescription = document.getElementById('surgery-description')?.value?.trim() || '';

  // Validate required fields
  if (!surgeryName || !surgeryTown) {
    alert('Please fill in all required fields (Surgery Name and Town/City)');
    return;
  }

  // Collect operating hours
  const operatingHours = {};
  const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

  days.forEach(day => {
    const enabled = document.getElementById(`${day}-enabled`).checked;
    const openTime = document.getElementById(`${day}-open`).value;
    const closeTime = document.getElementById(`${day}-close`).value;

    // Additional validation for hours
    if (enabled && (!openTime || !closeTime)) {
      alert(`Please set both opening and closing times for ${day.charAt(0).toUpperCase() + day.slice(1)} or disable it.`);
      return;
    }

    operatingHours[day] = {
      enabled: enabled,
      open: enabled ? openTime : null,
      close: enabled ? closeTime : null
    };
  });

  // Save to background storage
  smartSetupData.surgery = {
    name: surgeryName,
    town: surgeryTown,
    postcode: surgeryPostcode,
    phone: surgeryPhone,
    website: surgeryWebsite,
    description: surgeryDescription,
    operatingHours: operatingHours,
    timestamp: new Date().toISOString()
  };

  console.log('Surgery setup saved:', smartSetupData.surgery);

  showToast('Surgery information saved successfully');

  // Show success animation and proceed
  showStepSuccess();

  setTimeout(() => {
    nextStep();
  }, 1500);
}

// Update the manual staff processing to save to background storage
function processManualStaff() {
  const tbody = document.getElementById('manual-table-body');
  const rows = Array.from(tbody.querySelectorAll('.manual-row'));
  const staffData = [];
  const errors = [];

  rows.forEach((row, index) => {
    const inputs = row.querySelectorAll('.manual-input, .manual-select');
    const name = inputs[0].value.trim();
    const email = inputs[1].value.trim();
    const role = inputs[2].value.trim();
    const team = inputs[3].value.trim();
    const accessLevel = inputs[4].value;

    // Skip completely empty rows
    if (!name && !email && !role && !team && !accessLevel) {
      return;
    }

    // Validate required fields
    if (!name) {
      errors.push(`Row ${index + 1}: Name is required`);
    }
    if (!email) {
      errors.push(`Row ${index + 1}: Email is required`);
    } else {
      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        errors.push(`Row ${index + 1}: Invalid email format`);
      }
    }
    if (!accessLevel) {
      errors.push(`Row ${index + 1}: Access level is required`);
    }

    // Check for duplicate emails in this session
    const existingEmail = staffData.find(staff => staff.email === email);
    if (existingEmail) {
      errors.push(`Row ${index + 1}: Email ${email} is already used`);
    }

    if (!errors.length || errors.length < 3) { // Allow some errors for partial validation
      staffData.push({
        name: name,
        email: email,
        role: role || 'Staff Member',
        team: team || 'General',
        accessLevel: accessLevel
      });
    }
  });

  if (errors.length > 0 && staffData.length === 0) {
    alert('Please fix the following errors:\n\n' + errors.join('\n'));
    return;
  }

  if (staffData.length === 0) {
    alert('Please add at least one staff member before proceeding.');
    return;
  }

  // Show warnings but allow proceeding
  if (errors.length > 0) {
    const proceed = confirm(
      `Found ${errors.length} validation error(s):\n\n${errors.slice(0, 3).join('\n')}${errors.length > 3 ? '\n...and more' : ''}\n\nProceed with ${staffData.length} valid staff member(s)?`
    );
    if (!proceed) return;
  }

  // Save to background storage
  smartSetupData.staff = {
    data: staffData,
    timestamp: new Date().toISOString()
  };

  console.log('Staff data saved:', smartSetupData.staff);

  showToast(`${staffData.length} staff member(s) saved successfully`);

  // Show success animation and proceed
  showStepSuccess();

  setTimeout(() => {
    nextStep();
  }, 1500);
}

// Generic toast notification function
function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'success-toast';
  toast.innerHTML = `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M20 6L9 17l-5-5"/>
    </svg>
    ${message}
  `;

  document.body.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// Update total steps count for navigation
function updateTotalSteps() {
  window.totalSteps = 7; // Updated from 6 to 7 steps
}

// Call on page load
document.addEventListener('DOMContentLoaded', updateTotalSteps);

</script>



    <!-- Debug Console - Persistent across all pages -->
    <script src="debug-console.js"></script>
    <script src="supabase-debug.js"></script>
</body>
</html>

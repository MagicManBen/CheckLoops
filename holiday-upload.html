<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Data Upload - CheckLoop Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab-button {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #e0e0e0;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .staff-type-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #667eea;
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragging {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .data-preview {
            margin-top: 20px;
            max-height: 400px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-preview th,
        .data-preview td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-preview th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .alert {
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-button">‚Üê Back to Admin</a>
    
    <div class="container">
        <div class="header">
            <h1>Holiday Data Upload System</h1>
            <div class="subtitle">Upload staff profiles, holiday bookings, and work patterns</div>
        </div>

        <div class="tabs">
            <button class="tab-button active" data-tab="staff-profiles">Staff Profiles</button>
            <button class="tab-button" data-tab="holiday-bookings">Holiday Bookings</button>
            <button class="tab-button" data-tab="work-patterns">Work Patterns</button>
            <button class="tab-button" data-tab="bulk-upload">Bulk Upload</button>
        </div>

        <!-- Staff Profiles Tab -->
        <div class="tab-content active" id="staff-profiles">
            <h2 class="section-title">Add Staff Profiles</h2>
            
            <div class="staff-type-toggle">
                <button class="toggle-btn active" data-type="regular">Regular Staff</button>
                <button class="toggle-btn" data-type="gp">GP Staff</button>
            </div>

            <!-- Regular Staff Form -->
            <div id="regular-staff-form" class="staff-form">
                <form id="add-regular-staff">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" name="fullName" required>
                        </div>
                        <div class="form-group">
                            <label>Role *</label>
                            <select name="role" required>
                                <option value="">Select Role</option>
                                <option value="Nurse">Nurse</option>
                                <option value="Manager">Manager</option>
                                <option value="Admin">Admin</option>
                                <option value="Reception">Reception</option>
                                <option value="Pharmacist">Pharmacist</option>
                                <option value="Health Care Assistant">Health Care Assistant</option>
                                <option value="GP Assistant">GP Assistant</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Annual Leave Entitlement (Hours) *</label>
                            <input type="number" name="annualHours" min="0" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label>Email (Optional)</label>
                            <input type="email" name="email">
                        </div>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px;">Working Hours (HH:MM format)</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Monday Hours</label>
                            <input type="text" name="mondayHours" pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$" placeholder="08:00">
                        </div>
                        <div class="form-group">
                            <label>Tuesday Hours</label>
                            <input type="text" name="tuesdayHours" pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$" placeholder="08:00">
                        </div>
                        <div class="form-group">
                            <label>Wednesday Hours</label>
                            <input type="text" name="wednesdayHours" pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$" placeholder="08:00">
                        </div>
                        <div class="form-group">
                            <label>Thursday Hours</label>
                            <input type="text" name="thursdayHours" pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$" placeholder="08:00">
                        </div>
                        <div class="form-group">
                            <label>Friday Hours</label>
                            <input type="text" name="fridayHours" pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$" placeholder="07:30">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Add Staff Member</button>
                </form>
            </div>

            <!-- GP Staff Form -->
            <div id="gp-staff-form" class="staff-form hidden">
                <form id="add-gp-staff">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" name="fullName" required>
                        </div>
                        <div class="form-group">
                            <label>Annual Leave Entitlement (Sessions) *</label>
                            <input type="number" name="annualSessions" min="0" value="44" required>
                        </div>
                        <div class="form-group">
                            <label>Email (Optional)</label>
                            <input type="email" name="email">
                        </div>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px;">Working Sessions (1 or 2 per day)</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Monday Sessions</label>
                            <select name="mondaySessions">
                                <option value="">None</option>
                                <option value="1">1 Session</option>
                                <option value="2">2 Sessions</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tuesday Sessions</label>
                            <select name="tuesdaySessions">
                                <option value="">None</option>
                                <option value="1">1 Session</option>
                                <option value="2">2 Sessions</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Wednesday Sessions</label>
                            <select name="wednesdaySessions">
                                <option value="">None</option>
                                <option value="1">1 Session</option>
                                <option value="2">2 Sessions</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Thursday Sessions</label>
                            <select name="thursdaySessions">
                                <option value="">None</option>
                                <option value="1">1 Session</option>
                                <option value="2">2 Sessions</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Friday Sessions</label>
                            <select name="fridaySessions">
                                <option value="">None</option>
                                <option value="1">1 Session</option>
                                <option value="2">2 Sessions</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Add GP</button>
                </form>
            </div>

            <div id="staff-alert" class="alert hidden"></div>
        </div>

        <!-- Holiday Bookings Tab -->
        <div class="tab-content" id="holiday-bookings">
            <h2 class="section-title">Add Holiday Bookings</h2>
            
            <div class="staff-type-toggle">
                <button class="toggle-btn active" data-type="regular">Regular Staff</button>
                <button class="toggle-btn" data-type="gp">GP Staff</button>
            </div>

            <!-- Regular Staff Holiday Form -->
            <div id="regular-holiday-form" class="holiday-form">
                <form id="add-regular-holiday">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Staff Member *</label>
                            <select name="staffId" id="regular-staff-select" required>
                                <option value="">Select Staff Member</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Date *</label>
                            <input type="date" name="startDate" required>
                        </div>
                        <div class="form-group">
                            <label>End Date *</label>
                            <input type="date" name="endDate" required>
                        </div>
                        <div class="form-group">
                            <label>Hours per Day *</label>
                            <input type="text" name="hoursPerDay" pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$" placeholder="08:00" required>
                        </div>
                        <div class="form-group">
                            <label>Booking Type</label>
                            <select name="bookingType">
                                <option value="annual_leave">Annual Leave</option>
                                <option value="sick_leave">Sick Leave</option>
                                <option value="study_leave">Study Leave</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Holiday Booking</button>
                </form>
            </div>

            <!-- GP Holiday Form -->
            <div id="gp-holiday-form" class="holiday-form hidden">
                <form id="add-gp-holiday">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>GP *</label>
                            <select name="staffId" id="gp-staff-select" required>
                                <option value="">Select GP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label>Sessions *</label>
                            <select name="sessions" required>
                                <option value="">Select Sessions</option>
                                <option value="1">1 Session</option>
                                <option value="2">2 Sessions</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Booking Type</label>
                            <select name="bookingType">
                                <option value="annual_leave">Annual Leave</option>
                                <option value="sick_leave">Sick Leave</option>
                                <option value="study_leave">Study Leave</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add GP Holiday</button>
                </form>
            </div>

            <div id="holiday-alert" class="alert hidden"></div>
        </div>

        <!-- Work Patterns Tab -->
        <div class="tab-content" id="work-patterns">
            <h2 class="section-title">Update Work Patterns</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Select Staff Member</label>
                    <select id="pattern-staff-select">
                        <option value="">Select Staff Member</option>
                    </select>
                </div>
            </div>

            <div id="pattern-form-container" class="hidden">
                <!-- Dynamic form will be inserted here -->
            </div>

            <div id="pattern-alert" class="alert hidden"></div>
        </div>

        <!-- Bulk Upload Tab -->
        <div class="tab-content" id="bulk-upload">
            <h2 class="section-title">Bulk Upload</h2>
            
            <div class="section">
                <h3>Step 1: Download Template</h3>
                <p style="margin: 10px 0;">Download the appropriate template for your data type:</p>
                <div style="display: flex; gap: 10px; margin: 15px 0;">
                    <button class="btn btn-secondary" onclick="downloadTemplate('staff')">
                        üì• Staff Template
                    </button>
                    <button class="btn btn-secondary" onclick="downloadTemplate('gp')">
                        üì• GP Template
                    </button>
                    <button class="btn btn-secondary" onclick="downloadTemplate('holidays')">
                        üì• Holiday Bookings Template
                    </button>
                </div>
            </div>

            <div class="section">
                <h3>Step 2: Upload Completed Spreadsheet</h3>
                <div class="upload-area" id="upload-area">
                    <input type="file" id="file-upload" accept=".xlsx,.xls,.csv" hidden>
                    <div>
                        <p style="font-size: 24px; margin-bottom: 10px;">üìÅ</p>
                        <p>Click to browse or drag and drop your file here</p>
                        <p style="font-size: 12px; color: #999; margin-top: 5px;">Supported formats: .xlsx, .xls, .csv</p>
                    </div>
                </div>
                
                <div id="file-info" class="hidden" style="margin: 10px 0;">
                    <p>Selected file: <strong id="file-name"></strong></p>
                    <button class="btn btn-danger" onclick="clearFile()">Clear</button>
                </div>
            </div>

            <div id="data-preview-section" class="section hidden">
                <h3>Step 3: Preview & Confirm</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="row-count">0</div>
                        <div class="stat-label">Rows to Import</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="col-count">0</div>
                        <div class="stat-label">Columns</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="data-type">-</div>
                        <div class="stat-label">Data Type</div>
                    </div>
                </div>
                
                <div class="data-preview" id="data-preview">
                    <!-- Table preview will be inserted here -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="processUpload()">
                        üöÄ Import Data
                    </button>
                    <button class="btn btn-secondary" onclick="clearFile()">
                        Cancel
                    </button>
                </div>
            </div>

            <div id="upload-progress" class="hidden">
                <h3>Upload Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <p id="progress-text">Processing...</p>
            </div>

            <div id="upload-alert" class="alert hidden"></div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        
        let uploadedData = null;
        let uploadedFile = null;

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                
                // Update active button
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');
                
                // Load data for specific tabs
                if (tabName === 'holiday-bookings') {
                    loadStaffForHolidays();
                } else if (tabName === 'work-patterns') {
                    loadStaffForPatterns();
                }
            });
        });

        // Staff type toggle
        document.querySelectorAll('.staff-type-toggle').forEach(toggle => {
            toggle.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const parent = btn.closest('.tab-content');
                    parent.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const type = btn.dataset.type;
                    if (parent.id === 'staff-profiles') {
                        document.getElementById('regular-staff-form').classList.toggle('hidden', type !== 'regular');
                        document.getElementById('gp-staff-form').classList.toggle('hidden', type !== 'gp');
                    } else if (parent.id === 'holiday-bookings') {
                        document.getElementById('regular-holiday-form').classList.toggle('hidden', type !== 'regular');
                        document.getElementById('gp-holiday-form').classList.toggle('hidden', type !== 'gp');
                    }
                });
            });
        });

        // Add Regular Staff
        document.getElementById('add-regular-staff').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                // Create staff profile
                const { data: profile, error: profileError } = await supabase
                    .from('1_staff_holiday_profiles')
                    .insert({
                        full_name: formData.get('fullName'),
                        role: formData.get('role'),
                        is_gp: false
                    })
                    .select()
                    .single();
                
                if (profileError) throw profileError;
                
                // Add entitlement
                await supabase.from('2_staff_entitlements').insert({
                    staff_profile_id: profile.id,
                    year: new Date().getFullYear(),
                    annual_hours: parseFloat(formData.get('annualHours'))
                });
                
                // Add working patterns
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
                for (const day of days) {
                    const hours = formData.get(`${day}Hours`);
                    if (hours) {
                        await supabase.from('3_staff_working_patterns').insert({
                            staff_profile_id: profile.id,
                            day_of_week: day.charAt(0).toUpperCase() + day.slice(1),
                            hours_worked: hours + ':00'
                        });
                    }
                }
                
                showAlert('staff-alert', 'Staff member added successfully!', 'success');
                e.target.reset();
            } catch (error) {
                showAlert('staff-alert', 'Error: ' + error.message, 'error');
            }
        });

        // Add GP Staff
        document.getElementById('add-gp-staff').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                // Create staff profile
                const { data: profile, error: profileError } = await supabase
                    .from('1_staff_holiday_profiles')
                    .insert({
                        full_name: formData.get('fullName'),
                        role: 'GP',
                        is_gp: true
                    })
                    .select()
                    .single();
                
                if (profileError) throw profileError;
                
                // Add entitlement
                await supabase.from('2_staff_entitlements').insert({
                    staff_profile_id: profile.id,
                    year: new Date().getFullYear(),
                    annual_sessions: parseInt(formData.get('annualSessions'))
                });
                
                // Add working patterns
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
                for (const day of days) {
                    const sessions = formData.get(`${day}Sessions`);
                    if (sessions) {
                        await supabase.from('3_staff_working_patterns').insert({
                            staff_profile_id: profile.id,
                            day_of_week: day.charAt(0).toUpperCase() + day.slice(1),
                            sessions_worked: parseInt(sessions)
                        });
                    }
                }
                
                showAlert('staff-alert', 'GP added successfully!', 'success');
                e.target.reset();
            } catch (error) {
                showAlert('staff-alert', 'Error: ' + error.message, 'error');
            }
        });

        // Add Regular Staff Holiday
        document.getElementById('add-regular-holiday').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const startDate = new Date(formData.get('startDate'));
                const endDate = new Date(formData.get('endDate'));
                const hoursPerDay = formData.get('hoursPerDay') + ':00';
                const staffId = formData.get('staffId');
                const bookingType = formData.get('bookingType');
                
                // Create bookings for each day
                const bookings = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    // Skip weekends
                    if (d.getDay() === 0 || d.getDay() === 6) continue;
                    
                    bookings.push({
                        staff_profile_id: staffId,
                        booking_date: d.toISOString().split('T')[0],
                        hours_booked: hoursPerDay,
                        booking_type: bookingType
                    });
                }
                
                const { error } = await supabase.from('4_holiday_bookings').insert(bookings);
                if (error) throw error;
                
                showAlert('holiday-alert', `Holiday booking added: ${bookings.length} days`, 'success');
                e.target.reset();
            } catch (error) {
                showAlert('holiday-alert', 'Error: ' + error.message, 'error');
            }
        });

        // Add GP Holiday
        document.getElementById('add-gp-holiday').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const { error } = await supabase.from('4_holiday_bookings').insert({
                    staff_profile_id: formData.get('staffId'),
                    booking_date: formData.get('date'),
                    sessions_booked: parseInt(formData.get('sessions')),
                    booking_type: formData.get('bookingType')
                });
                
                if (error) throw error;
                
                showAlert('holiday-alert', 'GP holiday booking added successfully!', 'success');
                e.target.reset();
            } catch (error) {
                showAlert('holiday-alert', 'Error: ' + error.message, 'error');
            }
        });

        // Load staff for holidays
        async function loadStaffForHolidays() {
            try {
                const { data: staff } = await supabase
                    .from('1_staff_holiday_profiles')
                    .select('*')
                    .order('full_name');
                
                const regularSelect = document.getElementById('regular-staff-select');
                const gpSelect = document.getElementById('gp-staff-select');
                
                regularSelect.innerHTML = '<option value="">Select Staff Member</option>';
                gpSelect.innerHTML = '<option value="">Select GP</option>';
                
                staff.forEach(s => {
                    const option = `<option value="${s.id}">${s.full_name} (${s.role})</option>`;
                    if (s.is_gp) {
                        gpSelect.innerHTML += option;
                    } else {
                        regularSelect.innerHTML += option;
                    }
                });
            } catch (error) {
                console.error('Error loading staff:', error);
            }
        }

        // Load staff for patterns
        async function loadStaffForPatterns() {
            try {
                const { data: staff } = await supabase
                    .from('1_staff_holiday_profiles')
                    .select('*')
                    .order('full_name');
                
                const select = document.getElementById('pattern-staff-select');
                select.innerHTML = '<option value="">Select Staff Member</option>';
                
                staff.forEach(s => {
                    select.innerHTML += `<option value="${s.id}" data-is-gp="${s.is_gp}">${s.full_name} (${s.role})</option>`;
                });
                
                select.addEventListener('change', loadStaffPattern);
            } catch (error) {
                console.error('Error loading staff:', error);
            }
        }

        // Load staff pattern
        async function loadStaffPattern(e) {
            const staffId = e.target.value;
            const isGP = e.target.selectedOptions[0].dataset.isGp === 'true';
            
            if (!staffId) {
                document.getElementById('pattern-form-container').classList.add('hidden');
                return;
            }
            
            try {
                const { data: patterns } = await supabase
                    .from('3_staff_working_patterns')
                    .select('*')
                    .eq('staff_profile_id', staffId);
                
                const container = document.getElementById('pattern-form-container');
                container.classList.remove('hidden');
                
                // Create pattern object
                const patternMap = {};
                patterns.forEach(p => {
                    patternMap[p.day_of_week.toLowerCase()] = isGP ? p.sessions_worked : p.hours_worked;
                });
                
                // Generate form
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                let formHtml = '<form id="update-pattern"><div class="form-grid">';
                
                days.forEach(day => {
                    const dayLower = day.toLowerCase();
                    if (isGP) {
                        formHtml += `
                            <div class="form-group">
                                <label>${day} Sessions</label>
                                <select name="${dayLower}">
                                    <option value="">None</option>
                                    <option value="1" ${patternMap[dayLower] == 1 ? 'selected' : ''}>1 Session</option>
                                    <option value="2" ${patternMap[dayLower] == 2 ? 'selected' : ''}>2 Sessions</option>
                                </select>
                            </div>
                        `;
                    } else {
                        const value = patternMap[dayLower] ? patternMap[dayLower].substring(0, 5) : '';
                        formHtml += `
                            <div class="form-group">
                                <label>${day} Hours</label>
                                <input type="text" name="${dayLower}" value="${value}" 
                                       pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$" placeholder="08:00">
                            </div>
                        `;
                    }
                });
                
                formHtml += '</div><button type="submit" class="btn btn-primary">Update Pattern</button></form>';
                container.innerHTML = formHtml;
                
                // Add submit handler
                document.getElementById('update-pattern').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updatePattern(staffId, new FormData(e.target), isGP);
                });
                
            } catch (error) {
                console.error('Error loading pattern:', error);
            }
        }

        // Update pattern
        async function updatePattern(staffId, formData, isGP) {
            try {
                // Delete existing patterns
                await supabase
                    .from('3_staff_working_patterns')
                    .delete()
                    .eq('staff_profile_id', staffId);
                
                // Insert new patterns
                const patterns = [];
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
                
                days.forEach(day => {
                    const value = formData.get(day);
                    if (value) {
                        const pattern = {
                            staff_profile_id: staffId,
                            day_of_week: day.charAt(0).toUpperCase() + day.slice(1)
                        };
                        
                        if (isGP) {
                            pattern.sessions_worked = parseInt(value);
                        } else {
                            pattern.hours_worked = value + ':00';
                        }
                        
                        patterns.push(pattern);
                    }
                });
                
                if (patterns.length > 0) {
                    const { error } = await supabase.from('3_staff_working_patterns').insert(patterns);
                    if (error) throw error;
                }
                
                showAlert('pattern-alert', 'Work pattern updated successfully!', 'success');
            } catch (error) {
                showAlert('pattern-alert', 'Error: ' + error.message, 'error');
            }
        }

        // File upload handling
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-upload');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Handle file
        function handleFile(file) {
            uploadedFile = file;
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-info').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                uploadedData = XLSX.utils.sheet_to_json(firstSheet);
                
                displayPreview();
            };
            reader.readAsArrayBuffer(file);
        }

        // Display preview
        function displayPreview() {
            if (!uploadedData || uploadedData.length === 0) {
                showAlert('upload-alert', 'No data found in file', 'error');
                return;
            }
            
            const section = document.getElementById('data-preview-section');
            section.classList.remove('hidden');
            
            // Update stats
            document.getElementById('row-count').textContent = uploadedData.length;
            document.getElementById('col-count').textContent = Object.keys(uploadedData[0]).length;
            
            // Detect data type
            const columns = Object.keys(uploadedData[0]);
            let dataType = 'Unknown';
            if (columns.includes('Full Name') && columns.includes('Role')) {
                dataType = columns.includes('Annual Sessions') ? 'GP Staff' : 'Regular Staff';
            } else if (columns.includes('Staff Name') && columns.includes('Date')) {
                dataType = 'Holiday Bookings';
            }
            document.getElementById('data-type').textContent = dataType;
            
            // Create preview table
            let tableHtml = '<table><thead><tr>';
            columns.forEach(col => {
                tableHtml += `<th>${col}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            // Show first 10 rows
            uploadedData.slice(0, 10).forEach(row => {
                tableHtml += '<tr>';
                columns.forEach(col => {
                    tableHtml += `<td>${row[col] || ''}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            if (uploadedData.length > 10) {
                tableHtml += `<tr><td colspan="${columns.length}" style="text-align: center;">... and ${uploadedData.length - 10} more rows</td></tr>`;
            }
            
            tableHtml += '</tbody></table>';
            document.getElementById('data-preview').innerHTML = tableHtml;
        }

        // Process upload
        async function processUpload() {
            if (!uploadedData || uploadedData.length === 0) {
                showAlert('upload-alert', 'No data to upload', 'error');
                return;
            }
            
            const progressSection = document.getElementById('upload-progress');
            progressSection.classList.remove('hidden');
            
            try {
                const columns = Object.keys(uploadedData[0]);
                let processed = 0;
                
                // Detect and process based on data type
                if (columns.includes('Full Name') && columns.includes('Role')) {
                    // Staff data
                    const isGP = columns.includes('Annual Sessions');
                    
                    for (const row of uploadedData) {
                        // Create profile
                        const { data: profile, error: profileError } = await supabase
                            .from('1_staff_holiday_profiles')
                            .insert({
                                full_name: row['Full Name'],
                                role: row['Role'] || (isGP ? 'GP' : 'Staff'),
                                is_gp: isGP
                            })
                            .select()
                            .single();
                        
                        if (profileError) {
                            console.error('Error creating profile:', profileError);
                            throw new Error(`Failed to create staff profile for ${row['Full Name']}: ${profileError.message}`);
                        }
                        
                        if (profile) {
                            // Add entitlement to 2_staff_entitlements table (not holiday_entitlements)
                            if (isGP) {
                                const { error: entError } = await supabase.from('2_staff_entitlements').insert({
                                    staff_profile_id: profile.id,
                                    year: new Date().getFullYear(),
                                    annual_sessions: parseInt(row['Annual Sessions'] || 44)
                                });
                                if (entError) {
                                    console.error('Error creating entitlement:', entError);
                                    // Try the old table as fallback if new table doesn't exist
                                    console.warn(`Could not insert into 2_staff_entitlements: ${entError.message}`);
                                    console.log('Entitlement data saved with profile only');
                                }
                            } else {
                                const hours = parseFloat(row['Annual Hours'] || 0);
                                const { error: entError } = await supabase.from('2_staff_entitlements').insert({
                                    staff_profile_id: profile.id,
                                    year: new Date().getFullYear(),
                                    annual_hours: hours
                                });
                                if (entError) {
                                    console.error('Error creating entitlement:', entError);
                                    // Try the old table as fallback if new table doesn't exist
                                    console.warn(`Could not insert into 2_staff_entitlements: ${entError.message}`);
                                    console.log('Entitlement data saved with profile only');
                                }
                            }
                            
                            // Add working patterns
                            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                            for (const day of days) {
                                const value = row[day];
                                if (value) {
                                    const pattern = {
                                        staff_profile_id: profile.id,
                                        day_of_week: day
                                    };
                                    
                                    if (isGP) {
                                        pattern.sessions_worked = parseInt(value);
                                    } else {
                                        pattern.hours_worked = value + ':00';
                                    }
                                    
                                    const { error: patternError } = await supabase.from('3_staff_working_patterns').insert(pattern);
                                    if (patternError) {
                                        console.error('Error creating pattern:', patternError);
                                        // If RLS policy error, continue with warning
                                        if (patternError.message && patternError.message.includes('row-level security policy')) {
                                            console.warn(`RLS policy blocked work pattern for ${row['Full Name']} on ${day}`);
                                        } else {
                                            throw new Error(`Failed to create work pattern: ${patternError.message}`);
                                        }
                                    }
                                }
                            }
                        }
                        
                        processed++;
                        updateProgress(processed, uploadedData.length);
                    }
                    
                } else if (columns.includes('Staff Name') && columns.includes('Date')) {
                    // Holiday bookings
                    // First get staff mapping
                    const { data: staff, error: staffError } = await supabase
                        .from('1_staff_holiday_profiles')
                        .select('id, full_name, is_gp');
                    
                    if (staffError) {
                        console.error('Error fetching staff:', staffError);
                        throw new Error(`Failed to fetch staff profiles: ${staffError.message}`);
                    }
                    
                    const staffMap = {};
                    if (staff) {
                        staff.forEach(s => {
                            staffMap[s.full_name] = s;
                        });
                    }
                    
                    for (const row of uploadedData) {
                        const staffInfo = staffMap[row['Staff Name']];
                        if (staffInfo) {
                            const booking = {
                                staff_profile_id: staffInfo.id,
                                booking_date: row['Date'],
                                booking_type: row['Type'] || 'annual_leave'
                            };
                            
                            if (staffInfo.is_gp) {
                                booking.sessions_booked = parseInt(row['Sessions'] || 1);
                            } else {
                                booking.hours_booked = row['Hours'] + ':00';
                            }
                            
                            const { error: bookingError } = await supabase.from('4_holiday_bookings').insert(booking);
                            if (bookingError) {
                                console.error('Error inserting booking:', bookingError);
                                throw new Error(`Failed to insert booking: ${bookingError.message}`);
                            }
                        } else {
                            console.warn(`Staff member not found: ${row['Staff Name']}`);
                        }
                        
                        processed++;
                        updateProgress(processed, uploadedData.length);
                    }
                }
                
                showAlert('upload-alert', `Successfully imported ${processed} records!`, 'success');
                clearFile();
                
            } catch (error) {
                showAlert('upload-alert', 'Error: ' + error.message, 'error');
            } finally {
                progressSection.classList.add('hidden');
            }
        }

        // Update progress
        function updateProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `Processing: ${current} of ${total} (${percentage}%)`;
        }

        // Clear file
        function clearFile() {
            uploadedFile = null;
            uploadedData = null;
            fileInput.value = '';
            document.getElementById('file-info').classList.add('hidden');
            document.getElementById('data-preview-section').classList.add('hidden');
            document.getElementById('upload-progress').classList.add('hidden');
        }

        // Download template
        function downloadTemplate(type) {
            let data = [];
            let filename = '';
            
            if (type === 'staff') {
                filename = 'staff_template.xlsx';
                data = [
                    {
                        'Full Name': 'John Smith',
                        'Role': 'Nurse',
                        'Annual Hours': 200,
                        'Email': 'john.smith@example.com',
                        'Monday': '08:00',
                        'Tuesday': '08:00',
                        'Wednesday': '08:00',
                        'Thursday': '08:00',
                        'Friday': '07:30'
                    }
                ];
            } else if (type === 'gp') {
                filename = 'gp_template.xlsx';
                data = [
                    {
                        'Full Name': 'Dr. Jane Doe',
                        'Role': 'GP',
                        'Annual Sessions': 44,
                        'Email': 'jane.doe@example.com',
                        'Monday': 2,
                        'Tuesday': 2,
                        'Wednesday': 1,
                        'Thursday': 2,
                        'Friday': 1
                    }
                ];
            } else if (type === 'holidays') {
                filename = 'holidays_template.xlsx';
                data = [
                    {
                        'Staff Name': 'John Smith',
                        'Date': '2025-04-14',
                        'Hours': '08:00',
                        'Sessions': '', // Leave empty for regular staff
                        'Type': 'annual_leave'
                    },
                    {
                        'Staff Name': 'Dr. Jane Doe',
                        'Date': '2025-04-14',
                        'Hours': '', // Leave empty for GPs
                        'Sessions': 2,
                        'Type': 'annual_leave'
                    }
                ];
            }
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, filename);
        }

        // Show alert
        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.classList.remove('hidden');
            
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }

        // Check authentication on load
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'index.html';
            }
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Service Key Test - TEMPORARY ONLY</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body { font-family: monospace; padding: 20px; background: #330000; color: #ff0; }
  .warning { background: #ff0000; color: #fff; padding: 20px; margin: 20px 0; font-size: 18px; font-weight: bold; }
  .section { margin: 20px 0; padding: 15px; border: 1px solid #ff0; }
  button { padding: 10px 20px; margin: 5px; background: #550000; color: #ff0; border: 1px solid #ff0; cursor: pointer; }
  button:hover { background: #770000; }
  pre { white-space: pre-wrap; word-wrap: break-word; }
  .error { color: #f00; }
  .success { color: #0f0; }
</style>
</head>
<body>
<div class="warning">
⚠️ WARNING: THIS FILE USES SERVICE KEY - FOR TESTING ONLY!<br>
NEVER USE SERVICE KEY IN PRODUCTION!<br>
DELETE THIS FILE AFTER TESTING!
</div>

<h1>Service Key RLS Bypass Test</h1>

<div class="section">
  <h2>Test with Service Key (Bypasses RLS)</h2>
  <button onclick="testServiceUpdate()">Test Service Key Update</button>
  <button onclick="testAnonUpdate()">Test Anon Key Update (for comparison)</button>
  <button onclick="cleanupTest()">Cleanup Test Data</button>
</div>

<div class="section">
  <h2>Results</h2>
  <pre id="results"></pre>
</div>

<script>
const SUPABASE_URL = 'https://unveoqnlqnobufhublyw.supabase.co';
const ANON_KEY = 'sb_publishable_wpy7lxfbI2HwvsznlWJVKg_Zx7HnAc4';
const SERVICE_KEY = 'sb_secret_ylIhDtikpno4LTTUmpDJvw_Ov7BtIEp'; // WILL BE REVOKED AFTER TESTING

const TABLE = 'CQC All GPs';
const TEST_LOCATION_ID = '1-10240838706';

const log = (msg, data, cls = '') => {
  const results = document.getElementById('results');
  const timestamp = new Date().toISOString();
  const entry = `[${timestamp}] ${msg}${data ? '\n' + JSON.stringify(data, null, 2) : ''}`;
  const div = document.createElement('div');
  div.className = cls;
  div.textContent = entry;
  results.appendChild(div);
  results.scrollTop = results.scrollHeight;
};

async function testServiceUpdate() {
  log('Testing UPDATE with SERVICE KEY (bypasses RLS)...', null, 'warning');

  // Create client with service key
  const serviceClient = window.supabase.createClient(SUPABASE_URL, SERVICE_KEY, {
    auth: {
      autoRefreshToken: false,
      persistSession: false
    }
  });

  // Test update with unique timestamp
  const testTimestamp = new Date().toISOString();
  const testUpdate = {
    updated_at: testTimestamp,
    // Add a test field to verify the update worked
    also_known_as: 'SERVICE_KEY_TEST_' + Date.now()
  };

  const { data, error } = await serviceClient
    .from(TABLE)
    .update(testUpdate)
    .eq('location_id', TEST_LOCATION_ID)
    .select('location_id, updated_at, also_known_as');

  if (error) {
    log('Service key update failed:', error, 'error');
  } else if (!data || data.length === 0) {
    log('Service key update returned 0 rows', null, 'error');
  } else {
    log('SERVICE KEY UPDATE SUCCESSFUL!', {
      rows_updated: data.length,
      updated_at: data[0].updated_at,
      also_known_as: data[0].also_known_as
    }, 'success');
    log('This proves RLS is the only thing blocking anon updates', null, 'success');
  }
}

async function testAnonUpdate() {
  log('Testing UPDATE with ANON KEY (should be blocked by RLS)...', null, 'warning');

  const anonClient = window.supabase.createClient(SUPABASE_URL, ANON_KEY);

  const testUpdate = {
    updated_at: new Date().toISOString(),
    also_known_as: 'ANON_TEST_' + Date.now()
  };

  const { data, error } = await anonClient
    .from(TABLE)
    .update(testUpdate)
    .eq('location_id', TEST_LOCATION_ID)
    .select();

  if (error) {
    log('Anon update error:', error, 'error');
  } else if (!data || data.length === 0) {
    log('Anon update returned 0 rows (RLS BLOCKING)', null, 'error');
    log('This confirms RLS is preventing anon updates', null, 'warning');
  } else {
    log('Anon update somehow succeeded?', data, 'success');
  }
}

async function cleanupTest() {
  log('Cleaning up test data...', null, 'warning');

  const serviceClient = window.supabase.createClient(SUPABASE_URL, SERVICE_KEY, {
    auth: {
      autoRefreshToken: false,
      persistSession: false
    }
  });

  // Reset the test field
  const { data, error } = await serviceClient
    .from(TABLE)
    .update({ also_known_as: null })
    .eq('location_id', TEST_LOCATION_ID)
    .select();

  if (error) {
    log('Cleanup failed:', error, 'error');
  } else {
    log('Cleanup successful', { rows_cleaned: data?.length || 0 }, 'success');
  }
}

// Initial message
log('⚠️ SERVICE KEY TEST - DELETE THIS FILE AFTER TESTING!', null, 'error');
log('This file demonstrates that the service key bypasses RLS completely', null, 'warning');
log('Click buttons above to test', null, 'success');
</script>
</body>
</html>
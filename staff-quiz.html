<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — Weekly Knowledge Check</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://img.icons8.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="admin-nav.js"></script>
  <link rel="stylesheet" href="staff.css">
  <script src="fix-navigation-style.js"></script>
  <style>
    /* Quiz-specific styles - keeping the beautiful quiz card designs while using staff.css base */
    
    /* Override body background - let staff.css handle the main layout */
    .content {
      min-height: 100vh;
    }
    
    /* Container for quiz content */
    .quiz-container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    
    /* Quiz content area - use panel styling consistent with staff.css */
    
    /* Quiz Selection Screen */
    .quiz-home {
      display: grid;
      gap: 30px;
      animation: fadeIn 0.6s ease;
    }
    
    .welcome-banner {
      background: white;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .welcome-banner h1 {
      font-size: 36px;
      color: #667eea;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .welcome-banner p {
      color: #666;
      font-size: 18px;
    }
    
    .quiz-modes {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    
    .mode-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .mode-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }
    
    .mode-card.required {
      border-top: 4px solid #ff6b6b;
    }
    
    .mode-card.practice {
      border-top: 4px solid #4ecdc4;
    }
    
    .mode-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      border-radius: 50%;
    }
    
    .required .mode-icon {
      background: linear-gradient(135deg, #ff6b6b, #ff8787);
    }
    
    .practice .mode-icon {
      background: linear-gradient(135deg, #4ecdc4, #44a39f);
    }
    
    .mode-card h2 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 24px;
    }
    
    .mode-card p {
      text-align: center;
      color: #666;
      margin-bottom: 25px;
      line-height: 1.6;
    }
    
    .mode-status {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .countdown-display {
      font-size: 24px;
      font-weight: bold;
      color: #ff6b6b;
      margin: 10px 0;
    }
    
    /* Quiz-specific button styles are namespaced to avoid clashing with global staff `.btn` */
    .quiz-btn {
      width: 100%;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .quiz-btn-required {
      background: linear-gradient(135deg, #ff6b6b, #ff8787);
      color: white;
    }

    .quiz-btn-required:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }

    .quiz-btn-practice {
      background: linear-gradient(135deg, #4ecdc4, #44a39f);
      color: white;
    }

    .quiz-btn-practice:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
    }

    .quiz-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Quiz Taking Screen */
    .quiz-active {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      animation: slideUp 0.5s ease;
    }
    
    .quiz-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .quiz-header h2 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .quiz-header .mode-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
    }
    
    .mode-badge.required {
      background: #ffe0e0;
      color: #ff6b6b;
    }
    
    .mode-badge.practice {
      background: #d4f4f1;
      color: #44a39f;
    }
    
    .progress-container {
      margin-bottom: 30px;
    }
    
    .progress-bar {
      height: 8px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s ease;
      border-radius: 10px;
    }
    
    .progress-text {
      text-align: center;
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }
    
    .question-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      animation: fadeInUp 0.4s ease;
      border-left: 4px solid #667eea;
    }
    
    .question-number {
      color: #667eea;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .question-text {
      font-size: 18px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .options {
      display: grid;
      gap: 12px;
    }
    
    .option-label {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .option-label:hover {
      border-color: #667eea;
      background: #f7f9ff;
    }
    
    .option-label input[type="radio"] {
      margin-right: 12px;
      width: 20px;
      height: 20px;
    }
    
    .option-label.selected {
      border-color: #667eea;
      background: #f7f9ff;
    }
    
    .option-label.correct {
      border-color: #4caf50;
      background: #e8f5e9;
      animation: pulse 0.5s ease;
    }
    
    .option-label.incorrect {
      border-color: #f44336;
      background: #ffebee;
      animation: shake 0.5s ease;
    }
    
    .feedback {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      animation: fadeIn 0.3s ease;
    }
    
    .feedback.correct {
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #4caf50;
    }
    
    .feedback.incorrect {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }
    
    .quiz-actions {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    
    .quiz-btn-submit {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 40px;
      font-size: 18px;
    }

    .quiz-btn-submit:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    /* Results Screen */
    .quiz-results {
      text-align: center;
      padding: 40px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      animation: zoomIn 0.5s ease;
    }
    
    .score-display {
      font-size: 72px;
      font-weight: bold;
      margin: 20px 0;
      background: linear-gradient(135deg, #667eea, #764ba2);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
    }
    
    .score-message {
      font-size: 24px;
      margin-bottom: 20px;
    }
    
    .score-emoji {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .quiz-btn-home {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 40px;
      margin-top: 20px;
    }
    
    /* Category Selector */
    .category-selector {
      margin-bottom: 20px;
    }
    
    .category-dropdown {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      background-color: white;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
      font-size: 15px;
    }
    
    .category-dropdown:focus {
      border-color: #44a39f;
      box-shadow: 0 0 0 2px rgba(68, 163, 159, 0.2);
      outline: none;
    }
    
    /* Review Mode — interactive step-through */
.quiz-review {
  background: white;
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  animation: slideUp 0.5s ease;
}
.review-header { text-align:center; margin-bottom:18px; }
.review-header h2 { font-size: 28px; margin: 0 0 8px; }
.review-controls { display:flex; align-items:center; justify-content:center; gap:12px; margin-top:8px; }
.review-stepper { display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; max-width: 640px; }
.review-dot { width:14px; height:14px; border-radius:50%; background:#dfe3f8; border:2px solid #cfd5ff; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease; }
.review-dot.correct { background:#e8f5e9; border-color:#4caf50; }
.review-dot.incorrect { background:#ffebee; border-color:#f44336; }
.review-dot.active { transform:scale(1.2); box-shadow:0 0 0 4px rgba(102,126,234,.15); }
.review-card { background:#f8f9fa; border-radius:16px; padding:24px; border-left:4px solid #667eea; }
.review-qnum { color:#667eea; font-weight:700; margin-bottom:6px; }
.review-qtext { font-size:18px; font-weight:600; margin-bottom:14px; color:#1f2d3d; }
.choice { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border:2px solid #e0e0e0; border-radius:10px; margin-top:10px; background:white; }
.choice.correct { border-color:#4caf50; background:#e8f5e9; }
.choice.incorrect.user { border-color:#f44336; background:#ffebee; }
.pill { font-size:12px; padding:3px 8px; border-radius:999px; background:#eef2ff; font-weight:700; }
.pill.correct { background:#c8e6c9; }
.pill.yours { background:#ffe0e0; }
.explainer { margin-top:16px; padding:14px; border-radius:10px; background:#fff; border-left:4px solid #667eea; color:#1f2d3d; }
.review-actions { display:flex; justify-content:center; gap:12px; margin-top:24px; }
.review-toggles { display:flex; justify-content:center; gap:16px; margin:12px 0; color:#465362; }
.bookmark { cursor:pointer; user-select:none; display:inline-flex; align-items:center; gap:6px; font-weight:600; }
.flashcard .correct, .flashcard .incorrect { filter: blur(6px); }
.flashcard .pill { visibility:hidden; }
.keyboard-hint { text-align:center; font-size:12px; color:#7a8699; margin-top:8px; }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .hidden { display: none !important; }
    
    @media (max-width: 768px) {
      .quiz-modes {
        grid-template-columns: 1fr;
      }
      
      .welcome-banner h1 {
        font-size: 28px;
      }
    }
   /* Accessibility / Contrast Fix: ensure readable dark text inside light quiz panels
     We keep global --ink (white) for dark backgrounds elsewhere, but explicitly
     set legible colors for quiz content placed on white / light grey cards. */
   .quiz-home, .quiz-active, .quiz-results { color:#1f2d3d; }
   .quiz-home h1, .quiz-home h2, .quiz-active h2, .quiz-results h2 { color:#1c2a38; }
   .question-card, .question-text, .question-number { color:#1f2d3d; }
   .option-label { color:#1f2d3d; }
   .option-label span { color:inherit; }
   .option-label.selected { background:#f0f4ff; }
   .option-label:hover { background:#f3f7ff; }
   .option-label.correct { color:#1d5e24; }
   .option-label.incorrect { color:#8d1e1e; }
   .feedback.correct { color:#1d5e24; }
   .feedback.incorrect { color:#8d1e1e; }
   .progress-text { color:#465362; }
   .quiz-header .mode-badge.required { color:#c0392b; }
   .quiz-header .mode-badge.practice { color:#1f5e57; }
   .score-message { color:#1f2d3d; }
   /* Focus outline for keyboard users */
   .option-label:focus-within { outline:3px solid #667eea; outline-offset:2px; }

   /* Review contrast fixes — ensure readable dark text on light cards */
   .quiz-review { color:#1f2d3d; }
   .quiz-review h1, .quiz-review h2, .quiz-review h3, .quiz-review h4 { color:#1c2a38; }
   .quiz-review .review-qnum, 
   .quiz-review .review-qtext, 
   .quiz-review .choice, 
   .quiz-review .explainer, 
   .quiz-review .bookmark, 
   .quiz-review .pill { color:#1f2d3d; }
   /* Make prev/next buttons readable; keep primary action buttons as-is */
   .quiz-review .review-controls .quiz-btn { background:#e9ecef; color:#1f2d3d; }
   .quiz-review .keyboard-hint { color:#7a8699; }
   /* Keep semantic colors for correctness states */
   .quiz-review .choice.correct { color:#1d5e24; }
   .quiz-review .choice.incorrect.user { color:#8d1e1e; }
  </style>
</head>
<body>
  <div class="bg"><div class="wave"></div><div class="wave wave2"></div></div>
  <main class="content">
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav">
        <!-- Navigation will be rendered by staff-common.js -->
      </div>
      <div class="spacer"></div>
      
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>

    <!-- Quiz Content Panel -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title"><img data-i8="puzzle" data-i8-size="24" alt="" style="vertical-align: middle; margin-right: 8px;"> Weekly Knowledge Check</div>
      </div>
      
      <!-- Quiz Home Screen -->
      <div id="quiz-home" class="quiz-home">
        <div class="welcome-banner">
          <h1>
            <img data-i8="mind-map" data-i8-size="36" alt="" style="vertical-align: middle; margin-right: 10px;">
            Weekly Knowledge Check
          </h1>
          <p>Stay sharp with our weekly required quiz and unlimited practice sessions!</p>
        </div>
        
        <div class="quiz-modes">
          <!-- Required Quiz Card -->
          <div class="mode-card required">
            <div class="mode-icon"><img data-i8="clipboard" data-i8-size="40" alt="Required Quiz"></div>
            <h2>Required Weekly Quiz</h2>
            <p>Complete your mandatory weekly assessment. One attempt per week, results are recorded.</p>
            
            <div id="required-status" class="mode-status">
              <!-- Status will be populated by JavaScript -->
            </div>
            
            <button id="btn-required" class="quiz-btn quiz-btn-required">
              Start Required Quiz
            </button>
          </div>
          
          <!-- Practice Quiz Card -->
          <div class="mode-card practice">
            <div class="mode-icon"><img data-i8="target" data-i8-size="40" alt="Practice Quiz"></div>
            <h2>Practice Mode</h2>
            <p>Sharpen your skills anytime! Unlimited attempts, learn at your own pace.</p>
            
            <div class="mode-status">
              <p style="color: #44a39f; font-weight: 600;">
                ✨ Always Available
              </p>
              <p style="font-size: 14px; color: #666; margin-top: 5px;">
                Practice makes perfect!
              </p>
            </div>
            
            <div class="category-selector" style="margin-bottom: 15px;">
              <label for="category-select" style="display: block; margin-bottom: 8px; font-weight: 600; color: #44a39f;">Select Category:</label>
              <select id="category-select" class="category-dropdown" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #e0e0e0; background-color: white; font-family: 'Inter', sans-serif;">
                <option value="all">All Categories (Mixed)</option>
                <option value="Health & Safety">Health & Safety</option>
                <option value="Fire Safety">Fire Safety</option>
                <option value="Infection Control">Infection Control</option>
                <option value="Equipment">Equipment</option>
                <option value="Procedures">Procedures</option>
              </select>
            </div>
            
            <button id="btn-practice" class="quiz-btn quiz-btn-practice">
              Start Practice Quiz
            </button>
          </div>
        </div>
      </div>
      
      <!-- Quiz Taking Screen -->
      <div id="quiz-active" class="quiz-active hidden">
        <div class="quiz-header">
          <h2 id="quiz-title">Quiz in Progress</h2>
          <span id="mode-badge" class="mode-badge"></span>
        </div>
        
        <div class="progress-container">
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
          </div>
          <div id="progress-text" class="progress-text">Question 0 of 10</div>
        </div>
        
        <div id="questions-container">
          <!-- Questions will be populated here -->
        </div>
        
        <div class="quiz-actions">
          <button id="btn-submit" class="quiz-btn quiz-btn-submit" disabled>
            Submit Quiz
          </button>
        </div>
      </div>
      
      <!-- Review Screen -->
      <div id="quiz-review" class="quiz-review hidden">
        <div class="review-header">
          <h2>
            <img data-i8="books" data-i8-size="24" alt="Learn" style="vertical-align: middle; margin-right: 8px;"> Review & Learn
          </h2>
          <div class="review-controls">
            <button id="review-prev" class="quiz-btn" aria-label="Previous question">◀ Prev</button>
            <button id="review-next" class="quiz-btn" aria-label="Next question">Next ▶</button>
          </div>
          <div class="keyboard-hint">Pro tip: use ← / → to move between questions</div>
        </div>

        <div id="review-card" class="review-card" role="region" aria-live="polite"></div>

        <div class="review-actions">
          <button id="btn-review-summary" class="quiz-btn quiz-btn-submit">
            <img data-i8="clipboard" data-i8-size="16" alt=""> Skip to summary
          </button>
        </div>
      </div>
      <!-- Results Screen -->
      <div id="quiz-results" class="quiz-results hidden">
        <div class="score-emoji" id="score-emoji"><img data-i8="confetti" data-i8-size="64" alt="Celebration" id="score-emoji-img"></div>
        <h2>Quiz Complete!</h2>
        <div class="score-display" id="score-display">0/10</div>
        <div class="score-message" id="score-message">Good effort!</div>
        <div id="result-mode-info" style="margin: 20px 0; color: #666;"></div>
        <button id="btn-home" class="quiz-btn quiz-btn-home">
            Back to Quiz Home
          </button>
      </div>
    </div>

    <div class="muted" style="text-align:center; font-size:12px; padding:10px 0;">© CheckLoop • Weekly Knowledge Check</div>
  </main>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, clearAuthData, createAchievementClient } from './staff-common.js';
    
    // Initialize Supabase
    const supabase = await initSupabase();
    // Make supabase available globally for Admin Portal button
    window.supabase = supabase;
    handleAuthState(supabase);
    navActivate('quiz');

    // Admin nav removed - separate staff portal
    
let currentUser = null;
let currentProfile = null;
let achievementClient = null;
let currentQuestions = [];
let currentMode = null;
let userAnswers = {};
let quizStartTime = null;
let reviewIndex = 0;
let reviewResults = [];

async function refreshPracticeAchievements({ scorePercent, totalQuestions }) {
  if (!achievementClient) return;
  try {
    const { count } = await supabase
      .from('quiz_practices')
      .select('id', { count: 'exact', head: true })
      .eq('user_id', currentUser.id);

    const totalPractices = count ?? 0;
    await achievementClient.ensureUnlocked('practice_pro', {
      condition: totalPractices >= 5,
      metadata: {
        totalPractices,
        scorePercent,
        totalQuestions,
        mode: 'practice'
      }
    });
  } catch (err) {
    console.warn('Failed to refresh practice achievements:', err);
  }
}

async function refreshRequiredAchievements({ scorePercent, totalQuestions }) {
  if (!achievementClient) return;
  try {
    const { count } = await supabase
      .from('quiz_attempts')
      .select('id', { count: 'exact', head: true })
      .eq('user_id', currentUser.id)
      .eq('is_practice', false);

    const totalRequired = count ?? 0;
    await achievementClient.ensureUnlocked('quiz_hat_trick', {
      condition: totalRequired >= 3,
      metadata: {
        totalRequired,
        scorePercent,
        totalQuestions,
        mode: 'required'
      }
    });
  } catch (err) {
    console.warn('Failed to refresh required-quiz achievements:', err);
  }
}
    
    // Get start of current week (Sunday at 00:00:00)
    function getWeekStart(date = new Date()) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day;
      const weekStart = new Date(d.setDate(diff));
      weekStart.setHours(0, 0, 0, 0);
      return weekStart;
    }
    
    // Get end of current week (Saturday at 23:59:59)
    function getWeekEnd(date = new Date()) {
      const start = getWeekStart(date);
      const weekEnd = new Date(start.getTime() + 6 * 24 * 60 * 60 * 1000);
      weekEnd.setHours(23, 59, 59, 999);
      return weekEnd;
    }
    
    // Get next week start (next Sunday)
    function getNextWeekStart(date = new Date()) {
      const end = getWeekEnd(date);
      return new Date(end.getTime() + 24 * 60 * 60 * 1000);
    }
    
    // Format countdown
    function formatCountdown(ms) {
      if (ms <= 0) return 'Ready now!';
      
      const days = Math.floor(ms / (24 * 60 * 60 * 1000));
      const hours = Math.floor((ms % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
      const minutes = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
      
      const parts = [];
      if (days > 0) parts.push(`${days}d`);
      if (hours > 0) parts.push(`${hours}h`);
      if (minutes > 0 || parts.length === 0) parts.push(`${minutes}m`);
      
      return parts.join(' ');
    }
    
    // Check if quiz was taken this week using master_users only
    async function checkWeeklyQuizStatus() {
      console.log('📅 Checking weekly quiz status (master_users)…');
      const fallback = { taken: false, lastAttempt: null, nextAvailable: new Date() };

      if (!currentUser?.id) {
        console.error('📅 No current user ID available');
        return fallback;
      }

      try {
        const { data, error } = await supabase
          .from('master_users')
          .select('auth_user_id, next_quiz_due, last_required_quiz_at')
          .eq('auth_user_id', currentUser.id)
          .limit(1)
          .maybeSingle();

        if (error) {
          console.error('📅 master_users read error:', error);
          return fallback;
        }

        const now = new Date();
        const nextDue = data?.next_quiz_due ? new Date(data.next_quiz_due) : null;
        const last = data?.last_required_quiz_at ? new Date(data.last_required_quiz_at) : null;

        if (nextDue && nextDue.getTime() > now.getTime()) {
          return { taken: true, lastAttempt: last, nextAvailable: nextDue };
        }

        return { taken: false, lastAttempt: last, nextAvailable: now };
      } catch (err) {
        console.error('📅 Exception checking quiz status:', err);
        return fallback;
      }
    }
    
    // Update required quiz status display
    async function updateRequiredQuizStatus() {
      const status = await checkWeeklyQuizStatus();
      const statusEl = document.getElementById('required-status');
      const btnRequired = document.getElementById('btn-required');
      
      if (status.taken) {
        // Quiz already taken this week
        const msUntilNext = status.nextAvailable.getTime() - Date.now();
        statusEl.innerHTML = `
          <p style="color: #28a745; font-weight: 600; margin-bottom: 10px;">
            ✅ Week's Quiz Complete!
          </p>
          <p style="font-size: 14px; color: #666;">Next quiz available:</p>
          <div class="countdown-display" id="countdown">
            ${formatCountdown(msUntilNext)}
          </div>
        `;
        btnRequired.disabled = true;
        btnRequired.textContent = 'Completed This Week';
        
        // Update countdown every minute
        setInterval(() => {
          const ms = status.nextAvailable.getTime() - Date.now();
          const countdownEl = document.getElementById('countdown');
          if (countdownEl) {
            countdownEl.textContent = formatCountdown(ms);
            if (ms <= 0) {
              // Refresh quiz state instead of reloading page to prevent debugger interference
              if (typeof checkQuizAvailability === 'function') {
                checkQuizAvailability();
              } else if (typeof loadQuizState === 'function') {
                loadQuizState();
              } else if (typeof initQuiz === 'function') {
                initQuiz();
              }
            }
          }
        }, 60000);
      } else {
        // Quiz available
        statusEl.innerHTML = `
          <p style="color: #ff6b6b; font-weight: 600;">
            ⏰ Quiz Due This Week!
          </p>
          <p style="font-size: 14px; color: #666; margin-top: 5px;">
            Complete before Saturday midnight
          </p>
        `;
        btnRequired.disabled = false;
        btnRequired.textContent = 'Start Required Quiz';
      }
    }
    
    // Fetch quiz questions
    async function fetchQuestions() {
      console.log('🔍 fetchQuestions: Starting to fetch questions...');
      
      // For now, let's use the fallback questions since the database join isn't working
      // The issue is that quiz_options join is returning 0 options for all questions
      // This needs to be investigated with database permissions
      console.log('🔍 fetchQuestions: Using fallback questions (database join issue)');
      return [
        { id: 1, question: 'What should you check first in a safety inspection?', choices: ['PPE availability', 'Kitchen menu', 'Visitor log', 'Weather forecast'], answer: 0, category: 'Health & Safety', explanation: 'Start by ensuring essential protective equipment is available and fit for purpose so staff can safely address any hazards.' },
        { id: 2, question: 'Hand hygiene should last at least how many seconds?', choices: ['5 seconds', '10 seconds', '20 seconds', '40 seconds'], answer: 2, category: 'Infection Control', explanation: 'Rub for ≥20 seconds to cover all hand surfaces; this duration is shown to reduce microbial load effectively.' },
        { id: 3, question: 'Which waste goes into a sharps bin?', choices: ['Used needles', 'Food scraps', 'Paper towels', 'Plastic bottles'], answer: 0, category: 'Infection Control', explanation: 'Sharps bins are for items that can puncture skin (e.g., needles, blades). Never overfill and always close properly.' },
        { id: 4, question: 'When should you report a near-miss incident?', choices: ['End of the week', 'Immediately', 'During monthly review', 'Never'], answer: 1, category: 'Health & Safety', explanation: 'Report immediately so learning can happen quickly and the risk can be controlled before harm occurs.' },
        { id: 5, question: 'Which is NOT a fire class?', choices: ['Class A', 'Class B', 'Class D', 'Class H'], answer: 3, category: 'Fire Safety', explanation: 'UK fire classes include A, B, C, D, and F. There is no Class H.' },
        { id: 6, question: 'What is the correct method to lift a heavy box?', choices: ['Back bent, legs straight', 'Back straight, bend knees', 'Twist the spine', 'Hold with fingertips'], answer: 1, category: 'Health & Safety', explanation: 'Keep the back neutral, bend at the knees and hips, hold load close, and avoid twisting to protect the spine.' },
        { id: 7, question: 'A spill kit is used to handle?', choices: ['Electrical faults', 'Chemical spills', 'Printer jams', 'Lost property'], answer: 1, category: 'Health & Safety', explanation: 'Spill kits contain absorbents and PPE designed for chemical/biological spills—always check the kit type matches the substance.' },
        { id: 8, question: 'PAT testing refers to?', choices: ['Patient testing', 'Portable Appliance Testing', 'Public Area Testing', 'Pressure and Temperature'], answer: 1, category: 'Equipment', explanation: 'Portable Appliance Testing checks electrical safety of plug-in equipment to reduce shock and fire risks.' },
        { id: 9, question: 'What temperature should hot food be kept at?', choices: ['Above 45°C', 'Above 55°C', 'Above 63°C', 'Above 75°C'], answer: 2, category: 'Health & Safety', explanation: 'In the UK, hot holding should be at ≥63°C to keep food out of the bacterial “danger zone”.' },
        { id: 10, question: 'How often should fire alarms be tested?', choices: ['Daily', 'Weekly', 'Monthly', 'Yearly'], answer: 1, category: 'Fire Safety', explanation: 'A weekly functional test helps ensure the system, call points and sounders work between formal inspections.' },
        { id: 11, question: 'What color is a CO2 fire extinguisher?', choices: ['Red', 'Black', 'Blue', 'Cream'], answer: 1, category: 'Fire Safety', explanation: 'CO₂ extinguishers are marked with a black label; they’re suitable for electrical and Class B (liquid) fires.' },
        { id: 12, question: 'COSHH stands for?', choices: ['Control of Substances Hazardous to Health', 'Committee of Safety and Health Hazards', 'Certificate of Safe Handling and Hygiene', 'Central Office for Safety and Health'], answer: 0, category: 'Health & Safety', explanation: 'COSHH is UK regulation requiring employers to control hazardous substances exposure.' },
        { id: 13, question: 'What is the minimum rest break for a 6-hour shift?', choices: ['10 minutes', '20 minutes', '30 minutes', '45 minutes'], answer: 1, category: 'Procedures', explanation: 'Working Time Regulations: workers are entitled to an uninterrupted 20‑minute rest if working more than 6 hours.' },
        { id: 14, question: 'Which PPE protects against airborne particles?', choices: ['Safety glasses', 'FFP3 mask', 'Latex gloves', 'Steel toe boots'], answer: 1, category: 'Infection Control', explanation: 'FFP3 respirators filter fine aerosols; fit testing is essential for an effective seal.' },
        { id: 15, question: 'What is the first step in risk assessment?', choices: ['Control measures', 'Identify hazards', 'Training staff', 'Document findings'], answer: 1, category: 'Health & Safety', explanation: 'Risk assessment starts by identifying hazards; then evaluate risks, control, record, and review.' }
      ];
    }
    
    // Shuffle and pick random questions
    function pickRandomQuestions(questions, count = 10) {
      const shuffled = [...questions].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, Math.min(count, shuffled.length));
    }
    
    // Render quiz questions
    function renderQuiz(questions) {
      console.log('🎨 renderQuiz: Starting to render', questions?.length, 'questions');
      const container = document.getElementById('questions-container');
      if (!container) {
        console.error('🎨 renderQuiz: Questions container not found!');
        return;
      }
      
      container.innerHTML = '';
      
      if (!questions || questions.length === 0) {
        console.error('🎨 renderQuiz: No questions to render!');
        container.innerHTML = '<div class="question-card"><p>No questions available. Please try again.</p></div>';
        return;
      }
      
      questions.forEach((q, index) => {
        console.log('🎨 renderQuiz: Rendering question', index + 1, ':', q.question?.substring(0, 50) + '...');
        const questionCard = document.createElement('div');
        questionCard.className = 'question-card';
        questionCard.innerHTML = `
          <div class="question-number">Question ${index + 1}</div>
          <div class="question-text">${q.question}</div>
          <div class="options">
            ${q.choices.map((choice, choiceIndex) => `
              <label class="option-label" data-question="${index}" data-choice="${choiceIndex}">
                <input type="radio" name="q_${index}" value="${choiceIndex}" />
                <span>${choice}</span>
              </label>
            `).join('')}
          </div>
          <div id="feedback_${index}" class="feedback hidden"></div>
        `;
        container.appendChild(questionCard);
      });
      
      console.log('🎨 renderQuiz: Successfully rendered', questions.length, 'questions to DOM');
      
      // Add event listeners
      document.querySelectorAll('input[type="radio"]').forEach(input => {
        input.addEventListener('change', (e) => {
          const questionIndex = parseInt(e.target.name.split('_')[1]);
          userAnswers[questionIndex] = parseInt(e.target.value);
          
          // Update option styling
          document.querySelectorAll(`[data-question="${questionIndex}"]`).forEach(label => {
            label.classList.remove('selected');
          });
          e.target.closest('.option-label').classList.add('selected');
          
          updateProgress();
        });
      });
    }
    
    // Update progress
    function updateProgress() {
      const total = currentQuestions.length;
      const answered = Object.keys(userAnswers).length;
      const percentage = (answered / total) * 100;
      
      document.getElementById('progress-fill').style.width = `${percentage}%`;
      document.getElementById('progress-text').textContent = `Question ${answered} of ${total} answered`;
      
      // Enable submit button when all questions answered
      document.getElementById('btn-submit').disabled = answered < total;
    }
    
    // Start quiz
    async function startQuiz(mode) {
      console.log('🎯 startQuiz: Starting quiz in mode:', mode);
      
      // If this is a required quiz, check if already completed this week
      if (mode === 'required') {
        console.log('🎯 startQuiz: Checking weekly restriction for required quiz');
        
        // Double-check the weekly status to prevent bypassing
        const status = await checkWeeklyQuizStatus();
        console.log('🎯 startQuiz: Weekly status result:', status);
        
        if (status.taken) {
          console.log('🎯 startQuiz: Required quiz already completed this week, blocking');
          const nextAvailable = status.nextAvailable;
          const daysUntilNext = Math.ceil((nextAvailable.getTime() - Date.now()) / (1000 * 60 * 60 * 24));
          alert(`You have already completed the required quiz this week. Please wait until next Sunday (${daysUntilNext} days) to take it again.`);
          return;
        }
        
        console.log('🎯 startQuiz: Weekly restriction check passed, proceeding with quiz');
      }
      
      currentMode = mode;
      userAnswers = {};
      quizStartTime = new Date();
      
      // Get the selected category for practice quiz
      let selectedCategory = 'all';
      if (mode === 'practice') {
        selectedCategory = document.getElementById('category-select')?.value || 'all';
        console.log('🎯 startQuiz: Selected category:', selectedCategory);
      }
      
      // Fetch and prepare questions
      console.log('🎯 startQuiz: Fetching questions...');
      const allQuestions = await fetchQuestions();
      console.log('🎯 startQuiz: Got questions:', allQuestions?.length);
      
      // Filter questions by category if one is selected
      let filteredQuestions = allQuestions;
      if (mode === 'practice' && selectedCategory !== 'all') {
        filteredQuestions = allQuestions.filter(q => {
          // Each question has a hardcoded category in its object
          // We can extract it or match against it
          const questionCategory = q.category || 'Unknown';
          return questionCategory === selectedCategory;
        });
        console.log('🎯 startQuiz: Filtered to', filteredQuestions.length, 'questions in category:', selectedCategory);
        
        // If we don't have enough questions in the category, fall back to all questions
        if (filteredQuestions.length < 5) {
          console.log('🎯 startQuiz: Not enough questions in category, using all questions');
          filteredQuestions = allQuestions;
        }
      }
      
      currentQuestions = pickRandomQuestions(filteredQuestions, 10);
      console.log('🎯 startQuiz: Selected questions for quiz:', currentQuestions?.length);
      
      // Update UI
      document.getElementById('quiz-home').classList.add('hidden');
      document.getElementById('quiz-active').classList.remove('hidden');
      document.getElementById('quiz-results').classList.add('hidden');
      
      // Set mode-specific UI
      const titleEl = document.getElementById('quiz-title');
      const badgeEl = document.getElementById('mode-badge');
      
      if (mode === 'required') {
        titleEl.textContent = 'Required Weekly Quiz';
        badgeEl.innerHTML = '<img data-i8="clipboard" data-i8-size="16" alt="" style="vertical-align: middle; margin-right: 4px;"> Official - Results Recorded';
        badgeEl.className = 'mode-badge required';
      } else {
        const selectedCategory = document.getElementById('category-select')?.value || 'all';
        const categoryText = selectedCategory === 'all' ? 'Mixed Categories' : selectedCategory;
        
        titleEl.textContent = `Practice Quiz: ${categoryText}`;
        badgeEl.innerHTML = '<img data-i8="target" data-i8-size="16" alt="" style="vertical-align: middle; margin-right: 4px;"> Practice - Learn & Improve';
        badgeEl.className = 'mode-badge practice';
      }
      
      // Re-wire icons after setting innerHTML
      try {
        wireIcons();
      } catch (e) {
        console.error('Error wiring icons:', e);
      }
      
      // Render questions
      console.log('🎯 startQuiz: Rendering questions...');
      renderQuiz(currentQuestions);
      updateProgress();
      console.log('🎯 startQuiz: Quiz started successfully');
    }
    
    // Submit quiz
    async function submitQuiz() {
      const btnSubmit = document.getElementById('btn-submit');
      btnSubmit.disabled = true;
      btnSubmit.textContent = 'Submitting...';
      
      // Calculate score
      let correctCount = 0;
      currentQuestions.forEach((q, index) => {
        const userAnswer = userAnswers[index];
        const isCorrect = userAnswer === q.answer;
        if (isCorrect) correctCount++;
        
        // Show feedback
        const feedbackEl = document.getElementById(`feedback_${index}`);
        const optionLabels = document.querySelectorAll(`[data-question="${index}"]`);
        
        optionLabels.forEach((label, choiceIndex) => {
          if (choiceIndex === q.answer) {
            label.classList.add('correct');
          } else if (choiceIndex === userAnswer && !isCorrect) {
            label.classList.add('incorrect');
          }
        });
        
        if (feedbackEl) {
          feedbackEl.classList.remove('hidden');
          if (isCorrect) {
            feedbackEl.className = 'feedback correct';
            feedbackEl.innerHTML = '✅ Correct!';
          } else {
            feedbackEl.className = 'feedback incorrect';
            feedbackEl.innerHTML = `❌ Incorrect. The correct answer is: ${q.choices[q.answer]}`;
          }
        }
      });
      
      const scorePercent = Math.round((correctCount / currentQuestions.length) * 100);
      
      // Save to database
      console.log('💾 submitQuiz: Saving to database, mode:', currentMode);
      try {
        if (currentMode === 'required') {
          console.log('💾 submitQuiz: Recording required quiz in master_users via upsert');

          const completedAt = new Date();
          const nextDue = new Date(completedAt);
          nextDue.setDate(nextDue.getDate() + 7);

          // Update just the quiz-related fields to avoid issues with other constraints
          const { error: muErr } = await supabase
            .from('master_users')
            .update({
              next_quiz_due: nextDue.toISOString(),
              last_required_quiz_at: completedAt.toISOString()
            })
            .eq('auth_user_id', currentUser.id);

          if (muErr) {
            console.error('💾 submitQuiz: master_users update error:', muErr);
            showToast('⚠️ Could not record required quiz. Please try again.');
          } else {
            console.log('💾 submitQuiz: master_users updated successfully (next_quiz_due, last_required_quiz_at)');
            showToast('✅ Required quiz recorded.');
            await refreshRequiredAchievements({ scorePercent, totalQuestions: currentQuestions.length });
          }
        } else {
          // Save to quiz_practices if table exists
          console.log('💾 submitQuiz: Saving practice quiz to quiz_practices table');
          try {
            const insertData = {
              user_id: currentUser.id,
              site_id: currentProfile?.site_id || null,
              started_at: quizStartTime.toISOString(),
              completed_at: new Date().toISOString(),
              score: correctCount,
              total_questions: currentQuestions.length,
              score_percent: scorePercent
            };
            console.log('💾 submitQuiz: Practice insert data:', insertData);

              const { data, error } = await supabase.from('quiz_practices').insert(insertData);

            if (error) {
              console.error('💾 submitQuiz: Error saving practice quiz:', error);
              showToast('⚠️ Could not save practice quiz; continuing.');
              
              // Special handling for kiosk_users not exist error
              if (error.message && error.message.includes('kiosk_users') && error.message.includes('does not exist')) {
                console.log('💾 submitQuiz: Detected kiosk_users migration issue in practice quiz, trying alternate approach');
                
                try {
                  // Try direct insert without RLS - this avoids the kiosk_users reference
                  const directInsert = {
                    ...insertData,
                    // Ensure we have the required fields
                    created_at: new Date().toISOString()
                  };
                  
                  // Get API key from supabase client
                  const apiKey = supabase.supabaseKey || window.SUPABASE_KEY || window.SUPABASE_ANON_KEY || '';
                  // Try with a different endpoint that bypasses RLS
                  const directResult = await fetch(`${window.SUPABASE_URL || 'https://unveoqnlqnobufhublyw.supabase.co'}/rest/v1/quiz_practices`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${sessionData?.session?.access_token || ''}`,
                      'apikey': apiKey
                    },
                    body: JSON.stringify(directInsert)
                  });
                  
                  if (directResult.ok) {
                    console.log('💾 submitQuiz: Direct practice insert successful!');
                    // Continue with quiz completion
                  } else {
                    const errorText = await directResult.text();
                    console.error('💾 submitQuiz: Direct practice insert also failed:', errorText);
                    // Continue anyway since practice quiz is not critical
                  }
                } catch (directError) {
                  console.error('💾 submitQuiz: Error with direct practice insert:', directError);
                  // Continue anyway since practice quiz is not critical
                }
              }
              // For practice quiz, we don't block the flow if saving fails
            } else {
              console.log('💾 submitQuiz: Practice quiz saved successfully:', data);
              showToast('✅ Practice quiz saved.');

              if (achievementClient) {
                try {
                  await achievementClient.ensureUnlocked('first_practice_quiz', {
                    metadata: {
                      mode: 'practice',
                      scorePercent,
                      totalQuestions: currentQuestions.length
                    }
                  });
                  await refreshPracticeAchievements({ scorePercent, totalQuestions: currentQuestions.length });
                } catch (achievementError) {
                  console.warn('Failed to unlock first_practice_quiz achievement:', achievementError);
                }
              }
            }
          } catch (err) {
            console.error('💾 submitQuiz: Exception saving practice quiz:', err);
          }
        }
      } catch (err) {
        console.error('💾 submitQuiz: Error saving quiz attempt:', err);
      }
      
      // Build review payload and enter Review Mode first
      if (achievementClient) {
        try {
          await achievementClient.ensureUnlocked('quiz_complete', {
            condition: currentMode === 'required',
            metadata: {
              mode: currentMode,
              scorePercent,
              totalQuestions: currentQuestions.length
            }
          });
          await achievementClient.ensureUnlocked('quiz_perfect', {
            condition: scorePercent === 100,
            metadata: {
              mode: currentMode,
              totalQuestions: currentQuestions.length
            }
          });
        } catch (achievementErr) {
          console.warn('Quiz achievement unlock failed:', achievementErr);
        }
      }

      reviewResults = currentQuestions.map((q, index) => ({
        question: q.question,
        choices: q.choices,
        category: q.category || 'Mixed',
        explanation: q.explanation || null,
        correctIndex: q.answer,
        userIndex: userAnswers[index] ?? null,
        isCorrect: userAnswers[index] === q.answer
      }));
      startReview(correctCount, currentQuestions.length, scorePercent);

      // If this was a required quiz, refresh the status and next due (UI only)
      if (currentMode === 'required') {
        console.log('💾 submitQuiz: Required quiz completed, refreshing status');
        // Wait a moment so any DB writes settle
        setTimeout(async () => { await updateRequiredQuizStatus(); }, 500);
      }
    }
    
    // Show toast notification
    function showToast(message, duration = 3000) {
      const existingToast = document.querySelector('.achievement-toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = 'achievement-toast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: linear-gradient(135deg, #6366f1, #22d3ee);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        font-weight: 600;
        z-index: 10000;
        transition: transform 0.3s ease;
        box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
      `;
      document.body.appendChild(toast);

      // Animate in
      requestAnimationFrame(() => {
        toast.style.transform = 'translateX(-50%) translateY(0)';
      });

      // Remove after duration
      setTimeout(() => {
        toast.style.transform = 'translateX(-50%) translateY(100px)';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ===== Review Mode (interactive) =====
    function startReview(correct, total, percentage){
      // Show review UI
      document.getElementById('quiz-active').classList.add('hidden');
      document.getElementById('quiz-results').classList.add('hidden');
      const reviewEl = document.getElementById('quiz-review');
      reviewEl.classList.remove('hidden');

      // Wire controls
      document.getElementById('review-prev').onclick = () => gotoReviewIndex(reviewIndex - 1);
      document.getElementById('review-next').onclick = () => gotoReviewIndex(reviewIndex + 1);
      document.getElementById('btn-review-summary').onclick = () => {
        reviewEl.classList.add('hidden');
        showResults(correct, total, percentage);
      };
      document.addEventListener('keydown', reviewKeyHandler);

      // Initial render
      reviewIndex = 0;
      gotoReviewIndex(0);
      try { wireIcons(); } catch(e){}
    }

    function reviewKeyHandler(e){
      if (document.getElementById('quiz-review').classList.contains('hidden')) return;
      if (e.key === 'ArrowLeft') { e.preventDefault(); gotoReviewIndex(reviewIndex - 1); }
      if (e.key === 'ArrowRight') { e.preventDefault(); gotoReviewIndex(reviewIndex + 1); }
    }

    function gotoReviewIndex(i){
      const max = reviewResults.length - 1;
      if (i < 0) i = 0; if (i > max) i = max;
      reviewIndex = i;
      renderReviewCard();
    }

    function renderReviewCard(){
      const card = document.getElementById('review-card');
      const r = reviewResults[reviewIndex];

      const makeChoiceRow = (text, idx) => {
        const isCorrect = idx === r.correctIndex;
        const isUser = idx === r.userIndex;
        const cls = ['choice'];
        if (isCorrect) cls.push('correct');
        if (!isCorrect && isUser) cls.push('incorrect','user');
        const pill = isCorrect ? '<span class="pill correct">Correct</span>' : (isUser ? '<span class="pill yours">Your answer</span>' : '<span class="pill" style="visibility:hidden">&nbsp;</span>');
        return `<div class="${cls.join(' ')}"><span>${text}</span>${pill}</div>`;
      };

      card.innerHTML = `
        <div class="review-qnum">Question ${reviewIndex+1} • <span style="opacity:.8">${r.category}</span></div>
        <div class="review-qtext">${r.question}</div>
        ${r.choices.map((c, idx) => makeChoiceRow(c, idx)).join('')}
        <div class="explainer">
          <strong><img data-i8="light-on" data-i8-size="16" alt=""> Why this is correct</strong>
          <div style="margin-top:8px">${r.explanation || 'This question reinforces good practice.'}</div>
        </div>
      `;

      try { wireIcons(); } catch(e){}
    }



    // Show results
    function showResults(correct, total, percentage) {
      document.getElementById('quiz-active').classList.add('hidden');
      document.getElementById('quiz-results').classList.remove('hidden');
      
      // Set score display
      document.getElementById('score-display').textContent = `${correct}/${total}`;
      
      // Set emoji and message based on score
      const emojiImg = document.getElementById('score-emoji-img');
      const messageEl = document.getElementById('score-message');
      
      if (percentage === 100) {
        emojiImg.setAttribute('data-i8', 'trophy');
        emojiImg.alt = 'Trophy';
        messageEl.textContent = 'Perfect Score! Outstanding!';
      } else if (percentage >= 80) {
        emojiImg.setAttribute('data-i8', 'confetti');
        emojiImg.alt = 'Celebration';
        messageEl.textContent = 'Excellent Work!';
      } else if (percentage >= 60) {
        emojiImg.setAttribute('data-i8', 'thumbs-up');
        emojiImg.alt = 'Good job';
        messageEl.textContent = 'Good Job!';
      } else if (percentage >= 40) {
        emojiImg.setAttribute('data-i8', 'flexed-biceps');
        emojiImg.alt = 'Keep trying';
        messageEl.textContent = 'Keep Practicing!';
      } else {
        emojiImg.setAttribute('data-i8', 'books');
        emojiImg.alt = 'Study more';
        messageEl.textContent = 'Review and Try Again!';
      }
      
      // Re-wire the icon after changing the data-i8 attribute
      setIcon(emojiImg);
      
      // Set mode info
      const modeInfoEl = document.getElementById('result-mode-info');
      if (currentMode === 'required') {
        modeInfoEl.innerHTML = `
          <strong><img data-i8="checkmark" data-i8-size="16" alt="" style="vertical-align: middle; margin-right: 4px;"> Required Quiz Complete</strong><br>
          Your result has been recorded. See you next week!
        `;
      } else {
        // For practice quiz, check if we used a specific category
        const categoryName = currentQuestions.length > 0 && currentQuestions[0].category 
          ? currentQuestions[0].category 
          : 'Mixed Categories';
        
        modeInfoEl.innerHTML = `
          <strong><img data-i8="target" data-i8-size="16" alt="" style="vertical-align: middle; margin-right: 4px;"> Practice Complete: ${categoryName}</strong><br>
          Great practice session! Try again anytime to improve.
        `;
      }
      
      // Re-wire icons after setting innerHTML
      try {
        wireIcons();
      } catch (e) {
        console.error('Error wiring icons:', e);
      }
    }
    
    // Initialize using requireStaffSession like other staff pages
    requireStaffSession(supabase).then(async ({ session, profileRow }) => {
      currentUser = session.user;
      currentProfile = profileRow;

      try {
        achievementClient = await createAchievementClient({
          supabase,
          session,
          profile: profileRow
        });
      } catch (err) {
        console.warn('Quiz achievement client failed to initialise', err);
      }

      // Set topbar info
      const siteId = profileRow?.site_id;
      const siteText = siteId ? await getSiteText(supabase, siteId) : null;
      const accessType = profileRow?.access_type || session.user?.raw_user_meta_data?.access_type || null;
      const role = (accessType || profileRow?.role || 'Staff');
      setTopbar({
        siteText,
        email: session.user.email,
        role: role,
        access_type: accessType || profileRow?.role
      });

      // Set up logout handler using staff-common function
      const { attachLogout } = await import('./staff-common.js');
      attachLogout(supabase);
      
      // Update required quiz status
      await updateRequiredQuizStatus();
      
      // Event listeners
      document.getElementById('btn-required').addEventListener('click', () => {
        startQuiz('required');
      });
      
      document.getElementById('btn-practice').addEventListener('click', () => {
        startQuiz('practice');
      });
      
      document.getElementById('btn-submit').addEventListener('click', submitQuiz);
      
      document.getElementById('btn-home').addEventListener('click', async () => {
        // Reset to initial state and refresh status
        document.getElementById('quiz-home').classList.remove('hidden');
        document.getElementById('quiz-active').classList.add('hidden');
        document.getElementById('quiz-results').classList.add('hidden');
        
        // Force refresh the quiz status to ensure UI is up to date
        // Add a small delay to ensure database write is complete
        console.log('🔄 Returning to quiz home, refreshing status...');
        setTimeout(async () => {
          await updateRequiredQuizStatus();
        }, 100);
        
        // Reset variables
        currentMode = null;
        userAnswers = {};
        currentQuestions = [];
      });
      
    }).catch(e => {
      if (String(e.message).includes('NO_SESSION')) { window.location.replace('home.html'); return; }
      if (String(e.message).includes('NOT_STAFF')) { window.location.replace('home.html'); return; }
      console.error('Quiz page initialization error:', e);
    });
    
    // Icon service functions
    function i8(name, opts = {}) {
      var base  = 'https://img.icons8.com';
      var style = opts.style || 'cute-color';
      var size  = opts.size  || 48;
      // Icons8 OMG-IMG pattern is style/size/name.png
      var path  = [style, String(size), encodeURIComponent(name) + '.png'].join('/');
      return base + '/' + path;
    }
    
    function setIcon(el){
      var name  = el.getAttribute('data-i8');
      var size  = el.getAttribute('data-i8-size');
      var style = el.getAttribute('data-i8-style') || 'fluency';
      var fallback = (el.getAttribute('data-i8-fallback') || '').toLowerCase();
      
      if (fallback === 'auto') {
        var stylesToTry = [style, 'fluency', 'color'];
        var idx = 0;
        function tryNext(){
          if (idx >= stylesToTry.length) { el.onerror = null; return; }
          var url = i8(name, {style: stylesToTry[idx++], size: size ? parseInt(size,10) : undefined});
          if (el.src !== url) el.src = url; else tryNext();
        }
        el.onerror = tryNext;
        tryNext();
      } else {
        el.src = i8(name, {style: style, size: size ? parseInt(size,10) : undefined});
      }
    }
    
    function wireIcons(){
      document.querySelectorAll('img[data-i8]').forEach(setIcon);
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', wireIcons);
    } else {
      wireIcons();
    }
  </script>

    <!-- Debug Console - Persistent across all pages -->
    <script src="debug-console.js"></script>
    <script src="supabase-debug.js"></script>
</body>
</html>

import{createClient as Yt}from"https://esm.sh/@supabase/supabase-js@2";import Kt from"https://esm.sh/jszip@3.10.1";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();const W=document.getElementById("complaints-tbody"),Q=document.getElementById("cmp-select-all"),Xe=document.getElementById("complaints-export"),et=document.getElementById("complaints-bulk-export"),tt=document.getElementById("complaints-mark-resolved"),nt=document.getElementById("complaints-trend"),Se=document.getElementById("complaints-filter-start"),Ce=document.getElementById("complaints-filter-end"),ct=document.getElementById("complaints-filter-category"),ut=document.getElementById("complaints-filter-status"),mt=document.getElementById("complaints-search");function pt(e){const t=new Date(e);return isNaN(t)?null:t}const z=new Set;function be(e){return e.getAttribute("data-id")}function Ue(){const e=Array.from(W.querySelectorAll("tr[data-id]")).filter(n=>n.style.display!=="none");if(e.length===0){Q.checked=!1,Q.indeterminate=!1;return}const t=e.filter(n=>z.has(be(n))).length;Q.checked=t===e.length,Q.indeterminate=t>0&&t<e.length}function De(e,t){t?z.add(e):z.delete(e),Ue()}function Ie(e){const t=be(e);if(t){if(!e.querySelector(".cmp-select")){const n=document.createElement("input");n.type="checkbox",n.className="cmp-select",n.addEventListener("change",a=>{De(t,a.target.checked)});const i=document.createElement("td");i.style.width="36px",i.appendChild(n),e.insertBefore(i,e.firstChild)}if(!e.querySelector(".cmp-actions")){const n=document.createElement("td");n.className="cmp-actions",n.style.whiteSpace="nowrap";const i=document.createElement("button");i.className="pir-action-btn",i.textContent="View",i.style.marginRight="6px",i.addEventListener("click",()=>Qt(t));const a=document.createElement("button");a.className="pir-action-btn",a.textContent="Attach",a.addEventListener("click",()=>Zt(t)),n.appendChild(i),n.appendChild(a),e.appendChild(n)}}}function Qt(e){if(window.openCRUD){openCRUD("complaints","edit",e);return}alert("View complaint "+e)}function Zt(e){const t=document.createElement("input");t.type="file",t.onchange=async n=>{const i=n.target.files[0];if(i)try{const a=i.name.replace(/[^a-zA-Z0-9.\-_]/g,"_"),o=`complaints/${ctx.site_id}/${e}/${a}`,{data:r,error:s}=await supabase.storage.from("uploads").upload(o,i,{upsert:!0});if(s)throw s;await supabase.from("complaints").update({file_path:o}).eq("id",e),window.loadComplaints&&await loadComplaints(),alert("File uploaded")}catch(a){console.error(a),alert("Upload failed: "+a.message)}},t.click()}async function Jt(){if(z.size===0){alert("No rows selected");return}const e=Array.from(z),{data:t,error:n}=await supabase.from("complaints").select("*").in("id",e);if(n){alert("Export failed: "+n.message);return}const i=ft(t);gt(i,"complaints-export.csv")}function ft(e){if(!e||e.length===0)return"";const t=Object.keys(e[0]),n=a=>'"'+String(a??"").replace(/"/g,'""')+'"',i=[t.map(n).join(",")];return e.forEach(a=>i.push(t.map(o=>n(a[o])).join(","))),i.join(`
`)}function gt(e,t){const n=new Blob([e],{type:"text/csv"}),i=URL.createObjectURL(n),a=document.createElement("a");a.href=i,a.download=t,document.body.appendChild(a),a.click(),a.remove(),setTimeout(()=>URL.revokeObjectURL(i),5e3)}async function Xt(){if(z.size===0){alert("No rows selected");return}if(!confirm("Mark selected complaints as resolved?"))return;const e=Array.from(z);try{const{error:t}=await supabase.from("complaints").update({status:"resolved",resolved_at:new Date().toISOString()}).in("id",e);if(t)throw t;window.loadComplaints&&await loadComplaints(),z.clear(),Ue()}catch(t){console.error(t),alert("Failed to mark resolved: "+t.message)}}Q&&Q.addEventListener("change",()=>{const e=Q.checked;Array.from(W.querySelectorAll("tr[data-id]")).forEach(t=>{if(t.style.display==="none")return;const n=be(t),i=t.querySelector(".cmp-select");if(i)i.checked=e;else{const a=document.createElement("input");a.type="checkbox",a.className="cmp-select",a.checked=e,a.addEventListener("change",r=>De(be(t),r.target.checked));const o=document.createElement("td");o.style.width="36px",o.appendChild(a),t.insertBefore(o,t.firstChild)}De(n,e)})});const en=new MutationObserver(e=>{e.forEach(t=>{t.addedNodes&&t.addedNodes.forEach(n=>{n.nodeType===1&&n.matches("tr[data-id]")&&Ie(n)})})});en.observe(W,{childList:!0});Array.from(W.querySelectorAll("tr[data-id]")).forEach(Ie);et&&et.addEventListener("click",Jt);Xe&&Xe.addEventListener("click",async()=>{const{data:e}=await supabase.from("complaints").select("*").eq("site_id",ctx.site_id);gt(ft(e||[]),"complaints-all.csv")});tt&&tt.addEventListener("click",Xt);function yt(){const e=Se.value?new Date(Se.value):null,t=Ce.value?new Date(Ce.value):null,n=ct.value,i=(ut.value||"").toLowerCase(),a=(mt.value||"").toLowerCase().trim();Array.from(W.querySelectorAll("tr[data-id]")).forEach(o=>{const r=o.children,s=1,d=3,l=7,c=pt(r[s]?.textContent?.trim()),u=(r[d]?.textContent||"").trim(),m=(r[l]?.textContent||"").trim().toLowerCase(),f=(o.textContent||"").toLowerCase();let h=!0;e&&(!c||c<e)&&(h=!1),t&&(!c||c>new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59))&&(h=!1),n&&u!==n&&(h=!1),i&&!m.includes(i)&&(h=!1),a&&!f.includes(a)&&(h=!1),o.style.display=h?"":"none"}),Ue()}[Se,Ce,ct,ut,mt].forEach(e=>e&&e.addEventListener("input",yt));async function ht(){try{const e=new Date,t=new Date(e);t.setDate(e.getDate()-29);const n=`select to_char(date_trunc('day', datetime), 'YYYY-MM-DD') as day, count(*)::int as cnt from complaints where site_id = ${ctx.site_id} and datetime >= '${t.toISOString()}' group by 1 order by 1`,{data:i,error:a}=await supabase.rpc("sql",{q:n}).catch(()=>({error:{message:"RPC sql not available"}}));if(a||!i){const r={},s=Array.from(W.querySelectorAll("tr[data-id]")),d=t;s.forEach(l=>{const c=pt(l.children[1]?.textContent?.trim());if(c&&c>=d){const u=c.toISOString().slice(0,10);r[u]=(r[u]||0)+1}}),at(r);return}const o={};(i||[]).forEach(r=>{o[r.day]=r.cnt}),at(o)}catch(e){console.error("trend fetch failed",e)}}function at(e){const t=[],n=new Date;for(let s=29;s>=0;s--){const d=new Date(n);d.setDate(n.getDate()-s);const l=d.toISOString().slice(0,10);t.push(e[l]||0)}const i=600,a=120,o=Math.max(1,...t),r=t.map((s,d)=>d*(i/(t.length-1))+","+(a-s/o*(a-20))).join(" ");nt.setAttribute("viewBox","0 0 "+i+" "+a),nt.innerHTML=`
    <defs>
      <linearGradient id="trendGradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
        <stop offset="50%" style="stop-color:#764ba2;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
      </linearGradient>
      <linearGradient id="areaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" style="stop-color:#667eea;stop-opacity:0.3" />
        <stop offset="100%" style="stop-color:#667eea;stop-opacity:0.05" />
      </linearGradient>
      <filter id="glow">
        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
        <feMerge> 
          <feMergeNode in="coloredBlur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>
    
    <!-- Area fill -->
    <path fill="url(#areaGradient)" d="M0,${a} L${r.split(" ").map(s=>s.replace(","," L")).join(" ")} L${i},${a} Z" opacity="0">
      <animate attributeName="opacity" from="0" to="1" dur="1.5s" fill="freeze"/>
    </path>
    
    <!-- Main trend line with glow -->
    <polyline fill="none" stroke="url(#trendGradient)" stroke-width="4" 
              points="${r}" stroke-linejoin="round" stroke-linecap="round"
              filter="url(#glow)" stroke-dasharray="${i*2}" stroke-dashoffset="${i*2}">
      <animate attributeName="stroke-dashoffset" from="${i*2}" to="0" dur="2s" fill="freeze"/>
    </polyline>
    
    <!-- Animated data points -->
    ${t.map((s,d)=>{const l=d*(i/(t.length-1)),c=a-s/o*(a-20);return`
        <circle cx="${l}" cy="${c}" r="0" fill="#fff" stroke="url(#trendGradient)" stroke-width="2">
          <animate attributeName="r" from="0" to="4" dur="0.5s" begin="${.1*d}s" fill="freeze"/>
        </circle>
        <circle cx="${l}" cy="${c}" r="0" fill="url(#trendGradient)" opacity="0.3">
          <animate attributeName="r" from="0" to="8" dur="0.8s" begin="${.1*d}s" fill="freeze"/>
          <animate attributeName="opacity" from="0.5" to="0" dur="2s" begin="${.1*d}s" repeatCount="indefinite"/>
        </circle>
      `}).join("")}
  `}if(window.loadComplaints){const e=window.loadComplaints;window.loadComplaints=async function(){await e.apply(this,arguments),Array.from(W.querySelectorAll("tr[data-id]")).forEach(Ie),yt(),await ht()}}Array.from(W.querySelectorAll("tr[data-id]")).forEach(Ie);ht();const tn=CONFIG.SUPABASE_URL,nn=CONFIG.SUPABASE_ANON_KEY,g=Yt(tn,nn,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}});window.JSZip=Kt;window.supabase=g;function j(e=!0){const t=document.getElementById("auth-wrapper"),n=document.getElementById("app");e?(t&&(t.style.display="grid"),n&&(n.style.display="none")):(t&&(t.style.display="none"),n&&(n.style.display="grid"))}function te(e){const t=document.getElementById("auth-error");t&&(t.textContent=e,t.style.display="block")}function an(){const e=document.getElementById("auth-error");e&&(e.style.display="none")}async function on(e){e.preventDefault(),an();const t=document.getElementById("auth-email"),n=document.getElementById("auth-password"),i=document.querySelector('#auth-form button[type="submit"]');if(!t||!n){te("Email and password fields not found");return}try{i&&(i.disabled=!0,i.textContent="Signing in...");const{data:a,error:o}=await g.auth.signInWithPassword({email:t.value.trim(),password:n.value});o?te(o.message):a.user&&window.location.reload()}catch(a){te("Login failed: "+(a.message||"Unknown error"))}finally{i&&(i.disabled=!1,i.textContent="Sign In")}}function it(){const e=document.getElementById("auth-form");e&&e.addEventListener("submit",on),g.auth.onAuthStateChange((t,n)=>{t==="SIGNED_IN"||t==="TOKEN_REFRESHED"?(j(!1),jt()):t==="SIGNED_OUT"&&j(!0)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",it):it();const Be=document.getElementById("nav"),sn=[...document.querySelectorAll("section.view")];function Fe(e){if(!e)return;p.pageAccess&&!je(e)&&(console.warn(`Access denied to section: ${e}, redirecting to dashboard`),e="dashboard"),console.log("setActiveSection called with:",e);const t=Be.querySelector(`button[data-section="${e}"]`);if(!t)return;Be.querySelectorAll("button").forEach(i=>i.classList.remove("active")),t.classList.add("active"),sn.forEach(i=>i.classList.remove("active"));const n=document.getElementById("view-"+e);switch(n&&n.classList.add("active"),e){case"dashboard":Promise.all([P(),me(),ce(),ve()]);break;case"items":ae();break;case"rooms":_e();break;case"complaints":G();break;case"checktypes":we();break;case"schedules":Ee();break;case"staff":xe();break;case"submissions":qe();break;case"pre-inspection":re();break;case"complaints-dashboard":G(),vt();break;case"complaints-reporting":G();break;case"calendar":J();break;case"settings":xt();break;case"users":ue();break;case"training":X="clinical",document.querySelectorAll("#view-training .tab-controls button").forEach(i=>i.classList.remove("active")),document.getElementById("tab-clinical")?.classList.add("active"),V();break}try{localStorage.setItem("cl_active_section",e)}catch{}}Be.addEventListener("click",e=>{const t=e.target.closest("button[data-section]");if(!t)return;const n=t.getAttribute("data-section");if(p.pageAccess&&!je(n)){console.warn(`Access denied to section: ${n}`),alert(`You don't have permission to access ${n}.`);return}Fe(n),n==="settings"&&setTimeout(()=>{},100),n==="users"&&setTimeout(()=>{ue()},100),n==="training"&&setTimeout(()=>{X="clinical",document.querySelectorAll("#view-training .tab-controls button").forEach(i=>i.classList.remove("active")),document.getElementById("tab-clinical")?.classList.add("active"),V()},100)});function je(e){if(!p.pageAccess)return!1;if(e==="dashboard")return!0;const t={dashboard:"dashboard",complaints:"complaints",staff:"staff",items:"items",rooms:"rooms",checktypes:"checks",calendar:"calendar",schedules:"schedules",submissions:"submissions","pre-inspection":"pre-inspection",training:"training",settings:"settings",users:"users"};t["complaints-dashboard"]="complaints",t["complaints-reporting"]="complaints";const n=t[e]||e;return p.pageAccess.allowed_pages.includes("*")||p.pageAccess.allowed_pages.includes(n)||p.pageAccess[`can_see_${n}`]===!0}async function vt(){try{if(!p.site_id)return;const e=new Date;e.setDate(e.getDate()-29);const{data:t,error:n}=await g.from("complaints").select("id, category, status, datetime, share_with_team").eq("site_id",p.site_id).gte("datetime",e.toISOString());if(n)return console.warn("dashboard stats fetch error",n.message);const i={total:0,open:0,resolved:0,shared:0},a={},o={};(t||[]).forEach(l=>{i.total++,(l.status||"").toLowerCase()==="resolved"?i.resolved++:i.open++,l.share_with_team&&i.shared++;const c=l.category||"Unspecified";a[c]=(a[c]||0)+1;const u=l.status||"unknown";o[u]=(o[u]||0)+1}),ge("cmp-total",i.total),ge("cmp-open",i.open),ge("cmp-resolved",i.resolved),ge("cmp-share",i.shared);const r=document.getElementById("cmp-top-categories");if(r){const l=Object.entries(a).sort((c,u)=>u[1]-c[1]).slice(0,8);l.length===0?r.innerHTML='<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 40px 20px; font-style: italic;">No complaints in the last 30 days - Excellent service delivery! 🌟</div>':r.innerHTML=l.map((c,u)=>`
            <div style="display:flex; justify-content:space-between; align-items: center; padding:14px 18px; margin:10px 0; background:linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); border-radius:12px; border-left:4px solid var(--accent-1); transition:all 0.3s ease; animation:fadeInUp 0.6s ease-out; animation-delay:${u*.1}s; opacity:0; animation-fill-mode:forwards; cursor: pointer;" onmouseover="this.style.transform='translateX(4px)'; this.style.background='linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1))'" onmouseout="this.style.transform='translateX(0)'; this.style.background='linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08))'">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-weight:600; color: white; font-size: 1rem;">${y(c[0])}</div>
                <div style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; color: white;">Priority</div>
              </div>
              <div style="font-weight:800; color:var(--accent-1); font-size: 1.4rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${c[1]}</div>
            </div>
          `).join("")}const s=document.getElementById("cmp-status-breakdown");if(s){const l=Object.entries(o).sort((c,u)=>u[1]-c[1]);l.length===0?s.innerHTML='<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px; font-style: italic;">No status data available</div>':s.innerHTML=l.map((c,u)=>{const f={resolved:"#22c55e",closed:"#22c55e",open:"#f59e0b",investigating:"#3b82f6",pending:"#ef4444"}[c[0].toLowerCase()]||"var(--accent-2)",b={resolved:"✅",closed:"✅",open:"🔍",investigating:"⚠️",pending:"⏳"}[c[0].toLowerCase()]||"📋";return`
            <div style="display:flex; justify-content:space-between; align-items: center; padding:14px 18px; margin:10px 0; background:linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); border-radius:12px; border-left:4px solid ${f}; transition:all 0.3s ease; animation:fadeInUp 0.6s ease-out; animation-delay:${u*.1}s; opacity:0; animation-fill-mode:forwards; cursor: pointer;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.2rem;">${b}</span>
                <div style="font-weight:600; color: white; text-transform: capitalize;">${y(c[0])}</div>
              </div>
              <div style="font-weight:800; color:${f}; font-size: 1.4rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${c[1]}</div>
            </div>
            `}).join("")}const d={};for(let l=29;l>=0;l--){const c=new Date;c.setDate(c.getDate()-l);const u=c.toISOString().slice(0,10);d[u]=0}(t||[]).forEach(l=>{if(l.datetime){const c=l.datetime.slice(0,10);d.hasOwnProperty(c)&&d[c]++}}),rn(d)}catch(e){console.error("fetchComplaintsDashboardStats failed",e)}}function rn(e){const t=document.getElementById("dashboard-trend-chart");if(!t)return;const i=Object.keys(e).sort().map(d=>e[d]),a=600,o=120,r=Math.max(1,...i),s=i.map((d,l)=>l*(a/(i.length-1))+","+(o-d/r*(o-20))).join(" ");t.setAttribute("viewBox","0 0 "+a+" "+o),t.innerHTML=`
      <defs>
        <linearGradient id="dashboardTrendGradient" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
          <stop offset="50%" style="stop-color:#764ba2;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="dashboardAreaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#667eea;stop-opacity:0.3" />
          <stop offset="100%" style="stop-color:#667eea;stop-opacity:0.05" />
        </linearGradient>
        <filter id="dashboardGlow">
          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
          <feMerge> 
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      
      <!-- Area fill -->
      <path fill="url(#dashboardAreaGradient)" d="M0,${o} L${s.split(" ").map(d=>d.replace(","," L")).join(" ")} L${a},${o} Z" opacity="0">
        <animate attributeName="opacity" from="0" to="1" dur="1.5s" fill="freeze"/>
      </path>
      
      <!-- Main trend line with glow -->
      <polyline fill="none" stroke="url(#dashboardTrendGradient)" stroke-width="4" 
                points="${s}" stroke-linejoin="round" stroke-linecap="round"
                filter="url(#dashboardGlow)" stroke-dasharray="${a*2}" stroke-dashoffset="${a*2}">
        <animate attributeName="stroke-dashoffset" from="${a*2}" to="0" dur="2s" fill="freeze"/>
      </polyline>
      
      <!-- Animated data points -->
      ${i.map((d,l)=>{const c=l*(a/(i.length-1)),u=o-d/r*(o-20);return`
          <circle cx="${c}" cy="${u}" r="0" fill="#fff" stroke="url(#dashboardTrendGradient)" stroke-width="2">
            <animate attributeName="r" from="0" to="4" dur="0.5s" begin="${.1*l}s" fill="freeze"/>
          </circle>
          <circle cx="${c}" cy="${u}" r="0" fill="url(#dashboardTrendGradient)" opacity="0.3">
            <animate attributeName="r" from="0" to="8" dur="0.8s" begin="${.1*l}s" fill="freeze"/>
            <animate attributeName="opacity" from="0.5" to="0" dur="2s" begin="${.1*l}s" repeatCount="indefinite"/>
          </circle>
        `}).join("")}
    `}function ge(e,t){const n=document.getElementById(e);if(!n)return;const i=0,a=1500,o=performance.now();function r(s){const d=s-o,l=Math.min(d/a,1),c=1-Math.pow(1-l,3),u=Math.floor(i+(t-i)*c);n.textContent=u,n.style.transform=`scale(${1+Math.sin(l*Math.PI)*.1})`,l<1?requestAnimationFrame(r):(n.style.transform="scale(1)",n.style.animation="pulse 2s ease-in-out infinite")}requestAnimationFrame(r)}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("btn-open-complaints-reporting"),t=document.getElementById("btn-refresh-complaints-dashboard");e&&e.addEventListener("click",()=>{Fe("complaints-reporting")}),t&&t.addEventListener("click",()=>{t.style.transform="rotate(360deg)",t.style.transition="transform 0.8s ease",setTimeout(()=>{document.getElementById("view-complaints-dashboard").classList.contains("active")&&(G(),vt()),t.style.transform="rotate(0deg)"},800)}),document.querySelectorAll("#view-complaints-dashboard .stat-card").forEach((i,a)=>{i.addEventListener("mouseenter",()=>{i.style.transform="translateY(-8px) scale(1.02)",i.style.boxShadow="0 25px 50px rgba(0,0,0,0.15)"}),i.addEventListener("mouseleave",()=>{i.style.transform="translateY(0) scale(1)",i.style.boxShadow="0 8px 32px rgba(0,0,0,0.1)"})})});const bt=document.createElement("style");bt.textContent=`
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-20px) rotate(120deg); }
      66% { transform: translateY(-10px) rotate(240deg); }
    }
  `;document.head.appendChild(bt);const _t=document.getElementById("invite-modal"),wt=document.getElementById("invite-form"),B=document.getElementById("invite-error");function ln(){(async()=>{const e=document.getElementById("invite-reports-to"),t=document.getElementById("invite-role");if(e&&(e.innerHTML='<option value="">—</option>'),t&&(t.innerHTML='<option value="">—</option>'),!!p.site_id)try{if(e){const{data:n,error:i}=await g.from("kiosk_users").select("id, full_name").eq("site_id",p.site_id).eq("active",!0).order("full_name");!i&&Array.isArray(n)&&n.forEach(a=>{const o=document.createElement("option");o.value=a.id,o.textContent=a.full_name||a.id,e.appendChild(o)})}if(t){const{data:n,error:i}=await g.from("kiosk_roles").select("role").order("role");!i&&Array.isArray(n)&&n.forEach(a=>{const o=document.createElement("option");o.value=a.role,o.textContent=a.role,t.appendChild(o)})}}catch(n){console.warn("Failed to load dropdown lists",n)}})(),_t.classList.add("show"),B.style.display="none",wt.reset()}function ze(){_t.classList.remove("show")}document.getElementById("btn-invite-user")?.addEventListener("click",ln);document.getElementById("invite-modal-close")?.addEventListener("click",ze);document.getElementById("invite-cancel-btn")?.addEventListener("click",ze);document.getElementById("tab-clinical")?.addEventListener("click",()=>Vt("clinical"));document.getElementById("tab-non-clinical")?.addEventListener("click",()=>Vt("non-clinical"));document.getElementById("btn-manage-training-types")?.addEventListener("click",dn);document.getElementById("btn-export-training")?.addEventListener("click",mn);document.getElementById("training-modal-close")?.addEventListener("click",Ze);document.getElementById("training-cancel-btn")?.addEventListener("click",Ze);document.getElementById("training-form")?.addEventListener("submit",ca);document.getElementById("training-certificate")?.addEventListener("change",la);document.getElementById("training-completion-date")?.addEventListener("change",da);document.getElementById("training-upload-zone")?.addEventListener("click",()=>{document.getElementById("training-certificate")?.click()});document.getElementById("training-types-close")?.addEventListener("click",Ge);document.getElementById("training-types-cancel")?.addEventListener("click",Ge);document.getElementById("save-training-types")?.addEventListener("click",un);document.getElementById("add-training-type")?.addEventListener("click",cn);function dn(){document.getElementById("training-types-modal").classList.add("show"),Et()}function Ge(){document.getElementById("training-types-modal").classList.remove("show")}async function Et(){const e=document.getElementById("training-types-list");e.innerHTML='<div style="padding: 20px; text-align: center; color: var(--muted);">Loading...</div>';try{const{data:t,error:n}=await g.from("training_types").select("*").eq("site_id",p.site_id).order("name");if(n)throw n;e.innerHTML=t.map(i=>`
        <div class="training-type-row" data-id="${i.id}">
          <input type="text" value="${y(i.name)}" data-field="name">
          <select data-field="validity_months">
            <option value="">No Expiry</option>
            <option value="6" ${i.validity_months===6?"selected":""}>6 months</option>
            <option value="12" ${i.validity_months===12?"selected":""}>12 months</option>
            <option value="24" ${i.validity_months===24?"selected":""}>24 months</option>
            <option value="36" ${i.validity_months===36?"selected":""}>36 months</option>
          </select>
          <input type="checkbox" ${i.clinical?"checked":""} data-field="clinical">
          <input type="checkbox" ${i.non_clinical?"checked":""} data-field="non_clinical">
          <input type="checkbox" ${i.active?"checked":""} data-field="active">
          <button type="button" class="btn secondary" onclick="deleteTrainingType(${i.id})">Delete</button>
        </div>
      `).join("")}catch(t){console.error("Failed to load training types:",t),e.innerHTML='<div style="padding: 20px; text-align: center; color: var(--danger);">Failed to load training types</div>'}}function cn(){const e=document.getElementById("training-types-list"),t=`
      <div class="training-type-row" data-id="new-${Date.now()}">
        <input type="text" placeholder="Training name..." data-field="name">
        <select data-field="validity_months">
          <option value="">No Expiry</option>
          <option value="6">6 months</option>
          <option value="12" selected>12 months</option>
          <option value="24">24 months</option>
          <option value="36">36 months</option>
        </select>
        <input type="checkbox" checked data-field="clinical">
        <input type="checkbox" checked data-field="non_clinical">
        <input type="checkbox" checked data-field="active">
        <button type="button" class="btn secondary" onclick="this.parentElement.remove()">Remove</button>
      </div>
    `;e.insertAdjacentHTML("beforeend",t)}async function un(){const e=document.querySelectorAll(".training-type-row"),t=[],n=[];for(const i of e){const a=i.dataset.id,o=i.querySelector('[data-field="name"]').value.trim(),r=i.querySelector('[data-field="validity_months"]').value||null,s=i.querySelector('[data-field="clinical"]').checked,d=i.querySelector('[data-field="non_clinical"]').checked,l=i.querySelector('[data-field="active"]').checked;if(!o)continue;const c={site_id:p.site_id,name:o,validity_months:r?parseInt(r):null,clinical:s,non_clinical:d,active:l};a.startsWith("new-")?n.push(c):t.push({id:parseInt(a),...c})}try{if(n.length>0){const{error:i}=await g.from("training_types").insert(n);if(i)throw i}for(const i of t){const{id:a,...o}=i,{error:r}=await g.from("training_types").update(o).eq("id",a);if(r)throw r}Ge(),V()}catch(i){console.error("Failed to save training types:",i),document.getElementById("training-types-error").textContent=i.message,document.getElementById("training-types-error").style.display="block"}}window.deleteTrainingType=async function(e){if(confirm("Are you sure you want to delete this training type?"))try{const{error:t}=await g.from("training_types").update({active:!1}).eq("id",e);if(t)throw t;Et()}catch(t){console.error("Failed to delete training type:",t),alert("Failed to delete training type")}};function mn(){alert("Training report export functionality would be implemented here")}wt?.addEventListener("submit",async e=>{e.preventDefault(),B.style.display="none";const t=document.getElementById("invite-name").value.trim(),n=document.getElementById("invite-email").value.trim(),i=document.getElementById("invite-access").value,a=document.getElementById("invite-role").value,o=document.getElementById("invite-reports-to").value||null;if(!t||!n||!i){B.textContent="Please fill in Name, Email and Access",B.style.display="block";return}if(!p.site_id){B.textContent="No site selected",B.style.display="block";return}try{console.log("Sending simple invite...");const{data:r,error:s}=await g.functions.invoke("simple-invite",{body:{email:n,name:t,role:i,role_detail:a,reports_to_id:o},headers:{"x-redirect-url":CONFIG.passwordRedirectUrl}});if(s)throw s;console.log("Simple invite sent successfully",r),B.textContent="Invitation sent successfully! The user will receive an email with instructions to set their password.",B.style.display="block",B.style.backgroundColor="#d4edda",B.style.color="#155724",B.style.border="1px solid #c3e6cb",setTimeout(()=>{ze(),ue()},2e3)}catch(r){console.error("Failed to send invitation:",r),B.textContent=r.message||"Failed to send invitation",B.style.display="block"}});async function ue(){const e=document.getElementById("practice-users-tbody");if(!e){console.error("practice-users-tbody element not found");return}if(!p.site_id){e.innerHTML='<tr><td colspan="5" class="muted">No site selected</td></tr>';return}e.innerHTML='<tr><td colspan="5" class="muted">Loading users...</td></tr>';try{console.log("Loading users for site_id:",p.site_id),console.log("Testing site_invites table access...");const{data:t,error:n}=await g.from("site_invites").select("count").limit(1);n?console.error("Cannot access site_invites table:",n):console.log("site_invites table accessible");const{data:i,error:a}=await g.from("profiles").select("*").eq("site_id",p.site_id);if(a)throw console.error("Error loading profiles:",a),a;console.log("Loaded users:",i);const{data:o,error:r}=await g.from("site_invites").select("*").eq("site_id",p.site_id);r&&console.error("Error loading all invites:",r),console.log("Loaded all invites:",o);const s={};o&&o.forEach(c=>{if(c.status==="accepted"&&c.email){const u=i?.find(m=>m.full_name===c.full_name&&m.site_id===c.site_id);u&&(s[u.user_id]=c.email)}});const d=o?o.filter(c=>c.status==="pending"&&new Date(c.expires_at)>new Date):[],l=[...(i||[]).map(c=>({name:c.full_name||"Unknown",email:s[c.user_id]||"Email not available",role:c.role||"User",status:"Active",actions:`<button class="btn secondary" onclick="deactivateUser('${c.user_id}')">Deactivate</button>`})),...d.map(c=>({name:c.full_name,email:c.email,role:c.role,status:"Invited",actions:`<button class="btn secondary" onclick="cancelInvite('${c.id}')">Cancel Invite</button>`}))];e.innerHTML=l.length?l.map(c=>`
        <tr>
          <td>${y(c.name)}</td>
          <td>${y(c.email)}</td>
          <td>${y(c.role)}</td>
          <td><span class="chip ${c.status==="Active"?"success":"warning"}">${y(c.status)}</span></td>
          <td>${c.actions}</td>
        </tr>
      `).join(""):'<tr><td colspan="5" class="muted">No users yet</td></tr>'}catch(t){console.error("Failed to load users:",t);let n="Failed to load users";t.message&&(n+=": "+t.message),t.code&&(n+=" (Code: "+t.code+")"),e.innerHTML=`<tr><td colspan="5" class="muted">${n}</td></tr>`}}window.deactivateUser=async function(e){if(confirm("Are you sure you want to deactivate this user?"))try{const{error:t}=await g.from("profiles").update({active:!1}).eq("user_id",e).eq("site_id",p.site_id);if(t)throw t;ue()}catch(t){console.error("Failed to deactivate user:",t),alert("Failed to deactivate user")}};window.cancelInvite=async function(e){if(confirm("Are you sure you want to cancel this invitation?"))try{console.log("Attempting to cancel invitation:",{inviteId:e,siteId:p.site_id});const{data:t,error:n}=await g.rpc("cancel_site_invitation",{invite_id:e});if(n){console.error("Function approach failed:",n),console.log("Trying direct update approach...");const{data:i,error:a}=await g.from("site_invites").update({status:"revoked"}).eq("id",e).eq("site_id",p.site_id).select();if(a)throw console.error("Direct update also failed:",{message:a.message,details:a.details,hint:a.hint,code:a.code}),a;if(!i||i.length===0)throw new Error("No invitation found to cancel. This may be due to permissions or the invitation may already be processed.")}else{if(console.log("Function result:",t),!t.success)throw new Error(t.error||"Unknown error from cancel function");console.log("Successfully cancelled invitation via function")}console.log("Successfully cancelled invitation"),ue()}catch(t){console.error("Failed to cancel invitation:",t);let n="Failed to cancel invitation";t.message&&(n+=": "+t.message),t.details&&(n+=`
Details: `+t.details),t.hint&&(n+=`
Hint: `+t.hint),alert(n)}};function xt(){pn();const e=document.getElementById("debug-page-visibility");e&&e.addEventListener("click",()=>{typeof testDebugFunction=="function"&&testDebugFunction()})}async function pn(){try{const{data:e,error:t}=await g.from("role_permissions").select("allowed_pages").eq("role","staff").single();if(t){console.error("Error loading page permissions:",t);return}const n=e?.allowed_pages||[];console.log("Loaded staff permissions:",n),Object.entries({dashboard:"page-toggle-1","pre-inspection":"page-toggle-2",training:"page-toggle-3",calendar:"page-toggle-4",schedules:"page-toggle-5",submissions:"page-toggle-6",items:"page-toggle-7",rooms:"page-toggle-8",checks:"page-toggle-9",staff:"page-toggle-10",complaints:"page-toggle-11"}).forEach(([a,o])=>{const r=document.getElementById(o);r&&(r.checked=n.includes(a))})}catch(e){console.error("Failed to load page permissions:",e)}}window.testDebugFunction=async function(){console.log("� DEBUG: Starting comprehensive test...");const e=document.getElementById("debug-page-visibility"),t=e.textContent;try{e.disabled=!0,e.textContent="Debugging...",e.style.backgroundColor="#ffc107";const n=(document.getElementById("debug-enabled-toggles")?.value||"").trim();let i;try{i=JSON.parse(n)}catch{n===""?i=["DebugTestUpdate",...new Date().toISOString().split("T")]:i=[n]}console.log("� Supabase available:",!!window.supabase),console.log("� User:",await window.supabase.auth.getUser()),console.log("� Reading current role_permissions...");const{data:a,error:o}=await window.supabase.from("role_permissions").select("*").eq("role","staff");if(console.log("� Current data:",a),console.log("❌ Select error:",o),!a||a.length===0){console.log("� No staff record found, creating new one...");const{data:s,error:d}=await window.supabase.from("role_permissions").insert({role:"staff",allowed_pages:i}).select();if(console.log("� Insert result:",s),console.log("❌ Insert error:",d),d)throw d;e.textContent="Created New Record!",e.style.backgroundColor="#28a745"}else{console.log("🔄 Staff record exists, updating..."),console.log("📋 Current allowed_pages:",a[0]?.allowed_pages);const{data:s,error:d}=await window.supabase.from("role_permissions").upsert({role:"staff",allowed_pages:i}).select();if(console.log("📊 Upsert result:",s),console.log("❌ Upsert error:",d),d){console.log("🔄 Upsert failed, trying direct update...");const{data:l,error:c}=await window.supabase.from("role_permissions").update({allowed_pages:i}).eq("role","staff").select();if(console.log("� Direct update result:",l),console.log("❌ Direct update error:",c),c)throw c}e.textContent="Updated Successfully!",e.style.backgroundColor="#28a745"}console.log("🔍 Verifying changes...");const{data:r}=await window.supabase.from("role_permissions").select("*").eq("role","staff");console.log("✅ Final data:",r),setTimeout(()=>{e.disabled=!1,e.textContent=t,e.style.backgroundColor=""},4e3)}catch(n){console.error("❌ Debug failed:",n),console.error("❌ Error details:",{message:n.message,details:n.details,hint:n.hint,code:n.code}),e.textContent="Failed - Check Console",e.style.backgroundColor="#dc3545",setTimeout(()=>{e.disabled=!1,e.textContent=t,e.style.backgroundColor=""},5e3)}};async function fn(){try{await We(),xt();const e=localStorage.getItem("cl_active_section")||"dashboard";Fe(e),await Promise.all([P(),me(),ce()])}catch(e){console.error("Failed to initialize app:",e)}}fn();try{if(localStorage.getItem("cl_sidebar_collapsed")==="1"){document.getElementById("app")?.classList.add("collapsed"),document.getElementById("sidebar")?.classList.add("collapsed");try{document.getElementById("toggleSidebar")?.setAttribute("aria-expanded","false")}catch{}}}catch{}const gn=document.getElementById("search");window.addEventListener("keydown",e=>{e.key==="/"&&(e.preventDefault(),gn.focus())});document.getElementById("auth");const yn=document.getElementById("signout");document.getElementById("signin-form");document.getElementById("auth-error");let ne=!1;function Ve(){try{["rememberedPassword","rememberedEmail","rememberMe","cl_sidebar_collapsed","sb-unveoqnlqnobufhublyw-auth-token"].forEach(t=>{try{localStorage.removeItem(t)}catch{}})}catch{}try{sessionStorage.clear()}catch{}try{document.cookie.split(";").forEach(function(e){document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date(0).toUTCString()+";path=/")})}catch{}console.log("Storage cleared, redirecting to Home.html"),window.location.replace("Home.html?_="+Date.now())}async function he(){if(ne){console.log("Logout already in progress (admin), skipping duplicate call.");return}ne=!0,console.log("Starting forced logout from admin...");try{const{data:e}=await g.auth.getSession();e?.session?(await g.auth.signOut(),console.log("Supabase signOut completed")):console.log("No active session before signOut call")}catch(e){console.error("Supabase signOut failed:",e)}Ve()}yn.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation(),console.log("Logout button clicked on admin page"),await he()});(async function(){try{const{data:{session:e}}=await g.auth.getSession();if(!e||!e.user||!e.user.id){console.log("No valid session found on admin page, forcing logout"),await he();return}try{g.auth.onAuthStateChange((t,n)=>{console.log("Auth state changed on admin page:",t,n?"has session":"no session"),(t==="SIGNED_OUT"||!n||!n.user)&&(ne||(ne=!0,Ve()))})}catch(t){console.warn("Failed to attach auth state listener",t)}try{const t=e.user,{data:n}=await g.from("profiles").select("role").eq("user_id",t.id).maybeSingle();let i=null;if(n&&n.role&&(i=n.role),!i&&t?.raw_user_meta_data?.role&&(i=t.raw_user_meta_data.role),(i||"").toLowerCase()==="staff"){window.location.replace("staff.html");return}}catch(t){console.warn("Role guard check failed, continuing initialization",t)}try{await We(),console.log("✅ Context loaded successfully"),await Promise.all([P().catch(t=>console.error("loadCounts failed:",t)),me().catch(t=>console.error("loadDue failed:",t)),ce().catch(t=>console.error("loadActivity failed:",t))]),console.log("✅ All data loaded successfully")}catch(t){console.error("❌ Failed to initialize:",t),await he()}}catch(e){console.error("Session check failed:",e),await he()}})();window.addEventListener("pageshow",async e=>{if(e.persisted)try{const{data:{session:t}}=await g.auth.getSession();if(!t||!t.user){ne||(ne=!0,Ve());return}try{const n=t.user,{data:i}=await g.from("profiles").select("role").eq("user_id",n.id).maybeSingle();(i?.role||n?.raw_user_meta_data?.role||null||"").toLowerCase()==="staff"&&window.location.replace("staff.html")}catch{}}catch(t){console.warn("pageshow auth re-check failed:",t)}});let p={site_id:null,role:null,user:null},K={col:"item_name",dir:"asc"},Te="",k=new Date,It=0,Me="scheduled",Z=[],D=[];async function hn(){if(!(!p.user||!p.site_id))try{const{data:e,error:t}=await g.from("profiles").select("role").eq("user_id",p.user.id).single();if(t){console.error("Error fetching user profile:",t);return}if(e.role==="admin"||e.role==="owner"){document.querySelectorAll("button[data-section]").forEach(s=>s.style.display="flex");return}const{data:n,error:i}=await g.from("role_permissions").select("allowed_pages").eq("role",e.role).single();if(i){console.error("Error fetching role permissions:",i);return}const a=n?.allowed_pages||[];console.log("User role permissions:",e.role,a),document.querySelectorAll("button[data-section]").forEach(r=>{const s=r.getAttribute("data-section");s==="dashboard"||je(s)?r.style.display="flex":r.style.display="none"})}catch(e){console.error("Error updating navigation visibility:",e)}}async function We(){console.log("📍 loadContext starting...");try{const{data:{user:e},error:t}=await g.auth.getUser();if(t||!e)throw console.error("❌ No authenticated user found:",t),new Error("No authenticated user");console.log("✅ User authenticated:",e.email),p.user=e,console.log("🔍 Loading user profile...");let{data:n,error:i}=await g.from("profiles").select("site_id, role, full_name").eq("user_id",e.id).maybeSingle();if(i)throw console.error("❌ Profile loading error:",i),i;if(console.log("Profile data:",n),!n){console.log("⚠️ No profile found, checking for pending invitation...");const{data:u}=await g.from("site_invites").select("site_id, role, full_name, role_detail, reports_to_id").eq("email",e.email).eq("status","pending").gt("expires_at",new Date().toISOString()).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(u){console.log("✅ Found invitation, creating profile...",u);const{data:m,error:f}=await g.from("profiles").insert({user_id:e.id,site_id:u.site_id,role:u.role,full_name:u.full_name}).select("site_id, role, full_name").single();if(f)throw console.error("Failed to create profile:",f),new Error("Failed to create user profile");if(u.role_detail&&u.role_detail.trim()!==""){console.log("Creating kiosk_users entry...",u.role_detail);const{error:h}=await g.from("kiosk_users").insert({site_id:u.site_id,full_name:u.full_name,role:u.role_detail,active:!0,reports_to_id:u.reports_to_id});h?console.error("Failed to create kiosk_users entry:",h):console.log("Kiosk user created successfully")}await g.from("site_invites").update({status:"accepted"}).eq("email",e.email).eq("status","pending"),n=m,console.log("Profile created successfully:",n),await new Promise(h=>setTimeout(h,100))}else throw new Error("No profile found and no valid invitation")}if(p.site_id=n.site_id,p.role=n.role,p.full_name=n.full_name,p.role==="admin"||p.role==="owner")p.pageAccess={allowed_pages:["*"]};else{const{data:u,error:m}=await g.from("role_permissions").select("allowed_pages").eq("role",p.role).single();m?(console.error("Error loading role permissions:",m),p.pageAccess={allowed_pages:[]}):p.pageAccess={allowed_pages:u.allowed_pages||[]}}console.log("Context loaded:",{site_id:p.site_id,role:p.role,full_name:p.full_name,pageAccess:p.pageAccess});const a=document.getElementById("user-avatar"),o=document.getElementById("user-initials"),r=document.getElementById("user-name"),s=document.getElementById("site-info"),d=p.full_name||e.email||"User",l=d.trim().split(" ");let c;if(l.length>=2?c=(l[0].charAt(0)+l[l.length-1].charAt(0)).toUpperCase():c=d.substring(0,2).toUpperCase(),o.textContent=c,r.textContent=p.full_name||e.email||"User",await hn(),p.site_id){const{data:u}=await g.from("sites").select("name").eq("id",p.site_id).maybeSingle(),m=u?.name||`Site ${p.site_id}`;if(m.length>12){const f=m.split(" ");if(f.length>1){const h=f.map(b=>b.charAt(0)).join("").toUpperCase();s.textContent=h}else s.textContent=m.substring(0,8)+"..."}else s.textContent=m;p.site_name=u?.name||null}else s.textContent="No Site";return p}catch(e){throw console.error("💥 Failed to load context:",e),console.error("Error details:",{message:e.message,stack:e.stack,name:e.name}),e}}async function P(){if(!p.site_id)return;const[e,t,n,i,a]=await Promise.all([g.from("items").select("id",{count:"exact",head:!0}).eq("site_id",p.site_id),g.from("rooms").select("id",{count:"exact",head:!0}).eq("site_id",p.site_id),g.from("complaints").select("id",{count:"exact",head:!0}).eq("site_id",p.site_id),g.from("check_types").select("id",{count:"exact",head:!0}).eq("site_id",p.site_id),g.from("kiosk_users").select("id",{count:"exact",head:!0}).eq("site_id",p.site_id)]);typeof se=="function"&&se("due"),document.getElementById("badge-items").textContent=e.count??0,document.getElementById("badge-rooms").textContent=t.count??0,document.getElementById("badge-complaints").textContent=n.count??0,document.getElementById("badge-ct").textContent=i.count??0,document.getElementById("badge-staff").textContent=a.count??0}function kt(e){const t=new Date(e);return t.setHours(0,0,0,0),t}function vn(e){const t=new Date(e);return t.setHours(23,59,59,999),t}async function me(){const e=document.getElementById("due-tbody"),t="<tr><td colspan='4' class='muted'>Nothing due in the next 7 days.</td></tr>";if(e.innerHTML="<tr><td colspan='4' class='muted'>Loading…</td></tr>",!p.site_id){e.innerHTML="<tr><td colspan='4' class='muted'>No site selected.</td></tr>";return}const n=kt(new Date),i=new Date(n);i.setDate(i.getDate()+7);const{data:a,error:o}=await g.from("v_item_check_status").select("item_name, room_name, check_type, next_due_at").eq("site_id",p.site_id).gte("next_due_at",n.toISOString()).lt("next_due_at",i.toISOString()).order("next_due_at",{ascending:!0}).limit(500);if(o){e.innerHTML=`<tr><td colspan='4' class='muted'>${o.message}</td></tr>`;return}if(!a?.length){e.innerHTML=t;return}a.forEach(d=>{d.__date=d.next_due_at});const r={};(a||[]).forEach(d=>{const l=new Date(d.__date).toLocaleDateString(void 0,{weekday:"short",month:"numeric",day:"numeric"}),c=`${d.item_name}|${d.room_name||"—"}|${l}`;r[c]||(r[c]={item:d.item_name,room:d.room_name||"—",date:l,checks:[]}),r[c].checks.push(d.check_type||d.check)});const s=Object.values(r);if(!s.length){e.innerHTML=t;return}e.innerHTML=s.map(d=>`<tr>
      <td>${y(d.item)}</td>
      <td>${y(d.checks.join(", "))}</td>
      <td>${y(d.room)}</td>
      <td>${d.date}</td>
    </tr>`).join("")}async function bn(){const e=document.getElementById("due-tbody"),t="<tr><td colspan='4' class='muted'>No missed checks in the past 7 days.</td></tr>";if(e.innerHTML="<tr><td colspan='4' class='muted'>Loading…</td></tr>",!p.site_id){e.innerHTML="<tr><td colspan='4' class='muted'>No site selected.</td></tr>";return}const n=kt(new Date),i=new Date(n);i.setDate(i.getDate()-7);const{data:a,error:o}=await g.from("v_item_check_status").select("item_name, room_name, check_type, next_due_at, last_done_at").eq("site_id",p.site_id).gte("next_due_at",i.toISOString()).lt("next_due_at",n.toISOString()).order("next_due_at",{ascending:!1}).limit(500);if(o){e.innerHTML=`<tr><td colspan='4' class='muted'>${o.message}</td></tr>`;return}const r=(a||[]).filter(l=>{if(!l.last_done_at)return!0;try{return new Date(l.last_done_at)<new Date(l.next_due_at)}catch{return!0}});if(!r.length){e.innerHTML=t;return}r.forEach(l=>{l.__date=l.next_due_at});const s={};(r||[]).forEach(l=>{const c=new Date(l.__date).toLocaleDateString(void 0,{weekday:"short",month:"numeric",day:"numeric"}),u=`${l.item_name}|${l.room_name||"—"}|${c}`;s[u]||(s[u]={item:l.item_name,room:l.room_name||"—",date:c,checks:[]}),s[u].checks.push(l.check_type||l.check)});const d=Object.values(s);if(!d.length){e.innerHTML=t;return}e.innerHTML=d.map(l=>`<tr>
      <td>${y(l.item)}</td>
      <td>${y(l.checks.join(", "))}</td>
      <td>${y(l.room)}</td>
      <td>${l.date}</td>
    </tr>`).join("")}async function _n(){const e=document.getElementById("due-tbody"),t="<tr><td colspan='4' class='muted'>No completed checks in the past 7 days.</td></tr>";if(e.innerHTML="<tr><td colspan='4' class='muted'>Loading…</td></tr>",!p.site_id){e.innerHTML="<tr><td colspan='4' class='muted'>No site selected.</td></tr>";return}const n=vn(new Date),i=new Date;i.setHours(0,0,0,0),i.setDate(i.getDate()-7);const{data:a,error:o}=await g.from("v_item_check_status").select("item_name, room_name, check_type, last_done_at").eq("site_id",p.site_id).gte("last_done_at",i.toISOString()).lte("last_done_at",n.toISOString()).order("last_done_at",{ascending:!1}).limit(500);if(o){e.innerHTML=`<tr><td colspan='4' class='muted'>${o.message}</td></tr>`;return}if(!a?.length){e.innerHTML=t;return}a.forEach(d=>{d.__date=d.last_done_at});const r={};(a||[]).forEach(d=>{const l=new Date(d.__date).toLocaleDateString(void 0,{weekday:"short",month:"numeric",day:"numeric"}),c=`${d.item_name}|${d.room_name||"—"}|${l}`;r[c]||(r[c]={item:d.item_name,room:d.room_name||"—",date:l,checks:[]}),r[c].checks.push(d.check_type||d.check)});const s=Object.values(r);if(!s.length){e.innerHTML=t;return}e.innerHTML=s.map(d=>`<tr>
      <td>${y(d.item)}</td>
      <td>${y(d.checks.join(", "))}</td>
      <td>${y(d.room)}</td>
      <td>${d.date}</td>
    </tr>`).join("")}function se(e){if(document.getElementById("tab-due").classList.toggle("active",e==="due"),document.getElementById("tab-missed").classList.toggle("active",e==="missed"),document.getElementById("tab-completed").classList.toggle("active",e==="completed"),["tab-due","tab-missed","tab-completed"].forEach(t=>{const n=document.getElementById(t);n&&(n.classList.contains("active")?n.classList.add("active"):n.classList.remove("active"))}),e==="due")return me();if(e==="missed")return bn();if(e==="completed")return _n()}setTimeout(()=>{const e=document.getElementById("tab-due");e&&e.addEventListener("click",()=>se("due"));const t=document.getElementById("tab-missed");t&&t.addEventListener("click",()=>se("missed"));const n=document.getElementById("tab-completed");n&&n.addEventListener("click",()=>se("completed"))},50);async function ce(){const e=document.getElementById("activity-tbody"),{data:t,error:n}=await g.from("submissions").select("id, staff_name, submitted_at, comment").eq("site_id",p.site_id).order("submitted_at",{ascending:!1}).limit(10);if(n){e.innerHTML=`<tr><td colspan='3' class='muted'>${n.message}</td></tr>`;return}if(!t?.length){e.innerHTML="<tr><td colspan='3' class='muted'>No recent activity.</td></tr>";return}const i=t.map(r=>r.id);let a=[];if(i.length){const r=i.length===1?await g.from("submission_rows").select("submission_id",{count:"exact"}).eq("submission_id",i[0]):await g.from("submission_rows").select("submission_id",{count:"exact"}).in("submission_id",i);a=r&&r.data||[]}const o={};a?.forEach(r=>{o[r.submission_id]=(o[r.submission_id]||0)+1}),document.getElementById("activity-tbody").innerHTML=t.map(r=>`
      <tr><td>${Nt(r.submitted_at)}</td><td>${y(r.staff_name||"—")}</td><td>${o[r.id]??0}</td></tr>
    `).join("")}async function ie(){if(console.log("🏥 Loading CQC Readiness Dashboard..."),document.getElementById("last-updated-time").textContent=new Date().toLocaleTimeString(),document.getElementById("standards-last-updated").textContent=new Date().toLocaleString(),!p.site_id){console.warn("No site context available, showing placeholder data"),kn();return}try{const[e,t,n,i]=await Promise.all([wn(),En(),xn(),In()]),a=$t(e,t,n,i);Lt(a),St(e),Ct(t),Dt(n),Bt(i),Tt(e,t,n,i),Mt(e,t,n,i),console.log("✅ CQC Dashboard loaded successfully")}catch(e){console.error("❌ Failed to load CQC Dashboard:",e),$n(e)}}async function wn(){console.log("📋 Loading PIR compliance data...");try{const{data:e,error:t,count:n}=await g.from("pir_documents").select("id, status, title, updated_at",{count:"exact"}).eq("site_id",p.site_id);if(t)throw t;const i=n||0;let a=0,o=0,r=0;return(e||[]).forEach(s=>{const d=(s.status||"").toLowerCase(),l=s.updated_at&&new Date-new Date(s.updated_at)>2160*60*60*1e3;d==="ready"&&!l?a++:d==="ready"&&l?r++:o++}),{total:i,ready:a,pending:o,outdated:r,completionPercent:i>0?Math.round(a/i*100):0,complianceLevel:a>=i*.9?"excellent":a>=i*.7?"good":"needs-attention"}}catch(e){return console.error("PIR compliance error:",e),{total:0,ready:0,pending:0,outdated:0,completionPercent:0,complianceLevel:"error"}}}async function En(){console.log("🎓 Loading training compliance data...");try{const[e,t]=await Promise.all([g.from("kiosk_users").select("id",{count:"exact",head:!0}).eq("site_id",p.site_id),g.from("training_records").select("staff_id, expiry_date, training_type",{count:"exact"}).eq("site_id",p.site_id)]),n=e.count||0,i=t.data||[],a=new Date,o=new Date(a.getTime()+720*60*60*1e3);let r=0,s=0,d=0;const l={};i.forEach(u=>{const m=u.staff_id;if(l[m]||(l[m]={upToDate:0,expiringSoon:0,expired:0}),!u.expiry_date)l[m].upToDate++;else{const f=new Date(u.expiry_date);f<a?l[m].expired++:f<=o?l[m].expiringSoon++:l[m].upToDate++}}),Object.values(l).forEach(u=>{u.upToDate>u.expired+u.expiringSoon?r++:u.expiringSoon>0?s++:d++});const c=n>0?Math.round(r/n*100):0;return{totalStaff:n,upToDate:r,expiringSoon:s,expired:d,compliancePercent:c,complianceLevel:c>=90?"excellent":c>=70?"good":"needs-attention"}}catch(e){return console.error("Training compliance error:",e),{totalStaff:0,upToDate:0,expiringSoon:0,expired:0,compliancePercent:0,complianceLevel:"error"}}}async function xn(){console.log("🛡️ Loading safety compliance data...");try{const e=new Date;e.setDate(e.getDate()-7);const{data:t,error:n}=await g.from("v_item_check_status").select("id, last_done_at, last_result, item_name, check_type_name").eq("site_id",p.site_id).gte("last_done_at",e.toISOString()).ilike("check_type_name","%safety%,PAT%,fire%,equipment%,emergency%".split(",").join("%"));if(n&&!n.message.includes('relation "v_item_check_status" does not exist'))throw n;const i=t||[],a=Math.max(i.length,10),o=i.filter(l=>l.last_done_at).length,r=i.filter(l=>l.last_result==="pass"||l.last_result==="good").length,s=o-r,d=a>0?Math.round(o/a*100):0;return{totalRequired:a,completed:o,passed:r,failed:s,compliancePercent:d,complianceLevel:d>=95?"excellent":d>=80?"good":"needs-attention"}}catch(e){return console.error("Safety compliance error:",e),{totalRequired:15,completed:13,passed:12,failed:1,compliancePercent:87,complianceLevel:"good"}}}async function In(){console.log("📞 Loading complaints compliance data...");try{const{data:e,error:t}=await g.from("complaints").select("id, status, datetime, resolved_at, response").eq("site_id",p.site_id).order("datetime",{ascending:!1}).limit(100);if(t)throw t;const n=e||[];let i=0,a=0,o=0,r=0;n.forEach(d=>{const l=(d.status||"").toLowerCase();if(l==="open"||l==="pending"?i++:l==="investigating"?a++:(l==="resolved"||l==="closed")&&o++,d.response&&d.datetime){const c=new Date(d.datetime);((d.resolved_at?new Date(d.resolved_at):new Date)-c)/(1e3*60*60*24)<=3&&r++}});const s=n.length>0?Math.round(r/n.length*100):100;return{active:i,investigating:a,resolved:o,total:n.length,responseTimePercent:s,responseTimeCompliance:s>=90?"✅ Excellent":s>=70?"⚠️ Good":"❌ Needs Attention",complianceLevel:s>=90?"excellent":s>=70?"good":"needs-attention"}}catch(e){return console.error("Complaints compliance error:",e),{active:0,investigating:0,resolved:0,total:0,responseTimePercent:100,responseTimeCompliance:"✅ No Issues",complianceLevel:"excellent"}}}function $t(e,t,n,i){const a={pir:.3,training:.3,safety:.25,complaints:.15},o={pir:e.completionPercent,training:t.compliancePercent,safety:n.compliancePercent,complaints:i.responseTimePercent},r=Object.keys(a).reduce((s,d)=>s+o[d]*a[d],0);return Math.round(r)}function Lt(e){const t=document.getElementById("overall-readiness-score"),n=document.getElementById("readiness-status-icon"),i=document.getElementById("readiness-status-text");t.textContent=e+"%",e>=90?(n.style.background="#28a745",i.textContent="✅ Excellent - CQC Ready",i.style.color="#28a745"):e>=75?(n.style.background="#ffc107",i.textContent="⚠️ Good - Minor Improvements Needed",i.style.color="#ffc107"):(n.style.background="#dc3545",i.textContent="❌ Requires Attention",i.style.color="#dc3545")}function St(e){document.getElementById("pir-total-docs").textContent=e.total,document.getElementById("pir-completion-percent").textContent=e.completionPercent+"%",document.getElementById("pir-progress-bar").style.width=e.completionPercent+"%",document.getElementById("pir-ready-count").textContent=e.ready,document.getElementById("pir-pending-count").textContent=e.pending,document.getElementById("pir-outdated-count").textContent=e.outdated;const t=document.getElementById("pir-progress-bar");e.complianceLevel==="excellent"?t.style.background="#28a745":e.complianceLevel==="good"?t.style.background="#ffc107":t.style.background="#dc3545"}function Ct(e){document.getElementById("training-staff-count").textContent=e.totalStaff,document.getElementById("training-compliance-percent").textContent=e.compliancePercent+"%",document.getElementById("training-progress-bar").style.width=e.compliancePercent+"%",document.getElementById("training-up-to-date").textContent=e.upToDate,document.getElementById("training-expiring-soon").textContent=e.expiringSoon,document.getElementById("training-expired").textContent=e.expired;const t=document.getElementById("training-progress-bar");e.complianceLevel==="excellent"?t.style.background="#28a745":e.complianceLevel==="good"?t.style.background="#ffc107":t.style.background="#dc3545"}function Dt(e){document.getElementById("safety-checks-percent").textContent=e.compliancePercent+"%",document.getElementById("safety-checks-bar").style.width=e.compliancePercent+"%",document.getElementById("safety-completed").textContent=e.completed,document.getElementById("safety-required").textContent=e.totalRequired,document.getElementById("safety-passed").textContent=e.passed,document.getElementById("safety-failed").textContent=e.failed;const t=document.getElementById("safety-checks-bar");e.complianceLevel==="excellent"?t.style.background="#28a745":e.complianceLevel==="good"?t.style.background="#ffc107":t.style.background="#dc3545"}function Bt(e){document.getElementById("complaints-active").textContent=e.active,document.getElementById("complaints-investigating").textContent=e.investigating,document.getElementById("complaints-resolved").textContent=e.resolved,document.getElementById("complaints-response-time").textContent=e.responseTimeCompliance}function Tt(e,t,n,i){document.getElementById("staffing-score").textContent=t.compliancePercent+"%",document.getElementById("staffing-details").textContent=`${t.upToDate}/${t.totalStaff} staff with current training`,document.getElementById("staffing-standard-score").textContent=t.compliancePercent+"%",document.getElementById("staffing-standard-detail").textContent=t.complianceLevel==="excellent"?"All training up to date":t.complianceLevel==="good"?"Most training current":"Training compliance needs attention",document.getElementById("safety-score").textContent=n.compliancePercent+"%",document.getElementById("safety-details").textContent=`${n.completed}/${n.totalRequired} safety checks completed`,document.getElementById("safety-standard-score").textContent=n.compliancePercent+"%",document.getElementById("safety-standard-detail").textContent=n.complianceLevel==="excellent"?"All safety requirements met":n.complianceLevel==="good"?"Safety compliance good":"Safety checks need attention";const a=Math.round((e.completionPercent+i.responseTimePercent)/2);document.getElementById("governance-score").textContent=a+"%",document.getElementById("governance-details").textContent=`PIR ${e.completionPercent}%, Complaints handled well`,document.getElementById("governance-standard-score").textContent=a+"%",document.getElementById("governance-standard-detail").textContent=a>=90?"Excellent governance systems":a>=70?"Good governance in place":"Governance needs improvement",document.getElementById("person-centred-score").textContent="85%",document.getElementById("person-centred-detail").textContent="Patient feedback surveys positive, care plans reviewed"}function Mt(e,t,n,i){const a=[];e.completionPercent<80&&a.push(`📋 Complete ${e.pending+e.outdated} PIR documents`),t.expired>0&&a.push(`🎓 Urgent: ${t.expired} staff have expired training`),t.expiringSoon>0&&a.push(`⏰ ${t.expiringSoon} training certificates expire within 30 days`),n.compliancePercent<85&&a.push(`🛡️ Complete ${n.totalRequired-n.completed} overdue safety checks`),n.failed>0&&a.push(`❌ Address ${n.failed} failed safety checks`),i.active>5&&a.push(`📞 ${i.active} open complaints need attention`),i.responseTimePercent<80&&a.push(`⏱️ Improve complaint response times (currently ${i.responseTimePercent}%)`);const o=document.getElementById("priority-actions");a.length===0?(o.innerHTML="🎉 <strong>All priority areas are compliant!</strong> Your practice is CQC ready.",o.parentElement.style.background="rgba(40, 167, 69, 0.1)",o.parentElement.style.borderColor="#28a745",o.style.color="#155724"):o.innerHTML=a.map(r=>`• ${r}`).join("<br>")}function kn(){console.log("📊 Showing CQC placeholder data for demonstration");const e={pir:{total:25,ready:18,pending:5,outdated:2,completionPercent:72,complianceLevel:"good"},training:{totalStaff:12,upToDate:9,expiringSoon:2,expired:1,compliancePercent:75,complianceLevel:"good"},safety:{totalRequired:20,completed:17,passed:16,failed:1,compliancePercent:85,complianceLevel:"good"},complaints:{active:2,investigating:1,resolved:8,responseTimePercent:91,responseTimeCompliance:"✅ Excellent"}},t=$t(e.pir,e.training,e.safety,e.complaints);Lt(t),St(e.pir),Ct(e.training),Dt(e.safety),Bt(e.complaints),Tt(e.pir,e.training,e.safety,e.complaints),Mt(e.pir,e.training,e.safety,e.complaints),document.getElementById("standards-last-updated").textContent="Placeholder data for demonstration"}function $n(e){console.error("Showing CQC error state:",e),document.getElementById("overall-readiness-score").textContent="Error",document.getElementById("readiness-status-text").textContent="❌ Unable to load compliance data",document.getElementById("priority-actions").innerHTML="⚠️ <strong>Data loading error:</strong> Please check your connection and try refreshing."}async function ae(){const e=document.getElementById("items-tbody");let t=g.from("v_items_admin").select("*").eq("site_id",p.site_id);if(Te){const r=`%${Te}%`;t=t.or([`item_id.ilike.${r}`,`item_name.ilike.${r}`,`room_name.ilike.${r}`,`default_check_type_name.ilike.${r}`,`room.ilike.${r}`,`default_check_type.ilike.${r}`].join(","))}const n=K.col||"item_name",i=K.dir!=="desc";t=t.order(n,{ascending:i});const{data:a,error:o}=await t;if(o){e.innerHTML=`<tr><td colspan="5" class="muted">${o.message}</td></tr>`;return}if(!a?.length){e.innerHTML='<tr><td colspan="5" class="muted">No items yet.</td></tr>';return}["item_id","item_name","room_name","default_check_type_name","active"].forEach(r=>{const s=document.getElementById(`sort-${r}`);s&&(r===n?s.textContent=i?"▲":"▼":s.textContent="")}),e.innerHTML=a.map(r=>`<tr data-id="${r.id}">
      <td>${y(r.item_id)}</td>
      <td>${y(r.item_name)}</td>
      <td>${y((r.room_name??r.room)||"—")}</td>
      <td>${y((r.default_check_type_name??r.default_check_type)||"—")}</td>
      <td>${r.active?"Yes":"No"}</td>
    </tr>`).join("")}async function _e(){const e=document.getElementById("rooms-tbody"),{data:t,error:n}=await g.from("rooms").select("id,name,occupied_by").eq("site_id",p.site_id).order("name");if(n){e.innerHTML=`<tr><td colspan="2" class="muted">${n.message}</td></tr>`;return}if(!t?.length){e.innerHTML='<tr><td colspan="2" class="muted">No rooms yet.</td></tr>';return}const i=[...new Set((t||[]).map(o=>o.occupied_by).filter(Boolean))];let a={};if(i.length){const o=s=>typeof s=="string"&&s.indexOf("-")>-1;let r=[];if(i.length===1){const s=i[0];if(o(s)){const d=await g.from("kiosk_users").select("id,full_name,user_id").eq("user_id",s);r=d&&d.data||[]}else{const d=await g.from("kiosk_users").select("id,full_name").eq("id",s);r=d&&d.data||[]}}else{const s=i.filter(o),d=i.filter(l=>!o(l));if(s.length)try{const l=await g.from("kiosk_users").select("id,full_name,user_id").in("user_id",s);l&&l.data&&r.push(...l.data)}catch{}if(d.length)try{const l=await g.from("kiosk_users").select("id,full_name").in("id",d);l&&l.data&&r.push(...l.data)}catch{}}(r||[]).forEach(s=>{a[s.id]=s.full_name})}e.innerHTML=t.map(o=>`<tr data-id="${o.id}"><td>${y(o.name)}</td><td>${y(a[o.occupied_by]||"—")}</td></tr>`).join("")}async function G(){const e=document.getElementById("complaints-tbody");try{debugLog&&debugLog("loadComplaints() start",{site_id:p.site_id})}catch{}try{const t=await g.from("complaints").select("id, datetime, patient_initials, category, original_complaint, response, lessons_learned, status, priority, share_with_team, created_by, resolved_at").eq("site_id",p.site_id).order("datetime",{ascending:!1}).limit(1e3),{data:n,error:i}=t;if(i){debugLog&&debugLog("loadComplaints() supabase error",i),e.innerHTML=`<tr><td colspan="10" class="muted">${escapeHtml(i.message||"Error")}</td></tr>`;return}if(!n||n.length===0){debugLog&&debugLog("No complaints for site_id, attempting fallback");try{const a=await g.from("complaints").select("id, datetime, patient_initials, category, original_complaint, response, lessons_learned, status, priority, share_with_team, created_by, resolved_at").in("site_id",[1,2]).order("datetime",{ascending:!1}).limit(500);if(a&&!a.error&&a.data&&a.data.length){debugLog&&debugLog("Fallback returned rows",{count:a.data.length}),ot(e,a.data);return}else{debugLog&&debugLog("Fallback found no rows",{error:a.error}),e.innerHTML='<tr><td colspan="10" class="muted">No complaints yet.</td></tr>';return}}catch(a){console.error("Fallback query error",a),e.innerHTML='<tr><td colspan="10" class="muted">No complaints yet.</td></tr>';return}}ot(e,n);return}catch(t){console.error("loadComplaints failed",t),e.innerHTML='<tr><td colspan="10" class="muted">Error loading complaints</td></tr>';return}}function ot(e,t){const n=[...new Set((t||[]).map(a=>a.created_by).filter(Boolean))];let i={};(async function(){if(n.length)try{const s=l=>typeof l=="string"&&l.indexOf("-")>-1;let d=[];if(n.length===1){const l=n[0];if(s(l))try{const c=await g.from("kiosk_users").select("id,full_name,user_id").eq("user_id",l);d=c&&c.data||[]}catch(c){debugLog("kiosk_users user_id query failed, trying id fallback:",c.message);const u=await g.from("kiosk_users").select("id,full_name").eq("id",l);d=u&&u.data||[]}else{const c=await g.from("kiosk_users").select("id,full_name").eq("id",l);d=c&&c.data||[]}}else{const l=n.filter(s),c=n.filter(u=>!s(u));if(l.length)try{const u=await g.from("kiosk_users").select("id,full_name,user_id").in("user_id",l);u&&u.data&&d.push(...u.data)}catch(u){debugLog("kiosk_users user_id batch query failed, skipping UUID lookups:",u.message)}if(c.length)try{const u=await g.from("kiosk_users").select("id,full_name").in("id",c);u&&u.data&&d.push(...u.data)}catch{}}(d||[]).forEach(l=>{i[l.id]=l.full_name})}catch{}const a=s=>s?new Date(s).toLocaleString():"—",o=(s,d=120)=>s?s.length>d?y(s.slice(0,d))+"…":y(s):"",r=t.map(s=>`
    <tr data-id="${s.id}">
      <td style="width:36px"><input type="checkbox" class="cmp-select" data-id="${s.id}"></td>
      <td>${a(s.datetime)}</td>
      <td>${y(s.patient_initials)}</td>
      <td>${y(s.category)}</td>
      <td title="${y(s.original_complaint||"")}">${o(s.original_complaint,80)}</td>
      <td title="${y(s.response||"")}">${o(s.response,80)}</td>
      <td title="${y(s.lessons_learned||"")}">${o(s.lessons_learned,80)}</td>
      <td>${y(s.status||"")}</td>
      <td>${s.share_with_team?"Yes":"No"}</td>
      <td>${y(i[s.created_by]||(s.created_by?s.created_by:"—"))}</td>
      <td>${a(s.resolved_at)}</td>
      <td class="cmp-actions" style="white-space:nowrap"><button class="pir-action-btn" data-action="view" data-id="${s.id}">View</button> <button class="pir-action-btn" data-action="attach" data-id="${s.id}">Attach</button></td>
    </tr>
  `).join("");e.innerHTML=r})()}async function we(){const e=document.getElementById("ct-tbody"),{data:t,error:n}=await g.from("check_types").select("id, name, active").eq("site_id",p.site_id).order("name");if(n){e.innerHTML=`<tr><td colspan="2" class="muted">${n.message}</td></tr>`;return}if(!t?.length){e.innerHTML='<tr><td colspan="2" class="muted">No check types yet.</td></tr>';return}e.innerHTML=t.map(i=>`<tr data-id="${i.id}"><td>${y(i.name)}</td><td>${i.active?"Yes":"No"}</td></tr>`).join("")}async function Ee(){const e=document.getElementById("sched-tbody"),{data:t,error:n}=await g.from("item_allowed_types").select("id,item_id,check_type_id,frequency,required,scheduled_day").eq("site_id",p.site_id).order("id",{ascending:!0});if(n){e.innerHTML=`<tr><td colspan="6" class="muted">${n.message}</td></tr>`;return}if(!t?.length){e.innerHTML='<tr><td colspan="6" class="muted">No schedules yet.</td></tr>';return}const i=[...new Set(t.map(m=>m.item_id).filter(Boolean))],a=[...new Set(t.map(m=>m.check_type_id).filter(Boolean))],[o,r]=await Promise.all([i.length?i.length===1?g.from("items").select("id,item_name,room_id").eq("id",i[0]):g.from("items").select("id,item_name,room_id").in("id",i):Promise.resolve({data:[]}),a.length?a.length===1?g.from("check_types").select("id,name").eq("id",a[0]):g.from("check_types").select("id,name").in("id",a):Promise.resolve({data:[]})]),s={},d={};(o.data||[]).forEach(m=>{s[m.id]=m.item_name,d[m.id]=m.room_id});const l=[...new Set(Object.values(d).filter(Boolean))];let c={};if(l.length){const m=l.length===1?await g.from("rooms").select("id,name").eq("id",l[0]):await g.from("rooms").select("id,name").in("id",l);(m&&m.data||[]||[]).forEach(h=>{c[h.id]=h.name})}const u={};(r.data||[]).forEach(m=>u[m.id]=m.name),e.innerHTML=t.map(m=>`
    <tr data-id="${m.id}">
      <td>${y(s[m.item_id]||"—")}</td>
      <td>${y(c[d[m.item_id]]||"—")}</td>
      <td>${y(u[m.check_type_id]||"—")}</td>
      <td>${y(Tn(m.frequency))}</td>
      <td>${y(m.scheduled_day||"—")}</td>
      <td>${m.required?"Yes":"No"}</td>
    </tr>`).join("")}async function xe(){const e=document.getElementById("staff-tbody"),{data:t,error:n}=await g.from("kiosk_users").select(`
        id, 
        full_name, 
        role, 
        active,
        reports_to:reports_to_id(full_name)
      `).eq("site_id",p.site_id).order("full_name");if(n){e.innerHTML=`<tr><td colspan="4" class="muted">${n.message}</td></tr>`;return}if(!t?.length){e.innerHTML='<tr><td colspan="4" class="muted">No staff yet.</td></tr>';return}e.innerHTML=t.map(i=>`<tr data-id="${i.id}">
      <td>${y(i.full_name)}</td>
      <td>${y(i.role)}</td>
      <td>${y(i.reports_to?.full_name||"—")}</td>
      <td>${i.active?"Yes":"No"}</td>
    </tr>`).join("")}async function qe(){const e=document.getElementById("subs-tbody"),{data:t,error:n}=await g.from("submissions").select("id, submitted_at, staff_name, comment").eq("site_id",p.site_id).order("submitted_at",{ascending:!1}).limit(25);if(n){e.innerHTML=`<tr><td colspan="4" class="muted">${n.message}</td></tr>`;return}if(!t?.length){e.innerHTML='<tr><td colspan="4" class="muted">No submissions yet.</td></tr>';return}const i=t.map(o=>o.id);let a={};if(i.length){const o=i.length===1?await g.from("submission_rows").select("submission_id").eq("submission_id",i[0]):await g.from("submission_rows").select("submission_id").in("submission_id",i);(o&&o.data||[]).forEach(s=>{a[s.submission_id]=(a[s.submission_id]||0)+1})}e.innerHTML=t.map(o=>`<tr data-id="${o.id}">
      <td>${Nt(o.submitted_at)}</td><td>${y(o.staff_name||"—")}</td>
      <td>${a[o.id]??0}</td><td>${y(o.comment||"")}</td>
    </tr>`).join("")}function Ln(e){const t=new Date(e),n=t.getDay();return t.setHours(0,0,0,0),t.setDate(t.getDate()-n),t}const qt=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function Sn(e){if(!e)return-1;const t=String(e).slice(0,3);return qt.indexOf(t)}function At(e){return qt[e]||""}async function ve(){if(!p.site_id)return;const t=Ln(new Date),n=new Date(t);n.setDate(t.getDate()+7);const i=m=>m.toLocaleDateString(void 0,{weekday:"short",day:"numeric",month:"short"});for(let m=0;m<7;m++){const f=new Date(t);f.setDate(t.getDate()+m);const h=document.getElementById(`d${m}-label`);h&&(h.textContent=i(f))}const{data:a}=await g.from("item_allowed_types").select("id,required,scheduled_day").eq("site_id",p.site_id).eq("required",!0),o=Array(7).fill(0);(a||[]).forEach(m=>{if(m.scheduled_day){const f=Sn(m.scheduled_day);f!==-1&&o[f]++}});const{data:r,error:s}=await g.from("submissions").select("id, submitted_at").eq("site_id",p.site_id).gte("submitted_at",t.toISOString()).lt("submitted_at",n.toISOString());if(s)return;const d=(r||[]).map(m=>m.id);let l=[];if(d.length){const m=d.length===1?await g.from("submission_rows").select("submission_id").eq("submission_id",d[0]):await g.from("submission_rows").select("submission_id").in("submission_id",d);l=m&&m.data||[]}const c={};l.forEach(m=>{c[m.submission_id]=(c[m.submission_id]||0)+1});const u=Array(7).fill(0);(r||[]).forEach(m=>{const f=new Date(m.submitted_at),h=Math.floor((f-t)/864e5);h>=0&&h<7&&(u[h]+=c[m.id]||0)});for(let m=0;m<7;m++){const f=new Date(t);f.setDate(t.getDate()+m);const h=f<new Date(new Date().setHours(0,0,0,0)),b=o[m],v=u[m]||0,_=h?Math.max(b-v,0):0,x=b,I=document.getElementById(`d${m}-done-val`),C=document.getElementById(`d${m}-req-val`),R=document.getElementById(`d${m}-bar`),$=document.getElementById(`d${m}-done`),q=document.getElementById(`d${m}-missed`),N=document.getElementById(`d${m}-req`);if(I&&(I.textContent=v),C&&(C.textContent=x),$&&($.textContent=v),q&&(q.textContent=_),N&&(N.textContent=x),R){let H=0;x>0&&(H=v/x*100),R.style.width=`${Math.min(H,100)}%`,R.classList.toggle("danger",h&&_>0)}}}async function Ae(){if(!p.site_id)return;console.log("DEBUG: cacheRequiredSchedules() called for site_id:",p.site_id);const{data:e,error:t}=await g.from("item_allowed_types").select(`
        id,
        scheduled_day,
        frequency,
        items (id, item_name),
        check_types (id, name)
      `).eq("site_id",p.site_id).eq("required",!0);if(t){console.error("Failed to cache schedules:",t);return}Z=e||[],console.log("DEBUG: Cached",Z.length,"required schedules:",Z)}async function J(){if(p.site_id)switch(await Ae(),console.log("DEBUG: loadAndRenderCalendar() - requiredSchedulesCache has",Z.length,"items"),document.getElementById("cal-grid").style.display="none",document.getElementById("cal-weekdays").style.display="none",document.getElementById("cal-compliance-view").style.display="none",Me){case"daily":$e("daily");break;case"weekly":$e("weekly");break;case"monthly":$e("monthly");break;case"scheduled":default:document.getElementById("cal-weekdays").style.display="grid",document.getElementById("cal-grid").style.display="grid";const e=document.getElementById("cal-grid");e.innerHTML='<div style="grid-column: span 7; text-align:center; padding: 40px;" class="muted">Loading calendar...</div>',k.setDate(1);const t=k.getFullYear(),n=k.getMonth();document.getElementById("cal-month-year").textContent=k.toLocaleDateString(void 0,{month:"long",year:"numeric"});const i=new Date(t,n,1),a=new Date(t,n+1,0);a.setHours(23,59,59,999);const{data:o,error:r}=await g.from("submission_rows").select("item_pk, check_type_id, submissions!inner ( submitted_at )").gte("submissions.submitted_at",i.toISOString()).lte("submissions.submitted_at",a.toISOString()).eq("site_id",p.site_id);if(r){e.innerHTML=`<div class="muted">${r.message}</div>`;return}const s=new Map;(o||[]).forEach(d=>{const l=new Date(d.submissions.submitted_at).toISOString().slice(0,10);s.has(l)||s.set(l,new Set),s.get(l).add(`${d.item_pk}-${d.check_type_id}`)}),Cn(s);break}}async function $e(e){document.getElementById("cal-weekdays").style.display="none",document.getElementById("cal-grid").style.display="none";const t=document.getElementById("cal-compliance-view");t.style.display="block",t.innerHTML=`<div class="muted" style="text-align:center; padding: 40px;">Loading ${e} compliance...</div>`;const n=new Date;n.setHours(23,59,59,999);let i=new Date(k),a=new Date(k);if(e==="daily")i.setHours(0,0,0,0),a.setHours(23,59,59,999);else if(e==="weekly"){const l=i.getDay();i.setDate(i.getDate()-l),i.setHours(0,0,0,0),a=new Date(i),a.setDate(i.getDate()+6),a.setHours(23,59,59,999)}else i=new Date(k.getFullYear(),k.getMonth(),1),a=new Date(k.getFullYear(),k.getMonth()+1,0),a.setHours(23,59,59,999);const o={month:"long",year:"numeric"};e==="daily"&&(o.day="numeric"),document.getElementById("cal-month-year").textContent=i.toLocaleDateString(void 0,o);const{data:r,error:s}=await g.from("v_item_check_status").select("item_name, room_name, check_type, next_due_at, last_done_at").eq("site_id",p.site_id).eq("required",!0).gte("next_due_at",i.toISOString()).lte("next_due_at",a.toISOString()).order("next_due_at",{ascending:!0});if(s){t.innerHTML=`<div class="error">${s.message}</div>`;return}if(!r||r.length===0){t.innerHTML='<div class="muted" style="text-align:center; padding: 40px;">No checks were due in this period.</div>';return}let d=`<div class="table-wrap" style="max-height: 65vh;"><table>
        <thead><tr><th>Due Date</th><th>Item</th><th>Check</th><th>Room</th><th>Status</th></tr></thead>
        <tbody>`;r.forEach(l=>{const c=new Date(l.next_due_at);l.last_done_at&&new Date(l.last_done_at);let u='<span class="chip">Pending</span>';c<n&&(u='<span class="chip danger">Missed</span>'),d+=`<tr>
            <td>${c.toLocaleDateString(void 0,{weekday:"short",day:"numeric",month:"short"})}</td>
            <td>${y(l.item_name)}</td>
            <td>${y(l.check_type)}</td>
            <td>${y(l.room_name||"—")}</td>
            <td>${u}</td>
        </tr>`}),d+="</tbody></table></div>",t.innerHTML=d}function Cn(e){const t=document.getElementById("cal-grid"),n=new Date,i=n.toISOString().slice(0,10);n.setHours(0,0,0,0);const a=k.getFullYear(),o=k.getMonth(),r=new Date(a,o,1),d=new Date(a,o+1,0).getDate(),l=r.getDay();let c="";for(let f=0;f<l;f++)c+='<div class="cal-cell other-month"></div>';for(let f=1;f<=d;f++){const h=new Date(a,o,f),b=h.toISOString().slice(0,10),v=b===i,_=h<n,x=At(h.getDay()),I=e.get(b)||new Set;let C="";const R=Z.filter($=>{if(!$.scheduled_day||$.scheduled_day!==x)return!1;const q=String($.frequency||"").toLowerCase();if(q.includes("mon")){const N=new Date(h);return N.setDate(h.getDate()+7),N.getMonth()!==h.getMonth()}return!!(q.includes("day")||q.includes("week"))});console.log(`DEBUG: Day ${f} (${x}) - found ${R.length} tasks from ${Z.length} total schedules`),R.forEach($=>{const q=`${$.items.id}-${$.check_types.id}`,N=I.has(q);let H="scheduled";N?H="done":_&&(H="missed");let O="S";N?O="✓":_&&(O="✗");const Je=`${$.items.item_name} / ${$.check_types.name}`,pe=String($.frequency||"").toLowerCase();let fe="";pe.includes("day")?fe='<span class="freq-badge" title="Daily">D</span>':pe.includes("week")?fe='<span class="freq-badge" title="Weekly">W</span>':(pe.includes("mon")||pe.includes("month"))&&(fe='<span class="freq-badge" title="Monthly">M</span>'),C+=`<div class="cal-task"
              data-item-id="${$.items.id}"
              data-ct-id="${$.check_types.id}"
              data-date="${b}"
              title="${y(Je)}">
              <div class="cal-task-status ${H}">${O}</div>
              <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-left:6px;">${y(Je)}</span>
              ${fe}
            </div>`}),R.length===0&&(C+='<div class="muted" style="font-size:10px; text-align:center; padding-top:10px;">No required checks</div>'),c+=`<div class="cal-cell is-clickable" data-date="${b}">
            <div class="cal-day-num ${v?"is-today":""}">${f}</div>
            <div class="cal-tasks">${C}</div>
            </div>`}const m=(7-(l+d)%7)%7;for(let f=0;f<m;f++)c+='<div class="cal-cell other-month"></div>';t.innerHTML=c}async function Dn(e){const t=document.getElementById("day-modal");if(!t)return;const n=t.querySelector(".day-modal-title"),i=t.querySelector(".day-modal-body");n.textContent=`Details for ${new Date(e).toLocaleDateString(void 0,{weekday:"long",day:"numeric",month:"long",year:"numeric"})}`,i.innerHTML='<div class="muted">Loading…</div>',t.classList.add("show"),t.setAttribute("aria-hidden","false");const a=new Date(e),o=new Date(a);o.setHours(0,0,0,0);const r=new Date(a);r.setHours(23,59,59,999);const{data:s,error:d}=await g.from("submission_rows").select("item_pk, check_type_id, items(id,item_name), check_types(id,name), submissions!inner(submitted_at, staff_name)").gte("submissions.submitted_at",o.toISOString()).lte("submissions.submitted_at",r.toISOString()).eq("site_id",p.site_id),l={};!d&&s&&s.length&&s.forEach(h=>{const b=`${h.item_pk}-${h.check_type_id}`;l[b]={staff:h.submissions?.staff_name||"—",time:h.submissions?.submitted_at||null,item_name:h.items?.item_name||null,check_name:h.check_types?.name||null}});const c=At(a.getDay());a.getDate();const u=Z.filter(h=>{if(!h.scheduled_day||h.scheduled_day!==c)return!1;const b=String(h.frequency||"").toLowerCase();if(b.includes("mon")){const v=new Date(a);return v.setDate(a.getDate()+7),v.getMonth()!==a.getMonth()}return!!(b.includes("day")||b.includes("week"))}),m=new Set;if(u.forEach(h=>m.add(`${h.items.id}-${h.check_types.id}`)),Object.keys(l).forEach(h=>m.add(h)),m.size===0){i.innerHTML='<div class="muted">No checks recorded or scheduled for this day.</div>';return}let f='<div class="table-wrap"><table class="day-modal-table"><thead><tr><th>Check</th><th>Status</th><th>By</th><th>Time</th></tr></thead><tbody>';for(const h of m){const[b,v]=h.split("-"),_=Number(b),x=Number(v),I=u.find(O=>Number(O.items.id)===_&&Number(O.check_types.id)===x),C=l[h],R=I?I.items.item_name:C&&C.item_name||"—",$=I?I.check_types.name:C&&C.check_name||"—";let q='<span class="chip">Scheduled</span>',N="—",H="—";if(C)q='<span class="chip success">Done</span>',N=y(C.staff||"—"),H=C.time?new Date(C.time).toLocaleTimeString():"—";else if(isPast){const O=new Date;O.setHours(0,0,0,0),a<O&&(q='<span class="chip danger">Missed</span>')}f+=`<tr>
        <td>${y(R)} / ${y($)}</td>
        <td>${q}</td>
        <td>${N}</td>
        <td>${H}</td>
      </tr>`}f+="</tbody></table></div>",i.innerHTML=f}async function Bn(e,t,n){const i=document.getElementById("day-modal");if(!i)return;const a=i.querySelector(".day-modal-title"),o=i.querySelector(".day-modal-body");a.textContent="Details",o.innerHTML='<div class="muted">Loading…</div>',i.classList.add("show"),i.setAttribute("aria-hidden","false");const r=new Date(e),s=new Date(r);s.setHours(0,0,0,0);const d=new Date(r);d.setHours(23,59,59,999);const{data:l}=await g.from("submission_rows").select("submissions!inner(staff_name,submitted_at), items(item_name), check_types(name)").eq("site_id",p.site_id).eq("item_pk",t).eq("check_type_id",n).gte("submissions.submitted_at",s.toISOString()).lte("submissions.submitted_at",d.toISOString()),c=l?.[0]??null,u=c?.items?.item_name??(await g.from("items").select("item_name").eq("id",t).maybeSingle()).data?.item_name??"—",m=c?.check_types?.name??(await g.from("check_types").select("name").eq("id",n).maybeSingle()).data?.name??"—",f=new Date,h=r<new Date(f.setHours(0,0,0,0));let b='<span class="chip">Scheduled</span>',v="—",_="—";c?(b='<span class="chip success">Done</span>',v=y(c.submissions?.staff_name||"—"),_=c.submissions?.submitted_at?new Date(c.submissions.submitted_at).toLocaleTimeString():"—"):h&&(b='<span class="chip danger">Missed</span>'),o.innerHTML=`
      <table class="day-modal-table"><tbody>
        <tr><th>Item</th>  <td>${y(u)}</td></tr>
        <tr><th>Check</th> <td>${y(m)}</td></tr>
        <tr><th>Status</th><td>${b}</td></tr>
        <tr><th>Who</th>   <td>${v}</td></tr>
        <tr><th>When</th>  <td>${_}</td></tr>
      </tbody></table>`}function Ne(){const e=document.getElementById("day-modal");e&&(e.classList.remove("show"),e.setAttribute("aria-hidden","true"),It=Date.now()+300)}(()=>{const e=document.getElementById("day-modal-close");e&&!e.dataset.bound&&(e.dataset.bound="1",e.addEventListener("click",t=>{t.stopPropagation(),Ne()},{once:!1}))})();document.getElementById("cal-grid").addEventListener("click",async e=>{if(Date.now()<It){e.stopPropagation(),e.preventDefault();return}const t=e.target.closest(".cal-task");if(t){e.stopPropagation();const a=t.getAttribute("data-date"),o=t.getAttribute("data-item-id"),r=t.getAttribute("data-ct-id");if(a&&o&&r){await Bn(a,o,r);return}}const n=e.target.closest(".cal-cell.is-clickable");if(!n)return;const i=n.getAttribute("data-date");i&&await Dn(i)});document.addEventListener("click",e=>{const t=document.getElementById("day-modal");if(!(!t||!t.classList.contains("show"))){if(e.target.id==="day-modal-close"){e.stopPropagation(),e.preventDefault(),Ne();return}e.target===t&&(e.stopPropagation(),e.preventDefault(),Ne())}});function y(e){return(e??"").toString().replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Nt(e){return e?new Date(e).toLocaleString():"—"}function Pe(e){if(!e)return!1;try{return/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(String(e))}catch{return!1}}function T(e){if(!e)return"—";try{return new Date(e+"T12:00:00Z").toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}catch{return"—"}}function Tn(e){if(!e)return"—";if(typeof e!="string")return JSON.stringify(e);const t=[];return e.includes("year")&&t.push(e.match(/(\d+)\s*year/)[1]+" years"),e.includes("mon")&&t.push(e.match(/(\d+)\s*mon/)[1]+" months"),e.includes("day")&&t.push(e.match(/(\d+)\s*day/)[1]+" days"),t.join(", ")||e}const Ye=window.PIR_DEFINITIONS_DATA;async function Mn(){if(!p.site_id)return;const{count:e,error:t}=await g.from("pir_documents").select("*",{count:"exact",head:!0}).eq("site_id",p.site_id);if(t||e>0)return;const n=Ye.map(i=>{const a=!i.item_type.includes("file");return{site_id:p.site_id,category:i.category,title:i.title,item_type:i.item_type,status:a?"Not Started":"Not Attached",data:{}}});await g.from("pir_documents").insert(n)}function ke(e){return e.includes("file")&&(e.includes("text")||e.includes("questions"))?"Text & File":e.includes("file")?"File Attachment":e.includes("text")||e.includes("questions")?"Text / Q&A":e.includes("table")?"Data Table":e.includes("number")?"Data":"Information"}let S={filter:"all",sortBy:"category",selectedItems:new Set,draftTexts:new Map};async function re(){const e=document.getElementById("pir-docs-container");if(e.innerHTML='<div class="muted" style="text-align: center; padding: 20px;">Loading document list...</div>',!p.site_id)return;const{data:t,error:n}=await g.from("pir_documents").select("*").eq("site_id",p.site_id).order("id",{ascending:!0});if(n){e.innerHTML=`<div class="error">${n.message}</div>`;return}D=t||[],S.draftTexts=new Map(JSON.parse(localStorage.getItem("pir_draft_texts")||"[]")),Pt(),Rn(),Hn(),On(),Un()}function Pt(){const e=document.getElementById("pir-docs-container"),t=An(),n=Nn(t),i=Pn(n);let a="";for(const[o,r]of Object.entries(i))a+=`
                <div class="doc-category" id="category-${Ut(o)}">
                    <div class="doc-category-title">${y(o)}</div>
                    ${r.map(s=>qn(s)).join("")}
                </div>
            `;e.innerHTML=a||'<div class="muted" style="padding: 20px; text-align: center;">No documents match the current filter.</div>'}function le(e){return e&&(e.notes??(e.data&&e.data.notes))||""}function qn(e){const t=M(e),n=Rt(t),i=S.draftTexts.has(e.id),a=Ke(e)?.allow_templates,o=le(e),r=o&&o.trim().length>0,s=S.selectedItems.has(e.id);return`
            <div class="pir-table-row ${s?"selected":""}" data-id="${e.id}">
                <div class="pir-row-main">
                    <div>
                        <input type="checkbox" class="pir-row-checkbox" data-id="${e.id}" ${s?"checked":""}>
                    </div>
                    <div>
                        <div class="pir-row-title">${y(e.title)}</div>
                        <div class="pir-row-type">${ke(e.item_type)}</div>
                        ${i?'<div class="pir-draft-indicator"><span class="pir-draft-badge">draft</span> Text saved</div>':""}
                        ${r?'<div class="pir-notes-indicator"><span class="pir-notes-badge">📝</span> Has notes</div>':""}
                    </div>
                    <div>
                        <span class="pir-status-chip ${n}">${t}</span>
                    </div>
                    <div>
                        <span class="muted">${T(e.last_updated)}</span>
                    </div>
                    ${a?`<button class="pir-template-btn" data-id="${e.id}">Templates</button>`:"<div></div>"}
                    <div class="pir-row-actions">
                        <button class="pir-action-btn" data-action="upload" data-id="${e.id}">Upload</button>
                        ${e.file_path?`<button class="pir-action-btn" data-action="view" data-id="${e.id}">View</button>`:""}
                        <button class="pir-action-btn ${r?"has-notes":""}" data-action="notes" data-id="${e.id}">Notes</button>
                    </div>
                </div>
            </div>
        `}function M(e){const t=Ke(e),n=new Date;if(!e.file_path&&!e.data?.text_content&&!S.draftTexts.has(e.id))return t?.item_type?.includes("file")?"Not Attached":"Not Started";if(e.status==="Ready"){if(e.last_updated){const i=new Date(e.last_updated);if((n-i)/(1e3*60*60*24*30)>24)return"Outdated"}return"Ready"}return e.file_path&&e.status!=="Ready"?"Uploaded":S.draftTexts.has(e.id)&&!e.file_path?"Draft":e.status||"Not Started"}function Rt(e){return{"Not Attached":"not-attached","Not Started":"not-attached",Uploaded:"uploaded",Ready:"ready",Outdated:"outdated",Draft:"draft",Expired:"expired","Expiring Soon":"expiring-soon"}[e]||"not-attached"}function Ke(e){return window.PIR_DEFINITIONS_DATA?.find(t=>t.title===e.title)}function An(){return D.filter(e=>{const t=M(e),n=S.draftTexts.has(e.id);switch(S.filter){case"not-attached":return t==="Not Attached"||t==="Not Started";case"ready":return t==="Ready";case"expiring-soon":if(t==="Ready"&&e.last_updated){const i=new Date(e.last_updated),a=(new Date-i)/(1e3*60*60*24*30);return a>18&&a<=24}return!1;case"outdated":return t==="Outdated";case"draft":return n;case"all":default:return!0}})}function Nn(e){return[...e].sort((t,n)=>{let i,a;switch(S.sortBy){case"status":i=M(t),a=M(n);break;case"last-updated":i=t.last_updated||"1900-01-01",a=n.last_updated||"1900-01-01";break;case"category":default:i=t.category,a=n.category;break}return i<a?-1:i>a?1:0})}function Pn(e){const t=e.reduce((a,o)=>((a[o.category]=a[o.category]||[]).push(o),a),{}),n=[...new Set(window.PIR_DEFINITIONS_DATA?.map(a=>a.category)||[])],i={};for(const a of n)t[a]&&(i[a]=t[a]);return i}function Rn(){const e=D.length,t=D.filter(l=>M(l)==="Ready").length,n=e>0?Math.round(t/e*100):0;document.getElementById("pir-progress-bar").style.width=`${n}%`,document.getElementById("pir-progress-text").textContent=`${t} / ${e} Ready (${n}%)`;const i=Math.round(n/100*66),a=document.getElementById("pir-progress-large");a&&(a.textContent=`${i} / 66`);const o=document.getElementById("pir-progress-bar"),r=document.querySelector(".progress-bar-container");if(o&&r){r.classList.remove("progress-low","progress-medium","progress-high","progress-complete"),n>=100?r.classList.add("progress-complete"):n>=75?r.classList.add("progress-high"):n>=40?r.classList.add("progress-medium"):r.classList.add("progress-low");const l=Ht(n,t,e);r.setAttribute("title",l)}const s={};(window.PIR_DEFINITIONS_DATA||[]).forEach(l=>{const c=(l.category||"").match(/EMAIL\s*(\d+)/i),u=c?parseInt(c[1],10):null;u&&(s[u]=s[u]||{defs:[],ready:0,total:0},s[u].defs.push(l))}),Object.keys(s).forEach(l=>{const c=parseInt(l,10),u=s[c].defs.map(b=>b.title),m=D.filter(b=>u.includes(b.title)),f=m.length,h=m.filter(b=>M(b)==="Ready").length;s[c].total=f,s[c].ready=h});const d=document.getElementById("email-status-circles");if(d){const l=[];for(let c=1;c<=9;c++){const u=s[c]||{total:0,ready:0};let m="email-circle-item missing",f="email-circle missing";u.total>0&&u.ready===u.total?(m="email-circle-item ready",f="email-circle ready"):u.ready>0&&(m="email-circle-item partial",f="email-circle partial");const h=u.total>0?`${u.ready}/${u.total}`:"–",b=`Email Package ${c}: ${h}`;l.push(`<div class="${m}" title="${b}" data-package="${c}">
              <div class="${f}" data-package="${c}">${c}</div>
              <div class="email-circle-count">${h}</div>
            </div>`)}d.innerHTML=l.join(""),setTimeout(()=>{document.querySelectorAll("#email-status-circles [data-package]").forEach(c=>{c.addEventListener("click",u=>{u.stopPropagation();const m=parseInt(c.getAttribute("data-package"));Fn(c,m)})}),document.addEventListener("click",()=>{document.querySelectorAll(".email-popover").forEach(c=>c.remove())})},30)}}function Ht(e,t,n){const i=n-t;return e>=100?`🎉 Outstanding! All ${n} items are ready for CQC inspection. You're fully compliant!`:e>=90?`🌟 Excellent progress! Only ${i} items remaining. You're almost inspection-ready!`:e>=75?`💪 Great work! ${i} items to go. You're in the final stretch!`:e>=50?`📈 Good momentum! ${i} items remaining. Keep pushing forward!`:e>=25?`🚀 Getting started! ${i} items to complete. Every step counts!`:`📋 Ready to begin? ${i} items need attention. Let's get inspection-ready!`}function Hn(){const e=document.getElementById("pir-toc-items"),t=[...new Set(D.map(n=>n.category))];e.innerHTML=t.map(n=>`<a href="#category-${Ut(n)}" class="pir-toc-item" data-category="${n}">
                ${y(n.replace(/^EMAIL \d+:\s*/,""))}
            </a>`).join("")}function On(){document.querySelectorAll(".pir-filter-pill").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".pir-filter-pill").forEach(t=>t.classList.remove("active")),e.classList.add("active"),S.filter=e.dataset.filter,Pt(),Qe()})})}function Un(){const e=document.getElementById("pir-docs-container");e.addEventListener("change",t=>{if(t.target.classList.contains("pir-row-checkbox")){const n=parseInt(t.target.dataset.id);t.target.checked?S.selectedItems.add(n):S.selectedItems.delete(n),Qe(),Ot()}}),e.addEventListener("click",async t=>{const n=t.target.dataset.action,i=parseInt(t.target.dataset.id);if(n&&i){t.preventDefault(),t.stopPropagation();const a=D.find(o=>o.id===i);if(!a)return;switch(n){case"upload":Wn(a);break;case"view":await Gn(a);break;case"notes":Jn(a);break}}}),e.addEventListener("click",t=>{if(t.target.classList.contains("pir-template-btn")){t.preventDefault(),t.stopPropagation();const n=parseInt(t.target.dataset.id),i=D.find(a=>a.id===n);i&&Zn(i)}}),document.querySelectorAll(".pir-toc-item").forEach(t=>{t.addEventListener("click",n=>{n.preventDefault();const i=t.getAttribute("href");document.querySelector(i)?.scrollIntoView({behavior:"smooth"}),document.querySelectorAll(".pir-toc-item").forEach(a=>a.classList.remove("active")),t.classList.add("active")})}),document.getElementById("pir-bulk-upload")?.addEventListener("click",()=>Vn()),document.getElementById("pir-export")?.addEventListener("click",()=>Yn()),document.getElementById("pir-bulk-upload-selected")?.addEventListener("click",()=>Kn()),document.getElementById("pir-export-selected")?.addEventListener("click",()=>Qn()),document.getElementById("pir-clear-selection")?.addEventListener("click",()=>zn()),document.querySelector(".progress-bar-container")?.addEventListener("click",()=>{const t=document.querySelector(".progress-bar-container");if(t){t.style.animation="none",t.offsetHeight,t.style.animation="progressClick 0.3s ease-out";const n=D.length,i=D.filter(s=>M(s)==="Ready").length,a=n>0?Math.round(i/n*100):0,o=Ht(a,i,n),r=document.createElement("div");r.style.cssText=`
              position: fixed; top: 20px; right: 20px; 
              background: var(--panel-bg); color: var(--white);
              padding: 12px 20px; border-radius: 8px; 
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              z-index: 1000; max-width: 320px;
              border: 1px solid var(--border-color);
              animation: slideInRight 0.3s ease-out;
            `,r.textContent=o,document.body.appendChild(r),setTimeout(()=>{r.style.animation="slideOutRight 0.3s ease-in forwards",setTimeout(()=>r.remove(),300)},3e3)}})}function Fn(e,t){document.querySelectorAll(".email-popover").forEach(s=>s.remove());const n=jn(t);if(!n)return;n.style.position="absolute",n.style.top="0px",n.style.left="0px",document.body.appendChild(n);const i=e.getBoundingClientRect(),a=n.getBoundingClientRect();let o=window.scrollX+i.left+i.width/2-a.width/2;o=Math.max(8,Math.min(o,window.scrollX+window.innerWidth-a.width-8));let r=window.scrollY+i.bottom+10;r+a.height>window.scrollY+window.innerHeight&&(r=window.scrollY+i.top-a.height-10),n.style.left=o+"px",n.style.top=r+"px"}function jn(e){const n=(window.PIR_DEFINITIONS_DATA||[]).filter(u=>{const m=(u.category||"").match(/EMAIL\s*(\d+)/i);return m&&parseInt(m[1],10)===e}).map(u=>u.title),i=D.filter(u=>n.includes(u.title)),a=i.length,o=i.filter(u=>M(u)==="Ready").length,r=document.createElement("div");r.className="email-popover";const s=document.createElement("h4");s.textContent=`Email ${e} summary`,r.appendChild(s);const d=document.createElement("div");if(d.className="pop-row",d.innerHTML=`<div style="font-weight:600">Status</div><div style="font-weight:700">${o}/${a} ready</div>`,r.appendChild(d),a>0){const u=i.filter(f=>M(f)==="Ready"),m=i.filter(f=>M(f)!=="Ready");if(u.length){const f=document.createElement("div");f.style.marginTop="8px",f.style.fontSize="13px",f.style.fontWeight="600",f.textContent="Ready samples",r.appendChild(f);const h=document.createElement("div");h.className="pop-list",u.forEach(b=>{const v=document.createElement("div");v.className="pop-row",v.innerHTML=`<div style="flex:1">${y(b.title)}</div><div class="pill ready">Ready</div>`,h.appendChild(v)}),r.appendChild(h)}if(m.length){const f=document.createElement("div");f.style.marginTop="8px",f.style.fontSize="13px",f.style.fontWeight="600",f.textContent="Needs attention",r.appendChild(f);const h=document.createElement("div");h.className="pop-list",m.forEach(b=>{const v=document.createElement("div");v.className="pop-row",v.innerHTML=`<div style="flex:1">${y(b.title)}</div><div class="pill missing">Not ready</div>`,h.appendChild(v)}),r.appendChild(h)}}else{const u=document.createElement("div");u.style.padding="10px 0",u.textContent="No documents configured for this package.",r.appendChild(u)}const l=document.createElement("div");l.className="pop-actions";const c=document.createElement("button");return c.className="btn",c.textContent="Close",c.addEventListener("click",()=>document.querySelectorAll(".email-popover").forEach(u=>u.remove())),l.appendChild(c),r.appendChild(l),r}function Qe(){const e=document.getElementById("pir-bulk-bar"),t=S.selectedItems.size;t>0?(e.classList.add("visible"),document.getElementById("pir-selected-count").textContent=t):e.classList.remove("visible")}function Ot(){document.querySelectorAll(".pir-table-row").forEach(e=>{const t=parseInt(e.dataset.id);S.selectedItems.has(t)?e.classList.add("selected"):e.classList.remove("selected")})}function zn(){S.selectedItems.clear(),Qe(),Ot(),document.querySelectorAll(".pir-row-checkbox").forEach(e=>e.checked=!1)}async function Gn(e){if(!e.file_path){oe(e,null,null);return}oe(e,null,null,!0);try{const{data:t}=g.storage.from("pir_attachments").getPublicUrl(e.file_path),n=t.publicUrl,{data:i,error:a}=await g.storage.from("pir_attachments").download(e.file_path);if(a){console.warn("Could not fetch file metadata:",a),oe(e,n,null);return}const o={name:e.file_path.split("/").pop(),size:i.size,type:i.type||"application/octet-stream",url:n,data:i};oe(e,n,o)}catch(t){console.error("Preview error:",t),oe(e,null,null,!1,t.message)}}async function oe(e,t,n,i=!1,a=null){const o=document.getElementById("enhanced-pir-modal");o&&o.remove();const r=document.createElement("div");r.id="enhanced-pir-modal",r.className="modal enhanced-pir-modal",r.style.zIndex="2000";const s=M(e),d=Rt(s),l=n?.name?n.name.toLowerCase().split(".").pop():null;let c="";if(n&&e.file_path)try{if(e.file_path.split("/").length>=2){const{data:_}=await g.from("profiles").select("full_name").eq("site_id",e.site_id).single();_&&(c=`<div class="enhanced-info-item">
                            <span class="info-label">Uploaded by:</span>
                            <span class="info-value">${y(_.full_name||"Unknown")}</span>
                        </div>`)}}catch(v){console.warn("Could not fetch uploader info:",v)}const u=v=>{if(!v)return"Unknown size";if(v===0)return"0 Bytes";const _=1024,x=["Bytes","KB","MB","GB"],I=Math.floor(Math.log(v)/Math.log(_));return parseFloat((v/Math.pow(_,I)).toFixed(2))+" "+x[I]},m=v=>{switch(v){case"pdf":return"📄";case"doc":case"docx":return"📝";case"xls":case"xlsx":return"📊";case"ppt":case"pptx":return"📋";case"jpg":case"jpeg":case"png":case"gif":return"🖼️";default:return"📎"}};let f="",h="";i?f=`
                <div class="enhanced-preview-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading document preview...</p>
                </div>
            `:a?f=`
                <div class="enhanced-preview-error">
                    <div class="error-icon">⚠️</div>
                    <h4>Could not load preview</h4>
                    <p>${y(a)}</p>
                </div>
            `:t?(l==="pdf"?f=`
                    <div class="enhanced-pdf-preview">
                        <iframe src="${t}#toolbar=1&navpanes=0&scrollbar=1" 
                                style="width: 100%; height: 500px; border: none; border-radius: 8px;"></iframe>
                    </div>
                `:["jpg","jpeg","png","gif","webp"].includes(l)?f=`
                    <div class="enhanced-image-preview">
                        <img src="${t}" 
                             style="max-width: 100%; max-height: 500px; object-fit: contain; border-radius: 8px;" 
                             alt="Document preview">
                    </div>
                `:f=`
                    <div class="enhanced-preview-unsupported">
                        <div class="file-icon">${m(l)}</div>
                        <h4>Preview not available</h4>
                        <p>Preview is not supported for ${l?.toUpperCase()} files.</p>
                        <p class="muted">Click download to view the file in its native application.</p>
                    </div>
                `,h=`
                <button class="btn secondary" onclick="downloadPIRFile('${e.file_path}', '${n?.name||"document"}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Download
                </button>
                ${l==="pdf"?`
                <button class="btn secondary" onclick="window.open('${t}', '_blank')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                    Open in New Tab
                </button>
                `:""}
                <button class="btn primary" onclick="openPIRManageModal(pirDocsCache.find(d => d.id === ${e.id}))">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Update File
                </button>
            `):f=`
                <div class="enhanced-preview-empty">
                    <div class="empty-icon">📄</div>
                    <h4>No file attached</h4>
                    <p>This document doesn't have any files attached yet.</p>
                    <button class="btn primary" onclick="openPIRManageModal(pirDocsCache.find(d => d.id === ${e.id}))">
                        Upload File
                    </button>
                </div>
            `,r.innerHTML=`
            <div class="modal-content enhanced-pir-content">
                <div class="enhanced-pir-header">
                    <div class="header-main">
                        <h2>${y(e.title)}</h2>
                        <span class="pir-status-chip ${d}">${s}</span>
                    </div>
                    <div class="header-meta">
                        <span class="category-badge">${y(e.category)}</span>
                        <span class="item-type-badge">${ke(e.item_type)}</span>
                    </div>
                </div>
                
                <div class="enhanced-pir-body">
                    <div class="enhanced-pir-sidebar">
                        <div class="enhanced-info-section">
                            <h4>Document Information</h4>
                            
                            ${n?`
                            <div class="enhanced-info-item">
                                <span class="info-label">File Name:</span>
                                <span class="info-value">${y(n.name)}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">File Size:</span>
                                <span class="info-value">${u(n.size)}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">File Type:</span>
                                <span class="info-value">${l?.toUpperCase()||"Unknown"}</span>
                            </div>
                            `:""}
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">Status:</span>
                                <span class="info-value status-${d}">${s}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">Last Updated:</span>
                                <span class="info-value">${e.last_updated?T(e.last_updated):"Never"}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">Created:</span>
                                <span class="info-value">${T(e.created_at)}</span>
                            </div>
                            
                            ${c}
                        </div>
                        
                        <div class="enhanced-notes-section">
                            <h4>Notes</h4>
                            ${le(e)&&le(e).trim()?`
                                <div class="enhanced-notes-display">
                                    <div class="notes-content">${y(le(e)).replace(/\n/g,"<br>")}</div>
                                    <button class="btn secondary small" onclick="openPIRNotesModal(pirDocsCache.find(d => d.id === ${e.id}))">
                                        Edit Notes
                                    </button>
                                </div>
                            `:`
                                <div class="enhanced-notes-empty">
                                    <p class="muted">No notes added yet</p>
                                    <button class="btn secondary small" onclick="openPIRNotesModal(pirDocsCache.find(d => d.id === ${e.id}))">
                                        Add Notes
                                    </button>
                                </div>
                            `}
                        </div>
                        
                        ${!i&&!a?`
                        <div class="enhanced-actions-section">
                            <h4>Actions</h4>
                            <div class="enhanced-action-buttons">
                                ${h}
                            </div>
                        </div>
                        `:""}
                    </div>
                    
                    <div class="enhanced-pir-preview">
                        ${f}
                    </div>
                </div>
                
                <div class="enhanced-pir-footer">
                    <button class="btn secondary modal-close" onclick="document.getElementById('enhanced-pir-modal').remove()">
                        Close
                    </button>
                </div>
            </div>
        `,document.body.appendChild(r),r.classList.add("show"),r.addEventListener("click",v=>{(v.target===r||v.target.classList.contains("modal-close"))&&r.remove()});const b=v=>{v.key==="Escape"&&(r.remove(),document.removeEventListener("keydown",b))};document.addEventListener("keydown",b)}function Vn(){alert("Bulk upload functionality would be implemented here - allows mapping multiple files to PIR items by filename hints")}function Wn(e){if(!e){console.error("No document provided to openPIRManageModal");return}Y("pir_documents","edit",e)}function Yn(){const e=D.map(t=>({Category:t.category,Title:t.title,Status:M(t),"Last Updated":t.last_updated||"Never","Evidence Type":ke(t.item_type)}));Ft(e,"PIR-Checklist.csv")}function Kn(){const e=D.filter(t=>S.selectedItems.has(t.id));alert(`Bulk upload for ${e.length} selected items would be implemented here`)}function Qn(){const t=D.filter(n=>S.selectedItems.has(n.id)).map(n=>({Category:n.category,Title:n.title,Status:M(n),"Last Updated":n.last_updated||"Never","Evidence Type":ke(n.item_type)}));Ft(t,"PIR-Selected-Items.csv")}function Zn(e){const t=Ke(e);if(!t?.allow_templates||!t.templates)return;const n=document.createElement("div");n.className="modal",n.innerHTML=`
            <div class="modal-content" style="width: 600px;">
                <div class="modal-header">
                    <h3>Templates for: ${y(e.title)}</h3>
                    <button type="button" class="modal-close">&times;</button>
                </div>
                <div style="padding: 20px;">
                    <p style="color: var(--muted); margin-bottom: 20px;">
                        Download and complete these templates, then upload the finished document.
                    </p>
                    <div style="display: grid; gap: 12px;">
                        ${t.templates.map(i=>{const a=t.templates_bucket||"pir_templates";return`
                                <a href="${`${window.SUPABASE_URL}/storage/v1/object/public/${a}/${i.path}`}" download class="btn secondary" style="text-align: left; justify-content: flex-start;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    ${y(i.label)}
                                </a>
                            `}).join("")}
                    </div>
                </div>
            </div>
        `,document.body.appendChild(n),n.classList.add("show"),n.addEventListener("click",i=>{(i.target===n||i.target.closest(".modal-close"))&&n.remove()})}function Jn(e){const t=document.getElementById("pir-notes-modal");t&&t.remove();const n=document.createElement("div");n.id="pir-notes-modal",n.className="modal pir-notes-modal",n.style.zIndex="2001",n.innerHTML=`
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Notes for: ${y(e.title)}</h2>
                    <button class="modal-close" onclick="document.getElementById('pir-notes-modal').remove()">×</button>
                </div>
                
                <div class="modal-body">
                    <div class="field">
                        <label for="pir-notes-textarea">Document Notes</label>
                        <textarea 
                            id="pir-notes-textarea" 
                            rows="8" 
                            placeholder="Add notes about this document, its status, or any important information..."
                        >${y(le(e)||"")}</textarea>
                        <div class="hint">These notes are private to your organization and will not be included in any reports.</div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn secondary" onclick="document.getElementById('pir-notes-modal').remove()">
                        Cancel
                    </button>
                    <button class="btn primary" onclick="savePIRNotes(${e.id})">
                        Save Notes
                    </button>
                </div>
            </div>
        `,document.body.appendChild(n),n.classList.add("show"),setTimeout(()=>{const a=document.getElementById("pir-notes-textarea");a&&a.focus()},100);const i=a=>{a.key==="Escape"&&(n.remove(),document.removeEventListener("keydown",i))};document.addEventListener("keydown",i),n.addEventListener("click",a=>{a.target===n&&(n.remove(),document.removeEventListener("keydown",i))})}function Ut(e){return e.replace(/[^a-zA-Z0-9-_]/g,"-").toLowerCase()}function Ft(e,t){if(!e.length)return;const n=Object.keys(e[0]),i=[n.join(","),...e.map(s=>n.map(d=>`"${(s[d]||"").toString().replace(/"/g,'""')}"`).join(","))].join(`
`),a=new Blob([i],{type:"text/csv"}),o=window.URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=t,document.body.appendChild(r),r.click(),window.URL.revokeObjectURL(o),document.body.removeChild(r)}document.getElementById("pir-preview-close")?.addEventListener("click",()=>{document.getElementById("pir-preview-modal").classList.remove("show")});function Xn(e,t,n){const i=Ye.find(l=>l.title===e.title)||{};let a="";const o=t||{},r=`pir_draft_${e.title}`,s=localStorage.getItem(r);let d=e.status;switch(d==="Not Attached"&&!e.item_type.includes("file")&&(d="Not Started"),a+=`<div class="field"><label>Last Updated</label><input id="field-pir-last_updated" type="date" value="${e.last_updated||""}" /></div>`,e.item_type.includes("file")&&(a+=`
                <div class="field-group certificate-tracking" style="background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin: 16px 0;">
                    <h4 style="margin: 0 0 12px 0; color: var(--accent-2);">📋 Certificate Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="field" style="margin: 0;">
                            <label>Certificate Date</label>
                            <input id="field-pir-certificate_date" type="date" value="${o.certificate_date||""}" />
                            <div class="hint">Date when this certificate/document was issued</div>
                        </div>
                        <div class="field" style="margin: 0;">
                            <label>Valid Until</label>
                            <input id="field-pir-expiry_date" type="date" value="${o.expiry_date||""}" />
                            <div class="hint">When this certificate expires</div>
                        </div>
                    </div>
                    <div class="field" style="margin: 12px 0 0 0;">
                        <label>Review Reminder (days before expiry)</label>
                        <select id="field-pir-review_days_before" style="width: 200px;">
                            <option value="">No reminder</option>
                            <option value="7" ${o.review_days_before===7?"selected":""}>7 days</option>
                            <option value="14" ${o.review_days_before===14?"selected":""}>14 days</option>
                            <option value="30" ${o.review_days_before===30?"selected":""}>30 days</option>
                            <option value="60" ${o.review_days_before===60?"selected":""}>60 days</option>
                            <option value="90" ${o.review_days_before===90?"selected":""}>90 days</option>
                        </select>
                        <div class="hint">Get reminded to review/renew before expiry</div>
                    </div>
                </div>
            `),i.templates&&i.templates.length>0&&(a+=`<div class="pir-template-section">
                <label>Templates</label>
                <div class="template-buttons">
                    ${i.templates.map(l=>`
                        <button type="button" class="btn secondary template-download-btn" data-template-name="${l.name}" data-template-url="${l.url}">
                            📄 ${l.name}
                        </button>
                    `).join("")}
                </div>
            </div>`),e.item_type){case"textarea":const l=s||o.text_content||"";a+=`<div class="field">
                    <label>Summary / Statement</label>
                    <textarea id="field-pir-text_content" class="draft-enabled" data-draft-key="${r}">${y(l)}</textarea>
                    ${s?'<div class="draft-indicator">📝 Draft saved</div>':""}
                </div>`;break;case"textarea_and_file":const c=s||o.text_content||"";a+=`<div class="field">
                    <label>Summary / Process Description</label>
                    <textarea id="field-pir-text_content" class="draft-enabled" data-draft-key="${r}">${y(c)}</textarea>
                    ${s?'<div class="draft-indicator">📝 Draft saved</div>':""}
                    <div class="hint">${i.description||""}</div>
                </div>`;break;case"guided_questions":case"guided_questions_and_file":case"guided_questions_and_number":i.questions&&i.questions.forEach((u,m)=>{const f=`${r}_q${m}`,h=localStorage.getItem(f),b=h||o.answers?.[m]||"";a+=`<div class="field">
                            <label>${y(u)}</label>
                            <textarea data-question-index="${m}" class="draft-enabled" data-draft-key="${f}">${y(b)}</textarea>
                            ${h?'<div class="draft-indicator">📝 Draft saved</div>':""}
                        </div>`}),e.item_type.includes("number")&&(a+=`<div class="field"><label>${y(i.label||"Value")}</label><input id="field-pir-num1" type="number" value="${y(o.num1||"")}" /></div>`);break;case"number":a+=`<div class="field"><label>${y(i.label||"Value")}</label><input id="field-pir-num1" type="number" value="${y(o.num1||"")}" /></div>`;break;case"dual_number":case"triple_number":a+=`<div class="multi-input-container">${i.labels.map((u,m)=>`
                    <div class="field"><label>${y(u)}</label><input id="field-pir-num${m+1}" type="number" value="${y(o[`num${m+1}`]||"")}" /></div>
                `).join("")}</div>`;break;case"dual_text":a+=`<div class="multi-input-container">${i.labels.map((u,m)=>`
                    <div class="field"><label>${y(u)}</label><input id="field-pir-text${m+1}" type="text" value="${y(o[`text${m+1}`]||"")}" /></div>
                `).join("")}</div>`;break;case"dynamic_table":a+=`<div class="field"><label>${y(e.title)}</label><div id="dynamic-table-container"></div><button type="button" class="btn secondary" id="btn-add-table-row" style="margin-top:8px; font-size:12px; padding: 6px 10px;">+ Add Row</button></div>`;break}if(e.item_type.includes("file")){const l=n?n.split("/").pop():"No file attached";a+=`<hr style="border:none; border-top: 1px solid var(--border-color); margin: 16px 0;">
                <div class="field">
                <label>Attached File</label>
                <div id="file-display" style="padding:10px 12px; background:#ffffff10; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span>${y(l)}</span>
                    <div style="display:flex; gap:6px;">
                      ${n?'<button type="button" class="btn secondary" id="btn-preview-pir" style="padding: 4px 8px; font-size: 12px;">Preview</button>':""}
                      ${n?'<button type="button" class="btn secondary" id="btn-download-pir" style="padding: 4px 8px; font-size: 12px;">Download</button>':""}
                      ${n?'<button type="button" class="btn secondary" id="btn-delete-pir-attachment" style="padding: 4px 8px; font-size: 12px; background: #ff6b6b33; border-color: #ff6b6b55;">Delete</button>':""}
                    </div>
                </div>
                <input type="file" id="field-pir-file_path" style="color: var(--muted); font-size: 12px;" />
                <div class="hint">${i.description||"Uploading a new file will replace the existing one."}</div>
                </div>`}return a}const ye=document.getElementById("roles-modal");ye&&ye.addEventListener("click",e=>{(e.target===ye||e.target.closest(".modal-close"))&&ye.classList.remove("show")});async function jt(){console.log("🚀 Bootstrap starting...");try{const{data:{session:e},error:t}=await g.auth.getSession();if(t){console.error("❌ Session check failed:",t),j(!0);return}if(!e){console.log("ℹ️ No session found, showing auth"),j(!0);return}console.log("✅ Session found, user:",e.user?.email),j(!1);try{console.log("📍 Loading context..."),await We(),console.log("✅ Context loaded successfully")}catch(n){console.error("❌ Context loading failed:",n),te("Failed to load user context: "+(n.message||"Unknown error"));return}try{console.log("🌱 Seeding initial PIR docs..."),await Mn(),console.log("📅 Caching schedules..."),await Ae(),console.log("📊 Loading dashboard data..."),await Promise.all([P(),me(),ce(),ae(),_e(),G(),we(),Ee(),xe(),qe(),ve(),J(),ie()]),console.log("✅ All data loaded successfully")}catch(n){console.error("⚠️ Data loading failed (non-critical):",n),te("Some data failed to load. Dashboard may show incomplete information.")}if(ee()==="view-pre-inspection")try{await re()}catch(n){console.error("PIR loading failed:",n)}try{console.log("🔄 Setting up real-time subscriptions..."),g.channel("changes").on("postgres_changes",{event:"*",schema:"public",table:"items",filter:`site_id=eq.${p.site_id}`},ae).on("postgres_changes",{event:"*",schema:"public",table:"rooms",filter:`site_id=eq.${p.site_id}`},async()=>{await _e(),await P()}).on("postgres_changes",{event:"*",schema:"public",table:"complaints",filter:`site_id=eq.${p.site_id}`},async()=>{await G(),await P()}).on("postgres_changes",{event:"*",schema:"public",table:"check_types",filter:`site_id=eq.${p.site_id}`},async()=>{await we(),await P()}).on("postgres_changes",{event:"*",schema:"public",table:"kiosk_users",filter:`site_id=eq.${p.site_id}`},async()=>{await xe(),await P()}).on("postgres_changes",{event:"*",schema:"public",table:"submissions",filter:`site_id=eq.${p.site_id}`},async()=>{await ce(),await qe(),await ve(),ee()==="view-calendar"&&J()}).on("postgres_changes",{event:"*",schema:"public",table:"item_allowed_types",filter:`site_id=eq.${p.site_id}`},async()=>{await Ee(),await Ae(),await ve(),ee()==="view-calendar"&&J()}).on("postgres_changes",{event:"*",schema:"public",table:"pir_documents",filter:`site_id=eq.${p.site_id}`},async()=>{ee()==="view-pre-inspection"&&re()}).on("postgres_changes",{event:"*",schema:"public",table:"training_records",filter:`site_id=eq.${p.site_id}`},async()=>{await ie(),await P()}).on("postgres_changes",{event:"*",schema:"public",table:"pir_documents",filter:`site_id=eq.${p.site_id}`},async()=>{await ie(),ee()==="view-pre-inspection"&&re()}).on("postgres_changes",{event:"*",schema:"public",table:"submission_rows",filter:`site_id=eq.${p.site_id}`},async n=>{if(U.classList.contains("show")){const i=U.dataset.submissionId;n.new.submission_id==i&&Oe(i)}await ie()}).on("postgres_changes",{event:"*",schema:"public",table:"complaints",filter:`site_id=eq.${p.site_id}`},async()=>{await G(),await P(),await ie()}).on("postgres_changes",{event:"*",schema:"public",table:"submission_rows",filter:`site_id=eq.${p.site_id}`},async n=>{if(U.classList.contains("show")){const i=U.dataset.submissionId;n.new.submission_id==i&&Oe(i)}}).subscribe(),console.log("✅ Real-time subscriptions set up")}catch(n){console.error("⚠️ Failed to set up real-time subscriptions:",n)}console.log("🎉 Bootstrap completed successfully")}catch(e){console.error("💥 Bootstrap failed with unexpected error:",e),te("Application failed to start. Please refresh the page and try again."),e.message&&(e.message.includes("auth")||e.message.includes("session")||e.message.includes("token"))&&(console.log("Authentication error detected, redirecting to login"),j(!0))}}const zt=document.getElementById("crud-modal"),st=document.getElementById("crud-title"),ea=document.getElementById("crud-form"),Re=document.getElementById("crud-fields"),A=document.getElementById("crud-error"),Gt=document.getElementById("crud-delete"),ta=document.getElementById("crud-cancel");let E={entity:null,mode:"add",row:null,pk:null,context:{}};const de={rooms:{table:"rooms",label:"Room",pk:"id",fields:[{name:"name",label:"Name",type:"text",required:!0},{name:"occupied_by",label:"Owner (Staff)",type:"select",source:"kiosk_users",sourceLabel:"full_name"}]},check_types:{table:"check_types",label:"Check Type",pk:"id",fields:[{name:"name",label:"Name",type:"text",required:!0},{name:"active",label:"Active",type:"checkbox",default:!0}]},kiosk_users:{table:"kiosk_users",label:"Staff",pk:"id",fields:[{name:"full_name",label:"Full Name",type:"text",required:!0},{name:"role",label:"Role",type:"select",required:!0},{name:"reports_to_id",label:"Reports To",type:"select",source:"kiosk_users",sourceLabel:"full_name",valueKey:"id"},{name:"active",label:"Active",type:"checkbox",default:!0}]},complaints:{table:"complaints",label:"Complaint",pk:"id",fields:[{name:"attachment",label:"Attach Complaint Document",type:"file-upload",fullWidth:!0},{name:"complaint_date",label:"Complaint Date",type:"datepicker",required:!0},{name:"patient_initials",label:"Patient Initials",type:"text",required:!0,maxLength:10},{name:"age",label:"Age",type:"age-selector"},{name:"complaint_number",label:"Complaint Number",type:"text",readonly:!0},{name:"response_sent",label:"Response Sent",type:"checkbox",default:!1},{name:"complaint_summary",label:"Complaint Summary",type:"textarea",required:!0,fullWidth:!0},{name:"original_complaint",label:"Original Complaint Details",type:"textarea",fullWidth:!0},{name:"response",label:"Response Given",type:"textarea",fullWidth:!0},{name:"lessons_learned",label:"Lessons Learned",type:"textarea",fullWidth:!0},{name:"category",label:"Category",type:"select",source:"complaint_categories",sourceLabel:"name",valueKey:"name",required:!0},{name:"solution_given",label:"Solution Given",type:"textarea",fullWidth:!0},{name:"category_trends",label:"Category for Trends Chart",type:"category-select",options:[{value:"MEDICATION",label:"MEDICATION",color:"#ff6b6b"},{value:"COMMUNICATION",label:"COMMUNICATION",color:"#4ecdc4"},{value:"ADMIN",label:"ADMIN",color:"#45b7d1"},{value:"MEDICAL",label:"MEDICAL",color:"#96ceb4"},{value:"APPT SYSTEM",label:"APPT SYSTEM",color:"#feca57"},{value:"OUTSIDE AGENCIES",label:"OUTSIDE AGENCIES",color:"#ff9ff3"},{value:"GDPR",label:"GDPR",color:"#54a0ff"}],required:!0},{name:"people_involved",label:"Names of People Involved",type:"staff-multi-select",source:"kiosk_users",sourceLabel:"full_name",valueKey:"id"},{name:"avenue_used",label:"Avenue Used to Complain",type:"avenue-select",options:[{value:"Phone",label:"Phone"},{value:"Email",label:"Email"},{value:"Letter",label:"Letter"},{value:"In Person",label:"In Person"},{value:"Online Form",label:"Online Form"},{value:"Social Media",label:"Social Media"}]},{name:"suggestions_prevent_reoccurrence",label:"Suggestions to prevent reoccurrence",type:"textarea",fullWidth:!0},{name:"actions_to_be_taken",label:"Actions to be taken",type:"textarea",fullWidth:!0},{name:"status",label:"Status",type:"status-select",options:[{value:"pending",label:"Pending",color:"#feca57"},{value:"investigating",label:"Investigating",color:"#ff6b6b"},{value:"resolved",label:"Resolved",color:"#1dd1a1"},{value:"closed",label:"Closed",color:"#636e72"}],default:"pending"},{name:"priority",label:"Priority",type:"priority-select",options:[{value:"low",label:"Low",color:"#1dd1a1"},{value:"medium",label:"Medium",color:"#feca57"},{value:"high",label:"High",color:"#ff6b6b"}],default:"medium"},{name:"share_with_team",label:"Share with team",type:"checkbox",default:!1},{name:"created_by",label:"Created by",type:"select",source:"kiosk_users",sourceLabel:"full_name",valueKey:"id"}]},items:{table:"items",label:"Item",pk:"id",fields:[{name:"item_id",label:"Code",type:"text",required:!0},{name:"item_name",label:"Name",type:"text",required:!0},{name:"room_id",label:"Room",type:"select",source:"rooms",sourceLabel:"name"},{name:"default_check_type_id",label:"Default Check Type",type:"select",source:"check_types",sourceLabel:"name"},{name:"active",label:"Active",type:"checkbox",default:!0}]},item_allowed_types:{table:"item_allowed_types",label:"Schedule",pk:"id",fields:[{name:"item_id",label:"Item",type:"select",source:"items",sourceLabel:"item_name",required:!0},{name:"check_type_id",label:"Check Type",type:"select",source:"check_types",sourceLabel:"name",required:!0},{name:"frequency",label:"Every",type:"frequency",onchange:function(e){const t=e.target.value.toLowerCase(),n=document.getElementById("field-scheduled_day");n&&(t.includes("mon")?n.innerHTML=Array.from({length:31},(i,a)=>`<option value="${a+1}">${a+1}${["st","nd","rd"][a]||"th"}</option>`).join(""):n.innerHTML=[{value:"Sun",label:"Sunday"},{value:"Mon",label:"Monday"},{value:"Tue",label:"Tuesday"},{value:"Wed",label:"Wednesday"},{value:"Thu",label:"Thursday"},{value:"Fri",label:"Friday"},{value:"Sat",label:"Saturday"}].map(i=>`<option value="${i.value}">${i.label}</option>`).join(""))},required:!0},{name:"scheduled_day",label:"On",type:"select"},{name:"required",label:"Required",type:"checkbox",default:!0}]},submission_rows:{table:"submission_rows",label:"Submission Row",pk:"id",fields:[{name:"check_type_id",label:"Check Type",type:"select",source:"check_types",sourceLabel:"name",required:!0},{name:"row_comment",label:"Comment",type:"textarea"}]},pir_documents:{table:"pir_documents",label:"Inspection Document",pk:"id"}};async function Y(e,t="add",n=null,i={}){if(A.textContent="",E={entity:de[e],mode:t,row:n,pk:de[e].pk,context:i},console.log("OpenCRUD - User Context:",{ctx_user:p.user,ctx_site_id:p.site_id,entityKey:e,mode:t}),debugLog("CRUD Open",{entity:e,mode:t,user:p.user?.id,site:p.site_id}),e==="pir_documents"){st.textContent=`Manage: ${n.title}`,Re.innerHTML=Xn(n,n.data,n.file_path);const r=document.getElementById("btn-delete-pir-attachment");if(r&&n?.file_path&&r.addEventListener("click",async()=>{if(confirm("Are you sure you want to delete this attachment? This cannot be undone."))try{A.textContent="Deleting...";const{error:s}=await g.storage.from("pir_attachments").remove([n.file_path]);if(s)throw s;const{data:d,error:l}=await g.from("pir_documents").update({file_path:null,status:"Not Attached",last_updated:new Date().toISOString().slice(0,10)}).eq("id",n.id).select().single();if(l)throw l;E.row=d,Y("pir_documents","edit",d),A.textContent=""}catch(s){A.textContent=`Deletion failed: ${s.message}`}}),n.item_type==="dynamic_table"){const s=document.getElementById("dynamic-table-container"),d=document.getElementById("btn-add-table-row"),l=(Ye.find(u=>u.title===n.title)||{}).headers||[];n.data||(n.data={}),n.data.table_data||(n.data.table_data=[]);const c=()=>{let u=`<table style="font-size:12px;"><thead><tr>${l.map(m=>`<th>${y(m)}</th>`).join("")}<th></th></tr></thead><tbody>`;n.data.table_data.forEach((m,f)=>{u+=`<tr>${l.map((h,b)=>`<td><input value="${y(m[b]||"")}" data-row="${f}" data-col="${b}" /></td>`).join("")}
                    <td><button type="button" class="btn-remove-row" data-index="${f}" style="all:unset; cursor:pointer; color: var(--danger);">✕</button></td></tr>`}),u+="</tbody></table>",s.innerHTML=u};d.addEventListener("click",()=>{n.data.table_data.push(new Array(l.length).fill("")),c()}),s.addEventListener("input",u=>{u.target.tagName==="INPUT"&&(n.data.table_data[u.target.dataset.row][u.target.dataset.col]=u.target.value)}),s.addEventListener("click",u=>{u.target.classList.contains("btn-remove-row")&&(n.data.table_data.splice(parseInt(u.target.dataset.index,10),1),c())}),c()}}else{st.textContent=t==="add"?`Add ${E.entity.label}`:i.titlePrefix||`Edit ${E.entity.label}`;let r=Array.isArray(E.entity.fields)?E.entity.fields.map(s=>({...s})):[];if(e==="kiosk_users"){const s=r.findIndex(d=>d.name==="role");s!==-1?r[s]={name:"role",label:"Role",type:"select",source:"kiosk_roles",sourceLabel:"role",valueKey:"role",required:!0}:r.push({name:"role",label:"Role",type:"select",source:"kiosk_roles",sourceLabel:"role",valueKey:"role",required:!0})}if(Re.innerHTML=`<div class="crud-grid">${r.map(s=>{let d=n?n[s.name]:s.type==="checkbox"?!!s.default:s.default??"";d==null&&(d=s.type==="checkbox"?!1:"");const l=`field-${s.name}`,c=s.label||s.name,u=s.fullWidth?"field full":"field";if(s.type==="text")return`<div class="${u}"><label>${y(c)}</label><input id="${l}" type="text" value="${y(d)}" ${s.required?"required":""} ${s.readonly?"readonly":""}></div>`;if(s.type==="datepicker"){const m=new Date().toISOString().slice(0,10),f=d?new Date(d).toISOString().slice(0,10):"";return`<div class="${u}">
              <label>${y(c)}</label>
              <div class="datepicker-wrapper">
                <input id="${l}" type="date" value="${y(f)}" ${s.required?"required":""} class="modern-datepicker" />
                <button type="button" class="btn secondary quick-date" onclick="document.getElementById('${l}').value='${m}'">Today</button>
              </div>
            </div>`}if(s.type==="age-selector"){const m=Array.from({length:100},(f,h)=>h+1).map(f=>`<option value="${f}" ${f==d?"selected":""}>${f}</option>`).join("");return`<div class="${u}">
              <label>${y(c)}</label>
              <select id="${l}" class="ui-select age-select">
                <option value="">Select age...</option>
                ${m}
                <option value="100+" ${d=="100+"?"selected":""}>100+</option>
              </select>
            </div>`}if(s.type==="staff-multi-select")return`<div class="${u}">
              <label>${y(c)}</label>
              <div class="multi-select-wrapper">
                <input id="${l}" type="hidden" value="${y(d)}" />
                <div class="staff-chips" id="${l}-chips"></div>
                <select id="${l}-selector" class="ui-select">
                  <option value="">Add staff member...</option>
                </select>
              </div>
            </div>`;if(s.type==="category-select"||s.type==="status-select"||s.type==="priority-select"||s.type==="avenue-select"){const m=(s.options||[]).map(f=>`<option value="${f.value}" ${f.value==d?"selected":""} data-color="${f.color||""}">${f.label}</option>`).join("");return`<div class="${u}">
              <label>${y(c)}</label>
              <select id="${l}" class="ui-select ${s.type}" ${s.required?"required":""}>
                ${s.required?"":'<option value="">Select...</option>'}
                ${m}
              </select>
            </div>`}if(s.type==="datetime"){let m="",f="";try{if(d){const h=new Date(d);m=h.toISOString().slice(0,10),f=h.toISOString().slice(11,16)}}catch{}return`<div class="${u}"><label>${y(c)}</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="${l}-date" type="date" value="${y(m)}" ${s.required?"required":""} />
                <input id="${l}-time" type="time" value="${y(f)}" ${s.required?"required":""} />
                <button type="button" class="btn secondary" id="${l}-now" style="padding:6px 8px;">Now</button>
              </div>
            </div>`}if(s.type==="textarea")return`<div class="${u}"><label>${y(c)}</label><textarea id="${l}" rows="3" ${s.required?"required":""}>${y(d)}</textarea></div>`;if(s.type==="checkbox")return`<div class="${u}"><label style="display:flex; gap:8px; align-items:center;"><input id="${l}" type="checkbox" ${d?"checked":""}> ${y(c)}</label></div>`;if(s.type==="select")if(s.options){const m=(s.options||[]).map(f=>`<option value="${f.value}"${f.value==d?" selected":""}>${f.label}</option>`).join("");return`<div class="${u}"><label>${y(c)}</label><select id="${l}" class="ui-select">${m}</select></div>`}else return`<div class="${u}"><label>${y(c)}</label><select id="${l}" class="ui-select"><option value="">Loading...</option></select></div>`;if(s.type==="frequency"){setTimeout(()=>{const v=String(d||"1 month").toLowerCase(),_=document.getElementById("field-scheduled_day");_&&(v.includes("mon")?_.innerHTML=Array.from({length:31},(x,I)=>`<option value="${I+1}">${I+1}${["st","nd","rd"][I]||"th"}</option>`).join(""):_.innerHTML=[{value:"Sun",label:"Sunday"},{value:"Mon",label:"Monday"},{value:"Tue",label:"Tuesday"},{value:"Wed",label:"Wednesday"},{value:"Thu",label:"Thursday"},{value:"Fri",label:"Friday"},{value:"Sat",label:"Saturday"}].map(x=>`<option value="${x.value}">${x.label}</option>`).join(""))},0);let m=1,f="day";if(typeof d=="string"&&d){const v=d.match(/(\d+)\s*(year|mon|week|day)/i);v&&(m=v[1],f=v[2].toLowerCase())}const b=[{v:"day",n:"day(s)"},{v:"week",n:"week(s)"},{v:"mon",n:"month(s)"},{v:"year",n:"year(s)"}].map(v=>`<option value="${v.v}"${v.v===f?" selected":""}>${v.n}</option>`).join("");return`<div class="${u}"><label>${y(c||"Every")}</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="${l}-n" type="number" min="1" value="${m}" style="width:110px">
                <select id="${l}-u">${b}</select>
              </div>
            </div>`}return s.type==="file-upload"?`<div class="${u}" style="border: 1px dashed #ccc; padding: 15px; border-radius: 8px; background: #f9f9f9;">
              <label style="font-weight: bold; margin-bottom: 10px; display: block;">${y(c)}</label>
              <div class="file-upload-area" style="text-align: center;">
                <input id="${l}" type="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt" style="display: none;" />
                <button type="button" class="btn secondary" onclick="document.getElementById('${l}').click()" style="margin-bottom: 10px;">
                  <span>📎 Choose File</span>
                </button>
                <div id="${l}-status" style="font-size: 12px; color: #666; margin-top: 5px;">No file selected</div>
                <div id="${l}-progress" style="display: none; margin-top: 10px;">
                  <div style="background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                    <div id="${l}-progress-bar" style="background: #4CAF50; height: 20px; width: 0%; transition: width 0.3s;"></div>
                  </div>
                  <div id="${l}-progress-text" style="font-size: 12px; margin-top: 5px;">Uploading...</div>
                </div>
              </div>
              <div class="ai-helper" style="margin-top:.5rem; display:flex; gap:.5rem; align-items:center; justify-content:center;">
                <button type="button" id="ai-populate-btn-${l}" class="ai-populate-btn btn btn-secondary" style="padding:.4rem .7rem; font-size:.9rem;">
                  Optional: Populate with AI
                </button>
                <span id="ai-status-${l}" style="font-size:.85rem; opacity:.8;"></span>
              </div>
            </div>`:`<div class="${u}"><label>${y(c)}</label><input id="${l}" type="text" value="${y(d)}"></div>`}).join("")}</div>`,e==="kiosk_users"&&(async()=>{const s=document.getElementById("field-role");if(s&&s.tagName.toLowerCase()==="select"){const d=[{v:"admin",l:"Admin"},{v:"staff",l:"Staff"}],l=(E.row||{}).role||"";s.innerHTML='<option value="">—</option>'+d.map(c=>{const u=String(c.v)===String(l)?" selected":"";return`<option value="${c.v}"${u}>${c.l}</option>`}).join("")}})(),(async()=>{for(const s of E.entity.fields||[])if(s.type==="select"&&s.source&&!s.options){const d=document.getElementById("field-"+s.name);if(!d)continue;try{const l=(s.valueKey||"id")+", "+(s.sourceLabel||"full_name");let c=g.from(s.source).select(l);const u=["rooms","check_types","items","kiosk_users","item_allowed_types"];typeof p<"u"&&p.site_id&&u.includes(s.source)&&(c=c.eq("site_id",p.site_id));const{data:m,error:f}=await c;if(!f&&Array.isArray(m)){let h=m;if(s.name==="reports_to_id"&&E?.row?.id){const v=s.valueKey||"id";h=m.filter(_=>String(_[v])!==String(E.row.id))}const b=(E.row||{})[s.name];if(d.innerHTML='<option value="">—</option>'+h.map(v=>{const _=v[s.valueKey||"id"],x=v[s.sourceLabel||"full_name"],I=String(_)===String(b)?" selected":"";return'<option value="'+_+'"'+I+">"+y(x)+"</option>"}).join(""),s.name==="created_by"){const v=d.value;v&&!Pe(v)&&p.user&&p.user.id&&(d.value=p.user.id)}}else d.innerHTML='<option value="">(error)</option>'}catch(l){console.warn("Select loader error for",s.name,l),d.innerHTML='<option value="">(error)</option>'}}})(),e==="complaints"){const s=document.getElementById("field-attachment");s&&s.addEventListener("change",async d=>{const l=d.target.files[0],c=document.getElementById("field-attachment-status"),u=document.getElementById("field-attachment-progress"),m=document.getElementById("field-attachment-progress-bar"),f=document.getElementById("field-attachment-progress-text");if(!l){c.textContent="No file selected",c.style.color="#666";return}if(l.size>10*1024*1024){c.textContent="File too large. Maximum size is 10MB.",c.style.color="#e74c3c";return}try{u.style.display="block",c.style.color="#666",c.textContent=`Selected: ${l.name} (${(l.size/1024).toFixed(1)} KB)`,E.pendingAttachment={file:l,fileName:l.name,fileSize:l.size,fileType:l.type},m.style.width="100%",f.textContent="Ready to upload when complaint is saved",setTimeout(()=>{u.style.display="none"},2e3)}catch(h){console.error("File selection error:",h),c.textContent="Error selecting file",c.style.color="#e74c3c",u.style.display="none"}}),setTimeout(()=>{const d=document.getElementById("field-people_involved-selector"),l=document.getElementById("field-people_involved-chips"),c=document.getElementById("field-people_involved");d&&l&&c&&(g.from("kiosk_users").select("id, full_name").eq("site_id",p.site_id).then(({data:u,error:m})=>{u&&!m&&(d.innerHTML='<option value="">Add staff member...</option>'+u.map(f=>`<option value="${f.id}">${f.full_name}</option>`).join(""))}),d.addEventListener("change",u=>{if(u.target.value){const m=u.target.value,f=u.target.selectedOptions[0].text,h=c.value?c.value.split(","):[];if(!h.includes(m)){h.push(m),c.value=h.join(",");const b=document.createElement("div");b.className="staff-chip",b.innerHTML=`${f} <button type="button" onclick="this.parentElement.remove(); updateStaffIds()">×</button>`,l.appendChild(b)}u.target.value=""}}),window.updateStaffIds=function(){const u=l.querySelectorAll(".staff-chip"),m=Array.from(u).map(f=>{const h=f.textContent.replace("×","").trim(),b=Array.from(d.options).find(v=>v.text===h);return b?b.value:null}).filter(f=>f);c.value=m.join(",")},c.value&&c.value.split(",").forEach(m=>{const f=Array.from(d.options).find(h=>h.value===m);if(f){const h=document.createElement("div");h.className="staff-chip",h.innerHTML=`${f.text} <button type="button" onclick="this.parentElement.remove(); updateStaffIds()">×</button>`,l.appendChild(h)}}))},100)}(function(){(E.entity.fields||[]).forEach(d=>{if(d.type==="datetime"){const l=document.getElementById(`field-${d.name}-now`);if(!l)return;l.addEventListener("click",()=>{const c=new Date,u=document.getElementById(`field-${d.name}-date`),m=document.getElementById(`field-${d.name}-time`);u&&(u.value=c.toISOString().slice(0,10)),m&&(m.value=c.toISOString().slice(11,16))})}})})()}const a=document.getElementById("btn-download-pir");a&&n?.file_path&&a.addEventListener("click",async()=>{const{data:r,error:s}=await g.storage.from("pir_attachments").download(n.file_path);if(s){A.textContent=`Download failed: ${s.message}`;return}const d=URL.createObjectURL(r),l=document.createElement("a");l.href=d,l.download=n.file_path.split("/").pop(),document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(d)});const o=document.getElementById("btn-preview-pir");o&&n?.file_path&&o.addEventListener("click",async()=>{const{data:r,error:s}=await g.storage.from("pir_attachments").download(n.file_path);if(s){A.textContent=`Preview failed: ${s.message}`;return}const d=n.file_path.split("/").pop().toLowerCase(),l=URL.createObjectURL(r);if(d.endsWith(".pdf"))showPdfPreview(l,d);else if(d.match(/\.(docx?|xlsx?|pptx?)$/))showDocumentMetadata(d,r.size);else{const c=document.createElement("a");c.href=l,c.target="_blank",document.body.appendChild(c),c.click(),document.body.removeChild(c)}}),Gt.style.display=t==="edit"&&e!=="pir_documents"?"inline-block":"none",zt.classList.add("show")}function He(){zt.classList.remove("show")}ta.addEventListener("click",He);ea.addEventListener("submit",async e=>{e.preventDefault(),A.textContent="";const t=E.entity;let n={};if(t.table==="pir_documents"){const a=E.row;n.last_updated=document.getElementById("field-pir-last_updated").value||null;let o=a.data||{},r=!1;const s=document.getElementById("field-pir-certificate_date")?.value||null,d=document.getElementById("field-pir-expiry_date")?.value||null,l=document.getElementById("field-pir-review_days_before")?.value||null;if(s&&(o.certificate_date=s),d&&(o.expiry_date=d),l&&(o.review_days_before=parseInt(l)),a.item_type.includes("textarea")){const m=document.getElementById("field-pir-text_content")?.value||null;o.text_content=m,m&&(r=!0)}a.item_type.includes("questions")&&(o.answers=Array.from(Re.querySelectorAll("textarea[data-question-index]")).map(m=>m.value),o.answers.some(m=>m)&&(r=!0)),(a.item_type.includes("number")||a.item_type.includes("dual")||a.item_type.includes("triple"))&&(o.num1=document.getElementById("field-pir-num1")?.value||null,o.num2=document.getElementById("field-pir-num2")?.value||null,o.num3=document.getElementById("field-pir-num3")?.value||null,(o.num1||o.num2||o.num3)&&(r=!0)),a.item_type.includes("text")&&(o.text1=document.getElementById("field-pir-text1")?.value||null,o.text2=document.getElementById("field-pir-text2")?.value||null,(o.text1||o.text2)&&(r=!0)),a.item_type==="dynamic_table"&&(o.table_data=a.data.table_data,o.table_data?.length>0&&(r=!0)),n.data=o;const c=document.getElementById("field-pir-file_path");let u=!!a.file_path;if(c&&c.files.length>0){const m=c.files[0],f=`${p.site_id}/${a.id}/${m.name.replace(/[^a-zA-Z0-9.\-_]/g,"_")}`,{error:h}=await g.storage.from("pir_attachments").upload(f,m,{upsert:!0});if(h)throw h;n.file_path=f,u=!0}if(u||r)if(d){const m=new Date(d),h=Math.ceil((m-new Date)/(1e3*60*60*24));h<0?n.status="Expired":l&&h<=parseInt(l)?n.status="Expiring Soon":n.status="Ready"}else n.status="Ready";else n.status=a.item_type.includes("file")?"Not Attached":"Not Started"}else for(const a of E.entity.fields||[]){if(a.type==="file-upload")continue;let o;if(a.type==="checkbox")o=document.getElementById(`field-${a.name}`).checked;else if(a.type==="select")o=document.getElementById(`field-${a.name}`).value,o===""&&(o=null);else if(a.type==="frequency"){const r=document.getElementById(`field-${a.name}-n`).value||"1",s=document.getElementById(`field-${a.name}-u`).value||"day";o=`${r} ${s}`}else if(a.type==="datetime"){const r=document.getElementById(`field-${a.name}-date`),s=document.getElementById(`field-${a.name}-time`);document.getElementById(`field-${a.name}-now`);let d=r?r.value:null,l=s?s.value:null;if(!d&&!l)o=null;else{d||(d=new Date().toISOString().slice(0,10)),l||(l="00:00");const c=`${d}T${l}:00`,u=new Date(c);o=isNaN(u.getTime())?null:u.toISOString()}}else if(a.type==="age-selector")o=document.getElementById(`field-${a.name}`).value,o===""?o=null:o=parseInt(o);else if(a.type==="staff-multi-select"){const r=document.querySelectorAll(`input[name="field-${a.name}"]:checked`);o=Array.from(r).map(s=>s.value).join(","),o===""&&(o=null)}else a.type==="category-select"||a.type==="status-select"||a.type==="priority-select"||a.type==="avenue-select"?(o=document.getElementById(`field-${a.name}`).value,o===""&&(o=null)):a.type==="datepicker"?(o=document.getElementById(`field-${a.name}`).value,o===""&&(o=null)):a.type==="textarea"?(o=document.getElementById(`field-${a.name}`).value,o===""&&(o=null)):(o=document.getElementById(`field-${a.name}`).value,o===""&&(o=null));n[a.name]=o}if(p.site_id&&(n.site_id=p.site_id),E.mode==="add"&&t.table==="complaints"&&!n.complaint_number)try{const{count:a}=await g.from("complaints").select("id",{count:"exact",head:!0}).eq("site_id",p.site_id),o=(a||0)+1;n.complaint_number=`C${String(o).padStart(4,"0")}`}catch(a){console.warn("Failed to generate complaint number:",a),n.complaint_number=`C${Date.now()}`}n.created_by&&!Pe(n.created_by)&&(p.user&&p.user.id?(console.log("Coercing created_by from",n.created_by,"to",p.user.id),n.created_by=p.user.id):(console.log("Removing invalid created_by value:",n.created_by),delete n.created_by)),t.table==="complaints"&&!n.created_by&&p.user?.id&&(console.log("Setting created_by to current user:",p.user.id),n.created_by=p.user.id);const i=[];if((E.entity.fields||[]).forEach(a=>{if(a.name==="created_by"){const o=n.created_by;o&&(String(o).includes("-")?Pe(o)||i.push({field:a.name,value:o}):/^\d+$/.test(String(o))||i.push({field:a.name,value:o}))}}),i.length){A.textContent=`Please choose valid options for: ${i.map(a=>a.field).join(", ")}.`;return}if(t.table==="complaints"&&!n.datetime)if(n.complaint_date)try{const a=new Date(n.complaint_date);isNaN(a.getTime())?n.datetime=new Date().toISOString():n.datetime=a.toISOString()}catch{n.datetime=new Date().toISOString()}else n.datetime=new Date().toISOString();try{let a=null;if(console.log("About to save to database:",{mode:E.mode,table:t.table,body:n,context:{site_id:p.site_id,user_id:p.user?.id,pendingAttachment:!!E.pendingAttachment}}),debugLog("Form Submit",{mode:E.mode,table:t.table,hasAttachment:!!E.pendingAttachment,bodyKeys:Object.keys(n),created_by:n.created_by,site_id:n.site_id}),E.mode==="add"){const{data:o,error:r}=await g.from(t.table).insert(n).select("id").single();if(r)throw console.error("Database insert error:",r),debugLog("Insert Error",r),r;a=o?.id,console.log("Successfully inserted with ID:",a)}else{const o=E.pk||"id",r=E.row?.[o];if(!r)throw new Error("Missing primary key for update.");const{error:s}=await g.from(t.table).update(n).eq(o,r);if(s)throw s;a=r}if(t.table==="complaints"&&E.pendingAttachment&&a){const o=E.pendingAttachment.file,r=E.pendingAttachment.fileName,s=E.pendingAttachment.fileType,d=E.pendingAttachment.fileSize;try{const l=String(r).replace(/[^a-zA-Z0-9.\-_]/g,"_"),c=`complaints/${p.site_id}/${a}/${l}`;console.log("Uploading attachment to storagePath:",c,{fileType:s,fileSize:d});const{data:u,error:m}=await g.storage.from("pir_attachments").upload(c,o,{upsert:!0,contentType:s});if(console.log("uploadData:",u,"uploadError:",m),m)throw console.error("Supabase upload error object:",m),m;let f=null;try{const{data:_}=g.storage.from("pir_attachments").getPublicUrl(c);console.log("getPublicUrl result:",_),_&&_.publicUrl&&(f=_.publicUrl)}catch(_){console.warn("getPublicUrl threw:",_)}if(!f&&g.storage.from("pir_attachments").createSignedUrl)try{const{data:_,error:x}=await g.storage.from("pir_attachments").createSignedUrl(c,3600);console.log("createSignedUrl result:",_,"err:",x),!x&&_&&_.signedUrl&&(f=_.signedUrl)}catch(_){console.warn("createSignedUrl threw:",_)}const h={complaint_id:a,file_name:l,file_url:f||c,file_type:s,file_size:d,attachment_type:"original",uploaded_at:new Date().toISOString()};console.log("Inserting attachment record:",h),debugLog("Attachment Insert",{record:h,hasPublicUrl:!!f,storagePath:c});const{data:b,error:v}=await g.from("complaint_attachments").insert(h).select().single();if(console.log("attachment insert result:",{attachData:b,attachmentError:v}),v)throw v;E.pendingAttachment=null}catch(l){console.error("Attachment upload error:",l),console.error("Full error details:",JSON.stringify(l,null,2)),l.code==="42501"?console.error("RLS Policy Error: Check that complaint_attachments table has proper insert policies"):l.code==="23505"?console.error("Unique constraint violation in complaint_attachments"):l.message&&l.message.includes("policy")&&console.error("Policy violation detected:",l.message),debugLog("Attachment Error",{error:l,complaintId:a,fileName:r,fileSize:d,storagePath:typeof storagePath<"u"?storagePath:"undefined"});try{const c=l&&l.message?l.message:JSON.stringify(l);A.textContent=`Complaint saved, but attachment failed to upload: ${c}`}catch{A.textContent="Complaint saved, but attachment failed to upload. Check console for details."}setTimeout(()=>{A.textContent="",He()},8e3);return}}He(),t.table==="pir_documents"?re():await Promise.all([P(),ae(),_e(),G(),we(),Ee(),xe()])}catch(a){A.textContent=a.message||String(a)}});Gt.addEventListener("click",async()=>{for(const e of E.entity.fields||[]){let t;if(e.type==="checkbox")t=document.getElementById(`field-${e.name}`).checked;else if(e.type==="select")t=document.getElementById(`field-${e.name}`).value,t===""&&(t=null);else if(e.type==="frequency"){const n=document.getElementById(`field-${e.name}-n`).value||"1",i=document.getElementById(`field-${e.name}-u`).value||"day";t=`${n} ${i}`}else t=document.getElementById(`field-${e.name}`).value,t===""&&(t=null);body[e.name]=t}});document.getElementById("btn-new-room")?.addEventListener("click",()=>Y("rooms","add"));document.getElementById("btn-new-complaint")?.addEventListener("click",()=>Y("complaints","add"));document.getElementById("btn-new-ct")?.addEventListener("click",()=>Y("check_types","add"));document.getElementById("btn-new-item")?.addEventListener("click",()=>Y("items","add"));document.getElementById("btn-new-sched")?.addEventListener("click",()=>Y("item_allowed_types","add"));document.getElementById("app").addEventListener("click",async e=>{const t=e.target.closest("tr[data-id]");if(!t)return;const n=t.closest("tbody");if(!n)return;if(n.id==="subs-tbody"){Oe(t.dataset.id);return}const i=n.dataset.entity;if(i&&de[i]){const a=t.dataset.id;n.querySelectorAll("tr.selected").forEach(o=>o.classList.remove("selected")),t.classList.add("selected");try{const{data:o,error:r}=await g.from(de[i].table).select("*").eq(de[i].pk,a).maybeSingle();if(r)throw r;o&&Y(i,"edit",o)}catch(o){console.error("Error fetching row for editing:",o)}}});const rt=document.querySelector("#view-items thead");rt&&rt.addEventListener("click",e=>{const t=e.target.closest("th.sortable");if(!t)return;const n=t.getAttribute("data-col");K.col===n?K.dir=K.dir==="asc"?"desc":"asc":(K.col=n,K.dir="asc"),ae()});function ee(){const e=document.querySelector("section.view.active");return e?e.id:""}document.getElementById("search").addEventListener("keydown",e=>{e.key==="Enter"&&ee()==="view-items"&&(e.preventDefault(),Te=e.target.value.trim(),ae())});document.getElementById("cal-prev")?.addEventListener("click",()=>{k.setMonth(k.getMonth()-1),J()});document.getElementById("cal-next")?.addEventListener("click",()=>{k.setMonth(k.getMonth()+1),J()});document.getElementById("cal-view-switcher")?.addEventListener("click",e=>{const t=e.target.closest("button[data-view]");t&&(document.querySelectorAll("#cal-view-switcher button").forEach(n=>n.classList.remove("active")),t.classList.add("active"),Me=t.dataset.view,Me==="daily"&&(k=new Date),J())});const U=document.getElementById("submission-detail-modal");async function Oe(e){U.classList.add("show"),U.dataset.submissionId=e,document.getElementById("submission-detail-content").innerHTML='<div class="muted" style="padding:20px 0; text-align:center;">Loading details...</div>',document.getElementById("submission-detail-title").textContent=`Details for Submission #${e}`,console.log("DEBUG showSubmissionDetails: Fetching submission details for ID:",e);const{data:t,error:n}=await g.from("submission_rows").select(`
      id, row_comment, item_id, check_type, check_value, check_type_id, item_pk
    `).eq("submission_id",e);if(console.log("DEBUG showSubmissionDetails: Query result:",{rows:t,error:n}),n){console.error("Error fetching submission details:",n),document.getElementById("submission-detail-content").innerHTML=`<div class="muted" style="padding:20px 0; text-align:center; color:red;">Error loading details: ${n.message}</div>`;return}if(!t||t.length===0){console.log("DEBUG showSubmissionDetails: No rows found"),document.getElementById("submission-detail-content").innerHTML='<div class="muted" style="padding:20px 0; text-align:center;">No items found for this submission.</div>';return}let i='<div class="table-wrap" style="max-height: 60vh;"><table><thead><tr><th>Item ID</th><th>Check Performed</th><th>Result</th><th>Comment</th></tr></thead><tbody data-entity="submission_rows">';i+=t.map(a=>`<tr data-id="${a.id}">
      <td>${y(a.item_id||"Unknown")}</td>
      <td>${y(a.check_type||"Unknown Check")}</td>
      <td>${y(a.check_value||"Done")}</td>
      <td>${y(a.row_comment||"-")}</td>
    </tr>`).join(""),i+="</tbody></table></div>",console.log("DEBUG showSubmissionDetails: Generated HTML:",i),document.getElementById("submission-detail-content").innerHTML=i}U.addEventListener("click",e=>{(e.target===U||e.target.closest("#submission-detail-close"))&&U.classList.remove("show")});var w=typeof w<"u"?w:{staff:[],types:[],records:[]},X=typeof X<"u"?X:"clinical",L=typeof L<"u"?L:{search:"",status:"all",role:"all",sort:"name",compact:!1};async function V(){let e=document.getElementById("training-tbody");if(!e){try{console.debug("[training] tbody not found yet; retrying shortly")}catch{}setTimeout(V,100);return}if(window.ctx&&window.ctx.site_id)try{window.trainingLoadAttempts=0}catch{}e.innerHTML='<tr><td colspan="100%" class="muted">Loading training matrix...</td></tr>',(typeof window.trainingData>"u"||!window.trainingData)&&(window.trainingData={staff:[],types:[],records:[]}),w=window.trainingData;const t=window.location.hostname;if((!window.ctx||!window.ctx.site_id)&&(window.trainingLoadAttempts=(window.trainingLoadAttempts||0)+1,window.debugLog&&window.debugLog("loadTrainingMatrix:waitingForCtx",{host:t,attempt:window.trainingLoadAttempts}),window.trainingLoadAttempts<=40)){setTimeout(V,250);return}window.debugLog&&window.debugLog("loadTrainingMatrix:start",{hasCtx:!!window.ctx,site_id:window.ctx?.site_id});try{if(!window.ctx||!p.site_id){window.debugLog&&window.debugLog("loadTrainingMatrix:noCtx_final"),document.getElementById("training-tbody").innerHTML='<tr><td colspan="100%" class="muted">No site context yet. Please wait or reload.</td></tr>';return}const[n,i,a]=await Promise.all([g.from("kiosk_users").select("*").eq("site_id",p.site_id),g.from("training_types").select("*").eq("site_id",p.site_id).eq("active",!0),g.from("training_records").select("*").eq("site_id",p.site_id)]);if(n.error)throw n.error;if(i.error)throw i.error;if(a.error)throw a.error;w={staff:n.data||[],types:i.data||[],records:a.data||[]};try{window.trainingData=w}catch{}window.debugLog&&window.debugLog("loadTrainingMatrix:fetched",{staff:(n.data||[]).length,types:(i.data||[]).length,records:(a.data||[]).length}),na(),setTimeout(()=>F(),10)}catch(n){window.debugLog&&window.debugLog("loadTrainingMatrix:error",n),document.getElementById("training-tbody").innerHTML='<tr><td colspan="100%" class="muted">Failed to load training data: '+(n?.message||n)+"</td></tr>"}}try{window.loadTrainingMatrix=V}catch{}try{window.renderTrainingMatrix=F}catch{}function na(){try{const e=document.getElementById("training-search"),t=document.querySelectorAll(".filter-pill"),n=document.getElementById("density-toggle"),i=document.getElementById("role-filter"),a=document.getElementById("sort-select"),o=document.getElementById("close-drawer");if(e&&e.addEventListener("input",r=>{L.search=r.target.value.toLowerCase(),F()}),t.forEach(r=>{r.addEventListener("click",()=>{t.forEach(s=>s.classList.remove("active")),r.classList.add("active"),L.status=r.dataset.filter,F()})}),n&&n.addEventListener("click",()=>{L.compact=!L.compact,n.classList.toggle("active");const r=document.getElementById("training-matrix-container");r&&r.classList.toggle("compact",L.compact)}),i){const r=[...new Set(w.staff.map(s=>s.role).filter(Boolean))];i.innerHTML='<option value="all">All Roles</option>'+r.map(s=>`<option value="${s}">${s}</option>`).join(""),i.addEventListener("change",s=>{L.role=s.target.value,F()})}a&&a.addEventListener("change",r=>{L.sort=r.target.value,F()}),o&&o.addEventListener("click",()=>{document.getElementById("cell-drawer").classList.remove("open")})}catch(e){console.error("initializeTrainingControls error",e);const t=document.getElementById("training-tbody");t&&(t.innerHTML=`<tr><td colspan="100%" class="muted">Controls init error: ${y(e?.message||e)}</td></tr>`)}}function Vt(e){X=e,document.querySelectorAll("#view-training .tab-controls button").forEach(t=>t.classList.remove("active")),document.getElementById(`tab-${e}`).classList.add("active"),F()}function F(){try{try{window.debugLog&&window.debugLog("renderTrainingMatrix:enter",{now:Date.now()})}catch{}if(window.trainingData)try{w=window.trainingData}catch{}const t=document.getElementById("training-headers"),n=document.getElementById("training-tbody");if(!t||!n)return;try{window.debugLog&&window.debugLog("renderTrainingMatrix:starting",{staffLen:w.staff?.length,typesLen:w.types?.length})}catch{}if(!w.staff||w.staff.length===0||!w.types||w.types.length===0){n.innerHTML=`
          <tr><td colspan="100%" class="muted">No training data available.</td></tr>
          <tr><td colspan="100%" style="text-align:center; padding: 16px;">
            <button class="btn secondary" id="btn-use-demo-training">Use demo data to preview matrix</button>
          </td></tr>`;const i=document.getElementById("btn-use-demo-training");i&&i.addEventListener("click",()=>{w.staff=[{id:1,full_name:"Alice Example",role:"Nurse"},{id:2,full_name:"Bob Example",role:"HCA"}],w.types=[{id:101,name:"BLS",validity_months:12},{id:102,name:"GDPR",validity_months:24}];const a=new Date,o=new Date;o.setMonth(o.getMonth()+9),w.records=[{id:1001,staff_id:1,training_type_id:101,completion_date:a.toISOString(),expiry_date:o.toISOString(),provider:"Acme Training",verified_by:"Manager"},{id:1002,staff_id:2,training_type_id:102,completion_date:a.toISOString(),expiry_date:null,provider:"Acme Training"}],F()});return}}catch(t){console.error("renderTrainingMatrix error",t);const n=document.getElementById("training-tbody");n&&(n.innerHTML=`<tr><td colspan="100%" class="muted">Render error: ${y(t?.message||t)}</td></tr>`);return}let e=w.staff.filter(t=>{const n=["GP","Nurse","HCA","Practice Nurse","ANP"].some(r=>(t.role||"").toLowerCase().includes(r.toLowerCase())),i=X==="clinical"?n:!n,a=!L.search||(t.full_name||"").toLowerCase().includes(L.search),o=L.role==="all"||t.role===L.role;return i&&a&&o});L.status!=="all"&&(e=e.filter(t=>{const n=w.records.filter(a=>a.staff_id===t.id);return Wt(t.id,n)===L.status})),e.sort((t,n)=>{switch(L.sort){case"compliance":const i=Le(t.id);return Le(n.id)-i;case"expiry":const o=lt(t.id),r=lt(n.id);return!o&&!r?0:o?r?new Date(o)-new Date(r):-1:1;case"overdue":const s=dt(t.id);return dt(n.id)-s;default:return(t.full_name||"").localeCompare(n.full_name||"")}}),headers.innerHTML="<th>Staff Member</th>"+w.types.map(t=>`
        <th class="sortable" data-type-id="${t.id}" title="${y(t.description||t.name)}">
          ${y(t.name)}
        </th>
      `).join(""),headers.querySelectorAll("th.sortable").forEach(t=>{t.addEventListener("click",()=>{oa(t.dataset.typeId)})}),e.length===0?tbody.innerHTML=`<tr><td colspan="${w.types.length+1}" class="muted">No ${X} staff found</td></tr>`:tbody.innerHTML=e.map(t=>{const n=w.records.filter(o=>o.staff_id===t.id),i=Le(t.id),a=w.types.map(o=>{const r=n.find(s=>s.training_type_id===o.id);return aa(t.id,o.id,r)}).join("");return`<tr>
          <td title="${y(t.full_name)} - ${i}% compliant">${y(t.full_name||"Unknown")}<br><small class="compliance-badge">${i}% compliant</small></td>
          ${a}
        </tr>`}).join(""),ia(),tbody.querySelectorAll(".training-cell").forEach(t=>{t.addEventListener("click",()=>{const n=t.dataset.staffId,i=t.dataset.typeId;sa(n,i)})})}function aa(e,t,n,i,a){const o=new Date;let r="training-missing",s="—",d="No record found";if(n){new Date(n.completion_date);const l=n.expiry_date?new Date(n.expiry_date):null;if(l){const c=Math.ceil((l-o)/864e5);c<0?(r="training-expired",s="Expired",d=`Expired ${Math.abs(c)} days ago\\nCompleted: ${T(n.completion_date)}\\nExpired: ${T(n.expiry_date)}`):c<=30?(r="training-expiring",s=`${c}d`,d=`Expires in ${c} days\\nCompleted: ${T(n.completion_date)}\\nExpires: ${T(n.expiry_date)}`):(r="training-completed",s="✓",d=`Valid until ${T(n.expiry_date)}\\nCompleted: ${T(n.completion_date)}`)}else r="training-completed",s="✓",d=`Completed: ${T(n.completion_date)}\\nNo expiry date`;n.verified_by&&(d+=`\\nVerified by: ${n.verified_by}`)}return`<td class="training-cell ${r}" data-staff-id="${e}" data-type-id="${t}" title="${d}">
      ${s}
      <div class="training-tooltip">${d.replace(/\\n/g,"<br>")}</div>
    </td>`}function Wt(e,t){const n=new Date;let i=!1,a=!1,o=!1;return w.types.forEach(r=>{const s=t.find(d=>d.training_type_id===r.id);if(!s)o=!0;else if(s.expiry_date){const d=new Date(s.expiry_date),l=Math.ceil((d-n)/(1e3*60*60*24));l<0?i=!0:l<=30&&(a=!0)}}),i?"expired":a?"expiring":o?"missing":"valid"}function Le(e){const t=w.records.filter(a=>a.staff_id===e),n=new Date;let i=0;return w.types.forEach(a=>{const o=t.find(r=>r.training_type_id===a.id);o&&(o.expiry_date?new Date(o.expiry_date)>=n&&i++:i++)}),w.types.length>0?Math.round(i/w.types.length*100):0}function lt(e){const t=w.records.filter(a=>a.staff_id===e),n=new Date;let i=null;return t.forEach(a=>{if(a.expiry_date){const o=new Date(a.expiry_date);o>=n&&(!i||o<new Date(i))&&(i=a.expiry_date)}}),i}function dt(e){const t=w.records.filter(o=>o.staff_id===e),n=new Date;let i=0;t.forEach(o=>{o.expiry_date&&new Date(o.expiry_date)<n&&i++});const a=w.types.length-t.length;return i+a}function ia(e){let t={all:0,missing:0,expiring:0,expired:0,valid:0};w.staff.forEach(i=>{const a=w.records.filter(r=>r.staff_id===i.id),o=Wt(i.id,a);t.all++,t[o]++}),Object.keys(t).forEach(i=>{const a=document.getElementById(`count-${i}`);a&&(a.textContent=t[i])});const n={"legend-valid-count":t.valid,"legend-expiring-count":t.expiring,"legend-expired-count":t.expired,"legend-missing-count":t.missing};Object.entries(n).forEach(([i,a])=>{const o=document.getElementById(i);o&&(o.textContent=a)})}function oa(e){const t=document.querySelector(`th[data-type-id="${e}"]`),n=t.dataset.sort||"none";document.querySelectorAll("th.sortable").forEach(i=>{i.classList.remove("sort-asc","sort-desc"),delete i.dataset.sort}),n==="none"||n==="desc"?(t.classList.add("sort-asc"),t.dataset.sort="asc"):(t.classList.add("sort-desc"),t.dataset.sort="desc"),F()}function sa(e,t){const n=w.staff.find(o=>o.id==e),i=w.types.find(o=>o.id==t),a=w.records.find(o=>o.staff_id==e&&o.training_type_id==t);if(!(!n||!i)){if(document.getElementById("drawer-staff-name").textContent=n.full_name||"Unknown",document.getElementById("drawer-module-name").textContent=i.name,a){const o=new Date,r=a.expiry_date?new Date(a.expiry_date):null;let s="Completed";if(r){const d=Math.ceil((r-o)/864e5);d<0?s=`Expired (${Math.abs(d)} days ago)`:d<=30?s=`Expiring in ${d} days`:s="Valid"}document.getElementById("drawer-status").textContent=s,document.getElementById("drawer-issue-date").textContent=a.completion_date?T(a.completion_date):"-",document.getElementById("drawer-expiry-date").textContent=a.expiry_date?T(a.expiry_date):"No expiry",document.getElementById("drawer-provider").textContent=a.provider||"-",document.getElementById("drawer-evidence").textContent=a.certificate_url?"Certificate on file":"No evidence",document.getElementById("drawer-notes").textContent=a.notes||"-",document.getElementById("drawer-verified").textContent=a.verified_by?`${a.verified_by} on ${T(a.verified_date)}`:"Not verified"}else document.getElementById("drawer-status").textContent="No record",document.getElementById("drawer-issue-date").textContent="-",document.getElementById("drawer-expiry-date").textContent="-",document.getElementById("drawer-provider").textContent="-",document.getElementById("drawer-evidence").textContent="No evidence",document.getElementById("drawer-notes").textContent="-",document.getElementById("drawer-verified").textContent="Not verified";ra(e,t,a),document.getElementById("cell-drawer").classList.add("open")}}function ra(e,t,n){const i=document.getElementById("drawer-upload"),a=document.getElementById("drawer-replace"),o=document.getElementById("drawer-review"),r=document.getElementById("drawer-reminder");[i,a,o,r].forEach(u=>{u&&u.replaceWith(u.cloneNode(!0))});const s=document.getElementById("drawer-upload"),d=document.getElementById("drawer-replace");s&&s.addEventListener("click",()=>openTrainingModal(e,t)),d&&d.addEventListener("click",()=>openTrainingModal(e,t));const l=document.getElementById("drawer-review");l&&l.addEventListener("click",async()=>{if(n)try{await g.from("training_records").update({verified_by:p.user?.email||"System",verified_date:new Date().toISOString()}).eq("id",n.id),showToast("Record marked as reviewed","success"),V()}catch(u){showToast("Failed to mark as reviewed: "+u.message,"error")}});const c=document.getElementById("drawer-reminder");c&&c.addEventListener("click",()=>{showToast("Reminder functionality coming soon","info")})}function Ze(){document.getElementById("training-modal").classList.remove("show"),document.getElementById("training-error").style.display="none",document.getElementById("training-form").reset()}async function la(){const t=document.getElementById("training-certificate").files[0];if(!t)return;if(t.size>10*1024*1024){document.getElementById("training-error").textContent="File size must be less than 10MB",document.getElementById("training-error").style.display="block";return}const n=document.getElementById("training-upload-zone");n.innerHTML=`
      <div style="color: var(--success);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <p style="margin-top: 8px;">Selected: ${t.name}</p>
      </div>
    `}function da(){const e=document.getElementById("training-completion-date").value,t=document.getElementById("training-type-id").value;if(!e||!t)return;const n=w.types.find(r=>r.id==t);if(!n||!n.validity_months)return;const i=new Date(e),a=new Date(i);a.setMonth(a.getMonth()+n.validity_months);const o=document.getElementById("training-expiry-date");o.value=a.toISOString().split("T")[0]}async function ca(e){e.preventDefault();const t=document.getElementById("training-error");t.style.display="none";try{const n=document.getElementById("training-staff-id").value,i=document.getElementById("training-type-id").value,a=document.getElementById("training-completion-date").value,o=document.getElementById("training-expiry-date").value,r=document.getElementById("training-notes").value,s=document.getElementById("training-certificate");let d=null;if(s.files[0]){const u=s.files[0],m=`training-${n}-${i}-${Date.now()}.${u.name.split(".").pop()}`,{data:f,error:h}=await g.storage.from("training-certificates").upload(m,u);if(h)throw h;const{data:b}=g.storage.from("training-certificates").getPublicUrl(m);d=b.publicUrl}const l={site_id:p.site_id,staff_id:parseInt(n),training_type_id:parseInt(i),completion_date:a,expiry_date:o||null,notes:r||null,certificate_url:d},c=w.records.find(u=>u.staff_id==n&&u.training_type_id==i);if(c){const{error:u}=await g.from("training_records").update(l).eq("id",c.id);if(u)throw u}else{const{error:u}=await g.from("training_records").insert(l);if(u)throw u}Ze(),V()}catch(n){console.error("Failed to save training record:",n),t.textContent=n.message||"Failed to save training record",t.style.display="block"}}window.downloadTrainingCertificate=function(){const e=document.getElementById("training-staff-id").value,t=document.getElementById("training-type-id").value,n=w.records.find(i=>i.staff_id==e&&i.training_type_id==t);n?.certificate_url&&window.open(n.certificate_url,"_blank")};window.logout=async function(){try{await g.auth.signOut(),j(!0)}catch(e){console.error("Logout failed:",e),j(!0)}};document.addEventListener("DOMContentLoaded",jt);

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CheckLoop — Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="config.js"></script>
<script>
  // Configure PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<script>
// Move existing help icons into a neat top-right badge per page header
document.addEventListener('DOMContentLoaded', () => {
  // Find all help-icon buttons that call showHelp('view-...')
  const icons = Array.from(document.querySelectorAll('button.help-icon'));
  icons.forEach(btn => {
    // Extract view id from onclick attribute if present
    const onclick = btn.getAttribute('onclick') || '';
    const m = onclick.match(/showHelp\(['"]([^'"]+)['"]\)/);
    if (!m) return;
    const viewId = m[1];

    // Find nearest .page-header ancestor
    const header = btn.closest('.page-header');
    if (!header) return;

    // Avoid adding multiple badges
    if (header.querySelector('.page-help-badge')) {
      btn.remove();
      return;
    }

  // Create badge (letter i) to sit immediately to the right of the page title
    const badge = document.createElement('button');
    badge.className = 'page-help-badge';
    badge.setAttribute('aria-label', 'Page help');
    badge.title = 'Page help';
    // Use a compact eye glyph for clarity
  badge.innerHTML = 'i';
    badge.addEventListener('click', (e) => {
      e.preventDefault();
      showHelp(viewId);
    });

    // If the header uses a light panel background, give the badge a light variant
    const panelBg = getComputedStyle(header).backgroundColor || '';
    // crude check for very light backgrounds
    if (panelBg.startsWith('rgb(')) {
      const nums = panelBg.replace(/[rgba\(\) ]/g, '').split(',').map(n=>parseFloat(n));
      const avg = (nums[0] + nums[1] + nums[2]) / 3;
      if (avg > 220) badge.classList.add('light');
    }

    // Insert badge into the page title wrapper so it sits right of the title
    const titleWrapper = header.querySelector('.page-title-wrapper');
    if (titleWrapper) {
      titleWrapper.appendChild(badge);
    } else {
      header.appendChild(badge);
    }

    // Remove original button
    btn.remove();
  });
});
</script>
<script>
  // ——— Training Matrix bootstrapper: detect ctx later and retry load ———
  (function(){
    // Ensure a safe debugLog exists early to avoid ReferenceErrors
    window.debugLog = window.debugLog || function(){ try { console.log('[DBG]', ...arguments); } catch(e){} };
    function hasSiteCtx(){
      return typeof window.ctx === 'object' && window.ctx && Number(window.ctx.site_id) > 0;
    }
    function tryLoadTrainingMatrix(tag){
      if (!('loadTrainingMatrix' in window)) return false;
      if (!hasSiteCtx()) return false;
      try{
        console.info('[training-shim] triggering loadTrainingMatrix()', { tag, site_id: window.ctx.site_id });
        window.loadTrainingMatrix();
        return true;
      }catch(e){ console.warn('[training-shim] loadTrainingMatrix threw', e); return false; }
    }

    // 1) Intercept profile fetch to learn ctx when it arrives
    const _fetch = window.fetch;
    window.fetch = async function(input, init){
      const res = await _fetch(input, init);
      try{
        const url = (typeof input === 'string') ? input : input.url;
        if (url && url.includes('/rest/v1/profiles') && res.ok){
          const clone = res.clone();
          const data = await clone.json();
          const row = Array.isArray(data) ? data[0] : data;
          if (row && (row.site_id || row.role || row.full_name)){
            window.ctx = Object.assign({}, window.ctx || {}, {
              site_id: row.site_id ?? window.ctx?.site_id,
              role: row.role ?? window.ctx?.role,
              full_name: row.full_name ?? window.ctx?.full_name
            });
            if (row.site_id) localStorage.setItem('site_id', String(row.site_id));
            console.info('[training-shim] ctx learned from profiles', window.ctx);
            window.dispatchEvent(new CustomEvent('ctx-ready', { detail: window.ctx }));
            tryLoadTrainingMatrix('profiles-fetch');
          }
        }
      }catch(e){ /*ignore*/ }
      return res;
    };

    // 2) When someone signals ctx readiness
    window.addEventListener('ctx-ready', () => tryLoadTrainingMatrix('ctx-ready'));

    // 3) When the Training nav is clicked, attempt now and again after a short delay
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-section="training"], button');
      if (!btn) return;
      const label = (btn.getAttribute('data-section') || btn.textContent || '').toLowerCase();
      if (label.includes('training')){
        setTimeout(() => tryLoadTrainingMatrix('nav-click'), 50);
        setTimeout(() => tryLoadTrainingMatrix('nav-click-delay'), 400);
      }
    });

    // 4) Safety timer: if the view shows a spinner for >2s after page load, retry
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const trainingView = document.querySelector('#view-training');
        if (!trainingView) return;
        const text = (trainingView.textContent || '').toLowerCase();
        if (text.includes('loading training matrix')){
          tryLoadTrainingMatrix('post-load-timeout');
        }
      }, 2000);
    });

    // 5) Additional retry after authentication completes
    document.addEventListener('ctx-ready', () => {
      console.log('[training-shim] ctx-ready event received, retrying training matrix load');
      setTimeout(() => tryLoadTrainingMatrix('ctx-ready-event'), 100);
    });
  })();
</script>
<script>
  // ——— Minimal ctx shim so modules like the Training Matrix don't stall when ctx isn't built yet ———
  (function ensureCtx(){
    try{
      // If a valid ctx already exists, do nothing
      if (typeof window.ctx === 'object' && window.ctx && window.ctx.site_id) return;

      // Pull hints from config.js and/or localStorage
      const siteIdFromConfig = (typeof window.SITE_ID !== 'undefined' && window.SITE_ID !== null && window.SITE_ID !== '') ? Number(window.SITE_ID) : null;
      const siteIdFromStorage = Number(localStorage.getItem('site_id')) || null;
      const siteNameFromConfig = (typeof window.SITE_NAME !== 'undefined' && window.SITE_NAME) ? window.SITE_NAME : null;
      const siteNameFromStorage = localStorage.getItem('site_name') || null;
      const roleFromStorage = localStorage.getItem('role') || undefined;

      const site_id = siteIdFromConfig || siteIdFromStorage || null;
      const site_name = siteNameFromConfig || siteNameFromStorage || undefined;

      if (site_id){
        // Build a minimal ctx so feature loaders can proceed
        window.ctx = Object.assign({}, window.ctx || {}, { site_id, site_name, role: roleFromStorage });
        console.info('[ctx-shim] Using fallback ctx', window.ctx);
      } else {
        // No site context available — replace endless spinners with a helpful message
        console.warn('[ctx-shim] No site context available. Training matrix will show an error instead of infinite loading.');
        document.addEventListener('DOMContentLoaded', () => {
          const container = document.querySelector('#view-training .training-matrix, #view-training .table-wrap, #view-training .panel, #view-training');
          if (container && !container.__ctxShimMsg){
            container.__ctxShimMsg = true;
            const msg = document.createElement('div');
            msg.className = 'panel';
            msg.style.padding = '16px';
            msg.style.borderRadius = '12px';
            msg.innerHTML = '<strong>Cannot determine site context.</strong> Please sign in again or choose a site. (<em>ctx</em> is missing)';
            // Prefer to append into a panel body; otherwise, just insert
            if (container.firstChild) {
              container.insertBefore(msg, container.firstChild);
            } else {
              container.appendChild(msg);
            }
          }
        });
      }
    }catch(e){ console.error('[ctx-shim] failed', e); }
  })();
</script>
<style>
  :root{
    --bg1:#0b4fb3; --bg2:#062b6f; --glass:#ffffff12; --glass-2:#ffffff1a;
    --white:#e6f0ff; --muted:#b8c7e8; --ink:#eaf1ff;
    --accent:#76a7ff; --accent-2:#5f96ff; --success:#2bd4a7; --danger:#ff6b6b;
    --warning: #ffca28;
    --shadow: 0 10px 30px rgba(6,43,111,.35);
    --round:18px;
    --panel-bg: linear-gradient(145deg, #133b8a, #0c275e);
    --border-color: #ffffff1f;
    --stat-1-bg: #8e6eff33; --stat-1-color: #c4b5fd;
    --stat-2-bg: #2bd4a733; --stat-2-color: #6ee7b7;
    --stat-3-bg: #ffca2833; --stat-3-color: #ffe082;
    --stat-4-bg: #ff6b6b33; --stat-4-color: #fca5a5;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--ink); background:#0b3a86; overflow-x:hidden;
  }
  /* Silky animated background */
  .bg{
    position:fixed; inset:0; z-index:-1; overflow:hidden; background: radial-gradient(1200px 700px at 20% -10%, #6aa0ff33, transparent),
      radial-gradient(900px 600px at 90% 10%, #3566ff2e, transparent),
      linear-gradient(180deg, #0e3f93 0%, #082a69 100%);
  }
  .wave{
    position:absolute; width:160%; height:160%; left:-30%; top:-30%;
    background: conic-gradient(from 180deg at 50% 50%, #2c63ff22, #143a9622, #2c63ff22);
    filter: blur(60px);
    animation: drift 22s ease-in-out infinite alternate;
    transform-origin: 50% 50%;
  }
  .wave2{ animation-duration: 28s; mix-blend-mode: screen; }
  @keyframes drift{
    0%{ transform: rotate(0deg) scale(1.0); }
    100%{ transform: rotate(25deg) scale(1.08); }
  }

  /* Layout */
  .app{ display:grid; --sidebarW:260px; grid-template-columns: var(--sidebarW) 1fr; gap:22px; padding:22px; min-height:100vh; transition: grid-template-columns .2s ease; }
  .app.collapsed{ --sidebarW:56px; }
  /* Disable transitions during resize for smooth dragging */
  .app.is-resizing { transition: none !important; }
  .sidebar{
    background: linear-gradient(180deg, #1a4ea8 0%, #0e367e 100%);
    border-radius:20px; box-shadow: var(--shadow); padding:14px;
    transition: width 0.2s;
  }
  .app.collapsed #sidebar {
    overflow-x: hidden;
    padding-left: 6px;
    padding-right: 6px;
  }
  /* When collapsed, ensure the toggle remains visible and centered at the top */
  .app.collapsed #sidebar > .sidebar-toggle { float: none; display: inline-grid; margin: 10px auto; }
  .app.collapsed #sidebar .brand .t,
  .app.collapsed #sidebar .brand .hint,
  .app.collapsed #sidebar .menu-item-label { display:none; }
  .app.collapsed #sidebar .nav button{ justify-content:center; gap:0; padding:10px; }
  .app.collapsed #sidebar .icon{ margin:0; }
  .sidebar-toggle {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--white);
    margin: 8px 6px;
    padding: 8px;
    display: inline-grid;
    place-items: center;
    border-radius: 10px;
    transition: transform .18s ease, background .12s ease, color .12s ease;
    background: transparent;
  }
  .sidebar-toggle:focus { outline: 2px solid var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,.12); }
  .sidebar-toggle:hover { background: #ffffff12; }
  .sidebar-toggle-icon { color: var(--white); width:18px; height:18px; display:block; transition: transform .22s ease; }
  /* When the app is collapsed, rotate the chevron to point the other direction */
  .app.collapsed .sidebar-toggle-icon { transform: rotate(180deg); }

  /* Position the toggle visually near the top-right of the sidebar but keep it in the DOM flow */
  .sidebar > .sidebar-toggle { float: right; margin-top: 10px; margin-right: 6px; }
  .brand{ display:flex; align-items:center; gap:10px; padding:10px 12px 16px; }
  .brand .logo{ width:32px; height:32px; border-radius:10px; object-fit:contain; box-shadow: inset 0 0 0 2px #ffffff33; }
  .brand .t{ font-weight:800; letter-spacing:.2px }
  .menu-item-label{ font-weight:600; }

  .nav{ display:flex; flex-direction:column; gap:6px; margin-top:6px; }
  .nav button{
    all:unset; display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px;
    cursor:pointer; color:var(--white); opacity:.85;
    transition: transform .12s ease, background .2s ease, opacity .2s ease;
  }
  /* Group toggle for grouped menus (Configure / Checks & Audits) */
  .nav-group-toggle {
    all:unset; display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:8px 12px; color:var(--muted); font-weight:700; font-size:12px; cursor:pointer;
    border-radius:8px; margin-top:8px;
  }
  .nav-group-toggle:hover { background: #ffffff08; }
  .nav-group-toggle .caret {
    display:inline-block; width:10px; height:10px; transform-origin:center; transition: transform .18s ease, border-color .18s ease;
    border-right:2px solid var(--muted); border-bottom:2px solid var(--muted); transform: rotate(-45deg);
  }
  .nav-group-toggle[aria-expanded="true"] .caret { transform: rotate(45deg); border-color: var(--accent-2); }
  .nav-group { display:flex; flex-direction:column; gap:6px; padding-left:4px; }
  .nav-group.collapsed { display:none; }
  /* Tweak group toggles when sidebar collapsed: keep a compact, centred caret so the
     user still sees grouping affordance and icons remain visible (avoid disappearing UI). */
  .app.collapsed #sidebar .nav .nav-group-toggle {
    display:flex; align-items:center; justify-content:center; gap:0;
    padding:8px; border-radius:8px; margin-top:8px;
    color: var(--muted); background: transparent;
  }
  /* Ensure the caret remains visible and compact */
  .app.collapsed #sidebar .nav .nav-group-toggle .caret { display:block; transform: rotate(0deg); border-color: var(--muted); }

  /* Keep icons visible and consistent when collapsed */
  .app.collapsed #sidebar .nav .icon { margin:0; width:28px; height:28px; }

  /* Resize handle styling */
  #sidebar-resize-handle{
    position: absolute; top:0; right: -6px; width: 12px; height:100%; cursor: ew-resize; z-index:30;
    display:flex; align-items:center; justify-content:center; background: transparent;
  }
  #sidebar-resize-handle::before{
    content:''; width:2px; height:40px; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.14)); border-radius:2px;
    box-shadow: 0 0 0 6px transparent; transition: box-shadow .12s ease;
  }
  #sidebar-resize-handle:active::before{ box-shadow: 0 0 8px 2px rgba(0,0,0,0.12); }

  /* User Profile Section */
  .user-profile {
    margin-top: auto;
    padding: 12px 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    border-top: 1px solid rgba(255,255,255,0.06);
  }

  .user-row {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
  }

  .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 18px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    transition: transform 0.18s ease;
    flex-shrink: 0;
  }

  .user-avatar:hover { transform: scale(1.04); }

  .user-details {
    text-align: left;
    min-width: 0;
    flex: 1;
  }

  .user-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--white);
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .site-info {
    font-size: 12px;
    color: var(--muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .btn-signout {
    all: unset;
    padding: 8px;
    border-radius: 8px;
    background: rgba(255,255,255,0.06);
    color: var(--white);
    cursor: pointer;
    transition: background 0.18s ease, transform 0.12s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
  }

  .btn-signout svg { width: 18px; height: 18px; }

  .btn-signout:hover { background: rgba(255,255,255,0.14); transform: translateY(-1px); }

  /* Collapsed sidebar adjustments */
  .app.collapsed .user-profile { padding: 12px 6px; }
  .app.collapsed .user-avatar { width: 36px; height: 36px; font-size: 14px; }
  .app.collapsed .user-details { display: none; }
  .app.collapsed .btn-signout { padding: 6px; }

  /* Hide nav-group-toggle label text when collapsed but keep the caret visible */
  .app.collapsed #sidebar .nav .nav-group-toggle { font-size: 0; }
  .app.collapsed #sidebar .nav .nav-group-toggle .caret { display:inline-block; width:10px; height:10px; transform-origin:center; border-right:2px solid var(--muted); border-bottom:2px solid var(--muted); }
  .app.collapsed #sidebar .nav .nav-group-toggle[aria-expanded="true"] .caret { transform: rotate(45deg); border-color: var(--accent-2); }
  
  /* When collapsed: show all icons for every page (flatten groups into the icon rail).
    Hide the group toggle labels so the rail is compact, but keep child buttons visible
    as centered icons for direct access. This restores the previous behaviour where
    minimized sidebar shows every page's icon. */
  .app.collapsed #sidebar .nav .nav-group-toggle { display: none !important; }
  .app.collapsed #sidebar .nav .nav-group { display: flex !important; flex-direction: column; gap:6px; padding-left: 0 !important; }
  .app.collapsed #sidebar .nav .nav-group.collapsed { display: flex !important; }
  .app.collapsed #sidebar .nav .nav-group button { all:unset; display:flex !important; align-items:center; justify-content:center; padding:10px; border-radius:8px; }
  /* Hide text/badges when collapsed — only icons should remain visible */
  .app.collapsed #sidebar .menu-item-label, .app.collapsed #sidebar .nav .nav-badge { display:none !important; }
  /* Ensure every nav button is visible in collapsed mode (covers edge cases where scripts add/remove classes) */
  .app.collapsed #sidebar .nav, .app.collapsed #sidebar .nav * { visibility: visible !important; }
  .app.collapsed #sidebar .nav button { display:flex !important; opacity:1 !important; }
  .app.collapsed #sidebar .nav .icon { display:block !important; }
  .nav button:hover{ transform: translateY(-1px); background: #ffffff14; opacity:1; }
  .nav button.active{ background:var(--accent); color:var(--white); opacity:1; font-weight:600; }
  .nav .icon{
    width:32px; height:32px; /* Larger, more legible icons */
    object-fit:contain; opacity:1;
    color: var(--white) !important; /* SVGs use currentColor */
    flex-shrink:0; display:inline-flex; align-items:center; justify-content:center;
  }
  .nav .icon svg{ width:100%; height:100%; stroke-width:3.2; }
  /* Bitmap-only filters (kept for legacy PNGs if any remain elsewhere) */
  .nav img.icon{ filter: brightness(0) invert(1); }
  .nav button.active img.icon{
    /* Approximate green for bitmap icons */
    filter: invert(64%) sepia(41%) saturate(498%) hue-rotate(98deg) brightness(92%) contrast(92%);
  }
  /* Ensure bitmap icons match SVG sizing */
  .nav img.icon{ width:32px; height:32px; object-fit:contain; }

  .nav-badge {
    margin-left: auto;
    font-size: 11px;
    background: var(--glass-2);
    padding: 2px 6px;
    border-radius: 99px;
    line-height: 1;
    opacity: 0.85;
  }
  .nav button.active .nav-badge {
    background: var(--accent);
    color: #fff;
  }
  .tab-controls .btn.secondary.active { background: var(--accent-2); border-color: var(--accent); color: var(--white); }


  .nav button:hover .icon{ opacity:1; }

  .content{ 
    padding:6px;
    height: calc(100vh - 44px); /* Account for app padding */
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .search{
    flex:1; background:#ffffff17; border-radius:100px; padding:10px 14px; display:flex; align-items:center; gap:10px;
  }
  .search input{ all:unset; color:var(--ink); width:100%; font-size:14px; }
  .pill{ padding:8px 12px; border-radius:999px; background:#ffffff17; }
  .btn{ all:unset; padding:9px 14px; border-radius:12px; background:linear-gradient(135deg,#7db1ff,#4f89ff); color:#fff; font-weight:600; cursor:pointer; }
  .btn.secondary{ background:#ffffff1e; border:1px solid #ffffff26; }

  .panel{
    background: var(--panel-bg);
    border:1px solid var(--border-color); border-radius:22px; padding:24px; box-shadow: var(--shadow);
    backdrop-filter: blur(8px);
  }
  .panel-header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
  .panel-header svg { width:22px; height:22px; color:var(--accent); }
  .panel-title { font-weight:700; font-size:18px; }

  .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
  .g-12{ grid-column: span 12; }
  .g-6{ grid-column: span 6; }
  .g-4{ grid-column: span 4; }
  .g-3{ grid-column: span 3; }

  .h1{ font-size:32px; font-weight:900; letter-spacing:.2px; margin:6px 0 8px; }
  .muted{ color:var(--muted) }

  table{ width:100%; border-collapse:separate; border-spacing:0; }
  th, td{ text-align:left; padding:12px 14px; font-size:14px; }
  thead th{ position:sticky; top:0; background:#0e2e6df2; backdrop-filter: blur(6px); z-index:1; font-weight:600; color:var(--muted); }
  tbody tr{ transition: background .12s ease; }
  tbody tr:nth-child(even){ background: #ffffff0a; }
  td { border-bottom:1px solid #ffffff14; }
  tbody tr:last-child td { border-bottom: none; }
  .table-wrap{ overflow:auto; max-height:420px; }
  .chip{ padding:4px 8px; background:#ffffff20; border-radius:999px; font-size:12px; display:inline-block }
  .chip.success { background: var(--stat-2-bg); color: var(--stat-2-color); }
  .chip.danger { background: var(--stat-4-bg); color: var (--stat-4-color); }
  .chip.warning { background: var(--stat-3-bg); color: var (--stat-3-color); }


  /* Sections (SPA) */
  section.view{ display:none; }
  section.view.active{ 
    display: flex; /* Changed from block to flex */
    animation: fadeIn .18s ease;
    flex: 1;
    overflow: hidden;
    flex-direction: column;
  }
  
  /* Make panels fill available space */
  section.view .panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin-bottom: 0; /* Remove bottom margin to use full space */
  }
  
  /* Specific table containers should be scrollable */
  .table-wrap {
    flex: 1;
    overflow-y: auto;
    margin-top: 16px;
  }
  
  /* Dashboard grid adjustments */
  section.view .grid {
    flex: 1;
    overflow-y: auto;
  }
  
  /* Grid panels should maintain their size but allow content scrolling */
  .grid .panel {
    flex: none; /* Don't flex in grid layout */
    min-height: 200px; /* Minimum size for grid panels */
  }
  
  /* Content within grid panels should be scrollable if needed */
  .grid .panel .table-wrap {
    max-height: 400px; /* Reasonable max height for grid tables */
  }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(3px)} to{opacity:1; transform:none} }

  /* Auth overlay */
  .auth{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:24px; background: #071c44d0; backdrop-filter: blur(6px); z-index: 10;
  }
  .auth.show{ display:flex; }
  .card{ background:#0b2a64; border:1px solid #ffffff1f; border-radius:20px; box-shadow:var(--shadow); padding:22px; width:min(460px, 92vw); }
  .card h2{ margin:0 0 12px; }
  .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0; }
  .field input, .field textarea { all:unset; background:#ffffff17; border:1px solid #ffffff24; padding:12px 12px; border-radius:12px; }
  .field textarea { min-height: 60px; }
  .hint{ font-size:12px; color:#b9c9ff; opacity:.9 }
  /* Dark-select styling for Windows/Edge */
  .ui-select{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    background:#0b2a64; color:var(--ink);
    border:1px solid #ffffff24; border-radius:12px; padding:12px; width:100%;
  }
  .ui-select:focus{ outline:2px solid var(--accent); box-shadow:0 0 0 3px #76a7ff40; }
  .ui-select option{ background:#0b2a64; color:var(--ink); }
  .ui-select option:disabled{ color:#8aa0cf; }
  @media (forced-colors: active){
    .ui-select{ forced-color-adjust:none; background:Canvas; color:CanvasText; border-color:GrayText; }
    .ui-select option{ background:Canvas; color:CanvasText; }
  }
  .error{ color:var(--danger); font-size:12px; margin-top:6px; }

  .footer{ text-align:center; font-size:12px; color:#b7c8ff; opacity:.9; padding:22px 0; }

  /* Modal styles */
  .modal { 
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 30;
    background: rgba(7,28,68,0.85);
  }
  .modal.show { 
    display: flex; 
  }
  .modal-content { 
    background: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 18px;
    padding: 22px;
    box-shadow: var(--shadow);
    color: var(--white);
  }
  /* CRUD modal tweaks: keep buttons visible, make fields scrollable and more compact */
  #crud-modal .card {
    display: flex;
    flex-direction: column;
    max-height: 88vh; /* slightly taller but still limited */
    width: min(880px, 98vw); /* wider modal for more horizontal space */
    padding: 20px 22px;
  }
  #crud-modal form { display: flex; flex-direction: column; gap: 0; }
  #crud-fields {
  flex: 1 1 auto; /* let fields take remaining space */
  overflow-y: auto;
  padding-right: 8px; /* space for scrollbar */
  margin-bottom: 12px;
  /* Keep fields area within viewport so modal footer/buttons remain visible */
  max-height: calc(88vh - 140px); /* account for title and buttons */
  }
  /* Grid for form fields: single column on small screens, two balanced columns on wider */
  #crud-fields .crud-grid { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 16px 24px; 
    align-items: start;
  }
  @media (min-width: 760px) {
    #crud-fields .crud-grid { grid-template-columns: 1fr 1fr; }
    /* allow some fields to span full width when needed */
    #crud-fields .field.full { grid-column: 1 / -1; }
  }
  
  /* Standardize all field containers and inputs for perfect alignment */
  #crud-modal .field { 
    box-sizing: border-box; 
    display: flex; 
    flex-direction: column; 
  }
  
  #crud-modal .field label { 
    margin-bottom: 6px; 
    font-weight: 600; 
    font-size: 14px; 
    line-height: 1.3;
    min-height: 18px; /* consistent label height */
  }
  
  /* Standardize ALL input elements to same height and styling */
  #crud-modal .field input[type="text"],
  #crud-modal .field input[type="date"], 
  #crud-modal .field .ui-select,
  #crud-modal .field select {
    height: 44px;
    padding: 0 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text);
    font-size: 14px;
    box-sizing: border-box;
    line-height: 1.4;
  }
  
  /* Textareas get consistent styling but variable height */
  #crud-modal .field textarea { 
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text);
    font-size: 14px;
    box-sizing: border-box;
    resize: vertical;
    min-height: 88px;
    line-height: 1.4;
  }
  
  #crud-modal .field.full textarea { 
    min-height: 120px; 
  }
  
  /* Checkbox styling to align with other inputs */
  #crud-modal .field input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: 8px;
  }
  
  /* Multi-select and datepicker wrapper alignment */
  #crud-modal .datepicker-wrapper {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  #crud-modal .datepicker-wrapper input {
    flex: 1;
  }
  
  #crud-modal .multi-select-wrapper {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  #crud-modal .staff-chips {
    min-height: 44px;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }
  
  /* File upload styling */
  .file-upload-area {
    transition: all 0.3s ease;
  }
  
  .file-upload-area:hover {
    opacity: 0.9;
  }
  
  .file-upload-area button {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: var(--white);
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(118, 167, 255, 0.3);
  }
  
  .file-upload-area button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(118, 167, 255, 0.4);
  }
  
  .file-upload-area button span {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  /* Modern form enhancements */
  .datepicker-wrapper { display: flex; gap: 8px; align-items: center; }
  .modern-datepicker { flex: 1; }
  .quick-date { 
    height: 44px !important; 
    padding: 0 12px !important; 
    font-size: 14px; 
    white-space: nowrap; 
    border-radius: 8px !important;
    line-height: 1.4;
  }
  
  .age-select { font-weight: 500; }
  
  .multi-select-wrapper { display: flex; flex-direction: column; gap: 8px; }
  .staff-chips { display: flex; flex-wrap: wrap; gap: 6px; min-height: 24px; }
  .staff-chip { 
    background: var(--accent); 
    color: white; 
    padding: 6px 10px; 
    border-radius: 12px; 
    font-size: 12px; 
    display: flex; 
    align-items: center; 
    gap: 4px;
  }
  .staff-chip button { 
    background: none; 
    border: none; 
    color: white; 
    cursor: pointer; 
    padding: 0; 
    margin-left: 4px;
  }
  
  .category-select, .status-select, .priority-select, .avenue-select {
    font-weight: 500;
  }
  
  .category-select option[data-color]:not([value=""]) { font-weight: 600; }
  .status-select option[data-color]:not([value=""]) { font-weight: 600; }
  .priority-select option[data-color]:not([value=""]) { font-weight: 600; }
  
  /* Enhanced field labels with better spacing and icons */
  #crud-modal .field label { 
    font-weight: 600; 
    font-size: 13px; 
    margin-bottom: 4px;
    display: block;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .modal-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }
  .modal-close {
    all: unset;
    cursor: pointer;
    background: #ffffff12;
    border-radius: 999px;
    width: 34px;
    height: 34px;
    display: grid;
    place-items: center;
  }

  /* Small screens */
  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    .sidebar{ position:sticky; top:0; z-index:2; }
    .g-4 { grid-column: span 12; }
  }
  @media (max-width: 600px){
    .stat-card { grid-column: span 12; }
  }

  /* Stat cards */
  .stat-card {
    display:flex; align-items:center; gap:16px;
    background: var(--glass); padding:16px; border-radius:16px;
    border: 1px solid var(--glass-2);
  }
  .stat-card .icon-wrap {
    width:48px; height:48px; border-radius:12px;
    display:grid; place-items:center; flex-shrink:0;
    background: var(--c); color: var(--i);
  }
  .stat-card .icon-wrap svg { width:24px; height:24px; }
  .stat-num { font-size:28px; font-weight:700; line-height:1.1; color:var(--white); }
  .stat-label { font-size:14px; color:var(--muted); }

  /* Weekly Calendar styles */
  .cal-day{ background:#ffffff0f; border:1px solid #ffffff1e; border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:8px; }
  .cal-day-header { display: flex; justify-content: space-between; align-items: baseline; }
  .cal-day-label { font-weight: 600; color: var(--white); }
  .cal-day-summary { font-size: 12px; color: var(--muted); }
  .cal-day-bar-bg { width: 100%; height: 8px; background: var(--glass-2); border-radius: 99px; overflow: hidden; }
  .cal-day-bar-fg { height: 100%; background: var(--success); width: 0%; border-radius: 99px; transition: width .4s ease; }
  .cal-day-bar-fg.danger { background: var(--danger); }
  .cal-day-metrics { display: flex; justify-content: space-between; font-size: 11px; }
  .cal-metric.success { color: var(--success); }
  .cal-metric.danger { color: var(--danger); }
  
  /* Row hover/selected across all tables */
  tbody tr:hover{ background:#ffffff12 !important; }
  tbody tr.selected{ background:#ffffff1e !important; }
  tbody[data-entity] tr{ cursor:pointer; }
  #subs-tbody tr { cursor: pointer; }


  /* Items view: full-height + sortable */
  /* Items view styles - now handled by general panel styles */
  #view-items .table-wrap{ flex:1; max-height:none; overflow:auto; }
  #view-items thead th.sortable{ cursor:pointer; user-select:none; }
  #view-items thead th .arrow{ font-size:11px; opacity:.9; margin-left:6px }

  /* Monthly Calendar Styles */
  #cal-grid { grid-auto-rows: 1fr; align-items: start; }
  .cal-cell {
    background: var(--glass);
    border: 1px solid var(--glass-2);
    border-radius: 12px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    font-size: 12px;
    transition: background .12s ease;

    /* Keep cells perfectly square regardless of content/viewport */
    aspect-ratio: 1 / 1;
    min-height: 0; /* allow grid to calculate height from width */
    overflow: hidden;
  }
  .cal-cell.is-clickable { cursor: pointer; }
  .cal-cell.is-clickable:hover { background: var(--glass-2); }
  .cal-cell.other-month { opacity: .4; background: transparent; border-color:transparent; pointer-events:none; }
  .cal-cell.is-today .cal-day-num {
    background: var(--accent);
    color: var(--white);
    font-weight: 700;
  }
  .cal-day-num {
    font-weight: 600;
    font-size: 14px;
    width: 26px; height: 26px;
    display: grid; place-items: center;
    border-radius: 999px;
    margin-bottom: 4px;
    transition: all .2s ease;
    flex-shrink: 0;
  }
  .cal-tasks {
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 11px;
    padding-right: 4px; /* for scrollbar */
  }
  /* Custom scrollbar for task list */
  .cal-tasks::-webkit-scrollbar { width: 4px; }
  .cal-tasks::-webkit-scrollbar-track { background: transparent; }
  .cal-tasks::-webkit-scrollbar-thumb { background: #ffffff33; border-radius: 4px; }

  .cal-task {
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cal-task-status {
    width: 18px; height: 18px;
    border-radius: 999px;
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: var(--white);
    background: var(--muted);
    opacity: .9;
    line-height: 1;
  }
  .cal-task-status.scheduled { background: var(--muted); color: var(--white); opacity: .85; }
  .cal-task-status.done { background: var(--success); color: var(--white); }
  .cal-task-status.missed { background: var(--danger); color: var(--white); }

  .freq-badge {
    font-size:10px;
    padding:2px 6px;
    border-radius:999px;
    background: rgba(255,255,255,0.06);
    color: var(--muted);
    margin-left: 8px;
    flex-shrink: 0;
  }
  .cal-legend { display:flex; gap:14px; align-items:center; color:var(--muted); font-size:12px; margin-bottom:12px; }
  .cal-legend .item { display:flex; gap:8px; align-items:center; }
  .cal-legend .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
  .cal-legend .dot.scheduled { background: var(--muted); opacity:.6 }
  .cal-legend .dot.done { background: var(--success) }
  .cal-legend .dot.missed { background: var(--danger) }
  
  /* Day modal */
  #day-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 30; background: rgba(7,28,68,0.85); }
  #day-modal.show { display: flex; }
  .day-modal-card { width: min(900px, 86vw); background: var(--panel-bg); border:1px solid var(--border-color); border-radius:18px; padding:22px; box-shadow: var(--shadow); color: var(--white); }
  .day-modal-close { all:unset; float:right; cursor:pointer; background:#ffffff12; border-radius:999px; width:34px; height:34px; display:grid; place-items:center; }
  /* Branding modal */
  #branding-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 31; background: rgba(7,28,68,0.85); }
  #branding-modal.show { display: flex; }
  .branding-card { width: min(700px, 92vw); background: var(--panel-bg); border:1px solid var(--border-color); border-radius:18px; padding:22px; box-shadow: var(--shadow); color: var(--white); }
  .branding-close { all:unset; float:right; cursor:pointer; background:#ffffff12; border-radius:999px; width:34px; height:34px; display:grid; place-items:center; }
  .branding-row { display:grid; grid-template-columns: 160px 1fr; gap:14px; align-items:center; margin:12px 0; }
  .branding-preview { width:160px; height:90px; border-radius:10px; background:#ffffff12; border:1px solid #ffffff22; display:grid; place-items:center; overflow:hidden; }
  .branding-preview img { max-width:100%; max-height:100%; object-fit:contain; }
  .branding-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
  .hint-mini { font-size: 12px; color: var(--muted); }
  
  #cal-view-switcher .btn.secondary.active {
    background: var(--accent-2);
    border-color: var(--accent);
    color: var(--white);
  }
  /* Pre-inspection View Styles */
  .progress-bar-bg { background: var(--glass-2); border-radius: 99px; height: 10px; overflow: hidden; }
  .progress-bar-fg { background: var(--success); height: 100%; width: 0%; border-radius: 99px; transition: width .4s ease; }
  
  /* Enhanced progress header with count display */
  .pir-progress-header {
  display: block;
    gap: 24px;
    align-items: center;
    margin-bottom: 24px;
    padding: 20px;
    background: var(--glass);
    border-radius: 16px;
    border: 1px solid var(--border-color);
  }
  
  .pir-progress-text {
    font-size: 28px;
    font-weight: 700;
    color: var(--white);
    text-align: center;
  }
  
  .pir-progress-label {
    font-size: 14px;
    color: var(--muted);
    margin-top: 4px;
    text-align: center;
  }

  /* Dedicated PIR progress panel that stretches full width */
  .pir-progress-panel { padding: 20px; border-radius: 16px; background: var(--panel-bg); border:1px solid var(--border-color); box-shadow: var(--shadow); margin-bottom: 24px; }
  .pir-progress-main { display:flex; flex-direction:column; gap:16px; }
  
  /* Enhanced full-width progress bar with clear outline and interactive effects */
  .progress-bar-container { 
    position: relative; 
    padding: 6px; 
    background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(0,0,0,0.05)); 
    border-radius: 999px; 
    border: 2px solid rgba(255,255,255,0.15);
    box-shadow: 
      0 4px 12px rgba(0,0,0,0.1),
      inset 0 1px 0 rgba(255,255,255,0.2),
      inset 0 -1px 0 rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .progress-bar-container:hover {
    transform: translateY(-1px);
    box-shadow: 
      0 6px 20px rgba(0,0,0,0.15),
      inset 0 1px 0 rgba(255,255,255,0.3),
      inset 0 -1px 0 rgba(0,0,0,0.15);
    border-color: rgba(255,255,255,0.25);
  }
  
  .progress-bar-bg { 
    background: linear-gradient(90deg, 
      rgba(220,53,69,0.2) 0%, 
      rgba(255,193,7,0.2) 50%, 
      rgba(16,185,129,0.2) 100%
    ); 
    border-radius: 999px; 
    height: 24px; 
    overflow: hidden; 
    position: relative;
  }
  
  .progress-bar-bg::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
      transparent 0%, 
      rgba(255,255,255,0.1) 20%, 
      rgba(255,255,255,0.2) 50%, 
      rgba(255,255,255,0.1) 80%, 
      transparent 100%
    );
    animation: shimmer 3s ease-in-out infinite;
    opacity: 0.7;
  }
  
  @keyframes shimmer {
    0%, 100% { transform: translateX(-100%); }
    50% { transform: translateX(200%); }
  }
  
  /* Enhanced gradient progress bar with animations */
  .progress-bar-fg { 
    background: linear-gradient(90deg,
      #dc3545 0%,
      #fd7e14 25%,
      #ffc107 50%,
      #28a745 75%,
      #10b981 100%
    ); 
    height: 100%; 
    width: 0%; 
    border-radius: 999px; 
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); 
    position: relative;
    overflow: hidden;
    box-shadow: 
      0 2px 8px rgba(0,0,0,0.2),
      inset 0 1px 0 rgba(255,255,255,0.3);
  }
  
  .progress-bar-fg::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
      transparent 0%, 
      rgba(255,255,255,0.4) 50%, 
      transparent 100%
    );
    transform: translateX(-100%);
    animation: progressGlow 2s ease-in-out infinite;
  }
  
  @keyframes progressGlow {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(300%); }
  }
  
  /* Progress milestones */
  .progress-milestones {
    position: absolute;
    top: -8px;
    left: 6px;
    right: 6px;
    height: 40px;
    pointer-events: none;
  }
  
  .milestone {
    position: absolute;
    width: 2px;
    height: 16px;
    background: rgba(255,255,255,0.4);
    border-radius: 1px;
    top: 50%;
    transform: translateY(-50%);
  }
  
  .milestone.quarter { left: 25%; }
  .milestone.half { left: 50%; background: rgba(255,255,255,0.6); height: 20px; }
  .milestone.three-quarter { left: 75%; }
  
  /* Progress state animations and effects */
  .progress-bar-container.progress-low {
    animation: progressPulse 2s ease-in-out infinite;
  }
  
  .progress-bar-container.progress-medium {
    border-color: rgba(255,193,7,0.4);
  }
  
  .progress-bar-container.progress-high {
    border-color: rgba(40,167,69,0.4);
  }
  
  .progress-bar-container.progress-complete {
    border-color: rgba(16,185,129,0.6);
    animation: progressCelebrate 3s ease-in-out infinite;
  }
  
  @keyframes progressPulse {
    0%, 100% { 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    50% { 
      box-shadow: 0 6px 20px rgba(220,53,69,0.3), inset 0 1px 0 rgba(255,255,255,0.3);
      border-color: rgba(220,53,69,0.4);
    }
  }
  
  @keyframes progressCelebrate {
    0%, 100% { 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    50% { 
      box-shadow: 0 8px 25px rgba(16,185,129,0.4), inset 0 1px 0 rgba(255,255,255,0.4);
      transform: translateY(-2px);
    }
  }
  
  @keyframes progressClick {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
  }
  
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }

  /* Standardized page headers with help icons */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
  }
  
  .page-title-wrapper {
  display: flex;
  align-items: center; /* align title and badge vertically */
    gap: 8px;
    position: relative;
  }
  
  .page-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--white);
    margin: 0;
    line-height: 1.2;
  }
  
  .help-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    transition: all 0.2s ease;
    margin-top: 2px;
    flex-shrink: 0;
  }
  
  .help-icon:hover {
    background: rgba(255,255,255,0.15);
    border-color: rgba(255,255,255,0.4);
    color: var(--white);
    transform: scale(1.1);
  }

  /* Page help badge: inline eye button placed just to the right of the page title */
  .page-header { position: relative; }

  .page-help-badge {
    display: inline-grid;
    place-items: center;
    margin-left: 10px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.06);
    color: var(--white);
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(2,6,23,0.35);
    transition: transform 0.12s ease, box-shadow 0.12s ease;
    flex-shrink: 0;
  }

  .page-help-badge:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 10px 24px rgba(2,6,23,0.4); }

  /* Variant for light panels (when --panel-bg is light) */
  .page-help-badge.light {
    background: linear-gradient(135deg, #fff, #f3f6fb);
    color: var(--ink);
    border-color: rgba(0,0,0,0.06);
    box-shadow: 0 6px 18px rgba(16,24,40,0.08);
  }
  
  /* Help modal styles */
  .help-modal {
    position: fixed;
    inset: 0;
    background: rgba(7,28,68,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
  }
  
  .help-modal.show {
    display: flex;
  }
  
  .help-modal-content {
  background: var(--panel-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 24px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  /* Use readable text color on the panel background */
  color: var(--ink);
  }
  
  .help-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .help-modal-title {
    font-size: 20px;
    font-weight: 700;
  color: var(--ink);
    margin: 0;
  }
  
  .help-modal-close {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: rgba(255,255,255,0.7);
    transition: all 0.2s ease;
  }
  
  .help-modal-close:hover {
    background: rgba(255,255,255,0.2);
    color: var(--white);
  }
  
  .help-modal-body {
    color: var(--ink);
    line-height: 1.6;
  }

  .pir-progress-stats { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .pir-progress-stats .large { font-size:18px; font-weight:800; color:var(--ink); }
  .pir-progress-stats .muted-small { font-size:12px; color:var(--muted); }

  /* Mini progress inside each email cell */
  .email-mini-bar-bg { width:80%; height:8px; background: rgba(0,0,0,0.06); border-radius:999px; overflow:hidden; }
  .email-mini-bar-fg { height:100%; width:0%; background: linear-gradient(90deg,#dc3545,#ffc107,#10b981); transition: width .5s ease; }

  /* Email status circles (compact row design) */
  .email-status-circles {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 8px;
  padding: 18px 16px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .email-circle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }
  
  .email-circle-item:hover {
    transform: translateY(-2px);
  }
  
  .email-circle {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 16px;
    color: white;
    position: relative;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  .email-circle::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    border-radius: 50%;
    transition: left 0.6s ease;
  }
  
  .email-circle-item:hover .email-circle::before {
    left: 100%;
  }
  
  .email-circle.ready {
    background: linear-gradient(135deg, #28a745, #20c997);
    box-shadow: 0 2px 12px rgba(40,167,69,0.4);
  }
  
  .email-circle.partial {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    box-shadow: 0 2px 12px rgba(255,193,7,0.4);
  }
  
  .email-circle.missing {
    background: linear-gradient(135deg, #6c757d, #495057);
    box-shadow: 0 2px 8px rgba(108,117,125,0.3);
  }
  
  .email-circle-count {
  font-size: 12px;
    font-weight: 600;
    color: var(--text-color);
    opacity: 0.8;
    transition: opacity 0.3s ease;
  }
  
  .email-circle-item:hover .email-circle-count {
    opacity: 1;
  }
  
  .email-circle-item.ready .email-circle-count {
    color: #28a745;
  }
  
  .email-circle-item.partial .email-circle-count {
    color: #fd7e14;
  }
  
  .email-circle-item.missing .email-circle-count {
    color: #6c757d;
  }

  /* Popover for email package summaries */
  .email-popover {
    position: absolute;
    min-width: 260px;
    max-width: 360px;
    background: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 12px 30px rgba(2,6,23,0.25);
    color: var(--ink);
    z-index: 1400;
    transform-origin: top right;
    animation: popIn .18s cubic-bezier(.2,.9,.2,1);
  }

  .email-popover .pop-list {
    max-height: 220px;
    overflow: auto;
    margin-top: 8px;
    padding-right: 6px;
  }

  @keyframes popIn {
    from { transform: scale(.92) translateY(-6px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
  }

  .email-popover h4 { margin: 0 0 8px; font-size: 14px; }
  .email-popover .pop-row { display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed rgba(0,0,0,0.04); }
  .email-popover .pop-row:last-child { border-bottom: none; }
  .email-popover .pop-actions { display:flex; gap:8px; margin-top:10px; justify-content:flex-end; }
  .email-popover .pill { padding:6px 10px; border-radius:12px; font-size:12px; }
  .email-popover .pill.ready { background: linear-gradient(90deg,#34d399,#10b981); color:white; }
  .email-popover .pill.partial { background: linear-gradient(90deg,#ffd580,#ffb020); color:#3b2f00; }
  .email-popover .pill.missing { background: #f1f5f9; color:var(--muted); border:1px solid var(--border-color); }

  .email-cell {
    padding: 10px;
    border-radius: 10px;
    text-align: center;
    font-weight: 700;
    font-size: 13px;
    border: 1px solid var(--border-color);
    background: var(--panel-bg);
    color: var(--muted);
    display:flex;
    flex-direction:column;
    gap:4px;
    align-items:center;
    justify-content:center;
  }

  .email-cell.ready {
    background: linear-gradient(180deg, #34d399, #10b981);
    color: white;
    border-color: rgba(16,185,129,0.25);
  }

  .email-cell.partial {
    background: linear-gradient(180deg, #ffd580, #ffb020);
    color: #3b2f00;
    border-color: rgba(255,176,32,0.16);
  }

  .email-cell.missing {
    background: var(--glass-2);
    color: var(--muted);
    border-style: dashed;
  }

  .email-cell .email-num { font-size: 12px; opacity: .9; }
  .email-cell .email-count { font-size: 14px; }
  
  /* Filter pills */
  .pir-filters {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .pir-filter-pill {
    padding: 8px 16px;
    border-radius: 20px;
    background: var(--glass);
    border: 1px solid var(--border-color);
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
  }
  
  .pir-filter-pill:hover {
    background: var(--glass-2);
    transform: translateY(-1px);
  }
  
  .pir-filter-pill.active {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent);
  }
  
  /* Sidebar TOC for categories */
  .pir-layout {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 24px;
    height: 100%;
    overflow: hidden;
  }
  
  .pir-toc {
    background: var(--glass);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    padding: 16px;
    overflow-y: auto;
    max-height: calc(100vh - 280px);
  }
  
  .pir-toc-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 12px;
    color: var(--white);
  }
  
  .pir-toc-item {
    display: block;
    padding: 8px 12px;
    margin: 2px 0;
    border-radius: 8px;
    color: var(--muted);
    text-decoration: none;
    font-size: 12px;
    transition: all 0.2s ease;
    cursor: pointer;
    line-height: 1.3;
  }
  
  .pir-toc-item:hover {
    background: var(--glass-2);
    color: var(--white);
  }
  
  .pir-toc-item.active {
    background: var(--accent);
    color: var(--white);
  }
  
  .pir-main {
    overflow-y: auto;
    max-height: calc(100vh - 280px);
  }
  
  /* Category sections with sticky headers */
  .doc-category {
    margin-bottom: 32px;
    scroll-margin-top: 70px;
  }
  
  .doc-category-title {
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 16px;
    font-weight: 700;
    color: var(--accent-2);
    background: var(--panel-bg);
    backdrop-filter: blur(8px);
    border-bottom: 2px solid var(--accent-2);
    padding: 12px 0 8px 0;
    margin-bottom: 16px;
  }
  
  /* Enhanced table rows with hover actions */
  .pir-table-row {
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
    background: var(--glass);
    overflow: hidden;
  }
  
  .pir-table-row:hover {
    border-color: var(--accent-2);
    box-shadow: 0 4px 12px rgba(118, 167, 255, 0.15);
    transform: translateY(-1px);
  }
  
  .pir-row-main {
    padding: 16px 20px;
    display: grid;
    /* checkbox column should be auto, title should take remaining space */
    grid-template-columns: auto 1fr auto auto auto auto;
    gap: 16px;
    align-items: center;
  }
  
  .pir-row-title {
    font-weight: 600;
    color: var(--white);
    font-size: 14px;
  }
  
  .pir-row-type {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }
  
  .pir-row-actions {
    display: flex;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  
  .pir-table-row:hover .pir-row-actions {
    opacity: 1;
  }
  
  .pir-action-btn {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 6px;
    background: var(--glass-2);
    border: 1px solid var(--border-color);
    color: var(--white);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .pir-action-btn:hover {
    background: var(--accent-2);
    border-color: var(--accent);
  }
  
  .pir-action-btn.primary {
    background: var(--accent);
    border-color: var(--accent);
  }
  
  /* Status chips with enhanced styling */
  .pir-status-chip {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .pir-status-chip.not-attached {
    background: var(--glass-2);
    color: var(--muted);
  }
  
  .pir-status-chip.uploaded {
    background: var(--stat-3-bg);
    color: var(--stat-3-color);
  }
  
  .pir-status-chip.ready {
    background: var(--stat-2-bg);
    color: var(--stat-2-color);
  }
  
  .pir-status-chip.outdated {
    background: #ff8c0033;
    color: #ff8c00;
  }
  
  .pir-status-chip.draft {
    background: #8b5cf633;
    color: #8b5cf6;
  }
  
  .pir-status-chip.expired {
    background: #dc354533;
    color: #dc3545;
    font-weight: 600;
    animation: pulse-warning 2s infinite;
  }
  
  .pir-status-chip.expiring-soon {
    background: #ffc10733;
    color: #ffc107;
    font-weight: 600;
  }

  @keyframes pulse-warning {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* Certificate tracking styles */
  .certificate-tracking {
    border-left: 4px solid var(--accent-2);
  }
  
  .certificate-tracking h4 {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }
  
  .enhanced-pir-modal .info-value.status-expired {
    color: #dc3545;
    font-weight: 600;
  }
  
  .enhanced-pir-modal .info-value.status-expiring-soon {
    color: #ffc107;
    font-weight: 600;
  }

  /* Enhanced PIR Modal Styles */
  .enhanced-pir-modal {
    backdrop-filter: blur(8px);
  }
  
  .enhanced-pir-content {
    width: min(95vw, 1200px);
    height: min(90vh, 800px);
    max-width: none;
    max-height: none;
    display: flex;
    flex-direction: column;
    background: var(--panel-bg);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  
  .enhanced-pir-header {
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(135deg, var(--panel-bg) 0%, var(--glass) 100%);
    border-radius: 16px 16px 0 0;
  }
  
  .enhanced-pir-header .header-main {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  
  .enhanced-pir-header h2 {
    margin: 0;
    font-size: 24px;
    color: var(--white);
    max-width: 70%;
  }
  
  .enhanced-pir-header .header-meta {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .category-badge, .item-type-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .category-badge {
    background: var(--accent-2)33;
    color: var(--accent-2);
  }
  
  .item-type-badge {
    background: var(--muted)33;
    color: var(--muted);
  }
  
  .enhanced-pir-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  
  .enhanced-pir-sidebar {
    width: 300px;
    padding: 24px;
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    background: var(--glass);
  }
  
  .enhanced-info-section {
    margin-bottom: 32px;
  }
  
  .enhanced-info-section h4 {
    margin: 0 0 16px 0;
    font-size: 16px;
    color: var(--accent-2);
    font-weight: 600;
  }
  
  .enhanced-info-item {
    display: flex;
    flex-direction: column;
    margin-bottom: 16px;
  }
  
  .info-label {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 4px;
    font-weight: 500;
  }
  
  .info-value {
    font-size: 14px;
    color: var(--white);
    word-wrap: break-word;
  }
  
  .enhanced-actions-section h4 {
    margin: 0 0 16px 0;
    font-size: 16px;
    color: var(--accent-2);
    font-weight: 600;
  }
  
  .enhanced-action-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .enhanced-action-buttons .btn {
    justify-content: flex-start;
    gap: 8px;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
  }
  
  .enhanced-pir-preview {
    flex: 1;
    padding: 24px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .enhanced-preview-loading, 
  .enhanced-preview-error, 
  .enhanced-preview-empty,
  .enhanced-preview-unsupported {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 16px;
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--glass);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .error-icon, .empty-icon, .file-icon {
    font-size: 48px;
    opacity: 0.7;
  }
  
  .enhanced-preview-error h4,
  .enhanced-preview-empty h4,
  .enhanced-preview-unsupported h4 {
    margin: 0;
    color: var(--white);
    font-size: 18px;
  }
  
  .enhanced-preview-error p,
  .enhanced-preview-empty p,
  .enhanced-preview-unsupported p {
    margin: 0;
    color: var(--muted);
    font-size: 14px;
    line-height: 1.5;
  }
  
  .enhanced-pdf-preview,
  .enhanced-image-preview {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .enhanced-pir-footer {
    padding: 20px 24px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    background: var(--glass);
    border-radius: 0 0 16px 16px;
  }
  
  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .enhanced-pir-content {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
    }
    
    .enhanced-pir-body {
      flex-direction: column;
    }
    
    .enhanced-pir-sidebar {
      width: auto;
      border-right: none;
      border-bottom: 1px solid var(--border-color);
      max-height: 200px;
    }
  }
  
  /* Template buttons inline */
  .pir-template-btn {
    padding: 4px 8px;
    font-size: 11px;
    border-radius: 6px;
    background: linear-gradient(135deg, var(--accent-2), var(--accent));
    border: none;
    color: var(--white);
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0;
  }
  
  .pir-table-row:hover .pir-template-btn {
    opacity: 1;
  }
  
  .pir-template-btn:hover {
    transform: scale(1.05);
  }
  
  /* Bulk operations bar */
  .pir-bulk-bar {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 12px 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(12px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 20;
  }
  
  .pir-bulk-bar.visible {
    opacity: 1;
    visibility: visible;
  }
  
  .pir-bulk-count {
    font-weight: 600;
    color: var(--white);
  }
  
  /* Mobile responsive card layout */
  @media (max-width: 768px) {
    .pir-layout {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .pir-toc {
      display: none;
    }
    
    .pir-row-main {
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 16px;
    }
    
    .pir-row-actions {
      opacity: 1;
      justify-self: start;
    }
    
    .pir-table-row {
      padding: 0;
    }
  }
  
  /* Draft text support */
  .pir-draft-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--accent-2);
    margin-top: 4px;
  }
  
  .pir-draft-badge {
    background: var(--accent);
    color: var(--white);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
  }
  
  /* Notes indicator */
  .pir-notes-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--success);
    margin-top: 4px;
  }
  
  .pir-notes-badge {
    font-size: 12px;
  }
  
  .pir-action-btn.has-notes {
    background: var(--success-bg);
    border-color: var(--success);
    color: var(--success);
    font-weight: 600;
  }
  
  /* PIR Notes Modal */
  .pir-notes-modal .modal-content {
    max-width: 600px;
    width: 90%;
  }
  
  .pir-notes-modal textarea {
    min-height: 200px;
    resize: vertical;
    font-family: inherit;
  }
  
  .pir-notes-modal .btn.success {
    background-color: var(--success);
    border-color: var(--success);
    color: var(--white);
  }
  
  .pir-notes-modal .btn.error {
    background-color: var(--error);
    border-color: var(--error);
    color: var(--white);
  }
  
  /* Column sorting */
  .pir-sort-header {
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 0;
    font-weight: 600;
  }
  
  .pir-sort-header:hover {
    color: var(--accent-2);
  }
  
  .pir-sort-arrow {
    font-size: 10px;
    opacity: 0.6;
    transition: all 0.2s ease;
  }
  
  .pir-sort-header.active .pir-sort-arrow {
    opacity: 1;
    color: var(--accent);
  }
  
  /* Enhanced PIR Modal Styles */
  .enhanced-pir-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
    animation: modalFadeIn 0.3s ease-out;
  }
  
  .enhanced-pir-modal.show {
    display: flex;
  }
  
  .enhanced-pir-content {
    background: var(--panel-bg);
    border-radius: 16px;
    width: 95vw;
    height: 90vh;
    max-width: 1400px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--border-color);
    animation: modalSlideIn 0.3s ease-out;
  }
  
  .enhanced-pir-header {
    padding: 24px 32px;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(135deg, var(--glass) 0%, var(--panel-bg) 100%);
  }
  
  .enhanced-pir-header .header-main {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 12px;
  }
  
  .enhanced-pir-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--white);
    flex: 1;
  }
  
  .enhanced-pir-header .header-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .category-badge {
    background: var(--accent);
    color: var(--panel-bg);
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .item-type-badge {
    background: var(--glass);
    color: var(--white);
    border: 1px solid var(--border-color);
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .enhanced-pir-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  
  .enhanced-pir-sidebar {
    width: 300px;
    background: var(--glass);
    border-right: 1px solid var(--border-color);
    padding: 24px;
    overflow-y: auto;
    flex-shrink: 0;
  }
  
  .enhanced-info-section,
  .enhanced-actions-section,
  .enhanced-notes-section {
    margin-bottom: 32px;
  }
  
  .enhanced-info-section h4,
  .enhanced-actions-section h4,
  .enhanced-notes-section h4 {
    margin: 0 0 16px 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--white);
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .enhanced-notes-display {
    background: var(--glass);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
  }
  
  .enhanced-notes-display .notes-content {
    color: var(--white);
    font-size: 0.875rem;
    line-height: 1.5;
    margin-bottom: 16px;
    white-space: pre-wrap;
  }
  
  .enhanced-notes-empty {
    padding: 16px;
    text-align: center;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    background: var(--glass);
  }
  
  .enhanced-notes-empty p {
    margin: 0 0 12px 0;
    font-style: italic;
  }
  
  .btn.small {
    padding: 6px 12px;
    font-size: 0.75rem;
  }
  
  .enhanced-info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 16px;
  }
  
  .info-label {
    font-size: 0.75rem;
    color: var(--muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .info-value {
    font-size: 0.875rem;
    color: var(--white);
    word-break: break-word;
  }
  
  .info-value.status-ready { color: var(--success); }
  .info-value.status-warning { color: var(--warning); }
  .info-value.status-danger { color: var(--danger); }
  
  .enhanced-action-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .enhanced-action-buttons .btn {
    justify-content: flex-start;
    gap: 8px;
  }
  
  .enhanced-pir-preview {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    background: var(--panel-bg);
  }
  
  .enhanced-pdf-preview {
    height: 100%;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
  }
  
  .enhanced-image-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    background: var(--glass);
    border-radius: 8px;
    padding: 20px;
  }
  
  .enhanced-preview-loading,
  .enhanced-preview-error,
  .enhanced-preview-empty,
  .enhanced-preview-unsupported {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 40px;
    color: var(--muted);
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
  }
  
  .error-icon,
  .empty-icon,
  .file-icon {
    font-size: 3rem;
    margin-bottom: 16px;
  }
  
  .enhanced-preview-error h4,
  .enhanced-preview-empty h4,
  .enhanced-preview-unsupported h4 {
    color: var(--white);
    margin: 0 0 12px 0;
    font-size: 1.25rem;
    font-weight: 600;
  }
  
  .enhanced-preview-error p,
  .enhanced-preview-empty p,
  .enhanced-preview-unsupported p {
    margin: 0 0 8px 0;
    line-height: 1.5;
  }
  
  .enhanced-pir-footer {
    padding: 20px 32px;
    border-top: 1px solid var(--border-color);
    background: var(--glass);
    display: flex;
    justify-content: flex-end;
  }
  
  @keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes modalSlideIn {
    from { 
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to { 
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Responsive design for smaller screens */
  @media (max-width: 1024px) {
    .enhanced-pir-content {
      width: 98vw;
      height: 95vh;
    }
    
    .enhanced-pir-body {
      flex-direction: column;
    }
    
    .enhanced-pir-sidebar {
      width: 100%;
      max-height: 200px;
      border-right: none;
      border-bottom: 1px solid var(--border-color);
    }
    
    .enhanced-info-section,
    .enhanced-actions-section {
      margin-bottom: 16px;
    }
    
    .enhanced-info-item {
      margin-bottom: 8px;
    }
  }

  /* PDF preview modal enhancements */
  .pir-preview-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
    backdrop-filter: blur(4px);
  }
  
  .pir-preview-modal.show {
    display: flex;
  }
  
  .pir-preview-content {
    background: var(--panel-bg);
    border-radius: 16px;
    width: 90vw;
    height: 90vh;
    max-width: 1200px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .pir-preview-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .pir-preview-body {
    flex: 1;
    overflow: auto;
    padding: 0;
  }
  
  .pir-preview-close {
    background: var(--glass);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--white);
    cursor: pointer;
  }
  
  #pir-tbody tr { cursor: pointer; }

  /* Pre‑Inspection panel should fill viewport and allow inner scrolling */
  #view-pre-inspection .panel {
    min-height: calc(100vh - 190px);
    display: flex;
    flex-direction: column;
  }
  /* Make the documents container the scrollable area */
  #view-pre-inspection #pir-docs-container {
    flex: 1 1 auto;
    overflow-y: auto;
    max-height: none;            /* override .table-wrap default 420px cap */
    -webkit-overflow-scrolling: touch; /* iOS/Safari momentum scroll */
    overscroll-behavior: contain;      /* prevent scroll chaining */
  }

  /* Dynamic & Multi-Input Form Styles */
  .multi-input-container { display: flex; gap: 12px; align-items: flex-start; }
  .multi-input-container .field { flex: 1; margin-top: 0; }
  .dynamic-table-row { display: flex; gap: 8px; align-items: center; }
  .dynamic-table-row input { flex: 1; }

  /* Training Matrix Styles - Enhanced */
  .training-matrix {
    overflow: hidden;
    background: var(--panel-bg);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    position: relative;
    height: 600px;
    display: flex;
    flex-direction: column;
  }

  /* Training controls and search */
  .training-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    background: var(--panel-bg);
    flex-wrap: wrap;
  }

  .training-search {
    flex: 1;
    min-width: 200px;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--glass);
    font-size: 14px;
  }

  .training-filters {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .filter-pill {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    background: var(--glass);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .filter-pill:hover {
    background: var(--glass-2);
  }

  .filter-pill.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .density-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--muted);
  }

  .density-switch {
    width: 40px;
    height: 20px;
    background: var(--glass);
    border-radius: 10px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .density-switch.active {
    background: var(--primary);
  }

  .density-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s ease;
  }

  .density-switch.active::after {
    transform: translateX(20px);
  }

  /* Legend moved to top right */
  .training-legend {
    position: absolute;
    top: 16px;
    right: 16px;
    display: flex;
    gap: 16px;
    font-size: 11px;
    color: var(--muted);
    background: var(--panel-bg);
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    z-index: 5;
  }

  .training-legend .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .training-legend .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 2px;
  }

  /* Scrollable container */
  .training-matrix-scroll {
    flex: 1;
    overflow: auto;
    position: relative;
  }

  .training-matrix table {
    min-width: 800px;
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
  }

  .training-matrix th {
    background: var(--panel-bg);
    position: sticky;
    top: 0;
    z-index: 2;
    writing-mode: vertical-lr;
    text-orientation: mixed;
    width: 120px;
    max-width: 120px;
    padding: 16px 8px;
    font-size: 12px;
    border-right: 1px solid var(--border-color);
    border-bottom: 2px solid var(--border-color);
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .training-matrix th:hover {
    background: var(--glass-2);
  }

  .training-matrix th.sortable::after {
    content: '↕';
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    opacity: 0.5;
  }

  .training-matrix th.sort-asc::after {
    content: '↑';
    opacity: 1;
  }

  .training-matrix th.sort-desc::after {
    content: '↓';
    opacity: 1;
  }

  .training-matrix th:first-child {
    writing-mode: horizontal-tb;
    text-orientation: initial;
    width: 200px;
    max-width: 200px;
    position: sticky;
    left: 0;
    z-index: 3;
    background: var(--panel-bg);
    box-shadow: 2px 0 4px rgba(0,0,0,0.1);
  }

  .training-matrix td {
    padding: 12px 8px;
    border-right: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    font-size: 11px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 48px;
    position: relative;
  }

  .training-matrix.compact td {
    padding: 8px 6px;
    min-height: 36px;
    font-size: 10px;
  }

  .training-matrix td:first-child {
    position: sticky;
    left: 0;
    background: var(--panel-bg);
    z-index: 1;
    cursor: default;
    font-weight: 600;
    text-align: left;
    padding-left: 16px;
    box-shadow: 2px 0 4px rgba(0,0,0,0.1);
  }

  .training-matrix td.training-cell {
    border-radius: 6px;
    margin: 2px;
    border: none;
  }

  .training-matrix td.training-cell:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  /* Status chips with enhanced styling */
  .training-completed { 
    background: var(--stat-2-bg); 
    color: var(--stat-2-color);
  }
  .training-expiring { 
    background: var(--stat-3-bg); 
    color: var(--stat-3-color);
  }
  .training-expired { 
    background: var(--stat-4-bg); 
    color: var(--stat-4-color);
  }
  .training-missing { 
    background: var(--glass); 
    color: var(--muted); 
    opacity: 0.6;
  }

  /* Tooltip */
  .training-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }

  .training-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-top-color: rgba(0,0,0,0.9);
  }

  .training-cell:hover .training-tooltip {
    opacity: 1;
  }

  /* Cell details drawer */
  .cell-drawer {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: var(--panel-bg);
    border-left: 1px solid var(--border-color);
    box-shadow: -4px 0 20px rgba(0,0,0,0.1);
    z-index: 1000;
    transition: right 0.3s ease;
    overflow-y: auto;
  }

  .cell-drawer.open {
    right: 0;
  }

  .cell-drawer-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .cell-drawer-content {
    padding: 20px;
  }

  .cell-drawer .field {
    margin-bottom: 16px;
  }

  .cell-drawer .field label {
    display: block;
    font-weight: 600;
    margin-bottom: 4px;
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
  }

  .cell-drawer .field-value {
    padding: 8px 0;
    font-size: 14px;
  }

  .cell-drawer-actions {
    padding: 20px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .cell-drawer-actions .btn {
    flex: 1;
    min-width: 120px;
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .training-controls {
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
    }

    .training-filters {
      flex-wrap: wrap;
    }

    .training-legend {
      position: static;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .training-matrix {
      height: auto;
      min-height: 400px;
    }

    .training-matrix th:first-child {
      width: 140px;
      max-width: 140px;
    }

    .training-matrix th {
      width: 80px;
      max-width: 80px;
      font-size: 10px;
      padding: 12px 4px;
    }

    .training-matrix td {
      padding: 8px 4px;
      font-size: 10px;
    }

    .cell-drawer {
      width: 100%;
      right: -100%;
    }

    .cell-drawer.open {
      right: 0;
    }

    .cell-drawer-actions {
      flex-direction: column;
    }

    .cell-drawer-actions .btn {
      flex: none;
    }
  }

  /* Print styles */
  @media print {
    .training-controls,
    .cell-drawer,
    .training-legend {
      display: none !important;
    }

    .training-matrix {
      height: auto !important;
      overflow: visible !important;
    }

    .training-matrix-scroll {
      overflow: visible !important;
    }
  }
  
  /* Training Status Colors */
  .training-completed { background: var(--stat-2-bg); color: var(--stat-2-color); }
  .training-expiring { background: var(--stat-3-bg); color: var(--stat-3-color); }
  .training-expired { background: var(--stat-4-bg); color: var(--stat-4-color); }
  .training-missing { background: var(--glass); color: var(--muted); opacity: 0.6; }
  
  /* Training Modal */
  .training-modal .modal-content {
    width: min(600px, 90vw);
    max-height: 90vh;
    overflow-y: auto;
  }
  
  /* Training Types Management Modal */
  .training-types-modal .modal-content {
    width: min(800px, 95vw);
    max-height: 90vh;
    overflow-y: auto;
  }
  .training-type-row {
    display: grid;
    grid-template-columns: 2fr 1fr 80px 80px 80px 100px;
    gap: 12px;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
  }
  .training-type-row:last-child {
    border-bottom: none;
  }
  .training-type-row input, .training-type-row select {
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: var(--glass);
    color: var(--white);
    font-size: 12px;
  }
  .training-type-row button {
    padding: 4px 8px;
    font-size: 11px;
  }
  
  .training-upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: var(--glass);
  }
  .training-upload-zone:hover {
    border-color: var(--accent);
    background: var(--glass-2);
  }
  .training-upload-zone.dragover {
    border-color: var(--accent);
    background: var(--accent-2);
  }
</style>


<style>
  /* Toggle Switch Styles */
  .toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    background: var(--glass-2);
    border-radius: 24px;
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .toggle-switch:hover {
    background: var(--glass);
  }

  .toggle-slider {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 18px;
    height: 18px;
    background: var(--white);
    border-radius: 50%;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .toggle-switch input:checked + .toggle-slider {
    transform: translateX(20px);
    background: var(--accent);
  }

  .toggle-switch input:checked ~ .toggle-switch {
    background: var(--accent-2);
  }
</style>

<style id="stellar-light-theme">
  :root{ --bg-page:#f3f5f9; --panel-bg:#ffffff; --border-color:#e9edf5; --ink:#1f2937; --white:#111827; --muted:#667085; --accent:#a467ff; --accent-2:#658ae3; --mint:#01cabd; --success:#41d656; --warning:#fc6a24; --danger:#ef5463; --round:16px; --shadow-sm:0 1px 2px rgba(16,24,40,.06); --shadow-md:0 2px 6px rgba(16,24,40,.06), 0 12px 24px rgba(16,24,40,.04); }
  body{ background:var(--bg-page) !important; color:var(--ink); font-family:'Urbanist', Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  .bg{ position:fixed; inset:0; z-index:-1; background:var(--bg-page) !important; }
  .wave,.wave2{ display:none !important; }
  .sidebar{ background:var(--panel-bg) !important; border:1px solid var(--border-color) !important; border-radius:18px !important; box-shadow:0 2px 6px rgba(16,24,40,.06),0 12px 24px rgba(16,24,40,.04) !important; }
  .brand .t{ color:var(--white) !important; } .brand .hint{ color:var(--muted) !important; }
  .brand .logo{ box-shadow:none !important; border-radius:12px !important; border:1px solid var(--border-color) !important; background:#fff !important; }
  .nav button{ color:#475467 !important; background:transparent !important; border:1px solid transparent !important; border-radius:12px !important; padding:10px 12px !important; }
  .nav button:hover{ background:#f6f7fb !important; border-color:#f0f2f7 !important; transform:none !important; }
  .nav .icon{ width:18px; height:18px; color:#667085 !important; filter:none !important; opacity:1 !important; }
  .nav .nav-badge{ background:#eef2ff !important; color:#667085 !important; }
  .nav button.active{ background:#f5f1ff !important; border-color:#e8e1ff !important; color:#3a2b6d !important; box-shadow: inset 0 0 0 1px #e8e1ff !important; font-weight:600 !important; }
  .nav button.active .icon{ color:var(--accent) !important; }
  .btn{ background:#fff !important; border:1px solid #e7eaf3 !important; color:#344054 !important; box-shadow:0 1px 2px rgba(16,24,40,.06) !important; }
  .btn:hover{ background:#f8faff !important; }
  .btn.secondary{ background:#fff !important; border:1px solid var(--border-color) !important; color:#475467 !important; }
  .tab-controls .btn.secondary.active{ background:#f5f1ff !important; border-color:#e8e1ff !important; color:#3a2b6d !important; }
  .panel{ background:#fff !important; border:1px solid var(--border-color) !important; border-radius:16px !important; box-shadow:0 2px 6px rgba(16,24,40,.06),0 12px 24px rgba(16,24,40,.04) !important; }
  .panel-header svg{ color:#98a2b3 !important; }
  .panel-title{ color:var(--white) !important; }
  thead th{ background:#fafbff !important; color:#667085 !important; border-bottom:1px solid var(--border-color) !important; }
  tbody tr:nth-child(even){ background:#fcfcfd !important; }
  td{ border-bottom:1px solid var(--border-color) !important; }
  tbody tr:hover{ background:#f3f6ff !important; }
  tbody tr.selected{ background:#ebe9ff !important; }
  .chip{ background:#f4f6fb !important; color:#475467 !important; }
  .chip.success{ background:#eafaf1 !important; color:#037a48 !important; }
  .chip.danger{ background:#ffe9ec !important; color:#b42318 !important; }
  .chip.warning{ background:#fff3e6 !important; color:#9a5606 !important; }
  .cal-day{ background:#fff !important; border:1px solid var(--border-color) !important; box-shadow:0 1px 2px rgba(16,24,40,.06) !important; }
  .cal-day-label{ color:#111827 !important; } .cal-day-summary{ color:#667085 !important; }
  .cal-day-bar-bg{ background:#eef2f6 !important; }
  .cal-day-bar-fg{ background: linear-gradient(90deg, var(--mint), var(--success)) !important; }
  .cal-day-bar-fg.danger{ background: linear-gradient(90deg, #ffd3bf, var(--warning)) !important; }
  .cal-metric.success{ color:var(--success) !important; } .cal-metric.danger{ color:var(--warning) !important; }
  .card, .modal-content, .branding-card, .day-modal-card{ background:#fff !important; border:1px solid var(--border-color) !important; box-shadow:0 2px 6px rgba(16,24,40,.06),0 12px 24px rgba(16,24,40,.04) !important; }
  .auth, .modal{ background: rgba(15,23,42,.35) !important; }
  .field input, .field textarea{ background:#fff !important; border:1px solid var(--border-color) !important; color:var(--ink) !important; }
  .ui-select{ background:#fff !important; border:1px solid var(--border-color) !important; color:var(--ink) !important; }
  .cal-cell{ background:#fff !important; border:1px solid var(--border-color) !important; }
  .cal-day-num{ background:#f0f2f8 !important; color:#111827 !important; }
  .cal-cell.is-today .cal-day-num{ background:var(--accent) !important; color:#fff !important; }
  .cal-task-status.scheduled{ background:#e6eaf2 !important; color:#475467 !important; }
  .cal-task-status.done{ background:#eafaf1 !important; color:#037a48 !important; }
  .cal-task-status.missed{ background:#ffe9ec !important; color:#b42318 !important; }
  .training-matrix{ background:#fff !important; border:1px solid var(--border-color) !important; }
  .training-matrix th, .training-matrix td{ border-color:var(--border-color) !important; }
  .training-completed{ background:#eafaf1 !important; color:#027a48 !important; }
  .training-expiring{ background:#fff3e6 !important; color:#9a5606 !important; }
  .training-expired{ background:#ffe9ec !important; color:#b42318 !important; }
  .training-missing{ background:#f4f6fb !important; color:#667085 !important; }
  .footer{ color:#98a2b3 !important; }
</style>

<style id="stellar-light-color-boost">
  /* Add pastel card tints and vivid accents (no markup changes) */

  /* Week calendar panel gets a gentle purple/blue wash */
  #view-dashboard #week-calendar{
    background: linear-gradient(180deg,#f5f1ff 0%, #eef3ff 100%) !important;
    border-color:#e8e1ff !important;
  }
  /* Week calendar panel gets a gentle purple/blue wash */
  #view-dashboard #week-calendar{
    background: linear-gradient(180deg,#f5f1ff 0%, #eef3ff 100%) !important;
    border-color:#e8e1ff !important;
  }

  /* Cycle soft colors across the seven day cards */
  #week-grid .cal-day{ box-shadow: var(--shadow-sm); }
  #week-grid .cal-day:nth-child(1){ background:#f5f1ff !important; border-color:#e8e1ff !important; }
  #week-grid .cal-day:nth-child(1) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--accent), var(--accent-2)) !important; }

  #week-grid .cal-day:nth-child(2){ background:#eefdff !important; border-color:#d9f5ff !important; }
  #week-grid .cal-day:nth-child(2) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--mint), #7de9d0) !important; }

  #week-grid .cal-day:nth-child(3){ background:#fff5ec !important; border-color:#ffe5d3 !important; }
  #week-grid .cal-day:nth-child(3) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--warning), #ffd59c) !important; }

  #week-grid .cal-day:nth-child(4){ background:#eefcf5 !important; border-color:#d6f5e8 !important; }
  #week-grid .cal-day:nth-child(4) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--success), var(--mint)) !important; }

  #week-grid .cal-day:nth-child(5){ background:#f4f8ff !important; border-color:#e1ecff !important; }
  #week-grid .cal-day:nth-child(5) .cal-day-bar-fg{ background: linear-gradient(90deg, #6aa8ff, var(--accent-2)) !important; }

  #week-grid .cal-day:nth-child(6){ background:#fff0f4 !important; border-color:#ffd7e3 !important; }
  #week-grid .cal-day:nth-child(6) .cal-day-bar-fg{ background: linear-gradient(90deg, #ef5463, #fc6a24) !important; }

  #week-grid .cal-day:nth-child(7){ background:#eef7ff !important; border-color:#dceaff !important; }
  #week-grid .cal-day:nth-child(7) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--accent-2), var(--accent)) !important; }

  /* Give the other two dashboard panels a subtle tint so the page isn't all-white */
  #view-dashboard .grid > .panel:nth-of-type(2){
    background: linear-gradient(180deg,#ffffff 0%, #f7fbff 100%) !important;
  }
  #view-dashboard .grid > .panel:nth-of-type(3){
    background: linear-gradient(180deg,#ffffff 0%, #f8f6ff 100%) !important;
  }

  /* Table header & hover colors a bit brighter for the light UI */
  #view-dashboard thead th{ background:#f6f8ff !important; border-bottom-color:#e7ecf5 !important; }
  #view-dashboard tbody tr:hover{ background:#edf2ff !important; }

  /* Active nav item with a soft purple glow so the menu feels alive */
  .nav button.active{ box-shadow: 0 8px 24px rgba(164,103,255,.18) !important; }
</style>

<style id="stellar-light-delight">
  :root{
    --radius-xl:20px;
    --border-soft:#eef1f8;
  }

  /* Subtle animated pastel blobs in the background */
  .bg::before, .bg::after { 
    content:""; position:absolute; pointer-events:none; z-index:0; 
    width:55vmax; height:55vmax; border-radius:50%; filter: blur(45px); opacity:.55;
    animation: floaty 24s ease-in-out infinite alternate;
  }
  .bg::before { left:-10vmax; top:-10vmax; background: radial-gradient(closest-side, #a467ff2b, transparent 70%); }
  .bg::after  { right:-8vmax; bottom:-12vmax; background: radial-gradient(closest-side, #01cabd26, transparent 70%); animation-duration: 28s; }
  @keyframes floaty { from { transform: translateY(-8px) } to { transform: translateY(12px) } }

  /* Gradient borders + gentle sheen on panels */
  .panel{ 
    position: relative;
    background: #fff !important; 
    border:1px solid transparent !important; 
    background: linear-gradient(#fff,#fff) padding-box, linear-gradient(180deg,#ecf1ff,#f9ecff) border-box !important;
    box-shadow: var(--shadow-md) !important;
  }
  /* Tint the two lower dashboard panels differently so the page isn't all white */
  #view-dashboard .grid > .panel:nth-of-type(2){
    background: linear-gradient(#fff,#fff) padding-box, linear-gradient(180deg,#ecf7ff,#f2ecff) border-box !important;
  }
  #view-dashboard .grid > .panel:nth-of-type(3){
    background: linear-gradient(#fff,#fff) padding-box, linear-gradient(180deg,#fdf5ee,#eefaf3) border-box !important;
  }
  .panel:hover::after{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background: linear-gradient(120deg, transparent 30%, #ffffff80 50%, transparent 70%);
    transform: translateX(-120%);
    animation: sheen 1.2s ease forwards;
  }
  @keyframes sheen { to { transform: translateX(120%);} }

  /* Icon chips in panel headers */
  .panel-header svg{
    padding:8px; border-radius:12px; 
    background: linear-gradient(180deg,#f5f1ff,#edf0ff);
    box-shadow: 0 6px 24px rgba(164,103,255,.15), inset 0 0 0 1px #eae6ff;
  }
  #week-calendar .panel-header svg{ background: linear-gradient(180deg,#f5f1ff,#eef3ff); }
  #view-dashboard .grid > .panel:nth-of-type(2) .panel-header svg{ background: linear-gradient(180deg,#eefcf5,#e8fff9); }
  #view-dashboard .grid > .panel:nth-of-type(3) .panel-header svg{ background: linear-gradient(180deg,#fff0f4,#fff7ef); }

  /* Sidebar icons as soft tiles; active gets a purple glow */
  .nav .icon{ padding:6px; border-radius:10px; background:#f1f2f7; box-shadow: inset 0 0 0 1px var(--border-color), 0 4px 10px rgba(17,24,39,.05); }
  .nav button.active .icon{ background: linear-gradient(180deg,#f5f1ff,#e9e2ff); box-shadow: inset 0 0 0 1px #e1d7ff, 0 8px 18px rgba(164,103,255,.25); }

  /* Progress bars get animated stripes for a lively feel */
  .cal-day-bar-fg{ position:relative; overflow:hidden; box-shadow: 0 0 0 1px #fff inset, 0 6px 14px rgba(16,24,40,.07); }
  .cal-day-bar-fg::after{ content:""; position:absolute; inset:0; background: repeating-linear-gradient(45deg, #ffffff40 0 8px, #ffffff00 8px 16px); transform: translateX(-100%); animation: slide-stripes 2s linear infinite; }
  @keyframes slide-stripes{ to { transform: translateX(100%);} }

  /* Table rows: brighter hover with a colored edge */
  #view-dashboard tbody tr:hover{ background:#f7f9ff !important; box-shadow: inset 3px 0 0 #a467ff; }

  /* Calendar cards lift on hover */
  #week-grid .cal-day{ transition: transform .18s ease, box-shadow .18s ease; }
  #week-grid .cal-day:hover{ transform: translateY(-2px); box-shadow: 0 10px 24px rgba(16,24,40,.08); }
</style>

<style id="layout-scrollless">
  /* Adjusted: allow page scrolling while keeping inner scroll containers functional */
  html, body { height: 100%; overflow: auto !important; }
  body { overscroll-behavior: auto; }
  .app { min-height: 100vh; height: auto; overflow: visible; }

  /* Sidebar: full-height with its own scroll */
  .sidebar{ position: sticky; top: 22px; height: calc(100vh - 44px); max-height: calc(100vh - 44px); overflow-y: auto; overscroll-behavior: contain; }
  .app.collapsed #sidebar{ height: calc(100vh - 44px); max-height: calc(100vh - 44px); overflow-y: auto; }

  /* Main content: allow natural page scroll; inner views still manage their own scrolling */
  .content{ height: auto; overflow: visible; display:flex; flex-direction:column; }
  section.view{ min-height: 0; }
  section.view.active{ flex: 1 1 auto; overflow: visible; display:flex; flex-direction:column; }

  /* Panels are flex columns so inner pieces can scroll */
  section.view .panel{ flex: 1 1 auto; display:flex; flex-direction:column; overflow: visible; min-height: 0; }
  .panel .table-wrap{ flex: 1 1 auto; overflow: auto; min-height: 0; }

  /* Grids inside views become the scroll container, not the page */
  section.view .grid{ flex: 1 1 auto; overflow: auto; min-height: 0; }
  .grid .panel{ flex: 0 0 auto; min-height: 240px; }

  /* Calendar view: allow the month grid to scroll inside the panel */
  #view-calendar .panel{ display:flex; flex-direction:column; }
  #cal-grid{ min-height: 0 !important; overflow: auto; }

  /* Users/Items/etc: ensure their tables stretch and scroll */
  #view-users .table-wrap,
  #view-items .table-wrap,
  #view-rooms .table-wrap,
  #view-complaints .table-wrap,
  #view-training .training-matrix{ flex: 1 1 auto; max-height: none; overflow: auto; }

  /* Dashboard cards: weekly grid can scroll horizontally on very small screens without causing page scroll */
  #week-grid{ overflow: auto; }

  /* Footer never pushes the page to scroll */
  .footer{ flex: 0 0 auto; }
</style>

<style id="collapsed-icon-rail">
  /* ——— Collapsed Sidebar: show every icon in a single scrollable rail ——— */
  #sidebar { -webkit-overflow-scrolling: touch; }

  /* Container for the cloned buttons (built by JS) */
  #icon-rail { display:none; }
  .app.collapsed #sidebar #icon-rail {
    display: flex !important;
    flex-direction: column;
    gap: 8px;
  }
  .app.collapsed #sidebar #icon-rail button{
    all: unset;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
  }
  .app.collapsed #sidebar #icon-rail .menu-item-label,
  .app.collapsed #sidebar #icon-rail .nav-badge{ display:none !important; }

  /* Hide original grouped menus and top-level buttons when collapsed —
     the rail shows clones of *all* items so nothing is missing */
  .app.collapsed #sidebar .nav > .nav-group,
  .app.collapsed #sidebar .nav > .nav-group-toggle,
  .app.collapsed #sidebar .nav > button[data-section]{
    display: none !important;
  }

  /* Make icons a consistent size in the rail */
  .app.collapsed #sidebar #icon-rail .icon{ width:22px; height:22px; margin:0; }

  /* Ensure scrolling always works on the collapsed sidebar */
  .app.collapsed #sidebar{ overflow-y: auto !important; }

  /* ——— JAZZY COMPLAINTS DASHBOARD STYLES ——— */
  
  /* Animated gradient backgrounds */
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  @keyframes countUp {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* Enhanced stat cards with gradients and animations */
  #view-complaints-dashboard .stat-card {
    background: linear-gradient(135deg, var(--glass), rgba(255,255,255,0.1)) !important;
    border: 1px solid rgba(255,255,255,0.2);
    backdrop-filter: blur(20px);
    border-radius: 16px !important;
    padding: 20px !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.6s ease-out;
    color: white !important;
  }
  
  #view-complaints-dashboard .stat-card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    border-color: var(--accent-1);
  }

  #view-complaints-dashboard .stat-card h3,
  #view-complaints-dashboard .stat-card .stat-number,
  #view-complaints-dashboard .stat-card .stat-label {
    color: white !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    font-weight: 600;
  }

  #view-complaints-dashboard .stat-card .stat-number {
    font-weight: 800;
  }

  /* Enhanced button styling for dashboard */
  #view-complaints-dashboard .btn {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  #view-complaints-dashboard .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  }

  #view-complaints-dashboard .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
  }

  #view-complaints-dashboard .btn:hover::before {
    left: 100%;
  }
  
  #view-complaints-dashboard .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
  }
  
  #view-complaints-dashboard .stat-card:hover::before {
    left: 100%;
  }
  
  /* Animated numbers */
  #view-complaints-dashboard .stat-num {
    font-size: 2.5rem !important;
    font-weight: 800 !important;
    background: linear-gradient(45deg, var(--accent-1), var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: countUp 0.8s ease-out;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  #view-complaints-dashboard .stat-label {
    font-weight: 600 !important;
    color: var(--muted) !important;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.85rem !important;
  }
  
  /* Colorful stat card variants */
  #view-complaints-dashboard .stat-card:nth-child(1) {
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    animation-delay: 0.1s;
  }
  
  #view-complaints-dashboard .stat-card:nth-child(2) {
    background: linear-gradient(135deg, #f093fb, #f5576c) !important;
    animation-delay: 0.2s;
  }
  
  #view-complaints-dashboard .stat-card:nth-child(3) {
    background: linear-gradient(135deg, #4facfe, #00f2fe) !important;
    animation-delay: 0.3s;
  }
  
  #view-complaints-dashboard .stat-card:nth-child(4) {
    background: linear-gradient(135deg, #43e97b, #38f9d7) !important;
    animation-delay: 0.4s;
  }
  
  /* Glowing dashboard panels */
  #view-complaints-dashboard .panel > div[style*="background:var(--glass)"] {
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)) !important;
    border: 1px solid rgba(255,255,255,0.2);
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    animation: fadeInUp 0.8s ease-out;
  }
  
  #view-complaints-dashboard .panel > div[style*="background:var(--glass)"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    border-color: rgba(255,255,255,0.3);
  }
  
  /* Enhanced category and status lists */
  #cmp-top-categories > div, #cmp-status-breakdown > div {
    padding: 12px 16px !important;
    margin: 8px 0 !important;
    background: linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    border-radius: 8px;
    border-left: 4px solid var(--accent-1);
    transition: all 0.2s ease;
    animation: fadeInUp 0.5s ease-out;
  }
  
  #cmp-top-categories > div:hover, #cmp-status-breakdown > div:hover {
    background: linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
    transform: translateX(4px);
    border-left-color: var(--accent-2);
  }
  
  /* Trend chart enhancements */
  #complaints-trend {
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    transition: all 0.3s ease;
  }
  
  #complaints-trend:hover {
    filter: drop-shadow(0 6px 12px rgba(0,0,0,0.15));
  }
  
  /* Enhanced quick action buttons */
  #view-complaints-dashboard .btn {
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2)) !important;
    border: none !important;
    border-radius: 12px !important;
    padding: 12px 24px !important;
    font-weight: 600 !important;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    position: relative;
    overflow: hidden;
  }
  
  #view-complaints-dashboard .btn:hover {
    transform: translateY(-2px) scale(1.05) !important;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
  }
  
  #view-complaints-dashboard .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  
  #view-complaints-dashboard .btn:hover::before {
    left: 100%;
  }
  
  /* Dashboard title enhancement */
  #view-complaints-dashboard .h1 {
    background: linear-gradient(45deg, var(--accent-1), var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2.5rem !important;
    font-weight: 800 !important;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    animation: fadeInUp 0.5s ease-out;
  }
  
  /* Loading animation for dashboard widgets */
  #cmp-top-categories:empty::before,
  #cmp-status-breakdown:empty::before {
    content: '';
    display: block;
    width: 40px;
    height: 40px;
    margin: 20px auto;
    border: 4px solid rgba(255,255,255,0.1);
    border-top: 4px solid var(--accent-1);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Stagger animations for dashboard elements */
  #view-complaints-dashboard .stat-card:nth-child(1) { animation-delay: 0.1s; }
  #view-complaints-dashboard .stat-card:nth-child(2) { animation-delay: 0.2s; }
  #view-complaints-dashboard .stat-card:nth-child(3) { animation-delay: 0.3s; }
  #view-complaints-dashboard .stat-card:nth-child(4) { animation-delay: 0.4s; }
  
  /* Floating particles background effect */
  #view-complaints-dashboard::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 20%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
    animation: gradientShift 15s ease infinite;
    background-size: 200% 200%;
  }
  
  /* Responsive adjustments for dashboard */
  @media (max-width: 768px) {
    #view-complaints-dashboard .stat-card {
      padding: 16px !important;
    }
    
    #view-complaints-dashboard .stat-num {
      font-size: 2rem !important;
    }
    
    #view-complaints-dashboard .h1 {
      font-size: 2rem !important;
    }
    
    /* Stack dashboard panels on mobile */
    #view-complaints-dashboard div[style*="display:grid; grid-template-columns: 2fr 1fr"] {
      grid-template-columns: 1fr !important;
      gap: 16px !important;
    }
    
    #view-complaints-dashboard div[style*="display:flex; gap:16px"] {
      flex-direction: column !important;
    }
  }
  
  /* Enhanced focus states for accessibility */
  #view-complaints-dashboard .btn:focus {
    outline: 2px solid var(--accent-1);
    outline-offset: 2px;
  }
  
  /* Interactive elements pulse on focus */
  #view-complaints-dashboard .stat-card:focus-within {
    animation: pulse 2s infinite;
  }
  
  /* Smooth transitions for theme changes */
  * {
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
  }
</style>

<script>

    // === BRANDING MODAL + UPLOADS ===
    const brandingBtn = document.getElementById('btn-branding');
    const brandingModal = document.getElementById('branding-modal');
    const brandingClose = document.getElementById('branding-close');
    const brandingCancel = document.getElementById('branding-cancel');
    const brandingForm = document.getElementById('branding-form');
    const logoInput = document.getElementById('branding-logo');
    const sigInput  = document.getElementById('branding-signature');
    const logoPrev  = document.getElementById('branding-logo-preview');
    const sigPrev   = document.getElementById('branding-signature-preview');
    const brandErr  = document.getElementById('branding-error');
    const brandOK   = document.getElementById('branding-success');

    function openBranding(){ brandingModal?.classList.add('show'); brandErr.style.display='none'; brandOK.style.display='none'; }
    function closeBranding(){ brandingModal?.classList.remove('show'); }

    brandingBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openBranding(); });
    brandingClose?.addEventListener('click', closeBranding);
    brandingCancel?.addEventListener('click', closeBranding);

    function readPreview(input, img){
      if(!input?.files?.[0]){ img.src=''; return; }
      const file = input.files[0];
      const url = URL.createObjectURL(file);
      img.src = url;
    }
    logoInput?.addEventListener('change', ()=> readPreview(logoInput, logoPrev));
    sigInput?.addEventListener('change', ()=> readPreview(sigInput, sigPrev));

    async function uploadBranding(){
      try{
        brandErr.style.display='none'; brandOK.style.display='none';
        const bucket = 'branding';
        const siteSlug = (typeof ctx === 'object' && (ctx?.site_slug || ctx?.site_name)) ? (ctx.site_slug || String(ctx.site_name).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')) : 'default';
        const uploads = [];

        if(logoInput?.files?.[0]){
          const f = logoInput.files[0];
          const ext = (f.name.split('.').pop() || 'png').toLowerCase();
          const path = `${siteSlug}/logo.${ext}`;
          uploads.push(supabase.storage.from(bucket).upload(path, f, { upsert:true, cacheControl:'3600', contentType: f.type || 'image/png' }));
        }
        if(sigInput?.files?.[0]){
          const f = sigInput.files[0];
          const ext = (f.name.split('.').pop() || 'png').toLowerCase();
          const path = `${siteSlug}/signature.${ext}`;
          uploads.push(supabase.storage.from(bucket).upload(path, f, { upsert:true, cacheControl:'3600', contentType: f.type || 'image/png' }));
        }

        if(uploads.length === 0){ throw new Error('Please choose at least one file to upload.'); }
        const results = await Promise.all(uploads);
        const failed = results.find(r => r?.error);
        if(failed){ throw failed.error; }
        brandOK.textContent = 'Uploaded successfully.';
        brandOK.style.display = 'block';
        setTimeout(closeBranding, 900);
      }catch(err){
        console.error(err);
        brandErr.textContent = 'Upload failed: ' + (err?.message || err);
        brandErr.style.display = 'block';
      }
    }

    brandingForm?.addEventListener('submit', (e)=>{ e.preventDefault(); uploadBranding(); });

    // === Templates download enhancer for PIR modals ===
    (function installTemplateButtons(){
      // Watch DOM for the PIR manage modal opening and inject template links
      const observer = new MutationObserver(() => {
        // Find any modal/card whose title starts with 'Manage:'
        const cards = Array.from(document.querySelectorAll('.card, .panel, [role="dialog"], .branding-card, .day-modal-card'));
        for (const card of cards) {
          const h = card.querySelector('h2, h3, .panel-title');
          if (!h) continue;
          const heading = (h.textContent || '').trim();
          if (!/^Manage:\s*/i.test(heading)) continue;
          const title = heading.replace(/^Manage:\s*/i, '').trim();

          // Locate definition
          const def = (window.PIR_DEFINITIONS_DATA || []).find(d => (d.title||'').trim() === title);
          if (!def || !def.allow_templates || !Array.isArray(def.templates) || def.templates.length === 0) continue;

          // Find the file input (we'll append links under it)
          const fileInput = card.querySelector('input[type="file"]');
          if (!fileInput) continue;
          const container = fileInput.closest('.field') || fileInput.parentElement || card;

          // Prevent duplicate injection
          if (container.querySelector('#pir-template-downloads')) { continue; }

          // Build links (prefer Supabase public URL if available)
          const wrap = document.createElement('div');
          wrap.id = 'pir-template-downloads';
          wrap.className = 'hint';
          wrap.style.marginTop = '10px';

          const list = document.createElement('div');
          list.style.display = 'grid';
          list.style.gap = '6px';

          const bucket = def.templates_bucket || 'pir_templates';
          const prefix = def.templates_prefix || '';

          def.templates.forEach(t => {
            const p = (t && t.path) ? t.path : '';
            let href = '';
            try {
              if (window.supabase && supabase.storage) {
                const r = supabase.storage.from(bucket).getPublicUrl(p).data;
                href = r?.publicUrl || '';
              }
            } catch(e) { /* fallback below */ }
            if (!href && window.SUPABASE_URL) {
              href = `${window.SUPABASE_URL.replace(/\/$/, '')}/storage/v1/object/public/${bucket}/${p}`;
            }
            if (!href && typeof window.SUPABASE_URL === 'undefined') {
              href = 'https://unveoqnlqnobufhublyw.supabase.co/storage/v1/object/public/' + bucket + '/' + p;
            }

            const item = document.createElement('div');
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.alignItems = 'center';
            item.style.gap = '8px';

            const label = document.createElement('span');
            label.textContent = t.name || p || 'Template';
            label.style.flex = '1';
            label.style.overflow = 'hidden';
            label.style.textOverflow = 'ellipsis';

            const link = document.createElement('a');
            link.href = href || '#';
            link.textContent = href ? 'Download' : 'Unavailable';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';

            item.appendChild(label);
            item.appendChild(link);
            list.appendChild(item);
          });

          wrap.appendChild(list);
          container.appendChild(wrap);
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
    })();

window.addEventListener('DOMContentLoaded', function initPIRemlGenerator(){
    // Initialize any needed functionality
});

(function () {
  var ua = navigator.userAgent || "";
  var isIOSiPad = /iPad|iPhone|iPod/.test(ua) ||
                  (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
  var onIpadPage = /indexIpad\.html$/i.test(location.pathname);
  var bypass = location.search.includes("admin=1"); // add ?admin=1 to stay on Admin

  if (isIOSiPad && !onIpadPage && !bypass) {
    location.replace("indexIpad.html"); // same folder
  }
})();
</script>

</script>
<script>
// ——— Persisted sidebar group open/close ———
(function manageNavGroups(){
  function setOpen(id, open){
    const toggle = document.querySelector('.nav-group-toggle[aria-controls="'+id+'"]');
    const group = document.getElementById(id);
    if(!toggle || !group) return;
    toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    group.classList.toggle('collapsed', !open);
  }
  function restore(){
    document.querySelectorAll('.nav-group-toggle').forEach(t => {
      const id = t.getAttribute('aria-controls');
      const saved = localStorage.getItem('navGroup:'+id);
      const open = saved === 'open'; // default closed
      setOpen(id, open);
    });
  }
  document.addEventListener('DOMContentLoaded', restore);
  // Click delegation (works even if elements re-render)
  document.addEventListener('click', (e) => {
    const toggle = e.target.closest('.nav-group-toggle');
    if(!toggle) return;
    const id = toggle.getAttribute('aria-controls');
    // If sidebar is collapsed, treat the group toggle as a quick navigation to the group's
    // first child (icon) instead of expanding the group which is hidden in collapsed mode.
    const appCollapsed = document.getElementById('app')?.classList.contains('collapsed');
    if (appCollapsed) {
      const group = document.getElementById(id);
      if (group) {
        const firstBtn = group.querySelector('button[data-section]');
        if (firstBtn) {
          firstBtn.click();
          return;
        }
      }
      return;
    }

    const willOpen = toggle.getAttribute('aria-expanded') !== 'true';
    setOpen(id, willOpen);
    localStorage.setItem('navGroup:'+id, willOpen ? 'open' : 'collapsed');
  });
  // Keyboard support
  document.addEventListener('keydown', (e) => {
    const toggle = e.target && e.target.closest ? e.target.closest('.nav-group-toggle') : null;
    if(!toggle) return;
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      const id = toggle.getAttribute('aria-controls');
      const appCollapsed = document.getElementById('app')?.classList.contains('collapsed');
      if (appCollapsed) {
        const group = document.getElementById(id);
        if (group) {
          const firstBtn = group.querySelector('button[data-section]');
          if (firstBtn) { firstBtn.click(); return; }
        }
        return;
      }
      const willOpen = toggle.getAttribute('aria-expanded') !== 'true';
      setOpen(id, willOpen);
      localStorage.setItem('navGroup:'+id, willOpen ? 'open' : 'collapsed');
    }
  });
})();
</script>
<script>
// ——— Build a flat icon rail when the sidebar is collapsed (guarantees every icon is visible) ———
(function(){
  function initIconRail(){
    const app = document.getElementById('app');
    const nav = document.getElementById('nav');
    if (!app || !nav) return; // if something is really wrong, bail

    function collectButtons(){
      const list = [];
      nav.querySelectorAll(':scope > button[data-section]').forEach(b => list.push(b));
      nav.querySelectorAll('.nav-group button[data-section]').forEach(b => list.push(b));
      return list;
    }

    function ensureRail(){
      let rail = nav.querySelector('#icon-rail');
      if (!rail){
        rail = document.createElement('div');
        rail.id = 'icon-rail';
        nav.insertBefore(rail, nav.firstChild);
      }
      return rail;
    }

    function buildRail(){
      const rail = ensureRail();
      rail.innerHTML = '';
      collectButtons().forEach(orig => {
        const clone = orig.cloneNode(true);
        clone.addEventListener('click', () => orig.click());
        if (orig.classList.contains('active')) clone.classList.add('active');
        rail.appendChild(clone);
      });
      syncActive();
    }

    function syncActive(){
      const rail = nav.querySelector('#icon-rail');
      if (!rail) return;
      rail.querySelectorAll('button[data-section]').forEach(clone => {
        const key = clone.getAttribute('data-section');
        const orig = nav.querySelector(`button[data-section="${key}"]`);
        if (orig){
          clone.classList.toggle('active', orig.classList.contains('active'));
        }
      });
    }

    // Rebuild when the app toggles collapsed/expanded
    const mo = new MutationObserver(() => {
      if (app.classList.contains('collapsed')) buildRail();
    });
    mo.observe(app, { attributes: true, attributeFilter: ['class'] });

    // Keep clone "active" states in sync after any nav interaction
    nav.addEventListener('click', () => setTimeout(syncActive, 0));

    // Initial run: if already collapsed at load, build immediately
    if (app.classList.contains('collapsed')) buildRail();
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initIconRail);
  } else {
    initIconRail();
  }
})();
</script>
  <script type="module" crossorigin src="/assets/index-D_WcoW6j.js"></script>
</head>
<body>
  <!-- Authentication Screen -->
  <div id="auth-wrapper" style="
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100vw; 
    height: 100vh; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: grid; 
    place-items: center; 
    z-index: 9999;
  ">
    <div style="
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(20px); 
      padding: 40px; 
      border-radius: 20px; 
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); 
      width: 400px; 
      max-width: 90vw;
    ">
      <div style="text-align: center; margin-bottom: 32px;">
        <img src="/assets/Animated_Logo-CwjgXDE2.gif" alt="CheckLoop Logo" style="width: 80px; height: 80px; margin-bottom: 16px;">
        <h1 style="margin: 0; color: #2d3748; font-size: 28px; font-weight: 700;">CheckLoop</h1>
        <p style="margin: 8px 0 0 0; color: #718096; font-size: 16px;">Welcome Back</p>
        <p style="margin: 4px 0 0 0; color: #a0aec0; font-size: 14px;">Enter your credentials to access the admin dashboard.</p>
      </div>

      <form id="auth-form">
        <div style="margin-bottom: 20px;">
          <label for="auth-email" style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600;">Email</label>
          <input 
            type="email" 
            id="auth-email" 
            required 
            style="
              width: 100%; 
              padding: 12px; 
              border: 2px solid #e5e7eb; 
              border-radius: 8px; 
              font-size: 16px; 
              transition: border-color 0.2s;
              background: rgba(255, 255, 255, 0.8);
            "
            placeholder="ben.howard@stoke.nhs.uk"
          >
        </div>

        <div style="margin-bottom: 24px;">
          <label for="auth-password" style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600;">Password</label>
          <input 
            type="password" 
            id="auth-password" 
            required 
            style="
              width: 100%; 
              padding: 12px; 
              border: 2px solid #e5e7eb; 
              border-radius: 8px; 
              font-size: 16px; 
              transition: border-color 0.2s;
              background: rgba(255, 255, 255, 0.8);
            "
            placeholder="••••••"
          >
        </div>

        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; font-size: 14px;">
          <label style="display: flex; align-items: center; color: #6b7280;">
            <input type="checkbox" style="margin-right: 8px;"> Remember me
          </label>
          <a href="#" style="color: #667eea; text-decoration: none;">Forgot Password?</a>
        </div>

        <button 
          type="submit" 
          style="
            width: 100%; 
            padding: 14px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: opacity 0.2s;
          "
        >
          Sign In
        </button>

        <div id="auth-error" style="
          display: none; 
          background: #fee2e2; 
          color: #dc2626; 
          padding: 12px; 
          border-radius: 8px; 
          margin-top: 16px; 
          font-size: 14px;
        "></div>
      </form>

      <div style="text-align: center; margin-top: 24px; color: #9ca3af; font-size: 14px;">
        Don't have an account? <a href="#" style="color: #667eea; text-decoration: none;">Sign up here</a>
      </div>
    </div>
  </div>

  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
  </div>

  <div class="app" id="app" aria-live="polite">
    <aside class="sidebar" id="sidebar">
      <!-- Updated sidebar toggle: SVG chevron positioned at the sidebar edge for clearer affordance -->
      <button id="toggleSidebar" class="sidebar-toggle" aria-label="Toggle sidebar" aria-expanded="true" title="Toggle sidebar">
        <svg class="sidebar-toggle-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor" />
        </svg>
      </button>
      <div class="brand">
        <img src="/assets/Animated_Logo-CwjgXDE2.gif" alt="CheckLoop Logo" class="logo">
        <div>
          <div class="t">CheckLoop</div>
          <div class="hint">Admin</div>
        </div>
      </div>
      <nav class="nav" id="nav">
        <button class="active" data-section="dashboard"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span class="menu-item-label">Dashboard</span></button>

  <button class="nav-group-toggle" id="toggle-pre-inspection" type="button" aria-expanded="false" aria-controls="group-pre-inspection">Pre-Inspection <span class="caret" aria-hidden="true"></span></button>
  <div class="nav-group collapsed" id="group-pre-inspection">
          <button data-section="pre-inspection"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg><span class="menu-item-label">Pre-inspection</span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-checks" type="button" aria-expanded="false" aria-controls="group-checks">Checks & Audits <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-checks">
        </div>
          <button class="nav-group-toggle" id="toggle-complaints" type="button" aria-expanded="false" aria-controls="group-complaints">Complaints <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-complaints">
          <button data-section="complaints-dashboard"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg><span class="menu-item-label">Dashboard</span><span class="nav-badge" id="badge-complaints-dashboard"></span></button>
          <button data-section="complaints-reporting"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 6h18M3 12h18M3 18h18"/></svg><span class="menu-item-label">Reporting</span><span class="nav-badge" id="badge-complaints"></span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-scans" type="button" aria-expanded="false" aria-controls="group-scans">Scans <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-scans">
          <button data-section="calendar"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="menu-item-label">Calendar</span></button>
          <button data-section="schedules"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><polyline points="12 7 12 12 16 14"></polyline></svg><span class="menu-item-label">Schedules</span></button>
          <button data-section="submissions"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="6" height="6"></rect><rect x="15" y="3" width="6" height="6"></rect><rect x="3" y="15" width="6" height="6"></rect><path d="M15 15h2v2h-2z"></path><path d="M19 19h2"></path><path d="M19 15v2"></path></svg><span class="menu-item-label">Submissions</span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-config" type="button" aria-expanded="false" aria-controls="group-config">Configure <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-config">
          <button data-section="items"><svg class="icon" style="color: var(--muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4a2 2 0 0 0 1-1.73z"/>
            <path d="M3.27 6.96L12 12l8.73-5.04"/>
            <path d="M12 22V12"/>
          </svg><span class="menu-item-label">Items</span><span class="nav-badge" id="badge-items"></span></button>
          <button data-section="rooms"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 9l9-7 9 7"></path><path d="M9 22V12h6v10"></path><path d="M21 22H3a2 2 0 0 1-2-2V9"></path></svg><span class="menu-item-label">Rooms</span><span class="nav-badge" id="badge-rooms"></span></button>
          <button data-section="checktypes"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><polyline points="9 12 12 15 16 9"></polyline></svg><span class="menu-item-label">Check Types</span><span class="nav-badge" id="badge-ct"></span></button>
          <button data-section="quiz"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 1 1 5.83 1c0 2-3 2-3 4"/><line x1="12" y1="17" x2="12" y2="17"/></svg><span class="menu-item-label">Quiz</span><span class="nav-badge" id="badge-quiz"></span></button>
          <button data-section="staff"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="7" r="4"></circle><path d="M5.5 21a6.5 6.5 0 0 1 13 0"></path></svg><span class="menu-item-label">Staff</span><span class="nav-badge" id="badge-staff"></span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-settings" type="button" aria-expanded="false" aria-controls="group-settings">Settings <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-settings">
          <button data-section="settings"><svg class="icon" style="color: var(--muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9c.69 0 1.25-.56 1.25-1.25V3a2 2 0 1 1 4 0v.09c0 .69.56 1.25 1.25 1.25.37 0 .72-.15.97-.4l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.25.25-.4.6-.4.97V9c0 .69.56 1.25 1.25 1.25H21a2 2 0 1 1 0 4h-.09c-.69 0-1.25.56-1.25 1.25z"/>
          </svg><span class="menu-item-label">Site Settings</span></button>
          <button data-section="users"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg><span class="menu-item-label">Users</span></button>
        </div>
      </nav>
      
      <!-- User Profile Section -->
      <div class="user-profile">
        <div class="user-row">
          <div class="user-avatar" id="user-avatar">
            <span id="user-initials">U</span>
          </div>
          <div class="user-details">
            <div class="user-name" id="user-name">User</div>
            <div class="site-info" id="site-info">Site</div>
          </div>
        </div>
        <button class="btn-signout" id="signout" title="Sign Out">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
        </button>
      </div>
      
      <!-- Resize handle for dragging sidebar width -->
      <div id="sidebar-resize-handle"></div>
    </aside>

    <main class="content">
      <section class="view active" id="view-dashboard">
        <div class="footer">© CheckLoop • Built for GP surgeries • CQC Readiness Dashboard ✅</div>
      </section>

      <section class="view" id="view-quiz">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Quiz Management</h1>
              <button class="help-icon" onclick="showHelp('view-quiz')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn secondary" id="btn-quiz-refresh">Refresh</button>
              <a class="btn" id="btn-open-quiz" href="quiz.html?site=2" target="_blank">Open Quiz Page</a>
            </div>
          </div>

          <div class="table-wrap" style="margin-top:10px">
            <table>
              <thead id="quiz-thead">
                <tr><th class="muted">Loading schema…</th></tr>
              </thead>
              <tbody id="quiz-tbody">
                <tr><td class="muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="hint" style="margin-top:10px">Showing raw contents of <code>quiz_questions</code> from Supabase.</div>
        </div>
      </section>
      
      <!-- Users View (moved from Settings) -->
      <section class="view" id="view-users">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">User Management</h1>
              <button class="help-icon" onclick="showHelp('view-users')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <button class="btn" id="btn-invite-user">Invite User</button>
            </div>
          </div>

          <div class="settings-section" style="margin-top:20px">
            <h3>Practice Users</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="practice-users-tbody">
                  <tr><td colspan="5" class="muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Invite User Modal -->
        <div class="modal" id="invite-modal">
          <div class="modal-content" style="width:500px">
            <div class="modal-header">
              <h3>Invite User</h3>
              <button type="button" class="modal-close" id="invite-modal-close">&times;</button>
            </div>
            <form id="invite-form">
              <div class="field">
                <label>Full Name</label>
                <input type="text" id="invite-name" name="full_name" required>
              </div>
              <div class="field">
                <label>Email</label>
                <input type="email" id="invite-email" name="email" required>
              </div>
              <div class="field">
                <label>Access</label>
                <select id="invite-access" name="access" required>
                  <option value="admin">Admin</option>
                  <option value="staff">Staff</option>
                </select>
                <div class="hint">Choose account access level (Admin or Staff)</div>
              </div>
              <div class="field">
                <label>Role</label>
                <select id="invite-role" name="role_detail">
                  <option value="">—</option>
                </select>
              </div>
              <div class="field">
                <label>Reports To</label>
                <select id="invite-reports-to" name="reports_to_id">
                  <option value="">—</option>
                </select>
              </div>
              <div class="error" id="invite-error" style="display:none"></div>
              <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px">
                <button type="button" class="btn secondary" id="invite-cancel-btn">Cancel</button>
                <button type="submit" class="btn">Send Invitation</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <section class="view" id="view-pre-inspection">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Pre-Inspection Readiness</h1>
              <button class="help-icon" onclick="showHelp('view-pre-inspection')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <button class="btn secondary" id="pir-bulk-upload">Bulk Upload</button>
              <button class="btn secondary" id="pir-export">Export Checklist</button>
            </div>
          </div>
          
          <!-- Progress at a glance: dedicated full-width PIR panel -->
          <div class="pir-progress-panel">
            <div class="pir-progress-main">
              <div class="pir-progress-stats">
                <div>
                  <div class="muted">Overall Progress (Ready Items)</div>
                  <div class="pir-progress-text" id="pir-progress-text">0 / 0 Ready (0%)</div>
                </div>
                <div style="text-align:right">
                  <div class="muted-small">Scaled: 0 — 66</div>
                  <div class="large" id="pir-progress-large">0 / 66</div>
                </div>
              </div>

              <div>
                <div class="progress-bar-container">
                  <div class="progress-milestones">
                    <div class="milestone quarter"></div>
                    <div class="milestone half"></div>
                    <div class="milestone three-quarter"></div>
                  </div>
                  <div class="progress-bar-bg">
                    <div class="progress-bar-fg" id="pir-progress-bar" style="width: 0%;"></div>
                  </div>
                </div>
              </div>

              <div style="margin-top:12px;">
                <div style="font-weight:700; margin-bottom:8px;">Email package status</div>
                <div class="email-status-circles" id="email-status-circles">
                  <!-- Email circles injected by JS -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Filter & sort pills -->
          <div class="pir-filters">
            <div class="pir-filter-pill active" data-filter="all">All</div>
            <div class="pir-filter-pill" data-filter="not-attached">Not Attached</div>
            <div class="pir-filter-pill" data-filter="ready">Ready</div>
            <div class="pir-filter-pill" data-filter="expiring-soon">Expiring Soon</div>
            <div class="pir-filter-pill" data-filter="outdated">Outdated</div>
            <div class="pir-filter-pill" data-filter="draft">Has Draft</div>
          </div>
          
          <div class="pir-layout">
            <!-- Sidebar TOC -->
            <div class="pir-toc">
              <div class="pir-toc-title">Categories</div>
              <div id="pir-toc-items">
                <div class="muted" style="padding: 20px; text-align: center; font-size: 12px;">Loading...</div>
              </div>
            </div>
            
            <!-- Main content -->
            <div class="pir-main">
              <div id="pir-docs-container"></div>
            </div>
          </div>
        </div>
        
        <!-- Bulk operations bar -->
        <div class="pir-bulk-bar" id="pir-bulk-bar">
          <div class="pir-bulk-count"><span id="pir-selected-count">0</span> items selected</div>
          <button class="btn secondary" id="pir-bulk-upload-selected">Bulk Upload Selected</button>
          <button class="btn secondary" id="pir-export-selected">Export Selected</button>
          <button class="btn secondary" id="pir-clear-selection">Clear Selection</button>
        </div>
        
        <!-- Preview Modal -->
        <div class="pir-preview-modal" id="pir-preview-modal">
          <div class="pir-preview-content">
            <div class="pir-preview-header">
              <h3 id="pir-preview-title">Document Preview</h3>
              <button class="pir-preview-close" id="pir-preview-close">Close</button>
            </div>
            <div class="pir-preview-body" id="pir-preview-body">
              <div style="padding: 40px; text-align: center; color: var(--muted);">Loading preview...</div>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="view-training">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Mandatory Training Management</h1>
              <button class="help-icon" onclick="showHelp('view-training')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <button class="btn secondary" id="btn-manage-training-types">Manage Training Types</button>
              <button class="btn" id="btn-export-training">Export Report</button>
            </div>
          </div>
          
          <div class="tab-controls" style="margin-bottom: 24px; display:flex; gap:8px;">
            <button class="btn secondary active" id="tab-clinical" data-tab="clinical">Clinical Staff</button>
            <button class="btn secondary" id="tab-non-clinical" data-tab="non-clinical">Non-Clinical Staff</button>
          </div>

          <div class="training-matrix" id="training-matrix-container">
            <!-- Simple Training Matrix Table -->

            <table id="training-matrix-table">
              <thead>
                <tr id="training-headers">
                  <th>Staff Member</th>
                </tr>
              </thead>
              <tbody id="training-tbody">
                <tr><td colspan="100%" class="muted">Loading training matrix...</td></tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top: 16px; display: flex; gap: 20px; font-size: 12px; color: var(--muted);">
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-2-bg); border-radius: 2px;"></div>
              <span>Valid</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-3-bg); border-radius: 2px;"></div>
              <span>Expiring ≤30 days</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-4-bg); border-radius: 2px;"></div>
              <span>Expired</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--glass); border-radius: 2px;"></div>
              <span>No Record</span>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="view-calendar">
        <div class="panel">
          <div id="cal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <button id="cal-prev" class="btn secondary">‹ Prev</button>
            <div id="cal-month-year" class="panel-title">Loading...</div>
            <button id="cal-next" class="btn secondary">Next ›</button>
          </div>
          
          <div class="cal-legend" id="cal-legend">
            <div class="item"><span class="dot scheduled" aria-hidden="true"></span> Scheduled</div>
            <div class="item"><span class="dot done" aria-hidden="true"></span> Done</div>
            <div class="item"><span class="dot missed" aria-hidden="true"></span> Missed</div>
            <div class="item" style="margin-left:auto;">Frequency: <span class="freq-badge" style="margin-left:8px;">D</span> Daily <span class="freq-badge" style="margin-left:8px; margin-left:12px;">W</span> Weekly <span class="freq-badge" style="margin-left:8px; margin-left:12px;">M</span> Monthly</div>
          </div>

          <div id="cal-weekdays" style="display:grid; grid-template-columns: repeat(7, 1fr); text-align:center; margin-bottom:8px; font-weight:600; color:var(--muted); font-size:12px;">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div id="cal-grid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; min-height: 500px;">
          </div>
          <div id="cal-compliance-view" style="display: none;"></div>
        </div>
      </section>

      <section class="view" id="view-items">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Equipment & Asset Management</h1>
              <button class="help-icon" onclick="showHelp('view-items')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-item">Add Item</button>
          </div>
          <div class="table-wrap" style="margin-top:10px"><table>
            <thead><tr><th class="sortable" data-col="item_id">Code <span class="arrow" id="sort-item_id"></span></th><th class="sortable" data-col="item_name">Name <span class="arrow" id="sort-item_name"></span></th><th class="sortable" data-col="room_name">Room <span class="arrow" id="sort-room_name"></span></th><th class="sortable" data-col="default_check_type_name">Default Check <span class="arrow" id="sort-default_check_type_name"></span></th><th class="sortable" data-col="active">Active <span class="arrow" id="sort-active"></span></th></tr></thead>
            <tbody id="items-tbody" data-entity="items"><tr><td colspan="5" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-rooms">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Room & Location Management</h1>
              <button class="help-icon" onclick="showHelp('view-rooms')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-room">Add Room</button>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>Name</th><th>Owner</th></tr></thead>
            <tbody id="rooms-tbody" data-entity="rooms"><tr><td colspan="2" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

          <!-- Complaints Dashboard view -->
          <section class="view" id="view-complaints-dashboard">
            <div class="panel">
              <div class="page-header">
                <div class="page-title-wrapper">
                  <h1 class="page-title">Complaints Dashboard</h1>
                  <button class="help-icon" onclick="showHelp('view-complaints-dashboard')" title="Help">?</button>
                </div>
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--accent-1);">
                    <path d="M3 12h18m-9-9v18"/>
                  </svg>
                  <div>
                    <div style="color: white; font-size: 2rem; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                      📊 Complaints Dashboard
                    </div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 1rem; font-weight: 400; margin-top: 4px;">
                        Compliance Monitoring & Quality Improvement Analytics
                      </div>
                  </div>
                </div>
                <div style="display:flex; gap:10px; flex-direction: column; align-items: flex-end;">
                  <!-- Status Indicator -->
                  <div style="background: rgba(32, 191, 107, 0.06); padding: 6px 12px; border-radius: 16px; backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.04);">
                    <span style="color: #22c55e; font-weight: 700; font-size: 0.9rem;">✅ Status: OK</span>
                  </div>
                  <button class="btn" id="btn-new-complaint-dashboard" onclick="addComplaint()" style="background:linear-gradient(135deg, #43e97b, #38f9d7); color: white; font-weight: 600;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;">
                      <path d="M12 5v14M5 12h14"/>
                    </svg>
                    Add Complaint
                  </button>
                </div>
              </div>

              <!-- Top stats with icons -->
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:16px; margin-bottom:24px;">
                
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; flex-direction:column; gap:8px; position:relative;">
                  <div style="position:absolute; top:16px; right:16px; opacity:0.3;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                      <path d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5S20.55 6 20 6H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V6H4C3.45 6 3 5.55 3 5S3.45 4 4 4H7Z"/>
                    </svg>
                  </div>
                  <div class="stat-num" id="cmp-total" style="color:#fff; font-weight: 800; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">—</div>
                  <div class="stat-label" style="color:rgba(255,255,255,0.9); font-weight: 600;">Total Complaints (30d)</div>
                  <div style="color: rgba(255,255,255,0.7); font-size: 0.8rem; margin-top: 4px;">Reporting period: last 30 days</div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display:flex; flex-direction:column; gap:8px; position:relative;">
                  <div style="position:absolute; top:16px; right:16px; opacity:0.3;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                      <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"/>
                    </svg>
                  </div>
                  <div class="stat-num" id="cmp-open" style="color:#fff; font-weight: 800; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">—</div>
                  <div class="stat-label" style="color:rgba(255,255,255,0.9); font-weight: 600;">Active & Under Investigation</div>
                  <div style="color: rgba(255,255,255,0.7); font-size: 0.8rem; margin-top: 4px;">Requires attention</div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display:flex; flex-direction:column; gap:8px; position:relative;">
                  <div style="position:absolute; top:16px; right:16px; opacity:0.3;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                      <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"/>
                    </svg>
                  </div>
                  <div class="stat-num" id="cmp-resolved" style="color:#fff; font-weight: 800; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">—</div>
                  <div class="stat-label" style="color:rgba(255,255,255,0.9); font-weight: 600;">Resolved & Closed</div>
                  <div style="color: rgba(255,255,255,0.7); font-size: 0.8rem; margin-top: 4px;">Resolution timeframe</div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); display:flex; flex-direction:column; gap:8px; position:relative;">
                  <div style="position:absolute; top:16px; right:16px; opacity:0.3;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#333">
                      <path d="M18 16.08C17.24 16.08 16.56 16.38 16.04 16.85L8.91 12.7C8.96 12.47 9 12.24 9 12S8.96 11.53 8.91 11.3L15.96 7.19C16.5 7.69 17.21 8 18 8C19.66 8 21 6.66 21 5S19.66 2 18 2 15 3.34 15 5C15 5.24 15.04 5.47 15.09 5.7L8.04 9.81C7.5 9.31 6.79 9 6 9C4.34 9 3 10.34 3 12S4.34 15 6 15C6.79 15 7.5 14.69 8.04 14.19L15.16 18.34C15.11 18.55 15.08 18.77 15.08 19C15.08 20.61 16.39 21.92 18 21.92S20.92 20.61 20.92 19C20.92 17.39 19.61 16.08 18 16.08Z"/>
                    </svg>
                  </div>
                  <div class="stat-num" id="cmp-share" style="color:#333; font-weight: 800; text-shadow: 0 1px 3px rgba(255,255,255,0.5);">—</div>
                  <div class="stat-label" style="color:#333; font-weight: 600;">Shared for Learning</div>
                  <div style="color: rgba(51,51,51,0.7); font-size: 0.8rem; margin-top: 4px;">Team Development & Training</div>
                </div>

              </div>

              <!-- Compliance Metrics Row -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                
                <!-- Response Time Compliance -->
                <div class="stat-card" style="background: linear-gradient(135deg, #20bf6b 0%, #01a3a4 100%); padding: 20px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <h4 style="margin: 0 0 8px; font-size: 1rem; font-weight: 600; color: white;">⏱️ Response Times</h4>
                      <div style="font-size: 1.8rem; font-weight: 800; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">< 24hrs</div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">Recommended: same-day acknowledgment</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="background: rgba(255,255,255,0.25); padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; backdrop-filter: blur(10px);">
                        <span style="color: white; font-weight: 700; font-size: 1.1rem;">—</span>
                      </div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Compliance Rate</div>
                    </div>
                  </div>
                </div>

                <!-- Resolution Quality -->
                <div class="stat-card" style="background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%); padding: 20px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <h4 style="margin: 0 0 8px; font-size: 1rem; font-weight: 600; color: white;">🎯 Resolution Quality</h4>
                      <div style="font-size: 1.8rem; font-weight: 800; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">—</div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">Average satisfaction rating</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="background: rgba(255,255,255,0.25); padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; backdrop-filter: blur(10px);">
                        <span style="color: white; font-weight: 700; font-size: 1.1rem;">—</span>
                      </div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Satisfied</div>
                    </div>
                  </div>
                </div>

                <!-- Learning & Improvement -->
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <h4 style="margin: 0 0 8px; font-size: 1rem; font-weight: 600; color: white;">📚 Learning Actions</h4>
                      <div style="font-size: 1.8rem; font-weight: 800; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">—</div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">Process improvements identified</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="background: rgba(255,255,255,0.25); padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; backdrop-filter: blur(10px);">
                        <span style="color: white; font-weight: 700; font-size: 1.1rem;">—</span>
                      </div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Implemented</div>
                    </div>
                  </div>
                </div>

              </div>

              <!-- Dashboard visuals: common categories, statuses etc. -->
              <div style="display:grid; grid-template-columns: 2fr 1fr; gap:16px; margin-bottom:24px;">
                <div style="background:var(--glass); border-radius:16px; padding:20px;">
                  <div style="font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; color: white;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    📊 Most Common Categories
                  </div>
                  <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 16px;">
                    Track complaint patterns to identify systemic issues and improvement opportunities
                  </div>
                  <div id="cmp-top-categories" style="min-height:120px;">Loading complaint categories...</div>
                </div>
                <div style="background:var(--glass); border-radius:16px; padding:20px;">
                  <div style="font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; color: white;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <path d="M8 12h8M12 8v8"/>
                    </svg>
                    📋 Current Status Overview
                  </div>
                  <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 16px;">
                    Real-time complaint resolution tracking
                  </div>
                  <div id="cmp-status-breakdown" style="min-height:120px;">Loading status breakdown...</div>
                </div>
              </div>

              <div style="display:flex; gap:20px; margin-bottom:16px; align-items:flex-start; flex-wrap:wrap;">
                <div style="flex:2; min-height:200px; background:var(--glass); border-radius:16px; padding:20px;">
                  <div style="font-weight:700; margin-bottom:16px; display:flex; align-items:center; gap:8px; color: white;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 3v18h18"/>
                      <path d="M7 12l4-4 4 4 6-6"/>
                    </svg>
                    Complaint Trends (Last 30 Days)
                  </div>
                  <div style="width: 100%; height: 160px; display: flex; align-items: center; justify-content: center;">
                    <svg id="dashboard-trend-chart" style="width: 100%; height: 100%; overflow: visible;"></svg>
                  </div>
                  <div style="margin-top: 16px; display: flex; justify-content: space-around; text-align: center;">
                    <div>
                      <div style="color: white; font-weight: 700; font-size: 1.3rem;">—</div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">vs Last Month</div>
                    </div>
                    <div>
                      <div style="color: white; font-weight: 700; font-size: 1.3rem;">—</div>
                      <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Daily Average</div>
                    </div>
                    <div>
                      <div style="color: white; font-weight: 700; font-size: 1.3rem;">—</div>
                      <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Peak Day</div>
                    </div>
                  </div>
                </div>
                <div style="flex:1; min-width:280px; background:var(--glass); border-radius:16px; padding:20px;">
                  <div style="font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; color: white;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    Quick Actions
                  </div>
                  <button class="btn" id="btn-open-complaints-reporting" onclick="setActiveSection('complaints-reporting')" style="width:100%; margin-bottom:12px; background:linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; font-weight: 600; padding: 14px; border-radius: 8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                      <line x1="16" y1="13" x2="8" y2="13"/>
                      <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    📊 Open Reporting
                  </button>
                  <button class="btn" id="btn-refresh-complaints-dashboard" onclick="fetchComplaintsDashboardStats()" style="width:100%; margin-bottom:12px; background:linear-gradient(135deg, #4facfe, #00f2fe); color: white; border: none; font-weight: 600; padding: 14px; border-radius: 8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;">
                      <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                    🔄 Refresh Data
                  </button>
                  <button class="btn" id="btn-generate-report" style="width:100%; margin-bottom:12px; background:linear-gradient(135deg, #a8edea, #fed6e3); color: #333; border: none; font-weight: 600; padding: 14px; border-radius: 8px;">
                    📋 Generate Report
                  </button>
                  <button class="btn" id="btn-checklist" style="width:100%; background:linear-gradient(135deg, #20bf6b, #01a3a4); color: white; border: none; font-weight: 600; padding: 14px; border-radius: 8px;">
                    ✅ Checklist
                  </button>
                  
                  <!-- Pre-Inspection Status Indicator -->
                  <div style="margin-top: 20px; padding: 16px; background: rgba(32, 191, 107, 0.2); border-radius: 12px; border-left: 4px solid #20bf6b; backdrop-filter: blur(10px);">
                    <div style="display: flex; align-items: center;">
                      <span style="font-size: 1.2rem; margin-right: 8px;">✅</span>
                      <div>
                        <div style="color: white; font-weight: 700; font-size: 0.9rem;">Status: OK</div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">All metrics within requirements</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Complaints Reporting view (list, filter, export, add, amend) -->
          <section class="view" id="view-complaints-reporting">
            <div class="panel">
              <div class="page-header">
                <div class="page-title-wrapper">
                  <h1 class="page-title">Complaints Reporting</h1>
                  <button class="help-icon" onclick="showHelp('view-complaints-reporting')" title="Help">?</button>
                </div>
                <div style="display:flex; gap:10px;">
                  <button class="btn secondary" id="complaints-export">Export</button>
                  <button class="btn" id="btn-new-complaint">Add Complaint</button>
                </div>
              </div>

              <!-- Filters -->
              <div style="display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap">
                <div style="display:flex; gap:8px; align-items:center;">
                  <label class="muted" style="font-size:13px;">From</label>
                  <input type="date" id="complaints-filter-start" class="ui-select" style="width:160px;">
                  <label class="muted" style="font-size:13px;">To</label>
                  <input type="date" id="complaints-filter-end" class="ui-select" style="width:160px;">
                </div>
                <select id="complaints-filter-category" class="ui-select" style="min-width:160px;"></select>
                <select id="complaints-filter-status" class="ui-select" style="min-width:140px;">
                  <option value="">All Statuses</option>
                  <option value="resolved">Resolved</option>
                  <option value="open">Open</option>
                </select>
                <input id="complaints-search" class="ui-select" placeholder="Search text or patient initials" style="flex:1; min-width:160px;">
              </div>

              <!-- Complaints table (list + actions) -->
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th style="width:36px"><input type="checkbox" id="cmp-select-all" aria-label="Select all"></th>
                      <th>Datetime</th>
                      <th>Patient</th>
                      <th>Category</th>
                      <th>Original complaint</th>
                      <th>Response</th>
                      <th>Lessons learned</th>
                      <th>Status</th>
                      <th>Share</th>
                      <th>Created by</th>
                      <th>Resolved at</th>
                      <th style="width:140px">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="complaints-tbody" data-entity="complaints"><tr><td colspan="12" class="muted">Loading…</td></tr></tbody>
                </table>
              </div>
            </div>
          </section>


      <section class="view" id="view-checktypes">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Check Type Configuration</h1>
              <button class="help-icon" onclick="showHelp('view-checktypes')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-ct">Add Check Type</button>
          </div>
          <div class="table-wrap" style="margin-top:10px"><table>
            <thead><tr><th>Name</th><th>Active</th></tr></thead>
            <tbody id="ct-tbody" data-entity="check_types"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-schedules">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Compliance Schedules</h1>
              <button class="help-icon" onclick="showHelp('view-schedules')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-sched">Add Schedule</button>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>Item</th><th>Room</th><th>Check</th><th>Frequency</th><th>Day</th><th>Required</th></tr></thead>
            <tbody id="sched-tbody" data-entity="item_allowed_types"><tr><td colspan="6" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-staff">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Staff Records</h1>
              <button class="help-icon" onclick="showHelp('view-staff')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <!-- Role management removed: roles are fixed to Admin and Staff -->
            </div>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>Name</th><th>Role</th><th>Reports To</th><th>Active</th></tr></thead>
            <tbody id="staff-tbody" data-entity="kiosk_users"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-submissions">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Compliance Submissions</h1>
              <button class="help-icon" onclick="showHelp('view-submissions')" title="Help">?</button>
            </div>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>When</th><th>Staff</th><th>Rows</th><th>Comment</th></tr></thead>
            <tbody id="subs-tbody"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-settings">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">System Settings</h1>
              <button class="help-icon" onclick="showHelp('view-settings')" title="Help">?</button>
            </div>
          </div>
      
      
              <h3>Page Visibility</h3>
              
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-1" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Dashboard</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-2" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Pre-inspection</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-3" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Mandatory Training</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-4" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Calendar</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-5" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Schedules</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-6" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Submissions</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-7" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Items</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-8" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Rooms</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-9" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Check Types</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-10" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Staff</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-11" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Complaints</span>
                  </label>
                </div>
              </div>
              
              <div style="margin-top: 20px; text-align: center;">
                <!-- Save button removed per request -->
                <button type="button" class="btn secondary" id="debug-page-visibility" style="padding: 8px 16px; font-size: 14px;" onclick="testDebugFunction()">
                  Save
                </button>
                <br>
                <!-- Read-only textbox showing enabled toggles as an array/string -->
                <input type="text" id="debug-enabled-toggles" readonly placeholder="[]" style="display:none; width:100%; margin-top:8px; font-family:monospace; padding:8px; box-sizing:border-box;" />
                <!-- Editable box for entering a custom array (not wired to any logic yet) -->
                <textarea id="debug-custom-array" placeholder='["one","two"]' style="display:none; width:100%; margin-top:8px; font-family:monospace; padding:8px; box-sizing:border-box; min-height:48px;" ></textarea>
              </div>
              
              
              <!-- Debug Settings Section -->
              <div class="settings-section" style="margin-top:20px">

              </div>
            </div>
      </section>
    </main>
  </div>

  <script>
    // Keep the debug-enabled-toggles input in sync with the page visibility checkboxes
    (function(){
      function getToggleMap(){
        return {
          'page-toggle-1': 'dashboard',
          'page-toggle-2': 'pre-inspection',
          'page-toggle-3': 'training',
          'page-toggle-4': 'calendar',
          'page-toggle-5': 'schedules',
          'page-toggle-6': 'submissions',
          'page-toggle-7': 'items',
          'page-toggle-8': 'rooms',
          'page-toggle-9': 'checks',
          'page-toggle-10': 'staff',
          'page-toggle-11': 'complaints'
        };
      }

      function updateDebugEnabledToggles(){
        const input = document.getElementById('debug-enabled-toggles');
        if(!input) return;
        const map = getToggleMap();
        const enabled = [];
        Object.keys(map).forEach(id => {
          const el = document.getElementById(id);
          if(el && el.checked) enabled.push(map[id]);
        });
        input.value = JSON.stringify(enabled);
      }

      // Wire change listeners to toggles when they exist
      function wireToggleListeners(){
        const els = document.querySelectorAll('[id^="page-toggle-"]');
        els.forEach(el => {
          el.removeEventListener('change', updateDebugEnabledToggles);
          el.addEventListener('change', updateDebugEnabledToggles);
        });
      }

      // Expose for manual calls
      window.updateDebugEnabledToggles = updateDebugEnabledToggles;

      // Attempt to wire now and again after DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        wireToggleListeners();
        updateDebugEnabledToggles();
      });

      // If settings are initialized later, ensure we wire again
      // (initPageVisibilityToggles calls loadPagePermissions which sets toggles)
      const origInit = window.initPageVisibilityToggles;
      if(typeof origInit === 'function'){
        window.initPageVisibilityToggles = function(){
          const res = origInit.apply(this, arguments);
          // small delay to allow loadPagePermissions to set toggle states
          setTimeout(() => { wireToggleListeners(); updateDebugEnabledToggles(); }, 200);
          return res;
        };
      }
    })();
  </script>

  <script>
    (function(){
      function setQuizLinkSite(){
        var link = document.getElementById('btn-open-quiz');
        if(!link) return;
        try{
          var siteId = (window.ctx && (ctx.site_id || ctx.siteId)) ? (ctx.site_id || ctx.siteId) : null;
          if(!siteId) return;
          var u = new URL(link.getAttribute('href'), location.href);
          u.searchParams.set('site', siteId);
          link.setAttribute('href', u.pathname + u.search);
        }catch(e){}
      }
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', setQuizLinkSite);
      }else{
        setQuizLinkSite();
      }
    })();
  </script>


  <div id="day-modal" aria-hidden="true">
    <div class="day-modal-card">
      <button class="day-modal-close" id="day-modal-close" aria-label="Close">✕</button>
      <h2 class="day-modal-title">Details</h2>
      <div class="day-modal-body">Loading…</div>
    </div>
  </div>
  <div id="branding-modal" aria-hidden="true">
    <div class="branding-card">
      <button class="branding-close" id="branding-close" aria-label="Close">✕</button>
      <h2 style="margin:0 0 6px">Branding</h2>
      <div class="hint-mini">Upload a practice logo and a signature image. PNG with transparent background is ideal.</div>
      <form id="branding-form">
        <div class="branding-row">
          <div>
            <div class="muted" style="margin-bottom:6px">Logo</div>
            <div class="branding-preview"><img id="branding-logo-preview" alt="" /></div>
          </div>
          <div>
            <input type="file" id="branding-logo" accept="image/*" />
            <div class="hint-mini">Recommended: PNG, at least 600×300px.</div>
          </div>
        </div>
        <div class="branding-row">
          <div>
            <div class="muted" style="margin-bottom:6px">Signature</div>
            <div class="branding-preview"><img id="branding-signature-preview" alt="" /></div>
          </div>
          <div>
            <input type="file" id="branding-signature" accept="image/*" />
            <div class="hint-mini">Recommended: Transparent PNG.</div>
          </div>
        </div>
        <div class="branding-actions">
          <button type="button" class="btn secondary" id="branding-cancel">Cancel</button>
          <button type="submit" class="btn" id="branding-save">Upload</button>
        </div>
        <div class="error" id="branding-error" role="alert" style="display:none"></div>
        <div class="hint" id="branding-success" style="display:none">Uploaded successfully.</div>
      </form>
    </div>
  </div>

  <!-- Training Types Management Modal -->
  <div class="modal training-types-modal" id="training-types-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Manage Training Types</h3>
        <button type="button" class="modal-close" id="training-types-close">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <p style="color: var(--muted); font-size: 14px; margin-bottom: 16px;">
          Configure training modules and their expiry periods. When staff upload training certificates, 
          the expiry date will be automatically calculated based on these settings.
        </p>
        
        <div class="training-type-row" style="font-weight: 600; color: var(--accent-2); border-bottom: 2px solid var(--border-color);">
          <div>Training Name</div>
          <div>Expiry Period</div>
          <div>Clinical</div>
          <div>Non-Clinical</div>
          <div>Active</div>
          <div>Actions</div>
        </div>
        
        <div id="training-types-list">
          <div style="padding: 20px; text-align: center; color: var(--muted);">Loading...</div>
        </div>
        
        <button type="button" class="btn" id="add-training-type" style="margin-top: 16px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add New Training Type
        </button>
      </div>
      
      <div class="error" id="training-types-error" style="display:none"></div>
      
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
        <button type="button" class="btn secondary" id="training-types-cancel">Cancel</button>
        <button type="button" class="btn" id="save-training-types">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Training Record Modal -->
  <div class="modal training-modal" id="training-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="training-modal-title">Update Training Record</h3>
        <button type="button" class="modal-close" id="training-modal-close">&times;</button>
      </div>
      <form id="training-form">
        <input type="hidden" id="training-staff-id">
        <input type="hidden" id="training-type-id">
        
        <div class="field">
          <label>Staff Member</label>
          <input type="text" id="training-staff-name" disabled>
        </div>
        
        <div class="field">
          <label>Training Module</label>
          <input type="text" id="training-type-name" disabled>
        </div>
        
        <div class="field">
          <label>Completion Date</label>
          <input type="date" id="training-completion-date" required>
        </div>
        
        <div class="field">
          <label>Expiry Date (if applicable)</label>
          <input type="date" id="training-expiry-date">
        </div>
        
        <div class="field">
          <label>Certificate</label>
          <div class="training-upload-zone" id="training-upload-zone">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 12px; color: var(--muted);">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <p>Drop certificate here or click to browse</p>
            <p style="font-size: 11px; color: var(--muted); margin-top: 8px;">PDF, JPG, PNG up to 10MB</p>
          </div>
          <input type="file" id="training-certificate" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
          <div id="training-current-file" style="display: none; margin-top: 8px; padding: 8px; background: var(--glass); border-radius: 8px;">
            <span id="training-file-name"></span>
            <button type="button" class="btn secondary" style="margin-left: 8px; padding: 4px 8px; font-size: 11px;" onclick="downloadTrainingCertificate()">Download</button>
          </div>
        </div>
        
        <div class="field">
          <label>Notes</label>
          <textarea id="training-notes" placeholder="Optional notes about this training..."></textarea>
        </div>
        
        <div class="error" id="training-error" style="display:none"></div>
        
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px">
          <button type="button" class="btn secondary" id="training-cancel-btn">Cancel</button>
          <button type="button" class="btn secondary" id="training-delete-btn" style="display: none;">Delete Record</button>
          <button type="submit" class="btn">Save Training Record</button>
        </div>
      </form>
    </div>
  </div>

<script>
  // --- PRE-INSPECTION (PIR) DATA DEFINITIONS (v2 - Enhanced for Email Generation) ---
// This block contains the definitions for all pre-inspection items.
// It has been updated with an `email_blurb` for each item to facilitate automatic email generation.
window.PIR_DEFINITIONS_DATA = [
    // EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Statement of purpose", 
        item_type: "file_only",
        description: "Upload your existing Statement of Purpose OR download and complete the official templates, then upload the finished document.",
        allow_upload: true,
        file_label: "Attached File",
        file_hint: "Uploading a new file will replace the existing one.",
        allow_templates: true,
        templates_bucket: "pir_templates",
        templates_prefix: "",
        templates: [
          { label: "Template – Part 1 (Provider)",   path: "20120418_100457_v2_00_statement_of_purpose_pt_1_for_pub_unprotected.doc" },
          { label: "Template – Part 2 (Aims & objectives)", path: "20120327_100457_v2_00_statement_of_purpose_pt_2_for_pub_unprotected.doc" },
          { label: "Template – Part 3 (Location)",  path: "20120418_100457_v2_00_statement_of_purpose_pt_3_for_pub_unprotected.doc" },
          { label: "Template – Part 4 (Registered manager)", path: "20120413_100457_v2_00_statement_of_purpose_pt_4_for_pub_unprotected.doc" }
        ],
        email_blurb: "Provides our Statement of Purpose, detailing the practice's aims, services, and patient population."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Copy of Major incident/business continuity", 
        item_type: "file_only",
        email_blurb: "Attached is our Major Incident and Business Continuity Plan."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Medical emergencies policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for handling medical emergencies within the practice."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Chaperone policy", 
        item_type: "file_only",
        email_blurb: "Attached is our Chaperone Policy for patient consultations."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Induction process", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Induction Structure: Describe the phases and timeline of your induction process for different staff roles (clinical, admin).", 
            "Key Content & Policies: What essential topics are covered (e.g., safeguarding, H&S, IPC, confidentiality, chaperone policy)?", 
            "Competency Assessment: How do you verify and document that new staff are competent and confident in their role at the end of the induction period?"
        ], 
        description: "Describe the process and/or attach the induction pack/checklist.",
        email_blurb: "Provides a summary of our staff induction process, with the induction pack attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Online services policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the provision and use of online patient services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Access policy", 
        item_type: "file_only",
        email_blurb: "Attached is our Patient Access Policy, detailing how patients can access our services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Registration policy (incl access to medical records)", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for patient registration and access to medical records."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Home visits/care home protocol", 
        item_type: "file_only",
        email_blurb: "Attached is our protocol for conducting home visits and supporting care homes."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for supporting carers", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Identification Strategy: How do you proactively identify patients who are carers?", 
            "Support & Signposting: What specific support is offered and which local/national services do you signpost to?", 
            "Recording & Flagging: How do you maintain an up-to-date carers' register in the clinical system?"
        ], 
        description: "Describe the process and attach any relevant leaflets or policies.",
        email_blurb: "Details our process for identifying and supporting carers, with relevant leaflets attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Number of carers identified and percentage", 
        item_type: "dual_number", 
        labels: ["Number Identified", "Percentage (%)"],
        email_blurb: "Provides the current number and percentage of identified carers on our patient list."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for bereaved patients", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Immediate Steps: What are the immediate administrative and clinical steps upon notification of a patient death?",
            "Family Communication: How and when do you make contact with the bereaved family, and what support is offered?",
            "Record Management: What is the process for updating and managing the deceased patient's records?",
            "Signposting: Which bereavement support services are patients and their families signposted to?",
            "Staff Support: How are staff who were involved in the patient's care supported?"
        ], 
        description: "Describe the process and attach any relevant protocols.",
        email_blurb: "Outlines our process for supporting bereaved patients and their families."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "ICO registration certificate", 
        item_type: "file_only",
        email_blurb: "Attached is our current ICO registration certificate."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Provider liability/MD insurance", 
        item_type: "file_only",
        email_blurb: "Attached is our certificate of provider liability/medical defence insurance."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Information leaflet for online services", 
        
        item_type: "file_only",
        email_blurb: "Attached is the information leaflet we provide to patients regarding our online services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Safety and drug alerts process and evidence of management and actions.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Receipt & Dissemination: How are alerts received and promptly distributed to all relevant staff?", 
            "Action & Responsibility: Who is the designated lead, and what is the process for actioning alerts and documenting in patient records?", 
            "Audit & Learning: How do you maintain a central log to track alerts, actions, and outcomes?"
        ], 
        description: "Describe the process and attach evidence (e.g., completed logs, screenshots).",
        email_blurb: "Details our process for managing safety and drug alerts, with evidence of actions attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy and process for ensuring staff are recruited safely including DBS and registration checks.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for safe staff recruitment, including DBS and registration checks."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy and process to ensure practice oversight of other staff not directly employed by the practice.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the oversight of non-practice staff with access to patients or records."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for supervision and competency oversight of clinical staff.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Supervision Framework: Describe your system for clinical supervision for different roles (e.g., Nurses, HCAs), including frequency and format.", 
            "Competency Assessment: How are competencies for advanced roles (e.g., prescribing) assessed, documented, and reviewed?", 
            "Governance & Record Keeping: Where are supervision and competency records kept and how do they inform appraisals?"
        ], 
        description: "Describe the process and attach any relevant policy.",
        email_blurb: "Outlines our process for clinical supervision and competency oversight, with the relevant policy attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy for ensuring PGDs and PSDs are appropriately reviewed and signed.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of PGDs and PSDs."
    },

    // EMAIL 2: TRAINING
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Number of current staff by role and WTE.", 
        item_type: "dynamic_table", 
        headers: ["Role", "Number of Staff", "WTE"],
        email_blurb: "Provides a breakdown of current staff by role and Whole Time Equivalent (WTE)."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "List of staff and their extended role(s).", 
        item_type: "dynamic_table", 
        headers: ["Staff Name", "Extended Role(s)"],
        email_blurb: "Provides a list of staff members and their designated extended roles."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Policy of training for staff and process to manage and monitor.", 
        item_type: "file_only",
        email_blurb: "Attached is our staff training policy, including our process for management and monitoring."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Matrix of staff training.", 
        item_type: "file_only",
        description: "Attach the training matrix which should include all mandatory and role-specific training.",
        email_blurb: "Attached is our comprehensive staff training matrix."
    },

    // EMAIL 3: SAFEGUARDING
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Safeguarding adults' policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the safeguarding of adults."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Safeguarding children policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the safeguarding of children."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Sample of minutes of MDT meetings", 
        item_type: "file_only",
        description: "Attach a recent, anonymised sample of MDT meeting minutes where safeguarding was discussed.",
        email_blurb: "Attached is a sample of minutes from multidisciplinary team meetings."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Policy/process to ensure information is shared with others.", 
        item_type: "file_only",
        description: "e.g. coding of medical records",
        email_blurb: "Attached is our policy on information sharing, including the coding of medical records."
    },

    // EMAIL 4: RISK ASSESSMENTS
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest fire risk assessment and any action log", 
        item_type: "file_only",
        email_blurb: "Attached is our latest fire risk assessment and corresponding action log."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence and date of fire extinguisher check", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of our latest fire extinguisher checks."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence of latest service for emergency lights and alarm test", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of the latest service for our emergency lights and fire alarm."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Copy of the latest fire drill and actions taken.", 
        item_type: "file_only",
        email_blurb: "Attached is the record of our latest fire drill and any actions taken."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Sample of weekly fire alarm checks", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the sample checks are provided (e.g., 'March 2025')."],
        description: "Attach the log of weekly fire alarm tests for the specified month.",
        email_blurb: "Attached is a sample of our weekly fire alarm checks for the month specified."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest health and safety risk assessment and any action log", 
        item_type: "file_only",
        email_blurb: "Attached is our latest health and safety risk assessment and action log."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest legionella assessment and sample water temperature checks", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the sample temperature checks are provided (e.g., 'March 2025')."],
        description: "Attach the latest full assessment and the water temperature logs for the specified month.",
        email_blurb: "Attached is our latest legionella risk assessment and sample water temperature checks."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Copy of any other general risk assessments.", 
        item_type: "file_only",
        description: "e.g. wheelchair access, monitoring of waiting areas etc.",
        email_blurb: "Attached are copies of other general risk assessments undertaken by the practice."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Equipment calibration dates and copy of certificate", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of our equipment calibration."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "PAT testing dates and copy of certificate", 
        item_type: "file_only",
        email_blurb: "Attached is our latest PAT testing certificate."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence of immunisation status of staff.", 
        item_type: "file_only",
        email_blurb: "Attached is evidence regarding the immunisation status of our staff."
    },

    // EMAIL 5: INFECTION PREVENTION AND CONTROL
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Name and role of IPC lead", 
        item_type: "dual_text", 
        labels: ["Name of Lead", "Role"],
        email_blurb: "Provides the name and role of our designated Infection Prevention and Control (IPC) lead."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Latest Infection control policy", 
        item_type: "file_only",
        email_blurb: "Attached is our latest Infection Prevention and Control policy."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Latest Infection prevention control audit and action log.", 
        item_type: "file_only",
        email_blurb: "Attached is our latest IPC audit and corresponding action log."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Copies of any meetings where IPC has been discussed", 
        item_type: "file_only",
        description: "Include any shared learning and changes since last inspection.",
        email_blurb: "Attached are minutes from meetings where IPC was discussed, showing shared learning."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Summary of vaccine fridge management", 
        item_type: "guided_questions", 
        questions: [
            "Policy & Responsibility: Who is the named lead for vaccine storage and what are the core principles of your cold chain policy?", 
            "Equipment & Location: How many vaccine fridges do you have, where are they located, and how are they maintained?", 
            "Monitoring & Recording: Describe your process for daily temperature monitoring, including logging and acceptable ranges.", 
            "Action on Excursion: What is the procedure for a cold chain incident?", 
            "Stock Management: How do you manage vaccine stock to ensure rotation and minimise wastage?"
        ],
        email_blurb: "Provides a summary of our vaccine fridge and cold chain management procedures."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Sample of vaccine fridge temperature recordings", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the temperature logs are provided (e.g., 'March 2025')."],
        description: "Attach the temperature recordings for the specified month.",
        email_blurb: "Attached are the vaccine fridge temperature recordings for the month specified."
    },

    // EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Significant events policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of significant events."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Complaint’s policy and leaflet available to patients", 
        item_type: "file_only",
        email_blurb: "Attached is our complaints policy and the accompanying patient information leaflet."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "A summary of significant events within the last 12 months", 
        item_type: "guided_questions_and_number", 
        questions: [
            "Process for Reporting & Grading: How are significant events (SEs) reported, recorded, and graded?", 
            "Investigation & Themes: Describe your investigation process. What were the main themes from events in the last 12 months?", 
            "Learning & Actions: What were the critical learning points and what specific changes have been implemented as a result?"
        ], 
        label: "Number of events (12 months)",
        email_blurb: "Provides a summary of significant events from the last 12 months, including learning and actions taken."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "A summary of complaints received within the last 12 months", 
        item_type: "guided_questions_and_number", 
        questions: [
            "Process for Handling Complaints: Briefly describe your complaints procedure, from receipt to final response.", 
            "Analysis & Themes: What were the main themes from complaints received in the last 12 months?", 
            "Service Improvement: What specific changes to services have been made in response to patient complaints?"
        ], 
        label: "Number of complaints (12 months)",
        email_blurb: "Provides a summary of complaints from the last 12 months, detailing themes and resulting improvements."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Sample meetings minutes where SEAs and/or complaints have been discussed.", 
        item_type: "file_only",
        description: "From the past 6 months.",
        email_blurb: "Attached is a sample of meeting minutes showing discussion of significant events and complaints."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Sample of compliments received in the past 6 months.", 
        item_type: "file_only",
        email_blurb: "Attached is a sample of compliments received from patients."
    },

    // EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Summary of the quality of care you provide for the six population groups", 
        item_type: "guided_questions", 
        questions: [
            "Older people: How do you tailor services for older people (e.g., proactive care, frailty assessments)?", 
            "People with long-term conditions: Describe your approach to managing patients with LTCs (e.g., recall systems, care planning).", 
            "Families, children and young people: How do you provide accessible services for this group (e.g., immunisation clinics, safeguarding)?", 
            "Working age people: How do you ensure access for working people (e.g., online services, extended hours)?", 
            "Vulnerable people: What provisions do you have for vulnerable groups (e.g., homeless, learning disabilities, carers)?", 
            "People experiencing poor mental health: Describe your approach to supporting patients with mental health needs (e.g., access to IAPT)."
        ],
        email_blurb: "Provides a summary of how we tailor our care for the six key population groups."
    },
    {
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK",
        title: "Summary of clinical audits (last 2 years)",
        item_type: "textarea",
        description: "Provide a summary list of clinical audits completed in the last two years and explain how you decide on audit topics.",
        email_blurb: "Provides a summary of clinical audit activity undertaken in the last two years."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Full Cycle Audit Example 1", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Audit Topic & Standard: What was the topic of the audit and what standard was measured against?",
            "Initial Findings: What were the results of the first data collection cycle?",
            "Changes Implemented: What specific changes were made to practice as a result of the findings?",
            "Re-Audit Results: What were the results of the second data collection cycle, and was there an improvement?"
        ],
        description: "Describe the audit and attach the full audit document as evidence.",
        email_blurb: "Details our first example of a completed two-cycle clinical audit, with the full report attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Full Cycle Audit Example 2", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Audit Topic & Standard: What was the topic of the audit and what standard was measured against?",
            "Initial Findings: What were the results of the first data collection cycle?",
            "Changes Implemented: What specific changes were made to practice as a result of the findings?",
            "Re-Audit Results: What were the results of the second data collection cycle, and was there an improvement?"
        ],
        description: "Describe the audit and attach the full audit document as evidence.",
        email_blurb: "Details our second example of a completed two-cycle clinical audit, with the full report attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Summary of any other quality improvement work undertaken over the last two years.", 
        item_type: "guided_questions", 
        questions: [
            "Project Overview: Describe any significant Quality Improvement (QI) projects undertaken that are not clinical audits.", 
            "Methodology & Outcomes: What QI methodology was used (e.g., PDSA) and what were the measured outcomes?", 
            "Learning & Sustainability: What was learned and how have the improvements been sustained?"
        ],
        email_blurb: "Provides a summary of other non-audit Quality Improvement (QI) work from the last two years."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Evidence of how you have responded to patient feedback (last 12 months).", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Collection Methods: What formal and informal methods do you use to gather patient feedback?", 
            "Analysis & Key Themes: Provide a summary of the key themes, both positive and negative, from patient feedback.", 
            "Action & 'You Said, We Did': Provide specific examples of changes made in direct response to patient feedback."
        ], 
        description: "Summarise and attach evidence (e.g., survey results, FFT data, action logs).",
        email_blurb: "Shows how we have collected, analysed, and acted upon patient feedback, with evidence attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Patient survey results and action log (if not included above)", 
        item_type: "file_only",
        email_blurb: "Attached are the results and action log from our own patient survey."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Evidence of how you have responded to staff feedback (last 12 months).", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Collection Methods: What mechanisms are in place for staff to provide feedback?", 
            "Analysis & Key Themes: What were the key themes from staff feedback over the last 12 months?", 
            "Action & Response: Provide specific examples of changes made in response to staff feedback."
        ], 
        description: "Summarise and attach evidence (e.g., staff survey results).",
        email_blurb: "Shows how we have collected, analysed, and acted upon staff feedback, with evidence attached."
    },

    // EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Discharge (medicine reconciliation) process and any audits/checks undertaken.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Process Workflow: Describe the end-to-end process from receiving a discharge summary to updating the patient's record.", 
            "Roles & Responsibilities: Who is responsible for each step of the process (e.g., admin, clinical pharmacist, GP)?", 
            "Quality Assurance: How do you audit compliance? Provide a summary of any recent audit findings."
        ], 
        description: "Describe the process and attach audits/checks.",
        email_blurb: "Details our process for medicine reconciliation following patient discharge, with recent audits attached."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Policy and process for the management of repeat prescriptions and medicine reviews.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of repeat prescriptions and medication reviews."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Patient summarising/coding in medical records policy/process and any audits.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "New Patient Record Summarising: Describe your process and target timeframe for summarising new patient records.", 
            "Clinical Correspondence Workflow: How is incoming correspondence processed, read, coded, and actioned?", 
            "Quality Assurance: What systems are in place to ensure coding is accurate, consistent, and timely?"
        ], 
        description: "Describe the process and attach audits/checks.",
        email_blurb: "Outlines our process for summarising and coding patient records, with recent audits attached."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Number of patient records that have not been fully summarised.", 
        item_type: "number", 
        label: "Number of records",
        email_blurb: "Provides the current number of patient records awaiting full summarisation."
    },

    // EMAIL 9: DATA FOR THE REPORT
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "NHS health checks data (last 12 months)", 
        item_type: "triple_number", 
        labels: ["Eligible", "Offered", "Completed"],
        email_blurb: "Provides our NHS Health Checks data for the last 12 months."
    },
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "Learning Disability check data (last 12 months)", 
        item_type: "triple_number", 
        labels: ["Eligible", "Offered", "Completed"],
        email_blurb: "Provides our Learning Disability Health Checks data for the last 12 months."
    },
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "Cervical cancer screening and child immunisation coverage data.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Cervical Screening Uptake Strategy: Describe the specific actions you have taken to improve cervical screening uptake.", 
            "Childhood Immunisation Uptake Strategy: Describe the specific actions you have taken to improve childhood immunisation rates.", 
            "Data & Outcomes: What has been the impact of these actions on your uptake data?"
        ], 
        description: "Summarise actions and attach coverage data.",
        email_blurb: "Provides our latest uptake data for cervical screening and childhood immunisations, along with actions taken to improve coverage."
    },
];

</script>

  
  <div id="crud-modal" class="auth" aria-hidden="true">
    <div class="card" style="width:min(620px,95vw)">
      <h2 id="crud-title">Edit</h2>
      <form id="crud-form">
        <div id="crud-fields"></div>
        <div style="display:flex; gap:8px; margin-top:12px">
          <button type="submit" class="btn" id="crud-save">Save</button>
          <button type="button" class="btn secondary" id="crud-cancel">Cancel</button>
          <button type="button" class="btn secondary" id="crud-delete" style="margin-left:auto; background:#ff6b6b33; border:1px solid #ff6b6b55">Delete</button>
        </div>
        <div class="error" id="crud-error" role="alert"></div>
      </form>
    </div>
  </div>
  
  <div id="submission-detail-modal" class="auth" aria-hidden="true">
    <div class="card" style="width:min(800px, 95vw)">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="submission-detail-title" style="margin:0;">Submission Details</h2>
        <button id="submission-detail-close" class="btn secondary" style="padding: 6px; line-height: 0;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div class="hint">Click on a row to amend the check type or comment.</div>
      <div id="submission-detail-content" style="margin-top:12px;"></div>
    </div>
  </div>
  <script>

  // Instrument file selection and upload points if present
  (function instrumentDebugging(){
    const fileInput = document.getElementById('field-attachment');
    if(fileInput){
      fileInput.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        debugLog('file selected', f ? { name: f.name, size: f.size, type: f.type } : 'no-file');
      });
    }

    // Hook into save button to dump pendingAttachment
    const saveBtn = document.getElementById('crud-save');
    if(saveBtn){
      saveBtn.addEventListener('click', ()=>{
        debugLog('Save clicked. pendingAttachment', window.crudState ? window.crudState.pendingAttachment : null);
      });
    }

    // AI Populate logic for complaints form (using event delegation for dynamic buttons)
    (function(){
      function setStatus(statusEl, msg){ if(statusEl) statusEl.textContent = msg || ''; }
      function getEl(...selectors){ for(const s of selectors){ const el=document.querySelector(s); if(el) return el; } return null; }

      // Use event delegation to handle dynamically created AI buttons
      document.addEventListener('click', async function(event) {
        if (!event.target.classList.contains('ai-populate-btn')) return;
        
        const btn = event.target;
        const btnId = btn.id;
        const statusId = btnId.replace('ai-populate-btn-', 'ai-status-');
        const statusEl = document.getElementById(statusId);
        
        // Find the associated file input - extract field ID from button ID
        const fieldId = btnId.replace('ai-populate-btn-', '');
        const fileInput = document.getElementById(fieldId);
        
        debugLog('AI button clicked', {buttonId: btnId, fieldId: fieldId, fileInputFound: !!fileInput, hasFiles: fileInput?.files?.length > 0});
        
        if (!fileInput || !fileInput.files.length){
          setStatus(statusEl, 'Choose a file first.'); 
          debugLog('No file input or files found', {fileInput: !!fileInput, filesLength: fileInput?.files?.length});
          return;
        }
        
        const file = fileInput.files[0];
        debugLog('AI button clicked', {buttonId: btnId, fileName: file.name, fileSize: file.size});
        
        // Get form field elements
        const elDate = getEl('#field-complaint_date');
        const elPatient = getEl('#field-patient_initials');
        const elAge = getEl('#field-age');
        const elSummary = getEl('#field-complaint_summary');
        const elOrig = getEl('#field-original_complaint');
        const elResp = getEl('#field-response');
        const elLessons = getEl('#field-lessons_learned');
        const elCategory = getEl('#field-category');
        const elCategoryTrends = getEl('#field-category_trends');
        const elSolution = getEl('#field-solution_given');
        const elSuggestions = getEl('#field-suggestions_prevent_reoccurrence');
        const elActions = getEl('#field-actions_to_be_taken');
        const elPeopleInvolved = getEl('#field-people_involved');
        const elAvenue = getEl('#field-avenue_used');
        const elStatus = getEl('#field-status');
        const elPriority = getEl('#field-priority');
        const elResponseSent = getEl('#field-response_sent');
        const elCreatedBy = getEl('#field-created_by');

        btn.disabled = true; 
        setStatus(statusEl, 'Processing…');
        
        try {
          let textContent = '';
          
          // Extract text based on file type
          if (file.type === 'text/plain') {
            textContent = await file.text();
            debugLog('Text file processed', {length: textContent.length});
          } else if (file.type === 'application/pdf') {
            setStatus(statusEl, 'Extracting text from PDF…');
            try {
              const arrayBuffer = await file.arrayBuffer();
              const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
              debugLog('PDF loaded', {numPages: pdf.numPages});
              
              let pdfText = '';
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                pdfText += pageText + '\n';
              }
              textContent = pdfText.trim();
              debugLog('PDF text extracted', {length: textContent.length});
            } catch (pdfError) {
              debugLog('PDF extraction error', pdfError);
              setStatus(statusEl, 'Error extracting text from PDF. Try a text file instead.');
              btn.disabled = false;
              return;
            }
          } else if (file.type.includes('word') || file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
            setStatus(statusEl, 'Word document processing - please use PDF or text files');
            btn.disabled = false;
            return;
          } else {
            setStatus(statusEl, 'Please upload a PDF or text (.txt) file for AI processing.');
            btn.disabled = false;
            return;
          }
          
          if (!textContent || textContent.length < 10) {
            setStatus(statusEl, 'File appears to be empty or too short.');
            btn.disabled = false;
            return;
          }
          
          debugLog('Calling extract-complaint function', {textLength: textContent.length});
          setStatus(statusEl, 'Calling AI service…');
          
          const { data, error } = await supabase.functions.invoke('extract-complaint', { 
            body: { text: textContent }
          });
          
          debugLog('AI function response', {data, error});
          
          if (error) {
            debugLog('AI function error', error);
            throw error;
          }
          
          if (!data || !data.success) {
            const errorMsg = data?.error || 'Unknown error from AI service';
            debugLog('AI service error', errorMsg);
            throw new Error(errorMsg);
          }
          
          const d = data.data || {};
          debugLog('AI extracted data', d);
          debugLog('Form elements found', {
            date: !!elDate,
            patient: !!elPatient,
            age: !!elAge,
            summary: !!elSummary,
            original: !!elOrig,
            response: !!elResp,
            lessons: !!elLessons,
            category: !!elCategory,
            categoryTrends: !!elCategoryTrends,
            solution: !!elSolution,
            suggestions: !!elSuggestions,
            actions: !!elActions,
            peopleInvolved: !!elPeopleInvolved,
            avenue: !!elAvenue,
            status: !!elStatus,
            priority: !!elPriority,
            responseSent: !!elResponseSent,
            createdBy: !!elCreatedBy
          });
          
          // Populate all form fields
          if (elDate && d.complaint_date) {
            elDate.value = d.complaint_date;
            debugLog('Populated complaint date', d.complaint_date);
          }
          if (elPatient && d.patient_initials) {
            elPatient.value = d.patient_initials;
            debugLog('Populated patient initials', d.patient_initials);
          }
          if (elAge && d.age) {
            elAge.value = d.age;
            debugLog('Populated age', d.age);
          }
          if (elSummary && d.complaint_summary) {
            elSummary.value = d.complaint_summary;
            debugLog('Populated summary', d.complaint_summary);
          }
          if (elOrig && d.original_complaint) {
            elOrig.value = d.original_complaint;
            debugLog('Populated original complaint', d.original_complaint);
          }
          if (elResp && d.response) {
            elResp.value = d.response;
            debugLog('Populated response', d.response);
          }
          if (elLessons && d.lessons_learned) {
            elLessons.value = d.lessons_learned;
            debugLog('Populated lessons learned', d.lessons_learned);
          }
          if (elCategory && d.category) {
            elCategory.value = d.category;
            debugLog('Populated category', d.category);
          }
          if (elCategoryTrends && d.category_trends) {
            elCategoryTrends.value = d.category_trends;
            debugLog('Populated category trends', d.category_trends);
          }
          if (elSolution && d.solution_given) {
            elSolution.value = d.solution_given;
            debugLog('Populated solution given', d.solution_given);
          }
          if (elSuggestions && d.suggestions_prevent_reoccurrence) {
            elSuggestions.value = d.suggestions_prevent_reoccurrence;
            debugLog('Populated suggestions', d.suggestions_prevent_reoccurrence);
          }
          if (elActions && d.actions_to_be_taken) {
            elActions.value = d.actions_to_be_taken;
            debugLog('Populated actions', d.actions_to_be_taken);
          }
          if (elAvenue && d.avenue_used) {
            elAvenue.value = d.avenue_used;
            debugLog('Populated avenue used', d.avenue_used);
          }
          if (elStatus && d.status) {
            elStatus.value = d.status;
            debugLog('Populated status', d.status);
          }
          if (elPriority && d.priority) {
            elPriority.value = d.priority;
            debugLog('Populated priority', d.priority);
          }
          if (elResponseSent && typeof d.response_sent === 'boolean') {
            elResponseSent.checked = d.response_sent;
            debugLog('Populated response sent', d.response_sent);
          }
          // Set created_by to current user
          if (elCreatedBy && ctx.user && ctx.user.id) {
            elCreatedBy.value = ctx.user.id;
            debugLog('Set created_by to current user', ctx.user.id);
          }
          // Handle people_involved (multi-select field)
          if (elPeopleInvolved && d.people_involved && Array.isArray(d.people_involved)) {
            // For multi-select, we'd need to match names to IDs from the staff list
            debugLog('People involved names extracted', d.people_involved);
            // Note: Actual ID mapping would require matching against kiosk_users table
          }
          
          setStatus(statusEl, '✓ Filled by AI — please review.');
          debugLog('Form populated successfully');
          
        } catch(e) {
          console.error('AI processing error:', e); 
          debugLog('AI error details', {message: e.message, stack: e.stack, error: e});
          setStatus(statusEl, 'AI error: ' + (e.message || e));
        } finally { 
          btn.disabled = false; 
        }
      });
    })();

  })();

  </script>
  
  <!-- Help Modal -->
  <div id="help-modal" class="help-modal">
    <div class="help-modal-content">
      <div class="help-modal-header">
        <h3 id="help-modal-title" class="help-modal-title">Page Help</h3>
        <button id="help-modal-close" class="help-modal-close">✕</button>
      </div>
      <div id="help-modal-body" class="help-modal-body">
        <!-- Content populated by JavaScript -->
      </div>
    </div>
  </div>
  
 </body>
 </html>
  <script>
    // === Quiz: Raw Supabase Table Renderer ===
    (function(){
      function escapeHtml(str){
        return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      }

      async function loadQuizRawTable(){
        const thead = document.getElementById('quiz-thead');
        const tbody = document.getElementById('quiz-tbody');
        if(!thead || !tbody){ return; }
        tbody.innerHTML = '<tr><td colspan="999" class="muted">Loading…</td></tr>';
        try{
          let query = supabase.from('quiz_questions').select('*');
          if(window.ctx && ctx.site_id){ query = query.eq('site_id', ctx.site_id); }
          const { data, error } = await query;
          if(error) throw error;
          const rows = Array.isArray(data) ? data : [];

          // Build columns dynamically from union of keys
          const keys = rows.length ? Array.from(new Set(rows.flatMap(r => Object.keys(r)))) : [];
          if(keys.length === 0){
            thead.innerHTML = '<tr><th class="muted">No columns</th></tr>';
            tbody.innerHTML = '<tr><td class="muted">No rows</td></tr>';
          } else {
            thead.innerHTML = '<tr>' + keys.map(k => `<th>${escapeHtml(k)}</th>`).join('') + '</tr>';
            tbody.innerHTML = rows.map(r => {
              return '<tr>' + keys.map(k => `<td>${escapeHtml(r[k] ?? '')}</td>`).join('') + '</tr>';
            }).join('');
          }

          // Update badge with count
          const badge = document.getElementById('badge-quiz');
          if(badge){ badge.textContent = rows.length ? String(rows.length) : ''; }
        }catch(err){
          console.error(err);
          thead.innerHTML = '';
          tbody.innerHTML = `<tr><td colspan="999" class="muted">Error: ${escapeHtml(err?.message || err)}</td></tr>`;
        }
      }

      // Load when the Quiz nav button is clicked
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('btn-quiz-refresh')?.addEventListener('click', loadQuizRawTable);

        const quizBtn = document.querySelector('nav [data-section="quiz"]');
        quizBtn?.addEventListener('click', () => setTimeout(loadQuizRawTable, 30));

        // Also observe the section becoming active (covers programmatic routing)
        const view = document.getElementById('view-quiz');
        if(view){
          const obs = new MutationObserver(() => {
            if(view.classList.contains('active') && !view.dataset._loaded){
              view.dataset._loaded = '1';
              loadQuizRawTable();
            }
          });
          obs.observe(view, { attributes:true, attributeFilter:['class'] });

          // If already active on load, render immediately
          if(view.classList.contains('active')){ loadQuizRawTable(); }
        }
      });

      // Expose for console/debug
      window.loadQuizRawTable = loadQuizRawTable;
    })();

    // Preview modal functions
    function showPdfPreview(fileUrl, fileName) {
        // Create preview modal if it doesn't exist
        let previewModal = document.getElementById('pdf-preview-modal');
        if (!previewModal) {
            previewModal = document.createElement('div');
            previewModal.id = 'pdf-preview-modal';
            previewModal.className = 'modal';
            previewModal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
                    <div class="modal-header">
                        <h3>Document Preview: <span id="preview-file-name"></span></h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body" style="height: 80vh; padding: 0;">
                        <iframe id="pdf-viewer" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </div>
            `;
            document.body.appendChild(previewModal);

            // Close modal handlers
            previewModal.addEventListener('click', (e) => {
                if (e.target === previewModal || e.target.classList.contains('modal-close')) {
                    previewModal.classList.remove('show');
                    URL.revokeObjectURL(document.getElementById('pdf-viewer').src);
                }
            });
        }

        document.getElementById('preview-file-name').textContent = fileName;
        document.getElementById('pdf-viewer').src = fileUrl;
        previewModal.classList.add('show');
    }

    function showDocumentMetadata(fileName, fileSize) {
        const formatFileSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const getFileType = (name) => {
            const ext = name.split('.').pop().toLowerCase();
            const types = {
                'doc': 'Word Document',
                'docx': 'Word Document',
                'xls': 'Excel Spreadsheet', 
                'xlsx': 'Excel Spreadsheet',
                'ppt': 'PowerPoint Presentation',
                'pptx': 'PowerPoint Presentation'
            };
            return types[ext] || 'Document';
        };

        showToast(`📄 ${getFileType(fileName)} - ${formatFileSize(fileSize)}\nClick Download to open`, 'info');
    }

    // Initialize all PIR enhancements when document loads
    document.addEventListener('DOMContentLoaded', () => {
        initializeDraftTextSupport();
        
        // Initialize bulk operations toggle
        const bulkToggle = document.getElementById('bulk-select-toggle');
        if (bulkToggle) {
            bulkToggle.addEventListener('change', () => {
                document.getElementById('pre-inspection-view').classList.toggle('bulk-mode', bulkToggle.checked);
            });
        }
    });

    // PDF Preview and Document Metadata Functions
    function showPdfPreview(fileUrl, fileName) {
      // Create modal for PDF preview
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.zIndex = '2000';
      modal.innerHTML = `
        <div class="modal-content" style="width: 90vw; height: 90vh; max-width: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3>Preview: ${fileName}</h3>
            <button class="btn secondary modal-close">×</button>
          </div>
          <iframe src="${fileUrl}" style="width: 100%; height: calc(90vh - 100px); border: 1px solid var(--border-color); border-radius: 8px;"></iframe>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.classList.add('show');
      
      // Close handlers
      modal.querySelector('.modal-close').addEventListener('click', () => {
        modal.remove();
        URL.revokeObjectURL(fileUrl);
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
          URL.revokeObjectURL(fileUrl);
        }
      });
    }

    function showDocumentMetadata(fileName, fileSize) {
      const fileSizeFormatted = (fileSize / 1024).toFixed(1) + ' KB';
      const fileExtension = fileName.split('.').pop().toUpperCase();
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.zIndex = '2000';
      modal.innerHTML = `
        <div class="modal-content" style="width: min(400px, 90vw);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3>Document Information</h3>
            <button class="btn secondary modal-close">×</button>
          </div>
          <div class="field">
            <label>File Name</label>
            <div style="padding: 8px 0; word-break: break-all;">${fileName}</div>
          </div>
          <div class="field">
            <label>File Type</label>
            <div style="padding: 8px 0;">${fileExtension} Document</div>
          </div>
          <div class="field">
            <label>File Size</label>
            <div style="padding: 8px 0;">${fileSizeFormatted}</div>
          </div>
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); color: var(--muted); font-size: 12px;">
            💡 To preview ${fileExtension} files, download and open in the appropriate application.
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.classList.add('show');
      
      // Close handlers
      modal.querySelector('.modal-close').addEventListener('click', () => {
        modal.remove();
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // Initialize draft text support when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      initializeDraftTextSupport();
    });

    // Initialize if DOM is already ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeDraftTextSupport);
    } else {
      initializeDraftTextSupport();
    }

  </script>

<script>
// Sidebar resize functionality
document.addEventListener('DOMContentLoaded', () => {
  const sidebar = document.getElementById('sidebar');
  const app = document.getElementById('app');
  const resizeHandle = document.getElementById('sidebar-resize-handle');
  const toggleButton = document.getElementById('toggleSidebar');
  
  let isResizing = false;
  let startX = 0;
  let startWidth = 0;
  const minWidth = 56; // Collapsed width
  const maxWidth = 400; // Maximum sidebar width
  const defaultWidth = 260; // Default sidebar width
  
  // Get current sidebar width from CSS variable
  function getCurrentSidebarWidth() {
    const computedStyle = getComputedStyle(app);
    const sidebarWidth = computedStyle.getPropertyValue('--sidebarW');
    return parseInt(sidebarWidth) || defaultWidth;
  }
  
  // Set sidebar width with optional transition control
  function setSidebarWidth(width, enableTransition = true) {
    // Disable transitions during drag for smoothness
    if (!enableTransition) {
      app.style.transition = 'none';
    } else {
      app.style.transition = '';
    }
    
    app.style.setProperty('--sidebarW', width + 'px');
    
    // Auto-collapse when dragged to minimum width
    if (width <= minWidth) {
      app.classList.add('collapsed');
      toggleButton.setAttribute('aria-expanded', 'false');
    } else if (app.classList.contains('collapsed')) {
      app.classList.remove('collapsed');
      toggleButton.setAttribute('aria-expanded', 'true');
    }
  }
  
  // Throttle function for smooth resize
  function throttle(func, limit) {
    let inThrottle;
    return function() {
      const args = arguments;
      const context = this;
      if (!inThrottle) {
        func.apply(context, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    }
  }
  
  // Optimized resize handler
  const handleResize = throttle((e) => {
    if (!isResizing) return;
    
    const deltaX = e.clientX - startX;
    const newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
    
    setSidebarWidth(newWidth, false); // Disable transition during drag
  }, 16); // ~60fps
  
  // Mouse down on resize handle
  resizeHandle.addEventListener('mousedown', (e) => {
    isResizing = true;
    startX = e.clientX;
    startWidth = getCurrentSidebarWidth();
    
    // Prevent text selection during resize
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'ew-resize';
    
    // Add resizing class for additional styling if needed
    app.classList.add('is-resizing');
    
    e.preventDefault();
  });
  
  // Mouse move - resize sidebar
  document.addEventListener('mousemove', handleResize);
  
  // Mouse up - stop resizing
  document.addEventListener('mouseup', () => {
    if (isResizing) {
      isResizing = false;
      document.body.style.userSelect = '';
      document.body.style.cursor = '';
      
      // Re-enable transitions
      app.classList.remove('is-resizing');
      setSidebarWidth(getCurrentSidebarWidth(), true);
      
      // Save the new width to localStorage for persistence
      const currentWidth = getCurrentSidebarWidth();
      if (currentWidth > minWidth) {
        localStorage.setItem('sidebarWidth', currentWidth);
      }
    }
  });
  
  // Touch support for mobile devices
  const handleTouchResize = throttle((e) => {
    if (!isResizing || e.touches.length !== 1) return;
    
    const touch = e.touches[0];
    const deltaX = touch.clientX - startX;
    const newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
    
    setSidebarWidth(newWidth, false);
  }, 16);
  
  resizeHandle.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
      const touch = e.touches[0];
      isResizing = true;
      startX = touch.clientX;
      startWidth = getCurrentSidebarWidth();
      app.classList.add('is-resizing');
      e.preventDefault();
    }
  });
  
  document.addEventListener('touchmove', handleTouchResize);
  
  document.addEventListener('touchend', () => {
    if (isResizing) {
      isResizing = false;
      app.classList.remove('is-resizing');
      setSidebarWidth(getCurrentSidebarWidth(), true);
      
      const currentWidth = getCurrentSidebarWidth();
      if (currentWidth > minWidth) {
        localStorage.setItem('sidebarWidth', currentWidth);
      }
    }
  });
  
  // Restore saved sidebar width and collapsed state on page load
  const savedWidth = localStorage.getItem('sidebarWidth');
  const savedCollapsed = localStorage.getItem('cl_sidebar_collapsed');
  
  if (savedCollapsed === '1') {
    // Restore collapsed state
    app.classList.add('collapsed');
    sidebar.classList.add('collapsed');
    toggleButton.setAttribute('aria-expanded', 'false');
    setSidebarWidth(minWidth);
  } else if (savedWidth) {
    // Restore saved width
    const width = parseInt(savedWidth);
    if (width >= minWidth && width <= maxWidth) {
      setSidebarWidth(width);
    }
  }
  
  // Modify the existing toggle button behavior to work with resize
  toggleButton.addEventListener('click', function() {
    if (app.classList.contains('collapsed')) {
      // Expanding - restore to saved width or default
      const savedWidth = localStorage.getItem('sidebarWidth');
      const targetWidth = savedWidth ? parseInt(savedWidth) : defaultWidth;
      setSidebarWidth(targetWidth);
      app.classList.remove('collapsed');
      sidebar.classList.remove('collapsed');
      toggleButton.setAttribute('aria-expanded', 'true');
    } else {
      // Collapsing - save current width first
      const currentWidth = getCurrentSidebarWidth();
      if (currentWidth > minWidth) {
        localStorage.setItem('sidebarWidth', currentWidth);
      }
      setSidebarWidth(minWidth);
      app.classList.add('collapsed');
      sidebar.classList.add('collapsed');
      toggleButton.setAttribute('aria-expanded', 'false');
    }
    
    // Save collapsed state to localStorage
    try{ 
      localStorage.setItem("cl_sidebar_collapsed", app.classList.contains("collapsed") ? "1" : "0"); 
    } catch(_) {}
  });
});

// Help system functionality
const pageHelp = {
  'view-dashboard': {
    title: 'Dashboard Overview',
    content: 'Your central command center providing a comprehensive overview of your practice\'s CQC readiness. Monitor key metrics, view upcoming tasks, track compliance status, and quickly access areas that need attention. The dashboard displays real-time data across all compliance areas including training, safety checks, and documentation status.'
  },
  'view-pre-inspection': {
    title: 'Pre-Inspection Readiness',
    content: 'When CQC announces an inspection, you have just two weeks notice. This page helps you prepare the required documentation packages quickly and efficiently. Upload and organize documents into the nine email packages that CQC requires, ensure all information is current and relevant, then export everything with a single click. Stay inspection-ready with organized, up-to-date documentation.'
  },
  'view-training': {
    title: 'Mandatory Training Management',
    content: 'Manage all staff training requirements and certifications in one place. Track completion dates, monitor upcoming renewals, and ensure all mandatory training is current. Upload certificates, set expiry reminders, and maintain compliance with CQC training standards. Generate training matrices and reports for inspection purposes.'
  },
  'view-users': {
    title: 'User Management',
    content: 'Manage staff accounts, roles, and permissions for your CheckLoop system. Add new team members, assign appropriate access levels (Admin or Staff), and maintain security by managing user credentials. Control who can access sensitive compliance data and administrative functions.'
  },
  'view-calendar': {
    title: 'Compliance Calendar',
    content: 'Visual overview of all compliance-related activities, deadlines, and scheduled tasks. Track safety checks, training renewals, equipment servicing, and other time-sensitive compliance activities. Never miss critical deadlines with automated reminders and clear visual indicators of upcoming requirements.'
  },
  'view-complaints-dashboard': {
    title: 'Complaints Dashboard',
    content: 'Monitor and analyze complaint trends, response times, and resolution patterns. CQC expects excellent complaint handling with swift responses and clear resolution processes. Track active complaints, view resolution statistics, and ensure you meet the required response timeframes for regulatory compliance.'
  },
  'view-complaints-reporting': {
    title: 'Complaints Reporting',
    content: 'Report and document new complaints with detailed information capture. Record complaint details, assign responsibility, track investigation progress, and document resolutions. Maintain comprehensive records that demonstrate proper complaint handling procedures to CQC inspectors.'
  },
  'view-items': {
    title: 'Equipment & Asset Management',
    content: 'Maintain detailed records of all practice equipment, medical devices, and assets. Track serial numbers, maintenance schedules, calibration dates, and warranty information. Ensure all equipment meets safety standards and compliance requirements for CQC inspections.'
  },
  'view-rooms': {
    title: 'Room & Location Management',
    content: 'Organize and manage different areas within your practice. Define rooms, assign equipment and staff, track room-specific compliance requirements, and maintain location-based safety and maintenance records. Essential for practices with multiple consultation rooms or specialized treatment areas.'
  },
  'view-checktypes': {
    title: 'Check Type Configuration',
    content: 'Define and customize the types of safety checks, equipment tests, and compliance verifications required in your practice. Set up standardized check procedures, assign frequencies, and create templates to ensure consistent compliance monitoring across all areas of your practice.'
  },
  'view-schedules': {
    title: 'Compliance Schedules',
    content: 'Create and manage recurring schedules for safety checks, equipment maintenance, training renewals, and other compliance activities. Automate routine tasks with intelligent scheduling that adapts to your practice needs and ensures nothing is overlooked.'
  },
  'view-staff': {
    title: 'Staff Records',
    content: 'Comprehensive staff management including personal details, qualifications, training records, and compliance status. Maintain complete staff files with DBS checks, professional registrations, emergency contacts, and role-specific requirements. Essential for CQC staff-related compliance.'
  },
  'view-submissions': {
    title: 'Compliance Submissions',
    content: 'Track all submissions made to regulatory bodies, insurance companies, and other organizations. Maintain records of when documents were submitted, to whom, and for what purpose. Monitor response status and maintain audit trails for regulatory compliance.'
  },
  'view-settings': {
    title: 'System Configuration',
    content: 'Configure CheckLoop settings to match your practice requirements. Set up notification preferences, customize compliance thresholds, manage data retention policies, and configure integrations with other systems. Tailor the system to your specific operational needs.'
  },
  'view-quiz': {
    title: 'Quiz Management',
    content: 'Create and manage training quizzes and assessments for staff competency verification. Design custom questions, set pass marks, track completion rates, and generate competency reports. Ensure staff understand policies and procedures through regular assessment.'
  }
};

function showHelp(viewId) {
  const modal = document.getElementById('help-modal');
  const title = document.getElementById('help-modal-title');
  const body = document.getElementById('help-modal-body');
  
  const helpData = pageHelp[viewId];
  if (helpData) {
    title.textContent = helpData.title;
    body.textContent = helpData.content;
    modal.classList.add('show');
  }
}

function hideHelp() {
  document.getElementById('help-modal').classList.remove('show');
}

// Event listeners for help modal
document.getElementById('help-modal-close').addEventListener('click', hideHelp);
document.getElementById('help-modal').addEventListener('click', function(e) {
  if (e.target === this) hideHelp();
});

// Escape key closes modal
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('help-modal').classList.contains('show')) {
    hideHelp();
  }
});
</script>

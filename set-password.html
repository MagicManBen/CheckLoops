<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Your Password</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg1: #0b4fb3;
            --bg2: #062b6f;
            --glass: #ffffff12;
            --white: #e6f0ff;
            --ink: #eaf1ff;
            --accent: #76a7ff;
            --danger: #ff6b6b;
            --shadow: 0 10px 30px rgba(6, 43, 111, .35);
            --panel-bg: linear-gradient(145deg, #133b8a, #0c275e);
            --border-color: #ffffff1f;
        }
        body {
            margin: 0;
            font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            color: var(--ink);
            background: #0b3a86;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 32px;
            width: min(420px, 90vw);
            text-align: center;
        }
        h2 {
            margin: 0 0 16px;
            font-weight: 700;
        }
        .field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 16px 0;
            text-align: left;
        }
        input {
            all: unset;
            background: #ffffff17;
            border: 1px solid #ffffff24;
            padding: 12px;
            border-radius: 12px;
        }
        .btn {
            all: unset;
            padding: 12px 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #7db1ff, #4f89ff);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
        }
        .message {
            font-size: 14px;
            margin-top: 16px;
            padding: 10px;
            border-radius: 8px;
        }
        .error {
            background: #ff6b6b22;
            color: var(--danger);
        }
        .success {
            background: #2bd4a722;
            color: #2bd4a7;
        }
    </style>
</head>
<body>

    <div class="card">
        <h2>Set Your Password</h2>
        <p>Welcome! Create a password to finish setting up your account.</p>
        <form id="password-form">
            <div class="field">
                <label for="password">New Password</label>
                <input type="password" id="password" required>
            </div>
            <div class="field">
                <label for="confirm-password">Confirm Password</label>
                <input type="password" id="confirm-password" required>
            </div>
            <button type="submit" class="btn">Set Password and Sign In</button>
        </form>
        <div id="message" class="message" style="display: none;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient('https://unveoqnlqnobufhublyw.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTkyMDIxMjQsImV4cCI6MjAxNDc3ODEyNH0.J4j2A69e_1Jj2s_n-2A423Gs-CV_lXG3i3Gf_Jj-5kI');
        
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const messageDiv = document.getElementById('message');
        let sessionActive = false;

        // Function to display messages
        function showMessage(message, type = 'error') {
            messageDiv.textContent = message;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
        }

        // Handle the password update form submission
        passwordForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (!sessionActive) {
                showMessage('Your session is not active. Please use the invitation link again.');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('Passwords do not match.');
                return;
            }

            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long.');
                return;
            }

            try {
                showMessage('Setting password...', 'success');
                
                const { data, error } = await supabaseClient.auth.updateUser({ 
                    password: password 
                });

                if (error) {
                    console.error('Password update error:', error);
                    showMessage(`Error setting password: ${error.message}`);
                } else {
                    console.log('Password updated successfully:', data);
                    showMessage('Password set successfully! Redirecting you to the dashboard...', 'success');
                    
                    // Redirect to the main application after a short delay
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            } catch (err) {
                console.error('Unexpected error:', err);
                showMessage('An unexpected error occurred. Please try again.');
            }
        });

        // Listen for auth state changes. Supabase client automatically
        // detects the session from the URL fragment.
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth Event:', event, session);
            if (event === 'INITIAL_SESSION' && !session) {
                // This happens on page load if there's no session in storage and no auth fragment in URL
                showMessage('No active session found. Please click the link from your invitation email again, or make sure you are accessing this page from the same browser where you clicked the email link.');
                sessionActive = false;
            } else if (event === 'SIGNED_IN') {
                // This happens when the user is redirected from the invite link.
                // The Supabase client has processed the URL fragment and created a session.
                showMessage('Authentication successful! You can now set your password.', 'success');
                sessionActive = true;
            } else if (event === 'SIGNED_OUT') {
                showMessage('Your session has expired or you have signed out. Please use the invitation link again.');
                sessionActive = false;
            }
        });

    </script></body>
</html>
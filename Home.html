<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sign In — CheckLoop</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="config.js"></script>
<style>
  :root{
    --bg1:#0b4fb3; --bg2:#062b6f; --glass:#ffffff12; --glass-2:#ffffff1a;
    --white:#e6f0ff; --muted:#b8c7e8; --ink:#eaf1ff;
    --accent:#76a7ff; --accent-2:#5f96ff; --success:#2bd4a7; --danger:#ff6b6b;
    --shadow: 0 10px 30px rgba(6,43,111,.35);
    --round:18px;
    --panel-bg: linear-gradient(145deg, #133b8a, #0c275e);
    --border-color: #ffffff1f;
  }
  *{box-sizing:border-box}
  html,body{height:100%}

  /* Page background copied from index.html for consistent palette */
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--ink);
    background: linear-gradient(180deg, #0e3f93 0%, #082a69 100%);
    overflow-x:hidden;
    min-height:100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Silky animated background matching index.html */
  .bg{
    position:fixed; inset:0; z-index:-1; overflow:hidden; background: radial-gradient(1200px 700px at 20% -10%, #6aa0ff33, transparent),
      radial-gradient(900px 600px at 90% 10%, #3566ff2e, transparent),
      linear-gradient(180deg, #0e3f93 0%, #082a69 100%);
  }
  .wave{
    position:absolute; width:160%; height:160%; left:-30%; top:-30%;
    background: conic-gradient(from 180deg at 50% 50%, #2c63ff22, #143a9622, #2c63ff22);
    filter: blur(60px);
    animation: drift 22s ease-in-out infinite alternate;
    transform-origin: 50% 50%;
  }
  .wave2{ animation-duration: 28s; mix-blend-mode: screen; }
  @keyframes drift{ 0%{ transform: rotate(0deg) scale(1.0); } 100%{ transform: rotate(25deg) scale(1.08); } }

  /* Centering container */
  .card-wrap{ display:flex; justify-content:center; align-items:center; height:100vh; padding:24px; }

  .card{
    background: var(--panel-bg);
    border:1px solid var(--border-color);
    border-radius:20px;
    box-shadow:var(--shadow);
    padding:28px 32px;
    width: min(460px, 92vw);
    color: var(--white);
    backdrop-filter: blur(6px);
  }

  .brand .t{ font-weight:800; color:var(--white); margin-bottom:8px }
  .card h2{ margin:4px 0 12px; font-size:24px; color:var(--white); }
  .hint{ font-size:13px; color:var(--muted); margin-bottom:10px }

  .field{ display:flex; flex-direction:column; gap:8px; margin:12px 0; }
  .field label{ font-weight:600; font-size:13px; color:var(--muted) }
  .field input{ all:unset; background:#ffffff12; border:1px solid #ffffff14; padding:12px 14px; border-radius:12px; color:var(--white); }
  .field input:focus{ border-color:var(--accent); box-shadow:0 0 0 4px #76a7ff22; }

  .extra-options{ display:flex; justify-content:space-between; align-items:center; margin-top:8px; }
  .extra-options label{ color:var(--muted); font-size:13px }
  .extra-options a{ color:var(--muted); text-decoration:none }
  .extra-options a:hover{ color:var(--white); text-decoration:underline }

  .btn{ all:unset; display:block; width:100%; text-align:center; padding:12px; border-radius:12px; background:linear-gradient(135deg,#7db1ff,#4f89ff); color:#fff; font-weight:600; cursor:pointer; margin-top:16px }
  .btn.secondary{ background: #ffffff12; border:1px solid var(--border-color); color:var(--white) }

  .error{ color:var(--danger); font-size:13px; margin-top:12px; text-align:center; background:#ff6b6b15; padding:10px; border-radius:8px; border:1px solid #ff6b6b33 }
  .success{ color:var(--success); font-size:13px; margin-top:12px; text-align:center; background:#2bd4a715; padding:10px; border-radius:8px; border:1px solid #2bd4a733 }

  .signup-link{ text-align:center; margin-top:20px; padding-top:14px; border-top:1px solid var(--border-color); }
  .signup-link a{ color:var(--accent); font-weight:600 }

  /* Form switching */
  .form-container{ position:relative; overflow:hidden }
  .form-step{ transition: all .28s ease }
  .form-step.hidden{ opacity:0; transform:translateX(20px); pointer-events:none; position:absolute; inset:0 }

  @media (max-width:768px){ .card{ padding:20px; width:92vw } }
</style>
</head>
<body>
  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
  </div>

  <div class="card">
    <div class="brand">
      <div class="logo"></div>
      <div class="t">CheckLoop</div>
    </div>
    
    <div class="form-container">
      <!-- Sign In Form -->
      <div class="form-step" id="signin-form-container">
        <h2 id="signin-title">Welcome Back</h2>
        <div class="hint" id="signin-hint">Enter your credentials to access the admin dashboard.</div>
        
        <form id="signin-form">
          <div class="field">
            <label>Email</label>
            <input type="email" id="email" placeholder="you@practice.com" required />
          </div>
          <div class="field">
            <label>Password</label>
            <input type="password" id="password" placeholder="••••••••" required />
          </div>
          
          <div class="extra-options">
            <label for="remember-me">
              <input type="checkbox" id="remember-me">
              Remember me
            </label>
            <a href="#" onclick="showForgotPassword()">Forgot Password?</a>
          </div>

          <button class="btn" type="submit">Sign In</button>
          <div class="error" id="auth-error" role="alert"></div>
          <div class="success" id="auth-success" style="display:none"></div>
        </form>
        
        <div class="signup-link">
          Don't have an account? <a href="signup.html">Sign up here</a>
        </div>
      </div>

      <!-- Forgot Password Form -->
      <div class="form-step hidden" id="forgot-form-container">
        <h2>Reset Password</h2>
        <div class="hint" style="margin-bottom: 20px;">Enter your email address and we'll send you a link to reset your password.</div>
        <form id="forgot-form">
          <div class="field">
            <label for="reset-email">Email address</label>
            <input type="email" placeholder="you@practice.com" required id="reset-email" />
          </div>
          <button type="submit" class="btn">Send Reset Link</button>
          <button type="button" class="btn secondary" onclick="showSignIn()" style="margin-top: 12px;">Back to Sign In</button>
          <div id="forgot-error" class="error" style="display:none"></div>
          <div id="forgot-success" class="success" style="display:none"></div>
        </form>
      </div>

      <!-- Reset Password Form (when coming from email link) -->
      <div class="form-step hidden" id="reset-form-container">
        <h2>Set New Password</h2>
        <form id="reset-form">
          <div class="field">
            <label for="new-password">New Password</label>
            <input type="password" placeholder="Enter new password" required id="new-password" minlength="6" />
          </div>
          <div class="field">
            <label for="confirm-password">Confirm Password</label>
            <input type="password" placeholder="Confirm new password" required id="confirm-password" minlength="6" />
          </div>
          <button type="submit" class="btn">Update Password</button>
          <div id="update-error" class="error" style="display:none"></div>
          <div id="update-success" class="success" style="display:none"></div>
        </form>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  
  // Create Supabase client with same settings as staff-common.js
  const supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
    auth: { 
      persistSession: true, 
      autoRefreshToken: true, 
      detectSessionInUrl: true, 
      flowType: 'pkce',
      storage: window.localStorage,
      storageKey: `sb-${CONFIG.SUPABASE_URL.split('//')[1].split('.')[0]}-auth-token`
    }
  });

  // Check if already logged in
  supabase.auth.getSession().then(({ data: { session } }) => {
    if (session) {
      console.log('Already logged in, redirecting to staff.html');
      window.location.href = 'staff.html';
    }
  });

  // Handle login form submission
  const signinForm = document.getElementById('signin-form');
  if (signinForm) {
    signinForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('auth-error');
      const successDiv = document.getElementById('auth-success');
      
      // Clear messages
      if (errorDiv) {
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
      }
      if (successDiv) {
        successDiv.style.display = 'none';
        successDiv.textContent = '';
      }
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });
        
        if (error) {
          console.error('Login error:', error);
          if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
          }
          return;
        }
        
        if (data.session) {
          console.log('Login successful for:', email);
          if (successDiv) {
            successDiv.textContent = 'Login successful! Redirecting...';
            successDiv.style.display = 'block';
          }
          
          // Always redirect to staff.html - all users go there first
          setTimeout(() => {
            window.location.href = 'staff.html';
          }, 500);
        }
      } catch (err) {
        console.error('Login error:', err);
        if (errorDiv) {
          errorDiv.textContent = 'An error occurred during login';
          errorDiv.style.display = 'block';
        }
      }
    });
  }
  
  // Handle forgot password
  window.showForgotPassword = function() {
    document.getElementById('signin-form-container')?.classList.add('hidden');
    document.getElementById('forgot-form-container')?.classList.remove('hidden');
  };
  
  window.showSignIn = function() {
    document.getElementById('forgot-form-container')?.classList.add('hidden');
    document.getElementById('signin-form-container')?.classList.remove('hidden');
  };
</script>

</body>
</html>

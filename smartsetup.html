<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CheckLoops • Smart Setup</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0a1f4a; --bg2:#0c2a67; --panel:#0f2f73; --ink:#eaf1ff; --muted:#b5c3e6;
    --nhs:#005EB8; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --border:#ffffff22;
    --card1:#0e2c6e; --card2:#0b245a; --shadow:0 20px 50px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 800px at 20% -10%, #1a4fcc66 0%, transparent 60%),
      radial-gradient(1200px 800px at 100% 10%, #0ea5e955 0%, transparent 60%),
      linear-gradient(160deg,var(--bg),var(--bg2));
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  header{position:sticky;top:0;z-index:20;backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(180deg, rgba(10,24,60,.85), rgba(10,24,60,.60));
    border-bottom:1px solid var(--border)}
  .nav{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:14px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;font-size:18px}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,#7dd3fc,#60a5fa);box-shadow:0 0 20px #60a5fa99;}
  .navfill{flex:1}
  .stepper{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
  .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(180deg,#0d2b69,#0a2357)}
  .chip.active{border-color:#60a5fa;color:#dbeafe}
  .chip.ok{border-color:#22c55e;color:#bbf7d0}
  .wrap{max-width:1200px;margin:20px auto;padding:0 18px}
  .hero{background:linear-gradient(180deg,#0d2b69aa,#0b2356aa);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:22px}
  .hero h1{margin:0 0 6px;font-size:22px}
  .hero p{margin:0;color:var(--muted)}
  .progress{height:8px;border-radius:6px;background:#0b1a40;border:1px solid var(--border);overflow:hidden;margin-top:14px}
  .progress>span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#22d3ee);width:20%}
  .grid{display:grid;grid-template-columns:1.15fr 1fr;gap:16px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{border:1px solid var(--border);border-radius:16px;background:linear-gradient(180deg,var(--card1),var(--card2));box-shadow:var(--shadow);padding:14px;animation:floatIn .3s ease both}
  @keyframes floatIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .titleRow{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .titleRow strong{font-size:14px}
  .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#0f3b8a,#0c2d6a);color:#e6f0ff;padding:9px 12px;border-radius:10px;cursor:pointer;font-size:13px}
  .btn.primary{background:linear-gradient(180deg,#1e63d0,#134da6);border-color:#4b7bd6}
  .btn.success{background:linear-gradient(180deg,#16a34a,#12843f);border-color:#2bd47a}
  .btn.ghost{background:transparent}
  .searchbar{display:flex;gap:8px;align-items:center;margin-top:10px}
  .searchbar input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:linear-gradient(180deg,#0c285f,#0a2252);color:#eaf1ff}
  .hint{color:var(--muted);font-size:12px}
  .list{margin-top:10px;max-height:360px;overflow:auto;display:grid;gap:8px}
  .item{background:linear-gradient(180deg,#102f74,#0b255a);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;transition:transform .12s,border-color .12s,box-shadow .12s}
  .item:hover{transform:translateY(-1px);border-color:#60a5fa;box-shadow:0 10px 24px rgba(13,70,160,.25)}
  .item small{color:var(--muted)}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px;font-size:13px;margin-top:10px}
  .kv div{padding:5px 0;border-bottom:1px dashed #ffffff20}
  .mono{background:#0a1633;border:1px solid #1f2b52;color:#d6e4ff;border-radius:10px;padding:10px;font-size:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap;word-break:break-word;overflow:auto}
  .badges{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:linear-gradient(180deg,#0e2c6e,#0b245a);border-radius:999px;padding:6px 10px;font-size:12px}
  .ok{border-color:#22c55e;color:#bbf7d0} .warn{border-color:#f59e0b;color:#ffecb3} .err{border-color:#ef4444;color:#fecaca}
  .checklist{margin-top:8px;padding:8px;background:#0a1633aa;border-radius:8px;border:1px solid #1f2b52;font-size:11px}
  .checklist .section{margin-bottom:6px}
  .checklist .label{color:#7dd3fc;font-weight:600;margin-bottom:3px}
  .checklist .fields{display:flex;flex-wrap:wrap;gap:4px}
  .checklist .field{padding:2px 5px;border-radius:4px;background:#0c285f;border:1px solid #2a4a8a}
  .checklist .field.captured{background:#16a34a33;border-color:#22c55e}
  .checklist .field.missing{background:#ef444433;border-color:#ef4444}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><span class="dot"></span>CheckLoops • Smart Setup</div>
    <div class="navfill"></div>
    <div class="stepper">
      <span class="chip active" id="st1">Welcome</span>
      <span class="chip" id="st2">Pick Practice</span>
      <span class="chip" id="st3">Import</span>
      <span class="chip" id="st4">Verify</span>
    </div>
  </div>
</header>

<div class="wrap">
  <section class="hero">
    <h1>Welcome to Smart Setup</h1>
    <p>Find your practice, import from <strong>CQC</strong> and <strong>NHS ODS</strong>, and verify it's saved — fast.</p>
    <div class="progress"><span id="prog" style="width:20%"></span></div>
  </section>

  <div class="grid">
    <div class="card">
      <div class="titleRow">
        <strong>Search for your GP Surgery</strong>
        <span class="hint">Searching "CQC All GPs"</span>
      </div>
      <div class="searchbar">
        <input id="q" placeholder="Enter practice name…" />
        <button type="button" class="btn primary" id="go">Search</button>
        <label class="hint"><input type="checkbox" id="odsOnly"> ODS only</label>
      </div>
      <div id="results" class="list"></div>
    </div>

    <div class="card">
      <div class="titleRow">
        <strong>Selected Practice</strong>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button type="button" class="btn ghost" id="btnReload">Reload Row</button>
          <button type="button" class="btn" id="btnFetchCQC">CQC → Save</button>
          <button type="button" class="btn" id="btnFetchODS">NHS ODS → Save</button>
          <button type="button" class="btn success" id="btnFetchBoth">Run Both</button>
        </div>
      </div>
      <div id="meta" class="kv"></div>
      <div class="badges">
        <span id="apiStatus" class="badge warn">Idle</span>
      </div>
      <div id="captureChecklist" class="checklist" style="display:none"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="titleRow">
      <strong>Debug Panel</strong>
      <button type="button" class="btn ghost" onclick="copyDebug()">Copy</button>
    </div>
    <div id="raw" class="mono" style="min-height:180px;max-height:300px">
      === Latest Edge/Fetch Response ===
      No data yet
    </div>
    <div id="saved" class="mono" style="min-height:100px;max-height:200px;margin-top:10px">
      === Saved Row (after last action) ===
      None
    </div>
    <div id="log" class="mono" style="min-height:150px;max-height:260px;margin-top:10px">
      === Log ===
    </div>
  </div>
</div>

<script>
  // ===== Config (client-safe) =====
  const SUPABASE_URL = 'https://unveoqnlqnobufhublyw.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_wpy7lxfbI2HwvsznlWJVKg_Zx7HnAc4';
  const TABLE = 'CQC All GPs';
  const EDGE_FN = 'fetch-nhs-data-complete';
  const CQC_FN = 'fetch-cqc-details';

  // Edge merge functions (for RLS fallback)
  const MERGE_FNS = [
    'merge-gp-row',
    'merge-location',
    'merge-location-provider',
    'merge-gp-fields',
    EDGE_FN,
    CQC_FN
  ];

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const el = (id)=>document.getElementById(id);
  const logEl = el('log');
  const rawEl = el('raw');
  const savedEl = el('saved');
  const progEl = el('prog');

  function log(msg, data){
    const time = new Date().toISOString().replace('T',' ').replace('Z','');
    logEl.textContent += `\n[${time}] ${msg}`;
    if(data){ logEl.textContent += `\n  ${JSON.stringify(data,null,2).split('\n').join('\n  ')}`; }
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setRaw(obj){
    rawEl.textContent = '=== Latest Edge/Fetch Response ===\n' + JSON.stringify(obj, null, 2);
  }

  function setSaved(obj){
    savedEl.textContent = '=== Saved Row (after last action) ===\n' + (obj ? JSON.stringify(obj, null, 2) : 'None');
  }

  function setStatus(txt, cls='warn'){
    const badge = el('apiStatus');
    badge.textContent = txt;
    badge.className = `badge ${cls}`;
  }

  function setProg(n){
    progEl.style.width = Math.max(5, Math.min(100, n)) + '%';
  }

  function setChip(id){
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    el(id).classList.add('active');
  }

  let current = null; // { location_id, provider_id, ods_code?, row? }

  // ===== Search =====
  async function search(){
    const q = el('q').value.trim();
    if(!q){ return; }
    setStatus('Searching…');
    setChip('st2'); setProg(35);
    el('results').innerHTML = '<div class="item"><small>Searching…</small></div>';

    let query = supabase.from(TABLE)
      .select('location_id, location_name, postcode, region, ods_code, provider_id')
      .ilike('location_name', `%${q}%`)
      .limit(20);

    if(el('odsOnly').checked){ query = query.not('ods_code','is',null).neq('ods_code',''); }

    const { data, error } = await query;
    if(error){ setStatus('Search failed', 'err'); log('Search failed', error); el('results').innerHTML=''; return; }

    setStatus(`Found ${data.length}`, 'ok');
    renderResults(data);
  }

  function renderResults(rows){
    const list = el('results');
    if(!rows.length){ list.innerHTML = '<div class="item"><small>No matches</small></div>'; return; }
    list.innerHTML = '';
    rows.forEach(r=>{
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div><strong>${r.location_name}</strong><br/><small>${r.region||'—'} · ${r.postcode||'—'}</small></div><div><small>${r.ods_code?('ODS '+r.ods_code):''}</small></div>`;
      div.onclick = ()=>selectPractice(r.location_id);
      list.appendChild(div);
    });
  }

  // ===== Load + show one row =====
  async function selectPractice(location_id){
    setStatus('Loading row…');
    setChip('st2'); setProg(45);
    const { data, error } = await supabase.from(TABLE).select('*').eq('location_id', location_id).single();
    if(error){ setStatus('Load failed', 'err'); log('Load failed', error); return; }
    current = {
      location_id: data.location_id,
      provider_id: data.provider_id || null,
      ods_code: data.ods_code || null,
      row: data
    };
    setStatus('Row ready', 'ok');
    renderMeta(data);
    setSaved({ saved_row: data });
  }

  function renderMeta(row){
    const m = el('meta');
    const addr = [row.address_line_1,row.address_line_2,row.town_city,row.postcode].filter(Boolean).join(', ');
    m.innerHTML = ''+
      kv('Location name', row.location_name) +
      kv('Location ID', row.location_id) +
      kv('Provider ID', row.provider_id||'—') +
      kv('ODS code', row.ods_code||'—') +
      kv('Phone', row.main_phone_number||'—') +
      kv('Website', row.website||'—') +
      kv('Address', addr||'—') +
      kv('Region', row.region||'—') +
      kv('Last NHS update', row.last_nhs_update? String(row.last_nhs_update).replace('T',' ').split('.')[0] : '—');
  }
  function kv(k,v){ return `<div style="color:var(--muted)">${k}</div><div>${v??'—'}</div>`; }

  // ===== Fix A: RLS-aware save flow =====
  async function saveUpdate(update, source='manual'){
    if(!current) return null;
    const clean = compact(update);
    if(!Object.keys(clean).length){ log('Nothing to update'); return null; }

    // Try direct update
    const { data, error } = await supabase.from(TABLE).update(clean).eq('location_id', current.location_id).select('*');
    if(error){
      setStatus('Save failed','err');
      log('Save failed', error);
      return null;
    }

    // Check if any rows were updated (FIX A: RLS detection)
    if(!data || data.length === 0){
      log('Direct update returned 0 rows (RLS blocked) - falling back to Edge merge');
      const mergeResult = await writeViaEdge(clean, source);
      if(mergeResult.ok){
        // Reload the row to get the updated data
        const reloaded = await reloadRow();
        return reloaded;
      }
      return null;
    }

    log('Saved successfully', { keys: Object.keys(clean), rows_updated: data.length });
    setSaved({ saved_row: data[0] });
    current.row = data[0];
    renderMeta(data[0]);
    return data[0];
  }

  // ===== Edge merge fallback (service role) =====
  async function writeViaEdge(patch, sourceLabel){
    const payload = {
      table: TABLE,
      location_id: current.location_id,
      provider_id: current.provider_id || null,
      ods_code: current.ods_code || null,
      source: sourceLabel,
      action: 'merge',
      apply: true,
      patch
    };

    let workingFunctions = 0;
    let lastWorkingFunction = null;

    for (const fn of MERGE_FNS){
      try{
        log(`Trying Edge merge via ${fn}...`);
        const { data, error } = await supabase.functions.invoke(fn, { body: payload });
        if(error){
          if(error.name === 'FunctionsFetchError'){
            // Function doesn't exist, skip silently
            continue;
          }
          log(`Edge merge via ${fn} error`, error);
          continue;
        }

        workingFunctions++;
        lastWorkingFunction = fn;

        // Check for success - handle Edge function quirks
        // fetch-cqc-details has a bug where it returns database_updated:false even when it updates
        const isSuccess = data && (
          data.database_updated === true ||
          data.ok === true ||
          data.success === true ||
          // Special case: fetch-cqc-details returns success:true with data even when database_updated is false
          (fn === 'fetch-cqc-details' && data.success === true && data.data)
        );

        if(isSuccess){
          log(`Edge merge via ${fn}: success`, {
            database_updated: data.database_updated,
            has_data: !!data.data,
            success: data.success
          });
          setRaw({ edge_merge_fn: fn, result: data });
          return { ok:true, fn, data };
        } else if(data && data.database_updated === false){
          log(`Edge merge via ${fn}: returned but did not update database`, data);
        }
      }catch(e){
        log(`Edge merge via ${fn} threw`, String(e));
      }
    }

    // If no functions worked at all, log a more helpful error
    if(workingFunctions === 0){
      log('ERROR: All Edge merge functions failed or do not exist. Please ensure Edge Functions are deployed.');
      setStatus('Edge Functions not available', 'err');
    } else if(lastWorkingFunction){
      log(`Edge merge failed: ${workingFunctions} functions responded but none updated the database`);
    }

    return { ok:false };
  }

  async function reloadRow(){
    if(!current) return null;
    const { data, error } = await supabase.from(TABLE).select('*').eq('location_id', current.location_id).single();
    if(error){
      log('Reload failed', error);
      return null;
    }
    current.row = data;
    current.provider_id = data.provider_id || current.provider_id;
    current.ods_code = data.ods_code || current.ods_code;
    renderMeta(data);
    setSaved({ saved_row: data });
    return data;
  }

  // ===== CQC fetch (direct) =====
  async function fetchCQC(){
    if(!current){ return; }
    const locId = current.location_id;
    const provId = current.provider_id;
    setStatus('Fetching CQC…');
    setChip('st3'); setProg(60);

    try{
      // Try CQC Edge Function first (if present)
      const viaEdge = await tryCqcEdge({ location_id: locId, provider_id: provId });
      if(viaEdge && viaEdge.data){
        await afterCqc(viaEdge);
        return;
      }

      // Fallback: direct CQC API (public)
      const loc = await fetchJson(`https://api.cqc.org.uk/public/v1/locations/${encodeURIComponent(locId)}`);
      let prov = null;
      if(provId){
        prov = await fetchJson(`https://api.cqc.org.uk/public/v1/providers/${encodeURIComponent(provId)}`);
      }
      const payload = { location: loc, provider: prov };
      await afterCqc({ data: payload });
    }catch(e){
      setStatus('CQC error', 'err');
      log('CQC fetch error', String(e));
    }
  }

  async function afterCqc(resp){
    const cqc = resp?.data || resp;
    setRaw({ cqc });
    const update = buildUpdateFromCqc(cqc);

    // Show capture checklist (Fix D)
    showCaptureChecklist('CQC', update);

    const saved = await saveUpdate(update, 'cqc');
    if(saved){
      setStatus('CQC saved', 'ok');
      setChip('st4'); setProg(100);
    } else {
      setStatus('CQC save failed', 'err');
      log('CQC save failed - no rows updated');
    }
  }

  // ===== Fix C: Enhanced CQC builder with all required fields =====
  function buildUpdateFromCqc(cqc){
    if(!cqc) return {};
    const loc = cqc.location || cqc.cqc_location || cqc.Location || cqc || null;
    const prov = cqc.provider || cqc.cqc_provider || cqc.Provider || null;

    const pick = (a,b,c)=> a!==undefined ? a : (b!==undefined ? b : c);

    // Extract ratings (Fix C: ensure all rating fields)
    const currentRatings = loc?.currentRatings || null;
    const historicRatings = loc?.historicRatings || null;
    const keyQuestionRatings = currentRatings?.overall?.keyQuestionRatings || null;

    // Extract contacts from various sources (Fix C: comprehensive contacts)
    let contacts = loc?.contacts || prov?.contacts || null;
    if(!contacts && loc?.regulatedActivities){
      // Try to extract from regulated activities
      contacts = [];
      if(Array.isArray(loc.regulatedActivities)){
        loc.regulatedActivities.forEach(ra => {
          if(ra.contacts && Array.isArray(ra.contacts)){
            contacts = contacts.concat(ra.contacts);
          }
        });
      }
    }

    return compact({
      location_source: loc ? JSON.stringify(loc) : undefined,
      provider_source: prov ? JSON.stringify(prov) : undefined,

      location_name: pick(loc?.name, prov?.name, undefined),
      provider_name: pick(prov?.name, undefined, undefined),
      provider_id: pick(loc?.providerId, prov?.providerId, undefined),
      organisation_type: pick(loc?.organisationType, undefined, undefined),
      location_type: pick(loc?.type, undefined, undefined),
      region: pick(loc?.region, undefined, undefined),

      address_line_1: pick(loc?.postalAddressLine1, undefined, undefined),
      address_line_2: pick(loc?.postalAddressLine2, undefined, undefined),
      town_city: pick(loc?.postalAddressTownCity, undefined, undefined),
      postcode: pick(loc?.postalCode, undefined, undefined),
      uprn: pick(loc?.uprn, undefined, undefined),
      latitude: (loc?.onspdLatitude!=null)? String(loc.onspdLatitude) : undefined,
      longitude:(loc?.onspdLongitude!=null)? String(loc.onspdLongitude): undefined,
      main_phone_number: pick(loc?.mainPhoneNumber, prov?.mainPhoneNumber, undefined),
      website: pick(loc?.website, prov?.website, undefined),

      // Location codes
      onspd_ccg_code: pick(loc?.onspdCcgCode, undefined, undefined),
      onspd_ccg_name: pick(loc?.onspdCcgName, undefined, undefined),
      onspd_icb_code: pick(loc?.onspdIcbCode, undefined, undefined),
      onspd_icb_name: pick(loc?.onspdIcbName, undefined, undefined),
      ods_ccg_code: pick(loc?.odsCcgCode, undefined, undefined),
      ods_ccg_name: pick(loc?.odsCcgName, undefined, undefined),

      // Ratings (Fix C: all rating fields)
      overall_rating: currentRatings?.overall?.rating,
      last_inspection_date: pick(loc?.lastInspection?.date, undefined, undefined),
      last_report_date: pick(loc?.lastReport?.publicationDate, undefined, undefined),
      current_ratings: currentRatings ? JSON.stringify(currentRatings) : undefined,
      historic_ratings: historicRatings ? JSON.stringify(historicRatings) : undefined,
      key_question_ratings: keyQuestionRatings ? JSON.stringify(keyQuestionRatings) : undefined,

      // Arrays
      regulated_activities: loc?.regulatedActivities ? JSON.stringify(loc.regulatedActivities) : undefined,
      inspection_areas: loc?.inspectionAreas ? JSON.stringify(loc.inspectionAreas) : undefined,
      inspection_categories: loc?.inspectionCategories ? JSON.stringify(loc.inspectionCategories) : undefined,
      gac_service_types: loc?.gacServiceTypes ? JSON.stringify(loc.gacServiceTypes) : undefined,
      specialisms: loc?.specialisms ? JSON.stringify(loc.specialisms) : undefined,

      // Provider fields (Fix C: all provider fields)
      provider_website: prov?.website,
      provider_main_phone_number: prov?.mainPhoneNumber,
      provider_registration_status: prov?.registrationStatus,
      provider_registration_date: prov?.registrationDate,
      ownership_type: prov?.ownershipType,
      provider_region: prov?.region,
      provider_address_line_1: prov?.postalAddressLine1,
      provider_address_line_2: prov?.postalAddressLine2,
      provider_town_city: prov?.postalAddressTownCity,
      provider_postcode: prov?.postalCode,
      provider_location_ids: prov?.locationIds ? JSON.stringify(prov.locationIds) : undefined,
      provider_inspection_areas: prov?.inspectionAreas ? JSON.stringify(prov.inspectionAreas) : undefined,

      // Additional provider fields (Fix C)
      provider_constituency: prov?.constituency,
      provider_county: prov?.postalAddressCounty,
      provider_inspection_directorate: prov?.inspectionDirectorate,
      provider_latitude: (prov?.onspdLatitude!=null)? String(prov.onspdLatitude) : undefined,
      provider_longitude: (prov?.onspdLongitude!=null)? String(prov.onspdLongitude): undefined,
      provider_local_authority: prov?.localAuthority,
      provider_onspd_icb_code: prov?.onspdIcbCode,
      provider_onspd_icb_name: prov?.onspdIcbName,
      provider_type: prov?.type,
      provider_uprn: prov?.uprn,

      // Location fields (Fix C)
      constituency: loc?.constituency,
      contacts: contacts ? JSON.stringify(contacts) : undefined,
      registration_date: loc?.registrationDate,
      registration_status: loc?.registrationStatus,

      ods_code: normalizeOds(loc?.odsCode),
      updated_at: new Date().toISOString(),
    });
  }

  // ===== NHS ODS fetch (by ODS if possible, else by name) =====
  async function fetchODS(){
    if(!current){ return; }
    setStatus('Fetching NHS ODS…');
    setChip('st3'); setProg(70);

    try{
      // Try Edge Function first (if present)
      const viaEdge = await tryEdge({ location_id: current.location_id, ods_code: current.ods_code||null, data_sources:['ods'] });
      if(viaEdge){
        await afterOds(viaEdge);
        return;
      }

      let odsData = null;
      if(current.ods_code){
        odsData = await fetchJson(`https://directory.spineservices.nhs.uk/ORD/2-0-0/organisations/${encodeURIComponent(current.ods_code)}`);
      } else if(current.row){
        // Fallback: search by name (coarse)
        const name = encodeURIComponent(current.row.location_name);
        const list = await fetchJson(`https://directory.spineservices.nhs.uk/ORD/2-0-0/organisations?Name=${name}`);
        odsData = Array.isArray(list?.organisations) ? list.organisations[0] || null : list || null;
      }
      await afterOds({ data: { ods_data: odsData } });
    }catch(e){
      setStatus('NHS error', 'err');
      log('NHS fetch error', String(e));
    }
  }

  async function afterOds(resp){
    const ods = resp?.data?.ods_data || resp?.data || resp || null;
    setRaw({ ods });

    // Log the ODS structure to help debug parsing
    if(ods){
      log('ODS response structure', {
        hasOrganisation: !!ods.Organisation,
        hasOrgId: !!(ods.Organisation?.OrgId || ods.OrgId),
        hasGeoLoc: !!(ods.Organisation?.GeoLoc || ods.GeoLoc),
        topLevelKeys: Object.keys(ods).slice(0, 10)
      });
    }

    const update = buildUpdateFromOds(ods);

    // Show capture checklist (Fix D)
    showCaptureChecklist('ODS', update);

    const saved = await saveUpdate(update, 'ods');
    if(saved){
      setStatus('NHS saved', 'ok');
      setChip('st4'); setProg(100);
    } else {
      setStatus('NHS save failed', 'err');
      log('ODS save failed - no rows updated');
    }
  }

  // ===== Fix B: Shape-agnostic ODS parser =====
  function buildUpdateFromOds(ods){
    if(!ods) return {};

    // Handle case variations for the main object
    // NHS API often returns the org data directly at root level or under Organisation
    const org = ods.Organisation || ods.organisation || ods.Organization || ods;

    // Debug: Log what we're working with
    if(ods){
      const sample = {
        hasOrganisation: !!ods.Organisation,
        orgKeys: org ? Object.keys(org).slice(0, 5) : [],
        orgIdType: org.OrgId ? typeof org.OrgId : 'none',
        orgIdValue: org.OrgId?.extension || org.OrgId || 'none'
      };
      log('ODS parsing debug', sample);
    }

    // Extract ODS code from various possible locations (Fix B: flexible extraction)
    let ident = '';
    // NHS API often uses OrgId with extension as the primary identifier
    if(org.OrgId){
      const orgId = org.OrgId;
      if(typeof orgId === 'string'){
        ident = orgId;
      } else if(orgId?.extension){
        ident = orgId.extension;
      } else if(orgId?.root){
        ident = orgId.root;
      }
    }
    // Try identifier field
    else if(ods.identifier?.value){
      ident = ods.identifier.value;
    }
    else if(Array.isArray(ods.identifier)){
      const m = ods.identifier.find(x=>String(x.system||'').toLowerCase().includes('ods'));
      ident = m?.value || ods.identifier[0]?.value || '';
    }
    else if(typeof ods.identifier==='string'){
      ident = ods.identifier;
    }
    // Try code field
    else if(org.code || org.Code || ods.code || ods.Code){
      ident = org.code || org.Code || ods.code || ods.Code;
    }

    // Extract contact information (Fix B: handle various structures)
    const telecom = Array.isArray(ods.telecom)? ods.telecom :
                   Array.isArray(org.telecom)? org.telecom : [];
    const phone = telecom.find(t=>String(t.system||'').toLowerCase()==='phone')?.value || null;
    const url = telecom.find(t=>String(t.system||'').toLowerCase()==='url')?.value || (ods.website||org.website||null);

    // Handle addresses with case variations (Fix B)
    // NHS API often uses GeoLoc.Location for address
    const addr = org.GeoLoc?.Location || ods.GeoLoc?.Location ||
                (Array.isArray(org.Addresses)? org.Addresses[0] : null) ||
                (Array.isArray(ods.Addresses)? ods.Addresses[0] : null) ||
                (Array.isArray(org.address)? org.address[0] : null) ||
                (Array.isArray(ods.address)? ods.address[0] : null) ||
                org.Addresses || org.addresses || org.Address || org.address ||
                ods.Addresses || ods.addresses || ods.Address || ods.address || null;

    const line = Array.isArray(addr?.line)? addr.line : [];

    // Extract name with case variations (Fix B)
    const name = org.Name || org.name || ods.Name || ods.name ||
                org.OrganisationName || ods.OrganisationName || null;

    // Extract postcode with case variations (Fix B)
    const postcode = addr?.PostCode || addr?.Postcode || addr?.postalCode || addr?.postcode ||
                    org.PostCode || ods.PostCode || null;

    return compact({
      nhs_ods_data: JSON.stringify(ods),
      last_nhs_update: new Date().toISOString(),
      nhs_last_updated: new Date().toISOString(), // Both timestamp fields
      ods_code: normalizeOds(ident)||undefined,
      main_phone_number: phone||undefined,
      website: url||undefined,
      address_line_1: addr?.AddrLn1 || addr?.line1 || line[0] || addr?.addressLine1 || undefined,
      address_line_2: addr?.AddrLn2 || addr?.line2 || line[1] || addr?.addressLine2 || undefined,
      town_city: addr?.Town || addr?.town || addr?.city || addr?.postalAddressTownCity || undefined,
      postcode: postcode || undefined,
      region: org.Region || org.region || ods.Region || ods.region || undefined,
      location_name: name || undefined,
      updated_at: new Date().toISOString(),
    });
  }

  // ===== Fix D: Capture Checklist Display =====
  const MUST_CAPTURE = [
    'constituency', 'contacts', 'current_ratings', 'historic_ratings', 'key_question_ratings',
    'provider_constituency', 'provider_county', 'provider_inspection_directorate',
    'provider_latitude', 'provider_longitude', 'provider_local_authority',
    'provider_onspd_icb_code', 'provider_onspd_icb_name', 'provider_type', 'provider_uprn',
    'registration_date', 'registration_status', 'ods_code', 'nhs_ods_data', 'last_nhs_update'
  ];

  function showCaptureChecklist(source, update){
    const checklist = el('captureChecklist');
    const captured = [];
    const missing = [];

    MUST_CAPTURE.forEach(field => {
      if(update[field] !== undefined){
        captured.push(field);
      } else {
        missing.push(field);
      }
    });

    let html = `<div class="section">`;
    html += `<div class="label">${source} Capture Checklist:</div>`;

    if(captured.length > 0){
      html += `<div class="label" style="color:#22c55e">✓ Captured (${captured.length}):</div>`;
      html += `<div class="fields">`;
      captured.forEach(f => {
        html += `<span class="field captured">${f}</span>`;
      });
      html += `</div>`;
    }

    if(missing.length > 0){
      html += `<div class="label" style="color:#ef4444">✗ Missing (${missing.length}):</div>`;
      html += `<div class="fields">`;
      missing.forEach(f => {
        html += `<span class="field missing">${f}</span>`;
      });
      html += `</div>`;
    }

    html += `</div>`;
    checklist.innerHTML = html;
    checklist.style.display = 'block';

    log(`${source} capture checklist`, { captured: captured.length, missing: missing.length });
  }

  // ===== Utilities =====
  async function fetchJson(url){
    const res = await fetch(url);
    if(!res.ok){ throw new Error(`${res.status} ${res.statusText}`); }
    return await res.json();
  }

  function compact(obj){
    const out={};
    Object.keys(obj||{}).forEach(k=>{
      const v=obj[k];
      if(v!==undefined) out[k]=v;
    });
    return out;
  }

  function normalizeOds(c){
    if(!c) return '';
    const u=String(c).trim().toUpperCase();
    // More flexible pattern to capture various ODS formats
    const match = u.match(/([A-Z]\d{2,7})/);
    return match ? match[0] : '';
  }

  async function tryEdge(body){
    try{
      const { data, error } = await supabase.functions.invoke(EDGE_FN, { body });
      if(error){
        log('Edge function error (ignored)', error);
        return null;
      }
      if(data){
        setRaw({ edge_response:data });
        return data;
      }
      return null;
    }catch(e){
      log('Edge function call failed (ignored)', String(e));
      return null;
    }
  }

  async function tryCqcEdge(body){
    try{
      const { data, error } = await supabase.functions.invoke(CQC_FN, { body });
      if(error){
        log('CQC Edge function error (ignored)', error);
        return null;
      }
      if(data){
        setRaw({ cqc_edge_response:data });
        return data;
      }
      return null;
    }catch(e){
      log('CQC Edge function call failed (ignored)', String(e));
      return null;
    }
  }

  async function copyDebug(){
    const debugContent =
      rawEl.textContent + '\n\n' +
      savedEl.textContent + '\n\n' +
      logEl.textContent;
    try{
      await navigator.clipboard.writeText(debugContent);
      alert('Debug content copied to clipboard');
    }catch(e){
      alert('Failed to copy: ' + e);
    }
  }

  // ===== Wire up =====
  el('go').onclick = search;
  el('q').addEventListener('keydown', e=>{ if(e.key==='Enter') search(); });
  el('btnReload').onclick = ()=> current && selectPractice(current.location_id);
  el('btnFetchCQC').onclick = fetchCQC;
  el('btnFetchODS').onclick = fetchODS;
  el('btnFetchBoth').onclick = async ()=>{ await fetchCQC(); await fetchODS(); };

  // Focus search on load
  window.addEventListener('load', ()=>{ el('q').focus(); });
</script>
</body>
</html>
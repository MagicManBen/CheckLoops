<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CheckLoop – Sign In</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* --- macOS Bright Style Redesign v2 --- */
    :root {
      --primary: #0071E3; /* Brighter, more vibrant blue */
      --primary-light: #e6f1ff;
      --text-primary: #1d232a;
      --text-secondary: #6b7785;
      --border-color: rgba(0, 0, 0, 0.1);
      --glass-bg: rgba(255, 255, 255, 0.6);
      --shadow: 0 10px 35px rgba(65, 84, 124, 0.1), 0 2px 10px rgba(65, 84, 124, 0.05);
      --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --danger: #E53E3E;
      --warning: #DD6B20;
      --success: #38A169;
    }

    * {
      box-sizing: border-box;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      color: var(--text-primary);
      background: #F7F9FC;
      position: relative;
    }
    
    body::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(45deg, #cce5ff, #d4f0ff, #ffe6f0, #e0dfff);
        background-size: 400% 400%;
        animation: gradientBG 18s ease infinite;
        z-index: -1;
        opacity: 0.8;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    
    .auth-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 64px;
        width: 100%;
        max-width: 960px;
        align-items: center;
    }

    .branding-section {
        padding: 24px;
        color: #fff;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .branding-section .logo {
        width: 120px;
        margin-bottom: 16px;
    }
    .branding-section h1 {
        font-size: 44px;
        font-weight: 700;
        margin: 0 0 16px;
        line-height: 1.2;
        color: #0d2a4c;
    }
    .branding-section .tagline {
        font-size: 18px;
        line-height: 1.6;
        color: #2a5a8a;
        max-width: 400px;
        margin-bottom: 32px;
    }
    .feature-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .feature-item {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    .feature-item svg {
        width: 28px;
        height: 28px;
        color: #1c6ab5;
        flex-shrink: 0;
    }
    .feature-item-text h4 {
        margin: 0 0 4px;
        font-size: 16px;
        font-weight: 600;
        color: #194a7a;
    }
    .feature-item-text p {
        margin: 0;
        font-size: 14px;
        color: #3b76ac;
    }


    .card {
      width: 100%;
      max-width: 420px;
      background: var(--glass-bg);
      backdrop-filter: blur(30px) saturate(200%);
      -webkit-backdrop-filter: blur(30px) saturate(200%);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.6);
      border-radius: 24px;
      padding: 32px;
    }

    h1 { font-size: 28px; font-weight: 700; margin: 0 0 8px; }
    p.sub { margin: 0 0 24px; color: var(--text-secondary); }
    label { display: block; font-size: 13px; color: var(--text-secondary); margin: 0 0 8px; font-weight: 500; }

    input {
      width: 100%;
      padding: 14px;
      border: 1px solid #e0e6f0;
      border-radius: 12px;
      font: inherit;
      outline: none;
      background: #fdfdff;
      color: var(--text-primary);
      font-size: 15px;
    }
    input::placeholder { color: #98a4b3; }
    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
    }

    .btn {
      width: 100%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      border: 0;
      border-radius: 12px;
      padding: 14px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      background: var(--primary);
      color: #fff;
      box-shadow: 0 4px 15px rgba(0, 113, 227, 0.2);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 113, 227, 0.3);
    }
    .btn:active {
      transform: translateY(0px) scale(0.98);
      box-shadow: 0 2px 10px rgba(0, 113, 227, 0.2);
    }
    .btn:disabled { opacity: .5; cursor: not-allowed; transform: none; box-shadow: none; }

    .link { background: transparent; border: 0; color: var(--text-secondary); cursor: pointer; font-weight: 500; }
    .link:hover { color: var(--primary); text-decoration: underline; }

    .alt { margin-top: 16px; display: flex; gap: 8px; align-items: center; justify-content: center; font-size: 14px; color: var(--text-secondary); }
    .alt .link { color: var(--primary); font-weight: 600; }

    .error { display: none; margin: 12px 0; padding: 12px; border-left: 4px solid #E45151; background: rgba(228, 81, 81, 0.08); border-radius: 10px; color: #9B2C2C; font-weight: 500; }

    .form-meta { display: flex; justify-content: space-between; align-items: center; margin: 12px 0 18px; font-size: 13px; color: var(--text-secondary); }
    .checkbox { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 13px; line-height: 1; cursor: pointer; }
    .checkbox input { width: 16px; height: 16px; margin: 0; accent-color: var(--primary); }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .fadeInUp { animation: fadeInUp 0.6s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
    .fadeIn { animation: fadeIn 0.5s ease forwards; }

    /* --- App Shell --- */
    .app-shell { display: none; grid-template-columns: 80px 1fr; height: 100vh; overflow: hidden; }
    .sidebar {
      background: rgba(247, 249, 252, 0.7);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border-right: 1px solid rgba(0,0,0,0.07);
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    
    #logoBtn {
        mix-blend-mode: screen; /* Fix for GIF background */
    }

    .sidebar-button { width: 52px; height: 52px; display: grid; place-items: center; border-radius: 16px; cursor: pointer; background: transparent; border: 1px solid transparent; }
    .sidebar-button:hover { background: rgba(0, 113, 227, 0.08); transform: scale(1.05); }
    .sidebar-button.selected { background: var(--primary-light); box-shadow: 0 0 15px rgba(0, 113, 227, 0.1); }
    .sidebar-button img { width: 28px; height: 28px; display: block; object-fit: contain; filter: grayscale(1) opacity(0.6); }
    .sidebar-button.selected img { filter: none; }
    .sidebar .spacer { flex: 1; }

    .profile { position: relative; }
    .avatar { width: 44px; height: 44px; border-radius: 50%; display: grid; place-items: center; background: linear-gradient(135deg, var(--primary), #529dff); color: #fff; font-weight: 700; font-size: 16px; cursor: pointer; border: 2px solid rgba(255, 255, 255, 0.8); }
    .avatar:hover { transform: scale(1.1); box-shadow: 0 0 15px rgba(0, 113, 227, 0.3); }

    .profile-menu { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-10px); background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.5); padding: 8px; z-index: 1000; width: 150px; }
    .profile-menu button { width: 100%; background: transparent; border: none; padding: 10px 12px; font-weight: 500; color: var(--text-primary); cursor: pointer; text-align: left; border-radius: 8px; }
    .profile-menu button:hover { background: rgba(0, 113, 227, 0.1); color: var(--primary); }

    .main { padding: 24px 32px; display: flex; flex-direction: column; height: 100vh; overflow-y: auto; background: transparent; }
    .main h2 { font-size: 24px; font-weight: 600; margin: 0 0 16px; }

    .grid-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; flex: 1; min-height: 0; height: 100%; }
    .panel { background: var(--glass-bg); backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.6); border-radius: 16px; box-shadow: var(--shadow); padding: 20px; display: flex; flex-direction: column; height: 100%; min-height: 0; }
    .rows { display: flex; flex-direction: column; gap: 10px; min-height: 0; flex: 1; overflow-y: auto; padding-right: 8px; }
    .rows::-webkit-scrollbar { width: 6px; }
    .rows::-webkit-scrollbar-track { background: transparent; }
    .rows::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 3px; }
    .rows::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }

    .row-card { background: #fff; border: 1px solid #e8eef7; border-left: 4px solid var(--primary); padding: 10px 14px; border-radius: 10px; font-size: 14px; font-weight: 500; color: var(--text-primary); user-select: none; cursor: grab; box-shadow: 0 2px 4px rgba(65, 84, 124, 0.05); }
    .row-card:hover { background: #fdfdff; border-color: #dbe8ff; transform: scale(1.02); }
    .row-card:active { cursor: grabbing; }
    .row-card.dragging { opacity: .6; transform: scale(0.98); background: #e6f2ff; }
    .rows.drop-target { background: rgba(0, 113, 227, 0.05); border-radius: 12px; }

    .team-header { padding: 8px 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--primary); background: rgba(0, 113, 227, 0.08); border-radius: 8px; letter-spacing: .05em; user-select: none; margin-top: 10px; }
    .team-group.drop-target { background: rgba(0, 113, 227, 0.05); border-radius: 12px; }

    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .panel-header .title { margin: 0; }

    .icon-btn { background: var(--primary); color: #fff; border: none; border-radius: 10px; font-size: 24px; font-weight: 300; width: 38px; height: 38px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
    .icon-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0, 113, 227, 0.2); }

    .rooms-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; padding: 10px; }
    .room-card { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(65, 84, 124, 0.08); border: 1px solid #e8eef7; width: 100%; aspect-ratio: 1 / 1; display: flex; flex-direction: column; font-weight: bold; position: relative; padding: 8px; }
    .room-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(65, 84, 124, 0.12); border-color: #dbe8ff; }
    .room-card.highlight { border: 2px dashed var(--primary); background-color: #f0f7ff; }
    .room-delete { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; display: grid; place-items: center; border: 1px solid #e8eef7; border-radius: 8px; background: #fff; color: #E45151; font-weight: 800; line-height: 1; cursor: pointer; z-index: 2; }
    .room-delete:hover { background: #ffecec; color: #B42323; box-shadow: 0 4px 12px rgba(228,81,81,.2); }
    .room-header { text-align: center; font-weight: 600; font-size: 16px; padding: 8px; color: var(--text-primary); }
    .room-items { flex: 1; display: flex; flex-direction: column; gap: 6px; overflow: auto; padding: 0 8px 8px 8px; }
    .room-item { background: #f9fbff; border: 1px solid #e8eef7; border-left: 3px solid var(--primary); border-radius: 8px; padding: 8px 10px; font-size: 13px; font-weight: 500; cursor: grab; user-select: none; }
    .room-item:active { cursor: grabbing; }

    .table-wrap { background: #fff; border: 1px solid #e8eef7; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(65, 84, 124, 0.06); }
    table.nice-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .nice-table thead th { font-size: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); background: #f9fbff; padding: 14px 16px; border-bottom: 1px solid #e8eef7; text-transform: uppercase; letter-spacing: 0.05em; }
    .nice-table tbody td { padding: 14px 16px; border-bottom: 1px solid #f2f5fa; font-size: 14px; color: var(--text-primary); }
    .nice-table tbody tr:last-child td { border-bottom: none; }
    .nice-table tbody tr:hover { background: #f9fbff; }

    .config-btn { border: 1px solid #e0e6f0; background: #fff; color: var(--text-secondary); border-radius: 8px; padding: 6px 12px; font-weight: 500; cursor: pointer; }
    .config-btn:hover { background: #f9fbff; color: var(--text-primary); border-color: #d0d8e4; }
    .subcard { background: #fff; border: 1px solid #e8eef7; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(65, 84, 124, 0.06); }
    .subcard .subcard-title { font-size: 12px; color: var(--text-secondary); font-weight: 600; margin: 0 0 8px; text-transform: uppercase; letter-spacing: .04em; }
    .filter-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .radio-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .radio-pill { display: inline-flex; align-items: center; border: 1px solid #e0e6f0; border-radius: 999px; padding: 8px 14px; cursor: pointer; background: #fff; user-select: none; }
    .radio-pill span { font-weight: 500; color: var(--text-secondary); }
    .radio-pill.active { background: var(--primary-light); border-color: #b3d7ff; }
    .radio-pill.active span { color: var(--primary); }
    .subcard input[type="text"] { padding: 10px 14px; border: 1px solid #e0e6f0; border-radius: 10px; background: #f9fbff; color: var(--text-primary); }

    #staffRows .row-card { border-left: none; display: grid; grid-template-columns: 1fr 160px 64px 40px; align-items: center; gap: 8px; padding: 8px 12px; }
    #staffRows .staff-name { font-weight: 600; }
    #staffRows .staff-role { color: var(--text-secondary); font-size: 13px; }
    #staffRows .staff-pin { display: inline-block; min-width: 24px; text-align: center; font-weight: 700; }
    #staffRows .staff-pin.pin-yes { color: #26a269; }
    #staffRows .staff-pin.pin-no { color: #B42323; }
    .staff-config-btn { width: 32px; height: 32px; border: 1px solid #e0e6f0; border-radius: 8px; background: #fff; font-size: 14px; line-height: 1; display: grid; place-items: center; cursor: pointer; color: var(--text-secondary); }
    .staff-config-btn:hover { background: #f9fbff; color: var(--text-primary); }
    .staff-headers { display: grid; grid-template-columns: 1fr 160px 64px 40px; gap: 8px; padding: 8px 12px; font-size: 12px; text-transform: uppercase; color: var(--text-secondary); background: #f2f5fa; border-radius: 8px; user-select: none; margin-bottom: 8px; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(30, 41, 59, .6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 2000; animation: fadeIn 0.3s ease forwards; }
    .modal { background: #fcfdff; border-radius: 16px; box-shadow: var(--shadow); width: 90%; max-width: 460px; padding: 24px; display: flex; flex-direction: column; gap: 16px; animation: fadeInUp 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
    .modal h3 { margin: 0; font-size: 20px; font-weight: 600;}
    .modal label { font-size: 13px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px; display: block; }
    .modal input, .modal select { width: 100%; padding: 12px; border: 1px solid #e0e6f0; border-radius: 10px; font: inherit; background: #fff; color: var(--text-primary); }
    .modal .pin-row { display: flex; align-items: center; gap: 10px; }
    .btn-small { padding: 10px 16px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-secondary { background: #eef2f8; color: var(--text-secondary); }
    .btn-secondary:hover { background: #e5eaf2; color: var(--text-primary); }
    .modal .btn-row { display: flex; justify-content: flex-end; gap: 12px; margin-top: 8px; }

    /* --- New Dashboard Styles --- */
    #pageDashboard { gap: 24px; }
    .dash-header { display: flex; justify-content: space-between; align-items: center; }
    .dash-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }
    .stat-card { background: #fff; border: 1px solid #e8eef7; border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 4px 12px rgba(65, 84, 124, 0.06); }
    .stat-card-icon { width: 48px; height: 48px; border-radius: 12px; display: grid; place-items: center; }
    .stat-card-icon svg { width: 24px; height: 24px; color: #fff; }
    .stat-card-info .value { font-size: 28px; font-weight: 700; color: var(--text-primary); line-height: 1; }
    .stat-card-info .label { font-size: 14px; color: var(--text-secondary); }
    .dash-main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; flex: 1; min-height: 0; }
    .dash-card { background: #fff; border: 1px solid #e8eef7; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(65, 84, 124, 0.06); display: flex; flex-direction: column; }
    .dash-card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
    .dash-card-header h3 { margin: 0; font-size: 16px; font-weight: 600; }
    .dash-card-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .dash-list-item { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; padding: 10px; background: #f9fbff; border-radius: 10px; border: 1px solid #f2f5fa; }
    .dash-list-item .item-name { font-weight: 600; font-size: 14px; }
    .dash-list-item .item-details { font-size: 13px; color: var(--text-secondary); }
    .dash-list-item .status-pill { padding: 4px 10px; font-size: 12px; font-weight: 600; border-radius: 999px; }
    .status-pill.danger { background: rgba(229, 62, 62, 0.1); color: #C53030; }
    .status-pill.warning { background: rgba(221, 107, 32, 0.1); color: #B45309; }
    .status-pill.success { background: rgba(56, 161, 105, 0.1); color: #2F855A; }
    .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
    /* --- End New Dashboard Styles --- */

    /* --- Schedule Page Design --- */
    .schedule-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }
    .schedule-card {
        background: #fff;
        border: 1px solid #e8eef7;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 12px rgba(65, 84, 124, 0.06);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .schedule-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(65, 84, 124, 0.1);
    }
    .schedule-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    .schedule-card-header .item-name {
        font-weight: 600;
        font-size: 16px;
    }
    .schedule-card-header .check-type {
        font-size: 13px;
        color: var(--text-secondary);
    }
    .schedule-card-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
    }
    .schedule-card-details .frequency {
        background: var(--primary-light);
        color: var(--primary);
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 500;
    }
    .schedule-card-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
        padding-top: 12px;
        border-top: 1px solid #f2f5fa;
    }
    .status-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 12px;
    }
    .status-badge.active { background: #e6f7f0; color: #26a269; }
    .status-badge.inactive { background: #f3f4f6; color: #6b7785; }
    .status-badge.required { border: 1px solid #e0e6f0; }

    /* --- Calendar Page Styles --- */
    .calendar-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        gap: 16px;
    }
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 8px;
    }
    .calendar-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        text-align: center;
        flex-grow: 1;
    }
    .calendar-nav-btn {
        background: #fff;
        border: 1px solid #e0e6f0;
        border-radius: 8px;
        width: 36px;
        height: 36px;
        cursor: pointer;
        font-size: 18px;
        color: var(--text-secondary);
    }
    .calendar-nav-btn:hover {
        background: #f9fbff;
        color: var(--text-primary);
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-template-rows: repeat(6, 1fr);
        gap: 1px;
        background-color: #e8eef7;
        border: 1px solid #e8eef7;
        border-radius: 12px;
        overflow: hidden;
        flex: 1;
        min-height: 0;
    }
    .calendar-day {
        background-color: #fff;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        position: relative;
    }
    .calendar-day.other-month {
        background-color: #f9fbff;
        color: #b0bac5;
    }
    .calendar-day-header {
        font-weight: 600;
        font-size: 13px;
        text-align: right;
    }
    .calendar-day.today .calendar-day-header {
        color: #fff;
        background-color: var(--primary);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: grid;
        place-items: center;
        margin-left: auto;
    }
    .calendar-day-name {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        text-align: center;
        padding: 12px 0;
        background: #f9fbff;
    }
    .calendar-events {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 12px;
    }
     .calendar-events::-webkit-scrollbar { width: 4px; }
    .calendar-events::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 2px; }

    .calendar-event {
        background-color: var(--primary-light);
        color: var(--primary);
        border-left: 3px solid var(--primary);
        padding: 4px 6px;
        border-radius: 4px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
    }
    .calendar-event:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0,113,227,0.2);
    }


    @media (max-width: 900px) {
      .auth-container { grid-template-columns: 1fr; gap: 32px; }
      .branding-section { text-align: center; padding: 0; }
      .branding-section .logo { margin: 0 auto 16px; }
      .branding-section .tagline { margin-left: auto; margin-right: auto; }
      .feature-list { max-width: 420px; margin: 0 auto; }
      .feature-item { text-align: left; }
      .card { margin: 0 auto; }
      .grid-2-1 { grid-template-columns: 1fr; }
      .main { padding: 16px; }
      .dash-grid { grid-template-columns: 1fr 1fr; }
      .dash-main-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 700px) {
      #staffRows .row-card, .staff-headers { grid-template-columns: 1fr; gap: 4px; padding: 10px; }
      #staffRows .staff-role, #staffRows .staff-pin { margin-left: 2px; }
    }
  </style>
</head>
<body>
  <!-- Redirect iPad users to the optimised layout -->
  <script>
    (function () {
      const ua = navigator.userAgent || '';
      const isIpad = /iPad/i.test(ua) || (/Macintosh/i.test(ua) && 'ontouchstart' in window);
      if (isIpad) {
        window.location.replace('indexIpad.html');
      }
    })();
  </script>
<div class="wrap">
    <div class="auth-container">
        <div class="branding-section fadeInUp">
            <img src="Animated_Logo.gif" alt="CheckLoop Logo" class="logo" style="mix-blend-mode: screen; border-radius: 16px;">
            <h1>Stay Compliant, Effortlessly.</h1>
            <p class="tagline">CheckLoop simplifies your safety and operational checks, ensuring everything is logged, tracked, and always ready for inspection.</p>
            <div class="feature-list">
                <div class="feature-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <div class="feature-item-text">
                        <h4>Automated Scheduling</h4>
                        <p>Never miss a check with smart, recurring schedules for all your items.</p>
                    </div>
                </div>
                <div class="feature-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                    <div class="feature-item-text">
                        <h4>Real-time Monitoring</h4>
                        <p>Get instant updates and a clear overview of all check statuses on your dashboard.</p>
                    </div>
                </div>
                <div class="feature-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    <div class="feature-item-text">
                        <h4>Compliance Simplified</h4>
                        <p>Generate reports and maintain a complete audit trail with just a few clicks.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="card fadeInUp" id="authCard">
            <h1 class="fadeIn">Sign in</h1>
            <p class="sub fadeIn" style="animation-delay: 0.1s;">Use your email and password.</p>
            <div id="err" class="error"></div>
            <form id="loginForm">
                <label for="email">Email</label>
                <input id="email" type="email" placeholder="you@company.com" autocomplete="email" required />
                <div style="height:16px"></div>
                <label for="password">Password</label>
                <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" required />
                <div class="form-meta">
                    <label class="checkbox">
                        <input id="remember" type="checkbox" />
                        <span>Remember me</span>
                    </label>
                    <button class="link" type="button" id="forgotBtn">Forgot password?</button>
                </div>
                <button class="btn" id="signInBtn" type="submit">Sign In</button>
                <button class="link" type="button" id="backBtn" style="display:none;margin-top:8px;width:100%">Back to sign in</button>
            </form>
            <div class="alt"><span class="muted">No account?</span><button class="link" type="button" id="createBtn">Create account</button></div>
        </div>
    </div>
</div>


  <div id="appShell" class="app-shell" style="display:none">
    <aside class="sidebar">
      <div style="display:flex;align-items:center;justify-content:center;margin-bottom:28px;">
        <img id="logoBtn" src="Animated_Logo.gif" alt="Logo" style="cursor:pointer;width:90%;height:auto;max-width:160px;border-radius:8px;margin:5px auto;display:block;" />
      </div>
      <div class="section" style="display:flex;flex-direction:column;gap:10px;align-items:center;">
        <div class="sidebar-button selected" id="btnDashboardPage" title="Dashboard">
          <img src="./dashboard.png" alt="Dashboard" />
        </div>
        <div class="sidebar-button" id="btnDoctorPage" title="Staff">
          <img src="./Doctor.png" alt="Doctor" />
        </div>
        <div class="sidebar-button" id="btnSchedulePage" title="Schedule">
          <img src="./Schedule.png" alt="Schedule" />
        </div>
        <div class="sidebar-button" id="btnCalendarPage" title="Calendar">
          <img src="./check-mark.png" alt="Calendar" />
        </div>
        <div class="sidebar-button" id="btnItemsPage" title="Manage Items">
          <img src="./QRCode.png" alt="QR Code" />
        </div>
        <div class="sidebar-button" id="btnBoxesPage" title="Rooms">
          <img src="./AddRoomIcon.png" alt="Add Room" />
        </div>
      </div>
      <div class="spacer"></div>
      <div class="profile" style="justify-content:center;">
        <div class="avatar" id="profileInitials" onclick="toggleProfileMenu()">--</div>
        <div class="profile-menu" id="profileMenu" style="display:none">
          <button onclick="doLogout()">Sign Out</button>
        </div>
      </div>
    </aside>
    
    <!-- Main Content Pages -->
    <section class="main" id="pageDashboard" style="display:none;">
        <div class="dash-header">
            <h2>Dashboard</h2>
            <span id="welcomeName" style="font-weight: 500;"></span>
        </div>
        <div class="dash-grid" id="dashStatsGrid">
            <!-- Stat cards will be injected here -->
        </div>
        <div class="dash-main-grid">
            <div class="dash-card">
                <div class="dash-card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    <h3>Overdue Checks</h3>
                </div>
                <div class="dash-card-list" id="dashOverdueList">
                    <!-- Overdue items will be injected here -->
                </div>
            </div>
            <div class="dash-card">
                <div class="dash-card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    <h3>Checks Due Soon</h3>
                </div>
                <div class="dash-card-list" id="dashUpcomingList">
                    <!-- Upcoming items will be injected here -->
                </div>
            </div>
        </div>
    </section>
    
    <section class="main" id="pageHome" style="display: block;">
      <h2>Welcome to CheckLoop</h2>
      <div id="mainContent" style="color:var(--text-secondary)">Choose an option from the left to get started.</div>
    </section>
    
    <section class="main" id="pageDoctor" style="display:none;">
      <div class="panel-header">
        <h2 class="title">Staff</h2>
        <div style="display:flex;gap:8px;">
          <button class="btn-small btn-primary" id="addStaffBtn" title="Add Staff">Add Staff</button>
          <button class="btn-small btn-secondary" id="addTeamBtn" title="Add Team">Add Team</button>
        </div>
      </div>
      <div class="subcard" id="staffFilterCard">
        <div class="filter-row">
          <div style="display:flex;flex-direction:column;gap:6px">
            <span class="subcard-title">Filter by</span>
            <div class="radio-row" id="staffFieldRadios">
              <label class="radio-pill active"><input type="radio" name="staffField" value="name" checked hidden><span>Name</span></label>
              <label class="radio-pill"><input type="radio" name="staffField" value="role" hidden><span>Role</span></label>
            </div>
          </div>
          <input id="staffFilterInput" type="text" placeholder="Type to filter..." autocomplete="off" style="flex:1;min-width:220px" />
          <button class="config-btn" type="button" id="staffFilterClear">Clear</button>
        </div>
      </div>
      <div class="panel" id="staffRowsCard" style="flex: 1; min-height: 0;">
        <div class="rows" id="staffRows"></div>
      </div>
    </section>
    
    <section class="main" id="pageSchedule" style="display:none;">
        <div class="panel-header">
            <h2 class="title">Schedule</h2>
            <button class="icon-btn" id="addScheduleBtn" title="Add schedule">+</button>
        </div>
        <div class="subcard" id="scheduleFilterCard">
            <div class="filter-row">
            <input id="scheduleFilterInput" type="text" placeholder="Filter by item or check type…" autocomplete="off" style="flex:1;min-width:220px" />
            <button class="config-btn" type="button" id="scheduleFilterClear">Clear</button>
            </div>
        </div>
        <div class="panel" style="flex: 1; min-height: 0; padding: 10px;">
            <div id="scheduleGrid" class="schedule-grid">
                <!-- Schedule cards will be dynamically inserted here -->
            </div>
        </div>
    </section>

    <section class="main" id="pageCalendar" style="display:none;">
        <h2>Calendar</h2>
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="calPrev" class="calendar-nav-btn">‹</button>
                <h3 id="calMonthYear">Month Year</h3>
                <button id="calNext" class="calendar-nav-btn">›</button>
            </div>
            <div class="calendar-grid" style="grid-template-rows: auto; flex: 0; min-height: auto;">
              <div class="calendar-day-name">Sun</div>
              <div class="calendar-day-name">Mon</div>
              <div class="calendar-day-name">Tue</div>
              <div class="calendar-day-name">Wed</div>
              <div class="calendar-day-name">Thu</div>
              <div class="calendar-day-name">Fri</div>
              <div class="calendar-day-name">Sat</div>
            </div>
            <div class="calendar-grid" id="calGrid">
                <!-- Calendar days will be dynamically inserted here -->
            </div>
        </div>
    </section>

    <section class="main" id="pageBoxes" style="display:none; padding: 0; background: transparent;">
      <div class="grid-2-1" style="padding: 24px 32px;">
        <div class="panel" id="itemsPrimary">
          <div class="panel-header">
            <h2 class="title">Rooms</h2>
            <button id="addRoomBtn" class="icon-btn" title="Add room">+</button>
          </div>
          <div class="rows" id="leftRows">
            <div class="rooms-grid" id="roomsGrid"></div>
          </div>
        </div>
        <div class="panel" id="itemsSecondary">
          <h2 class="title" style="margin-bottom: 16px;">Unassigned Items</h2>
          <div class="rows" id="rightRows">
            <!-- Unassigned items will be populated here -->
          </div>
        </div>
      </div>
    </section>

    <section class="main" id="pageItems" style="display:none;">
        <div class="panel-header">
            <h2 class="title">Items</h2>
            <button class="icon-btn" id="addItemBtn" title="New Item">+</button>
        </div>
        <div class="subcard" id="itemsFilterCard">
            <div class="filter-row">
            <div style="display:flex;flex-direction:column;gap:6px">
                <span class="subcard-title">Filter by</span>
                <div class="radio-row" id="itemsFieldRadios">
                <label class="radio-pill active"><input type="radio" name="itemsField" value="name" checked hidden><span>Name</span></label>
                <label class="radio-pill"><input type="radio" name="itemsField" value="id" hidden><span>ID</span></label>
                <label class="radio-pill"><input type="radio" name="itemsField" value="room" hidden><span>Room</span></label>
                </div>
            </div>
            <input id="itemsFilterInput" type="text" placeholder="Type to filter..." autocomplete="off" style="flex:1;min-width:220px" />
            <button class="config-btn" type="button" id="itemsFilterClear">Clear</button>
            </div>
        </div>
        <div class="subcard" id="itemsTableCard" style="flex: 1; min-height: 0; display: flex; flex-direction: column;">
            <div class="table-wrap" style="flex: 1; overflow-y:auto;">
            <table class="nice-table" id="itemsTable">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>ID</th>
                    <th>Room</th>
                    <th></th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
            </div>
        </div>
    </section>
  </div>

  <!-- MODALS -->
  <div id="checkOverviewModal" class="modal-overlay">
    <div class="modal">
      <h3>Check Overview</h3>
      <div class="modal-grid">
        <label>Item:</label> <span id="overviewItemName"></span>
        <label>Check Type:</label> <span id="overviewCheckType"></span>
        <label>Due Date:</label> <span id="overviewDueDate"></span>
        <label>Frequency:</label> <span id="overviewFrequency"></span>
        <label>Last Done:</label> <span id="overviewLastDone"></span>
      </div>
      <div class="btn-row">
        <button id="overviewCloseBtn" type="button" class="btn-small btn-secondary">Close</button>
      </div>
    </div>
  </div>
  <div id="itemModal" class="modal-overlay">
    <div class="modal">
      <h3>Edit Item</h3>
      <div>
        <label for="itemModalName">Name</label>
        <input id="itemModalName" type="text" />
      </div>
      <div>
        <label for="itemModalId">ID</label>
        <input id="itemModalId" type="text" />
      </div>
      <div>
        <label for="itemModalRoom">Room</label>
        <select id="itemModalRoom"></select>
      </div>
      <div class="btn-row">
        <button id="itemModalCancel" type="button" class="btn-small btn-secondary">Cancel</button>
        <button id="itemModalSave" type="button" class="btn-small btn-primary">Save</button>
      </div>
    </div>
  </div>

  <div id="scheduleModal" class="modal-overlay">
    <div class="modal">
      <h3 id="scheduleModalTitle">Add Schedule</h3>
      <div>
        <label for="scheduleItemSel">Item</label>
        <select id="scheduleItemSel"></select>
      </div>
      <div>
        <label for="scheduleTypeSel">Check Type</label>
        <select id="scheduleTypeSel"></select>
      </div>
      <div>
        <label>Frequency</label>
        <div class="pin-row">
          <input id="freqNum" type="number" min="1" step="1" value="1" style="max-width:90px" />
          <select id="freqUnit">
            <option value="minute">minutes</option>
            <option value="hour">hours</option>
            <option value="day" selected>days</option>
            <option value="week">weeks</option>
            <option value="month">months</option>
          </select>
        </div>
      </div>
      <div>
        <label>Warn Before</label>
        <div class="pin-row">
          <input id="warnNum" type="number" min="0" step="1" value="3" style="max-width:90px" />
          <select id="warnUnit">
            <option value="minute">minutes</option>
            <option value="hour">hours</option>
            <option value="day" selected>days</option>
            <option value="week">weeks</option>
            <option value="month">months</option>
          </select>
        </div>
      </div>
      <div class="pin-row">
        <label style="margin:0; flex-shrink: 0;">Required</label>
        <input id="scheduleRequired" type="checkbox" checked style="width: 20px; height: 20px;"/>
        <label style="margin-left:12px; flex-shrink: 0;">Active</label>
        <input id="scheduleActive" type="checkbox" checked style="width: 20px; height: 20px;"/>
      </div>
      <div class="btn-row">
        <button id="scheduleModalCancel" type="button" class="btn-small btn-secondary">Cancel</button>
        <button id="scheduleModalSave" type="button" class="btn-small btn-primary">Save</button>
      </div>
    </div>
  </div>

  <div id="staffModal" class="modal-overlay">
    <div class="modal">
      <h3>Edit Staff</h3>
      <div>
        <label for="staffModalName">Name</label>
        <input id="staffModalName" type="text" />
      </div>
      <div>
        <label for="staffModalRole">Role</label>
        <select id="staffModalRole"></select>
      </div>
      <div>
        <label>Pin</label>
        <div class="pin-row">
          <span id="staffModalPinDisplay">****</span>
          <button id="staffModalPinChange" type="button" class="btn-small btn-secondary">Change</button>
        </div>
        <input id="staffModalPinInput" type="text" placeholder="New PIN" style="display:none;margin-top:6px;" />
      </div>
      <div class="btn-row">
        <button id="staffModalCancel" type="button" class="btn-small btn-secondary">Cancel</button>
        <button id="staffModalSave" type="button" class="btn-small btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- ALL JAVASCRIPT IS UNCHANGED BELOW THIS LINE (except schedule page logic) -->
  <script data-app="main">
  
  function toggleProfileMenu(){
    const m = document.getElementById('profileMenu');
    if(m) m.style.display = (m.style.display === 'none') ? 'block' : 'none';
  }

  /* --- Schedule page helpers --- */
  let _SCHEDULE_ITEMS = [];
  let _SCHEDULE_TYPES = [];

  function intervalFrom(num, unit){
    const n = Math.max(0, parseInt(num || '0', 10));
    const u = String(unit || 'day');
    if(n === 0) return '0 minutes';
    switch(u){
      case 'minute': return `${n} minutes`;
      case 'hour':   return `${n} hours`;
      case 'day':    return `${n} days`;
      case 'week':   return `${n} weeks`;
      case 'month':  return `${n} months`;
      default:       return `${n} days`;
    }
  }

  function formatInterval(s){
    if(!s) return '';
    const m = String(s).match(/(\d+)\s*(minute|hour|day|week|month)s?/i);
    return m ? `Every ${m[1]} ${m[2]}${Number(m[1])===1?'':'s'}` : String(s);
  }

  function buildOptions(selectEl, options, getVal, getLabel, includeBlank){
    if(!selectEl) return;
    const html = [includeBlank? '<option value=\"\">Select…</option>' : '']
      .concat(options.map(o=>`<option value=\"${escapeHtml(String(getVal(o)))}\">${escapeHtml(String(getLabel(o)))}</option>`))
      .join('');
    selectEl.innerHTML = html;
  }
  
  /* --- NEW Schedule page logic --- */
  async function loadSchedulePage(){
    if(!window.SB || !window.CURRENT_SITE_ID) return;
    const site = window.CURRENT_SITE_ID;

    const [{ data: itemsRes, error: itemsErr },
           { data: typesRes, error: typesErr },
           { data: rowsRes,  error: rowsErr }] = await Promise.all([
      window.SB.from('items').select('id,item_name').eq('site_id', site).eq('active', true).order('item_name', { ascending:true }),
      window.SB.from('check_types').select('id,name,category,active').eq('site_id', site).eq('active', true).order('name', { ascending:true }),
      window.SB.from('item_allowed_types').select('id,item_id,check_type_id,frequency,warn_before,required,active').eq('site_id', site).order('id', { ascending:true })
    ]);

    if(itemsErr||typesErr||rowsErr){ console.error(itemsErr||typesErr||rowsErr); }

    _SCHEDULE_ITEMS = itemsRes || [];
    _SCHEDULE_TYPES = typesRes || [];

    const nameByItem = new Map(_SCHEDULE_ITEMS.map(i=>[Number(i.id), i.item_name || `Item ${i.id}`]));
    const typeById = new Map(_SCHEDULE_TYPES.map(t=>[Number(t.id), t]));
    const grid = document.getElementById('scheduleGrid');
    if(!grid) return;

    const queryText = (document.getElementById('scheduleFilterInput')?.value || '').trim().toLowerCase();

    grid.innerHTML = (rowsRes||[]).map(r=>{
      const itemName  = nameByItem.get(Number(r.item_id)) || 'Unknown Item';
      const typeObj   = typeById.get(Number(r.check_type_id));
      const typeName  = typeObj ? typeObj.name : `Unknown Type`;
      const typeCat   = typeObj ? typeObj.category : '';
      const freq      = formatInterval(r.frequency);
      const rowSearch = `${itemName} ${typeName} ${typeCat}`.toLowerCase();
      const hideRow   = queryText && !rowSearch.includes(queryText);
      
      if (hideRow) return '';

      return `
        <div class="schedule-card" data-row-id="${r.id}">
          <div class="schedule-card-header">
            <div>
              <div class="item-name">${escapeHtml(itemName)}</div>
              <div class="check-type">${escapeHtml(typeName)}</div>
            </div>
            <div class="status-badge ${r.active ? 'active' : 'inactive'}">${r.active ? 'Active' : 'Inactive'}</div>
          </div>
          <div class="schedule-card-details">
            <div class="frequency">${escapeHtml(freq)}</div>
            <div>${r.required ? '<span class="status-badge required">Required</span>' : ''}</div>
          </div>
          <div class="schedule-card-actions">
            <button class="config-btn schedule-edit-btn" data-id="${r.id}">Edit</button>
            <button class="config-btn schedule-deactivate-btn" data-id="${r.id}">${r.active ? 'Deactivate' : 'Activate'}</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function setupScheduleUI(){
    const input = document.getElementById('scheduleFilterInput');
    const clearBtn = document.getElementById('scheduleFilterClear');
    if(input && !input.dataset.bound){
      input.addEventListener('input', () => loadSchedulePage());
      input.dataset.bound = '1';
    }
    if(clearBtn && !clearBtn.dataset.bound){
      clearBtn.addEventListener('click', () => { if(input){ input.value=''; } loadSchedulePage(); });
      clearBtn.dataset.bound = '1';
    }
    const addBtn = document.getElementById('addScheduleBtn');
    if(addBtn && !addBtn.dataset.bound){
      addBtn.addEventListener('click', () => openScheduleModal('add'));
      addBtn.dataset.bound = '1';
    }
    const grid = document.getElementById('scheduleGrid');
    if(grid && !grid.dataset.bound){
      grid.addEventListener('click', async (e)=>{
        const editBtn  = e.target.closest('.schedule-edit-btn');
        const toggBtn  = e.target.closest('.schedule-deactivate-btn');
        if(editBtn){
          openScheduleModal('edit', Number(editBtn.dataset.id));
          return;
        }
        if(toggBtn){
          const id = Number(toggBtn.dataset.id);
          if(!window.SB) return;
          const { data, error } = await window.SB.from('item_allowed_types').select('active').eq('id', id).single();
          if(error) return alert(error.message);
          const next = !data.active;
          const { error: upErr } = await window.SB.from('item_allowed_types').update({ active: next }).eq('id', id);
          if(upErr) return alert(upErr.message);
          loadSchedulePage();
        }
      });
      grid.dataset.bound = '1';
    }
  }

  async function openScheduleModal(mode, id){
    if(!window.SB || !window.CURRENT_SITE_ID) return;
    
    // Pre-fetch items and types if they are not already loaded
    if (_SCHEDULE_ITEMS.length === 0 || _SCHEDULE_TYPES.length === 0) {
        const site = window.CURRENT_SITE_ID;
        const [{ data: itemsRes }, { data: typesRes }] = await Promise.all([
            window.SB.from('items').select('id,item_name').eq('site_id', site).eq('active', true).order('item_name', { ascending: true }),
            window.SB.from('check_types').select('id,name,category,active').eq('site_id', site).eq('active', true).order('name', { ascending: true })
        ]);
        _SCHEDULE_ITEMS = itemsRes || [];
        _SCHEDULE_TYPES = typesRes || [];
    }

    const modal     = document.getElementById('scheduleModal');
    const title     = document.getElementById('scheduleModalTitle');
    const itemSel   = document.getElementById('scheduleItemSel');
    const typeSel   = document.getElementById('scheduleTypeSel');
    const freqNum   = document.getElementById('freqNum');
    const freqUnit  = document.getElementById('freqUnit');
    const warnNum   = document.getElementById('warnNum');
    const warnUnit  = document.getElementById('warnUnit');
    const requiredC = document.getElementById('scheduleRequired');
    const activeC   = document.getElementById('scheduleActive');

    buildOptions(itemSel, _SCHEDULE_ITEMS, o=>o.id, o=>o.item_name, true);
    buildOptions(typeSel, _SCHEDULE_TYPES, o=>o.id, o=>`${o.name} (${o.category})`, true);

    modal.dataset.mode = mode;
    delete modal.dataset.id;

    if(mode === 'edit' && Number.isFinite(id)){
      title.textContent = 'Edit Schedule';
      modal.dataset.id = String(id);
      const { data, error } = await window.SB.from('item_allowed_types').select('item_id,check_type_id,frequency,warn_before,required,active').eq('id', id).single();
      if(error){ alert(error.message); return; }
      itemSel.value = String(data.item_id);
      typeSel.value = String(data.check_type_id);
      requiredC.checked = !!data.required;
      activeC.checked   = !!data.active;
      const fm = String(data.frequency||'7 days').match(/(\d+)\s*(minute|hour|day|week|month)/i);
      const wm = String(data.warn_before||'3 days').match(/(\d+)\s*(minute|hour|day|week|month)/i);
      freqNum.value  = fm ? fm[1] : '7';
      freqUnit.value = fm ? fm[2].toLowerCase() : 'day';
      warnNum.value  = wm ? wm[1] : '3';
      warnUnit.value = wm ? wm[2].toLowerCase() : 'day';
    }else{
      title.textContent = 'Add Schedule';
      itemSel.value = '';
      typeSel.value = '';
      freqNum.value = '7';  freqUnit.value = 'day';
      warnNum.value = '3';  warnUnit.value = 'day';
      requiredC.checked = true;
      activeC.checked   = true;
    }
    modal.style.display = 'flex';
  }

  async function saveScheduleModal(){
    const modal   = document.getElementById('scheduleModal');
    const mode    = modal.dataset.mode;
    const id      = Number(modal.dataset.id);

    const item_id       = Number(document.getElementById('scheduleItemSel').value);
    const check_type_id = Number(document.getElementById('scheduleTypeSel').value);
    const freq     = intervalFrom(document.getElementById('freqNum').value,  document.getElementById('freqUnit').value);
    const warn     = intervalFrom(document.getElementById('warnNum').value,  document.getElementById('warnUnit').value);
    const required = document.getElementById('scheduleRequired').checked;
    const active   = document.getElementById('scheduleActive').checked;

    if(!Number.isFinite(item_id) || !Number.isFinite(check_type_id)){
      alert('Select both an item and a check type.');
      return;
    }

    try{
      if(mode === 'edit' && Number.isFinite(id)){
        const { error } = await window.SB.from('item_allowed_types').update({ item_id, check_type_id, frequency: freq, warn_before: warn, required, active }).eq('id', id);
        if(error) throw error;
      }else{
        const { error } = await window.SB.from('item_allowed_types').upsert({ site_id: window.CURRENT_SITE_ID, item_id, check_type_id, frequency: freq, warn_before: warn, required, active }, { onConflict: 'site_id,item_id,check_type_id' });
        if(error) throw error;
      }
      modal.style.display = 'none';
      loadSchedulePage();
    }catch(e){ alert(e.message || 'Save failed'); }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const modal = document.getElementById('scheduleModal');
    if(modal && !modal.dataset.boundInit){
      document.getElementById('scheduleModalCancel').addEventListener('click', ()=>{ modal.style.display='none'; });
      document.getElementById('scheduleModalSave').addEventListener('click', saveScheduleModal);
      modal.dataset.boundInit = '1';
    }
  });
  /* --- End Schedule Logic --- */
  
  /* --- Calendar page logic --- */
    let calendarDate = new Date();
    let allSchedules = [];

    function getNextDueDate(schedule) {
        const base = schedule.last_completed_at ? new Date(schedule.last_completed_at) : new Date(schedule.created_at);
        const m = String(schedule.frequency).match(/(\d+)\s*(minute|hour|day|week|month)/i);
        let next = new Date(base);
        if (m) {
            const n = Number(m[1]);
            const unit = m[2].toLowerCase();
            if (unit.startsWith('minute')) next.setMinutes(next.getMinutes() + n);
            else if (unit.startsWith('hour')) next.setHours(next.getHours() + n);
            else if (unit.startsWith('day')) next.setDate(next.getDate() + n);
            else if (unit.startsWith('week')) next.setDate(next.getDate() + n * 7);
            else if (unit.startsWith('month')) next.setMonth(next.getMonth() + n);
        }
        return next;
    }

    async function loadCalendarData() {
        if (!window.SB || !window.CURRENT_SITE_ID) return;
        const site = window.CURRENT_SITE_ID;

        const { data, error } = await window.SB
            .from('item_allowed_types')
            .select('*, items(item_name), check_types(name)')
            .eq('site_id', site)
            .eq('active', true);

        if (error) {
            console.error('Error fetching calendar schedules:', error);
            allSchedules = [];
        } else {
            allSchedules = (data || []).map(s => ({
                ...s,
                next_due: getNextDueDate(s)
            }));
        }
        renderCalendar();
    }

    function renderCalendar() {
        const calGrid = document.getElementById('calGrid');
        const calMonthYear = document.getElementById('calMonthYear');
        if (!calGrid || !calMonthYear) return;

        calGrid.innerHTML = '';
        const month = calendarDate.getMonth();
        const year = calendarDate.getFullYear();

        calMonthYear.textContent = `${calendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        const paddingDays = firstDayOfMonth.getDay();

        const today = new Date();
        today.setHours(0,0,0,0);

        // A calendar grid has 6 rows (weeks) and 7 columns (days) = 42 cells
        for (let i = 0; i < 42; i++) {
            const daySquare = document.createElement('div');
            daySquare.classList.add('calendar-day');

            const day = i - paddingDays + 1;
            const currentDate = new Date(year, month, day);

            if (currentDate.getMonth() === month) {
                // This is a day in the current month
                currentDate.setHours(0,0,0,0);
                daySquare.innerHTML = `<div class="calendar-day-header">${day}</div><div class="calendar-events"></div>`;
                if (currentDate.getTime() === today.getTime()) {
                    daySquare.classList.add('today');
                }

                const eventsContainer = daySquare.querySelector('.calendar-events');
                const daySchedules = allSchedules.filter(s => {
                    const dueDate = new Date(s.next_due);
                    dueDate.setHours(0,0,0,0);
                    return dueDate.getTime() === currentDate.getTime();
                });

                daySchedules.forEach(schedule => {
                    const eventDiv = document.createElement('div');
                    eventDiv.classList.add('calendar-event');
                    eventDiv.dataset.scheduleId = schedule.id;
                    const itemName = schedule.items ? schedule.items.item_name : 'Unknown Item';
                    const typeName = schedule.check_types ? schedule.check_types.name : 'Unknown Type';
                    eventDiv.textContent = `${itemName}: ${typeName}`;
                    eventDiv.title = `${itemName}: ${typeName}`;
                    eventsContainer.appendChild(eventDiv);
                });
            } else {
                // This is a padding day from the previous or next month
                daySquare.classList.add('other-month');
                daySquare.innerHTML = `<div class="calendar-day-header">${currentDate.getDate()}</div>`;
            }
            calGrid.appendChild(daySquare);
        }
    }
    
    function openCheckOverviewModal(scheduleId) {
        const id = Number(scheduleId);
        const schedule = allSchedules.find(s => s.id === id);
        if (!schedule) return;

        document.getElementById('overviewItemName').textContent = schedule.items?.item_name || 'N/A';
        document.getElementById('overviewCheckType').textContent = schedule.check_types?.name || 'N/A';
        document.getElementById('overviewDueDate').textContent = new Date(schedule.next_due).toLocaleDateString();
        document.getElementById('overviewFrequency').textContent = formatInterval(schedule.frequency);
        document.getElementById('overviewLastDone').textContent = schedule.last_completed_at ? new Date(schedule.last_completed_at).toLocaleString() : 'Never';

        document.getElementById('checkOverviewModal').style.display = 'flex';
    }


    function setupCalendarUI() {
        const prevBtn = document.getElementById('calPrev');
        const nextBtn = document.getElementById('calNext');
        const calGrid = document.getElementById('calGrid');
        const overviewModal = document.getElementById('checkOverviewModal');
        const closeBtn = document.getElementById('overviewCloseBtn');

        if (prevBtn && !prevBtn.dataset.bound) {
            prevBtn.addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            });
            prevBtn.dataset.bound = '1';
        }

        if (nextBtn && !nextBtn.dataset.bound) {
            nextBtn.addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            });
            nextBtn.dataset.bound = '1';
        }
        
        if (calGrid && !calGrid.dataset.bound) {
            calGrid.addEventListener('click', (e) => {
                const eventEl = e.target.closest('.calendar-event');
                if (eventEl && eventEl.dataset.scheduleId) {
                    openCheckOverviewModal(eventEl.dataset.scheduleId);
                }
            });
            calGrid.dataset.bound = '1';
        }
        
        if (closeBtn && !closeBtn.dataset.bound) {
            closeBtn.addEventListener('click', () => {
                overviewModal.style.display = 'none';
            });
            closeBtn.dataset.bound = '1';
        }
    }
  /* --- End Calendar Logic --- */


  /* --- Dashboard helpers --- */
  async function loadDashboard() {
    if (!window.SB || !window.CURRENT_SITE_ID) return;
    const site = window.CURRENT_SITE_ID;

    // --- 1. Fetch all necessary data in parallel ---
    const [stats, schedulesRes] = await Promise.all([
        // Get counts for stat cards
        Promise.all([
            window.SB.from('rooms').select('id', { head: true, count: 'exact' }).eq('site_id', site),
            window.SB.from('items').select('id', { head: true, count: 'exact' }).eq('site_id', site).eq('active', true),
            window.SB.from('kiosk_users').select('id', { head: true, count: 'exact' }).eq('site_id', site).eq('active', true),
            window.SB.from('item_allowed_types').select('id', { head: true, count: 'exact' }).eq('site_id', site).eq('active', true)
        ]),
        // Get all active schedules with item and check type names
        window.SB.from('item_allowed_types')
            .select('*, items(item_name), check_types(name)')
            .eq('site_id', site)
            .eq('active', true)
    ]);

    // --- 2. Process and Render Stat Cards ---
    const [roomsC, itemsC, staffC, schC] = stats;
    const statsGrid = document.getElementById('dashStatsGrid');
    if (statsGrid) {
        statsGrid.innerHTML = `
            <div class="stat-card">
                <div class="stat-card-icon" style="background: #4A90E2;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></div>
                <div class="stat-card-info"><div class="value">${roomsC.count || 0}</div><div class="label">Rooms</div></div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon" style="background: #50E3C2;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg></div>
                <div class="stat-card-info"><div class="value">${itemsC.count || 0}</div><div class="label">Tracked Items</div></div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon" style="background: #B8E986;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div>
                <div class="stat-card-info"><div class="value">${staffC.count || 0}</div><div class="label">Active Staff</div></div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon" style="background: #F5A623;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></div>
                <div class="stat-card-info"><div class="value">${schC.count || 0}</div><div class="label">Active Schedules</div></div>
            </div>
        `;
    }

    // --- 3. Process Schedules for Overdue/Upcoming Lists ---
    if (schedulesRes.error) {
        console.error(schedulesRes.error);
        return;
    }
    const schedules = schedulesRes.data || [];
    const now = new Date();
    const warnLimit = new Date(now.getTime() + (3 * 24 * 60 * 60 * 1000)); // 3 days from now

    const processedSchedules = schedules.map(s => {
        const next_due = getNextDueDate(s);
        const daysDiff = (next_due - now) / (1000 * 60 * 60 * 24);
        return { ...s, next_due, daysDiff };
    });

    const overdue = processedSchedules.filter(s => s.next_due < now).sort((a,b) => a.next_due - b.next_due);
    const upcoming = processedSchedules.filter(s => s.next_due >= now && s.next_due < warnLimit).sort((a,b) => a.next_due - b.next_due);

    // --- 4. Render the Lists ---
    const renderList = (containerId, items, statusClass, statusTextFn) => {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (items.length === 0) {
            container.innerHTML = '<div class="empty-state">All clear!</div>';
            return;
        }
        container.innerHTML = items.map(item => `
            <div class="dash-list-item">
                <div>
                    <div class="item-name">${escapeHtml(item.items?.item_name || 'Unknown Item')}</div>
                    <div class="item-details">${escapeHtml(item.check_types?.name || 'Unknown Check')}</div>
                </div>
                <div class="status-pill ${statusClass}">${statusTextFn(item.daysDiff)}</div>
            </div>
        `).join('');
    };
    
    renderList('dashOverdueList', overdue, 'danger', d => `${Math.abs(Math.round(d))}d overdue`);
    renderList('dashUpcomingList', upcoming, 'warning', d => `Due in ${Math.max(0, Math.round(d))}d`);
}


  function setupDashboardUI(){
    const btn = document.getElementById('btnDashboardPage');
    if(btn && !btn.dataset.bound){
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.sidebar-button').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        showPage('dashboard');
      });
      btn.dataset.bound = '1';
    }
  }
  /* --- end Dashboard helpers --- */
  document.addEventListener('click', function(e){
    const m = document.getElementById('profileMenu');
    const a = document.getElementById('profileInitials');
    if(!m || !a) return;
    if (!a.contains(e.target) && !m.contains(e.target)) {
      m.style.display = 'none';
    }
  });

  // Simple SPA-style page switching
  function showPage(page){
    document.querySelectorAll('.main').forEach(p => p.style.display = 'none');
    const pageEl = document.getElementById(`page${page.charAt(0).toUpperCase() + page.slice(1)}`);
    if(pageEl) {
        pageEl.style.display = 'flex';
    }

    try { localStorage.setItem('CL_LAST_PAGE', page); } catch(_) {}
    
    document.querySelectorAll('.sidebar-button').forEach(b => b.classList.remove('selected'));
    const btnId = `btn${page.charAt(0).toUpperCase() + page.slice(1)}Page`;
    const activeBtn = document.getElementById(btnId);
    if(activeBtn) activeBtn.classList.add('selected');

    if(page === 'boxes'){
      setupRoomsUI();
      ensureRoomsLoaded();
      loadItems();
    } else if(page === 'items'){
      loadItemsPage();
    } else if(page === 'doctor'){
      if(typeof setupStaffUI === 'function') setupStaffUI();
      if(typeof loadStaff === 'function') loadStaff();
    } else if(page === 'schedule'){
      if(typeof setupScheduleUI === 'function') setupScheduleUI();
      if(typeof loadSchedulePage === 'function') loadSchedulePage();
    } else if (page === 'calendar') {
        if (typeof setupCalendarUI === 'function') setupCalendarUI();
        if (typeof loadCalendarData === 'function') loadCalendarData();
    } else if(page === 'dashboard'){
      setupDashboardUI();
      loadDashboard();
    }
  }
  // Items page table loader
  async function loadItemsPage(){
    if(!window.SB || !window.CURRENT_SITE_ID) return;
    if(!ROOMS_LOADED){ await loadRooms(); }
    const { data, error } = await window.SB
      .from('items')
      .select('id,item_id,item_name,room_id,active,category')
      .eq('site_id', window.CURRENT_SITE_ID)
      .eq('active', true)
      .order('item_name', { ascending: true });
    if(error){ console.error('items page load', error); return; }
    const tbody = document.querySelector('#itemsTable tbody');
    if(!tbody) return;
    const roomMap = new Map((ROOMS||[]).map(r=>[Number(r.id), r.name]));
    // Populate Room filter
    const roomSel = document.getElementById('itemsFilterRoom');
    if(roomSel){
      const current = roomSel.value;
      roomSel.innerHTML = '<option value="">All Rooms</option>' + (ROOMS||[]).map(r=>`<option value="${escapeHtml(r.name)}">${escapeHtml(r.name)}</option>`).join('');
      if(current) roomSel.value = current;
    }
    tbody.innerHTML = (data||[]).map(it=>{
      const roomName = it.room_id ? (roomMap.get(Number(it.room_id)) || 'Unknown') : 'Unassigned';
      const cat = (it.category || '').toString();
      return `
        <tr>
          <td>${escapeHtml(it.item_name||'')}</td>
          <td>${escapeHtml(it.item_id||'')}</td>
          <td>${escapeHtml(roomName)}</td>
          <td><span class="badge cat-${cat.toLowerCase()}">${escapeHtml(cat)}</span></td>
          <td><button class="config-btn" data-item-id="${it.id}">Configure</button></td>
        </tr>`;
    }).join('');
    if (typeof applyItemsFilter === 'function') { applyItemsFilter(); }
  }
  function applyItemsFilter(){
    const tbody = document.querySelector('#itemsTable tbody');
    if(!tbody) return;
    const q = (document.getElementById('itemsFilterInput')?.value || '').trim().toLowerCase();
    const selected = document.querySelector('input[name="itemsField"]:checked');
    const field = selected ? selected.value : 'name';
    const col = (field === 'name') ? 0 : (field === 'id' ? 1 : 2);
    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
      const tds = tr.querySelectorAll('td');
      const txt = (tds[col]?.textContent || '').toLowerCase();
      tr.style.display = (!q || txt.includes(q)) ? '' : 'none';
    });
  }

  function setupItemsFilter(){
    const input = document.getElementById('itemsFilterInput');
    const clearBtn = document.getElementById('itemsFilterClear');
    const radios = Array.from(document.querySelectorAll('input[name="itemsField"]'));
    const syncActive = ()=>{
      document.querySelectorAll('#itemsFieldRadios .radio-pill').forEach(l=>l.classList.remove('active'));
      const sel = document.querySelector('input[name="itemsField"]:checked');
      if(sel){ const label = sel.closest('.radio-pill'); if(label) label.classList.add('active'); }
    };
    if(input && !input.dataset.bound){ input.addEventListener('input', applyItemsFilter); input.dataset.bound='1'; }
    if(clearBtn && !clearBtn.dataset.bound){ clearBtn.addEventListener('click', ()=>{ if(input){ input.value=''; } applyItemsFilter(); if(input){ input.focus(); } }); clearBtn.dataset.bound='1'; }
    radios.forEach(r => { if(!r.dataset.bound){ r.addEventListener('change', ()=>{ syncActive(); applyItemsFilter(); }); r.dataset.bound='1'; }});
    syncActive();
  }

  function setupSidebar(){
    document.querySelectorAll('.sidebar-button').forEach(btn => {
        if (btn.dataset.bound) return;
        const pageName = btn.id.replace('btn', '').replace('Page', '').toLowerCase();
        btn.addEventListener('click', () => {
            showPage(pageName);
        });
        btn.dataset.bound = '1';
    });

    const logo = document.getElementById('logoBtn');
    if (logo && !logo.dataset.bound) {
      logo.addEventListener('click', () => { showPage('dashboard'); });
      logo.dataset.bound = '1';
    }
  }

  function setupNavRouting(){
    document.querySelectorAll('.nav .item').forEach(li => {
      const page = li.dataset.page;
      if(!page) return;
      li.addEventListener('click', () => showPage(page));
    });
  }

  function setupDnD(){
    const makeDraggable = (el)=>{
      el.setAttribute('draggable','true');
      el.addEventListener('dragstart', (e)=>{
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', el.dataset.itemId || '');
        el.classList.add('dragging');
        window.__draggingEl = el;
      });
      el.addEventListener('dragend', ()=>{
        el.classList.remove('dragging');
        window.__draggingEl = null;
        document.querySelectorAll('.rows.drop-target').forEach(x=>x.classList.remove('drop-target'));
      });
    };

    document.querySelectorAll('.row-card').forEach(makeDraggable);

    const zones = Array.from(document.querySelectorAll('.rows, .drop-box, .team-group'))
      .filter(Boolean)
      .filter(z => z.id !== 'leftRows' && z.id !== 'staffRows');
    zones.forEach(zone=>{
      zone.addEventListener('dragover', (e)=>{
        if(!window.__draggingEl) return; 
        e.preventDefault();
        zone.classList.add('drop-target');
        e.dataTransfer.dropEffect = 'move';
      });
      zone.addEventListener('dragleave', ()=>{
        zone.classList.remove('drop-target');
      });
      zone.addEventListener('drop', (e)=>{
        e.preventDefault();
        zone.classList.remove('drop-target');
        const el = window.__draggingEl;
        if(!el) return;
        // Insert at position based on mouse Y to "snap" in list order
        const after = Array.from(zone.querySelectorAll('.row-card')).find(child=>{
          const rect = child.getBoundingClientRect();
          return e.clientY < rect.top + rect.height/2;
        });
        if(after){ zone.insertBefore(el, after); }
        else{ zone.appendChild(el); }
        // --- Begin: staff card team‑change logic ---
        if(zone.id === 'staffRows' && el.dataset.staffId){
          // Determine the team header that now precedes the dropped card
          let newKey = 'no_team';
          let prev = el.previousElementSibling;
          while(prev){
            if(prev.classList && prev.classList.contains('team-header')){
              newKey = prev.dataset.teamId || 'no_team';
              break;
            }
            prev = prev.previousElementSibling;
          }
          const oldKey = el.dataset.teamId || 'no_team';
          if(newKey !== oldKey){
            changeUserTeam(Number(el.dataset.staffId), oldKey, newKey)
              .then(()=>{ el.dataset.teamId = newKey; })
              .catch(err => console.error('Team change error', err));
          }
        }
        // --- End: staff card team‑change logic ---
      });
    });
  }

  // --- Rooms logic (data + UI) ---
  let ROOMS = [];
  let ROOMS_LOADED = false;

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  function renderRooms(){
    const grid = document.getElementById('roomsGrid');
    if(!grid) return;
    grid.innerHTML = ROOMS.map(room =>
      `<div class="room-card" data-room-id="${room.id}">
        <div class="room-header">${escapeHtml(room.name || 'Unnamed')}</div>
        <button class="room-delete" title="Delete room" data-room-id="${room.id}" aria-label="Delete room">&minus;</button>
        <div class="room-items"></div>
      </div>`
    ).join('');
  }

  // Populates each room-card's .room-items with assigned items from Supabase
  async function renderRoomAssignments() {
    if (!window.SB || !window.CURRENT_SITE_ID) return;
    const { data, error } = await window.SB
      .from('items')
      .select('id,item_name,room_id')
      .eq('site_id', window.CURRENT_SITE_ID)
      .eq('active', true)
      .not('room_id', 'is', null)
      .order('item_name', { ascending: true });
    if (error) { console.error('items load', error); return; }
    // Clear existing lists
    document.querySelectorAll('.room-card .room-items').forEach(el => el.innerHTML = '');
    // Fill each room's items
    (data || []).forEach(item => {
      const target = document.querySelector(`.room-card[data-room-id="${item.room_id}"] .room-items`);
      if (target) {
        const node = document.createElement('div');
        node.className = 'room-item';
        node.dataset.itemId = item.id;
        node.dataset.roomId = String(item.room_id);
        node.setAttribute('draggable', 'true');
        node.textContent = item.item_name || 'Item';
        target.appendChild(node);
      }
    });
  }

  async function loadRooms() {
    if (!window.SB || !window.CURRENT_SITE_ID) return;
    const { data, error } = await window.SB
      .from('rooms')
      .select('id,name')
      .eq('site_id', window.CURRENT_SITE_ID)
      .order('name', { ascending: true });
    if (error) { console.error('rooms load', error); return; }
    ROOMS = data || [];
    ROOMS_LOADED = true;
    renderRooms();
    await renderRoomAssignments();
  }

  // Load items for current site (render only unassigned in right-side row cards)
  async function loadItems() {
    if (!window.SB || !window.CURRENT_SITE_ID) return;
    const { data, error } = await window.SB
      .from('items')
      .select('id,item_name,room_id')
      .eq('site_id', window.CURRENT_SITE_ID)
      .eq('active', true)
      .is('room_id', null)
      .order('item_name', { ascending: true });

    if (error) {
      console.error('Error loading items:', error);
      return;
    }

    const rightRows = document.getElementById('rightRows');
    if (!rightRows) return;
    rightRows.innerHTML = (data || []).map(item => (
      `<div class="row-card" draggable="true" data-item-id="${item.id}">${escapeHtml(item.item_name || 'Item')}</div>`
    )).join('');
  }

  function initRealtimeItems(){
    if(!window.SB || !window.CURRENT_SITE_ID) return;
    try{
      if(window._itemsChannel){ try { window._itemsChannel.unsubscribe(); } catch {} }
      const channel = window.SB
        .channel('items-realtime')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'items', filter: `site_id=eq.${window.CURRENT_SITE_ID}` },
          async (_payload) => {
            await loadRooms();
            await loadItems();
            if(document.getElementById('pageItems') && document.getElementById('pageItems').style.display !== 'none'){
              loadItemsPage();
            }
          }
        )
        .subscribe((_status)=>{});
      window._itemsChannel = channel;
    }catch(e){ console.error('Realtime sub error:', e); }
  }
  // --- Drag and drop handling for item cards and row-card items to room cards ---
  document.addEventListener('dragstart', (e) => {
    const t = e.target;
    if (!t || !t.classList) return;
    if (t.classList.contains('item-card') || t.classList.contains('row-card') || t.classList.contains('room-item')) {
      const id = t.dataset.itemId;
      if (id) e.dataTransfer.setData('text/plain', id);
      if (e.dataTransfer) e.dataTransfer.effectAllowed = 'move';
      try { t.classList.add('dragging'); } catch {}
      window.__draggingEl = t;
    }
  });

  document.addEventListener('dragend', (e) => {
    const t = e.target;
    if (t && t.classList && (t.classList.contains('item-card') || t.classList.contains('row-card') || t.classList.contains('room-item'))){
      try { t.classList.remove('dragging'); } catch {}
    }
    window.__draggingEl = null;
    document.querySelectorAll('.rows.drop-target').forEach(x=>x.classList.remove('drop-target'));
  });

  // Highlight drop targets and handle drop for .room-card
  document.addEventListener('DOMContentLoaded', () => {
    // Delegate dragover/dragleave/drop to each .room-card after rooms are loaded
    function setupRoomCardDnD() {
      document.querySelectorAll('.room-card').forEach(roomCard => {
        const itemsArea = roomCard.querySelector('.room-items');
        const zones = [roomCard, itemsArea].filter(Boolean);

        zones.forEach(z => {
          z.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            roomCard.classList.add('highlight');
            if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
          }, true);

          z.addEventListener('dragleave', (e) => {
            e.stopPropagation();
            roomCard.classList.remove('highlight');
          }, true);

          z.addEventListener('drop', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            roomCard.classList.remove('highlight');
            const itemIdStr = e.dataTransfer.getData('text/plain');
            const itemId = parseInt(itemIdStr, 10);
            const roomId = roomCard.dataset.roomId;
            const roomIdNum = parseInt(roomId, 10);
            if (!Number.isFinite(itemId) || !Number.isFinite(roomIdNum)) return;

            // If the dragged element is already in this room, skip DB update
            const existingNode = document.querySelector(`.room-item[data-item-id="${itemId}"]`);
            if (existingNode) {
              const currentRoomEl = existingNode.closest('.room-card');
              const currentRoomId = currentRoomEl ? currentRoomEl.dataset.roomId : null;
              if (currentRoomId && Number(currentRoomId) === roomIdNum) {
                return;
              }
            }

            const { error } = await window.SB
              .from('items')
              .update({ room_id: roomIdNum })
              .eq('id', itemId)
              .eq('site_id', window.CURRENT_SITE_ID);
            if (error) {
              console.error('Error updating item room:', error);
            } else {
              await loadRooms();
              await loadItems();
            }
          }, true);
        });
      });
    }
    window.setupRoomCardDnD = setupRoomCardDnD;
    // Set up after initial load and after every rooms reload
    const origLoadRooms = loadRooms;
    window.loadRooms = async function() {
      await origLoadRooms.apply(this, arguments);
      setupRoomCardDnD();
    };
    // Also run after DOMContentLoaded if rooms already present
    setupRoomCardDnD();
    // --- Begin: Add rightRows drop handler for unassigning ---
    function setupRightRowsDrop(){
      const zones = [
        document.getElementById('rightRows'),
        document.getElementById('itemsSecondary')
      ].filter(Boolean);
      zones.forEach(zone => {
        if(zone.dataset.boundUnassign === '1') return;
        zone.addEventListener('dragover', (e)=>{ 
          e.preventDefault(); 
          if(e.dataTransfer) e.dataTransfer.dropEffect = 'move'; 
          zone.classList.add('drop-target');
        }, true);
        zone.addEventListener('dragleave', ()=>{
          zone.classList.remove('drop-target');
        }, true);
        zone.addEventListener('drop', async (e)=>{
          e.preventDefault();
          e.stopPropagation();
          zone.classList.remove('drop-target');
          const itemIdStr = e.dataTransfer.getData('text/plain');
          const itemId = parseInt(itemIdStr, 10);
          if(!Number.isFinite(itemId) || !window.SB) return;
          const { error } = await window.SB
            .from('items')
            .update({ room_id: null })
            .eq('id', itemId)
            .eq('site_id', window.CURRENT_SITE_ID);
          if(error){ console.error('Unassign item error:', error); }
          await loadRooms();
          await loadItems();
        }, true);
        zone.dataset.boundUnassign = '1';
      });
    }
    setupRightRowsDrop();
    // --- End: Add rightRows drop handler for unassigning ---
  });

  // --- Items page population ---
  async function loadItems(){
    try {
      const sb = window.SB || window.supabase;
      if(!sb) return;
      const { data, error } = await sb
        .from('items')
        .select('id,item_id,item_name,room,room_id')
        .eq('site_id', window.CURRENT_SITE_ID)
        .eq('active', true)
        .order('item_name', { ascending: true });
      if(error){ console.error(error); return; }
      const tbody = document.querySelector('#itemsTable tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      (data||[]).forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(it.item_name || '')}</td>
          <td>${escapeHtml(it.item_id || '')}</td>
          <td>${escapeHtml(it.room || 'Unassigned')}</td>
          <td><button class="config-btn" data-item-id="${it.id}">Configure</button></td>
        `;
        tbody.appendChild(tr);
      });
      if (typeof applyItemsFilter === 'function') { applyItemsFilter(); }
    } catch(e){ console.error(e); }
  }

// ensure each page sets itself up even when restored after a reload
const origShowPage = showPage;
showPage = function(page){
  origShowPage(page);

  if (page === 'items') {
    loadItemsPage();            // refresh Items list/table
  } else if (page === 'boxes') {
    setupRoomsUI();
    ensureRoomsLoaded();
    loadItems();                // refresh unassigned items list
  } else if (page === 'doctor') {
    if (typeof setupStaffUI === 'function') setupStaffUI();
    if (typeof loadStaff   === 'function') loadStaff();
  } else if (page === 'schedule') {
    if (typeof setupScheduleUI   === 'function') setupScheduleUI();
    if (typeof loadSchedulePage === 'function') loadSchedulePage();
  } else if (page === 'dashboard') {
    setupDashboardUI();
    loadDashboard();
  }
}

// --- Restore last page reliably after reload/sign-in ---
// (Inserted immediately after showPage reassignment)
</script>
<script>
(function setupLastPageRestore(){
  function restore(){
    if(window._restoredLastPage) return;
    const shell = document.getElementById('appShell');
    if(!shell){ return; }
    const visible = shell.style.display !== 'none';
    if(visible){
      window._restoredLastPage = true;
      const last = (localStorage.getItem('CL_LAST_PAGE') || 'dashboard');
      showPage(last);
      return;
    }
    setTimeout(restore, 150);
  }
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(restore, 0);
  } else {
    document.addEventListener('DOMContentLoaded', restore);
  }
})();
</script>
<script data-app="main">

  async function addRoom(){
    if(!window.SB){ alert('Supabase not ready – please sign in again.'); return; }
    if(!window.CURRENT_SITE_ID){ alert('No site selected for this user (missing site_id).'); return; }
    const name = prompt('Room name?');
    if(!name) return;
    const { data, error } = await window.SB
      .from('rooms')
      .insert([{ site_id: window.CURRENT_SITE_ID, name: name.trim() }])
      .select('id,name')
      .single();
    if(error){ console.error('add room', error); alert(error.message); return; }
    ROOMS.unshift(data);
    renderRooms();
    await renderRoomAssignments();
    if (typeof window.setupRoomCardDnD === 'function') {
      window.setupRoomCardDnD();
    }
  }

  /* Add a new team for the current site */
  async function addTeam(){
    if(!window.SB){ alert('Supabase not ready – please sign in again.'); return; }
    if(!window.CURRENT_SITE_ID){ alert('No site selected for this user (missing site_id).'); return; }
    const name = prompt('Team name?');
    if(!name) return;
    const { error } = await window.SB
      .from('teams')
      .insert([{ site_id: window.CURRENT_SITE_ID, name: name.trim() }]);
    if(error){ console.error('add team', error); alert(error.message); return; }
    await loadStaff();   // refresh list to show the new team
  }



  // Delete a room: unassign its items then remove the room
  async function deleteRoomById(roomId){
    if(!window.SB || !window.CURRENT_SITE_ID) return;
    const idNum = Number(roomId);
    if(!Number.isFinite(idNum)) return;
    // Unassign items in this room
    const { error: itemsErr } = await window.SB
      .from('items')
      .update({ room_id: null })
      .eq('site_id', window.CURRENT_SITE_ID)
      .eq('room_id', idNum);
    if(itemsErr){ alert(itemsErr.message); return; }
    // Delete the room
    const { error: roomErr } = await window.SB
      .from('rooms')
      .delete()
      .eq('site_id', window.CURRENT_SITE_ID)
      .eq('id', idNum);
    if(roomErr){ alert(roomErr.message); return; }
    await loadRooms();
    await loadItems();
  }

  // Delegate click for delete buttons on dynamically rendered cards
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.room-delete');
    if(!btn) return;
    const card = btn.closest('.room-card');
    const name = card ? (card.querySelector('.room-header')?.textContent || 'this room') : 'this room';
    if(!confirm(`Delete "${name}"? Items will be unassigned.`)) return;
    await deleteRoomById(btn.dataset.roomId);
  });



  function ensureRoomsLoaded(){
    if(!ROOMS_LOADED) loadRooms();
  }

  function setupRoomsUI(){
    const btn = document.getElementById('addRoomBtn');
    if(btn && !btn.dataset.bound){
      btn.addEventListener('click', addRoom);
      btn.dataset.bound = '1';
    }
  }
  // Update team_members when a staff card is moved to a different team
  async function changeUserTeam(userId, oldKey, newKey){
    if(!window.SB || !window.CURRENT_SITE_ID) return;
    try{
      // Remove old membership if necessary
      if(oldKey !== 'no_team'){
        await window.SB
          .from('team_members')
          .delete()
          .eq('site_id', window.CURRENT_SITE_ID)
          .eq('user_id', userId)
          .eq('team_id', oldKey);
      }
      // Add or update new membership
      if(newKey !== 'no_team'){
        await window.SB
          .from('team_members')
          .upsert(
            { site_id: window.CURRENT_SITE_ID, user_id: userId, team_id: newKey },
            { onConflict: 'site_id, user_id, team_id' }
          );
      }
    }catch(e){
      console.error('changeUserTeam', e);
    }
  }
  // --- Staff page helpers ---
  async function loadStaff(){
    if(!window.SB || !window.CURRENT_SITE_ID) return;
    try{
      const sb = window.SB;
      const siteId = window.CURRENT_SITE_ID;
      // Fetch users and team membership rows
      const [usersRes, tmRes] = await Promise.all([
        sb
          .from('kiosk_users')
          .select('id,full_name,role,active,created_at,pin,pin_hash')
          .eq('site_id', siteId)
          .order('full_name', { ascending: true }),
        sb
          .from('team_members')
          .select('user_id,team_id')
          .eq('site_id', siteId)
      ]);

      const users = usersRes.data || [];
      const memberships = tmRes.data || [];
      if(usersRes.error){ console.error('loadStaff users', usersRes.error); }
      if(tmRes.error){ console.error('loadStaff team_members', tmRes.error); }

      // Fetch team names for referenced team_ids
      const teamIds = Array.from(new Set(memberships.map(m => Number(m.team_id)).filter(n => Number.isFinite(n))));
      let teamNameById = new Map();
      if(teamIds.length){
        const teamsRes = await sb
          .from('teams')
          .select('id,name')
          .in('id', teamIds);
        if(teamsRes.error){ console.error('loadStaff teams', teamsRes.error); }
        const teams = teamsRes.data || [];
        teamNameById = new Map(teams.map(t => [String(t.id), t.name || `Team ${t.id}`]));
      }

      // Build user -> teamIds map
      const userTeams = new Map();
      memberships.forEach(m => {
        const uid = String(m.user_id);
        const arr = userTeams.get(uid) || [];
        arr.push(m.team_id);
        userTeams.set(uid, arr);
      });

      // Left column mini list with PIN checkmark/cross
      const list = document.getElementById('staffList');
      if(list){
        list.innerHTML = users.map(u => {
          const roleTxt = u.role ? (' — ' + escapeHtml(u.role)) : '';
          const pinTxt = (u.pin || u.pin_hash) ? ' • ✓' : ' • ✕';
          return `<div class="row-card" data-staff-id="${u.id}">${escapeHtml(u.full_name || 'Unnamed')}${roleTxt}${pinTxt}</div>`;
        }).join('');
      }

      // Group by team_id; include 'No Team' for users without membership
      const groups = new Map(); // key => {name, members[]}
      function ensureGroup(key){
        if(!groups.has(key)){
          const name = (key === 'no_team') ? 'No Team' : (teamNameById.get(String(key)) || `Team ${key}`);
          groups.set(key, { name, members: [] });
        }
        return groups.get(key);
      }
      users.forEach(u => {
        const tids = userTeams.get(String(u.id)) || [];
        if(!tids.length){
          ensureGroup('no_team').members.push(u);
        } else {
          tids.forEach(tid => { ensureGroup(String(tid)).members.push(u); });
        }
      });

      // Sort groups by name, and members by full_name
      const sortedGroups = Array.from(groups.entries()).map(([key, g]) => ({ key, ...g }));
      sortedGroups.sort((a,b) => a.name.localeCompare(b.name));
      sortedGroups.forEach(g => g.members.sort((a,b) => (a.full_name||'').localeCompare(b.full_name||'')));

      const staffRows = document.getElementById('staffRows');
      if (staffRows) {
        const headersHtml = '<div class="staff-headers"><div>Name</div><div>Role</div><div>Pin</div><div></div></div>';
        const groupsHtml = sortedGroups.map(g => {
          const header = `<div class="team-header" data-team-id="${g.key}">${escapeHtml(g.name)}</div>`;
          const membersHtml = g.members.map(u => {
            const pinYes = (u.pin || u.pin_hash);
            return `<div class="row-card staff-row" draggable="true" data-staff-id="${u.id}" data-team-id="${g.key}">
              <div class="staff-name">${escapeHtml(u.full_name || 'Unnamed')}</div>
              <div class="staff-role">${escapeHtml(u.role || '')}</div>
              <div class="staff-pin ${pinYes ? 'pin-yes' : 'pin-no'}">${pinYes ? '✓' : '✕'}</div>
              <div><button class="staff-config-btn" title="Configure" data-staff-id="${u.id}">⚙️</button></div>
            </div>`;
          }).join('');
          return `<div class="team-group" data-team-id="${g.key}">${header + membersHtml}</div>`;
        }).join('');
        staffRows.innerHTML = headersHtml + groupsHtml;
        // Re‑enable drag‑and‑drop behaviour reused from boxes page
        if (typeof setupDnD === 'function') setupDnD();
        if (typeof applyStaffFilter === 'function') applyStaffFilter();
      }
    } catch(e){ console.error(e); }
  }

  /* --- Configure staff helper --- */
  async function configureStaff(staffId){
    const sid = Number(staffId);
    if(!window.SB || !window.CURRENT_SITE_ID || !Number.isFinite(sid)) return;
    try{
      // fetch current user record
      const { data: user, error } = await window.SB
        .from('kiosk_users')
        .select('full_name, role, pin')
        .eq('id', sid)
        .single();
      if(error){ alert(error.message); return; }

      // ensure role list cached
      if(!window._rolesCache){
        const { data: rolesData, error: rolesErr } = await window.SB
          .from('kiosk_users')
          .select('role')
          .eq('site_id', window.CURRENT_SITE_ID)
          .neq('role', null);
        if(!rolesErr){
          window._rolesCache = Array.from(new Set((rolesData||[]).map(r=>r.role).filter(Boolean))).sort();
        }
      }
      const roles = window._rolesCache || [];

      // populate modal elements
      const overlay = document.getElementById('staffModal');
      if(!overlay) return;
      const nameEl = document.getElementById('staffModalName');
      const roleSel = document.getElementById('staffModalRole');
      const pinDisp = document.getElementById('staffModalPinDisplay');
      const pinInp  = document.getElementById('staffModalPinInput');

      nameEl.value = user?.full_name || '';
      // build role options if not already
      if(roleSel.dataset.built !== '1'){
        roleSel.innerHTML = roles.map(r=>`<option value="${r}">${r}</option>`).join('');
        roleSel.dataset.built = '1';
      }
      roleSel.value = user?.role || '';

      pinDisp.textContent = (user?.pin || user?.pin === '') ? '****' : 'None';
      pinInp.value = '';

      overlay.style.display = 'flex';

      // attach once‑only button handlers
      if(!overlay.dataset.bound){
        const close = ()=>{ overlay.style.display='none'; };
        document.getElementById('staffModalCancel').addEventListener('click', close);
        document.getElementById('staffModalPinChange').addEventListener('click', ()=>{
          pinInp.style.display = 'block';
          pinInp.focus();
        });
        document.getElementById('staffModalSave').addEventListener('click', async ()=>{
          const updates = {
            full_name: nameEl.value.trim(),
            role: roleSel.value
          };
          if(pinInp.style.display !== 'none' && pinInp.value.trim() !== ''){
            updates.pin = pinInp.value.trim();
          }
          const { error: upErr } = await window.SB
            .from('kiosk_users')
            .update(updates)
            .eq('id', sid);
          if(upErr){ alert(upErr.message); return; }
          close();
          await loadStaff();
        });
        overlay.dataset.bound = '1';
      }
    }catch(e){ console.error('configureStaff', e); }
  }

  // Delegate click handling for configure buttons
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.staff-config-btn');
    if(btn){
      e.stopPropagation();
      configureStaff(btn.dataset.staffId);
    }
  });

  // Collapse/expand helper for team groups in staff table
  function setupTeamCollapse(){
    // Delegate click behaviour for team header rows
    document.addEventListener('click', (e) => {
      const th = e.target.closest && e.target.closest('.team-header');
      if(!th) return;
      const tb = th.closest && th.closest('tbody.team-group');
      if(!tb) return;
      const caret = th.querySelector('.collapse-caret');
      const isCollapsed = tb.classList.toggle('collapsed');
      // show/hide all non-header rows in this tbody
      Array.from(tb.querySelectorAll('tr')).forEach(r => {
        if(r.classList && r.classList.contains('team-header')) return;
        r.style.display = isCollapsed ? 'none' : '';
      });
      if(caret) caret.textContent = isCollapsed ? '▸' : '▾';
    });

    // Initialize collapsed state (none collapsed by default) and ensure header cursors
    document.querySelectorAll('tbody.team-group').forEach(tb => {
      const header = tb.querySelector('.team-header');
      if(header){ header.style.cursor = 'pointer'; }
      // make sure caret exists and is in correct initial state
      const caret = header && header.querySelector('.collapse-caret');
      if(caret) caret.textContent = tb.classList.contains('collapsed') ? '▸' : '▾';
    });
  }

  function applyStaffFilter(){
    const tbody = document.querySelector('#staffTable tbody');
    if(tbody){
      const q = (document.getElementById('staffFilterInput')?.value || '').trim().toLowerCase();
      const selected = document.querySelector('input[name="staffField"]:checked');
      const field = selected ? selected.value : 'name';
      const col = (field === 'name') ? 0 : (field === 'role' ? 2 : 0);
      Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
        // keep team header rows visible
        if(tr.classList && tr.classList.contains('team-header')){ tr.style.display = ''; return; }
        const tds = tr.querySelectorAll('td');
        const txt = (tds[col]?.textContent || '').toLowerCase();
        tr.style.display = (!q || txt.includes(q)) ? '' : 'none';
      });
    }
    // Also filter the new draggable cards list
    const cardContainer = document.getElementById('staffRows');
    if (cardContainer) {
      Array.from(cardContainer.querySelectorAll('.row-card')).forEach(card => {
        const txt = (card.textContent || '').toLowerCase();
        card.style.display = (!q || txt.includes(q)) ? '' : 'none';
      });
      // Show or hide each team header depending on whether it has any visible member rows
      const headers = Array.from(cardContainer.querySelectorAll('.team-header'));
      headers.forEach(h => {
        let sib = h.nextElementSibling;
        let anyVisible = false;
        while(sib && !sib.classList.contains('team-header')){
          if(sib.style.display !== 'none'){ anyVisible = true; break; }
          sib = sib.nextElementSibling;
        }
        h.style.display = anyVisible ? '' : 'none';
      });
    }
  }

  function setupStaffFilter(){
    const input = document.getElementById('staffFilterInput');
    const clearBtn = document.getElementById('staffFilterClear');
    const radios = Array.from(document.querySelectorAll('input[name="staffField"]'));
    const syncActive = ()=>{
      document.querySelectorAll('#staffFieldRadios .radio-pill').forEach(l=>l.classList.remove('active'));
      const sel = document.querySelector('input[name="staffField"]:checked');
      if(sel){ const label = sel.closest('.radio-pill'); if(label) label.classList.add('active'); }
    };
    if(input && !input.dataset.bound){ input.addEventListener('input', applyStaffFilter); input.dataset.bound='1'; }
    if(clearBtn && !clearBtn.dataset.bound){ clearBtn.addEventListener('click', ()=>{ if(input){ input.value=''; } applyStaffFilter(); if(input){ input.focus(); } }); clearBtn.dataset.bound='1'; }
    radios.forEach(r => { if(!r.dataset.bound){ r.addEventListener('change', ()=>{ syncActive(); applyStaffFilter(); }); r.dataset.bound='1'; }});
    syncActive();
  }

  function setupStaffUI(){
    const addStaffBtn = document.getElementById('addStaffBtn');
    if(addStaffBtn && !addStaffBtn.dataset.bound){
      addStaffBtn.addEventListener('click', async ()=>{
        if(!window.SB || !window.CURRENT_SITE_ID){ alert('Supabase not ready'); return; }
        const name = prompt('Staff full name?');
        if(!name) return;
        const { error } = await window.SB
          .from('kiosk_users')
          .insert([{ site_id: window.CURRENT_SITE_ID, full_name: name.trim(), active: true }]);
        if(error){ alert(error.message || 'Failed to add staff'); return; }
        await loadStaff();
      });
      addStaffBtn.dataset.bound = '1';
    }

    const addTeamBtn = document.getElementById('addTeamBtn');
    if(addTeamBtn && !addTeamBtn.dataset.bound){
      addTeamBtn.addEventListener('click', addTeam);
      addTeamBtn.dataset.bound = '1';
    }
    // ensure filters wired
    setupStaffFilter();
  }

// Ensure listeners are bound after DOM is ready
if(document.readyState === 'complete' || document.readyState === 'interactive'){
  setTimeout(setupNavRouting, 0);
 setTimeout(setupSidebar, 0);
  setTimeout(setupDnD, 0);
  setTimeout(setupRoomsUI, 0);
  setTimeout(ensureRoomsLoaded, 0);
  setTimeout(loadItems, 0);
  setTimeout(setupItemsFilter, 0);
  setTimeout(setupStaffUI, 0);
  setTimeout(setupStaffFilter, 0);
  setTimeout(setupTeamCollapse, 0);
} else {
  document.addEventListener('DOMContentLoaded', setupNavRouting);
  document.addEventListener('DOMContentLoaded', setupSidebar);
  document.addEventListener('DOMContentLoaded', setupDnD);
 document.addEventListener('DOMContentLoaded', setupRoomsUI);
  document.addEventListener('DOMContentLoaded', ensureRoomsLoaded);
  document.addEventListener('DOMContentLoaded', loadItems);
  document.addEventListener('DOMContentLoaded', setupItemsFilter);
  document.addEventListener('DOMContentLoaded', setupStaffUI);
  document.addEventListener('DOMContentLoaded', setupStaffFilter);
  document.addEventListener('DOMContentLoaded', setupTeamCollapse);
}

 // Global error hooks -> debug box
  window.onerror = function(message, source, lineno, colno, error){
  };
  window.onunhandledrejection = function(e){
  };

  const SUPABASE_URL = 'https://unveoqnlqnobufhublyw.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME';

  const form = document.getElementById('loginForm');
  const email = document.getElementById('email');
  const password = document.getElementById('password');
  const btn = document.getElementById('signInBtn');
  const err = document.getElementById('err');
  const authCard = document.getElementById('authCard');
  const successCard = document.getElementById('successCard');
  const logoutBtn = document.getElementById('logoutBtn');
  const remember = document.getElementById('remember');
  const REMEMBER_KEY = 'remember_me';

  const wrap = document.querySelector('.wrap');
  const appShell = document.getElementById('appShell');
  const profileInitials = document.getElementById('profileInitials');
  const profileName = document.getElementById('profileName');
  const profileEmail = document.getElementById('profileEmail');
  const navLogout = document.getElementById('navLogout');

  // In-memory, non-persistent storage (clears on refresh)
  const inMemoryStorage = (()=>{
    const m = new Map();
    return {
      get length(){ return m.size; },
      key(i){ return Array.from(m.keys())[i] ?? null; },
      getItem(k){ const v = m.get(k); return v === undefined ? null : v; },
      setItem(k,v){ m.set(String(k), String(v)); },
      removeItem(k){ m.delete(k); },
      clear(){ m.clear(); }
    };
  })();

  function clearSupabaseStorage(storage){
    try{
      for(let i = storage.length - 1; i >= 0; i--){
        const k = storage.key(i);
        if(k && k.startsWith('sb-')){ storage.removeItem(k); }
      }
    }catch{}
  }

  function showError(msg){ err.textContent = msg; err.style.display = 'block'; }
  function clearError(){ err.style.display='none'; err.textContent=''; }

  function getInitials(name, email){
    const n = (name||'').trim();
    if(n){
      const parts = n.split(/\s+/);
      const first = parts[0]?.[0]||'';
      const last = parts.length>1 ? parts[parts.length-1][0] : '';
      const str = (first+last) || first;
      return (str||'?').toUpperCase();
    }
    const em = (email||'').trim();
    return em ? em[0].toUpperCase() : '?';
  }
  function showApp(defaultPage){
    wrap.style.display='none';
    appShell.style.display='grid';
    const last = (function(){
      try { return localStorage.getItem('CL_LAST_PAGE'); } catch(_) { return null; }
    })();
    const page = defaultPage || last || 'dashboard';
    showPage(page);
  }
  function showAuth(){ wrap.style.display='grid'; appShell.style.display='none'; }

  async function loadUserDetails(supabase){
    try{
      const { data: userRes } = await supabase.auth.getUser();
      const user = userRes && userRes.user;
      if(!user){ return; }
      const { data: profile } = await supabase
        .from('profiles')
        .select('site_id, full_name')
        .eq('user_id', user.id)
        .single();
      
      const welcomeName = document.getElementById('welcomeName');
      if (welcomeName && profile?.full_name) {
          welcomeName.textContent = `Welcome, ${profile.full_name.split(' ')[0]}!`;
      }

      if(profileInitials) profileInitials.textContent = getInitials(profile?.full_name, user.email);
      
      window.CURRENT_SITE_ID = profile?.site_id || null;
      window.SB = supabase;

      if(window.CURRENT_SITE_ID){
        initRealtimeItems();
      }
    }catch(e){ console.error("Error loading user details:", e) }
  }

  async function doLogout(){
    if (!window.SB) return;
    await window.SB.auth.signOut();
    clearSupabaseStorage(localStorage);
    try { localStorage.setItem(REMEMBER_KEY, '0'); } catch {}
    if(window._itemsChannel){
      try { window._itemsChannel.unsubscribe(); } catch {}
      window._itemsChannel = null;
    }
    window.SB = null;
    window.CURRENT_SITE_ID = null;
    ROOMS = [];
    ROOMS_LOADED = false;
    showAuth();
    form.reset();
    remember.checked = false;
  }
  
  function initAuth(){
    try{
      if(!window.supabase || !window.supabase.createClient){
        throw new Error('Supabase library not loaded');
      }
      let supabase;
      function storageChoice(){
        const saved = localStorage.getItem(REMEMBER_KEY);
        return saved === '1' ? window.localStorage : inMemoryStorage;
      }
      function makeClient(){
        return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: storageChoice() }
        });
      }
      let remembered = false;
      try { remembered = (localStorage.getItem(REMEMBER_KEY) === '1'); remember.checked = remembered; } catch {}
      if(!remembered){ clearSupabaseStorage(localStorage); }
      
      supabase = makeClient();
      window.SB = supabase;
      
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        clearError();
        btn.disabled = true; btn.textContent = 'Signing in…';
        try{
          const wantRemember = !!remember.checked;
          try { localStorage.setItem(REMEMBER_KEY, wantRemember ? '1' : '0'); } catch {}
          if(wantRemember !== (storageChoice() === window.localStorage)) {
              supabase = makeClient();
              window.SB = supabase;
          }
          const { data, error } = await supabase.auth.signInWithPassword({ email: email.value.trim(), password: password.value });
          if(error) throw error;
          if(!data || !data.user || !data.user.id){ throw new Error('No user returned from Supabase.'); }
          await loadUserDetails(supabase);
          showApp('dashboard');
        }catch(ex){
          showError(ex.message || 'Unable to sign in.');
          // Re-add the listener if sign in fails, so the user can try again.
          form.addEventListener('submit', arguments.callee, { once: true });
        }finally{
          btn.disabled = false; btn.textContent = 'Sign In';
        }
      }, { once: true });

      supabase.auth.getSession()
        .then(async ({ data }) => {
          if (data && data.session) {
            await loadUserDetails(supabase);
            showApp();
          } else {
            showAuth();
          }
        })
        .catch(() => {
          showAuth();
        });

      supabase.auth.onAuthStateChange(async (_event, session) => {
        if (session) {
          await loadUserDetails(supabase);
          showApp();
        } else {
          showAuth();
        }
      });

      const forgotBtn = document.getElementById('forgotBtn');
      const backBtn = document.getElementById('backBtn');
      const pwdLabel = document.querySelector('label[for="password"]');
      const formMeta = document.querySelector('.form-meta');
      const altRow = document.querySelector('.alt');

      function toResetUI(){
        if(pwdLabel) pwdLabel.style.display = 'none';
        password.style.display = 'none';
        if(formMeta) formMeta.style.display = 'none';
        if(altRow) altRow.style.display = 'none';
        btn.textContent = 'Send Password Reset';
        backBtn.style.display = 'inline';
        clearError();
      }

      function toSignInUI(){
        if(pwdLabel) pwdLabel.style.display = 'block';
        password.style.display = 'block';
        if(formMeta) formMeta.style.display = 'flex';
        if(altRow) altRow.style.display = 'flex';
        btn.textContent = 'Sign In';
        backBtn.style.display = 'none';
        clearError();
        form.onsubmit = null;
      }

      forgotBtn.addEventListener('click', ()=>{
        toResetUI();
        form.onsubmit = async (e) => {
          e.preventDefault();
          const emailValue = email.value.trim();
          if (!emailValue) {
            showError('Enter your email to reset password.');
            return;
          }
          try {
            const { error } = await supabase.auth.resetPasswordForEmail(emailValue, {
              redirectTo: window.location.href
            });
            if (error) throw error;
            showError('Check your email for the reset link.');
          } catch (ex) {
            showError(ex.message || 'Failed to initiate reset.');
          }
        };
      });

      backBtn.addEventListener('click', ()=>{
        toSignInUI();
        // Re-attach the main sign-in listener
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();
            btn.disabled = true; btn.textContent = 'Signing in…';
            try {
                const wantRemember = !!remember.checked;
                try { localStorage.setItem(REMEMBER_KEY, wantRemember ? '1' : '0'); } catch {}
                if (wantRemember !== (storageChoice() === window.localStorage)) {
                    supabase = makeClient();
                    window.SB = supabase;
                }
                const { data, error } = await supabase.auth.signInWithPassword({ email: email.value.trim(), password: password.value });
                if (error) throw error;
                if (!data || !data.user || !data.user.id) { throw new Error('No user returned from Supabase.'); }
                await loadUserDetails(supabase);
                showApp('dashboard');
            } catch (ex) {
                showError(ex.message || 'Unable to sign in.');
                form.addEventListener('submit', arguments.callee, { once: true });
            } finally {
                btn.disabled = false; btn.textContent = 'Sign In';
            }
        }, { once: true });
      });

      document.getElementById('createBtn').addEventListener('click', ()=>{ showError('Create account is not wired yet.'); });

    }catch(e){
      showError(e.message);
    }
  }

  (function ensureSupabase(){
    try{
      if(window.supabase && window.supabase.createClient){
        initAuth();
        return;
      }
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
      s.async = true;
      s.onload = initAuth;
      s.onerror = ()=>{ showError('Unable to load Supabase library.'); };
      document.head.appendChild(s);
    }catch(e){
        showError(e.message);
    }
  })();

/* --- Configure item helper --- */
async function configureItem(itemPk){
  const idNum = Number(itemPk);
  if(!window.SB || !window.CURRENT_SITE_ID || !Number.isFinite(idNum)) return;
  try{
    const { data: item, error } = await window.SB
      .from('items')
      .select('item_name,item_id,room_id')
      .eq('id', idNum)
      .single();
    if(error){ alert(error.message); return; }

    if(!ROOMS_LOADED){ await loadRooms(); }

    const overlay = document.getElementById('itemModal');
    if(!overlay) return;
    const nameEl = document.getElementById('itemModalName');
    const idEl   = document.getElementById('itemModalId');
    const roomSel= document.getElementById('itemModalRoom');

    nameEl.value = item.item_name || '';
    idEl.value   = item.item_id   || '';

    // build room options once
    if(roomSel.dataset.built !== '1'){
      roomSel.innerHTML = '<option value=\"\">Unassigned</option>' + (ROOMS||[]).map(r=>`<option value=\"${r.id}\">${escapeHtml(r.name)}</option>`).join('');
      roomSel.dataset.built = '1';
    }
    roomSel.value = (item.room_id !== null && item.room_id !== undefined) ? String(item.room_id) : '';

    overlay.style.display = 'flex';

    if(!overlay.dataset.bound){
      const close = ()=>{ overlay.style.display='none'; };
      document.getElementById('itemModalCancel').addEventListener('click', close);
      document.getElementById('itemModalSave').addEventListener('click', async ()=>{
        const updates = {
          item_name: nameEl.value.trim(),
          item_id:   idEl.value.trim(),
          room_id:   roomSel.value ? Number(roomSel.value) : null
        };
        const { error: upErr } = await window.SB
          .from('items')
          .update(updates)
          .eq('id', idNum);
        if(upErr){ alert(upErr.message); return; }
        close();
        await loadItems();
        await loadRooms();
      });
      overlay.dataset.bound = '1';
    }
  }catch(e){ console.error('configureItem', e); }
}

// Delegate click handling for item Configure buttons
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.config-btn[data-item-id]');
  if(btn){
    e.stopPropagation();
    configureItem(btn.dataset.itemId);
  }
});
</script>

<script >
  // Call loadRooms and loadItems after script load (for demo/test)
  loadRooms();
  loadItems();
</script>
</body>
</html>

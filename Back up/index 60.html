<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CheckLoop — Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  // Configure PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
<style>
  :root{
    --bg1:#0b4fb3; --bg2:#062b6f; --glass:#ffffff12; --glass-2:#ffffff1a;
    --white:#e6f0ff; --muted:#b8c7e8; --ink:#eaf1ff;
    --accent:#76a7ff; --accent-2:#5f96ff; --success:#2bd4a7; --danger:#ff6b6b;
    --warning: #ffca28;
    --shadow: 0 10px 30px rgba(6,43,111,.35);
    --round:18px;
    --panel-bg: linear-gradient(145deg, #133b8a, #0c275e);
    --border-color: #ffffff1f;
    --stat-1-bg: #8e6eff33; --stat-1-color: #c4b5fd;
    --stat-2-bg: #2bd4a733; --stat-2-color: #6ee7b7;
    --stat-3-bg: #ffca2833; --stat-3-color: #ffe082;
    --stat-4-bg: #ff6b6b33; --stat-4-color: #fca5a5;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--ink); background:#0b3a86; overflow-x:hidden;
  }
  /* Silky animated background */
  .bg{
    position:fixed; inset:0; z-index:-1; overflow:hidden; background: radial-gradient(1200px 700px at 20% -10%, #6aa0ff33, transparent),
      radial-gradient(900px 600px at 90% 10%, #3566ff2e, transparent),
      linear-gradient(180deg, #0e3f93 0%, #082a69 100%);
  }
  .wave{
    position:absolute; width:160%; height:160%; left:-30%; top:-30%;
    background: conic-gradient(from 180deg at 50% 50%, #2c63ff22, #143a9622, #2c63ff22);
    filter: blur(60px);
    animation: drift 22s ease-in-out infinite alternate;
    transform-origin: 50% 50%;
  }
  .wave2{ animation-duration: 28s; mix-blend-mode: screen; }
  @keyframes drift{
    0%{ transform: rotate(0deg) scale(1.0); }
    100%{ transform: rotate(25deg) scale(1.08); }
  }

  /* Layout */
  .app{ display:grid; --sidebarW:260px; grid-template-columns: var(--sidebarW) 1fr; gap:22px; padding:22px; min-height:100vh; transition: grid-template-columns .2s ease; }
  .app.collapsed{ --sidebarW:56px; }
  .sidebar{
    background: linear-gradient(180deg, #1a4ea8 0%, #0e367e 100%);
    border-radius:20px; box-shadow: var(--shadow); padding:14px;
    transition: width 0.2s;
  }
  .app.collapsed #sidebar {
    overflow-x: hidden;
    padding-left: 6px;
    padding-right: 6px;
  }
  .app.collapsed #sidebar .brand .t,
  .app.collapsed #sidebar .brand .hint,
  .app.collapsed #sidebar .menu-item-label { display:none; }
  .app.collapsed #sidebar .nav button{ justify-content:center; gap:0; padding:10px; }
  .app.collapsed #sidebar .icon{ margin:0; }
  .sidebar-toggle {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: var(--white);
    margin-bottom: 8px;
    margin-left: 2px;
    margin-top: 2px;
    display: block;
  }
  .brand{ display:flex; align-items:center; gap:10px; padding:10px 12px 16px; }
  .brand .logo{ width:32px; height:32px; border-radius:10px; background:linear-gradient(135deg,#9ec1ff,#3f78ff); box-shadow: inset 0 0 0 2px #ffffff33; }
  .brand .t{ font-weight:800; letter-spacing:.2px }

  .nav{ display:flex; flex-direction:column; gap:6px; margin-top:6px; }
  .nav button{
    all:unset; display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px;
    cursor:pointer; color:var(--white); opacity:.85;
    transition: transform .12s ease, background .2s ease, opacity .2s ease;
  }
  /* Group toggle for grouped menus (Configure / Checks & Audits) */
  .nav-group-toggle {
    all:unset; display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:8px 12px; color:var(--muted); font-weight:700; font-size:12px; cursor:pointer;
    border-radius:8px; margin-top:8px;
  }
  .nav-group-toggle:hover { background: #ffffff08; }
  .nav-group-toggle .caret {
    display:inline-block; width:10px; height:10px; transform-origin:center; transition: transform .18s ease, border-color .18s ease;
    border-right:2px solid var(--muted); border-bottom:2px solid var(--muted); transform: rotate(-45deg);
  }
  .nav-group-toggle[aria-expanded="true"] .caret { transform: rotate(45deg); border-color: var(--accent-2); }
  .nav-group { display:flex; flex-direction:column; gap:6px; padding-left:4px; }
  .nav-group.collapsed { display:none; }
  /* Tweak group toggles when sidebar collapsed: keep a compact, centred caret so the
     user still sees grouping affordance and icons remain visible (avoid disappearing UI). */
  .app.collapsed #sidebar .nav .nav-group-toggle {
    display:flex; align-items:center; justify-content:center; gap:0;
    padding:8px; border-radius:8px; margin-top:8px;
    color: var(--muted); background: transparent;
  }
  /* Ensure the caret remains visible and compact */
  .app.collapsed #sidebar .nav .nav-group-toggle .caret { display:block; transform: rotate(0deg); border-color: var(--muted); }

  /* Keep icons visible and consistent when collapsed */
  .app.collapsed #sidebar .nav .icon { margin:0; width:20px; height:20px; }

  /* Hide nav-group-toggle label text when collapsed but keep the caret visible */
  .app.collapsed #sidebar .nav .nav-group-toggle { font-size: 0; }
  .app.collapsed #sidebar .nav .nav-group-toggle .caret { display:inline-block; width:10px; height:10px; transform-origin:center; border-right:2px solid var(--muted); border-bottom:2px solid var(--muted); }
  .app.collapsed #sidebar .nav .nav-group-toggle[aria-expanded="true"] .caret { transform: rotate(45deg); border-color: var(--accent-2); }
  
  /* When collapsed: hide the group toggle controls and show all group child buttons as icons
    so dropdowns are effectively ignored and the sidebar becomes a flat icon bar. */
  .app.collapsed #sidebar .nav .nav-group-toggle { display: none !important; }
  .app.collapsed #sidebar .nav .nav-group { display:flex !important; padding-left:0 !important; }
  .app.collapsed #sidebar .nav .nav-group.collapsed { display:flex !important; }
  .app.collapsed #sidebar .nav .nav-group button { all:unset; display:flex; align-items:center; justify-content:center; padding:10px; border-radius:8px; }
  /* Hide text/badges when collapsed — only icons should remain visible */
  .app.collapsed #sidebar .menu-item-label, .app.collapsed #sidebar .nav .nav-badge { display:none !important; }
  .nav button:hover{ transform: translateY(-1px); background: #ffffff14; opacity:1; }
  .nav button.active{ background:var(--accent); color:var(--white); opacity:1; font-weight:600; }
  .nav .icon{
    width:18px; height:18px; object-fit:contain; opacity:.95;
    color: var(--white) !important; /* SVGs use currentColor */
    filter: brightness(0) invert(1); /* Make bitmap icons white */
  }

  .nav button.active .icon{
    color: var(--success) !important; /* SVGs turn green on active */
    /* Approximate green for bitmap icons */
    filter: invert(64%) sepia(41%) saturate(498%) hue-rotate(98deg) brightness(92%) contrast(92%);
  }

  .nav-badge {
    margin-left: auto;
    font-size: 11px;
    background: var(--glass-2);
    padding: 2px 6px;
    border-radius: 99px;
    line-height: 1;
    opacity: 0.85;
  }
  .nav button.active .nav-badge {
    background: var(--accent);
    color: #fff;
  }
  .tab-controls .btn.secondary.active { background: var(--accent-2); border-color: var(--accent); color: var(--white); }


  .nav button:hover .icon{ opacity:1; }

  .content{ 
    padding:6px;
    height: calc(100vh - 44px); /* Account for app padding */
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:14px;
    padding:10px 14px; background:#ffffff12; border-radius:16px; box-shadow:var(--shadow);
    backdrop-filter: blur(10px);
    flex-shrink: 0; /* Don't allow topbar to shrink */
  }
  .search{
    flex:1; background:#ffffff17; border-radius:100px; padding:10px 14px; display:flex; align-items:center; gap:10px;
  }
  .search input{ all:unset; color:var(--ink); width:100%; font-size:14px; }
  .pill{ padding:8px 12px; border-radius:999px; background:#ffffff17; }
  .btn{ all:unset; padding:9px 14px; border-radius:12px; background:linear-gradient(135deg,#7db1ff,#4f89ff); color:#fff; font-weight:600; cursor:pointer; }
  .btn.secondary{ background:#ffffff1e; border:1px solid #ffffff26; }

  .panel{
    background: var(--panel-bg);
    border:1px solid var(--border-color); border-radius:22px; padding:24px; box-shadow: var(--shadow);
    backdrop-filter: blur(8px);
  }
  .panel-header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
  .panel-header svg { width:22px; height:22px; color:var(--accent); }
  .panel-title { font-weight:700; font-size:18px; }

  .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
  .g-12{ grid-column: span 12; }
  .g-6{ grid-column: span 6; }
  .g-4{ grid-column: span 4; }
  .g-3{ grid-column: span 3; }

  .h1{ font-size:32px; font-weight:900; letter-spacing:.2px; margin:6px 0 8px; }
  .muted{ color:var(--muted) }

  table{ width:100%; border-collapse:separate; border-spacing:0; }
  th, td{ text-align:left; padding:12px 14px; font-size:14px; }
  thead th{ position:sticky; top:0; background:#0e2e6df2; backdrop-filter: blur(6px); z-index:1; font-weight:600; color:var(--muted); }
  tbody tr{ transition: background .12s ease; }
  tbody tr:nth-child(even){ background: #ffffff0a; }
  td { border-bottom:1px solid #ffffff14; }
  tbody tr:last-child td { border-bottom: none; }
  .table-wrap{ overflow:auto; max-height:420px; }
  .chip{ padding:4px 8px; background:#ffffff20; border-radius:999px; font-size:12px; display:inline-block }
  .chip.success { background: var(--stat-2-bg); color: var(--stat-2-color); }
  .chip.danger { background: var(--stat-4-bg); color: var (--stat-4-color); }
  .chip.warning { background: var(--stat-3-bg); color: var (--stat-3-color); }


  /* Sections (SPA) */
  section.view{ display:none; }
  section.view.active{ 
    display: flex; /* Changed from block to flex */
    animation: fadeIn .18s ease;
    flex: 1;
    overflow: hidden;
    flex-direction: column;
  }
  
  /* Make panels fill available space */
  section.view .panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin-bottom: 0; /* Remove bottom margin to use full space */
  }
  
  /* Specific table containers should be scrollable */
  .table-wrap {
    flex: 1;
    overflow-y: auto;
    margin-top: 16px;
  }
  
  /* Dashboard grid adjustments */
  section.view .grid {
    flex: 1;
    overflow-y: auto;
  }
  
  /* Grid panels should maintain their size but allow content scrolling */
  .grid .panel {
    flex: none; /* Don't flex in grid layout */
    min-height: 200px; /* Minimum size for grid panels */
  }
  
  /* Content within grid panels should be scrollable if needed */
  .grid .panel .table-wrap {
    max-height: 400px; /* Reasonable max height for grid tables */
  }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(3px)} to{opacity:1; transform:none} }

  /* Auth overlay */
  .auth{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:24px; background: #071c44d0; backdrop-filter: blur(6px); z-index: 10;
  }
  .auth.show{ display:flex; }
  .card{ background:#0b2a64; border:1px solid #ffffff1f; border-radius:20px; box-shadow:var(--shadow); padding:22px; width:min(460px, 92vw); }
  .card h2{ margin:0 0 12px; }
  .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0; }
  .field input, .field textarea { all:unset; background:#ffffff17; border:1px solid #ffffff24; padding:12px 12px; border-radius:12px; }
  .field textarea { min-height: 60px; }
  .hint{ font-size:12px; color:#b9c9ff; opacity:.9 }
  /* Dark-select styling for Windows/Edge */
  .ui-select{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    background:#0b2a64; color:var(--ink);
    border:1px solid #ffffff24; border-radius:12px; padding:12px; width:100%;
  }
  .ui-select:focus{ outline:2px solid var(--accent); box-shadow:0 0 0 3px #76a7ff40; }
  .ui-select option{ background:#0b2a64; color:var(--ink); }
  .ui-select option:disabled{ color:#8aa0cf; }
  @media (forced-colors: active){
    .ui-select{ forced-color-adjust:none; background:Canvas; color:CanvasText; border-color:GrayText; }
    .ui-select option{ background:Canvas; color:CanvasText; }
  }
  .error{ color:var(--danger); font-size:12px; margin-top:6px; }

  .footer{ text-align:center; font-size:12px; color:#b7c8ff; opacity:.9; padding:22px 0; }

  /* Modal styles */
  .modal { 
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 30;
    background: rgba(7,28,68,0.85);
  }
  .modal.show { 
    display: flex; 
  }
  .modal-content { 
    background: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 18px;
    padding: 22px;
    box-shadow: var(--shadow);
    color: var(--white);
  }
  /* CRUD modal tweaks: keep buttons visible, make fields scrollable and more compact */
  #crud-modal .card {
    display: flex;
    flex-direction: column;
    max-height: 88vh; /* slightly taller but still limited */
    width: min(880px, 98vw); /* wider modal for more horizontal space */
    padding: 20px 22px;
  }
  #crud-modal form { display: flex; flex-direction: column; gap: 0; }
  #crud-fields {
  flex: 1 1 auto; /* let fields take remaining space */
  overflow-y: auto;
  padding-right: 8px; /* space for scrollbar */
  margin-bottom: 12px;
  /* Keep fields area within viewport so modal footer/buttons remain visible */
  max-height: calc(88vh - 140px); /* account for title and buttons */
  }
  /* Grid for form fields: single column on small screens, two balanced columns on wider */
  #crud-fields .crud-grid { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 16px 24px; 
    align-items: start;
  }
  @media (min-width: 760px) {
    #crud-fields .crud-grid { grid-template-columns: 1fr 1fr; }
    /* allow some fields to span full width when needed */
    #crud-fields .field.full { grid-column: 1 / -1; }
  }
  
  /* Standardize all field containers and inputs for perfect alignment */
  #crud-modal .field { 
    box-sizing: border-box; 
    display: flex; 
    flex-direction: column; 
  }
  
  #crud-modal .field label { 
    margin-bottom: 6px; 
    font-weight: 600; 
    font-size: 14px; 
    line-height: 1.3;
    min-height: 18px; /* consistent label height */
  }
  
  /* Standardize ALL input elements to same height and styling */
  #crud-modal .field input[type="text"],
  #crud-modal .field input[type="date"], 
  #crud-modal .field .ui-select,
  #crud-modal .field select {
    height: 44px;
    padding: 0 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text);
    font-size: 14px;
    box-sizing: border-box;
    line-height: 1.4;
  }
  
  /* Textareas get consistent styling but variable height */
  #crud-modal .field textarea { 
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text);
    font-size: 14px;
    box-sizing: border-box;
    resize: vertical;
    min-height: 88px;
    line-height: 1.4;
  }
  
  #crud-modal .field.full textarea { 
    min-height: 120px; 
  }
  
  /* Checkbox styling to align with other inputs */
  #crud-modal .field input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: 8px;
  }
  
  /* Multi-select and datepicker wrapper alignment */
  #crud-modal .datepicker-wrapper {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  #crud-modal .datepicker-wrapper input {
    flex: 1;
  }
  
  #crud-modal .multi-select-wrapper {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  #crud-modal .staff-chips {
    min-height: 44px;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }
  
  /* File upload styling */
  .file-upload-area {
    transition: all 0.3s ease;
  }
  
  .file-upload-area:hover {
    opacity: 0.9;
  }
  
  .file-upload-area button {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: var(--white);
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(118, 167, 255, 0.3);
  }
  
  .file-upload-area button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(118, 167, 255, 0.4);
  }
  
  .file-upload-area button span {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  /* Modern form enhancements */
  .datepicker-wrapper { display: flex; gap: 8px; align-items: center; }
  .modern-datepicker { flex: 1; }
  .quick-date { 
    height: 44px !important; 
    padding: 0 12px !important; 
    font-size: 14px; 
    white-space: nowrap; 
    border-radius: 8px !important;
    line-height: 1.4;
  }
  
  .age-select { font-weight: 500; }
  
  .multi-select-wrapper { display: flex; flex-direction: column; gap: 8px; }
  .staff-chips { display: flex; flex-wrap: wrap; gap: 6px; min-height: 24px; }
  .staff-chip { 
    background: var(--accent); 
    color: white; 
    padding: 6px 10px; 
    border-radius: 12px; 
    font-size: 12px; 
    display: flex; 
    align-items: center; 
    gap: 4px;
  }
  .staff-chip button { 
    background: none; 
    border: none; 
    color: white; 
    cursor: pointer; 
    padding: 0; 
    margin-left: 4px;
  }
  
  .category-select, .status-select, .priority-select, .avenue-select {
    font-weight: 500;
  }
  
  .category-select option[data-color]:not([value=""]) { font-weight: 600; }
  .status-select option[data-color]:not([value=""]) { font-weight: 600; }
  .priority-select option[data-color]:not([value=""]) { font-weight: 600; }
  
  /* Enhanced field labels with better spacing and icons */
  #crud-modal .field label { 
    font-weight: 600; 
    font-size: 13px; 
    margin-bottom: 4px;
    display: block;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .modal-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }
  .modal-close {
    all: unset;
    cursor: pointer;
    background: #ffffff12;
    border-radius: 999px;
    width: 34px;
    height: 34px;
    display: grid;
    place-items: center;
  }

  /* Small screens */
  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    .sidebar{ position:sticky; top:0; z-index:2; }
    .g-4 { grid-column: span 12; }
  }
  @media (max-width: 600px){
    .stat-card { grid-column: span 12; }
  }

  /* Stat cards */
  .stat-card {
    display:flex; align-items:center; gap:16px;
    background: var(--glass); padding:16px; border-radius:16px;
    border: 1px solid var(--glass-2);
  }
  .stat-card .icon-wrap {
    width:48px; height:48px; border-radius:12px;
    display:grid; place-items:center; flex-shrink:0;
    background: var(--c); color: var(--i);
  }
  .stat-card .icon-wrap svg { width:24px; height:24px; }
  .stat-num { font-size:28px; font-weight:700; line-height:1.1; color:var(--white); }
  .stat-label { font-size:14px; color:var(--muted); }

  /* Weekly Calendar styles */
  .cal-day{ background:#ffffff0f; border:1px solid #ffffff1e; border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:8px; }
  .cal-day-header { display: flex; justify-content: space-between; align-items: baseline; }
  .cal-day-label { font-weight: 600; color: var(--white); }
  .cal-day-summary { font-size: 12px; color: var(--muted); }
  .cal-day-bar-bg { width: 100%; height: 8px; background: var(--glass-2); border-radius: 99px; overflow: hidden; }
  .cal-day-bar-fg { height: 100%; background: var(--success); width: 0%; border-radius: 99px; transition: width .4s ease; }
  .cal-day-bar-fg.danger { background: var(--danger); }
  .cal-day-metrics { display: flex; justify-content: space-between; font-size: 11px; }
  .cal-metric.success { color: var(--success); }
  .cal-metric.danger { color: var(--danger); }
  
  /* Row hover/selected across all tables */
  tbody tr:hover{ background:#ffffff12 !important; }
  tbody tr.selected{ background:#ffffff1e !important; }
  tbody[data-entity] tr{ cursor:pointer; }
  #subs-tbody tr { cursor: pointer; }


  /* Items view: full-height + sortable */
  /* Items view styles - now handled by general panel styles */
  #view-items .table-wrap{ flex:1; max-height:none; overflow:auto; }
  #view-items thead th.sortable{ cursor:pointer; user-select:none; }
  #view-items thead th .arrow{ font-size:11px; opacity:.9; margin-left:6px }

  /* Monthly Calendar Styles */
  #cal-grid { grid-auto-rows: 1fr; align-items: start; }
  .cal-cell {
    background: var(--glass);
    border: 1px solid var(--glass-2);
    border-radius: 12px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    font-size: 12px;
    transition: background .12s ease;

    /* Keep cells perfectly square regardless of content/viewport */
    aspect-ratio: 1 / 1;
    min-height: 0; /* allow grid to calculate height from width */
    overflow: hidden;
  }
  .cal-cell.is-clickable { cursor: pointer; }
  .cal-cell.is-clickable:hover { background: var(--glass-2); }
  .cal-cell.other-month { opacity: .4; background: transparent; border-color:transparent; pointer-events:none; }
  .cal-cell.is-today .cal-day-num {
    background: var(--accent);
    color: var(--white);
    font-weight: 700;
  }
  .cal-day-num {
    font-weight: 600;
    font-size: 14px;
    width: 26px; height: 26px;
    display: grid; place-items: center;
    border-radius: 999px;
    margin-bottom: 4px;
    transition: all .2s ease;
    flex-shrink: 0;
  }
  .cal-tasks {
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 11px;
    padding-right: 4px; /* for scrollbar */
  }
  /* Custom scrollbar for task list */
  .cal-tasks::-webkit-scrollbar { width: 4px; }
  .cal-tasks::-webkit-scrollbar-track { background: transparent; }
  .cal-tasks::-webkit-scrollbar-thumb { background: #ffffff33; border-radius: 4px; }

  .cal-task {
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cal-task-status {
    width: 18px; height: 18px;
    border-radius: 999px;
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: var(--white);
    background: var(--muted);
    opacity: .9;
    line-height: 1;
  }
  .cal-task-status.scheduled { background: var(--muted); color: var(--white); opacity: .85; }
  .cal-task-status.done { background: var(--success); color: var(--white); }
  .cal-task-status.missed { background: var(--danger); color: var(--white); }

  .freq-badge {
    font-size:10px;
    padding:2px 6px;
    border-radius:999px;
    background: rgba(255,255,255,0.06);
    color: var(--muted);
    margin-left: 8px;
    flex-shrink: 0;
  }
  .cal-legend { display:flex; gap:14px; align-items:center; color:var(--muted); font-size:12px; margin-bottom:12px; }
  .cal-legend .item { display:flex; gap:8px; align-items:center; }
  .cal-legend .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
  .cal-legend .dot.scheduled { background: var(--muted); opacity:.6 }
  .cal-legend .dot.done { background: var(--success) }
  .cal-legend .dot.missed { background: var(--danger) }
  
  /* Day modal */
  #day-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 30; background: rgba(7,28,68,0.85); }
  #day-modal.show { display: flex; }
  .day-modal-card { width: min(900px, 86vw); background: var(--panel-bg); border:1px solid var(--border-color); border-radius:18px; padding:22px; box-shadow: var(--shadow); color: var(--white); }
  .day-modal-close { all:unset; float:right; cursor:pointer; background:#ffffff12; border-radius:999px; width:34px; height:34px; display:grid; place-items:center; }
  /* Branding modal */
  #branding-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 31; background: rgba(7,28,68,0.85); }
  #branding-modal.show { display: flex; }
  .branding-card { width: min(700px, 92vw); background: var(--panel-bg); border:1px solid var(--border-color); border-radius:18px; padding:22px; box-shadow: var(--shadow); color: var(--white); }
  .branding-close { all:unset; float:right; cursor:pointer; background:#ffffff12; border-radius:999px; width:34px; height:34px; display:grid; place-items:center; }
  .branding-row { display:grid; grid-template-columns: 160px 1fr; gap:14px; align-items:center; margin:12px 0; }
  .branding-preview { width:160px; height:90px; border-radius:10px; background:#ffffff12; border:1px solid #ffffff22; display:grid; place-items:center; overflow:hidden; }
  .branding-preview img { max-width:100%; max-height:100%; object-fit:contain; }
  .branding-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
  .hint-mini { font-size: 12px; color: var(--muted); }
  
  #cal-view-switcher .btn.secondary.active {
    background: var(--accent-2);
    border-color: var(--accent);
    color: var(--white);
  }
  /* Pre-inspection View Styles */
  .progress-bar-bg { background: var(--glass-2); border-radius: 99px; height: 10px; overflow: hidden; }
  .progress-bar-fg { background: var(--success); height: 100%; width: 0%; border-radius: 99px; transition: width .4s ease; }
  .doc-category { margin-bottom: 20px; }
  .doc-category-title { font-size: 16px; font-weight: 600; color: var(--accent-2); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 12px; }
  #pir-tbody tr { cursor: pointer; }

  /* Pre‑Inspection panel should fill viewport and allow inner scrolling */
  #view-pre-inspection .panel {
    min-height: calc(100vh - 190px);
    display: flex;
    flex-direction: column;
  }
  /* Make the documents container the scrollable area */
  #view-pre-inspection #pir-docs-container {
    flex: 1 1 auto;
    overflow-y: auto;
    max-height: none;            /* override .table-wrap default 420px cap */
    -webkit-overflow-scrolling: touch; /* iOS/Safari momentum scroll */
    overscroll-behavior: contain;      /* prevent scroll chaining */
  }

  /* Dynamic & Multi-Input Form Styles */
  .multi-input-container { display: flex; gap: 12px; align-items: flex-start; }
  .multi-input-container .field { flex: 1; margin-top: 0; }
  .dynamic-table-row { display: flex; gap: 8px; align-items: center; }
  .dynamic-table-row input { flex: 1; }

  /* Training Matrix Styles */
  .training-matrix {
    overflow-x: auto;
    background: var(--panel-bg);
    border-radius: 16px;
    border: 1px solid var(--border-color);
  }
  .training-matrix table {
    min-width: 800px;
    border-collapse: separate;
    border-spacing: 0;
  }
  .training-matrix th {
    background: var(--panel-bg);
    position: sticky;
    top: 0;
    z-index: 2;
    writing-mode: vertical-lr;
    text-orientation: mixed;
    width: 120px;
    max-width: 120px;
    padding: 16px 8px;
    font-size: 12px;
    border-right: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
  }
  .training-matrix th:first-child {
    writing-mode: horizontal-tb;
    text-orientation: initial;
    width: 200px;
    max-width: 200px;
    position: sticky;
    left: 0;
    z-index: 3;
  }
  .training-matrix td {
    padding: 8px;
    border-right: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    font-size: 11px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 40px;
    position: relative;
  }
  .training-matrix td:first-child {
    position: sticky;
    left: 0;
    background: var(--panel-bg);
    z-index: 1;
    cursor: default;
    font-weight: 600;
    text-align: left;
    padding-left: 16px;
  }
  .training-matrix td.training-cell:hover {
    background: var(--glass-2);
    transform: scale(1.02);
  }
  
  /* Training Status Colors */
  .training-completed { background: var(--stat-2-bg); color: var(--stat-2-color); }
  .training-expiring { background: var(--stat-3-bg); color: var(--stat-3-color); }
  .training-expired { background: var(--stat-4-bg); color: var(--stat-4-color); }
  .training-missing { background: var(--glass); color: var(--muted); opacity: 0.6; }
  
  /* Training Modal */
  .training-modal .modal-content {
    width: min(600px, 90vw);
    max-height: 90vh;
    overflow-y: auto;
  }
  
  /* Training Types Management Modal */
  .training-types-modal .modal-content {
    width: min(800px, 95vw);
    max-height: 90vh;
    overflow-y: auto;
  }
  .training-type-row {
    display: grid;
    grid-template-columns: 2fr 1fr 80px 80px 80px 100px;
    gap: 12px;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
  }
  .training-type-row:last-child {
    border-bottom: none;
  }
  .training-type-row input, .training-type-row select {
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: var(--glass);
    color: var(--white);
    font-size: 12px;
  }
  .training-type-row button {
    padding: 4px 8px;
    font-size: 11px;
  }
  
  .training-upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: var(--glass);
  }
  .training-upload-zone:hover {
    border-color: var(--accent);
    background: var(--glass-2);
  }
  .training-upload-zone.dragover {
    border-color: var(--accent);
    background: var(--accent-2);
  }
</style>

<script>

    // === BRANDING MODAL + UPLOADS ===
    const brandingBtn = document.getElementById('btn-branding');
    const brandingModal = document.getElementById('branding-modal');
    const brandingClose = document.getElementById('branding-close');
    const brandingCancel = document.getElementById('branding-cancel');
    const brandingForm = document.getElementById('branding-form');
    const logoInput = document.getElementById('branding-logo');
    const sigInput  = document.getElementById('branding-signature');
    const logoPrev  = document.getElementById('branding-logo-preview');
    const sigPrev   = document.getElementById('branding-signature-preview');
    const brandErr  = document.getElementById('branding-error');
    const brandOK   = document.getElementById('branding-success');

    function openBranding(){ brandingModal?.classList.add('show'); brandErr.style.display='none'; brandOK.style.display='none'; }
    function closeBranding(){ brandingModal?.classList.remove('show'); }

    brandingBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openBranding(); });
    brandingClose?.addEventListener('click', closeBranding);
    brandingCancel?.addEventListener('click', closeBranding);

    function readPreview(input, img){
      if(!input?.files?.[0]){ img.src=''; return; }
      const file = input.files[0];
      const url = URL.createObjectURL(file);
      img.src = url;
    }
    logoInput?.addEventListener('change', ()=> readPreview(logoInput, logoPrev));
    sigInput?.addEventListener('change', ()=> readPreview(sigInput, sigPrev));

    async function uploadBranding(){
      try{
        brandErr.style.display='none'; brandOK.style.display='none';
        const bucket = 'branding';
        const siteSlug = (typeof ctx === 'object' && (ctx?.site_slug || ctx?.site_name)) ? (ctx.site_slug || String(ctx.site_name).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')) : 'default';
        const uploads = [];

        if(logoInput?.files?.[0]){
          const f = logoInput.files[0];
          const ext = (f.name.split('.').pop() || 'png').toLowerCase();
          const path = `${siteSlug}/logo.${ext}`;
          uploads.push(supabase.storage.from(bucket).upload(path, f, { upsert:true, cacheControl:'3600', contentType: f.type || 'image/png' }));
        }
        if(sigInput?.files?.[0]){
          const f = sigInput.files[0];
          const ext = (f.name.split('.').pop() || 'png').toLowerCase();
          const path = `${siteSlug}/signature.${ext}`;
          uploads.push(supabase.storage.from(bucket).upload(path, f, { upsert:true, cacheControl:'3600', contentType: f.type || 'image/png' }));
        }

        if(uploads.length === 0){ throw new Error('Please choose at least one file to upload.'); }
        const results = await Promise.all(uploads);
        const failed = results.find(r => r?.error);
        if(failed){ throw failed.error; }
        brandOK.textContent = 'Uploaded successfully.';
        brandOK.style.display = 'block';
        setTimeout(closeBranding, 900);
      }catch(err){
        console.error(err);
        brandErr.textContent = 'Upload failed: ' + (err?.message || err);
        brandErr.style.display = 'block';
      }
    }

    brandingForm?.addEventListener('submit', (e)=>{ e.preventDefault(); uploadBranding(); });

    // === Templates download enhancer for PIR modals ===
    (function installTemplateButtons(){
      // Watch DOM for the PIR manage modal opening and inject template links
      const observer = new MutationObserver(() => {
        // Find any modal/card whose title starts with 'Manage:'
        const cards = Array.from(document.querySelectorAll('.card, .panel, [role="dialog"], .branding-card, .day-modal-card'));
        for (const card of cards) {
          const h = card.querySelector('h2, h3, .panel-title');
          if (!h) continue;
          const heading = (h.textContent || '').trim();
          if (!/^Manage:\s*/i.test(heading)) continue;
          const title = heading.replace(/^Manage:\s*/i, '').trim();

          // Locate definition
          const def = (window.PIR_DEFINITIONS_DATA || []).find(d => (d.title||'').trim() === title);
          if (!def || !def.allow_templates || !Array.isArray(def.templates) || def.templates.length === 0) continue;

          // Find the file input (we'll append links under it)
          const fileInput = card.querySelector('input[type="file"]');
          if (!fileInput) continue;
          const container = fileInput.closest('.field') || fileInput.parentElement || card;

          // Prevent duplicate injection
          if (container.querySelector('#pir-template-downloads')) { continue; }

          // Build links (prefer Supabase public URL if available)
          const wrap = document.createElement('div');
          wrap.id = 'pir-template-downloads';
          wrap.className = 'hint';
          wrap.style.marginTop = '10px';

          const list = document.createElement('div');
          list.style.display = 'grid';
          list.style.gap = '6px';

          const bucket = def.templates_bucket || 'pir_templates';
          const prefix = def.templates_prefix || '';

          def.templates.forEach(t => {
            const p = (t && t.path) ? t.path : '';
            let href = '';
            try {
              if (window.supabase && supabase.storage) {
                const r = supabase.storage.from(bucket).getPublicUrl(p).data;
                href = r?.publicUrl || '';
              }
            } catch(e) { /* fallback below */ }
            if (!href && window.SUPABASE_URL) {
              href = `${window.SUPABASE_URL.replace(/\/$/, '')}/storage/v1/object/public/${bucket}/${p}`;
            }
            if (!href && typeof window.SUPABASE_URL === 'undefined') {
              href = 'https://unveoqnlqnobufhublyw.supabase.co/storage/v1/object/public/' + bucket + '/' + p;
            }

            const a = document.createElement('a');
            a.href = href;
            a.download = '';
            a.target = '_blank';
            a.rel = 'noopener';
            a.textContent = (t && t.label) ? t.label : (p.split('/').pop() || 'Template');
            a.className = 'btn secondary';
            a.style.width = 'fit-content';
            list.appendChild(a);
          });

          const titleEl = document.createElement('div');
          titleEl.textContent = 'Download templates:';
          titleEl.className = 'muted';
          titleEl.style.marginTop = '4px';

          wrap.appendChild(titleEl);
          wrap.appendChild(list);
          container.appendChild(wrap);
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
    })();

window.addEventListener('DOMContentLoaded', function initPIRemlGenerator(){
    // Initialize any needed functionality
});

(function () {
  var ua = navigator.userAgent || "";
  var isIOSiPad = /iPad|iPhone|iPod/.test(ua) ||
                  (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
  var onIpadPage = /indexIpad\.html$/i.test(location.pathname);
  var bypass = location.search.includes("admin=1"); // add ?admin=1 to stay on Admin

  if (isIOSiPad && !onIpadPage && !bypass) {
    location.replace("indexIpad.html"); // same folder
  }
})();
</script>

</head>
<body>
  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
  </div>

  <div class="app" id="app" aria-live="polite">
    <aside class="sidebar" id="sidebar">
      <button id="toggleSidebar" class="sidebar-toggle">☰</button>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="t">CheckLoop</div>
          <div class="hint">Admin</div>
        </div>
      </div>
      <nav class="nav" id="nav">
        <button class="active" data-section="dashboard"><img class="icon" alt="" src="dashboard.png"><span class="menu-item-label">Dashboard</span></button>

        <button class="nav-group-toggle" id="toggle-cqc" aria-expanded="true" aria-controls="group-cqc">CQC Notification <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group" id="group-cqc">
          <button data-section="pre-inspection"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg><span class="menu-item-label">Pre-inspection</span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-checks" aria-expanded="true" aria-controls="group-checks">Checks & Audits <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group" id="group-checks">
          <button data-section="training"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg><span class="menu-item-label">Mandatory Training</span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-scans" aria-expanded="true" aria-controls="group-scans">Scans <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group" id="group-scans">
          <button data-section="calendar"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="menu-item-label">Calendar</span></button>
          <button data-section="schedules"><img class="icon" alt="" src="Schedule.png"><span class="menu-item-label">Schedules</span></button>
          <button data-section="submissions"><img class="icon" alt="" src="QRCode.png"><span class="menu-item-label">Submissions</span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-config" aria-expanded="true" aria-controls="group-config">Configure <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group" id="group-config">
          <button data-section="items"><svg class="icon" style="color: var(--muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4a2 2 0 0 0 1-1.73z"/>
            <path d="M3.27 6.96L12 12l8.73-5.04"/>
            <path d="M12 22V12"/>
          </svg><span class="menu-item-label">Items</span><span class="nav-badge" id="badge-items"></span></button>
          <button data-section="rooms"><img class="icon" alt="" src="AddRoomIcon.png"><span class="menu-item-label">Rooms</span><span class="nav-badge" id="badge-rooms"></span></button>
          <button data-section="checktypes"><img class="icon" alt="" src="check-mark.png"><span class="menu-item-label">Check Types</span><span class="nav-badge" id="badge-ct"></span></button>
          <button data-section="staff"><img class="icon" alt="" src="Doctor.png"><span class="menu-item-label">Staff</span><span class="nav-badge" id="badge-staff"></span></button>
        </div>

        <button data-section="complaints"><img class="icon" alt="" src="AddRoomIcon.png"><span class="menu-item-label">Complaints</span><span class="nav-badge" id="badge-complaints"></span></button>

        <button class="nav-group-toggle" id="toggle-settings" aria-expanded="true" aria-controls="group-settings">Settings <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group" id="group-settings">
          <button data-section="settings"><svg class="icon" style="color: var(--muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9c.69 0 1.25-.56 1.25-1.25V3a2 2 0 1 1 4 0v.09c0 .69.56 1.25 1.25 1.25.37 0 .72-.15.97-.4l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.25.25-.4.6-.4.97V9c0 .69.56 1.25 1.25 1.25H21a2 2 0 1 1 0 4h-.09c-.69 0-1.25.56-1.25 1.25z"/>
          </svg><span class="menu-item-label">Site Settings</span></button>
          <button data-section="users"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg><span class="menu-item-label">Users</span></button>
        </div>
      </nav>
    </aside>

    <main class="content">
      <div class="topbar panel">
        <div class="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="search" placeholder="Search items, rooms, staff…" />
        </div>
        <div class="pill" id="site-pill">Site: —</div>
        <div class="pill" id="email-pill">—</div>
        <button class="btn secondary" id="signout">Sign Out</button>
      </div>

      <section class="view active" id="view-dashboard">

        <div class="grid" style="margin-top:14px;">
          <div class="panel g-12 compact-panel" id="week-calendar" style="margin-top:12px">
            <div class="panel-header">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
              <div class="panel-title">This Week (Sunday → Saturday)</div>
            </div>
            <div id="week-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px">
              <div class="cal-day">
                <div class="cal-day-header">
                  <div class="cal-day-label" id="d0-label">Sun</div>
                  <div class="cal-day-summary"><span id="d0-done-val">0</span> / <span id="d0-req-val">0</span></div>
                </div>
                <div class="cal-day-bar-bg"><div class="cal-day-bar-fg" id="d0-bar"></div></div>
                <div class="cal-day-metrics">
                  <div class="cal-metric" style="color: var(--muted);">🗓️ <span id="d0-req">0</span></div>
                  <div class="cal-metric success">✓ <span id="d0-done">0</span></div>
                  <div class="cal-metric danger">✗ <span id="d0-missed">0</span></div>
                </div>
              </div>
              <div class="cal-day">
                  <div class="cal-day-header"><div class="cal-day-label" id="d1-label">Mon</div><div class="cal-day-summary"><span id="d1-done-val">0</span> / <span id="d1-req-val">0</span></div></div>
                  <div class="cal-day-bar-bg"><div class="cal-day-bar-fg" id="d1-bar"></div></div>
                  <div class="cal-day-metrics">
                    <div class="cal-metric" style="color: var(--muted);">🗓️ <span id="d1-req">0</span></div>
                    <div class="cal-metric success">✓ <span id="d1-done">0</span></div>
                    <div class="cal-metric danger">✗ <span id="d1-missed">0</span></div>
                  </div>
              </div>
              <div class="cal-day">
                  <div class="cal-day-header"><div class="cal-day-label" id="d2-label">Tue</div><div class="cal-day-summary"><span id="d2-done-val">0</span> / <span id="d2-req-val">0</span></div></div>
                  <div class="cal-day-bar-bg"><div class="cal-day-bar-fg" id="d2-bar"></div></div>
                  <div class="cal-day-metrics">
                    <div class="cal-metric" style="color: var(--muted);">🗓️ <span id="d2-req">0</span></div>
                    <div class="cal-metric success">✓ <span id="d2-done">0</span></div>
                    <div class="cal-metric danger">✗ <span id="d2-missed">0</span></div>
                  </div>
              </div>
              <div class="cal-day">
                  <div class="cal-day-header"><div class="cal-day-label" id="d3-label">Wed</div><div class="cal-day-summary"><span id="d3-done-val">0</span> / <span id="d3-req-val">0</span></div></div>
                  <div class="cal-day-bar-bg"><div class="cal-day-bar-fg" id="d3-bar"></div></div>
                  <div class="cal-day-metrics">
                    <div class="cal-metric" style="color: var(--muted);">🗓️ <span id="d3-req">0</span></div>
                    <div class="cal-metric success">✓ <span id="d3-done">0</span></div>
                    <div class="cal-metric danger">✗ <span id="d3-missed">0</span></div>
                  </div>
              </div>
              <div class="cal-day">
                  <div class="cal-day-header"><div class="cal-day-label" id="d4-label">Thu</div><div class="cal-day-summary"><span id="d4-done-val">0</span> / <span id="d4-req-val">0</span></div></div>
                  <div class="cal-day-bar-bg"><div class="cal-day-bar-fg" id="d4-bar"></div></div>
                  <div class="cal-day-metrics">
                    <div class="cal-metric" style="color: var(--muted);">🗓️ <span id="d4-req">0</span></div>
                    <div class="cal-metric success">✓ <span id="d4-done">0</span></div>
                    <div class="cal-metric danger">✗ <span id="d4-missed">0</span></div>
                  </div>
              </div>
              <div class="cal-day">
                  <div class="cal-day-header"><div class="cal-day-label" id="d5-label">Fri</div><div class="cal-day-summary"><span id="d5-done-val">0</span> / <span id="d5-req-val">0</span></div></div>
                  <div class="cal-day-bar-bg"><div class="cal-day-bar-fg" id="d5-bar"></div></div>
                  <div class="cal-day-metrics">
                    <div class="cal-metric" style="color: var(--muted);">🗓️ <span id="d5-req">0</span></div>
                    <div class="cal-metric success">✓ <span id="d5-done">0</span></div>
                    <div class="cal-metric danger">✗ <span id="d5-missed">0</span></div>
                  </div>
              </div>
              <div class="cal-day">
                  <div class="cal-day-header"><div class="cal-day-label" id="d6-label">Sat</div><div class="cal-day-summary"><span id="d6-done-val">0</span> / <span id="d6-req-val">0</span></div></div>
                  <div class="cal-day-bar-bg"><div class="cal-day-bar-fg" id="d6-bar"></div></div>
                  <div class="cal-day-metrics">
                    <div class="cal-metric" style="color: var(--muted);">🗓️ <span id="d6-req">0</span></div>
                    <div class="cal-metric success">✓ <span id="d6-done">0</span></div>
                    <div class="cal-metric danger">✗ <span id="d6-missed">0</span></div>
                  </div>
              </div>
            </div>
            <div class="hint" style="margin-top:8px">Historic days show progress based on required schedules. <span style="color:var(--success)">Green</span> bars indicate all required checks were completed. <span style="color:var(--danger)">Red</span> bars indicate missed checks.</div>
          </div>

          <div class="panel g-12" style="min-height:520px; margin-top:12px;">
            <div class="panel-header" style="align-items:center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
                <div class="panel-title">Due / Missed / Completed</div>
                <div class="tab-controls" style="margin-left:auto; display:flex; gap:8px;">
                  <button class="btn secondary active" id="tab-due" data-tab="due">Due (7d)</button>
                  <button class="btn secondary" id="tab-missed" data-tab="missed">Missed (7d)</button>
                  <button class="btn secondary" id="tab-completed" data-tab="completed">Completed (7d)</button>
                </div>
            </div>
            <div class="table-wrap"><table>
              <thead><tr><th>Item</th><th>Check</th><th>Room</th><th>Date</th></tr></thead>
              <tbody id="due-tbody"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
            </table></div>
          </div>

          <div class="panel g-12" style="min-height:260px; margin-top:12px;">
            <div class="panel-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-8m0 0V4m0 8h8m-8 0H4"/><path d="M20 12v8m-8 0h8m-8 0H4"/></svg>
                <div class="panel-title">Recent Activity</div>
            </div>
            <div class="table-wrap"><table>
              <thead><tr><th>When</th><th>Staff</th><th>Rows</th></tr></thead>
              <tbody id="activity-tbody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
            </table></div>
          </div>
        </div>

        <!-- Roles Management Modal -->
        <div class="modal" id="roles-modal">
          <div class="modal-content" style="width:500px">
            <div class="modal-header">
              <h3>Manage Staff Roles</h3>
              <button type="button" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
              <div class="table-wrap" style="max-height:300px">
                <table>
                  <thead><tr><th>Role</th><th>Actions</th></tr></thead>
                  <tbody id="roles-tbody">
                    <tr><td colspan="2" class="muted">Loading roles...</td></tr>
                  </tbody>
                </table>
              </div>
              <div style="margin-top:20px">
                <form id="add-role-form" style="display:flex; gap:10px">
                  <div class="field" style="flex:1; margin:0">
                    <input type="text" id="new-role-input" placeholder="Enter new role name" required>
                  </div>
                  <button type="submit" class="btn">Add Role</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div class="footer">© CheckLoop • Built for GP surgeries • Silky blue UI ✨</div>
      </section>
      
      <!-- Users View (moved from Settings) -->
      <section class="view" id="view-users">
        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div class="h1" style="margin:0 0 10px">Users</div>
            <div style="display:flex; gap:10px;">
              <button class="btn" id="btn-invite-user">Invite User</button>
            </div>
          </div>

          <div class="settings-section" style="margin-top:20px">
            <h3>Practice Users</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="practice-users-tbody">
                  <tr><td colspan="5" class="muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Invite User Modal -->
        <div class="modal" id="invite-modal">
          <div class="modal-content" style="width:500px">
            <div class="modal-header">
              <h3>Invite User</h3>
              <button type="button" class="modal-close" id="invite-modal-close">&times;</button>
            </div>
            <form id="invite-form">
              <div class="field">
                <label>Full Name</label>
                <input type="text" id="invite-name" name="full_name" required>
              </div>
              <div class="field">
                <label>Email</label>
                <input type="email" id="invite-email" name="email" required>
              </div>
              <div class="field">
                <label>Access</label>
                <select id="invite-access" name="access" required>
                  <option value="admin">Admin</option>
                  <option value="staff">Staff</option>
                </select>
                <div class="hint">Choose account access level (Admin or Staff)</div>
              </div>
              <div class="field">
                <label>Role</label>
                <select id="invite-role" name="role_detail">
                  <option value="">—</option>
                </select>
              </div>
              <div class="field">
                <label>Reports To</label>
                <select id="invite-reports-to" name="reports_to_id">
                  <option value="">—</option>
                </select>
              </div>
              <div class="error" id="invite-error" style="display:none"></div>
              <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px">
                <button type="button" class="btn secondary" id="invite-cancel-btn">Cancel</button>
                <button type="submit" class="btn">Send Invitation</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <section class="view" id="view-pre-inspection">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
              <div class="h1" style="margin:0 0 10px">CQC Pre-Inspection Readiness</div>
            </div>
            <div class="grid" style="align-items: center; margin-bottom: 24px;">
                <div class="g-8">
                    <div class="muted">Overall Progress (Ready Items)</div>
                    <div class="progress-bar-bg" style="margin-top: 8px;">
                        <div class="progress-bar-fg" id="pir-progress-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="g-4" style="text-align: right;">
                    <div id="pir-progress-text" style="font-size: 24px; font-weight: 700;">0 / 0</div>
                    <div class="muted">Items Ready</div>
                </div>
            </div>
            
            <div id="pir-docs-container" class="table-wrap"></div>
        </div>
      </section>

      <section class="view" id="view-training">
        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <div class="h1" style="margin:0">Mandatory Training</div>
            <div style="display:flex; gap:10px;">
              <button class="btn secondary" id="btn-manage-training-types">Manage Training Types</button>
              <button class="btn" id="btn-export-training">Export Report</button>
            </div>
          </div>
          
          <div class="tab-controls" style="margin-bottom: 24px; display:flex; gap:8px;">
            <button class="btn secondary active" id="tab-clinical" data-tab="clinical">Clinical Staff</button>
            <button class="btn secondary" id="tab-non-clinical" data-tab="non-clinical">Non-Clinical Staff</button>
          </div>

          <div class="training-matrix" id="training-matrix-container">
            <table id="training-matrix-table">
              <thead>
                <tr id="training-headers">
                  <th>Staff Member</th>
                </tr>
              </thead>
              <tbody id="training-tbody">
                <tr><td colspan="100%" class="muted">Loading training matrix...</td></tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top: 16px; display: flex; gap: 20px; font-size: 12px; color: var(--muted);">
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-2-bg); border-radius: 2px;"></div>
              <span>Completed & Valid</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-3-bg); border-radius: 2px;"></div>
              <span>Expiring Soon (30 days)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-4-bg); border-radius: 2px;"></div>
              <span>Expired</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--glass); border-radius: 2px;"></div>
              <span>No Record</span>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="view-calendar">
        <div class="panel">
          <div id="cal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <button id="cal-prev" class="btn secondary">‹ Prev</button>
            <div id="cal-month-year" class="panel-title">Loading...</div>
            <button id="cal-next" class="btn secondary">Next ›</button>
          </div>
          
          <div class="cal-legend" id="cal-legend">
            <div class="item"><span class="dot scheduled" aria-hidden="true"></span> Scheduled</div>
            <div class="item"><span class="dot done" aria-hidden="true"></span> Done</div>
            <div class="item"><span class="dot missed" aria-hidden="true"></span> Missed</div>
            <div class="item" style="margin-left:auto;">Frequency: <span class="freq-badge" style="margin-left:8px;">D</span> Daily <span class="freq-badge" style="margin-left:8px; margin-left:12px;">W</span> Weekly <span class="freq-badge" style="margin-left:8px; margin-left:12px;">M</span> Monthly</div>
          </div>

          <div id="cal-weekdays" style="display:grid; grid-template-columns: repeat(7, 1fr); text-align:center; margin-bottom:8px; font-weight:600; color:var(--muted); font-size:12px;">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div id="cal-grid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; min-height: 500px;">
          </div>
          <div id="cal-compliance-view" style="display: none;"></div>
        </div>
      </section>

      <section class="view" id="view-items">
        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div class="h1" style="margin:0">Items</div>
            <button class="btn" id="btn-new-item">Add Item</button>
          </div>
          <div class="table-wrap" style="margin-top:10px"><table>
            <thead><tr><th class="sortable" data-col="item_id">Code <span class="arrow" id="sort-item_id"></span></th><th class="sortable" data-col="item_name">Name <span class="arrow" id="sort-item_name"></span></th><th class="sortable" data-col="room_name">Room <span class="arrow" id="sort-room_name"></span></th><th class="sortable" data-col="default_check_type_name">Default Check <span class="arrow" id="sort-default_check_type_name"></span></th><th class="sortable" data-col="active">Active <span class="arrow" id="sort-active"></span></th></tr></thead>
            <tbody id="items-tbody" data-entity="items"><tr><td colspan="5" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-rooms">
        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center"><div class="h1" style="margin:0 0 10px">Rooms</div><button class="btn" id="btn-new-room">Add Room</button></div>
          <div class="table-wrap"><table>
            <thead><tr><th>Name</th><th>Owner</th></tr></thead>
            <tbody id="rooms-tbody" data-entity="rooms"><tr><td colspan="2" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

          <section class="view" id="view-complaints">
            <div class="panel">
              <div style="display:flex; justify-content:space-between; align-items:center"><div class="h1" style="margin:0 0 10px">Complaints</div><button class="btn" id="btn-new-complaint">Add Complaint</button></div>
              <div class="table-wrap"><table>
                <thead>
                  <tr>
                    <th>Datetime</th>
                    <th>Patient</th>
                    <th>Category</th>
                    <th>Original complaint</th>
                    <th>Response</th>
                    <th>Lessons learned</th>
                    <th>Status</th>
                    <th>Share</th>
                    <th>Created by</th>
                    <th>Resolved at</th>
                  </tr>
                </thead>
                <tbody id="complaints-tbody" data-entity="complaints"><tr><td colspan="10" class="muted">Loading…</td></tr></tbody>
              </table></div>
            </div>
          </section>

      <section class="view" id="view-checktypes">
        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div class="h1" style="margin:0">Check Types</div>
            <button class="btn" id="btn-new-ct">Add Check Type</button>
          </div>
          <div class="table-wrap" style="margin-top:10px"><table>
            <thead><tr><th>Name</th><th>Active</th></tr></thead>
            <tbody id="ct-tbody" data-entity="check_types"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-schedules">
        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center"><div class="h1" style="margin:0 0 10px">Schedules</div><button class="btn" id="btn-new-sched">Add Schedule</button></div>
          <div class="table-wrap"><table>
            <thead><tr><th>Item</th><th>Room</th><th>Check</th><th>Frequency</th><th>Day</th><th>Required</th></tr></thead>
            <tbody id="sched-tbody" data-entity="item_allowed_types"><tr><td colspan="6" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-staff">
        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div class="h1" style="margin:0 0 10px">Staff</div>
            <div style="display:flex; gap:10px;">
              <!-- Role management removed: roles are fixed to Admin and Staff -->
            </div>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>Name</th><th>Role</th><th>Reports To</th><th>Active</th></tr></thead>
            <tbody id="staff-tbody" data-entity="kiosk_users"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-submissions">
        <div class="panel">
          <div class="h1" style="margin:0 0 10px">Submissions</div>
          <div class="table-wrap"><table>
            <thead><tr><th>When</th><th>Staff</th><th>Rows</th><th>Comment</th></tr></thead>
            <tbody id="subs-tbody"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-settings">
        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div class="h1" style="margin:0 0 10px">Settings</div>
            <div style="display:flex; gap:10px;"></div>
              </div>

              <!-- Debug Settings Section -->
              <div class="settings-section" style="margin-top:20px">
                <h3>Debug Options</h3>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="debug-window-toggle" style="margin:0;">
                    <span>Show Debug Window</span>
                  </label>
                  <div class="hint">Toggle visibility of the debug panel for troubleshooting</div>
                </div>
              </div>
            </div>
      </section>
    </main>
  </div>



  <div id="day-modal" aria-hidden="true">
    <div class="day-modal-card">
      <button class="day-modal-close" id="day-modal-close" aria-label="Close">✕</button>
      <h2 class="day-modal-title">Details</h2>
      <div class="day-modal-body">Loading…</div>
    </div>
  </div>
  <div id="branding-modal" aria-hidden="true">
    <div class="branding-card">
      <button class="branding-close" id="branding-close" aria-label="Close">✕</button>
      <h2 style="margin:0 0 6px">Branding</h2>
      <div class="hint-mini">Upload a practice logo and a signature image. PNG with transparent background is ideal.</div>
      <form id="branding-form">
        <div class="branding-row">
          <div>
            <div class="muted" style="margin-bottom:6px">Logo</div>
            <div class="branding-preview"><img id="branding-logo-preview" alt="" /></div>
          </div>
          <div>
            <input type="file" id="branding-logo" accept="image/*" />
            <div class="hint-mini">Recommended: PNG, at least 600×300px.</div>
          </div>
        </div>
        <div class="branding-row">
          <div>
            <div class="muted" style="margin-bottom:6px">Signature</div>
            <div class="branding-preview"><img id="branding-signature-preview" alt="" /></div>
          </div>
          <div>
            <input type="file" id="branding-signature" accept="image/*" />
            <div class="hint-mini">Recommended: Transparent PNG.</div>
          </div>
        </div>
        <div class="branding-actions">
          <button type="button" class="btn secondary" id="branding-cancel">Cancel</button>
          <button type="submit" class="btn" id="branding-save">Upload</button>
        </div>
        <div class="error" id="branding-error" role="alert" style="display:none"></div>
        <div class="hint" id="branding-success" style="display:none">Uploaded successfully.</div>
      </form>
    </div>
  </div>

  <!-- Training Types Management Modal -->
  <div class="modal training-types-modal" id="training-types-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Manage Training Types</h3>
        <button type="button" class="modal-close" id="training-types-close">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <p style="color: var(--muted); font-size: 14px; margin-bottom: 16px;">
          Configure training modules and their expiry periods. When staff upload training certificates, 
          the expiry date will be automatically calculated based on these settings.
        </p>
        
        <div class="training-type-row" style="font-weight: 600; color: var(--accent-2); border-bottom: 2px solid var(--border-color);">
          <div>Training Name</div>
          <div>Expiry Period</div>
          <div>Clinical</div>
          <div>Non-Clinical</div>
          <div>Active</div>
          <div>Actions</div>
        </div>
        
        <div id="training-types-list">
          <div style="padding: 20px; text-align: center; color: var(--muted);">Loading...</div>
        </div>
        
        <button type="button" class="btn" id="add-training-type" style="margin-top: 16px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add New Training Type
        </button>
      </div>
      
      <div class="error" id="training-types-error" style="display:none"></div>
      
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
        <button type="button" class="btn secondary" id="training-types-cancel">Cancel</button>
        <button type="button" class="btn" id="save-training-types">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Training Record Modal -->
  <div class="modal training-modal" id="training-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="training-modal-title">Update Training Record</h3>
        <button type="button" class="modal-close" id="training-modal-close">&times;</button>
      </div>
      <form id="training-form">
        <input type="hidden" id="training-staff-id">
        <input type="hidden" id="training-type-id">
        
        <div class="field">
          <label>Staff Member</label>
          <input type="text" id="training-staff-name" disabled>
        </div>
        
        <div class="field">
          <label>Training Module</label>
          <input type="text" id="training-type-name" disabled>
        </div>
        
        <div class="field">
          <label>Completion Date</label>
          <input type="date" id="training-completion-date" required>
        </div>
        
        <div class="field">
          <label>Expiry Date (if applicable)</label>
          <input type="date" id="training-expiry-date">
        </div>
        
        <div class="field">
          <label>Certificate</label>
          <div class="training-upload-zone" id="training-upload-zone">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 12px; color: var(--muted);">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <p>Drop certificate here or click to browse</p>
            <p style="font-size: 11px; color: var(--muted); margin-top: 8px;">PDF, JPG, PNG up to 10MB</p>
          </div>
          <input type="file" id="training-certificate" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
          <div id="training-current-file" style="display: none; margin-top: 8px; padding: 8px; background: var(--glass); border-radius: 8px;">
            <span id="training-file-name"></span>
            <button type="button" class="btn secondary" style="margin-left: 8px; padding: 4px 8px; font-size: 11px;" onclick="downloadTrainingCertificate()">Download</button>
          </div>
        </div>
        
        <div class="field">
          <label>Notes</label>
          <textarea id="training-notes" placeholder="Optional notes about this training..."></textarea>
        </div>
        
        <div class="error" id="training-error" style="display:none"></div>
        
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px">
          <button type="button" class="btn secondary" id="training-cancel-btn">Cancel</button>
          <button type="button" class="btn secondary" id="training-delete-btn" style="display: none;">Delete Record</button>
          <button type="submit" class="btn">Save Training Record</button>
        </div>
      </form>
    </div>
  </div>

<script>
  // --- PRE-INSPECTION (PIR) DATA DEFINITIONS (v2 - Enhanced for Email Generation) ---
// This block contains the definitions for all CQC pre-inspection items.
// It has been updated with an `email_blurb` for each item to facilitate automatic email generation.
window.PIR_DEFINITIONS_DATA = [
    // EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Statement of purpose", 
        item_type: "file_only",
        description: "Upload your existing Statement of Purpose OR download and complete the official templates, then upload the finished document.",
        allow_upload: true,
        file_label: "Attached File",
        file_hint: "Uploading a new file will replace the existing one.",
        allow_templates: true,
        templates_bucket: "pir_templates",
        templates_prefix: "",
        templates: [
          { label: "Template – Part 1 (Provider)",   path: "20120418_100457_v2_00_statement_of_purpose_pt_1_for_pub_unprotected.doc" },
          { label: "Template – Part 2 (Aims & objectives)", path: "20120327_100457_v2_00_statement_of_purpose_pt_2_for_pub_unprotected.doc" },
          { label: "Template – Part 3 (Location)",  path: "20120418_100457_v2_00_statement_of_purpose_pt_3_for_pub_unprotected.doc" },
          { label: "Template – Part 4 (Registered manager)", path: "20120413_100457_v2_00_statement_of_purpose_pt_4_for_pub_unprotected.doc" }
        ],
        email_blurb: "Provides our Statement of Purpose, detailing the practice's aims, services, and patient population."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Copy of Major incident/business continuity", 
        item_type: "file_only",
        email_blurb: "Attached is our Major Incident and Business Continuity Plan."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Medical emergencies policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for handling medical emergencies within the practice."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Chaperone policy", 
        item_type: "file_only",
        email_blurb: "Attached is our Chaperone Policy for patient consultations."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Induction process", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Induction Structure: Describe the phases and timeline of your induction process for different staff roles (clinical, admin).", 
            "Key Content & Policies: What essential topics are covered (e.g., safeguarding, H&S, IPC, confidentiality, chaperone policy)?", 
            "Competency Assessment: How do you verify and document that new staff are competent and confident in their role at the end of the induction period?"
        ], 
        description: "Describe the process and/or attach the induction pack/checklist.",
        email_blurb: "Provides a summary of our staff induction process, with the induction pack attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Online services policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the provision and use of online patient services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Access policy", 
        item_type: "file_only",
        email_blurb: "Attached is our Patient Access Policy, detailing how patients can access our services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Registration policy (incl access to medical records)", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for patient registration and access to medical records."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Home visits/care home protocol", 
        item_type: "file_only",
        email_blurb: "Attached is our protocol for conducting home visits and supporting care homes."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for supporting carers", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Identification Strategy: How do you proactively identify patients who are carers?", 
            "Support & Signposting: What specific support is offered and which local/national services do you signpost to?", 
            "Recording & Flagging: How do you maintain an up-to-date carers' register in the clinical system?"
        ], 
        description: "Describe the process and attach any relevant leaflets or policies.",
        email_blurb: "Details our process for identifying and supporting carers, with relevant leaflets attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Number of carers identified and percentage", 
        item_type: "dual_number", 
        labels: ["Number Identified", "Percentage (%)"],
        email_blurb: "Provides the current number and percentage of identified carers on our patient list."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for bereaved patients", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Immediate Steps: What are the immediate administrative and clinical steps upon notification of a patient death?",
            "Family Communication: How and when do you make contact with the bereaved family, and what support is offered?",
            "Record Management: What is the process for updating and managing the deceased patient's records?",
            "Signposting: Which bereavement support services are patients and their families signposted to?",
            "Staff Support: How are staff who were involved in the patient's care supported?"
        ], 
        description: "Describe the process and attach any relevant protocols.",
        email_blurb: "Outlines our process for supporting bereaved patients and their families."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "ICO registration certificate", 
        item_type: "file_only",
        email_blurb: "Attached is our current ICO registration certificate."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Provider liability/MD insurance", 
        item_type: "file_only",
        email_blurb: "Attached is our certificate of provider liability/medical defence insurance."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Information leaflet for online services", 
        
        item_type: "file_only",
        email_blurb: "Attached is the information leaflet we provide to patients regarding our online services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Safety and drug alerts process and evidence of management and actions.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Receipt & Dissemination: How are alerts received and promptly distributed to all relevant staff?", 
            "Action & Responsibility: Who is the designated lead, and what is the process for actioning alerts and documenting in patient records?", 
            "Audit & Learning: How do you maintain a central log to track alerts, actions, and outcomes?"
        ], 
        description: "Describe the process and attach evidence (e.g., completed logs, screenshots).",
        email_blurb: "Details our process for managing safety and drug alerts, with evidence of actions attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy and process for ensuring staff are recruited safely including DBS and registration checks.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for safe staff recruitment, including DBS and registration checks."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy and process to ensure practice oversight of other staff not directly employed by the practice.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the oversight of non-practice staff with access to patients or records."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for supervision and competency oversight of clinical staff.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Supervision Framework: Describe your system for clinical supervision for different roles (e.g., Nurses, HCAs), including frequency and format.", 
            "Competency Assessment: How are competencies for advanced roles (e.g., prescribing) assessed, documented, and reviewed?", 
            "Governance & Record Keeping: Where are supervision and competency records kept and how do they inform appraisals?"
        ], 
        description: "Describe the process and attach any relevant policy.",
        email_blurb: "Outlines our process for clinical supervision and competency oversight, with the relevant policy attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy for ensuring PGDs and PSDs are appropriately reviewed and signed.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of PGDs and PSDs."
    },

    // EMAIL 2: TRAINING
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Number of current staff by role and WTE.", 
        item_type: "dynamic_table", 
        headers: ["Role", "Number of Staff", "WTE"],
        email_blurb: "Provides a breakdown of current staff by role and Whole Time Equivalent (WTE)."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "List of staff and their extended role(s).", 
        item_type: "dynamic_table", 
        headers: ["Staff Name", "Extended Role(s)"],
        email_blurb: "Provides a list of staff members and their designated extended roles."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Policy of training for staff and process to manage and monitor.", 
        item_type: "file_only",
        email_blurb: "Attached is our staff training policy, including our process for management and monitoring."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Matrix of staff training.", 
        item_type: "file_only",
        description: "Attach the training matrix which should include all mandatory and role-specific training.",
        email_blurb: "Attached is our comprehensive staff training matrix."
    },

    // EMAIL 3: SAFEGUARDING
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Safeguarding adults' policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the safeguarding of adults."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Safeguarding children policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the safeguarding of children."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Sample of minutes of MDT meetings", 
        item_type: "file_only",
        description: "Attach a recent, anonymised sample of MDT meeting minutes where safeguarding was discussed.",
        email_blurb: "Attached is a sample of minutes from multidisciplinary team meetings."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Policy/process to ensure information is shared with others.", 
        item_type: "file_only",
        description: "e.g. coding of medical records",
        email_blurb: "Attached is our policy on information sharing, including the coding of medical records."
    },

    // EMAIL 4: RISK ASSESSMENTS
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest fire risk assessment and any action log", 
        item_type: "file_only",
        email_blurb: "Attached is our latest fire risk assessment and corresponding action log."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence and date of fire extinguisher check", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of our latest fire extinguisher checks."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence of latest service for emergency lights and alarm test", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of the latest service for our emergency lights and fire alarm."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Copy of the latest fire drill and actions taken.", 
        item_type: "file_only",
        email_blurb: "Attached is the record of our latest fire drill and any actions taken."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Sample of weekly fire alarm checks", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the sample checks are provided (e.g., 'March 2025')."],
        description: "Attach the log of weekly fire alarm tests for the specified month.",
        email_blurb: "Attached is a sample of our weekly fire alarm checks for the month specified."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest health and safety risk assessment and any action log", 
        item_type: "file_only",
        email_blurb: "Attached is our latest health and safety risk assessment and action log."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest legionella assessment and sample water temperature checks", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the sample temperature checks are provided (e.g., 'March 2025')."],
        description: "Attach the latest full assessment and the water temperature logs for the specified month.",
        email_blurb: "Attached is our latest legionella risk assessment and sample water temperature checks."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Copy of any other general risk assessments.", 
        item_type: "file_only",
        description: "e.g. wheelchair access, monitoring of waiting areas etc.",
        email_blurb: "Attached are copies of other general risk assessments undertaken by the practice."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Equipment calibration dates and copy of certificate", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of our equipment calibration."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "PAT testing dates and copy of certificate", 
        item_type: "file_only",
        email_blurb: "Attached is our latest PAT testing certificate."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence of immunisation status of staff.", 
        item_type: "file_only",
        email_blurb: "Attached is evidence regarding the immunisation status of our staff."
    },

    // EMAIL 5: INFECTION PREVENTION AND CONTROL
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Name and role of IPC lead", 
        item_type: "dual_text", 
        labels: ["Name of Lead", "Role"],
        email_blurb: "Provides the name and role of our designated Infection Prevention and Control (IPC) lead."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Latest Infection control policy", 
        item_type: "file_only",
        email_blurb: "Attached is our latest Infection Prevention and Control policy."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Latest Infection prevention control audit and action log.", 
        item_type: "file_only",
        email_blurb: "Attached is our latest IPC audit and corresponding action log."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Copies of any meetings where IPC has been discussed", 
        item_type: "file_only",
        description: "Include any shared learning and changes since last inspection.",
        email_blurb: "Attached are minutes from meetings where IPC was discussed, showing shared learning."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Summary of vaccine fridge management", 
        item_type: "guided_questions", 
        questions: [
            "Policy & Responsibility: Who is the named lead for vaccine storage and what are the core principles of your cold chain policy?", 
            "Equipment & Location: How many vaccine fridges do you have, where are they located, and how are they maintained?", 
            "Monitoring & Recording: Describe your process for daily temperature monitoring, including logging and acceptable ranges.", 
            "Action on Excursion: What is the procedure for a cold chain incident?", 
            "Stock Management: How do you manage vaccine stock to ensure rotation and minimise wastage?"
        ],
        email_blurb: "Provides a summary of our vaccine fridge and cold chain management procedures."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Sample of vaccine fridge temperature recordings", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the temperature logs are provided (e.g., 'March 2025')."],
        description: "Attach the temperature recordings for the specified month.",
        email_blurb: "Attached are the vaccine fridge temperature recordings for the month specified."
    },

    // EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Significant events policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of significant events."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Complaint’s policy and leaflet available to patients", 
        item_type: "file_only",
        email_blurb: "Attached is our complaints policy and the accompanying patient information leaflet."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "A summary of significant events within the last 12 months", 
        item_type: "guided_questions_and_number", 
        questions: [
            "Process for Reporting & Grading: How are significant events (SEs) reported, recorded, and graded?", 
            "Investigation & Themes: Describe your investigation process. What were the main themes from events in the last 12 months?", 
            "Learning & Actions: What were the critical learning points and what specific changes have been implemented as a result?"
        ], 
        label: "Number of events (12 months)",
        email_blurb: "Provides a summary of significant events from the last 12 months, including learning and actions taken."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "A summary of complaints received within the last 12 months", 
        item_type: "guided_questions_and_number", 
        questions: [
            "Process for Handling Complaints: Briefly describe your complaints procedure, from receipt to final response.", 
            "Analysis & Themes: What were the main themes from complaints received in the last 12 months?", 
            "Service Improvement: What specific changes to services have been made in response to patient complaints?"
        ], 
        label: "Number of complaints (12 months)",
        email_blurb: "Provides a summary of complaints from the last 12 months, detailing themes and resulting improvements."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Sample meetings minutes where SEAs and/or complaints have been discussed.", 
        item_type: "file_only",
        description: "From the past 6 months.",
        email_blurb: "Attached is a sample of meeting minutes showing discussion of significant events and complaints."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Sample of compliments received in the past 6 months.", 
        item_type: "file_only",
        email_blurb: "Attached is a sample of compliments received from patients."
    },

    // EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Summary of the quality of care you provide for the six population groups", 
        item_type: "guided_questions", 
        questions: [
            "Older people: How do you tailor services for older people (e.g., proactive care, frailty assessments)?", 
            "People with long-term conditions: Describe your approach to managing patients with LTCs (e.g., recall systems, care planning).", 
            "Families, children and young people: How do you provide accessible services for this group (e.g., immunisation clinics, safeguarding)?", 
            "Working age people: How do you ensure access for working people (e.g., online services, extended hours)?", 
            "Vulnerable people: What provisions do you have for vulnerable groups (e.g., homeless, learning disabilities, carers)?", 
            "People experiencing poor mental health: Describe your approach to supporting patients with mental health needs (e.g., access to IAPT)."
        ],
        email_blurb: "Provides a summary of how we tailor our care for the six key population groups."
    },
    {
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK",
        title: "Summary of clinical audits (last 2 years)",
        item_type: "textarea",
        description: "Provide a summary list of clinical audits completed in the last two years and explain how you decide on audit topics.",
        email_blurb: "Provides a summary of clinical audit activity undertaken in the last two years."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Full Cycle Audit Example 1", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Audit Topic & Standard: What was the topic of the audit and what standard was measured against?",
            "Initial Findings: What were the results of the first data collection cycle?",
            "Changes Implemented: What specific changes were made to practice as a result of the findings?",
            "Re-Audit Results: What were the results of the second data collection cycle, and was there an improvement?"
        ],
        description: "Describe the audit and attach the full audit document as evidence.",
        email_blurb: "Details our first example of a completed two-cycle clinical audit, with the full report attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Full Cycle Audit Example 2", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Audit Topic & Standard: What was the topic of the audit and what standard was measured against?",
            "Initial Findings: What were the results of the first data collection cycle?",
            "Changes Implemented: What specific changes were made to practice as a result of the findings?",
            "Re-Audit Results: What were the results of the second data collection cycle, and was there an improvement?"
        ],
        description: "Describe the audit and attach the full audit document as evidence.",
        email_blurb: "Details our second example of a completed two-cycle clinical audit, with the full report attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Summary of any other quality improvement work undertaken over the last two years.", 
        item_type: "guided_questions", 
        questions: [
            "Project Overview: Describe any significant Quality Improvement (QI) projects undertaken that are not clinical audits.", 
            "Methodology & Outcomes: What QI methodology was used (e.g., PDSA) and what were the measured outcomes?", 
            "Learning & Sustainability: What was learned and how have the improvements been sustained?"
        ],
        email_blurb: "Provides a summary of other non-audit Quality Improvement (QI) work from the last two years."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Evidence of how you have responded to patient feedback (last 12 months).", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Collection Methods: What formal and informal methods do you use to gather patient feedback?", 
            "Analysis & Key Themes: Provide a summary of the key themes, both positive and negative, from patient feedback.", 
            "Action & 'You Said, We Did': Provide specific examples of changes made in direct response to patient feedback."
        ], 
        description: "Summarise and attach evidence (e.g., survey results, FFT data, action logs).",
        email_blurb: "Shows how we have collected, analysed, and acted upon patient feedback, with evidence attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Patient survey results and action log (if not included above)", 
        item_type: "file_only",
        email_blurb: "Attached are the results and action log from our own patient survey."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Evidence of how you have responded to staff feedback (last 12 months).", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Collection Methods: What mechanisms are in place for staff to provide feedback?", 
            "Analysis & Key Themes: What were the key themes from staff feedback over the last 12 months?", 
            "Action & Response: Provide specific examples of changes made in response to staff feedback."
        ], 
        description: "Summarise and attach evidence (e.g., staff survey results).",
        email_blurb: "Shows how we have collected, analysed, and acted upon staff feedback, with evidence attached."
    },

    // EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Discharge (medicine reconciliation) process and any audits/checks undertaken.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Process Workflow: Describe the end-to-end process from receiving a discharge summary to updating the patient's record.", 
            "Roles & Responsibilities: Who is responsible for each step of the process (e.g., admin, clinical pharmacist, GP)?", 
            "Quality Assurance: How do you audit compliance? Provide a summary of any recent audit findings."
        ], 
        description: "Describe the process and attach audits/checks.",
        email_blurb: "Details our process for medicine reconciliation following patient discharge, with recent audits attached."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Policy and process for the management of repeat prescriptions and medicine reviews.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of repeat prescriptions and medication reviews."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Patient summarising/coding in medical records policy/process and any audits.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "New Patient Record Summarising: Describe your process and target timeframe for summarising new patient records.", 
            "Clinical Correspondence Workflow: How is incoming correspondence processed, read, coded, and actioned?", 
            "Quality Assurance: What systems are in place to ensure coding is accurate, consistent, and timely?"
        ], 
        description: "Describe the process and attach audits/checks.",
        email_blurb: "Outlines our process for summarising and coding patient records, with recent audits attached."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Number of patient records that have not been fully summarised.", 
        item_type: "number", 
        label: "Number of records",
        email_blurb: "Provides the current number of patient records awaiting full summarisation."
    },

    // EMAIL 9: DATA FOR THE REPORT
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "NHS health checks data (last 12 months)", 
        item_type: "triple_number", 
        labels: ["Eligible", "Offered", "Completed"],
        email_blurb: "Provides our NHS Health Checks data for the last 12 months."
    },
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "Learning Disability check data (last 12 months)", 
        item_type: "triple_number", 
        labels: ["Eligible", "Offered", "Completed"],
        email_blurb: "Provides our Learning Disability Health Checks data for the last 12 months."
    },
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "Cervical cancer screening and child immunisation coverage data.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Cervical Screening Uptake Strategy: Describe the specific actions you have taken to improve cervical screening uptake.", 
            "Childhood Immunisation Uptake Strategy: Describe the specific actions you have taken to improve childhood immunisation rates.", 
            "Data & Outcomes: What has been the impact of these actions on your uptake data?"
        ], 
        description: "Summarise actions and attach coverage data.",
        email_blurb: "Provides our latest uptake data for cervical screening and childhood immunisations, along with actions taken to improve coverage."
    },
];

</script>

<script type="module">
  // Supabase v2 client
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  import JSZip from "https://esm.sh/jszip@3.10.1";

  const SUPABASE_URL = "https://unveoqnlqnobufhublyw.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });
  // Expose to global for non-module scripts
  window.JSZip = JSZip;
  window.supabase = supabase;

  // SPA navigation
  const nav = document.getElementById("nav");
  const views = [...document.querySelectorAll("section.view")];

  // Sidebar toggle (also resize grid + persist state)
  const toggleBtn = document.getElementById("toggleSidebar");
  const sidebar = document.getElementById("sidebar");
  const appGrid = document.getElementById("app");
  if (toggleBtn && sidebar && appGrid) {
    toggleBtn.addEventListener("click", ()=>{
      appGrid.classList.toggle("collapsed");
      sidebar.classList.toggle("collapsed");
      try{ localStorage.setItem("cl_sidebar_collapsed", appGrid.classList.contains("collapsed") ? "1" : "0"); }catch(_){ }
    });
  }

  function setActiveSection(id){
    if(!id) return;
    console.log('setActiveSection called with:', id);
    const btn = nav.querySelector(`button[data-section="${id}"]`);
    if(!btn) return;
    // active state
    nav.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    // show view
    views.forEach(v => v.classList.remove("active"));
    const viewEl = document.getElementById("view-"+id);
    if(viewEl) viewEl.classList.add("active");
    
    // Load section data
    switch(id) {
      case 'dashboard':
        Promise.all([
          loadCounts(),
          loadDue(),
          loadActivity(),
          loadWeekCalendar()
        ]);
        break;
      case 'items':
        loadItems();
        break;
      case 'rooms':
        loadRooms();
        break;
      case 'complaints':
        loadComplaints();
        break;
      case 'checktypes':
        loadCheckTypes();
        break;
      case 'schedules':
        loadSchedules();
        break;
      case 'staff':
        loadStaff();
        break;
      case 'submissions':
        loadSubmissions();
        break;
      case 'pre-inspection':
        loadAndRenderPIR();
        break;
      case 'calendar':
        loadAndRenderCalendar();
        break;
      case 'settings':
        // Only initialize debug features on Site Settings page
        initDebugToggle();
        break;
      case 'users':
        // Users page hosts practice users listing and invite management
        loadPracticeUsers();
        break;
    }
    
    // persist
    try { localStorage.setItem("cl_active_section", id); } catch(_) {}
  }

  nav.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-section]");
    if(!btn) return;
    const id = btn.getAttribute("data-section");
    setActiveSection(id);
    
    // Special handling for settings and users sections
    if (id === 'settings') {
      setTimeout(() => {
        initDebugToggle();
      }, 100);
    }
    if (id === 'users') {
      setTimeout(() => {
        loadPracticeUsers();
      }, 100);
    }
    
    // Special handling for training section
    if (id === 'training') {
      setTimeout(() => loadTrainingMatrix(), 100); // Small delay to ensure context is loaded
    }
  });

  // --- Nav group toggles (expand/collapse groups) ---
  function initNavGroupToggles(){
    const groups = [
      { toggleId: 'toggle-cqc',    groupId: 'group-cqc',    storageKey: 'cl_group_cqc_expanded' },
      { toggleId: 'toggle-checks',  groupId: 'group-checks', storageKey: 'cl_group_checks_expanded' },
      { toggleId: 'toggle-scans',   groupId: 'group-scans',  storageKey: 'cl_group_scans_expanded' },
  { toggleId: 'toggle-config',  groupId: 'group-config',  storageKey: 'cl_group_config_expanded' },
  { toggleId: 'toggle-settings', groupId: 'group-settings', storageKey: 'cl_group_settings_expanded' }
    ];

    groups.forEach(g => {
      const t = document.getElementById(g.toggleId);
      const group = document.getElementById(g.groupId);
      if(!t || !group) return;

      // Initialize from localStorage (default expanded)
      let expanded = true;
      try { const saved = localStorage.getItem(g.storageKey); if(saved !== null) expanded = saved === '1'; } catch(_){}
      t.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      if(!expanded) group.classList.add('collapsed');

      t.addEventListener('click', () => {
        const isExp = t.getAttribute('aria-expanded') === 'true';
        const next = !isExp;
        t.setAttribute('aria-expanded', next ? 'true' : 'false');
        if(next) group.classList.remove('collapsed'); else group.classList.add('collapsed');
        try { localStorage.setItem(g.storageKey, next ? '1' : '0'); } catch(_){}
      });
    });
  }

  // Run once DOM and nav exist
  initNavGroupToggles();

  // User Management
  const inviteModal = document.getElementById('invite-modal');
  const inviteForm = document.getElementById('invite-form');
  const inviteError = document.getElementById('invite-error');

  function showInviteModal() {
    // Populate reports-to list and role list
    (async () => {
      const reportsToSel = document.getElementById('invite-reports-to');
      const roleSel = document.getElementById('invite-role');
      
      if (reportsToSel) {
        reportsToSel.innerHTML = '<option value="">—</option>';
      }
      if (roleSel) {
        roleSel.innerHTML = '<option value="">—</option>';
      }
      
      if (!ctx.site_id) return;
      
      try {
        // Load reports-to list from kiosk_users
        if (reportsToSel) {
          const { data: users, error: usersError } = await supabase.from('kiosk_users').select('id, full_name').eq('site_id', ctx.site_id).eq('active', true).order('full_name');
          if (!usersError && Array.isArray(users)) {
            users.forEach(u => {
              const opt = document.createElement('option');
              opt.value = u.id;
              opt.textContent = u.full_name || u.id;
              reportsToSel.appendChild(opt);
            });
          }
        }
        
        // Load roles list from kiosk_roles
        if (roleSel) {
          const { data: roles, error: rolesError } = await supabase.from('kiosk_roles').select('role').order('role');
          if (!rolesError && Array.isArray(roles)) {
            roles.forEach(r => {
              const opt = document.createElement('option');
              opt.value = r.role;
              opt.textContent = r.role;
              roleSel.appendChild(opt);
            });
          }
        }
      } catch (e) { 
        console.warn('Failed to load dropdown lists', e); 
      }
    })();

    inviteModal.classList.add('show');
    inviteError.style.display = 'none';
    inviteForm.reset();
  }

  function closeInviteModal() {
    inviteModal.classList.remove('show');
  }

  document.getElementById('btn-invite-user')?.addEventListener('click', showInviteModal);
  document.getElementById('invite-modal-close')?.addEventListener('click', closeInviteModal);
  document.getElementById('invite-cancel-btn')?.addEventListener('click', closeInviteModal);

  // Training event listeners
  document.getElementById('tab-clinical')?.addEventListener('click', () => switchTrainingTab('clinical'));
  document.getElementById('tab-non-clinical')?.addEventListener('click', () => switchTrainingTab('non-clinical'));
  document.getElementById('btn-manage-training-types')?.addEventListener('click', openTrainingTypesModal);
  document.getElementById('btn-export-training')?.addEventListener('click', exportTrainingReport);
  document.getElementById('training-modal-close')?.addEventListener('click', closeTrainingModal);
  document.getElementById('training-cancel-btn')?.addEventListener('click', closeTrainingModal);
  document.getElementById('training-form')?.addEventListener('submit', saveTrainingRecord);
  document.getElementById('training-certificate')?.addEventListener('change', handleTrainingFileUpload);
  document.getElementById('training-completion-date')?.addEventListener('change', calculateTrainingExpiry);
  document.getElementById('training-upload-zone')?.addEventListener('click', () => {
    document.getElementById('training-certificate')?.click();
  });

  // Training types modal event listeners
  document.getElementById('training-types-close')?.addEventListener('click', closeTrainingTypesModal);
  document.getElementById('training-types-cancel')?.addEventListener('click', closeTrainingTypesModal);
  document.getElementById('save-training-types')?.addEventListener('click', saveTrainingTypes);
  document.getElementById('add-training-type')?.addEventListener('click', addNewTrainingType);

  // Helper functions for training types modal
  function openTrainingTypesModal() {
    document.getElementById('training-types-modal').classList.add('show');
    loadTrainingTypes();
  }

  function closeTrainingTypesModal() {
    document.getElementById('training-types-modal').classList.remove('show');
  }

  async function loadTrainingTypes() {
    const list = document.getElementById('training-types-list');
    list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">Loading...</div>';
    
    try {
      const { data, error } = await supabase
        .from('training_types')
        .select('*')
        .eq('site_id', ctx.site_id)
        .order('name');
      
      if (error) throw error;
      
      list.innerHTML = data.map(type => `
        <div class="training-type-row" data-id="${type.id}">
          <input type="text" value="${esc(type.name)}" data-field="name">
          <select data-field="validity_months">
            <option value="">No Expiry</option>
            <option value="6" ${type.validity_months === 6 ? 'selected' : ''}>6 months</option>
            <option value="12" ${type.validity_months === 12 ? 'selected' : ''}>12 months</option>
            <option value="24" ${type.validity_months === 24 ? 'selected' : ''}>24 months</option>
            <option value="36" ${type.validity_months === 36 ? 'selected' : ''}>36 months</option>
          </select>
          <input type="checkbox" ${type.clinical ? 'checked' : ''} data-field="clinical">
          <input type="checkbox" ${type.non_clinical ? 'checked' : ''} data-field="non_clinical">
          <input type="checkbox" ${type.active ? 'checked' : ''} data-field="active">
          <button type="button" class="btn secondary" onclick="deleteTrainingType(${type.id})">Delete</button>
        </div>
      `).join('');
    } catch (err) {
      console.error('Failed to load training types:', err);
      list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Failed to load training types</div>';
    }
  }

  function addNewTrainingType() {
    const list = document.getElementById('training-types-list');
    const newRow = `
      <div class="training-type-row" data-id="new-${Date.now()}">
        <input type="text" placeholder="Training name..." data-field="name">
        <select data-field="validity_months">
          <option value="">No Expiry</option>
          <option value="6">6 months</option>
          <option value="12" selected>12 months</option>
          <option value="24">24 months</option>
          <option value="36">36 months</option>
        </select>
        <input type="checkbox" checked data-field="clinical">
        <input type="checkbox" checked data-field="non_clinical">
        <input type="checkbox" checked data-field="active">
        <button type="button" class="btn secondary" onclick="this.parentElement.remove()">Remove</button>
      </div>
    `;
    list.insertAdjacentHTML('beforeend', newRow);
  }

  async function saveTrainingTypes() {
    const rows = document.querySelectorAll('.training-type-row');
    const updates = [];
    const inserts = [];
    
    for (const row of rows) {
      const id = row.dataset.id;
      const name = row.querySelector('[data-field="name"]').value.trim();
      const validity_months = row.querySelector('[data-field="validity_months"]').value || null;
      const clinical = row.querySelector('[data-field="clinical"]').checked;
      const non_clinical = row.querySelector('[data-field="non_clinical"]').checked;
      const active = row.querySelector('[data-field="active"]').checked;
      
      if (!name) continue;
      
      const data = {
        site_id: ctx.site_id,
        name,
        validity_months: validity_months ? parseInt(validity_months) : null,
        clinical,
        non_clinical,
        active
      };
      
      if (id.startsWith('new-')) {
        inserts.push(data);
      } else {
        updates.push({ id: parseInt(id), ...data });
      }
    }
    
    try {
      if (inserts.length > 0) {
        const { error } = await supabase.from('training_types').insert(inserts);
        if (error) throw error;
      }
      
      for (const update of updates) {
        const { id, ...updateData } = update;
        const { error } = await supabase
          .from('training_types')
          .update(updateData)
          .eq('id', id);
        if (error) throw error;
      }
      
      closeTrainingTypesModal();
      loadTrainingMatrix();
    } catch (err) {
      console.error('Failed to save training types:', err);
      document.getElementById('training-types-error').textContent = err.message;
      document.getElementById('training-types-error').style.display = 'block';
    }
  }

  window.deleteTrainingType = async function(id) {
    if (!confirm('Are you sure you want to delete this training type?')) return;
    
    try {
      const { error } = await supabase
        .from('training_types')
        .update({ active: false })
        .eq('id', id);
      if (error) throw error;
      
      loadTrainingTypes();
    } catch (err) {
      console.error('Failed to delete training type:', err);
      alert('Failed to delete training type');
    }
  };

  function exportTrainingReport() {
    // This would generate and download a training report
    alert('Training report export functionality would be implemented here');
  }

  inviteForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    inviteError.style.display = 'none';

    const name = document.getElementById('invite-name').value.trim();
    const email = document.getElementById('invite-email').value.trim();
    const access = document.getElementById('invite-access').value;
    const roleDetail = document.getElementById('invite-role').value;
    const reportsToId = document.getElementById('invite-reports-to').value || null;
    
    console.log('Submitting invite:', { name, email, access, roleDetail, reportsToId, site_id: ctx.site_id, user_id: ctx.user?.id });

    if (!name || !email || !access) {
      inviteError.textContent = 'Please fill in Name, Email and Access';
      inviteError.style.display = 'block';
      return;
    }

    if (!ctx.site_id) {
      inviteError.textContent = 'No site selected';
      inviteError.style.display = 'block';
      return;
    }

    if (!ctx.user?.id) {
      inviteError.textContent = 'User not authenticated';
      inviteError.style.display = 'block';
      return;
    }

    try {
      // Generate a unique token for the invite
      const inviteToken = crypto.randomUUID ? crypto.randomUUID() : 'token-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      
      // Create invite record (role column stores access level)
      // Map 'staff' access to 'admin' role to avoid RLS policy conflicts
      const mappedRole = access === 'staff' ? 'admin' : access;
      
      const inviteData = {
        email,
        full_name: name,
        role: mappedRole,
        role_detail: roleDetail || null,
        reports_to_id: reportsToId ? parseInt(reportsToId, 10) : null,
        site_id: ctx.site_id,
        status: 'pending',
        token: inviteToken,
        expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 days
        invited_by: ctx.user.id,
        allowed_pages: '[]'
      };

      console.log('Creating invite with data:', inviteData);

      // First create the invite record
      const { data: createdInvite, error: createError } = await supabase
        .from('site_invites')
        .insert(inviteData)
        .select()
        .single();

      if (createError) throw createError;

      // Build the invite URL
      const inviteUrl = `${window.location.origin}/Home.html?invite=${inviteToken}`;

      // Send the invite email using Supabase Auth
      const { error: emailError } = await supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: inviteUrl,
          data: {
            full_name: name,
            role: mappedRole,  // Use mapped role for consistency
            role_detail: roleDetail,
            reports_to_id: reportsToId,
            site_id: ctx.site_id,
            invite_token: inviteToken
          }
        }
      });

      if (emailError) {
        console.error('Failed to send invite email:', emailError);
        // Add a warning to the UI but don't block
        inviteError.textContent = 'Invite created but email delivery may be delayed. Please check spam folder or try again.';
        inviteError.style.display = 'block';
        inviteError.style.backgroundColor = '#fff3cd';
        inviteError.style.color = '#856404';
        inviteError.style.border = '1px solid #ffeeba';
        setTimeout(() => {
          closeInviteModal();
          loadPracticeUsers();
        }, 3000);
        return;
      }

      console.log('Invite created and email sent successfully');
      
      // Show success message
      inviteError.textContent = 'Invitation sent successfully! The user will receive an email to join.';
      inviteError.style.display = 'block';
      inviteError.style.backgroundColor = '#d4edda';
      inviteError.style.color = '#155724';
      inviteError.style.border = '1px solid #c3e6cb';
      
      // Close modal and refresh list after showing success message
      setTimeout(() => {
        closeInviteModal();
        loadPracticeUsers();
      }, 2000);
    } catch (err) {
      console.error('Failed to send invitation:', err);
      inviteError.textContent = err.message || 'Failed to send invitation';
      inviteError.style.display = 'block';
    }
  });

  async function loadPracticeUsers() {
    const tbody = document.getElementById('practice-users-tbody');
    if (!tbody) {
      console.error('practice-users-tbody element not found');
      return;
    }
    
    if (!ctx.site_id) {
      tbody.innerHTML = '<tr><td colspan="5" class="muted">No site selected</td></tr>';
      return;
    }

    tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading users...</td></tr>';

    try {
      console.log('Loading users for site_id:', ctx.site_id);
      
      // Test access to site_invites table first
      console.log('Testing site_invites table access...');
      const { data: testInvites, error: testError } = await supabase
        .from('site_invites')
        .select('count')
        .limit(1);
      
      if (testError) {
        console.error('Cannot access site_invites table:', testError);
      } else {
        console.log('site_invites table accessible');
      }
      
      // Get users and their profiles - simplified query first
      const { data: users, error: usersError } = await supabase
        .from('profiles')
        .select('*')
        .eq('site_id', ctx.site_id);

      if (usersError) {
        console.error('Error loading profiles:', usersError);
        throw usersError;
      }

      console.log('Loaded users:', users);

      // Get pending invites
      const { data: invites, error: invitesError } = await supabase
        .from('site_invites')
        .select('*')
        .eq('site_id', ctx.site_id)
        .eq('status', 'pending')
        .gte('expires_at', new Date().toISOString());

      if (invitesError) {
        console.error('Error loading invites:', invitesError);
        // Continue without invites rather than failing completely
      }

      console.log('Loaded invites:', invites);

      const allRows = [
        // Active users
        ...(users || []).map(u => ({
          name: u.full_name || 'Unknown',
          email: u.user_id, // Using user_id as email fallback since we can't join to auth.users
          role: u.role || 'User',
          status: 'Active',
          actions: `<button class="btn secondary" onclick="deactivateUser('${u.user_id}')">Deactivate</button>`
        })),
        // Pending invites
        ...((invites || []).map(i => ({
          name: i.full_name,
          email: i.email,
          role: i.role,
          status: 'Invited',
          actions: `<button class="btn secondary" onclick="cancelInvite('${i.id}')">Cancel Invite</button>`
        })))
      ];

      tbody.innerHTML = allRows.length ? allRows.map(r => `
        <tr>
          <td>${esc(r.name)}</td>
          <td>${esc(r.email)}</td>
          <td>${esc(r.role)}</td>
          <td><span class="chip ${r.status === 'Active' ? 'success' : 'warning'}">${esc(r.status)}</span></td>
          <td>${r.actions}</td>
        </tr>
      `).join('') : '<tr><td colspan="5" class="muted">No users yet</td></tr>';

    } catch (err) {
      console.error('Failed to load users:', err);
      let errorMessage = 'Failed to load users';
      if (err.message) {
        errorMessage += ': ' + err.message;
      }
      if (err.code) {
        errorMessage += ' (Code: ' + err.code + ')';
      }
      tbody.innerHTML = `<tr><td colspan="5" class="muted">${errorMessage}</td></tr>`;
    }
  }

  // Global functions for user actions
  window.deactivateUser = async function(userId) {
    if (!confirm('Are you sure you want to deactivate this user?')) return;

    try {
      const { error } = await supabase
        .from('profiles')
        .update({ active: false })
        .eq('user_id', userId)
        .eq('site_id', ctx.site_id);

      if (error) throw error;
      loadPracticeUsers();
    } catch (err) {
      console.error('Failed to deactivate user:', err);
      alert('Failed to deactivate user');
    }
  };

  window.cancelInvite = async function(inviteId) {
    if (!confirm('Are you sure you want to cancel this invitation?')) return;

    try {
      console.log('Attempting to cancel invitation:', { inviteId, siteId: ctx.site_id });
      
      // First try using the stored procedure approach
      const { data: functionResult, error: functionError } = await supabase
        .rpc('cancel_site_invitation', { invite_id: inviteId });

      if (functionError) {
        console.error('Function approach failed:', functionError);
        
        // Fallback to direct update approach
        console.log('Trying direct update approach...');
        const { data, error } = await supabase
          .from('site_invites')
          .update({ status: 'revoked' })
          .eq('id', inviteId)
          .eq('site_id', ctx.site_id)
          .select();

        if (error) {
          console.error('Direct update also failed:', {
            message: error.message,
            details: error.details,
            hint: error.hint,
            code: error.code
          });
          throw error;
        }

        if (!data || data.length === 0) {
          throw new Error('No invitation found to cancel. This may be due to permissions or the invitation may already be processed.');
        }
      } else {
        // Check function result
        console.log('Function result:', functionResult);
        
        if (!functionResult.success) {
          throw new Error(functionResult.error || 'Unknown error from cancel function');
        }
        
        console.log('Successfully cancelled invitation via function');
      }

      console.log('Successfully cancelled invitation');
      loadPracticeUsers();
    } catch (err) {
      console.error('Failed to cancel invitation:', err);
      let errorMsg = 'Failed to cancel invitation';
      if (err.message) {
        errorMsg += ': ' + err.message;
      }
      if (err.details) {
        errorMsg += '\nDetails: ' + err.details;
      }
      if (err.hint) {
        errorMsg += '\nHint: ' + err.hint;
      }
      alert(errorMsg);
    }
  };

  // Debug window toggle functionality
  function initDebugToggle() {
    const toggle = document.getElementById('debug-window-toggle');
    const debugPanel = document.getElementById('debug-panel');
    
    if (!toggle || !debugPanel) return;
    
    // Load saved state (default to false - debug disabled by default)
    const debugEnabled = localStorage.getItem('cl_debug_enabled') === 'true';
    toggle.checked = debugEnabled;
    debugPanel.style.display = debugEnabled ? 'block' : 'none';
    
    // Handle toggle changes
    toggle.addEventListener('change', function() {
      const isEnabled = this.checked;
      debugPanel.style.display = isEnabled ? 'block' : 'none';
      localStorage.setItem('cl_debug_enabled', isEnabled ? 'true' : 'false');
    });
  }

  // Initialize data loading
  async function initializeApp() {
    try {
      // Load initial context
      await loadContext();
      
      // Initialize debug toggle on app start
      initDebugToggle();
      
      // Restore last active section
      const saved = localStorage.getItem("cl_active_section") || "dashboard";
      setActiveSection(saved);

      // Preload some common data
      await Promise.all([
        loadCounts(),
        loadDue(),
        loadActivity()
      ]);
    } catch(err) {
      console.error('Failed to initialize app:', err);
    }
  }

  // Start initialization
  initializeApp();

  // Restore sidebar collapsed state
  try {
    const s = localStorage.getItem("cl_sidebar_collapsed");
    if(s === "1"){
      document.getElementById("app")?.classList.add("collapsed");
      document.getElementById("sidebar")?.classList.add("collapsed");
    }
  } catch(_) {}

  // Quick UX
  const search = document.getElementById("search");
  window.addEventListener("keydown", (e)=>{ if(e.key==="/"){ e.preventDefault(); search.focus(); } });

  // Auth overlay controls
  const authOverlay = document.getElementById("auth");
  const emailPill = document.getElementById("email-pill");
  const sitePill = document.getElementById("site-pill");
  const signoutBtn = document.getElementById("signout");
  const signinForm = document.getElementById("signin-form");
  const authErr = document.getElementById("auth-error");

  signoutBtn.addEventListener("click", async()=>{
    await supabase.auth.signOut();
    window.location.href = 'Home.html';
  });

  // On page load, check for a valid session. If not found, redirect to login.
  supabase.auth.getSession().then(async ({ data: { session } }) => {
    if (!session) {
      window.location.href = 'Home.html';
      return;
    }

    // Initialize the context with the session
    try {
      await loadContext();
      await Promise.all([
        loadCounts(),
        loadDue(),
        loadActivity()
      ]);
    } catch (err) {
      console.error('Failed to initialize:', err);
      // If we fail to load the context, we should probably log out
      await supabase.auth.signOut();
      window.location.href = 'Home.html';
    }
  }).catch(err => {
    console.error('Session check failed:', err);
    window.location.href = 'Home.html';
  });

  // Load profile + site context
  let ctx = { site_id: null, role: null, user: null };
  // Items view state
  let itemsSort = { col: "item_name", dir: "asc" };
  let itemsQuery = "";
  // Calendar state
  let calendarDate = new Date();
  // Prevent click-through after closing modals (iOS/Safari ghost clicks)
  let suppressGridClickUntil = 0;
  let currentCalendarView = 'scheduled';
  let requiredSchedulesCache = [];
  let pirDocsCache = [];

  async function loadContext(){
    try {
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      if(userError || !user) throw new Error("No authenticated user");
      
      ctx.user = user;
      emailPill.textContent = user.email || "—";

      // Load user profile to get site_id and role
      const { data: profile, error: profileError } = await supabase
        .from("profiles")
        .select("site_id, role, full_name")
        .eq("user_id", user.id)
        .maybeSingle();

      if(profileError) throw profileError;
      if(!profile) throw new Error("No profile found for user");

      ctx.site_id = profile.site_id;
      ctx.role = profile.role;
      ctx.full_name = profile.full_name;

      // Load site information
      if(ctx.site_id){
        const { data: site } = await supabase
          .from("sites")
          .select("name")
          .eq("id", ctx.site_id)
          .maybeSingle();
        
        sitePill.textContent = site?.name ? `Site: ${site.name}` : `Site ID: ${ctx.site_id}`;
        ctx.site_name = site?.name || null;
      } else {
        sitePill.textContent = "Site: —";
      }

      return ctx;
    } catch(err) {
      console.error('Failed to load context:', err);
      throw err;
    }
  }

  // Data loaders
  async function loadCounts(){
    if(!ctx.site_id) return;
    const [items, rooms, complaints, ct, staff] = await Promise.all([
      supabase.from("items").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from("rooms").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from("complaints").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from("check_types").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from("kiosk_users").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
    ]);
    if(typeof setDueTab === 'function') setDueTab('due');

    // document.getElementById("stat-items").textContent = items.count ?? "0";
    // document.getElementById("stat-rooms").textContent = rooms.count ?? "0";
    // document.getElementById("stat-ct").textContent = ct.count ?? "0";
    // document.getElementById("stat-staff").textContent = staff.count ?? "0";
    document.getElementById('badge-items').textContent = items.count ?? 0;
    document.getElementById('badge-rooms').textContent = rooms.count ?? 0;
    document.getElementById('badge-complaints').textContent = complaints.count ?? 0;
    document.getElementById('badge-ct').textContent = ct.count ?? 0;
    document.getElementById('badge-staff').textContent = staff.count ?? 0;
  }

  // helper: start/end of day
function startOfDay(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
function endOfDay(d){ const x = new Date(d); x.setHours(23,59,59,999); return x; }

async function loadDue(){
  const tb = document.getElementById("due-tbody");
  const emptyMsg = "<tr><td colspan='4' class='muted'>Nothing due in the next 7 days.</td></tr>";
  tb.innerHTML = "<tr><td colspan='4' class='muted'>Loading…</td></tr>";
  if(!ctx.site_id) { tb.innerHTML = "<tr><td colspan='4' class='muted'>No site selected.</td></tr>"; return; }
  const today = startOfDay(new Date());
  const end = new Date(today); end.setDate(end.getDate() + 7);

  const { data, error } = await supabase
    .from("v_item_check_status")
    .select("item_name, room_name, check_type, next_due_at")
    .eq("site_id", ctx.site_id)
    .gte("next_due_at", today.toISOString())
    .lt("next_due_at", end.toISOString())
    .order("next_due_at", { ascending:true })
    .limit(500);

  if(error){ tb.innerHTML = `<tr><td colspan='4' class='muted'>${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = emptyMsg; return; }
  // prepare rows with date helper
  data.forEach(r=>{ r.__date = r.next_due_at; });

  // group by item, room, and date
  const grouped = {};
  (data||[]).forEach(r=>{
    const dStr = new Date(r.__date).toLocaleDateString(undefined, { weekday: 'short', month: 'numeric', day: 'numeric' });
    const key = `${r.item_name}|${r.room_name||'—'}|${dStr}`;
    if(!grouped[key]) grouped[key] = { item:r.item_name, room:r.room_name||'—', date:dStr, checks:[] };
    grouped[key].checks.push(r.check_type || r.check);
  });
  const rows = Object.values(grouped);
  if(!rows.length){ tb.innerHTML = emptyMsg; return; }
  tb.innerHTML = rows.map(g=>`<tr>
      <td>${esc(g.item)}</td>
      <td>${esc(g.checks.join(', '))}</td>
      <td>${esc(g.room)}</td>
      <td>${g.date}</td>
    </tr>`).join("");

}

async function loadMissed(){
  const tb = document.getElementById("due-tbody");
  const emptyMsg = "<tr><td colspan='4' class='muted'>No missed checks in the past 7 days.</td></tr>";
  tb.innerHTML = "<tr><td colspan='4' class='muted'>Loading…</td></tr>";
  if(!ctx.site_id) { tb.innerHTML = "<tr><td colspan='4' class='muted'>No site selected.</td></tr>"; return; }
  const today = startOfDay(new Date());
  const past = new Date(today); past.setDate(past.getDate() - 7);

  const { data, error } = await supabase
    .from("v_item_check_status")
    .select("item_name, room_name, check_type, next_due_at, last_done_at")
    .eq("site_id", ctx.site_id)
    .gte("next_due_at", past.toISOString())
    .lt("next_due_at", today.toISOString())
    .order("next_due_at", { ascending:false })
    .limit(500);

  if(error){ tb.innerHTML = `<tr><td colspan='4' class='muted'>${error.message}</td></tr>`; return; }
  const missed = (data||[]).filter(r => {
    if(!r.last_done_at) return true;
    try{ return new Date(r.last_done_at) < new Date(r.next_due_at); }catch(e){ return true; }
  });
  if(!missed.length){ tb.innerHTML = emptyMsg; return; }
  missed.forEach(r=>{ r.__date = r.next_due_at; });

  // group by item, room, and date — use the filtered `missed` array (was incorrectly using `data`)
  const grouped = {};
  (missed||[]).forEach(r=>{
    const dStr = new Date(r.__date).toLocaleDateString(undefined, { weekday: 'short', month: 'numeric', day: 'numeric' });
    const key = `${r.item_name}|${r.room_name||'—'}|${dStr}`;
    if(!grouped[key]) grouped[key] = { item:r.item_name, room:r.room_name||'—', date:dStr, checks:[] };
    grouped[key].checks.push(r.check_type || r.check);
  });
  const rows = Object.values(grouped);
  if(!rows.length){ tb.innerHTML = emptyMsg; return; }
  tb.innerHTML = rows.map(g=>`<tr>
      <td>${esc(g.item)}</td>
      <td>${esc(g.checks.join(', '))}</td>
      <td>${esc(g.room)}</td>
      <td>${g.date}</td>
    </tr>`).join("");

}

async function loadCompleted(){
  const tb = document.getElementById("due-tbody");
  const emptyMsg = "<tr><td colspan='4' class='muted'>No completed checks in the past 7 days.</td></tr>";
  tb.innerHTML = "<tr><td colspan='4' class='muted'>Loading…</td></tr>";
  if(!ctx.site_id) { tb.innerHTML = "<tr><td colspan='4' class='muted'>No site selected.</td></tr>"; return; }
  const today = endOfDay(new Date());
  const past = new Date(); past.setHours(0,0,0,0); past.setDate(past.getDate() - 7);

  const { data, error } = await supabase
    .from("v_item_check_status")
    .select("item_name, room_name, check_type, last_done_at")
    .eq("site_id", ctx.site_id)
    .gte("last_done_at", past.toISOString())
    .lte("last_done_at", today.toISOString())
    .order("last_done_at", { ascending:false })
    .limit(500);

  if(error){ tb.innerHTML = `<tr><td colspan='4' class='muted'>${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = emptyMsg; return; }
  data.forEach(r=>{ r.__date = r.last_done_at; });

  // group by item, room, and date
  const grouped = {};
  (data||[]).forEach(r=>{
    const dStr = new Date(r.__date).toLocaleDateString(undefined, { weekday: 'short', month: 'numeric', day: 'numeric' });
    const key = `${r.item_name}|${r.room_name||'—'}|${dStr}`;
    if(!grouped[key]) grouped[key] = { item:r.item_name, room:r.room_name||'—', date:dStr, checks:[] };
    grouped[key].checks.push(r.check_type || r.check);
  });
  const rows = Object.values(grouped);
  if(!rows.length){ tb.innerHTML = emptyMsg; return; }
  tb.innerHTML = rows.map(g=>`<tr>
      <td>${esc(g.item)}</td>
      <td>${esc(g.checks.join(', '))}</td>
      <td>${esc(g.room)}</td>
      <td>${g.date}</td>
    </tr>`).join("");

}

// Tab control
function setDueTab(tab){
  document.getElementById('tab-due').classList.toggle('active', tab==='due');
  document.getElementById('tab-missed').classList.toggle('active', tab==='missed');
  document.getElementById('tab-completed').classList.toggle('active', tab==='completed');

  // visually switch the secondary class active state (keeps styling coherent)
  ['tab-due','tab-missed','tab-completed'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(el.classList.contains('active')) el.classList.add('active');
    else el.classList.remove('active');
  });

  if(tab==='due') return loadDue();
  if(tab==='missed') return loadMissed();
  if(tab==='completed') return loadCompleted();
}

// attach handlers (defensive - may run before DOM in some builds)
setTimeout(()=>{
  const t1 = document.getElementById('tab-due'); if(t1) t1.addEventListener('click',()=>setDueTab('due'));
  const t2 = document.getElementById('tab-missed'); if(t2) t2.addEventListener('click',()=>setDueTab('missed'));
  const t3 = document.getElementById('tab-completed'); if(t3) t3.addEventListener('click',()=>setDueTab('completed'));
}, 50);


  async function loadActivity(){
    const tb = document.getElementById("activity-tbody");
    const { data, error } = await supabase
      .from("submissions")
      .select("id, staff_name, submitted_at, comment")
      .eq("site_id", ctx.site_id).order("submitted_at", { ascending:false }).limit(10);
    if(error){ tb.innerHTML = `<tr><td colspan='3' class='muted'>${error.message}</td></tr>`; return; }
    if(!data?.length){ tb.innerHTML = "<tr><td colspan='3' class='muted'>No recent activity.</td></tr>"; return; }
    // fetch counts per submission_id
    const ids = data.map(d=>d.id);
    const { data: rows } = await supabase
      .from("submission_rows")
      .select("submission_id", { count:"exact" })
      .in("submission_id", ids);
    const counts = {};
    rows?.forEach(r => { counts[r.submission_id] = (counts[r.submission_id]||0)+1; });
    document.getElementById("activity-tbody").innerHTML = data.map(r=>`
      <tr><td>${fmtDate(r.submitted_at)}</td><td>${esc(r.staff_name||"—")}</td><td>${counts[r.id] ?? 0}</td></tr>
    `).join("");
  }

  async function loadItems(){
    const tb = document.getElementById("items-tbody");
    let q = supabase.from("v_items_admin").select("*").eq("site_id", ctx.site_id);

    if(itemsQuery){
      const qi = `%${itemsQuery}%`;
      q = q.or([
        `item_id.ilike.${qi}`,
        `item_name.ilike.${qi}`,
        `room_name.ilike.${qi}`,
        `default_check_type_name.ilike.${qi}`,
        // fallbacks for raw items table fields
        `room.ilike.${qi}`,
        `default_check_type.ilike.${qi}`
      ].join(','));
    }

    const col = itemsSort.col || "item_name";
    const ascending = (itemsSort.dir !== "desc");
    q = q.order(col, { ascending });

    const { data, error } = await q;
    if(error){ tb.innerHTML = `<tr><td colspan="5" class="muted">${error.message}</td></tr>`; return; }
    if(!data?.length){ tb.innerHTML = `<tr><td colspan="5" class="muted">No items yet.</td></tr>`; return; }

    ["item_id","item_name","room_name","default_check_type_name","active"].forEach(k=>{
      const el = document.getElementById(`sort-${k}`);
      if(!el) return;
      if(k === col){ el.textContent = ascending ? "▲" : "▼"; }
      else { el.textContent = ""; }
    });

    tb.innerHTML = data.map(r => `<tr data-id="${r.id}">
      <td>${esc(r.item_id)}</td>
      <td>${esc(r.item_name)}</td>
      <td>${esc((r.room_name ?? r.room) || "—")}</td>
      <td>${esc((r.default_check_type_name ?? r.default_check_type) || "—")}</td>
      <td>${r.active ? "Yes" : "No"}</td>
    </tr>`).join("");
  }
async function loadRooms(){
  const tb = document.getElementById("rooms-tbody");
  const { data, error } = await supabase.from("rooms").select("id,name,occupied_by").eq("site_id", ctx.site_id).order("name");
  if(error){ tb.innerHTML = `<tr><td colspan="2" class="muted">${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = `<tr><td colspan="2" class="muted">No rooms yet.</td></tr>`; return; }
  const ownerIds = [...new Set((data||[]).map(r=>r.occupied_by).filter(Boolean))];
  let owners = {};
  if(ownerIds.length){
    const { data: staff } = await supabase.from("kiosk_users").select("id,full_name").in("id", ownerIds);
    (staff||[]).forEach(s => { owners[s.id] = s.full_name; });
  }
  tb.innerHTML = data.map(r=>`<tr data-id="${r.id}"><td>${esc(r.name)}</td><td>${esc(owners[r.occupied_by] || "—")}</td></tr>`).join("");
}
async function loadComplaints(){
  const tb = document.getElementById("complaints-tbody");
  try{ debugLog && debugLog('loadComplaints() start', { site_id: ctx.site_id }); }catch(e){}

  try{
    const res = await supabase
      .from("complaints")
      .select("id, datetime, patient_initials, category, original_complaint, response, lessons_learned, status, priority, share_with_team, created_by, resolved_at")
      .eq("site_id", ctx.site_id)
      .order("datetime", { ascending: false })
      .limit(1000);

    const { data, error } = res;
    if(error){
      debugLog && debugLog('loadComplaints() supabase error', error);
      tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">${escapeHtml(error.message || 'Error')}</td></tr>`; 
      return;
    }

    if(!data || data.length === 0){
      debugLog && debugLog('No complaints for site_id, attempting fallback');
      try{
        const fb = await supabase.from('complaints')
          .select('id, datetime, patient_initials, category, original_complaint, response, lessons_learned, status, priority, share_with_team, created_by, resolved_at')
          .in('site_id', [1,2])
          .order('datetime', { ascending: false })
          .limit(500);

        if(fb && !fb.error && fb.data && fb.data.length){
          debugLog && debugLog('Fallback returned rows', { count: fb.data.length });
          renderComplaintsTable(tb, fb.data);
          return;
        } else {
          debugLog && debugLog('Fallback found no rows', { error: fb.error });
          tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">No complaints yet.</td></tr>`;
          return;
        }
      }catch(fbErr){
        console.error('Fallback query error', fbErr);
        tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">No complaints yet.</td></tr>`;
        return;
      }
    }

    renderComplaintsTable(tb, data);
    return;
  }catch(err){
    console.error('loadComplaints failed', err);
    tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">Error loading complaints</td></tr>`;
    return;
  }
}

function renderComplaintsTable(tb, data){
  const creatorIds = [...new Set((data||[]).map(r=>r.created_by).filter(Boolean))];
  let creators = {};
  (async function(){
    if(creatorIds.length){
      try{
        const { data: staff } = await supabase.from('kiosk_users').select('id,full_name').in('id', creatorIds);
        (staff||[]).forEach(s=>{ creators[s.id] = s.full_name; });
      }catch(e){ /* ignore */ }
    }
    const fmtDate = (d) => d ? new Date(d).toLocaleString() : "—";
    const truncate = (t,n=120) => t ? (t.length>n ? esc(t.slice(0,n))+'…' : esc(t)) : '';
    const rows = data.map(r => `\n    <tr data-id="${r.id}">\n      <td>${fmtDate(r.datetime)}</td>\n      <td>${esc(r.patient_initials)}</td>\n      <td>${esc(r.category)}</td>\n      <td title="${esc(r.original_complaint || '')}">${truncate(r.original_complaint, 80)}</td>\n      <td title="${esc(r.response || '')}">${truncate(r.response, 80)}</td>\n      <td title="${esc(r.lessons_learned || '')}">${truncate(r.lessons_learned, 80)}</td>\n      <td>${esc(r.status || '')}</td>\n      <td>${r.share_with_team ? 'Yes' : 'No'}</td>\n      <td>${esc(creators[r.created_by] || (r.created_by ? r.created_by : '—'))}</td>\n      <td>${fmtDate(r.resolved_at)}</td>\n    </tr>\n  `).join("");
    tb.innerHTML = rows;
  })();
}

async function loadCheckTypes(){
  const tb = document.getElementById("ct-tbody");
  const { data, error } = await supabase.from("check_types").select("id, name, active").eq("site_id", ctx.site_id).order("name");
  if(error){ tb.innerHTML = `<tr><td colspan="2" class="muted">${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = `<tr><td colspan="2" class="muted">No check types yet.</td></tr>`; return; }
  tb.innerHTML = data.map(r => `<tr data-id="${r.id}"><td>${esc(r.name)}</td><td>${r.active ? "Yes" : "No"}</td></tr>`).join("");
}
async function loadSchedules(){
  const tb = document.getElementById("sched-tbody");
  const { data: scheds, error } = await supabase
    .from("item_allowed_types")
    .select("id,item_id,check_type_id,frequency,required,scheduled_day")
    .eq("site_id", ctx.site_id)
    .order("id", { ascending: true });
  if(error){ tb.innerHTML = `<tr><td colspan="6" class="muted">${error.message}</td></tr>`; return; }
  if(!scheds?.length){ tb.innerHTML = `<tr><td colspan="6" class="muted">No schedules yet.</td></tr>`; return; }

  const itemIds = [...new Set(scheds.map(s=>s.item_id).filter(Boolean))];
  const ctIds   = [...new Set(scheds.map(s=>s.check_type_id).filter(Boolean))];

  const [itemsRes, ctsRes] = await Promise.all([
    itemIds.length ? supabase.from("items").select("id,item_name,room_id").in("id", itemIds) : Promise.resolve({ data: [] }),
    ctIds.length   ? supabase.from("check_types").select("id,name").in("id", ctIds)   : Promise.resolve({ data: [] }),
  ]);

  const itemsById = {};
  const itemRoomIdByItemId = {};
  (itemsRes.data||[]).forEach(r=> { itemsById[r.id] = r.item_name; itemRoomIdByItemId[r.id] = r.room_id; });

  // Fetch room names for referenced room_ids
  const roomIds = [...new Set(Object.values(itemRoomIdByItemId).filter(Boolean))];
  let roomsById = {};
  if (roomIds.length){
    const { data: rooms } = await supabase.from("rooms").select("id,name").in("id", roomIds);
    (rooms||[]).forEach(r=> { roomsById[r.id] = r.name; });
  }

  const ctsById   = {}; (ctsRes.data||[]).forEach(r=> ctsById[r.id]   = r.name);

  tb.innerHTML = scheds.map(s=>`
    <tr data-id="${s.id}">
      <td>${esc(itemsById[s.item_id] || '—')}</td>
      <td>${esc(roomsById[itemRoomIdByItemId[s.item_id]] || '—')}</td>
      <td>${esc(ctsById[s.check_type_id] || '—')}</td>
      <td>${esc(intervalToText(s.frequency))}</td>
      <td>${esc(s.scheduled_day || "—")}</td>
      <td>${s.required ? 'Yes' : 'No'}</td>
    </tr>`).join("");
}

  async function loadStaff(){
    const tb = document.getElementById("staff-tbody");
    // Get staff with their manager's name
    const { data, error } = await supabase
      .from("kiosk_users")
      .select(`
        id, 
        full_name, 
        role, 
        active,
        reports_to:reports_to_id(full_name)
      `)
      .eq("site_id", ctx.site_id)
      .order("full_name");

    if(error){ tb.innerHTML = `<tr><td colspan="4" class="muted">${error.message}</td></tr>`; return; }
    if(!data?.length){ tb.innerHTML = `<tr><td colspan="4" class="muted">No staff yet.</td></tr>`; return; }
    
    tb.innerHTML = data.map(r=>`<tr data-id="${r.id}">
      <td>${esc(r.full_name)}</td>
      <td>${esc(r.role)}</td>
      <td>${esc(r.reports_to?.full_name || '—')}</td>
      <td>${r.active ? "Yes" : "No"}</td>
    </tr>`).join("");
  }

  async function loadSubmissions(){
    const tb = document.getElementById("subs-tbody");
    const { data, error } = await supabase.from("submissions")
      .select("id, submitted_at, staff_name, comment").eq("site_id", ctx.site_id).order("submitted_at", { ascending:false }).limit(25);
    if(error){ tb.innerHTML = `<tr><td colspan="4" class="muted">${error.message}</td></tr>`; return; }
    if(!data?.length){ tb.innerHTML = `<tr><td colspan="4" class="muted">No submissions yet.</td></tr>`; return; }
    // counts:
    const ids = data.map(d=>d.id);
    const { data: rows } = await supabase.from("submission_rows").select("submission_id", { count:"exact" }).in("submission_id", ids);
    const counts = {};
    rows?.forEach(r => { counts[r.submission_id] = (counts[r.submission_id]||0)+1; });
    tb.innerHTML = data.map(r=>`<tr data-id="${r.id}">
      <td>${fmtDate(r.submitted_at)}</td><td>${esc(r.staff_name||"—")}</td>
      <td>${counts[r.id] ?? 0}</td><td>${esc(r.comment||"")}</td>
    </tr>`).join("");
  }
  function startOfWeek(d){
    const x = new Date(d);
    const day = x.getDay(); // 0=Sun
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day);
    return x;
  }
  // Day helpers (support 3-letter codes saved to DB)
  const DAY_CODES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const DAY_FULL  = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  function dayToIndex(s){
    if(!s) return -1;
    const key = String(s).slice(0,3);
    return DAY_CODES.indexOf(key);
  }
  function indexToCode(i){ return DAY_CODES[i] || ''; }
  function indexToFull(i){ return DAY_FULL[i] || ''; }

  async function loadWeekCalendar(){
    if(!ctx.site_id) return;
    const now = new Date();
    const wkStart = startOfWeek(now);
    const wkEnd = new Date(wkStart); wkEnd.setDate(wkStart.getDate() + 7);

    const fmt = (d)=> d.toLocaleDateString(undefined,{ weekday:'short', day: 'numeric', month: 'short' });
    for(let i=0;i<7;i++){
      const dd = new Date(wkStart); dd.setDate(wkStart.getDate() + i);
      const el = document.getElementById(`d${i}-label`);
      if(el) el.textContent = fmt(dd);
    }
    
    // Fetch all required schedules and filter them by day
    const { data: scheds } = await supabase.from("item_allowed_types").select("id,required,scheduled_day").eq("site_id", ctx.site_id).eq("required", true);

    const requiredCountsPerDay = Array(7).fill(0);
    (scheds || []).forEach(s => {
      if(s.scheduled_day) {
        const dayIndex = dayToIndex(s.scheduled_day);
        if(dayIndex !== -1) {
          requiredCountsPerDay[dayIndex]++;
        }
      }
    });

    // Submissions in the week
    const { data: subs, error } = await supabase
      .from("submissions")
      .select("id, submitted_at")
      .eq("site_id", ctx.site_id)
      .gte("submitted_at", wkStart.toISOString())
      .lt("submitted_at", wkEnd.toISOString());

    if(error){ /* handle error silently for now */ return; }

    const ids = (subs||[]).map(s=>s.id);
    let rows = [];
    if(ids.length){
      const { data: sr } = await supabase
        .from("submission_rows")
        .select("submission_id")
        .in("submission_id", ids);
      rows = sr || [];
    }

    const countsBySubmission = {};
    rows.forEach(r => { countsBySubmission[r.submission_id] = (countsBySubmission[r.submission_id]||0)+1; });

    const donePerDay = Array(7).fill(0);
    (subs||[]).forEach(s=>{
      const when = new Date(s.submitted_at);
      const idx = Math.floor((when - wkStart)/86400000);
      if(idx>=0 && idx<7){
        donePerDay[idx] += (countsBySubmission[s.id] || 0);
      }
    });

    for(let i=0;i<7;i++){
      const dayDate = new Date(wkStart); dayDate.setDate(wkStart.getDate() + i);
      const isPast = dayDate < new Date(new Date().setHours(0,0,0,0));
      
      const requiredCountForDay = requiredCountsPerDay[i];
      const done = donePerDay[i] || 0;
      const missed = isPast ? Math.max(requiredCountForDay - done, 0) : 0;
      
      const totalScheduled = isPast ? requiredCountForDay : requiredCountForDay; // Required is always the same for a day, past or future.
      
      // Get elements
      const doneValEl = document.getElementById(`d${i}-done-val`);
      const reqValEl = document.getElementById(`d${i}-req-val`);
      const barEl = document.getElementById(`d${i}-bar`);
      const doneTextEl = document.getElementById(`d${i}-done`);
      const missedTextEl = document.getElementById(`d${i}-missed`);
      const reqTextEl = document.getElementById(`d${i}-req`);

      if(doneValEl) doneValEl.textContent = done;
      if(reqValEl) reqValEl.textContent = totalScheduled;
      if(doneTextEl) doneTextEl.textContent = done;
      if(missedTextEl) missedTextEl.textContent = missed;
      if(reqTextEl) reqTextEl.textContent = totalScheduled;

      if(barEl) {
        let percentage = 0;
        if (totalScheduled > 0) {
          percentage = (done / totalScheduled) * 100;
        }
        barEl.style.width = `${Math.min(percentage, 100)}%`;
        barEl.classList.toggle('danger', isPast && missed > 0);
      }
    }
  }

  // --- MONTHLY CALENDAR ---
  async function cacheRequiredSchedules() {
    if (!ctx.site_id) return;
    console.log("DEBUG: cacheRequiredSchedules() called for site_id:", ctx.site_id);
    const { data, error } = await supabase
      .from("item_allowed_types")
      .select(`
        id,
        scheduled_day,
        frequency,
        items (id, item_name),
        check_types (id, name)
      `)
      .eq("site_id", ctx.site_id)
      .eq("required", true)
  // NOTE: do NOT filter out null scheduled_day here — some schedules are interval-based
  // (e.g. daily / every N days / monthly by interval) and rely on frequency alone.
  ;
    if (error) { console.error("Failed to cache schedules:", error); return; }
    requiredSchedulesCache = data || [];
    console.log("DEBUG: Cached", requiredSchedulesCache.length, "required schedules:", requiredSchedulesCache);
  }

  async function loadAndRenderCalendar() {
    if (!ctx.site_id) return;
    
    // Ensure schedules are cached before rendering
    await cacheRequiredSchedules();
    console.log("DEBUG: loadAndRenderCalendar() - requiredSchedulesCache has", requiredSchedulesCache.length, "items");
    
    // Hide all views initially
    document.getElementById('cal-grid').style.display = 'none';
    document.getElementById('cal-weekdays').style.display = 'none';
    document.getElementById('cal-compliance-view').style.display = 'none';

    // Route to the correct rendering function based on the active tab
    switch (currentCalendarView) {
        case 'daily':
            renderComplianceView('daily');
            break;
        case 'weekly':
            renderComplianceView('weekly');
            break;
        case 'monthly':
            renderComplianceView('monthly');
            break;
        case 'scheduled':
        default:
            // This is the original logic for the grid view
            document.getElementById('cal-weekdays').style.display = 'grid';
            document.getElementById('cal-grid').style.display = 'grid';
            const calGrid = document.getElementById("cal-grid");
            calGrid.innerHTML = `<div style="grid-column: span 7; text-align:center; padding: 40px;" class="muted">Loading calendar...</div>`;

            calendarDate.setDate(1); // Go to the 1st of the month
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            document.getElementById('cal-month-year').textContent = calendarDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
            
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);
            monthEnd.setHours(23,59,59,999);

            const { data: completed, error: compErr } = await supabase
              .from('submission_rows')
              .select(`item_pk, check_type_id, submissions!inner ( submitted_at )`)
              .gte('submissions.submitted_at', monthStart.toISOString())
              .lte('submissions.submitted_at', monthEnd.toISOString())
              .eq('site_id', ctx.site_id);

            if(compErr) { calGrid.innerHTML = `<div class="muted">${compErr.message}</div>`; return; }

            const dailyData = new Map();
            (completed || []).forEach(c => {
                const dayKey = new Date(c.submissions.submitted_at).toISOString().slice(0, 10);
                if (!dailyData.has(dayKey)) {
                    dailyData.set(dayKey, new Set());
                }
                dailyData.get(dayKey).add(`${c.item_pk}-${c.check_type_id}`);
            });
            renderCalendar(dailyData);
            break;
    }
  }

  async function renderComplianceView(period) {
    document.getElementById('cal-weekdays').style.display = 'none';
    document.getElementById('cal-grid').style.display = 'none';
    const complianceContainer = document.getElementById('cal-compliance-view');
    complianceContainer.style.display = 'block';
    complianceContainer.innerHTML = `<div class="muted" style="text-align:center; padding: 40px;">Loading ${period} compliance...</div>`;

    const now = new Date();
    now.setHours(23, 59, 59, 999); // End of today

    let startDate = new Date(calendarDate);
    let endDate = new Date(calendarDate);

    // Define date range based on the selected period
    if (period === 'daily') {
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
    } else if (period === 'weekly') {
        const dayOfWeek = startDate.getDay(); // Sunday - 0, Monday - 1
        startDate.setDate(startDate.getDate() - dayOfWeek);
        startDate.setHours(0, 0, 0, 0);
        endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);
        endDate.setHours(23, 59, 59, 999);
    } else { // monthly
        startDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 1);
        endDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 0);
        endDate.setHours(23, 59, 59, 999);
    }
    
    // Update header to show the current period
    const titleFormat = { month: 'long', year: 'numeric' };
    if (period === 'daily') titleFormat.day = 'numeric';
    document.getElementById('cal-month-year').textContent = startDate.toLocaleDateString(undefined, titleFormat);


    const { data, error } = await supabase
      .from('v_item_check_status')
      .select('item_name, room_name, check_type, next_due_at, last_done_at')
      .eq('site_id', ctx.site_id)
      .eq('required', true)
      .gte('next_due_at', startDate.toISOString())
      .lte('next_due_at', endDate.toISOString())
      .order('next_due_at', { ascending: true });

    if (error) {
        complianceContainer.innerHTML = `<div class="error">${error.message}</div>`;
        return;
    }

    if (!data || data.length === 0) {
        complianceContainer.innerHTML = `<div class="muted" style="text-align:center; padding: 40px;">No checks were due in this period.</div>`;
        return;
    }

    let html = `<div class="table-wrap" style="max-height: 65vh;"><table>
        <thead><tr><th>Due Date</th><th>Item</th><th>Check</th><th>Room</th><th>Status</th></tr></thead>
        <tbody>`;

    data.forEach(item => {
        const dueDate = new Date(item.next_due_at);
        const lastDone = item.last_done_at ? new Date(item.last_done_at) : null;
        
        let statusChip = '<span class="chip">Pending</span>';
        if (dueDate < now) {
            statusChip = '<span class="chip danger">Missed</span>';
        }

        html += `<tr>
            <td>${dueDate.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric', month: 'short' })}</td>
            <td>${esc(item.item_name)}</td>
            <td>${esc(item.check_type)}</td>
            <td>${esc(item.room_name || '—')}</td>
            <td>${statusChip}</td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
    complianceContainer.innerHTML = html;
  }
  
  function renderCalendar(dailyData) {
    const grid = document.getElementById('cal-grid');
    const today = new Date();
    const todayKey = today.toISOString().slice(0, 10);
    today.setHours(0,0,0,0);
    
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); // 0=Sun, 1=Mon...

    let html = '';

    // Pad start of month
    for (let i = 0; i < startDayOfWeek; i++) {
        html += `<div class="cal-cell other-month"></div>`;
    }

    // Fill days of month
    for (let day = 1; day <= daysInMonth; day++) {
        const thisDate = new Date(year, month, day);
        const dayKey = thisDate.toISOString().slice(0, 10);
        const isToday = (dayKey === todayKey);
        const isPast = thisDate < today;
        const currentDayCode = indexToCode(thisDate.getDay());

        const completedTasks = dailyData.get(dayKey) || new Set();
        
        let dayTasksHtml = '';
        const tasksForThisDay = requiredSchedulesCache.filter(task => {
          // Require scheduled_day to match the current weekday code; if absent, this task
          // doesn't render on the grid (these are interval-based schedules handled elsewhere).
          if (!task.scheduled_day) return false;
          if (task.scheduled_day !== currentDayCode) return false;
          const freq = String(task.frequency || '').toLowerCase();

          // Monthly: show only on the last <weekday> of the month
          if (freq.includes('mon')) {
            const nextWeek = new Date(thisDate);
            nextWeek.setDate(thisDate.getDate() + 7);
            return nextWeek.getMonth() !== thisDate.getMonth();
          }

          // Daily or Weekly: show every week on the selected day
          if (freq.includes('day') || freq.includes('week')) {
            return true;
          }

          // Otherwise: do not show on the grid
          return false;
        });
        
        console.log(`DEBUG: Day ${day} (${currentDayCode}) - found ${tasksForThisDay.length} tasks from ${requiredSchedulesCache.length} total schedules`);

        tasksForThisDay.forEach(task => {
          const taskKey = `${task.items.id}-${task.check_types.id}`;
          const isDone = completedTasks.has(taskKey);
          let statusClass = 'scheduled';
          if (isDone) {
            statusClass = 'done';
          } else if (isPast) {
            statusClass = 'missed';
          }

          // Status character shown inside the coloured dot
          let statusChar = 'S';
          if (isDone) statusChar = '✓';
          else if (isPast) statusChar = '✗';

          const taskName = `${task.items.item_name} / ${task.check_types.name}`;
          const freq = String(task.frequency || '').toLowerCase();
          let freqBadge = '';
          if (freq.includes('day')) {
            freqBadge = `<span class="freq-badge" title="Daily">D</span>`;
          } else if (freq.includes('week')) {
            freqBadge = `<span class="freq-badge" title="Weekly">W</span>`;
          } else if (freq.includes('mon') || freq.includes('month')) {
            freqBadge = `<span class="freq-badge" title="Monthly">M</span>`;
          }

          dayTasksHtml += `<div class="cal-task"
              data-item-id="${task.items.id}"
              data-ct-id="${task.check_types.id}"
              data-date="${dayKey}"
              title="${esc(taskName)}">
              <div class="cal-task-status ${statusClass}">${statusChar}</div>
              <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-left:6px;">${esc(taskName)}</span>
              ${freqBadge}
            </div>`;
        });

        if (tasksForThisDay.length === 0) {
          dayTasksHtml += `<div class="muted" style="font-size:10px; text-align:center; padding-top:10px;">No required checks</div>`;
        }
        
        html += `<div class="cal-cell is-clickable" data-date="${dayKey}">
            <div class="cal-day-num ${isToday ? 'is-today' : ''}">${day}</div>
            <div class="cal-tasks">${dayTasksHtml}</div>
            </div>`;
    }

    // Pad end of month
    const totalCells = startDayOfWeek + daysInMonth;
    const remaining = (7 - (totalCells % 7)) % 7;
    for (let i = 0; i < remaining; i++) {
        html += `<div class="cal-cell other-month"></div>`;
    }

    grid.innerHTML = html;
  }

  // Day modal: show details when user clicks a calendar cell
  async function showDayModal(dateKey) {
    const modal = document.getElementById('day-modal');
    if(!modal) return;
    const titleEl = modal.querySelector('.day-modal-title');
    const bodyEl = modal.querySelector('.day-modal-body');
    titleEl.textContent = `Details for ${new Date(dateKey).toLocaleDateString(undefined, { weekday: 'long', day:'numeric', month:'long', year:'numeric' })}`;
    bodyEl.innerHTML = `<div class="muted">Loading…</div>`;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');

    const thisDate = new Date(dateKey);
    const start = new Date(thisDate); start.setHours(0,0,0,0);
    const end = new Date(thisDate); end.setHours(23,59,59,999);

    // Fetch any submission rows on that exact date, including item and check names when available
    const { data: rows, error: rowsErr } = await supabase
      .from('submission_rows')
      .select('item_pk, check_type_id, items(id,item_name), check_types(id,name), submissions!inner(submitted_at, staff_name)')
      .gte('submissions.submitted_at', start.toISOString())
      .lte('submissions.submitted_at', end.toISOString())
      .eq('site_id', ctx.site_id);

    const completedMap = {}; // key -> { staff, time, item_name, check_name }
    if(!rowsErr && rows && rows.length){
      rows.forEach(r => {
        const k = `${r.item_pk}-${r.check_type_id}`;
        completedMap[k] = {
          staff: r.submissions?.staff_name || '—',
          time: r.submissions?.submitted_at || null,
          item_name: r.items?.item_name || null,
          check_name: r.check_types?.name || null
        };
      });
    }

    // Determine scheduled tasks for this date (reuse same rules as calendar render)
    const currentDayCode = indexToCode(thisDate.getDay());
    const currentDayOfMonth = thisDate.getDate();
    const tasksForThisDay = requiredSchedulesCache.filter(task => {
      if (!task.scheduled_day) return false;
      if (task.scheduled_day !== currentDayCode) return false;
      const freq = String(task.frequency || '').toLowerCase();
      if (freq.includes('mon')) {
        const nextWeek = new Date(thisDate);
        nextWeek.setDate(thisDate.getDate() + 7);
        return nextWeek.getMonth() !== thisDate.getMonth();
      }
      if (freq.includes('day') || freq.includes('week')) return true;
      return false;
    });

    // Combine scheduled + completed keys so we show any recorded checks even if not scheduled
    const keys = new Set();
    tasksForThisDay.forEach(t => keys.add(`${t.items.id}-${t.check_types.id}`));
    Object.keys(completedMap).forEach(k => keys.add(k));

    if (keys.size === 0) {
      bodyEl.innerHTML = `<div class="muted">No checks recorded or scheduled for this day.</div>`;
      return;
    }

    let tableHtml = `<div class="table-wrap"><table class="day-modal-table"><thead><tr><th>Check</th><th>Status</th><th>By</th><th>Time</th></tr></thead><tbody>`;
    for (const k of keys) {
      const [itemIdStr, ctIdStr] = k.split('-');
      const itemId = Number(itemIdStr);
      const ctId = Number(ctIdStr);
      const scheduled = tasksForThisDay.find(t => Number(t.items.id) === itemId && Number(t.check_types.id) === ctId);
      const completed = completedMap[k];

      const itemName = scheduled ? scheduled.items.item_name : (completed && completed.item_name) || '—';
      const checkName = scheduled ? scheduled.check_types.name : (completed && completed.check_name) || '—';

      let statusHtml = '<span class="chip">Scheduled</span>';
      let by = '—';
      let timeText = '—';

      if (completed) {
        statusHtml = '<span class="chip success">Done</span>';
        by = esc(completed.staff || '—');
        timeText = completed.time ? new Date(completed.time).toLocaleTimeString() : '—';
      } else if (isPast) {
        // If scheduled but in the past -> mark missed
        const todayStart = new Date(); todayStart.setHours(0,0,0,0);
        if (thisDate < todayStart) {
          statusHtml = '<span class="chip danger">Missed</span>';
        }
      }

      tableHtml += `<tr>
        <td>${esc(itemName)} / ${esc(checkName)}</td>
        <td>${statusHtml}</td>
        <td>${by}</td>
        <td>${timeText}</td>
      </tr>`;
    }
    tableHtml += `</tbody></table></div>`;
    bodyEl.innerHTML = tableHtml;
  }

  async function showTaskModal(dateKey, itemId, ctId){
    const modal   = document.getElementById('day-modal');
    if(!modal) return;
    const titleEl = modal.querySelector('.day-modal-title');
    const bodyEl  = modal.querySelector('.day-modal-body');
    titleEl.textContent = 'Details';
    bodyEl.innerHTML = '<div class="muted">Loading…</div>';
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');

    const thisDate = new Date(dateKey);
    const start = new Date(thisDate); start.setHours(0,0,0,0);
    const end   = new Date(thisDate); end.setHours(23,59,59,999);

    // Completed row (if any) on that date
    const { data: rows } = await supabase
      .from('submission_rows')
      .select('submissions!inner(staff_name,submitted_at), items(item_name), check_types(name)')
      .eq('site_id', ctx.site_id)
      .eq('item_pk', itemId)
      .eq('check_type_id', ctId)
      .gte('submissions.submitted_at', start.toISOString())
      .lte('submissions.submitted_at', end.toISOString());

    const done = rows?.[0] ?? null;
    const itemName  = done?.items?.item_name  ?? (await supabase.from('items').select('item_name').eq('id', itemId).maybeSingle()).data?.item_name ?? '—';
    const checkName = done?.check_types?.name ?? (await supabase.from('check_types').select('name').eq('id', ctId).maybeSingle()).data?.name ?? '—';

    const now = new Date();
    const isPast = thisDate < new Date(now.setHours(0,0,0,0));

    let statusChip = '<span class="chip">Scheduled</span>';
    let who = '—', whenTime = '—';
    if(done){
      statusChip = '<span class="chip success">Done</span>';
      who  = esc(done.submissions?.staff_name || '—');
      whenTime = done.submissions?.submitted_at ? new Date(done.submissions.submitted_at).toLocaleTimeString() : '—';
    }else if(isPast){
      statusChip = '<span class="chip danger">Missed</span>';
    }

    bodyEl.innerHTML = `
      <table class="day-modal-table"><tbody>
        <tr><th>Item</th>  <td>${esc(itemName)}</td></tr>
        <tr><th>Check</th> <td>${esc(checkName)}</td></tr>
        <tr><th>Status</th><td>${statusChip}</td></tr>
        <tr><th>Who</th>   <td>${who}</td></tr>
        <tr><th>When</th>  <td>${whenTime}</td></tr>
      </tbody></table>`;
  }

  function hideDayModal(){
    const modal = document.getElementById('day-modal');
    if(!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    // Suppress any click that might "fall through" after closing
    suppressGridClickUntil = Date.now() + 300; // 300ms debounce
  }

  // Dedicated close‑button handler (defensive – runs only once)
  (() => {
    const btn = document.getElementById('day-modal-close');
    if(btn && !btn.dataset.bound){
      btn.dataset.bound = "1";
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        hideDayModal();
      }, { once:false });
    }
  })();

  // Click handler on calendar grid to show task modal or day modal
  document.getElementById('cal-grid').addEventListener('click', async (e) => {
    // Ignore ghost clicks right after closing a modal
    if (Date.now() < suppressGridClickUntil) {
      e.stopPropagation();
      e.preventDefault();
      return;
    }
    // 1️⃣ task clicked?
    const taskEl = e.target.closest('.cal-task');
    if(taskEl){
      e.stopPropagation();          // ← new, prevents underlying handlers
      const dateKey = taskEl.getAttribute('data-date');
      const itemId  = taskEl.getAttribute('data-item-id');
      const ctId    = taskEl.getAttribute('data-ct-id');
      if(dateKey && itemId && ctId){
        await showTaskModal(dateKey, itemId, ctId);
        return;
      }
    }
    // 2️⃣ fallback: whole‑day cell
    const cell = e.target.closest('.cal-cell.is-clickable');
    if(!cell) return;
    const dateKeyCell = cell.getAttribute('data-date');
    if(!dateKeyCell) return;
    await showDayModal(dateKeyCell);
  });

  // Close modal when clicking the X or outside the card
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('day-modal');
    if(!modal || !modal.classList.contains('show')) return;
    if (e.target.id === 'day-modal-close') {
      e.stopPropagation();
      e.preventDefault();
      hideDayModal();
      return;
    }
    if (e.target === modal) {
      e.stopPropagation();
      e.preventDefault();
      hideDayModal();
    }
  });

  // --- ROLES MANAGEMENT ---
  async function loadRoles() {
    const tbody = document.getElementById('roles-tbody');
    if (!tbody) return;
    // Roles are now fixed to Admin and Staff. Render static list.
    const fixed = [{role:'admin'},{role:'staff'}];
    tbody.innerHTML = fixed.map(r => 
      '<tr data-role="' + esc(r.role) + '">' +
        '<td>' + esc(r.role) + '</td>' +
        '<td>—</td>' +
      '</tr>'
    ).join('');
  }

  function initRolesManagement() {
    const btnManageRoles = document.getElementById('btn-manage-roles');
    const rolesModal = document.getElementById('roles-modal');
    const addRoleForm = document.getElementById('add-role-form');
    const closeBtn = rolesModal?.querySelector('.modal-close');

  // Role management UI removed; do not bind manage roles button.

    // Close on clicking outside
    if (rolesModal) {
      rolesModal.addEventListener('click', (e) => {
        if (e.target === rolesModal) {
          rolesModal.classList.remove('show');
        }
      });
    }

    // Close on clicking X button
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        rolesModal?.classList.remove('show');
      });
    }

    if (addRoleForm) {
      addRoleForm.addEventListener('submit', (e) => {
        e.preventDefault();
        // Disabled: roles are fixed to Admin and Staff. Use Manage Roles removed.
        alert('Role management is disabled. Roles are fixed to Admin and Staff.');
      });
    }
  }

  // Helpers
  function esc(s){ return (s ?? "").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function fmtDate(iso){
    if(!iso) return "—";
    const d = new Date(iso);
    return d.toLocaleString();
  }
  // small validator for UUID-like strings
  function isUUID(v){ if(!v) return false; try{ return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(String(v)); }catch(e){return false;} }
    function fmtDateShort(iso) {
      if (!iso) return "—";
      try {
        // Add a time component to avoid timezone-related date shifts for display
        return new Date(iso + 'T12:00:00Z').toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (e) {
        return "—";
      }
    }
  function intervalToText(i){
    if(!i) return "—";
    if (typeof i !== 'string') return JSON.stringify(i);
    const parts = [];
    if (i.includes('year')) parts.push(i.match(/(\d+)\s*year/)[1] + ' years');
    if (i.includes('mon')) parts.push(i.match(/(\d+)\s*mon/)[1] + ' months');
    if (i.includes('day')) parts.push(i.match(/(\d+)\s*day/)[1] + ' days');
    return parts.join(', ') || i;
  }
  
  // --- PRE-INSPECTION (PIR) LOGIC ---
    
    const PIR_DEFINITIONS = window.PIR_DEFINITIONS_DATA;

    async function seedInitialPIRDocs() {
        if (!ctx.site_id) return;
        const { count, error } = await supabase.from('pir_documents').select('*', { count: 'exact', head: true }).eq('site_id', ctx.site_id);
        if (error || count > 0) return;

        const docsToInsert = PIR_DEFINITIONS.map(def => {
            const isDataOnly = !def.item_type.includes('file');
            return {
                site_id: ctx.site_id,
                category: def.category,
                title: def.title,
                item_type: def.item_type,
                status: isDataOnly ? 'Not Started' : 'Not Attached',
                data: {}
            };
        });
        await supabase.from('pir_documents').insert(docsToInsert);
    }

    function formatItemType(itemType) {
        if (itemType.includes('file') && (itemType.includes('text') || itemType.includes('questions'))) return 'Text & File';
        if (itemType.includes('file')) return 'File Attachment';
        if (itemType.includes('text') || itemType.includes('questions')) return 'Text / Q&A';
        if (itemType.includes('table')) return 'Data Table';
        if (itemType.includes('number')) return 'Data';
        return 'Information';
    }

    async function loadAndRenderPIR() {
        const container = document.getElementById('pir-docs-container');
        container.innerHTML = `<div class="muted" style="text-align: center; padding: 20px;">Loading CQC document list...</div>`;
        if (!ctx.site_id) return;

        const { data, error } = await supabase.from('pir_documents').select('*').eq('site_id', ctx.site_id).order('id', { ascending: true });
        if (error) { container.innerHTML = `<div class="error">${error.message}</div>`; return; }
        pirDocsCache = data || [];

        const groupedByCat = pirDocsCache.reduce((acc, doc) => {
            (acc[doc.category] = acc[doc.category] || []).push(doc);
            return acc;
        }, {});
        
        const categoryOrder = [...new Set(PIR_DEFINITIONS.map(d => d.category))];

        let html = '';
        for (const category of categoryOrder) {
             if (groupedByCat[category]) {
                html += `<div class="doc-category">
                    <div class="doc-category-title">${esc(category)}</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50%;">Document / Information Required</th>
                                <th>Evidence Type</th>
                                <th>Status</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody id="pir-tbody" data-entity="pir_documents">`;
                
                groupedByCat[category].forEach(doc => {
                    let status = doc.status;
                    if (status === 'Not Attached' && !doc.item_type.includes('file')) {
                        status = 'Not Started';
                    }

                    let statusChip = 'chip';
                    if (status === 'Ready') statusChip += ' success';
                    else if (status === 'Needs Review') statusChip += ' warning';
                    else if (status === 'Not Attached' || status === 'Not Started') statusChip += ' danger';

                    html += `<tr data-id="${doc.id}">
                        <td>${esc(doc.title)}</td>
                        <td><span class="chip">${formatItemType(doc.item_type)}</span></td>
                        <td><span class="${statusChip}">${esc(status)}</span></td>
                        <td>${fmtDateShort(doc.last_updated)}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
        }
        container.innerHTML = html;
        updatePIRDashboard();
    }
    
    function updatePIRDashboard() {
        const total = pirDocsCache.length;
        const ready = pirDocsCache.filter(d => d.status === 'Ready').length;
        const percentage = total > 0 ? (ready / total) * 100 : 0;
        document.getElementById('pir-progress-bar').style.width = `${percentage}%`;
        document.getElementById('pir-progress-text').textContent = `${ready} / ${total}`;
    }


    // NOTE: The logic for the modal pop-up is now handled by the .eml generator script.
    // The old modal logic is left here but is not triggered by the main button anymore.


    // Helper function to format data from JSON into a readable text file string
    function formatDataForTxt(doc, itemDef) {
        let content = `DOCUMENT: ${doc.title}\nCATEGORY: ${doc.category}\n\n--------------------\n\n`;

        if (doc.data.answers && itemDef.questions) {
            itemDef.questions.forEach((q, index) => {
                content += `Q: ${q}\nA: ${doc.data.answers[index] || 'Not answered'}\n\n`;
            });
        } else if (doc.data.text_content) {
            content += `${doc.data.text_content}\n`;
        } else if (doc.item_type === 'dynamic_table' && doc.data.table_data) {
            content += itemDef.headers.join('\t') + '\n';
            content += '--------------------\n';
            content += doc.data.table_data.map(row => row.join('\t')).join('\n');
        } else {
            const labels = itemDef.labels || ['Value 1', 'Value 2', 'Value 3'];
             ['num1', 'num2', 'num3', 'text1', 'text2'].forEach((key, idx) => {
                if(doc.data[key] != null && doc.data[key] !== '') {
                    content += `${labels[idx] || key}: ${doc.data[key]}\n`;
                }
            });
        }
        return content;
    }

    function buildPirForm(item, data, filePath) {
        const itemDef = PIR_DEFINITIONS.find(d => d.title === item.title) || {};
        let html = '';
        const dataValues = data || {};
        
        let currentStatus = item.status;
        if (currentStatus === 'Not Attached' && !item.item_type.includes('file')) {
            currentStatus = 'Not Started';
        }

        html += `<div class="field"><label>Last Updated</label><input id="field-pir-last_updated" type="date" value="${item.last_updated || ''}" /></div>`;

        switch(item.item_type) {
            case 'textarea':
                html += `<div class="field"><label>Summary / Statement</label><textarea id="field-pir-text_content">${esc(dataValues.text_content || '')}</textarea></div>`;
                break;
            case 'textarea_and_file':
                html += `<div class="field"><label>Summary / Process Description</label><textarea id="field-pir-text_content">${esc(dataValues.text_content || '')}</textarea><div class="hint">${itemDef.description || ''}</div></div>`;
                break;
            case 'guided_questions':
            case 'guided_questions_and_file':
            case 'guided_questions_and_number':
                 if (itemDef.questions) {
                    itemDef.questions.forEach((q, index) => {
                        html += `<div class="field"><label>${esc(q)}</label><textarea data-question-index="${index}">${esc(dataValues.answers?.[index] || '')}</textarea></div>`;
                    });
                 }
                 if (item.item_type.includes('number')) {
                    html += `<div class="field"><label>${esc(itemDef.label || 'Value')}</label><input id="field-pir-num1" type="number" value="${esc(dataValues.num1 || '')}" /></div>`;
                 }
                break;
            case 'number':
                html += `<div class="field"><label>${esc(itemDef.label || 'Value')}</label><input id="field-pir-num1" type="number" value="${esc(dataValues.num1 || '')}" /></div>`;
                break;
            case 'dual_number':
            case 'triple_number':
                html += `<div class="multi-input-container">${itemDef.labels.map((label, i) => `
                    <div class="field"><label>${esc(label)}</label><input id="field-pir-num${i+1}" type="number" value="${esc(dataValues[`num${i+1}`] || '')}" /></div>
                `).join('')}</div>`;
                break;
            case 'dual_text':
                 html += `<div class="multi-input-container">${itemDef.labels.map((label, i) => `
                    <div class="field"><label>${esc(label)}</label><input id="field-pir-text${i+1}" type="text" value="${esc(dataValues[`text${i+1}`] || '')}" /></div>
                `).join('')}</div>`;
                break;
            case 'dynamic_table':
                html += `<div class="field"><label>${esc(item.title)}</label><div id="dynamic-table-container"></div><button type="button" class="btn secondary" id="btn-add-table-row" style="margin-top:8px; font-size:12px; padding: 6px 10px;">+ Add Row</button></div>`;
                break;
        }

        if (item.item_type.includes('file')) {
            const fileName = filePath ? filePath.split('/').pop() : 'No file attached';
            html += `<hr style="border:none; border-top: 1px solid var(--border-color); margin: 16px 0;">
                <div class="field">
                <label>Attached File</label>
                <div id="file-display" style="padding:10px 12px; background:#ffffff10; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span>${esc(fileName)}</span>
                    <div style="display:flex; gap:6px;">
                      ${filePath ? `<button type="button" class="btn secondary" id="btn-download-pir" style="padding: 4px 8px; font-size: 12px;">Download</button>` : ''}
                      ${filePath ? `<button type="button" class="btn secondary" id="btn-delete-pir-attachment" style="padding: 4px 8px; font-size: 12px; background: #ff6b6b33; border-color: #ff6b6b55;">Delete</button>` : ''}
                    </div>
                </div>
                <input type="file" id="field-pir-file_path" style="color: var(--muted); font-size: 12px;" />
                <div class="hint">${itemDef.description || 'Uploading a new file will replace the existing one.'}</div>
                </div>`;
        }
        return html;
    }

  // Initialize role management modal close behavior
  const rolesModal = document.getElementById('roles-modal');
  if (rolesModal) {
    rolesModal.addEventListener('click', (e) => {
      if (e.target === rolesModal || e.target.closest('.modal-close')) {
        rolesModal.classList.remove('show');
      }
    });
  }

  // Bootstrap
  async function bootstrap(){
    const { data: { session } } = await supabase.auth.getSession();
    showAuth(!session);
    if(!session) return;

    await loadContext();
    await seedInitialPIRDocs();
    await cacheRequiredSchedules();
    await Promise.all([loadCounts(), loadDue(), loadActivity(), loadItems(), loadRooms(), loadComplaints(), loadCheckTypes(), loadSchedules(), loadStaff(), loadSubmissions(), loadWeekCalendar(), loadAndRenderCalendar()]);

    // If the active section is pre-inspection, ensure its data is loaded now that context is ready.
    if (activeViewId() === 'view-pre-inspection') {
        await loadAndRenderPIR();
    }

    supabase.channel("changes")
      .on("postgres_changes", { event:"*", schema:"public", table:"items", filter:`site_id=eq.${ctx.site_id}` }, loadItems)
      .on("postgres_changes", { event:"*", schema:"public", table:"rooms", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadRooms(); await loadCounts(); })
      .on("postgres_changes", { event:"*", schema:"public", table:"complaints", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadComplaints(); await loadCounts(); })
      .on("postgres_changes", { event:"*", schema:"public", table:"check_types", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadCheckTypes(); await loadCounts(); })
      .on("postgres_changes", { event:"*", schema:"public", table:"kiosk_users", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadStaff(); await loadCounts(); })
      .on("postgres_changes", { event:"*", schema:"public", table:"submissions", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadActivity(); await loadSubmissions(); await loadWeekCalendar(); if(activeViewId() === 'view-calendar') loadAndRenderCalendar(); })
      .on("postgres_changes", { event:"*", schema:"public", table:"item_allowed_types", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadSchedules(); await cacheRequiredSchedules(); await loadWeekCalendar(); if(activeViewId() === 'view-calendar') loadAndRenderCalendar(); })
      .on("postgres_changes", { event:"*", schema:"public", table:"pir_documents", filter:`site_id=eq.${ctx.site_id}` }, async() => { if (activeViewId() === 'view-pre-inspection') { loadAndRenderPIR(); }})
      .on("postgres_changes", { event:"*", schema:"public", table:"submission_rows", filter:`site_id=eq.${ctx.site_id}` }, async(payload)=>{
        if(submissionDetailModal.classList.contains("show")){
          const openId = submissionDetailModal.dataset.submissionId;
          if(payload.new.submission_id == openId){ showSubmissionDetails(openId); }
        }
      })
      .subscribe();
  }

  // ---------- CRUD Helpers ----------
  const crudModal = document.getElementById("crud-modal");
  const crudTitle = document.getElementById("crud-title");
  const crudForm = document.getElementById("crud-form");
  const crudFields = document.getElementById("crud-fields");
  const crudError = document.getElementById("crud-error");
  const crudDeleteBtn = document.getElementById("crud-delete");
  const crudCancelBtn = document.getElementById("crud-cancel");

  let crudState = { entity:null, mode:"add", row:null, pk:null, context: {} };

  const ENTITIES = {
    rooms: { table: "rooms", label: "Room", pk: "id", fields: [{name:"name", label:"Name", type:"text", required:true}, {name:"occupied_by", label:"Owner (Staff)", type:"select", source:"kiosk_users", sourceLabel:"full_name"}] },
    check_types: { table: "check_types", label: "Check Type", pk: "id", fields: [{name:"name", label:"Name", type:"text", required:true}, {name:"active", label:"Active", type:"checkbox", default:true}] },
  kiosk_users: { table: "kiosk_users", label: "Staff", pk: "id", fields: [{name:"full_name", label:"Full Name", type:"text", required:true},
{name:"role", label:"Role", type:"select", required:true},
{name:"reports_to_id", label:"Reports To", type:"select", source:"kiosk_users", sourceLabel:"full_name", valueKey:"id"},
{name:"active", label:"Active", type:"checkbox", default:true}] },
    complaints: { table: "complaints", label: "Complaint", pk: "id", fields: [
  { name: "attachment", label: "Attach Complaint Document", type: "file-upload", fullWidth: true },
  { name: "complaint_date", label: "Complaint Date", type: "datepicker", required: true },
  { name: "patient_initials", label: "Patient Initials", type: "text", required: true, maxLength: 10 },
      { name: "age", label: "Age", type: "age-selector" },
      { name: "complaint_number", label: "Complaint Number", type: "text", readonly: true },
      { name: "response_sent", label: "Response Sent", type: "checkbox", default: false },
  { name: "complaint_summary", label: "Complaint Summary", type: "textarea", required: true, fullWidth: true },
  { name: "original_complaint", label: "Original Complaint Details", type: "textarea", fullWidth: true },
  { name: "response", label: "Response Given", type: "textarea", fullWidth: true },
  { name: "lessons_learned", label: "Lessons Learned", type: "textarea", fullWidth: true },
  { name: "category", label: "Category", type: "select", source: "complaint_categories", sourceLabel: "name", valueKey: "name", required: true },
      { name: "solution_given", label: "Solution Given", type: "textarea", fullWidth: true },
      { name: "category_trends", label: "Category for Trends Chart", type: "category-select", options: [
  {value:'MEDICATION', label:'MEDICATION', color:'#ff6b6b'},
  {value:'COMMUNICATION', label:'COMMUNICATION', color:'#4ecdc4'},
  {value:'ADMIN', label:'ADMIN', color:'#45b7d1'},
  {value:'MEDICAL', label:'MEDICAL', color:'#96ceb4'},
  {value:'APPT SYSTEM', label:'APPT SYSTEM', color:'#feca57'},
  {value:'OUTSIDE AGENCIES', label:'OUTSIDE AGENCIES', color:'#ff9ff3'},
  {value:'GDPR', label:'GDPR', color:'#54a0ff'}
      ], required: true },
      { name: "people_involved", label: "Names of People Involved", type: "staff-multi-select", source: "kiosk_users", sourceLabel: "full_name", valueKey: "id" },
      { name: "avenue_used", label: "Avenue Used to Complain", type: "avenue-select", options: [
  {value:'Phone', label:'Phone'},
  {value:'Email', label:'Email'},
  {value:'Letter', label:'Letter'},
  {value:'In Person', label:'In Person'},
  {value:'Online Form', label:'Online Form'},
  {value:'Social Media', label:'Social Media'}
      ] },
      { name: "suggestions_prevent_reoccurrence", label: "Suggestions to prevent reoccurrence", type: "textarea", fullWidth: true },
      { name: "actions_to_be_taken", label: "Actions to be taken", type: "textarea", fullWidth: true },
      { name: "status", label: "Status", type: "status-select", options: [
        {value:'pending', label:'Pending', color:'#feca57'},
        {value:'investigating', label:'Investigating', color:'#ff6b6b'},
        {value:'resolved', label:'Resolved', color:'#1dd1a1'},
        {value:'closed', label:'Closed', color:'#636e72'}
      ], default: 'pending' },
      { name: "priority", label: "Priority", type: "priority-select", options: [
        {value:'low', label:'Low', color:'#1dd1a1'},
        {value:'medium', label:'Medium', color:'#feca57'},
        {value:'high', label:'High', color:'#ff6b6b'}
      ], default: 'medium' },
      { name: "share_with_team", label: "Share with team", type: "checkbox", default: false },
      { name: "created_by", label: "Created by", type: "select", source: "kiosk_users", sourceLabel: "full_name", valueKey: "id" },
    ] },
    items: { table: "items", label: "Item", pk: "id", fields: [{name:"item_id", label:"Code", type:"text", required:true}, {name:"item_name", label:"Name", type:"text", required:true}, {name:"room_id", label:"Room", type:"select", source:"rooms", sourceLabel:"name"}, {name:"default_check_type_id", label:"Default Check Type", type:"select", source:"check_types", sourceLabel:"name"}, {name:"active", label:"Active", type:"checkbox", default:true}] },
    item_allowed_types: { table: "item_allowed_types", label: "Schedule", pk: "id", fields: [{name:"item_id", label:"Item", type:"select", source:"items", sourceLabel:"item_name", required:true}, {name:"check_type_id", label:"Check Type", type:"select", source:"check_types", sourceLabel:"name", required:true}, {name:"frequency", label:"Every", type:"frequency", onchange: function(e) {
          const freq = e.target.value.toLowerCase();
          const scheduledDaySelect = document.getElementById('field-scheduled_day');
          if (!scheduledDaySelect) return;
          
          if (freq.includes('mon')) {
            // For monthly frequency, show dates 1-31
            scheduledDaySelect.innerHTML = Array.from({length: 31}, (_, i) => 
              `<option value="${i+1}">${i+1}${['st','nd','rd'][i] || 'th'}</option>`
            ).join('');
          } else {
            // For other frequencies, show days of week
            scheduledDaySelect.innerHTML = [
              {value: 'Sun', label: 'Sunday'},
              {value: 'Mon', label: 'Monday'},
              {value: 'Tue', label: 'Tuesday'},
              {value: 'Wed', label: 'Wednesday'},
              {value: 'Thu', label: 'Thursday'},
              {value: 'Fri', label: 'Friday'},
              {value: 'Sat', label: 'Saturday'}
            ].map(day => `<option value="${day.value}">${day.label}</option>`).join('');
          }
        }, required:true}, { name: "scheduled_day", label: "On", type: "select" }, {name:"required", label:"Required", type:"checkbox", default:true}] },
    submission_rows: { table: "submission_rows", label: "Submission Row", pk: "id", fields: [{name:"check_type_id", label:"Check Type", type:"select", source:"check_types", sourceLabel:"name", required:true}, {name:"row_comment", label:"Comment", type:"textarea"}] },
    pir_documents: { table: "pir_documents", label: "Inspection Document", pk: "id" }
  };

  async function openCRUD(entityKey, mode="add", row=null, context={}){
    crudError.textContent = "";
    crudState = { entity:ENTITIES[entityKey], mode, row, pk:ENTITIES[entityKey].pk, context };
    
    // Debug user context
    console.log('OpenCRUD - User Context:', { 
      ctx_user: ctx.user, 
      ctx_site_id: ctx.site_id,
      entityKey: entityKey,
      mode: mode 
    });
    debugLog('CRUD Open', { 
      entity: entityKey, 
      mode: mode, 
      user: ctx.user?.id,
      site: ctx.site_id 
    });
    
    if (entityKey === 'pir_documents') {
        crudTitle.textContent = `Manage: ${row.title}`;
        crudFields.innerHTML = buildPirForm(row, row.data, row.file_path);
        
        const deleteAttachmentBtn = document.getElementById('btn-delete-pir-attachment');
        if (deleteAttachmentBtn && row?.file_path) {
            deleteAttachmentBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to delete this attachment? This cannot be undone.')) return;
                try {
                    crudError.textContent = 'Deleting...';
                    const { error: deleteError } = await supabase.storage.from('pir_attachments').remove([row.file_path]);
                    if (deleteError) throw deleteError;

                    const { data: updatedRow, error: updateError } = await supabase.from('pir_documents')
                        .update({ file_path: null, status: 'Not Attached', last_updated: new Date().toISOString().slice(0,10) })
                        .eq('id', row.id)
                        .select()
                        .single();
                    
                    if (updateError) throw updateError;
                    
                    // Re-render the modal with the updated state (no file)
                    crudState.row = updatedRow;
                    openCRUD('pir_documents', 'edit', updatedRow);
                    crudError.textContent = '';

                } catch (err) {
                    crudError.textContent = `Deletion failed: ${err.message}`;
                }
            });
        }

        if(row.item_type === 'dynamic_table') {
            const container = document.getElementById('dynamic-table-container');
            const addRowBtn = document.getElementById('btn-add-table-row');
            const headers = (PIR_DEFINITIONS.find(d => d.title === row.title) || {}).headers || [];
            if (!row.data) row.data = {};
            if (!row.data.table_data) row.data.table_data = [];

            const renderTable = () => {
                let tableHtml = `<table style="font-size:12px;"><thead><tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}<th></th></tr></thead><tbody>`;
                row.data.table_data.forEach((r, idx) => {
                    tableHtml += `<tr>${headers.map((h, i) => `<td><input value="${esc(r[i] || '')}" data-row="${idx}" data-col="${i}" /></td>`).join('')}
                    <td><button type="button" class="btn-remove-row" data-index="${idx}" style="all:unset; cursor:pointer; color: var(--danger);">✕</button></td></tr>`;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            };

            addRowBtn.addEventListener('click', () => {
                row.data.table_data.push(new Array(headers.length).fill(''));
                renderTable();
            });

            container.addEventListener('input', e => {
                 if(e.target.tagName === 'INPUT') {
                    row.data.table_data[e.target.dataset.row][e.target.dataset.col] = e.target.value;
                 }
            });
             container.addEventListener('click', e => {
                 if(e.target.classList.contains('btn-remove-row')) {
                    row.data.table_data.splice(parseInt(e.target.dataset.index, 10), 1);
                    renderTable();
                 }
            });
            renderTable();
        }

    } else {
        crudTitle.textContent = (mode === "add") ? `Add ${crudState.entity.label}` : context.titlePrefix || `Edit ${crudState.entity.label}`;
        // Use a mutable copy so we can tweak fields per entity
        let _fields = Array.isArray(crudState.entity.fields) ? crudState.entity.fields.map(f=>({...f})) : [];
        // Special-case: Staff role should be a dropdown sourced from kiosk_roles (text primary key)
        if (entityKey === 'kiosk_users') {
          const idx = _fields.findIndex(f => f.name === 'role');
          if (idx !== -1) {
            _fields[idx] = { name:'role', label:'Role', type:'select', source:'kiosk_roles', sourceLabel:'role', valueKey:'role', required:true };
          } else {
            _fields.push({ name:'role', label:'Role', type:'select', source:'kiosk_roles', sourceLabel:'role', valueKey:'role', required:true });
          }
        }
        crudFields.innerHTML = `<div class="crud-grid">${_fields.map(f => {

          let val = row ? row[f.name] : (f.type === "checkbox" ? !!f.default : (f.default ?? ""));
          if(val === null || val === undefined) val = (f.type === "checkbox" ? false : "");
          
          const id = `field-${f.name}`;
          const label = (f.label || f.name);
          const fieldClass = f.fullWidth ? "field full" : "field";
          
          if(f.type === "text"){
            return `<div class="${fieldClass}"><label>${esc(label)}</label><input id="${id}" type="text" value="${esc(val)}" ${f.required ? "required" : ""} ${f.readonly ? "readonly" : ""}></div>`;
          }
          
          if(f.type === "datepicker"){
            const today = new Date().toISOString().slice(0,10);
            const dateVal = val ? new Date(val).toISOString().slice(0,10) : "";
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <div class="datepicker-wrapper">
                <input id="${id}" type="date" value="${esc(dateVal)}" ${f.required ? "required" : ""} class="modern-datepicker" />
                <button type="button" class="btn secondary quick-date" onclick="document.getElementById('${id}').value='${today}'">Today</button>
              </div>
            </div>`;
          }
          
          if(f.type === "age-selector"){
            const ageOptions = Array.from({length: 100}, (_, i) => i + 1).map(age => 
              `<option value="${age}" ${age == val ? 'selected' : ''}>${age}</option>`
            ).join('');
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <select id="${id}" class="ui-select age-select">
                <option value="">Select age...</option>
                ${ageOptions}
                <option value="100+" ${val == "100+" ? 'selected' : ''}>100+</option>
              </select>
            </div>`;
          }
          
          if(f.type === "staff-multi-select"){
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <div class="multi-select-wrapper">
                <input id="${id}" type="hidden" value="${esc(val)}" />
                <div class="staff-chips" id="${id}-chips"></div>
                <select id="${id}-selector" class="ui-select">
                  <option value="">Add staff member...</option>
                </select>
              </div>
            </div>`;
          }
          
          if(f.type === "category-select" || f.type === "status-select" || f.type === "priority-select" || f.type === "avenue-select"){
            const opts = (f.options || []).map(o => 
              `<option value="${o.value}" ${o.value == val ? "selected": ""} data-color="${o.color || ""}">${o.label}</option>`
            ).join("");
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <select id="${id}" class="ui-select ${f.type}" ${f.required ? "required" : ""}>
                ${f.required ? '' : '<option value="">Select...</option>'}
                ${opts}
              </select>
            </div>`;
          }
          
          if(f.type === "datetime"){
            let dateVal = "";
            let timeVal = "";
            try{
              if(val){ const d = new Date(val); dateVal = d.toISOString().slice(0,10); timeVal = d.toISOString().slice(11,16); }
            }catch(e){}
            return `<div class="${fieldClass}"><label>${esc(label)}</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="${id}-date" type="date" value="${esc(dateVal)}" ${f.required ? "required" : ""} />
                <input id="${id}-time" type="time" value="${esc(timeVal)}" ${f.required ? "required" : ""} />
                <button type="button" class="btn secondary" id="${id}-now" style="padding:6px 8px;">Now</button>
              </div>
            </div>`;
          }
          
          if(f.type === "textarea"){
            return `<div class="${fieldClass}"><label>${esc(label)}</label><textarea id="${id}" rows="3" ${f.required ? "required" : ""}>${esc(val)}</textarea></div>`;
          }
          
          if(f.type === "checkbox"){
            return `<div class="${fieldClass}"><label style="display:flex; gap:8px; align-items:center;"><input id="${id}" type="checkbox" ${val ? "checked" : ""}> ${esc(label)}</label></div>`;
          }
          
          if(f.type === "select"){
            if(f.options){
              const opts = (f.options || []).map(o => `<option value="${o.value}"${o.value == val ? " selected": ""}>${o.label}</option>`).join("");
              return `<div class="${fieldClass}"><label>${esc(label)}</label><select id="${id}" class="ui-select">${opts}</select></div>`;
            }else{
              return `<div class="${fieldClass}"><label>${esc(label)}</label><select id="${id}" class="ui-select"><option value="">Loading...</option></select></div>`;
            }
          }
          
          if(f.type === "frequency"){
            setTimeout(() => {
              const freq = String(val || '1 month').toLowerCase();
              const scheduledDaySelect = document.getElementById('field-scheduled_day');
              if (!scheduledDaySelect) return;
              
              if (freq.includes('mon')) {
                scheduledDaySelect.innerHTML = Array.from({length: 31}, (_, i) => 
                  `<option value="${i+1}">${i+1}${['st','nd','rd'][i] || 'th'}</option>`
                ).join('');
              } else {
                scheduledDaySelect.innerHTML = [
                  {value: 'Sun', label: 'Sunday'},
                  {value: 'Mon', label: 'Monday'},
                  {value: 'Tue', label: 'Tuesday'},
                  {value: 'Wed', label: 'Wednesday'},
                  {value: 'Thu', label: 'Thursday'},
                  {value: 'Fri', label: 'Friday'},
                  {value: 'Sat', label: 'Saturday'}
                ].map(day => `<option value="${day.value}">${day.label}</option>`).join('');
              }
            }, 0);
            let num = 1, unit = "day";
            if(typeof val === "string" && val){
              const m = val.match(/(\d+)\s*(year|mon|week|day)/i);
              if(m){ num = m[1]; unit = m[2].toLowerCase(); }
            }
            const units = [
              {v:"day",  n:"day(s)"},
              {v:"week", n:"week(s)"},
              {v:"mon",  n:"month(s)"},
              {v:"year", n:"year(s)"}
            ];
            const unitOpts = units.map(u => `<option value="${u.v}"${u.v===unit?" selected":""}>${u.n}</option>`).join("");
            return `<div class="${fieldClass}"><label>${esc(label || "Every")}</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="${id}-n" type="number" min="1" value="${num}" style="width:110px">
                <select id="${id}-u">${unitOpts}</select>
              </div>
            </div>`;
          }
          
          if(f.type === "file-upload"){
            return `<div class="${fieldClass}" style="border: 1px dashed #ccc; padding: 15px; border-radius: 8px; background: #f9f9f9;">
              <label style="font-weight: bold; margin-bottom: 10px; display: block;">${esc(label)}</label>
              <div class="file-upload-area" style="text-align: center;">
                <input id="${id}" type="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt" style="display: none;" />
                <button type="button" class="btn secondary" onclick="document.getElementById('${id}').click()" style="margin-bottom: 10px;">
                  <span>📎 Choose File</span>
                </button>
                <div id="${id}-status" style="font-size: 12px; color: #666; margin-top: 5px;">No file selected</div>
                <div id="${id}-progress" style="display: none; margin-top: 10px;">
                  <div style="background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                    <div id="${id}-progress-bar" style="background: #4CAF50; height: 20px; width: 0%; transition: width 0.3s;"></div>
                  </div>
                  <div id="${id}-progress-text" style="font-size: 12px; margin-top: 5px;">Uploading...</div>
                </div>
              </div>
              <div class="ai-helper" style="margin-top:.5rem; display:flex; gap:.5rem; align-items:center; justify-content:center;">
                <button type="button" id="ai-populate-btn-${id}" class="ai-populate-btn btn btn-secondary" style="padding:.4rem .7rem; font-size:.9rem;">
                  Optional: Populate with AI
                </button>
                <span id="ai-status-${id}" style="font-size:.85rem; opacity:.8;"></span>
              </div>
            </div>`;
          }
          
          return `<div class="${fieldClass}"><label>${esc(label)}</label><input id="${id}" type="text" value="${esc(val)}"></div>`;

        }).join("")}</div>`;

// Ensure Staff Role dropdown is populated even if not declared in entity schema
if (entityKey === 'kiosk_users') {
  (async ()=>{
    const sel = document.getElementById('field-role');
    if (sel && sel.tagName.toLowerCase()==='select') {
      // Roles are fixed to Admin and Staff
      const options = [ {v:'admin', l:'Admin'}, {v:'staff', l:'Staff'} ];
      const selected = (crudState.row || {}).role || '';
      sel.innerHTML = `<option value="">—</option>` + options.map(o => {
        const s = (String(o.v) === String(selected)) ? ' selected' : '';
        return `<option value="${o.v}"${s}>${o.l}</option>`;
      }).join('');
    }
  })();
}

        
// Populate dynamic select sources
(async () => {
  
for (const f of (crudState.entity.fields || [])) {
    if (f.type === "select" && f.source && !f.options) {
      const sel = document.getElementById('field-' + f.name);
      if (!sel) continue;
      try {
        const selectCols = (f.valueKey || "id") + ", " + (f.sourceLabel || "full_name");
        let q = supabase.from(f.source).select(selectCols);
  const siteScoped = ["rooms","check_types","items","kiosk_users","item_allowed_types"];
        if (typeof ctx !== "undefined" && ctx.site_id && siteScoped.includes(f.source)) {
          q = q.eq("site_id", ctx.site_id);
        }
        const { data, error } = await q;
        if (!error && Array.isArray(data)) {
          // Exclude self when choosing a manager
          let list = data;
          if (f.name === "reports_to_id" && crudState?.row?.id) {
            const idKey = f.valueKey || "id";
            list = data.filter(r => String(r[idKey]) !== String(crudState.row.id));
          }
          const selected = (crudState.row || {})[f.name];
          sel.innerHTML = `<option value="">—</option>` + list.map(r => {
            const optVal = r[f.valueKey || "id"];
            const optLab = r[f.sourceLabel || "full_name"];
            const selAttr = (String(optVal) === String(selected)) ? " selected" : "";
            return '<option value="' + optVal + '"' + selAttr + '>' + esc(optLab) + '</option>';
          }).join("");
          // Defensive: if this is the created_by field and selected option looks non-UUID, prefer current user id
          if(f.name === 'created_by'){
            const chosen = sel.value;
            if(chosen && !isUUID(chosen) && ctx.user && ctx.user.id){
              sel.value = ctx.user.id;
            }
          }
        } else {
          sel.innerHTML = '<option value="">(error)</option>';
        }
      } catch (err) {
        console.warn('Select loader error for', f.name, err);
        sel.innerHTML = '<option value="">(error)</option>';
      }
    }
  }
})();;

  // Initialize enhanced form elements for complaints
  if (entityKey === 'complaints') {
    // Setup file upload handler
    const fileInput = document.getElementById('field-attachment');
    if (fileInput) {
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const statusDiv = document.getElementById('field-attachment-status');
        const progressDiv = document.getElementById('field-attachment-progress');
        const progressBar = document.getElementById('field-attachment-progress-bar');
        const progressText = document.getElementById('field-attachment-progress-text');
        
        if (!file) {
          statusDiv.textContent = 'No file selected';
          statusDiv.style.color = '#666';
          return;
        }
        
        // Validate file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
          statusDiv.textContent = 'File too large. Maximum size is 10MB.';
          statusDiv.style.color = '#e74c3c';
          return;
        }
        
        try {
          progressDiv.style.display = 'block';
          statusDiv.style.color = '#666';
          statusDiv.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
          
          // Store file for later upload when form is submitted
          crudState.pendingAttachment = {
            file: file,
            fileName: file.name,
            fileSize: file.size,
            fileType: file.type
          };
          
          progressBar.style.width = '100%';
          progressText.textContent = 'Ready to upload when complaint is saved';
          
          setTimeout(() => {
            progressDiv.style.display = 'none';
          }, 2000);
          
        } catch (error) {
          console.error('File selection error:', error);
          statusDiv.textContent = 'Error selecting file';
          statusDiv.style.color = '#e74c3c';
          progressDiv.style.display = 'none';
        }
      });
    }
    
    // Setup staff multi-select
    setTimeout(() => {
      const staffMultiSelect = document.getElementById('field-people_involved-selector');
      const staffChips = document.getElementById('field-people_involved-chips');
      const hiddenInput = document.getElementById('field-people_involved');
      
      if (staffMultiSelect && staffChips && hiddenInput) {
        // Load staff members into the selector
        supabase.from('kiosk_users').select('id, full_name').eq('site_id', ctx.site_id).then(({data, error}) => {
          if (data && !error) {
            staffMultiSelect.innerHTML = '<option value="">Add staff member...</option>' + 
              data.map(s => `<option value="${s.id}">${s.full_name}</option>`).join('');
          }
        });
        
        // Handle staff selection
        staffMultiSelect.addEventListener('change', (e) => {
          if (e.target.value) {
            const staffId = e.target.value;
            const staffName = e.target.selectedOptions[0].text;
            const currentIds = hiddenInput.value ? hiddenInput.value.split(',') : [];
            
            if (!currentIds.includes(staffId)) {
              currentIds.push(staffId);
              hiddenInput.value = currentIds.join(',');
              
              const chip = document.createElement('div');
              chip.className = 'staff-chip';
              chip.innerHTML = `${staffName} <button type="button" onclick="this.parentElement.remove(); updateStaffIds()">×</button>`;
              staffChips.appendChild(chip);
            }
            e.target.value = '';
          }
        });
        
        // Function to update hidden input when chips are removed
        window.updateStaffIds = function() {
          const chips = staffChips.querySelectorAll('.staff-chip');
          const ids = Array.from(chips).map(chip => {
            const text = chip.textContent.replace('×', '').trim();
            const option = Array.from(staffMultiSelect.options).find(opt => opt.text === text);
            return option ? option.value : null;
          }).filter(id => id);
          hiddenInput.value = ids.join(',');
        };
        
        // Load existing selections
        if (hiddenInput.value) {
          const existingIds = hiddenInput.value.split(',');
          existingIds.forEach(id => {
            const option = Array.from(staffMultiSelect.options).find(opt => opt.value === id);
            if (option) {
              const chip = document.createElement('div');
              chip.className = 'staff-chip';
              chip.innerHTML = `${option.text} <button type="button" onclick="this.parentElement.remove(); updateStaffIds()">×</button>`;
              staffChips.appendChild(chip);
            }
          });
        }
      }
    }, 100);
  }

  // Attach 'Now' handlers for datetime fields (fill date and time with current values)
  (function attachNowButtons(){
    (crudState.entity.fields || []).forEach(f=>{
      if(f.type === 'datetime'){
        const btn = document.getElementById(`field-${f.name}-now`);
        if(!btn) return;
        btn.addEventListener('click', ()=>{
          const d = new Date();
          const dateEl = document.getElementById(`field-${f.name}-date`);
          const timeEl = document.getElementById(`field-${f.name}-time`);
          if(dateEl) dateEl.value = d.toISOString().slice(0,10);
          if(timeEl) timeEl.value = d.toISOString().slice(11,16);
        });
      }
    });
  })();

    }

    const downloadBtn = document.getElementById('btn-download-pir');
    if (downloadBtn && row?.file_path) {
        downloadBtn.addEventListener('click', async () => {
            const { data, error } = await supabase.storage.from('pir_attachments').download(row.file_path);
            if (error) { crudError.textContent = `Download failed: ${error.message}`; return; }
            const url = URL.createObjectURL(data);
            const a = document.createElement('a');
            a.href = url;
            a.download = row.file_path.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    }

    crudDeleteBtn.style.display = (mode === "edit" && entityKey !== 'pir_documents') ? "inline-block" : "none";
    crudModal.classList.add("show");
  }

  function closeCRUD(){ crudModal.classList.remove("show"); }

  crudCancelBtn.addEventListener("click", closeCRUD);
  // Disable closing the CRUD modal by clicking the backdrop to prevent accidental closure.
  // Keep the Cancel button behavior intact.
  // Previously: close on backdrop click. That behavior is now disabled.
  // crudModal.addEventListener("click", (e)=>{ if(e.target === crudModal) closeCRUD(); });

  crudForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    crudError.textContent = "";
    const entity = crudState.entity;
    let body = {};
    
    if(entity.table === 'pir_documents') {
        const item = crudState.row;
        body.last_updated = document.getElementById('field-pir-last_updated').value || null;
        
        let jsonData = item.data || {};
        let hasData = false;

        if (item.item_type.includes('textarea')) {
            const val = document.getElementById('field-pir-text_content')?.value || null;
            jsonData.text_content = val;
            if(val) hasData = true;
        }
        if (item.item_type.includes('questions')) {
            jsonData.answers = Array.from(crudFields.querySelectorAll('textarea[data-question-index]')).map(el => el.value);
            if(jsonData.answers.some(a => a)) hasData = true;
        }
        if (item.item_type.includes('number') || item.item_type.includes('dual') || item.item_type.includes('triple')) {
            jsonData.num1 = document.getElementById('field-pir-num1')?.value || null;
            jsonData.num2 = document.getElementById('field-pir-num2')?.value || null;
            jsonData.num3 = document.getElementById('field-pir-num3')?.value || null;
            if(jsonData.num1 || jsonData.num2 || jsonData.num3) hasData = true;
        }
        if (item.item_type.includes('text')) { // dual_text
            jsonData.text1 = document.getElementById('field-pir-text1')?.value || null;
            jsonData.text2 = document.getElementById('field-pir-text2')?.value || null;
            if(jsonData.text1 || jsonData.text2) hasData = true;
        }
        if (item.item_type === 'dynamic_table') {
            jsonData.table_data = item.data.table_data;
            if(jsonData.table_data?.length > 0) hasData = true;
        }
        
        body.data = jsonData;

        const fileInput = document.getElementById('field-pir-file_path');
        let hasFile = !!item.file_path;
        if (fileInput && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const filePath = `${ctx.site_id}/${item.id}/${file.name.replace(/[^a-zA-Z0-9.\-_]/g, '_')}`;
            const { error: uploadError } = await supabase.storage.from('pir_attachments').upload(filePath, file, { upsert: true });
            if (uploadError) throw uploadError;
            body.file_path = filePath;
            hasFile = true;
        }

        // Auto-set status
        if (hasFile || hasData) {
            body.status = 'Ready';
        } else {
            body.status = item.item_type.includes('file') ? 'Not Attached' : 'Not Started';
        }

    } else { // Standard entity logic...
        
for (const f of (crudState.entity.fields || [])) {
  // Skip special fields that are handled separately
  if (f.type === "file-upload") continue;
  
  let val;
  if (f.type === "checkbox") {
    val = document.getElementById(`field-${f.name}`).checked;
  } else if (f.type === "select") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "frequency") {
    const n = document.getElementById(`field-${f.name}-n`).value || "1";
    const u = document.getElementById(`field-${f.name}-u`).value || "day";
    val = `${n} ${u}`;
  } else if (f.type === "datetime") {
    // read date + time inputs and combine to ISO
    const dateEl = document.getElementById(`field-${f.name}-date`);
    const timeEl = document.getElementById(`field-${f.name}-time`);
    const nowBtn = document.getElementById(`field-${f.name}-now`);
    let d = dateEl ? dateEl.value : null;
    let t = timeEl ? timeEl.value : null;
    if(!d && !t){ val = null; }
    else {
      // If only date provided, treat time as 00:00; if only time, use today
      if(!d) d = new Date().toISOString().slice(0,10);
      if(!t) t = '00:00';
      const combined = `${d}T${t}:00`;
      const dt = new Date(combined);
      val = isNaN(dt.getTime()) ? null : dt.toISOString();
    }
  } else if (f.type === "age-selector") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
    else val = parseInt(val);
  } else if (f.type === "staff-multi-select") {
    const checkboxes = document.querySelectorAll(`input[name="field-${f.name}"]:checked`);
    val = Array.from(checkboxes).map(cb => cb.value).join(',');
    if (val === "") val = null;
  } else if (f.type === "category-select" || f.type === "status-select" || f.type === "priority-select" || f.type === "avenue-select") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "datepicker") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "textarea") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  }
  body[f.name] = val;
}

    }

    if(ctx.site_id) body.site_id = ctx.site_id;

    // Auto-generate complaint number for new complaints
    if(crudState.mode === "add" && entity.table === "complaints") {
      if(!body.complaint_number) {
        // Get current count of complaints for this site to generate next number
        try {
          const { count } = await supabase
            .from("complaints")
            .select("id", { count: "exact", head: true })
            .eq("site_id", ctx.site_id);
          const nextNum = (count || 0) + 1;
          body.complaint_number = `C${String(nextNum).padStart(4, '0')}`;
        } catch (err) {
          console.warn('Failed to generate complaint number:', err);
          body.complaint_number = `C${Date.now()}`; // fallback
        }
      }
    }

    // Defensive coercion: ensure created_by is a UUID (kiosk_users.id). If not, use current auth user id when available.
    if(body.created_by && !isUUID(body.created_by)){
      if(ctx.user && ctx.user.id){
        console.log('Coercing created_by from', body.created_by, 'to', ctx.user.id);
        body.created_by = ctx.user.id;
      } else {
        // remove invalid value to avoid DB error
        console.log('Removing invalid created_by value:', body.created_by);
        delete body.created_by;
      }
    }
    
    // For complaints, ensure created_by is set if missing
    if(entity.table === 'complaints' && !body.created_by && ctx.user?.id) {
      console.log('Setting created_by to current user:', ctx.user.id);
      body.created_by = ctx.user.id;
    }

    // Basic validation: ensure UUID fields expected by the DB contain valid UUIDs
    // Use the already-coerced value in `body` (post processing). Accept numeric kiosk_user ids
    // (the kiosk_users table uses integer PKs) as valid choices.
    const uuidChecks = [];
    (crudState.entity.fields || []).forEach(f => {
      if (f.name === 'created_by') {
        const candidate = body.created_by;
        if (candidate) {
          // If it looks like a UUID (contains hyphens), require isUUID
          if (String(candidate).includes('-')) {
            if (!isUUID(candidate)) uuidChecks.push({ field: f.name, value: candidate });
          } else {
            // Not a UUID: allow numeric IDs (integers) or fallback to current user
            // Accept values that are all digits
            if (!/^\d+$/.test(String(candidate))) {
              // not a pure integer -> invalid
              uuidChecks.push({ field: f.name, value: candidate });
            }
          }
        }
      }
    });
    if (uuidChecks.length) {
      crudError.textContent = `Please choose valid options for: ${uuidChecks.map(c=>c.field).join(', ')}.`;
      return;
    }

    // Defensive: ensure complaints.datetime (DB NOT NULL) is set. Prefer complaint_date if provided.
    if (entity.table === 'complaints') {
      if (!body.datetime) {
        if (body.complaint_date) {
          // If complaint_date is just a date (YYYY-MM-DD), convert to ISO timestamp at midnight UTC
          try {
            const d = new Date(body.complaint_date);
            if (!isNaN(d.getTime())) body.datetime = d.toISOString();
            else body.datetime = new Date().toISOString();
          } catch (e) {
            body.datetime = new Date().toISOString();
          }
        } else {
          body.datetime = new Date().toISOString();
        }
      }
    }

    try{
      let complaintId = null;
      
      // Debug logging before database operations
      console.log('About to save to database:', {
        mode: crudState.mode,
        table: entity.table,
        body: body,
        context: { 
          site_id: ctx.site_id, 
          user_id: ctx.user?.id,
          pendingAttachment: !!crudState.pendingAttachment 
        }
      });
      
      debugLog('Form Submit', {
        mode: crudState.mode,
        table: entity.table,
        hasAttachment: !!crudState.pendingAttachment,
        bodyKeys: Object.keys(body),
        created_by: body.created_by,
        site_id: body.site_id
      });
      
      if(crudState.mode === "add"){
        const { data, error } = await supabase.from(entity.table).insert(body).select('id').single(); 
        if(error) {
          console.error('Database insert error:', error);
          debugLog('Insert Error', error);
          throw error;
        }
        complaintId = data?.id;
        console.log('Successfully inserted with ID:', complaintId);
      }else{
        const pk = crudState.pk || "id";
        const idv = crudState.row?.[pk];
        if(!idv){ throw new Error("Missing primary key for update."); }
        const { error } = await supabase.from(entity.table).update(body).eq(pk, idv); 
        if(error) throw error;
        complaintId = idv;
      }
      
      // Handle file attachment upload for complaints
      if(entity.table === "complaints" && crudState.pendingAttachment && complaintId) {
        const file = crudState.pendingAttachment.file;
        const fileName = crudState.pendingAttachment.fileName;
        const fileType = crudState.pendingAttachment.fileType;
        const fileSize = crudState.pendingAttachment.fileSize;
        
        try {
          // Sanitize filename
          const safeName = String(fileName).replace(/[^a-zA-Z0-9.\-_]/g, '_');
          const storagePath = `complaints/${ctx.site_id}/${complaintId}/${safeName}`;

          console.log('Uploading attachment to storagePath:', storagePath, { fileType, fileSize });

          // Upload file to Supabase Storage
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('pir_attachments')
            .upload(storagePath, file, { upsert: true, contentType: fileType });

          console.log('uploadData:', uploadData, 'uploadError:', uploadError);

          if (uploadError) {
            console.error('Supabase upload error object:', uploadError);
            throw uploadError;
          }

          // Try to get a public URL; if bucket is private, fall back to a signed URL
          let publicUrl = null;
          try {
            const { data: urlData } = supabase.storage.from('pir_attachments').getPublicUrl(storagePath);
            console.log('getPublicUrl result:', urlData);
            if (urlData && urlData.publicUrl) publicUrl = urlData.publicUrl;
          } catch (e) {
            console.warn('getPublicUrl threw:', e);
          }

          if (!publicUrl && supabase.storage.from('pir_attachments').createSignedUrl) {
            try {
              const { data: signed, error: signedErr } = await supabase.storage.from('pir_attachments').createSignedUrl(storagePath, 60 * 60);
              console.log('createSignedUrl result:', signed, 'err:', signedErr);
              if (!signedErr && signed && signed.signedUrl) publicUrl = signed.signedUrl;
            } catch (e) {
              console.warn('createSignedUrl threw:', e);
            }
          }

          // Save attachment record in complaint_attachments table
          const attachmentRecord = {
            complaint_id: complaintId,
            file_name: safeName,
            file_url: publicUrl || storagePath, // fallback to storage path if no public URL
            file_type: fileType,
            file_size: fileSize,
            attachment_type: 'original',
            uploaded_at: new Date().toISOString()
          };
          
          console.log('Inserting attachment record:', attachmentRecord);
          debugLog('Attachment Insert', { 
            record: attachmentRecord, 
            hasPublicUrl: !!publicUrl,
            storagePath: storagePath 
          });
          
          const { data: attachData, error: attachmentError } = await supabase.from('complaint_attachments').insert(attachmentRecord).select().single();

          console.log('attachment insert result:', { attachData, attachmentError });

          if (attachmentError) throw attachmentError;

          // Clear pending attachment
          crudState.pendingAttachment = null;

        } catch (attachmentErr) {
          console.error('Attachment upload error:', attachmentErr);
          console.error('Full error details:', JSON.stringify(attachmentErr, null, 2));
          
          // Add specific debugging for common RLS/policy issues
          if (attachmentErr.code === '42501') {
            console.error('RLS Policy Error: Check that complaint_attachments table has proper insert policies');
          } else if (attachmentErr.code === '23505') {
            console.error('Unique constraint violation in complaint_attachments');
          } else if (attachmentErr.message && attachmentErr.message.includes('policy')) {
            console.error('Policy violation detected:', attachmentErr.message);
          }
          
          debugLog('Attachment Error', {
            error: attachmentErr,
            complaintId: complaintId,
            fileName: fileName,
            fileSize: fileSize,
            storagePath: typeof storagePath !== 'undefined' ? storagePath : 'undefined'
          });
          
          // Don't fail the entire form submission if attachment fails
          try {
            const errMsg = attachmentErr && attachmentErr.message ? attachmentErr.message : JSON.stringify(attachmentErr);
            crudError.textContent = `Complaint saved, but attachment failed to upload: ${errMsg}`;
          } catch (e) {
            crudError.textContent = `Complaint saved, but attachment failed to upload. Check console for details.`;
          }
          setTimeout(() => { crudError.textContent = ""; closeCRUD(); }, 8000);
          return;
        }
      }
      
      closeCRUD();
      if (entity.table === 'pir_documents') loadAndRenderPIR();
      else await Promise.all([loadCounts(), loadItems(), loadRooms(), loadComplaints(), loadCheckTypes(), loadSchedules(), loadStaff()]);
    } catch(err) {
      crudError.textContent = err.message || String(err);
    }
  });

  crudDeleteBtn.addEventListener("click", async ()=>{
    
for (const f of (crudState.entity.fields || [])) {
  let val;
  if (f.type === "checkbox") {
    val = document.getElementById(`field-${f.name}`).checked;
  } else if (f.type === "select") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "frequency") {
    const n = document.getElementById(`field-${f.name}-n`).value || "1";
    const u = document.getElementById(`field-${f.name}-u`).value || "day";
    val = `${n} ${u}`;
  } else {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  }
  body[f.name] = val;
}

  });

  // ... (All remaining event listeners and functions are unchanged)
  document.getElementById("btn-new-room")?.addEventListener("click", ()=>openCRUD("rooms","add"));
  document.getElementById("btn-new-complaint")?.addEventListener("click", ()=>openCRUD("complaints","add"));
  document.getElementById("btn-new-ct")?.addEventListener("click", ()=>openCRUD("check_types","add"));
  // 'Add Staff' button removed from DOM; leave creation via staff modal or invite flow
  document.getElementById("btn-new-item")?.addEventListener("click", ()=>openCRUD("items","add"));
  document.getElementById("btn-new-sched")?.addEventListener("click", ()=>openCRUD("item_allowed_types","add"));

  document.getElementById('app').addEventListener('click', async (e) => {
    const tr = e.target.closest("tr[data-id]");
    if (!tr) return;
    const tbody = tr.closest("tbody");
    if(!tbody) return;
    if(tbody.id === 'subs-tbody') { showSubmissionDetails(tr.dataset.id); return; }
    const entityKey = tbody.dataset.entity;
    if (entityKey && ENTITIES[entityKey]) {
      const rowId = tr.dataset.id;
      tbody.querySelectorAll("tr.selected").forEach(r => r.classList.remove("selected"));
      tr.classList.add("selected");
      try {
        const { data: rowData, error } = await supabase.from(ENTITIES[entityKey].table).select("*").eq(ENTITIES[entityKey].pk, rowId).maybeSingle();
        if (error) throw error;
        if (rowData) openCRUD(entityKey, "edit", rowData);
      } catch (err) { console.error("Error fetching row for editing:", err); }
    }
  });

  const itemsHead = document.querySelector('#view-items thead');
  if(itemsHead){ itemsHead.addEventListener('click', (e)=>{ const th = e.target.closest('th.sortable'); if(!th) return; const col = th.getAttribute('data-col'); if(itemsSort.col === col){ itemsSort.dir = itemsSort.dir === 'asc' ? 'desc' : 'asc'; }else{ itemsSort.col = col; itemsSort.dir = 'asc'; } loadItems(); }); }
  function activeViewId(){ const v = document.querySelector('section.view.active'); return v ? v.id : ''; }
  document.getElementById('search').addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && activeViewId() === 'view-items'){ e.preventDefault(); itemsQuery = e.target.value.trim(); loadItems(); } });
  document.getElementById("cal-prev")?.addEventListener("click", ()=>{ calendarDate.setMonth(calendarDate.getMonth() - 1); loadAndRenderCalendar(); });
  document.getElementById("cal-next")?.addEventListener("click", ()=>{ calendarDate.setMonth(calendarDate.getMonth() + 1); loadAndRenderCalendar(); });
  document.getElementById("cal-view-switcher")?.addEventListener("click", (e) => { const btn = e.target.closest("button[data-view]"); if (!btn) return; document.querySelectorAll("#cal-view-switcher button").forEach(b => b.classList.remove("active")); btn.classList.add("active"); currentCalendarView = btn.dataset.view; if (currentCalendarView === 'daily') calendarDate = new Date(); loadAndRenderCalendar(); });
  
  const submissionDetailModal = document.getElementById("submission-detail-modal");
  async function showSubmissionDetails(submissionId) {
    submissionDetailModal.classList.add("show");
    submissionDetailModal.dataset.submissionId = submissionId;
    document.getElementById("submission-detail-content").innerHTML = `<div class="muted" style="padding:20px 0; text-align:center;">Loading details...</div>`;
    document.getElementById("submission-detail-title").textContent = `Details for Submission #${submissionId}`;
    console.log('DEBUG showSubmissionDetails: Fetching submission details for ID:', submissionId);
    
    // Get submission rows with all fields
    const { data: rows, error } = await supabase.from('submission_rows').select(`
      id, row_comment, item_id, check_type, check_value, check_type_id, item_pk
    `).eq('submission_id', submissionId);
    
    console.log('DEBUG showSubmissionDetails: Query result:', { rows, error });
    if (error) {
      console.error('Error fetching submission details:', error);
      document.getElementById("submission-detail-content").innerHTML = `<div class="muted" style="padding:20px 0; text-align:center; color:red;">Error loading details: ${error.message}</div>`;
      return;
    }
    if (!rows || rows.length === 0) {
      console.log('DEBUG showSubmissionDetails: No rows found');
      document.getElementById("submission-detail-content").innerHTML = `<div class="muted" style="padding:20px 0; text-align:center;">No items found for this submission.</div>`;
      return;
    }

    // Build the table with the data we have
    let contentHtml = `<div class="table-wrap" style="max-height: 60vh;"><table><thead><tr><th>Item ID</th><th>Check Performed</th><th>Result</th><th>Comment</th></tr></thead><tbody data-entity="submission_rows">`;
    contentHtml += rows.map(r => `<tr data-id="${r.id}">
      <td>${esc(r.item_id || 'Unknown')}</td>
      <td>${esc(r.check_type || 'Unknown Check')}</td>
      <td>${esc(r.check_value || 'Done')}</td>
      <td>${esc(r.row_comment || '-')}</td>
    </tr>`).join('');
    contentHtml += `</tbody></table></div>`;
    console.log('DEBUG showSubmissionDetails: Generated HTML:', contentHtml);
    document.getElementById("submission-detail-content").innerHTML = contentHtml;
  }
  submissionDetailModal.addEventListener("click", (e) => { if (e.target === submissionDetailModal || e.target.closest("#submission-detail-close")) { submissionDetailModal.classList.remove("show"); } });

  // === TRAINING FUNCTIONALITY ===
  let trainingData = { staff: [], types: [], records: [] };
  let currentTrainingTab = 'clinical';

  async function loadTrainingMatrix() {
    try {
      // Load staff, training types, and training records
      const [staffRes, typesRes, recordsRes] = await Promise.all([
        supabase.from('kiosk_users').select('*').eq('site_id', ctx.site_id),
        supabase.from('training_types').select('*').eq('site_id', ctx.site_id).eq('active', true),
        supabase.from('training_records').select(`
          *, 
          kiosk_users(full_name, role), 
          training_types(name)
        `).eq('site_id', ctx.site_id)
      ]);

      if (staffRes.error) throw staffRes.error;
      if (typesRes.error) throw typesRes.error;
      if (recordsRes.error) throw recordsRes.error;

      trainingData = {
        staff: staffRes.data || [],
        types: typesRes.data || [],
        records: recordsRes.data || []
      };

      renderTrainingMatrix();
    } catch (err) {
      console.error('Failed to load training data:', err);
      document.getElementById('training-tbody').innerHTML = '<tr><td colspan="100%" class="muted">Failed to load training data</td></tr>';
    }
  }

  function switchTrainingTab(tab) {
    currentTrainingTab = tab;
    document.querySelectorAll('#view-training .tab-controls button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    renderTrainingMatrix();
  }

  function renderTrainingMatrix() {
    const headers = document.getElementById('training-headers');
    const tbody = document.getElementById('training-tbody');
    
    if (!headers || !tbody) return;

    // Filter staff by type
    const filteredStaff = trainingData.staff.filter(staff => {
      const isClinical = ['GP', 'Nurse', 'HCA', 'Practice Nurse', 'ANP'].some(role => 
        (staff.role || '').toLowerCase().includes(role.toLowerCase())
      );
      return currentTrainingTab === 'clinical' ? isClinical : !isClinical;
    });

    // Build headers
    headers.innerHTML = '<th>Staff Member</th>' + 
      trainingData.types.map(type => `<th>${esc(type.name)}</th>`).join('');

    // Build matrix rows
    if (filteredStaff.length === 0) {
      tbody.innerHTML = `<tr><td colspan="${trainingData.types.length + 1}" class="muted">No ${currentTrainingTab} staff found</td></tr>`;
      return;
    }

    tbody.innerHTML = filteredStaff.map(staff => {
      const staffRecords = trainingData.records.filter(r => r.staff_id === staff.id);
      const cells = trainingData.types.map(type => {
        const record = staffRecords.find(r => r.training_type_id === type.id);
        return renderTrainingCell(staff.id, type.id, record);
      }).join('');
      
      return `<tr>
        <td>${esc(staff.full_name || 'Unknown')}</td>
        ${cells}
      </tr>`;
    }).join('');

    // Add click handlers
    tbody.querySelectorAll('.training-cell').forEach(cell => {
      cell.addEventListener('click', () => {
        const staffId = cell.dataset.staffId;
        const typeId = cell.dataset.typeId;
        openTrainingModal(staffId, typeId);
      });
    });
  }

  function renderTrainingCell(staffId, typeId, record) {
    const today = new Date();
    let status = 'training-missing';
    let content = '—';
    
    if (record) {
      const completionDate = new Date(record.completion_date);
      const expiryDate = record.expiry_date ? new Date(record.expiry_date) : null;
      
      if (expiryDate) {
        const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysToExpiry < 0) {
          status = 'training-expired';
          content = `Expired<br><small>${fmtDateShort(record.completion_date)}</small>`;
        } else if (daysToExpiry <= 30) {
          status = 'training-expiring';
          content = `Expires ${daysToExpiry}d<br><small>${fmtDateShort(record.completion_date)}</small>`;
        } else {
          status = 'training-completed';
          content = `Valid<br><small>${fmtDateShort(record.completion_date)}</small>`;
        }
      } else {
        status = 'training-completed';
        content = `Completed<br><small>${fmtDateShort(record.completion_date)}</small>`;
      }
    }

    return `<td class="training-cell ${status}" data-staff-id="${staffId}" data-type-id="${typeId}">${content}</td>`;
  }

  function openTrainingModal(staffId, typeId) {
    const staff = trainingData.staff.find(s => s.id == staffId);
    const type = trainingData.types.find(t => t.id == typeId);
    const record = trainingData.records.find(r => r.staff_id == staffId && r.training_type_id == typeId);

    if (!staff || !type) return;

    document.getElementById('training-staff-id').value = staffId;
    document.getElementById('training-type-id').value = typeId;
    document.getElementById('training-staff-name').value = staff.full_name || 'Unknown';
    document.getElementById('training-type-name').value = type.name;
    
    if (record) {
      document.getElementById('training-completion-date').value = record.completion_date || '';
      document.getElementById('training-expiry-date').value = record.expiry_date || '';
      document.getElementById('training-notes').value = record.notes || '';
      document.getElementById('training-delete-btn').style.display = 'block';
      
      if (record.certificate_url) {
        document.getElementById('training-current-file').style.display = 'block';
        document.getElementById('training-file-name').textContent = 'Certificate on file';
      } else {
        document.getElementById('training-current-file').style.display = 'none';
      }
    } else {
      document.getElementById('training-completion-date').value = '';
      document.getElementById('training-expiry-date').value = '';
      document.getElementById('training-notes').value = '';
      document.getElementById('training-delete-btn').style.display = 'none';
      document.getElementById('training-current-file').style.display = 'none';
    }

    document.getElementById('training-modal').classList.add('show');
  }

  function closeTrainingModal() {
    document.getElementById('training-modal').classList.remove('show');
    document.getElementById('training-error').style.display = 'none';
    document.getElementById('training-form').reset();
  }

  async function handleTrainingFileUpload() {
    const fileInput = document.getElementById('training-certificate');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    if (file.size > 10 * 1024 * 1024) {
      document.getElementById('training-error').textContent = 'File size must be less than 10MB';
      document.getElementById('training-error').style.display = 'block';
      return;
    }

    // Show file selected
    const uploadZone = document.getElementById('training-upload-zone');
    uploadZone.innerHTML = `
      <div style="color: var(--success);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <p style="margin-top: 8px;">Selected: ${file.name}</p>
      </div>
    `;
  }

  function calculateTrainingExpiry() {
    const completionDate = document.getElementById('training-completion-date').value;
    const typeId = document.getElementById('training-type-id').value;
    
    if (!completionDate || !typeId) return;
    
    // Find the training type to get validity period
    const trainingType = trainingData.types.find(t => t.id == typeId);
    if (!trainingType || !trainingType.validity_months) return;
    
    // Calculate expiry date
    const completion = new Date(completionDate);
    const expiry = new Date(completion);
    expiry.setMonth(expiry.getMonth() + trainingType.validity_months);
    
    // Set the expiry date field
    const expiryField = document.getElementById('training-expiry-date');
    expiryField.value = expiry.toISOString().split('T')[0];
  }

  async function saveTrainingRecord(e) {
    e.preventDefault();
    
    const errorDiv = document.getElementById('training-error');
    errorDiv.style.display = 'none';

    try {
      const staffId = document.getElementById('training-staff-id').value;
      const typeId = document.getElementById('training-type-id').value;
      const completionDate = document.getElementById('training-completion-date').value;
      const expiryDate = document.getElementById('training-expiry-date').value;
      const notes = document.getElementById('training-notes').value;
      const fileInput = document.getElementById('training-certificate');
      
      let certificateUrl = null;

      // Upload certificate if provided
      if (fileInput.files[0]) {
        const file = fileInput.files[0];
        const fileName = `training-${staffId}-${typeId}-${Date.now()}.${file.name.split('.').pop()}`;
        
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('training-certificates')
          .upload(fileName, file);

        if (uploadError) throw uploadError;
        
        const { data: urlData } = supabase.storage
          .from('training-certificates')
          .getPublicUrl(fileName);
          
        certificateUrl = urlData.publicUrl;
      }

      // Save or update training record
      const recordData = {
        site_id: ctx.site_id,
        staff_id: parseInt(staffId),
        training_type_id: parseInt(typeId),
        completion_date: completionDate,
        expiry_date: expiryDate || null,
        notes: notes || null,
        certificate_url: certificateUrl
      };

      const existingRecord = trainingData.records.find(r => 
        r.staff_id == staffId && r.training_type_id == typeId
      );

      if (existingRecord) {
        const { error } = await supabase
          .from('training_records')
          .update(recordData)
          .eq('id', existingRecord.id);
        if (error) throw error;
      } else {
        const { error } = await supabase
          .from('training_records')
          .insert(recordData);
        if (error) throw error;
      }

      closeTrainingModal();
      loadTrainingMatrix();
    } catch (err) {
      console.error('Failed to save training record:', err);
      errorDiv.textContent = err.message || 'Failed to save training record';
      errorDiv.style.display = 'block';
    }
  }

  // Global function for downloading training certificates
  window.downloadTrainingCertificate = function() {
    const staffId = document.getElementById('training-staff-id').value;
    const typeId = document.getElementById('training-type-id').value;
    const record = trainingData.records.find(r => 
      r.staff_id == staffId && r.training_type_id == typeId
    );
    
    if (record?.certificate_url) {
      window.open(record.certificate_url, '_blank');
    }
  };

  document.addEventListener("DOMContentLoaded", bootstrap);
</script>
  
  <div id="crud-modal" class="auth" aria-hidden="true">
    <div class="card" style="width:min(620px,95vw)">
      <h2 id="crud-title">Edit</h2>
      <form id="crud-form">
        <div id="crud-fields"></div>
        <div style="display:flex; gap:8px; margin-top:12px">
          <button type="submit" class="btn" id="crud-save">Save</button>
          <button type="button" class="btn secondary" id="crud-cancel">Cancel</button>
          <button type="button" class="btn secondary" id="crud-delete" style="margin-left:auto; background:#ff6b6b33; border:1px solid #ff6b6b55">Delete</button>
        </div>
        <div class="error" id="crud-error" role="alert"></div>
      </form>
    </div>
  </div>
  
  <div id="submission-detail-modal" class="auth" aria-hidden="true">
    <div class="card" style="width:min(800px, 95vw)">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="submission-detail-title" style="margin:0;">Submission Details</h2>
        <button id="submission-detail-close" class="btn secondary" style="padding: 6px; line-height: 0;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div class="hint">Click on a row to amend the check type or comment.</div>
      <div id="submission-detail-content" style="margin-top:12px;"></div>
    </div>
  </div>



  <!-- Debug panel (temporary) -->
  <div id="debug-panel" style="position:fixed; right:12px; bottom:12px; width:360px; max-height:40vh; overflow:auto; background:rgba(0,0,0,0.6); color:#fff; font-size:12px; padding:8px; border-radius:8px; z-index:9999; box-shadow:0 6px 18px rgba(0,0,0,0.4);">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px;"><strong style="font-size:13px">DEBUG</strong><button id="debug-clear" style="background:#333;color:#fff;border:none;padding:4px 8px;border-radius:6px;cursor:pointer">Clear</button></div>
    <div id="debug-log"></div>
  </div>
  <script>
  // Temporary debug helper
  function debugLog(msg, obj) {
    try {
      const panel = document.getElementById('debug-log');
      if (!panel) return;
      const time = new Date().toISOString().slice(11,23);
      const el = document.createElement('div');
      el.style.borderBottom = '1px dashed rgba(255,255,255,0.06)';
      el.style.padding = '6px 0';
      el.innerHTML = `<code style="color:#bfe7ff">[${time}]</code> ${String(msg)}${obj ? `<pre style="white-space:pre-wrap;margin:6px 0;color:#ffd6a5">${JSON.stringify(obj, null, 2)}</pre>` : ''}`;
      panel.insertBefore(el, panel.firstChild);
    } catch (e) { console.log('debugLog error', e); }
  }
  document.getElementById('debug-clear')?.addEventListener('click', ()=>{ const p=document.getElementById('debug-log'); if(p) p.innerHTML=''; });

  // Instrument file selection and upload points if present
  (function instrumentDebugging(){
    const fileInput = document.getElementById('field-attachment');
    if(fileInput){
      fileInput.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        debugLog('file selected', f ? { name: f.name, size: f.size, type: f.type } : 'no-file');
      });
    }

    // Hook into save button to dump pendingAttachment
    const saveBtn = document.getElementById('crud-save');
    if(saveBtn){
      saveBtn.addEventListener('click', ()=>{
        debugLog('Save clicked. pendingAttachment', window.crudState ? window.crudState.pendingAttachment : null);
      });
    }

    // AI Populate logic for complaints form (using event delegation for dynamic buttons)
    (function(){
      function setStatus(statusEl, msg){ if(statusEl) statusEl.textContent = msg || ''; }
      function getEl(...selectors){ for(const s of selectors){ const el=document.querySelector(s); if(el) return el; } return null; }

      // Use event delegation to handle dynamically created AI buttons
      document.addEventListener('click', async function(event) {
        if (!event.target.classList.contains('ai-populate-btn')) return;
        
        const btn = event.target;
        const btnId = btn.id;
        const statusId = btnId.replace('ai-populate-btn-', 'ai-status-');
        const statusEl = document.getElementById(statusId);
        
        // Find the associated file input - extract field ID from button ID
        const fieldId = btnId.replace('ai-populate-btn-', '');
        const fileInput = document.getElementById(fieldId);
        
        debugLog('AI button clicked', {buttonId: btnId, fieldId: fieldId, fileInputFound: !!fileInput, hasFiles: fileInput?.files?.length > 0});
        
        if (!fileInput || !fileInput.files.length){
          setStatus(statusEl, 'Choose a file first.'); 
          debugLog('No file input or files found', {fileInput: !!fileInput, filesLength: fileInput?.files?.length});
          return;
        }
        
        const file = fileInput.files[0];
        debugLog('AI button clicked', {buttonId: btnId, fileName: file.name, fileSize: file.size});
        
        // Get form field elements
        const elDate = getEl('#field-complaint_date');
        const elPatient = getEl('#field-patient_initials');
        const elAge = getEl('#field-age');
        const elSummary = getEl('#field-complaint_summary');
        const elOrig = getEl('#field-original_complaint');
        const elResp = getEl('#field-response');
        const elLessons = getEl('#field-lessons_learned');
        const elCategory = getEl('#field-category');
        const elCategoryTrends = getEl('#field-category_trends');
        const elSolution = getEl('#field-solution_given');
        const elSuggestions = getEl('#field-suggestions_prevent_reoccurrence');
        const elActions = getEl('#field-actions_to_be_taken');
        const elPeopleInvolved = getEl('#field-people_involved');
        const elAvenue = getEl('#field-avenue_used');
        const elStatus = getEl('#field-status');
        const elPriority = getEl('#field-priority');
        const elResponseSent = getEl('#field-response_sent');
        const elCreatedBy = getEl('#field-created_by');

        btn.disabled = true; 
        setStatus(statusEl, 'Processing…');
        
        try {
          let textContent = '';
          
          // Extract text based on file type
          if (file.type === 'text/plain') {
            textContent = await file.text();
            debugLog('Text file processed', {length: textContent.length});
          } else if (file.type === 'application/pdf') {
            setStatus(statusEl, 'Extracting text from PDF…');
            try {
              const arrayBuffer = await file.arrayBuffer();
              const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
              debugLog('PDF loaded', {numPages: pdf.numPages});
              
              let pdfText = '';
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                pdfText += pageText + '\n';
              }
              textContent = pdfText.trim();
              debugLog('PDF text extracted', {length: textContent.length});
            } catch (pdfError) {
              debugLog('PDF extraction error', pdfError);
              setStatus(statusEl, 'Error extracting text from PDF. Try a text file instead.');
              btn.disabled = false;
              return;
            }
          } else if (file.type.includes('word') || file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
            setStatus(statusEl, 'Word document processing - please use PDF or text files');
            btn.disabled = false;
            return;
          } else {
            setStatus(statusEl, 'Please upload a PDF or text (.txt) file for AI processing.');
            btn.disabled = false;
            return;
          }
          
          if (!textContent || textContent.length < 10) {
            setStatus(statusEl, 'File appears to be empty or too short.');
            btn.disabled = false;
            return;
          }
          
          debugLog('Calling extract-complaint function', {textLength: textContent.length});
          setStatus(statusEl, 'Calling AI service…');
          
          const { data, error } = await supabase.functions.invoke('extract-complaint', { 
            body: { text: textContent }
          });
          
          debugLog('AI function response', {data, error});
          
          if (error) {
            debugLog('AI function error', error);
            throw error;
          }
          
          if (!data || !data.success) {
            const errorMsg = data?.error || 'Unknown error from AI service';
            debugLog('AI service error', errorMsg);
            throw new Error(errorMsg);
          }
          
          const d = data.data || {};
          debugLog('AI extracted data', d);
          debugLog('Form elements found', {
            date: !!elDate,
            patient: !!elPatient,
            age: !!elAge,
            summary: !!elSummary,
            original: !!elOrig,
            response: !!elResp,
            lessons: !!elLessons,
            category: !!elCategory,
            categoryTrends: !!elCategoryTrends,
            solution: !!elSolution,
            suggestions: !!elSuggestions,
            actions: !!elActions,
            peopleInvolved: !!elPeopleInvolved,
            avenue: !!elAvenue,
            status: !!elStatus,
            priority: !!elPriority,
            responseSent: !!elResponseSent,
            createdBy: !!elCreatedBy
          });
          
          // Populate all form fields
          if (elDate && d.complaint_date) {
            elDate.value = d.complaint_date;
            debugLog('Populated complaint date', d.complaint_date);
          }
          if (elPatient && d.patient_initials) {
            elPatient.value = d.patient_initials;
            debugLog('Populated patient initials', d.patient_initials);
          }
          if (elAge && d.age) {
            elAge.value = d.age;
            debugLog('Populated age', d.age);
          }
          if (elSummary && d.complaint_summary) {
            elSummary.value = d.complaint_summary;
            debugLog('Populated summary', d.complaint_summary);
          }
          if (elOrig && d.original_complaint) {
            elOrig.value = d.original_complaint;
            debugLog('Populated original complaint', d.original_complaint);
          }
          if (elResp && d.response) {
            elResp.value = d.response;
            debugLog('Populated response', d.response);
          }
          if (elLessons && d.lessons_learned) {
            elLessons.value = d.lessons_learned;
            debugLog('Populated lessons learned', d.lessons_learned);
          }
          if (elCategory && d.category) {
            elCategory.value = d.category;
            debugLog('Populated category', d.category);
          }
          if (elCategoryTrends && d.category_trends) {
            elCategoryTrends.value = d.category_trends;
            debugLog('Populated category trends', d.category_trends);
          }
          if (elSolution && d.solution_given) {
            elSolution.value = d.solution_given;
            debugLog('Populated solution given', d.solution_given);
          }
          if (elSuggestions && d.suggestions_prevent_reoccurrence) {
            elSuggestions.value = d.suggestions_prevent_reoccurrence;
            debugLog('Populated suggestions', d.suggestions_prevent_reoccurrence);
          }
          if (elActions && d.actions_to_be_taken) {
            elActions.value = d.actions_to_be_taken;
            debugLog('Populated actions', d.actions_to_be_taken);
          }
          if (elAvenue && d.avenue_used) {
            elAvenue.value = d.avenue_used;
            debugLog('Populated avenue used', d.avenue_used);
          }
          if (elStatus && d.status) {
            elStatus.value = d.status;
            debugLog('Populated status', d.status);
          }
          if (elPriority && d.priority) {
            elPriority.value = d.priority;
            debugLog('Populated priority', d.priority);
          }
          if (elResponseSent && typeof d.response_sent === 'boolean') {
            elResponseSent.checked = d.response_sent;
            debugLog('Populated response sent', d.response_sent);
          }
          // Set created_by to current user
          if (elCreatedBy && ctx.user && ctx.user.id) {
            elCreatedBy.value = ctx.user.id;
            debugLog('Set created_by to current user', ctx.user.id);
          }
          // Handle people_involved (multi-select field)
          if (elPeopleInvolved && d.people_involved && Array.isArray(d.people_involved)) {
            // For multi-select, we'd need to match names to IDs from the staff list
            debugLog('People involved names extracted', d.people_involved);
            // Note: Actual ID mapping would require matching against kiosk_users table
          }
          
          setStatus(statusEl, '✓ Filled by AI — please review.');
          debugLog('Form populated successfully');
          
        } catch(e) {
          console.error('AI processing error:', e); 
          debugLog('AI error details', {message: e.message, stack: e.stack, error: e});
          setStatus(statusEl, 'AI error: ' + (e.message || e));
        } finally { 
          btn.disabled = false; 
        }
      });
    })();

  })();

  // --- Enhanced in-page debug panel (non-destructive) ---
  (function(){
    try{
      const panel = document.createElement('div');
      panel.id = 'enhancedDebugPanel';
      panel.style.position = 'fixed';
      panel.style.right = '12px';
      panel.style.bottom = '12px';
      panel.style.width = '420px';
      panel.style.maxHeight = '60vh';
      panel.style.overflow = 'auto';
      panel.style.background = 'rgba(0,0,0,0.85)';
      panel.style.color = '#e6e6e6';
      panel.style.fontSize = '12px';
      panel.style.zIndex = '999999';
      panel.style.borderRadius = '8px';
      panel.style.padding = '8px';
      panel.style.boxShadow = '0 8px 30px rgba(0,0,0,0.5)';

      panel.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px;">
          <strong style="color:#fff; font-size:13px;">DEBUG</strong>
          <div style="display:flex; gap:6px;">
            <button id="dbgClear" style="background:#c0392b;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px">Clear</button>
            <button id="dbgCopy" style="background:#16a085;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px">Copy</button>
            <button id="dbgToggle" style="background:#8e44ad;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px">Hide</button>
          </div>
        </div>
        <div id="dbgLog" style="white-space:pre-wrap; font-family:monospace; line-height:1.3; max-height:46vh; overflow-y:auto;">(logs appear here)</div>
      `;

      document.body.appendChild(panel);
      const logEl = document.getElementById('dbgLog');
      const clearBtn = document.getElementById('dbgClear');
      const copyBtn = document.getElementById('dbgCopy');
      const toggleBtn = document.getElementById('dbgToggle');

      function ts(){ return new Date().toISOString().replace('T',' ').replace('Z',''); }
      function debugLog(msg, obj){
        try{
          const line = `[${ts()}] ${msg}` + (obj!==undefined ? ' ' + JSON.stringify(obj, replacer, 2) : '');
          if(logEl.textContent === '(logs appear here)') logEl.textContent = '';
          logEl.textContent = line + '\n' + logEl.textContent;
          console.log('[DBG]', msg, obj);
        }catch(e){ console.log('debugLog fail', e); }
      }
      function replacer(k,v){ if(typeof v === 'function') return `[Function:${v.name||'anon'}]`; if(k && /token|key|secret|password/i.test(k)) return '[REDACTED]'; return v; }
      window.debugLog = debugLog;

      clearBtn.addEventListener('click', ()=>{ logEl.textContent = ''; debugLog('Logs cleared'); });
      copyBtn.addEventListener('click', ()=>{ navigator.clipboard?.writeText(logEl.textContent||'').then(()=>debugLog('Logs copied')).catch(e=>debugLog('Copy failed', e)); });
      toggleBtn.addEventListener('click', ()=>{ if(logEl.style.display==='none'){ logEl.style.display='block'; toggleBtn.textContent='Hide'; } else { logEl.style.display='none'; toggleBtn.textContent='Show'; } });

      // Wrap fetch
      const _fetch = window.fetch.bind(window);
      window.fetch = function(...args){
        try{ debugLog('fetch', { url: args[0], opts: args[1]?.method || 'GET' }); }catch(e){}
        return _fetch(...args).then(res=>{ debugLog('fetch-response', { url: args[0], status: res.status }); return res; }).catch(err=>{ debugLog('fetch-error', { url: args[0], error: String(err) }); throw err; });
      };

      // Wrap supabase.from to log queries
      try{
        if(window.supabase && window.supabase.from){
          const origFrom = window.supabase.from.bind(window.supabase);
          window.supabase.from = function(table){
            debugLog('supabase.from', { table });
            const q = origFrom(table);
            const wrapMethod = (methodName, label)=>{
              const orig = q[methodName]?.bind(q);
              if(orig){ q[methodName] = function(...a){ debugLog(label, { table, args: a.slice(0,2) }); return orig(...a); }; }
            };
            ['select','insert','update','delete','eq','in','order'].forEach(m=>wrapMethod(m,'supabase.'+m));
            return q;
          };
          debugLog('Supabase wrapped');
        }
      }catch(e){ console.warn('Supabase wrap failed', e); }

      // Capture button clicks & form submits
      document.addEventListener('click', (ev)=>{
        try{ const t=ev.target; if(!t) return; if(t.tagName==='BUTTON' || t.tagName==='A'){ debugLog('click', { tag: t.tagName, id: t.id||null, text: (t.textContent||'').trim().slice(0,60) }); } }catch(e){}
      }, true);

      document.addEventListener('submit', (ev)=>{
        try{ const f=ev.target; if(f && f.tagName==='FORM'){ const fd=new FormData(f); const keys=[]; for(const k of fd.keys()) keys.push(k); debugLog('form-submit', { id: f.id||null, fields: keys }); } }catch(e){}
      }, true);

      // Monitor file inputs
      document.addEventListener('change', (ev)=>{
        try{ const t=ev.target; if(!t) return; if(t.tagName==='INPUT' && t.type==='file'){ const files = Array.from(t.files||[]).map(f=>({name:f.name,size:f.size,type:f.type})); debugLog('file-select', { id: t.id||null, files }); } }catch(e){}
      }, true);

      // Monitor complaints table loads by observing container changes
      const cmpContainer = document.getElementById('complaints-tbody');
      if(cmpContainer){
        const obs = new MutationObserver((muts)=>{ debugLog('complaints-tbody changed', { mutations: muts.length }); });
        obs.observe(cmpContainer, { childList: true, subtree: true, characterData: true });
      }

      debugLog('Enhanced debug panel initialized');
    }catch(e){ console.error('Failed to init debug panel', e); }
  })();

  </script>
 </body>
 </html>
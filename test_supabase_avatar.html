<!DOCTYPE html>
<html>
<head>
    <title>Test Avatar Generation</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>
    <h1>Test Avatar Generation</h1>
    <div>
        <button onclick="testLogin()">1. Login First</button>
        <button onclick="testAvatar()">2. Test Avatar Generation</button>
    </div>
    <pre id="output"></pre>

    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        
        const output = document.getElementById('output');
        
        async function testLogin() {
            output.textContent = 'Logging in...\n';
            
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: 'ben.howard@stoke.nhs.uk',
                password: 'Hello1!'
            });
            
            if (error) {
                output.textContent += 'Login error: ' + error.message + '\n';
            } else {
                output.textContent += 'Login successful!\n';
                output.textContent += 'User: ' + data.user.email + '\n';
                output.textContent += 'Session token available: ' + (!!data.session.access_token) + '\n';
            }
        }
        
        async function testAvatar() {
            output.textContent += '\nTesting avatar generation...\n';
            
            // Check if we're logged in
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (!session) {
                output.textContent += 'ERROR: Not logged in! Click "Login First" button.\n';
                return;
            }
            
            output.textContent += 'Session found, calling generate-avatar function...\n';
            
            const payload = {
                description: "A friendly doctor with glasses and short brown hair",
                options: {
                    "opt-eyes": ["variant01", "variant02", "variant03"],
                    "opt-mouth": ["variant01", "variant02", "variant03"],
                    "opt-hairColor": ["brown", "black", "blonde"],
                    "opt-skinColor": ["light", "medium", "dark"],
                    "opt-backgroundColor": ["b6e3f4", "c7d2fe", "ddd6fe"]
                },
                seedHint: "TestDoctor"
            };
            
            try {
                const { data, error } = await supabaseClient.functions.invoke('generate-avatar', { 
                    body: payload 
                });
                
                if (error) {
                    output.textContent += 'ERROR: ' + JSON.stringify(error, null, 2) + '\n';
                    
                    // Log more details
                    if (error.context) {
                        output.textContent += 'Context: ' + JSON.stringify(error.context, null, 2) + '\n';
                    }
                } else {
                    output.textContent += 'SUCCESS!\n';
                    output.textContent += 'Avatar data: ' + JSON.stringify(data, null, 2) + '\n';
                }
            } catch (e) {
                output.textContent += 'EXCEPTION: ' + e.message + '\n';
                output.textContent += 'Stack: ' + e.stack + '\n';
            }
        }
    </script>
</body>
</html>
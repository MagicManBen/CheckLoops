<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoops ‚Ä¢ Smart Setup</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a1f4a;
      --bg2: #0c2a67;
      --panel: #0f2f73;
      --ink: #eaf1ff;
      --muted: #b5c3e6;
      --nhs: #005EB8;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --border: #ffffff22;
      --card1: #0e2c6e;
      --card2: #0b245a;
      --shadow: 0 20px 50px rgba(0, 0, 0, .45);
      --glow: #60a5fa;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      color: var(--ink);
      background: radial-gradient(1200px 800px at 20% -10%, #1a4fcc66 0%, transparent 60%),
                  radial-gradient(1200px 800px at 100% 10%, #0ea5e955 0%, transparent 60%),
                  linear-gradient(160deg, var(--bg), var(--bg2));
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow-x: hidden;
    }

    /* Navigation */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: saturate(140%) blur(8px);
      background: linear-gradient(180deg, rgba(10, 24, 60, .85), rgba(10, 24, 60, .60));
      border-bottom: 1px solid var(--border);
    }

    .nav {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
    }

    .brand .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7dd3fc, #60a5fa);
      box-shadow: 0 0 20px #60a5fa99;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .navfill {
      flex: 1;
    }

    /* Progress Steps */
    .stepper {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }

    .step {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: linear-gradient(180deg, #0d2b69, #0a2357);
      transition: all 0.3s;
    }

    .step.active {
      border-color: var(--glow);
      color: #dbeafe;
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
    }

    .step.done {
      border-color: var(--ok);
      color: #bbf7d0;
    }

    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      min-height: calc(100vh - 60px);
    }

    /* Pages */
    .page {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Welcome Page */
    .welcome {
      text-align: center;
      padding: 80px 20px;
    }

    .welcome h1 {
      font-size: 48px;
      font-weight: 800;
      background: linear-gradient(135deg, #60a5fa, #22d3ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 20px;
      animation: slideIn 0.6s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .welcome p {
      font-size: 20px;
      color: var(--muted);
      margin-bottom: 40px;
      animation: slideIn 0.8s ease;
    }

    /* Buttons */
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #0f3b8a, #0c2d6a);
      color: #e6f0ff;
      padding: 14px 28px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-block;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(13, 70, 160, .4);
    }

    .btn.primary {
      background: linear-gradient(180deg, #1e63d0, #134da6);
      border-color: #4b7bd6;
      animation: glow 3s infinite;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.2); }
      50% { box-shadow: 0 0 30px rgba(96, 165, 250, 0.4); }
    }

    .btn.success {
      background: linear-gradient(180deg, #16a34a, #12843f);
      border-color: #2bd47a;
    }

    .btn.ghost {
      background: transparent;
      border-color: var(--border);
    }

    .btn.slim {
      padding: 10px 16px;
      font-size: 13px;
    }

    /* Cards */
    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: linear-gradient(180deg, var(--card1), var(--card2));
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
      animation: floatIn 0.5s ease;
    }

    @keyframes floatIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    /* Search */
    .searchbar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .searchbar input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #0c285f, #0a2252);
      color: #eaf1ff;
      font-size: 16px;
      transition: all 0.3s;
    }

    .searchbar input:focus {
      outline: none;
      border-color: var(--glow);
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.2);
    }

    .searchbar input::placeholder {
      color: #6b82a6;
    }

    /* Results List */
    .list {
      display: grid;
      gap: 12px;
      max-height: 400px;
      overflow: auto;
      padding: 4px;
    }

    .list::-webkit-scrollbar {
      width: 8px;
    }

    .list::-webkit-scrollbar-track {
      background: #0a1633;
      border-radius: 4px;
    }

    .list::-webkit-scrollbar-thumb {
      background: #1f3a6e;
      border-radius: 4px;
    }

    .item {
      background: linear-gradient(180deg, #102f74, #0b255a);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .item:hover {
      transform: translateX(4px);
      border-color: var(--glow);
      box-shadow: 0 10px 24px rgba(13, 70, 160, .25);
    }

    .item.selected {
      border-color: var(--ok);
      background: linear-gradient(180deg, #0f3b7d, #0a2c5f);
    }

    .item strong {
      font-size: 15px;
      display: block;
      margin-bottom: 4px;
    }

    .item small {
      color: var(--muted);
      font-size: 13px;
    }

    /* Loading Animation */
    .loading {
      text-align: center;
      padding: 60px 20px;
    }

    .spinner {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      border: 3px solid var(--border);
      border-top-color: var(--glow);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 18px;
      color: var(--muted);
      animation: pulse 1.5s ease infinite;
    }

    /* Progress Bar */
    .progress-bar {
      height: 6px;
      background: #0a1633;
      border-radius: 3px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #60a5fa, #22d3ee);
      border-radius: 3px;
      transition: width 0.5s ease;
      animation: shimmer 2s linear infinite;
    }

    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    /* Meta Info */
    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px 16px;
      font-size: 14px;
    }

    .kv div {
      padding: 8px 0;
      border-bottom: 1px dashed #ffffff20;
    }

    .kv div:first-child {
      color: var(--muted);
    }

    /* Stack */
    .stack {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* Pills */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(180deg, #0e2c6e, #0b245a);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
    }

    .status.ok { border-color: var(--ok); color: #bbf7d0; }
    .status.warn { border-color: var(--warn); color: #ffecb3; }
    .status.err { border-color: var(--err); color: #fecaca; }

    /* Status Badge */
    #apiStatus {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 40;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Debug Panel */
    .debug-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 300px;
      background: rgba(10, 22, 51, 0.98);
      border-top: 1px solid var(--border);
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 45;
    }

    .debug-panel.open {
      transform: translateY(0);
    }

    .debug-toggle {
      position: fixed;
      bottom: 30px;
      left: 30px;
      background: linear-gradient(180deg, #0e2c6e, #0b245a);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      z-index: 46;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      background: #0a1633;
      color: #d6e4ff;
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #1f2b52;
      max-height: 250px;
      overflow: auto;
    }

    .checkbox-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }

    /* Animations for data import */
    .import-animation {
      display: flex;
      justify-content: center;
      gap: 40px;
      padding: 40px 0;
    }

    .import-step {
      text-align: center;
      opacity: 0.3;
      transition: opacity 0.5s;
    }

    .import-step.active {
      opacity: 1;
    }

    .import-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0e2c6e, #0b245a);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      position: relative;
    }

    .import-step.active .import-icon {
      border-color: var(--glow);
      animation: pulse 1.5s infinite;
    }

    .import-step.done .import-icon {
      border-color: var(--ok);
      background: linear-gradient(135deg, #16a34a33, #12843f33);
    }

    .completion {
      text-align: center;
      padding: 60px 20px;
    }

    .completion .checkmark {
      width: 100px;
      height: 100px;
      margin: 0 auto 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, #16a34a, #12843f);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      animation: scaleIn 0.5s ease;
    }

    @keyframes scaleIn {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stepper {
        display: none;
      }

      .welcome h1 {
        font-size: 32px;
      }

      .import-animation {
        flex-direction: column;
        gap: 20px;
      }
    }
  </style>
  <!--
    IMPORTANT ‚ö†Ô∏è
    - Do NOT paste your Supabase SERVICE KEY in this file. It must never be shipped to browsers.
    - This page uses only the Supabase ANON (publishable) key.
    - CQC/NHS calls are attempted directly. If you hit CORS/rate limits, create a Supabase Edge Function
      and call it from here (we include an optional attempt below).
  -->
</head>
<body>
  <!-- Navigation -->
  <header>
    <div class="nav">
      <div class="brand">
        <span class="dot"></span>
        CheckLoops ‚Ä¢ Smart Setup
      </div>
      <div class="navfill"></div>
      <div class="stepper">
        <span class="step active" id="step1">Welcome</span>
        <span class="step" id="step2">Search</span>
        <span class="step" id="step3">Select</span>
        <span class="step" id="step4">Import</span>
        <span class="step" id="step5">Complete</span>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Page 1: Welcome -->
    <div class="page active" id="page1">
      <div class="welcome">
        <h1>Welcome to Smart Setup</h1>
        <p>Let's set up your GP practice in just a few steps</p>
        <button class="btn primary" onclick="goToPage(2)">Get Started ‚Üí</button>
      </div>
    </div>

    <!-- Page 2: Search -->
    <div class="page" id="page2">
      <div class="card">
        <h2>üîç Find Your GP Practice</h2>
        <p style="color: var(--muted); margin-bottom: 20px;">Search for your practice by name or location</p>
        <div class="searchbar">
          <input id="q" placeholder="Enter practice name (e.g., Manchester)" />
          <button class="btn primary" id="go">Search</button>
        </div>
        <div class="checkbox-wrapper">
          <input type="checkbox" id="odsOnly" />
          <label for="odsOnly">Only show practices with ODS codes</label>
        </div>
        <div id="searchStatus" style="margin-top: 20px; display: none;">
          <div class="loading">
            <div class="spinner"></div>
            <div class="loading-text">Searching...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Page 3: Select -->
    <div class="page" id="page3">
      <div class="card">
        <h2>üìç Select Your Practice</h2>
        <p style="color: var(--muted); margin-bottom: 20px;">Choose from the search results below</p>
        <div id="results" class="list"></div>
        <div style="margin-top: 20px; display: flex; gap: 12px;">
          <button class="btn ghost" onclick="goToPage(2)">‚Üê Back to Search</button>
        </div>
      </div>
    </div>

    <!-- Page 4: Import -->
    <div class="page" id="page4">
      <div class="card">
        <h2>üì• Import Practice Data</h2>
        <div id="selectedPractice" style="margin-bottom: 30px;">
          <div id="meta" class="kv"></div>
        </div>

        <div class="import-animation">
          <div class="import-step" id="import-cqc">
            <div class="import-icon">üè•</div>
            <div>CQC Data</div>
          </div>
          <div class="import-step" id="import-nhs">
            <div class="import-icon">üíä</div>
            <div>NHS ODS</div>
          </div>
          <div class="import-step" id="import-save">
            <div class="import-icon">üíæ</div>
            <div>Save to DB</div>
          </div>
        </div>

        <div class="progress-bar">
          <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
        </div>

        <div style="margin-top: 30px; text-align: center;">
          <button class="btn success" id="btnFetchBoth">Start Import</button>
          <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
            <button class="btn slim ghost" id="btnReload">‚Üª Reload</button>
            <button class="btn slim" id="btnFetchCQC">CQC Only</button>
            <button class="btn slim" id="btnFetchODS">NHS Only</button>
          </div>
        </div>
      </div>

      <div class="loading" id="loadingIndicator" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Fetching data...</div>
      </div>
    </div>

    <!-- Page 5: Complete -->
    <div class="page" id="page5">
      <div class="completion">
        <div class="checkmark">‚úì</div>
        <h2 style="font-size: 32px; margin-bottom: 20px;">Setup Complete!</h2>
        <p style="color: var(--muted); font-size: 18px; margin-bottom: 40px;">Your GP practice has been successfully configured</p>
        <div style="display: flex; gap: 16px; justify-content: center;">
          <button class="btn primary" onclick="location.reload()">Setup Another Practice</button>
          <button class="btn ghost" onclick="window.location.href='/'">Go to Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Badge -->
  <div id="apiStatus" class="pill status warn" style="position: fixed; bottom: 30px; right: 30px; display: none;">
    <span>Idle</span>
  </div>

  <!-- Debug Panel -->
  <div class="debug-toggle" onclick="toggleDebug()">üîß</div>
  <div class="debug-panel" id="debugPanel">
    <div style="padding: 20px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <strong>Debug Console</strong>
        <button class="btn slim ghost" onclick="toggleDebug()">Close</button>
      </div>
      <div id="raw" class="mono" style="margin-bottom: 10px;">No data yet.</div>
      <div id="log" class="mono"></div>
    </div>
  </div>

<script>
  // ===== Config (client-safe) =====
  const SUPABASE_URL = 'https://unveoqnlqnobufhublyw.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_wpy7lxfbI2HwvsznlWJVKg_Zx7HnAc4';
  const TABLE = 'CQC All GPs'; // exact name in your DB
  const EDGE_FN = 'fetch-nhs-data-complete'; // optional: if you already have it deployed

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const el = (id)=>document.getElementById(id);
  const logEl = el('log');
  function log(msg, data){
    const time = new Date().toISOString().replace('T',' ').replace('Z','');
    logEl.textContent += `\n[${time}] ${msg}`;
    if(data){ logEl.textContent += `\n  ${JSON.stringify(data,null,2).split('\n').join('\n  ')}`; }
    logEl.scrollTop = logEl.scrollHeight;
  }
  function setRaw(obj){ el('raw').textContent = JSON.stringify(obj, null, 2); }
  function setStatus(txt, cls='warn'){
    const badge = el('apiStatus');
    badge.textContent = txt;
    badge.className = `pill status ${cls}`;
    badge.style.display = 'block';
    setTimeout(() => {
      if (badge.textContent === txt) {
        badge.style.display = 'none';
      }
    }, 5000);
  }

  let current = null; // { location_id, provider_id, ods_code?, row? }
  let currentPage = 1;

  // ===== Page Navigation =====
  function goToPage(pageNum) {
    // Hide all pages
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

    // Show the selected page
    el('page' + pageNum).classList.add('active');

    // Update steps
    document.querySelectorAll('.step').forEach((s, i) => {
      s.classList.remove('active', 'done');
      if (i + 1 < pageNum) {
        s.classList.add('done');
      } else if (i + 1 === pageNum) {
        s.classList.add('active');
      }
    });

    currentPage = pageNum;

    // Focus search input when on search page
    if (pageNum === 2) {
      setTimeout(() => el('q').focus(), 100);
    }
  }

  // ===== Search with Animation =====
  async function search(){
    const q = el('q').value.trim();
    if(!q){ return; }

    // Show loading animation
    el('searchStatus').style.display = 'block';

    setStatus('Searching‚Ä¶');

    // Build query
    let query = supabase.from(TABLE)
      .select('location_id, location_name, postcode, region, ods_code, provider_id')
      .ilike('location_name', `%${q}%`)
      .limit(20);

    if(el('odsOnly').checked){ query = query.not('ods_code','is',null).neq('ods_code',''); }

    const { data, error } = await query;

    // Hide loading animation
    el('searchStatus').style.display = 'none';

    if(error){
      setStatus('Search failed', 'err');
      log('Search failed', error);
      return;
    }

    setStatus(`Found ${data.length} results`, 'ok');
    renderResults(data);

    if (data.length > 0) {
      goToPage(3);
    }
  }

  function renderResults(rows){
    const list = el('results');
    if(!rows.length){
      list.innerHTML = '<div class="item"><small>No matches found. Try a different search term.</small></div>';
      return;
    }
    list.innerHTML = '';
    rows.forEach(r=>{
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div><strong>${r.location_name}</strong><br/><small>${r.region||'‚Äî'} ¬∑ ${r.postcode||'‚Äî'}</small></div><div><small>${r.ods_code?('ODS '+r.ods_code):''}</small></div>`;
      div.onclick = ()=>selectPractice(r.location_id);
      list.appendChild(div);
    });
  }

  // ===== Load + show one row =====
  async function selectPractice(location_id){
    setStatus('Loading practice...');
    const { data, error } = await supabase.from(TABLE).select('*').eq('location_id', location_id).single();
    if(error){ setStatus('Load failed', 'err'); log('Load failed', error); return; }

    current = {
      location_id: data.location_id,
      provider_id: data.provider_id || null,
      ods_code: data.ods_code || null,
      row: data
    };

    setStatus('Practice loaded', 'ok');
    renderMeta(data);
    setRaw({ saved_row: data });
    goToPage(4);
  }

  function renderMeta(row){
    const m = el('meta');
    const addr = [row.address_line_1,row.address_line_2,row.town_city,row.postcode].filter(Boolean).join(', ');
    m.innerHTML = ''+
      kv('Location name', row.location_name) +
      kv('Location ID', row.location_id) +
      kv('Provider ID', row.provider_id||'‚Äî') +
      kv('ODS code', row.ods_code||'‚Äî') +
      kv('Phone', row.main_phone_number||'‚Äî') +
      kv('Website', row.website||'‚Äî') +
      kv('Address', addr||'‚Äî') +
      kv('Region', row.region||'‚Äî') +
      kv('Last NHS update', row.last_nhs_update? String(row.last_nhs_update).replace('T',' ').split('.')[0] : '‚Äî');
  }
  function kv(k,v){ return `<div style="color:var(--muted)">${k}</div><div>${v??'‚Äî'}</div>`; }

  // ===== CQC fetch with animations =====
  async function fetchCQC(){
    if(!current){ return; }
    const locId = current.location_id;
    const provId = current.provider_id;

    setStatus('Fetching CQC‚Ä¶');
    animateImportStep('import-cqc', 'active');
    updateProgressBar(20);

    try{
      // Try Edge Function first (if present)
      const viaEdge = await tryEdge({ location_id: locId, provider_id: provId, ods_code: current.ods_code||null, data_sources:['cqc'] });
      if(viaEdge){ await afterCqc(viaEdge); return; }

      // Fallback: direct CQC API (public)
      const loc = await fetchJson(`https://api.cqc.org.uk/public/v1/locations/${encodeURIComponent(locId)}`);
      let prov = null;
      if(provId){ prov = await fetchJson(`https://api.cqc.org.uk/public/v1/providers/${encodeURIComponent(provId)}`); }
      const payload = { location: loc, provider: prov };
      await afterCqc({ data: payload });
    }catch(e){
      setStatus('CQC error', 'err');
      log('CQC fetch error', String(e));
      animateImportStep('import-cqc', '');
    }
  }

  async function afterCqc(resp){
    const cqc = resp?.data || resp; // support both shapes
    setRaw({ cqc });
    const update = buildUpdateFromCqc(cqc);
    await saveUpdate(update);

    // refresh current
    await selectPractice(current.location_id);
    setStatus('CQC saved', 'ok');
    animateImportStep('import-cqc', 'done');
    updateProgressBar(40);
  }

  function buildUpdateFromCqc(cqc){
    if(!cqc) return {};
    const loc = cqc.location || cqc.cqc_location || cqc.Location || cqc || null;
    const prov = cqc.provider || cqc.cqc_provider || cqc.Provider || null;

    const pick = (a,b,c)=> a!==undefined ? a : (b!==undefined ? b : c);
    const ratingObj = loc?.currentRatings||null;

    const telecomPhone = null; // CQC payloads rarely carry telecom arrays

    return compact({
      location_source: loc ? JSON.stringify(loc) : undefined,
      provider_source: prov ? JSON.stringify(prov) : undefined,

      location_name: pick(loc?.name, prov?.name, undefined),
      provider_name: pick(prov?.name, undefined, undefined),
      provider_id: pick(loc?.providerId, prov?.providerId, undefined),
      organisation_type: pick(loc?.organisationType, undefined, undefined),
      location_type: pick(loc?.type, undefined, undefined),
      region: pick(loc?.region, undefined, undefined),

      address_line_1: pick(loc?.postalAddressLine1, undefined, undefined),
      address_line_2: pick(loc?.postalAddressLine2, undefined, undefined),
      town_city: pick(loc?.postalAddressTownCity, undefined, undefined),
      postcode: pick(loc?.postalCode, undefined, undefined),
      uprn: pick(loc?.uprn, undefined, undefined),
      latitude: (loc?.onspdLatitude!=null)? String(loc.onspdLatitude) : undefined,
      longitude:(loc?.onspdLongitude!=null)? String(loc.onspdLongitude): undefined,
      main_phone_number: pick(loc?.mainPhoneNumber, prov?.mainPhoneNumber, telecomPhone||undefined),
      website: pick(loc?.website, prov?.website, undefined),

      onspd_ccg_code: pick(loc?.onspdCcgCode, undefined, undefined),
      onspd_ccg_name: pick(loc?.onspdCcgName, undefined, undefined),
      onspd_icb_code: pick(loc?.onspdIcbCode, undefined, undefined),
      onspd_icb_name: pick(loc?.onspdIcbName, undefined, undefined),
      ods_ccg_code: pick(loc?.odsCcgCode, undefined, undefined),
      ods_ccg_name: pick(loc?.odsCcgName, undefined, undefined),

      overall_rating: ratingObj?.overall?.rating,
      last_inspection_date: pick(loc?.lastInspection?.date, undefined, undefined),
      last_report_date: pick(loc?.lastReport?.publicationDate, undefined, undefined),

      regulated_activities: loc?.regulatedActivities ? JSON.stringify(loc.regulatedActivities) : undefined,
      inspection_areas: loc?.inspectionAreas ? JSON.stringify(loc.inspectionAreas) : undefined,
      inspection_categories: loc?.inspectionCategories ? JSON.stringify(loc.inspectionCategories) : undefined,
      gac_service_types: loc?.gacServiceTypes ? JSON.stringify(loc.gacServiceTypes) : undefined,
      specialisms: loc?.specialisms ? JSON.stringify(loc.specialisms) : undefined,

      provider_website: prov?.website,
      provider_main_phone_number: prov?.mainPhoneNumber,
      provider_registration_status: prov?.registrationStatus,
      provider_registration_date: prov?.registrationDate,
      ownership_type: prov?.ownershipType,
      provider_region: prov?.region,
      provider_address_line_1: prov?.postalAddressLine1,
      provider_address_line_2: prov?.postalAddressLine2,
      provider_town_city: prov?.postalAddressTownCity,
      provider_postcode: prov?.postalCode,
      provider_location_ids: prov?.locationIds ? JSON.stringify(prov.locationIds) : undefined,
      provider_inspection_areas: prov?.inspectionAreas ? JSON.stringify(prov.inspectionAreas) : undefined,

      ods_code: normalizeOds(loc?.odsCode),
      updated_at: new Date().toISOString(),
    });
  }

  // ===== NHS ODS fetch with animations =====
  async function fetchODS(){
    if(!current){ return; }
    setStatus('Fetching NHS ODS‚Ä¶');
    animateImportStep('import-nhs', 'active');
    updateProgressBar(60);

    try{
      // Try Edge Function first (if present)
      const viaEdge = await tryEdge({ location_id: current.location_id, ods_code: current.ods_code||null, data_sources:['ods'] });
      if(viaEdge){ await afterOds(viaEdge); return; }

      let odsData = null;
      if(current.ods_code){
        odsData = await fetchJson(`https://directory.spineservices.nhs.uk/ORD/2-0-0/organisations/${encodeURIComponent(current.ods_code)}`);
      } else if(current.row){
        // Fallback: search by name (coarse)
        const name = encodeURIComponent(current.row.location_name);
        const list = await fetchJson(`https://directory.spineservices.nhs.uk/ORD/2-0-0/organisations?Name=${name}`);
        odsData = Array.isArray(list?.organisations) ? list.organisations[0] || null : list || null;
      }
      await afterOds({ data: { ods_data: odsData } });
    }catch(e){
      setStatus('NHS error', 'err');
      log('NHS fetch error', String(e));
      animateImportStep('import-nhs', '');
    }
  }

  async function afterOds(resp){
    const ods = resp?.data?.ods_data || resp?.data || resp || null;
    setRaw({ ods });
    const update = buildUpdateFromOds(ods);
    await saveUpdate(update);
    await selectPractice(current.location_id);
    setStatus('NHS saved', 'ok');
    animateImportStep('import-nhs', 'done');
    updateProgressBar(80);
  }

  function buildUpdateFromOds(ods){
    if(!ods) return {};
    // Flexible extraction (the ORD API can return {identifier:{value}}, or arrays, etc.)
    let ident = '';
    if(ods.identifier?.value){ ident = ods.identifier.value; }
    else if(Array.isArray(ods.identifier)){ const m = ods.identifier.find(x=>String(x.system||'').toLowerCase().includes('ods')); ident = m?.value || ods.identifier[0]?.value || ''; }
    else if(typeof ods.identifier==='string'){ ident = ods.identifier; }
    else if(ods.code){ ident = ods.code; }

    const telecom = Array.isArray(ods.telecom)? ods.telecom : [];
    const phone = telecom.find(t=>String(t.system||'').toLowerCase()==='phone')?.value || null;
    const url = telecom.find(t=>String(t.system||'').toLowerCase()==='url')?.value || (ods.website||null);

    const addr = Array.isArray(ods.address)? ods.address[0] : (ods.address||null);
    const line = Array.isArray(addr?.line)? addr.line : [];

    return compact({
      nhs_ods_data: JSON.stringify(ods),
      last_nhs_update: new Date().toISOString(),
      ods_code: normalizeOds(ident)||undefined,
      main_phone_number: phone||undefined,
      website: url||undefined,
      address_line_1: addr?.line1 || line[0] || addr?.addressLine1 || undefined,
      address_line_2: addr?.line2 || line[1] || addr?.addressLine2 || undefined,
      town_city: addr?.city || addr?.town || addr?.postalAddressTownCity || undefined,
      postcode: addr?.postalCode || addr?.postcode || undefined,
      region: ods.region || undefined,
      location_name: ods.name || undefined,
      updated_at: new Date().toISOString(),
    });
  }

  // ===== Save helper with animation =====
  async function saveUpdate(update){
    if(!current) return;
    const clean = compact(update);
    if(!Object.keys(clean).length){ log('Nothing to update'); return; }

    animateImportStep('import-save', 'active');

    const { data, error } = await supabase.from(TABLE).update(clean).eq('location_id', current.location_id).select('*');

    if(error){
      setStatus('Save failed','err');
      log('Save failed', error);
      animateImportStep('import-save', '');
      return;
    }

    log('Saved', { keys: Object.keys(clean) });
    animateImportStep('import-save', 'done');
    updateProgressBar(100);
    return data?.[0] || null;
  }

  // ===== Utilities =====
  async function fetchJson(url){
    const res = await fetch(url);
    if(!res.ok){ throw new Error(`${res.status} ${res.statusText}`); }
    return await res.json();
  }
  function compact(obj){ const out={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; if(v!==undefined) out[k]=v; }); return out; }
  function normalizeOds(c){ if(!c) return ''; const u=String(c).trim().toUpperCase(); return /^[A-Z0-9]{3,8}$/.test(u)?u:''; }

  async function tryEdge(body){
    try{
      const { data, error } = await supabase.functions.invoke(EDGE_FN, { body });
      if(error){ log('Edge function error (ignored)', error); return null; }
      if(data){ setRaw({ edge_response:data }); return data; }
      return null;
    }catch(e){ log('Edge function call failed (ignored)', String(e)); return null; }
  }

  // ===== Animation helpers =====
  function animateImportStep(stepId, status) {
    const step = el(stepId);
    if (!step) return;

    step.classList.remove('active', 'done');
    if (status) {
      step.classList.add(status);
    }
  }

  function updateProgressBar(percent) {
    el('progressBar').style.width = percent + '%';

    if (percent === 100) {
      setTimeout(() => {
        goToPage(5);
      }, 1000);
    }
  }

  // ===== Debug Panel =====
  function toggleDebug() {
    el('debugPanel').classList.toggle('open');
  }

  // ===== Fetch both with animation sequence =====
  const originalFetchBoth = async function() {
    // Reset all animations
    ['import-cqc', 'import-nhs', 'import-save'].forEach(id => {
      animateImportStep(id, '');
    });
    updateProgressBar(0);

    await fetchCQC();
    await fetchODS();
  };

  // ===== Wire up =====
  el('go').onclick = search;
  el('q').addEventListener('keydown', e=>{ if(e.key==='Enter') search(); });
  el('btnReload').onclick = ()=> current && selectPractice(current.location_id);
  el('btnFetchCQC').onclick = fetchCQC;
  el('btnFetchODS').onclick = fetchODS;
  el('btnFetchBoth').onclick = originalFetchBoth;

  // Focus search on load
  window.addEventListener('load', ()=>{
    if (currentPage === 2) {
      el('q').focus();
    }
  });
</script>
</body>
</html>
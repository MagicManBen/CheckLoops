<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Staff Calendar — CheckLoops" />
  <meta name="theme-color" content="#0b4fb3" />
  <title>Staff Calendar — CheckLoops</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://*.supabase.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' https://*.supabase.co https://*.supabase.com wss://*.supabase.co wss://*.supabase.com https:;">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="supabase-js.js"></script>
  <link rel="stylesheet" href="staff-nav.css">
  <script src="staff-nav.js"></script>
  <script src="staff-common.js"></script>

  <style>
    :root {
      --primary: #0b4fb3;
      --primary-dark: #062b6f;
      --primary-light: #2b6ecc;
      --primary-lightest: #e8f2ff;
      --accent: #76a7ff;
      --accent-2: #5f96ff;
      --success: #2bd4a7;
      --success-light: #e8fdf8;
      --warning: #ffca28;
      --warning-light: #fffbeb;
      --danger: #ff6b6b;
      --danger-light: #fef2f2;
      --white: #ffffff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
      --radius-sm: 0.375rem;
      --radius: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
      --font-display: 'Plus Jakarta Sans', 'Inter', sans-serif;
      --transition: all 0.2s ease-in-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: var(--font-sans);
      background: linear-gradient(135deg, #e8f2ff 0%, #ffffff 100%) !important;
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--gray-900);
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="%23e2e8f0" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>') !important;
      opacity: 0.3;
      z-index: -1;
      pointer-events: none;
    }

    .page-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      flex: 1;
      position: relative;
      z-index: 1;
    }

    .calendar-header {
      background: var(--white);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .calendar-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--gray-900);
      font-family: var(--font-display);
      margin-bottom: 1rem;
    }

    .calendar-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .week-navigation {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .week-display {
      font-weight: 600;
      color: var(--gray-700);
      padding: 0.5rem 1rem;
      background: var(--gray-100);
      border-radius: var(--radius);
      min-width: 200px;
      text-align: center;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .btn:hover {
      background: var(--gray-200);
    }

    .btn.primary {
      background: var(--primary);
      color: white;
    }

    .btn.primary:hover {
      background: var(--primary-dark);
    }

    .filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--gray-300);
      background: var(--white);
      color: var(--gray-700);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .filter-select:hover {
      border-color: var(--gray-400);
    }

    .calendar-container {
      background: var(--white);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      padding: 1.5rem;
      overflow-x: auto;
    }

    .calendar-grid {
      width: 100%;
      min-width: 800px;
    }

    .calendar-grid table {
      width: 100%;
      border-collapse: collapse;
    }

    .calendar-grid th {
      background: var(--gray-50);
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--gray-700);
      border-bottom: 2px solid var(--gray-200);
      font-size: 0.875rem;
    }

    .calendar-grid th.day-header {
      text-align: center;
      min-width: 120px;
    }

    .calendar-grid th.today {
      background: var(--primary-lightest);
      color: var(--primary);
    }

    .calendar-grid td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle;
    }

    .staff-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 180px;
    }

    .staff-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .staff-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .staff-details {
      flex: 1;
    }

    .staff-name {
      font-weight: 600;
      color: var(--gray-900);
      font-size: 0.875rem;
    }

    .staff-role {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    .day-cell {
      text-align: center;
      padding: 0.5rem;
      min-height: 50px;
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-working {
      background: var(--success-light);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .status-holiday {
      background: var(--warning-light);
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    .status-off {
      background: var(--gray-100);
      color: var(--gray-500);
      border: 1px solid var(--gray-300);
    }

    .status-session {
      background: var(--primary-lightest);
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .time-display {
      font-size: 0.75rem;
      color: var(--gray-600);
      margin-top: 0.25rem;
    }

    .summary-row {
      background: var(--gray-50);
      font-weight: 600;
    }

    .summary-row td {
      padding: 1rem 0.75rem;
      border-top: 2px solid var(--gray-200);
    }

    .summary-count {
      text-align: center;
      color: var(--primary);
      font-size: 1rem;
    }

    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
      color: var(--gray-500);
    }

    .legend {
      display: flex;
      gap: 2rem;
      margin-top: 1.5rem;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: var(--radius);
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .legend-indicator {
      width: 20px;
      height: 20px;
      border-radius: 999px;
    }

    @media (max-width: 768px) {
      .content {
        padding: 1rem;
      }

      .calendar-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .week-navigation {
        justify-content: center;
      }

      .filters {
        justify-content: center;
      }

      .calendar-container {
        padding: 1rem;
      }

      .staff-info {
        min-width: auto;
      }

      .day-cell {
        padding: 0.25rem;
      }

      .status-badge {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
      }
    }

    @media print {
      body {
        background: white !important;
      }

      body::before {
        display: none;
      }

      .navbar {
        display: none;
      }

      .btn {
        display: none;
      }

      .filters {
        display: none;
      }

      .calendar-container {
        box-shadow: none;
        border: 1px solid #000;
      }

      .legend {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body style="visibility: hidden;">
  <div class="page-container">
    <div id="navbar-root"></div>

    <div class="content">
      <div class="calendar-header">
        <h1 class="calendar-title">Staff Calendar</h1>
        <div class="calendar-controls">
          <div class="week-navigation">
            <button class="btn" id="prev-week-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
              Previous
            </button>
            <div class="week-display" id="week-display">Loading...</div>
            <button class="btn" id="next-week-btn">
              Next
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
            <button class="btn primary" id="today-btn">Today</button>
          </div>
          <div class="filters">
            <select class="filter-select" id="site-filter">
              <option value="all">All Sites</option>
            </select>
            <select class="filter-select" id="role-filter">
              <option value="all">All Roles</option>
              <option value="gp">GPs</option>
              <option value="nurse">Nurses</option>
              <option value="admin">Admin</option>
              <option value="reception">Reception</option>
              <option value="other">Other</option>
            </select>
            <button class="btn" id="print-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
              </svg>
              Print
            </button>
          </div>
        </div>
      </div>

      <div class="calendar-container">
        <div class="calendar-grid" id="calendar-grid">
          <div class="loading-spinner">
            <div>Loading calendar...</div>
          </div>
        </div>

        <div class="legend">
          <div class="legend-item">
            <div class="legend-indicator status-working"></div>
            <span>Working/In</span>
          </div>
          <div class="legend-item">
            <div class="legend-indicator status-holiday"></div>
            <span>Holiday</span>
          </div>
          <div class="legend-item">
            <div class="legend-indicator status-session"></div>
            <span>Session (GP)</span>
          </div>
          <div class="legend-item">
            <div class="legend-indicator status-off"></div>
            <span>Not Scheduled</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      initSupabase,
      requireStaffSession,
      getSiteText,
      setTopbar,
      handleAuthState,
      navActivate,
      attachLogout
    } from './staff-common.js';

    let supabase;
    let currentWeekStart;
    let staffData = [];
    let holidayData = [];
    let sitesData = [];
    let currentFilters = {
      site: 'all',
      role: 'all'
    };
    let currentUser = null;
    let profileRow = null;

    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const dayFields = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];

    async function initializeCalendar() {
      try {
        console.debug('[staff-calendar] Initializing...');

        // Initialize Supabase with proper session persistence
        supabase = await initSupabase();
        window.supabase = supabase;
        console.debug('[staff-calendar] Supabase initialized');

        // Handle auth state changes
        handleAuthState(supabase);

        // Render navigation if available
        if (typeof window.renderStandardStaffNav === 'function') {
          window.renderStandardStaffNav('staff-calendar.html');
        }

        // Set active nav item
        navActivate('calendar');

        // Attach logout handler
        attachLogout(supabase);

        // Require authenticated session
        const { session, profileRow: profile } = await requireStaffSession(supabase);
        console.debug('[staff-calendar] Session verified', session?.user?.id, profile);
        // Auth successful - show page
        document.body.style.visibility = 'visible';

        profileRow = profile;
        const user = session.user;

        // Setup user info
        currentUser = {
          id: user.id,
          email: user.email,
          full_name: profileRow?.full_name || user?.raw_user_meta_data?.full_name || user.email.split('@')[0],
          role: profileRow?.role || user?.raw_user_meta_data?.role || 'Staff',
          site_id: profileRow?.site_id || user?.raw_user_meta_data?.site_id || null,
          access_type: profileRow?.access_type || user?.raw_user_meta_data?.access_type || null
        };

        // Set topbar with user info
        setTopbar({
          siteText: await getSiteText(supabase, currentUser.site_id),
          email: currentUser.email,
          role: currentUser.role,
          access_type: currentUser.access_type
        });

        // Show admin portal button if admin
        const adminRole = (currentUser.access_type || currentUser.role || '').toLowerCase();
        const adminPortalBtn = document.getElementById('adminPortalBtn');
        if (adminPortalBtn) {
          if (adminRole === 'admin' || adminRole === 'owner') {
            adminPortalBtn.style.display = 'inline-flex';
          } else {
            adminPortalBtn.style.display = 'none';
          }
        }

        // Set default site filter to user's site
        if (currentUser.site_id) {
          currentFilters.site = currentUser.site_id;
        }

        // Load calendar data
        await loadSites();
        initializeWeek();
        await loadCalendarData();
        setupEventListeners();

        // Auto-refresh every 5 minutes
        setInterval(() => loadCalendarData(), 5 * 60 * 1000);

        console.debug('[staff-calendar] Initialization complete');
      } catch (error) {
        console.error('[staff-calendar] Initialization error:', error);
        if (error.message === 'NO_SESSION') {
          window.location.href = 'home.html';
        }
      }
    }

    async function loadSites() {
      try {
        const { data: sites } = await supabase
          .from('sites')
          .select('id, name, city');

        if (sites && sites.length > 0) {
          sitesData = sites;
          const siteFilter = document.getElementById('site-filter');
          sites.forEach(site => {
            const option = document.createElement('option');
            option.value = site.id;
            option.textContent = `${site.name}${site.city ? ' - ' + site.city : ''}`;
            siteFilter.appendChild(option);
          });

          // Set the user's site as selected if they have one
          if (currentUser.site_id) {
            siteFilter.value = currentUser.site_id;
          }
        }
      } catch (error) {
        console.error('Error loading sites:', error);
      }
    }

    function initializeWeek() {
      const today = new Date();
      const dayOfWeek = today.getDay();
      currentWeekStart = new Date(today);
      currentWeekStart.setDate(today.getDate() - dayOfWeek);
      currentWeekStart.setHours(0, 0, 0, 0);
      updateWeekDisplay();
    }

    function updateWeekDisplay() {
      const weekEnd = new Date(currentWeekStart);
      weekEnd.setDate(currentWeekStart.getDate() + 6);

      const startStr = currentWeekStart.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
      const endStr = weekEnd.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

      document.getElementById('week-display').textContent = `${startStr} - ${endStr}`;
    }

    async function loadCalendarData() {
      try {
        // Show loading state
        document.getElementById('calendar-grid').innerHTML = '<div class="loading-spinner"><div>Loading calendar...</div></div>';

        // Calculate week range
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(currentWeekStart.getDate() + 6);

        const startStr = currentWeekStart.toISOString().split('T')[0];
        const endStr = weekEnd.toISOString().split('T')[0];

        // Load staff data with working patterns
        let staffQuery = supabase
          .from('master_users')
          .select(`
            id, auth_user_id, full_name, nickname, avatar_url, role, role_detail, is_gp, site_id,
            sunday_hours, sunday_sessions, monday_hours, monday_sessions,
            tuesday_hours, tuesday_sessions, wednesday_hours, wednesday_sessions,
            thursday_hours, thursday_sessions, friday_hours, friday_sessions,
            saturday_hours, saturday_sessions
          `)
          .eq('active', true);

        if (currentFilters.site !== 'all') {
          staffQuery = staffQuery.eq('site_id', currentFilters.site);
        }

        const { data: staff } = await staffQuery;
        staffData = staff || [];

        // Filter by role
        if (currentFilters.role !== 'all') {
          staffData = staffData.filter(s => {
            const role = (s.role || '').toLowerCase();
            const roleDetail = (s.role_detail || '').toLowerCase();

            switch (currentFilters.role) {
              case 'gp':
                return s.is_gp || role.includes('gp') || roleDetail.includes('gp');
              case 'nurse':
                return role.includes('nurse') || roleDetail.includes('nurse');
              case 'admin':
                return role.includes('admin') || roleDetail.includes('admin');
              case 'reception':
                return role.includes('reception') || roleDetail.includes('reception');
              default:
                return !s.is_gp && !role.includes('gp') && !role.includes('nurse') &&
                       !role.includes('admin') && !role.includes('reception');
            }
          });
        }

        // Load holiday data
        const { data: holidays } = await supabase
          .from('4_holiday_requests')
          .select('*')
          .eq('status', 'approved')
          .lte('start_date', endStr)
          .gte('end_date', startStr);

        holidayData = holidays || [];

        renderCalendar();
      } catch (error) {
        console.error('Error loading calendar data:', error);
        document.getElementById('calendar-grid').innerHTML = '<div class="loading-spinner"><div>Error loading calendar. Please refresh.</div></div>';
      }
    }

    function renderCalendar() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let html = '<table><thead><tr><th>Staff</th>';

      // Generate day headers
      for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(currentWeekStart.getDate() + i);
        const isToday = date.getTime() === today.getTime();
        const dayName = dayNames[i];
        const dayNum = date.getDate();

        html += `<th class="day-header ${isToday ? 'today' : ''}">
          ${dayName}<br><small>${dayNum}</small>
        </th>`;
      }
      html += '</tr></thead><tbody>';

      // Daily counts for summary
      const dailyCounts = Array(7).fill(0);

      // Render each staff member
      staffData.forEach(staff => {
        html += '<tr>';

        // Staff info cell
        html += '<td><div class="staff-info">';
        html += `<div class="staff-avatar">`;
        if (staff.avatar_url) {
          html += `<img src="${staff.avatar_url}" alt="${staff.full_name}">`;
        } else {
          const initial = staff.full_name ? staff.full_name[0].toUpperCase() : '?';
          html += initial;
        }
        html += '</div>';
        html += '<div class="staff-details">';
        html += `<div class="staff-name">${staff.full_name || staff.nickname || 'Unknown'}</div>`;
        html += `<div class="staff-role">${staff.role_detail || staff.role || 'Staff'}</div>`;
        html += '</div></div></td>';

        // Day cells
        for (let i = 0; i < 7; i++) {
          const date = new Date(currentWeekStart);
          date.setDate(currentWeekStart.getDate() + i);
          const dateStr = date.toISOString().split('T')[0];
          const dayField = dayFields[i];

          // Check for holidays
          const holiday = holidayData.find(h =>
            h.user_id === staff.id &&
            new Date(h.start_date) <= date &&
            new Date(h.end_date) >= date
          );

          html += '<td class="day-cell">';

          if (holiday) {
            html += '<div class="status-badge status-holiday">Holiday</div>';
            if (holiday.type && holiday.type !== 'annual') {
              html += `<div class="time-display">${holiday.type}</div>`;
            }
          } else {
            // Check working hours/sessions
            const hours = staff[`${dayField}_hours`];
            const sessions = staff[`${dayField}_sessions`];

            if (staff.is_gp && sessions) {
              html += '<div class="status-badge status-session">';
              if (typeof sessions === 'object') {
                const sessionList = [];
                if (sessions.am) sessionList.push('AM');
                if (sessions.pm) sessionList.push('PM');
                html += sessionList.join(' & ') || 'Session';
              } else {
                html += 'Session';
              }
              html += '</div>';
              dailyCounts[i]++;
            } else if (hours) {
              html += '<div class="status-badge status-working">Working</div>';
              html += `<div class="time-display">${hours}</div>`;
              dailyCounts[i]++;
            } else {
              html += '<div class="status-badge status-off">—</div>';
            }
          }

          html += '</td>';
        }
        html += '</tr>';
      });

      // Summary row
      html += '<tr class="summary-row">';
      html += '<td><strong>Total Working</strong></td>';
      for (let i = 0; i < 7; i++) {
        html += `<td class="summary-count">${dailyCounts[i]}</td>`;
      }
      html += '</tr>';

      html += '</tbody></table>';

      document.getElementById('calendar-grid').innerHTML = html;
    }

    function setupEventListeners() {
      // Week navigation
      document.getElementById('prev-week-btn').addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        updateWeekDisplay();
        loadCalendarData();
      });

      document.getElementById('next-week-btn').addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        updateWeekDisplay();
        loadCalendarData();
      });

      document.getElementById('today-btn').addEventListener('click', () => {
        initializeWeek();
        loadCalendarData();
      });

      // Filters
      document.getElementById('site-filter').addEventListener('change', (e) => {
        currentFilters.site = e.target.value === 'all' ? 'all' : parseInt(e.target.value);
        loadCalendarData();
      });

      document.getElementById('role-filter').addEventListener('change', (e) => {
        currentFilters.role = e.target.value;
        loadCalendarData();
      });

      // Print button
      document.getElementById('print-btn').addEventListener('click', () => {
        window.print();
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await initializeCalendar();
    });
  </script>
</body>
</html>
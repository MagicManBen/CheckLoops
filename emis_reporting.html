<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>CheckLoops — EMIS Appointment Data</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://*.supabase.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' https://*.supabase.co https://*.supabase.com wss://*.supabase.co wss://*.supabase.com https:;">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="config.js"></script>
<script src="rls-fix.js"></script>
<script src="supabase-js.js"></script>
<script type="module">
  const { createClient } = supabase;
  window.supabaseCreateClient = createClient;
  // Initialize supabase client (minimal, shared-session style)
  const sb = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: false,
    flowType: 'pkce',
    storage: window.localStorage,
    storageKey: `sb-${(CONFIG.SUPABASE_URL||'').split('//')[1]?.split('.')[0] || 'app'}-auth-token`
  }
  });
  window.supabase = sb;
</script>
<style>
    /* --- Welcome flow styling --- */
    .welcome-hero { text-align:center; margin-bottom: 16px; }
    .welcome-hero h1 { font-family: 'Urbanist', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-size: clamp(22px, 3vw, 32px); font-weight: 800; letter-spacing: .2px; color:#0f172a; }
    .welcome-hero .lead { color:#475569; margin: 6px auto 8px; max-width: 700px; }
    .cta-row { display:flex; gap:8px; justify-content:center; margin-top: 6px; }
    .btn-primary.big { 
      padding: 12px 20px; 
      font-size: 15px; 
      border-radius: 10px; 
      font-weight: 700;
      box-shadow: 
        0 6px 16px rgba(37,99,235,.22),
        0 2px 4px rgba(37,99,235,.12),
        inset 0 1px 0 rgba(255,255,255,0.12);
    }
    .btn-ghost { display:inline-flex;align-items:center;gap:6px;min-height:36px;padding:8px 14px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;color:#0f172a;font-weight:600;letter-spacing:.01em;cursor:pointer;transition:transform .15s ease, box-shadow .15s ease; }
    .btn-ghost:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(2,6,23,.06);} 

    .stepper { position:relative; display:grid; grid-template-columns:1fr 10px 1fr 10px 1fr 10px 1fr 10px 1fr; gap:6px; align-items:stretch; margin: 10px 0 12px; }
    .stepper .pipe { width:10px; display:grid; place-items:center; }
    .stepper .pipe::before { display: none; /* Remove vertical blue separator lines */ }
    .stepper .step { 
      background: rgba(255,255,255,.99); 
      border: 1px solid rgba(15,23,42,.06); 
      border-radius: 10px; 
      box-shadow: 
        0 4px 8px rgba(0,0,0,0.03),
        0 8px 16px rgba(0,0,0,0.03),
        0 0 0 1px rgba(0,0,0,0.01);
      padding: 9px 12px; 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      transform: translateY(0); 
      transition: all .18s ease; 
    }
    .stepper .step:hover { 
      transform: translateY(-2px); 
      box-shadow: 
        0 8px 20px rgba(0,0,0,0.05),
        0 14px 26px rgba(0,0,0,0.03),
        0 0 0 1px rgba(0,0,0,0.01);
    }
    .stepper .step .num { 
      flex: 0 0 32px; 
      height: 32px; 
      width: 32px; 
      border-radius: 50%; 
      display: grid; 
      place-items: center; 
      font-weight: 700; 
      color: #fff; 
      background: linear-gradient(180deg,#2563eb,#1d4ed8); 
      box-shadow: 
        0 4px 10px rgba(37,99,235,.2),
        0 1px 3px rgba(37,99,235,.1),
        inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .stepper .step .copy .t { font-weight: 600; color: #0f172a; font-size: 14px; }
    .stepper .step .copy .d { color: #64748b; font-size: 12px; margin: 3px 0 0; }
    .setup-card { border:1px dashed #dbe4f3; border-radius:12px; padding:12px; background: linear-gradient(180deg,#ffffff,#f8fafc); }
    .saved-tick { margin-left: 10px; font-weight:700; color:#16a34a; }

    .protip { margin-top: 6px; text-align:center; color:#64748b; font-size: 13px; }
    .sparkle { margin-right: 6px; filter: drop-shadow(0 2px 6px rgba(37,99,235,.2)); }

    /* Fun micro-animations */
    .fx-pop { animation: fxPop .28s cubic-bezier(.2,.9,.2,1); }
    @keyframes fxPop { from { transform: scale(.96); opacity:.0 } to { transform: scale(1); opacity:1 } }

    /* Confetti canvas */
    .confetti { position: fixed; inset: 0; pointer-events: none; z-index: 1000; }

    /* Step states */
    .stepper .step.done .num { 
      background: linear-gradient(180deg,#16a34a,#15803d); 
      box-shadow: 
        0 4px 12px rgba(22,163,74,.2),
        0 1px 4px rgba(22,163,74,.1),
        inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .stepper .step.active { 
      border-color: rgba(37,99,235,.2);
      outline: 2px solid rgba(37,99,235,.25); 
      box-shadow: 
        0 4px 16px rgba(37,99,235,.08),
        0 8px 24px rgba(0,0,0,0.04),
        0 0 0 2px rgba(37,99,235,.06);
    }

    /* Internal welcome wizard pages */
    .wsteps { margin-top: 8px; }
    .wstep { display:none; }
    .wstep.on { display:block; animation: fxPop .24s cubic-bezier(.2,.9,.2,1); }
    #welcome-back[disabled] { opacity:.5; pointer-events:none; }

    /* Simplified wizard progress bar */
    .wizard-progress{ margin:4px 0 16px; }
    .wizard-progress .rail{ 
      height: 6px; 
      border-radius: 999px; 
      background: #eef2f7; 
      overflow: hidden; 
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }
    .wizard-progress .fill{ 
      height: 100%; 
      background: linear-gradient(90deg, #60a5fa, #2563eb); 
      transition: width .3s ease;
      box-shadow: 0 1px 2px rgba(37,99,235,.16);
    }
    .wizard-progress .labels{ 
      display: flex; 
      justify-content: space-between; 
      font-size: 11px; 
      color: #64748b; 
      margin-top: 6px;
    }
    .wizard-progress .labels .active{ 
      color: #0f172a; 
      font-weight: 600; 
    }

    /* Make stepper non-interactive (visual only) */
    .stepper .step{ pointer-events:none; }
    
    /* Partner staff custom scrollbar */
    #partner-checkboxes::-webkit-scrollbar {
      width: 10px;
    }
    #partner-checkboxes::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    #partner-checkboxes::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #3b82f6, #2563eb);
      border-radius: 10px;
      border: 2px solid #f1f5f9;
    }
    #partner-checkboxes::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #2563eb, #1d4ed8);
    }
    
    /* Search input focus effect */
    #partner-search:focus {
      outline: none;
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }
    
    /* Calendar styles */
    .calendar-day {
      background: white;
      min-height: 120px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    
    .calendar-day:hover {
      background: #f8fafc;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 10;
    }
    
    .calendar-day.today {
      background: #eff6ff;
      border: 2px solid #3b82f6;
    }
    
    .calendar-day.other-month {
      background: #fafafa;
      opacity: 0.5;
    }
    
    .calendar-day.weekend {
      background: #f9fafb;
    }
    
    .calendar-day-number {
      font-weight: 700;
      font-size: 16px;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .calendar-day.today .calendar-day-number {
      color: #3b82f6;
    }
    
    .staff-badge {
      display: inline-block;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
      margin: 2px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    
    .staff-badge.partner {
      background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .staff-time {
      font-size: 10px;
      opacity: 0.8;
      margin-left: 4px;
    }
    
    #modal-staff-list::-webkit-scrollbar {
      width: 8px;
    }
    #modal-staff-list::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    #modal-staff-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }
    #modal-staff-list::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    /* EMIS Search step styling */
    .setup-steps { display: flex; flex-direction: column; gap: 26px; }
    .step-container { 
      padding: 0; 
      position: relative;
    }
    .step-title { 
      display: flex; 
      align-items: center; 
      font-size: 16px; 
      font-weight: 600; 
      margin-bottom: 10px; 
      gap: 8px; 
      color: #0f172a;
    }
    .step-number { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      width: 24px; 
      height: 24px; 
      background: linear-gradient(180deg,#2563eb,#1d4ed8); 
      color: white; 
      border-radius: 50%; 
      font-size: 14px; 
      font-weight: 600; 
      flex-shrink: 0; 
      box-shadow: 0 2px 6px rgba(37,99,235,.16);
    }
    .step-image { 
      margin-top: 12px; 
      text-align: center;
      position: relative;
      transition: transform 0.2s ease;
      border-radius: 10px;
      overflow: hidden;
    }
    .step-image img { 
      max-height: 360px; 
      object-fit: contain;
      border: 1px solid rgba(15,23,42,0.06);
      border-radius: 8px;
      box-shadow: 
        0 1px 2px rgba(0,0,0,0.02),
        0 3px 10px rgba(0,0,0,0.04),
        0 6px 16px rgba(0,0,0,0.03);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .step-image img:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.05),
        0 12px 24px rgba(0,0,0,0.06);
    }
    
    /* Dashboard day card styles */
    .day-card {
      background: white;
      border-radius: 20px;
      padding: 24px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      text-align: center;
    }
    
    .day-name {
      font-size: 18px;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 12px;
    }
    
    .day-date {
      background: #e5e5e7;
      border-radius: 16px;
      padding: 12px;
      font-size: 16px;
      font-weight: 500;
      color: #1d1d1f;
      margin-bottom: 16px;
    }
    
    .metric {
      border-radius: 50px;
      padding: 10px 20px;
      margin: 6px 0;
      font-size: 15px;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .metric.otd { background: #ffcc00; color: #1d1d1f; }
    .metric.otd.green { background: #34c759; color: white; }
    .metric.otd.yellow { background: #ffcc00; color: #1d1d1f; }
    .metric.otd.red { background: #ff3b30; color: white; }
    
    .metric.not-bkd { background: #ffcc00; color: #1d1d1f; }
    .metric.not-bkd.green { background: #34c759; color: white; }
    .metric.not-bkd.yellow { background: #ffcc00; color: #1d1d1f; }
    .metric.not-bkd.red { background: #ff3b30; color: white; }
    
    .metric.partner { background: #34c759; }
    .metric.duty { background: #34c759; }
    .metric.duty.red { background: #ff3b30; }
    
    .metric-label {
      font-size: 14px;
    }
    
    .metric-value {
      font-size: 18px;
      font-weight: 700;
    }
    
    .checkmark {
      font-size: 20px;
      margin-left: 8px;
    }
    
    /* Loading spinner animation */
    .spinner-container {
      display: inline-block;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      margin: 0 auto;
      border: 4px solid #f0f0f0;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Fade in animation for dashboard content */
    #dashboard-content {
      transition: opacity 0.4s ease-in-out;
    }
    
    #dashboard-content.loaded {
      opacity: 1 !important;
    }

    /* AI Rules Page Styles */
    .quick-example-btn {
      background:#fff;
      border:1px solid #cbd5e1;
      color:#475569;
      padding:6px 12px;
      border-radius:8px;
      font-size:12px;
      font-weight:500;
      cursor:pointer;
      transition:all .2s;
    }
    .quick-example-btn:hover {
      background:#3b82f6;
      color:white;
      border-color:#3b82f6;
      transform:translateY(-1px);
    }
    .rule-card {
      background:white;
      border:1px solid #e2e8f0;
      border-radius:10px;
      padding:16px;
      margin-bottom:12px;
      transition:all .2s;
    }
    .rule-card:hover {
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      transform:translateY(-2px);
    }
    .rule-card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .rule-card-title {
      font-weight:600;
      color:#1e293b;
      font-size:14px;
    }
    .rule-card-type {
      font-size:11px;
      padding:4px 8px;
      border-radius:6px;
      background:#f0f9ff;
      color:#0369a1;
      font-weight:600;
    }
    .rule-toggle {
      display:inline-block;
      width:40px;
      height:22px;
      background:#cbd5e1;
      border-radius:11px;
      position:relative;
      cursor:pointer;
      transition:background .3s;
    }
    .rule-toggle.active {
      background:#22c55e;
    }
    .rule-toggle::after {
      content:'';
      position:absolute;
      width:18px;
      height:18px;
      background:white;
      border-radius:50%;
      top:2px;
      left:2px;
      transition:transform .3s;
    }
    .rule-toggle.active::after {
      transform:translateX(18px);
    }
</style>
</head>
<body>
  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
    <div class="bg-pattern"></div>
  </div>
  <div class="mesh" aria-hidden="true"><div class="m1"></div><div class="m2"></div><div class="m3"></div></div>
  
  <!-- Floating orbs for extra depth -->
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <div class="orb orb3"></div>
  
  <!-- Particle system -->
  <div class="particles" aria-hidden="true">
    <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
    <div class="particle" style="left: 20%; animation-delay: 2s;"></div>
    <div class="particle" style="left: 30%; animation-delay: 4s;"></div>
    <div class="particle" style="left: 40%; animation-delay: 6s;"></div>
    <div class="particle" style="left: 50%; animation-delay: 8s;"></div>
    <div class="particle" style="left: 60%; animation-delay: 10s;"></div>
    <div class="particle" style="left: 70%; animation-delay: 12s;"></div>
    <div class="particle" style="left: 80%; animation-delay: 14s;"></div>
    <div class="particle" style="left: 90%; animation-delay: 16s;"></div>
  </div>

  <div class="app" id="app" aria-live="polite">
    <!-- App Header + Navigation -->
    <header class="app-hero" style="position:sticky;top:0;z-index:110;background:rgba(255,255,255,0.92);backdrop-filter: blur(10px);border-bottom:1px solid rgba(15,23,42,.08);">
      <div class="container-xl" style="max-width:1280px;margin:0 auto;padding:10px 18px;display:flex;align-items:center;gap:12px;">
        <div class="brand" style="display:flex;align-items:center;gap:8px;">
          <img src="logo.png" alt="CheckLoops logo" style="width:38px;height:38px;border-radius:6px;object-fit:contain;" />
          <div>
            <div style="font-weight:700;color:#0f172a;font-size:17px;">CheckLoops</div>
            <div style="font-size:11px;color:#64748b;margin-top:-2px;">EMIS Operations Portal</div>
          </div>
        </div>
        <nav class="app-nav" style="margin-left:auto;display:flex;align-items:center;gap:6px;">
          <button class="nav-btn" data-page="dashboard" style="color:#2563eb;background:#eff6ff;text-decoration:none;font-weight:600;padding:8px 16px;border-radius:8px;transition:all .15s;border:none;cursor:pointer;font-size:14px;">
            <i class="bi bi-house-door"></i> Dashboard
          </button>
          <button class="nav-btn" data-page="raw-data" style="color:#64748b;background:transparent;text-decoration:none;font-weight:500;padding:8px 16px;border-radius:8px;transition:all .15s;border:none;cursor:pointer;font-size:14px;">
            <i class="bi bi-table"></i> Raw Data
          </button>
          <button class="nav-btn" data-page="ai-rules" style="color:#64748b;background:transparent;text-decoration:none;font-weight:500;padding:8px 16px;border-radius:8px;transition:all .15s;border:none;cursor:pointer;font-size:14px;">
            <i class="bi bi-stars"></i> AI Rules
          </button>
          <button class="nav-btn" data-page="rules-alerts" style="color:#64748b;background:transparent;text-decoration:none;font-weight:500;padding:8px 16px;border-radius:8px;transition:all .15s;border:none;cursor:pointer;font-size:14px;">
            <i class="bi bi-gear"></i> Settings
          </button>
          <button class="nav-btn" data-page="calendar" style="color:#64748b;background:transparent;text-decoration:none;font-weight:500;padding:8px 16px;border-radius:8px;transition:all .15s;border:none;cursor:pointer;font-size:14px;">
            <i class="bi bi-calendar3"></i> Calendar
          </button>
          <span style="width:1px;height:24px;background:#e2e8f0;margin:0 6px;"></span>
          <a href="admin-dashboard.html" style="color:#64748b;text-decoration:none;font-weight:500;padding:6px 12px;border-radius:6px;transition:all .15s;">Admin</a>
        </nav>
      </div>
    </header>

    <!-- Views container -->
  <main id="views" class="container-xl" style="max-width:1180px;margin:8px auto 0;padding:0 14px 40px;">

      <!-- Dashboard Page -->
      <section id="page-dashboard" class="page-view" style="display:block;">
        <div id="dashboard-loading" style="text-align:center;padding:80px 20px;">
          <div class="spinner-container">
            <div class="spinner"></div>
            <div style="margin-top:24px;font-size:16px;color:#64748b;font-weight:500;">Loading appointment data...</div>
            <div style="margin-top:8px;font-size:14px;color:#94a3b8;">Analyzing this week and next week</div>
          </div>
        </div>
        
        <div id="dashboard-error" style="display:none;background:#ff3b30;color:white;padding:20px;border-radius:12px;margin:20px 0;"></div>
        
        <div id="dashboard-content" style="display:none;opacity:0;transition:opacity 0.3s ease;">
          <!-- Current Week -->
          <div style="margin-bottom:40px;">
            <h5 style="font-size:16px;font-weight:600;color:#1d1d1f;margin-bottom:16px;text-align:right;padding-right:20px;">This Week</h5>
            <div id="current-week" style="display:grid;grid-template-columns:repeat(5,1fr);gap:16px;"></div>
          </div>
          
          <!-- Next Week -->
          <div style="margin-bottom:40px;">
            <h5 style="font-size:16px;font-weight:600;color:#1d1d1f;margin-bottom:16px;text-align:right;padding-right:20px;">Next Week</h5>
            <div id="next-week" style="display:grid;grid-template-columns:repeat(5,1fr);gap:16px;"></div>
          </div>
        </div>
      </section>

      <!-- Raw Data Page -->
      <section id="page-raw-data" class="page-view" style="display:none;">
        <div style="background:white;border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-top:14px;">
          <div id="filled-error" class="alert alert-danger" role="alert" style="display:none;"></div>
          
          <div class="table-responsive" style="max-height:calc(100vh - 220px);overflow:auto;border-radius:8px;border:1px solid #e5e7eb;">
            <table class="table table-sm table-hover align-middle mb-0" id="filled-table" style="font-size:13px;">
              <thead style="position:sticky;top:0;z-index:10;background:#f9fafb;border-bottom:2px solid #e5e7eb;">
                <tr></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mt-3" style="padding:0 8px;">
            <div id="filled-status" class="text-muted" style="font-size:14px;">Loading...</div>
            <div class="d-flex gap-2 align-items-center">
              <label class="text-muted mb-0" style="font-size:14px;">Rows per page:</label>
              <select id="filled-page-size" class="form-select form-select-sm" style="width:auto;">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
              <button id="filled-prev" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-chevron-left"></i> Previous
              </button>
              <button id="filled-next" class="btn btn-outline-secondary btn-sm">
                Next <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Settings Page -->
      <section id="page-rules-alerts" class="page-view" style="display:none;">
        <div style="background:white;border-radius:12px;padding:32px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-top:14px;">
          <h2 style="font-size:24px;font-weight:600;color:#1d1d1f;margin-bottom:8px;">
            <i class="bi bi-gear" style="margin-right:8px;"></i>Dashboard Settings
          </h2>
          <p style="color:#64748b;margin-bottom:32px;">Configure thresholds, partner availability, and other dashboard settings.</p>
          
          <div id="rules-loading" style="text-align:center;padding:40px;">
            <div class="spinner" style="width:40px;height:40px;margin:0 auto;"></div>
            <p style="margin-top:16px;color:#64748b;">Loading settings...</p>
          </div>
          
          <div id="rules-content" style="display:none;">
            <!-- Accordion Sections -->
            <div class="accordion" id="settingsAccordion">
              
              <!-- Section 1: Appointment Thresholds -->
              <div class="accordion-item" style="border:1px solid #e5e7eb;border-radius:12px;margin-bottom:16px;overflow:hidden;">
                <h2 class="accordion-header">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#thresholdSection" aria-expanded="true" style="background:#f9fafb;font-weight:600;padding:20px;">
                    <i class="bi bi-speedometer2" style="margin-right:12px;font-size:20px;"></i>
                    Appointment Thresholds
                  </button>
                </h2>
                <div id="thresholdSection" class="accordion-collapse collapse show" data-bs-parent="#settingsAccordion">
                  <div class="accordion-body" style="padding:24px;">
                            <!-- OTD Thresholds -->
                    <div style="border-radius:8px;padding:20px;margin-bottom:20px;background:white;border:1px solid #e5e7eb;">
                      <h4 style="font-size:16px;font-weight:600;color:#1d1d1f;margin-bottom:12px;">
                        <span style="background:#ffcc00;color:#1d1d1f;padding:4px 12px;border-radius:6px;margin-right:8px;font-size:13px;">OTD</span>
                        On The Day Thresholds
                      </h4>
                      <p style="color:#64748b;font-size:14px;margin-bottom:16px;">Set minimum appointment counts for each day. Below this number will show as red.</p>
              
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label" style="font-weight:500;font-size:14px;">Monday</label>
                  <input type="number" id="otd-monday" class="form-control" min="0" value="25">
                </div>
                <div class="col-md-4">
                  <label class="form-label" style="font-weight:500;font-size:14px;">Tuesday</label>
                  <input type="number" id="otd-tuesday" class="form-control" min="0" value="20">
                </div>
                <div class="col-md-4">
                  <label class="form-label" style="font-weight:500;font-size:14px;">Wednesday</label>
                  <input type="number" id="otd-wednesday" class="form-control" min="0" value="20">
                </div>
                <div class="col-md-4">
                  <label class="form-label" style="font-weight:500;font-size:14px;">Thursday</label>
                  <input type="number" id="otd-thursday" class="form-control" min="0" value="20">
                </div>
                <div class="col-md-4">
                  <label class="form-label" style="font-weight:500;font-size:14px;">Friday</label>
                  <input type="number" id="otd-friday" class="form-control" min="0" value="20">
                </div>
              </div>
            </div>
            
            <!-- Not BKD Thresholds -->
            <div style="background:#f9fafb;border-radius:12px;padding:24px;margin-bottom:24px;">
              <h3 style="font-size:18px;font-weight:600;color:#1d1d1f;margin-bottom:16px;">
                <span style="background:#ffcc00;color:#1d1d1f;padding:4px 12px;border-radius:6px;margin-right:8px;font-size:14px;">Not BKD</span>
                Not Booked Thresholds
              </h3>
              <p style="color:#64748b;font-size:14px;margin-bottom:16px;">Set minimum available appointment counts for each day. Below this number will show as red.</p>
              
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label" style="font-weight:500;font-size:14px;">Monday</label>
                  <input type="number" id="notbkd-monday" class="form-control" min="0" value="25">
                </div>
                <div class="col-md-4">
                  <label class="form-label" style="font-weight:500;font-size:14px;">Tuesday</label>
                  <input type="number" id="notbkd-tuesday" class="form-control" min="0" value="20">
                </div>
                <div class="col-md-4">
                  <label class="form-label" style="font-weight:500;font-size:14px;">Wednesday</label>
                  <input type="number" id="notbkd-wednesday" class="form-control" min="0" value="20">
                </div>
                <div class="col-md-4">
                  <label class="form-label" style="font-weight:500;font-size:14px;">Thursday</label>
                  <input type="number" id="notbkd-thursday" class="form-control" min="0" value="20">
                </div>
                <div class="col-md-4">
                  <label class="form-label" style="font-weight:500;font-size:14px;">Friday</label>
                  <input type="number" id="notbkd-friday" class="form-control" min="0" value="20">
                </div>
              </div>
            </div>
            
            <!-- Gradient Settings -->
            <div style="background:#f9fafb;border-radius:12px;padding:24px;margin-bottom:24px;">
              <h3 style="font-size:18px;font-weight:600;color:#1d1d1f;margin-bottom:16px;">
                <i class="bi bi-palette" style="margin-right:8px;"></i>Color Gradient Settings
              </h3>
              <p style="color:#64748b;font-size:14px;margin-bottom:16px;">Configure how colors transition based on percentage of threshold met.</p>
              
              <div class="row g-3">
                <div class="col-md-6">
                  <div style="background:white;border-radius:8px;padding:16px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                      <div style="width:24px;height:24px;background:#ff3b30;border-radius:4px;"></div>
                      <span style="font-weight:500;">Red (Critical)</span>
                    </div>
                    <label class="form-label" style="font-size:13px;">Show red when below:</label>
                    <div class="input-group input-group-sm">
                      <input type="number" id="gradient-red" class="form-control" min="0" max="100" value="80">
                      <span class="input-group-text">% of threshold</span>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div style="background:white;border-radius:8px;padding:16px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                      <div style="width:24px;height:24px;background:#34c759;border-radius:4px;"></div>
                      <span style="font-weight:500;">Green (Good)</span>
                    </div>
                    <label class="form-label" style="font-size:13px;">Show green when above:</label>
                    <div class="input-group input-group-sm">
                      <input type="number" id="gradient-green" class="form-control" min="0" max="200" value="100">
                      <span class="input-group-text">% of threshold</span>
                    </div>
                  </div>
                </div>
              </div>
              <p style="color:#94a3b8;font-size:12px;margin-top:12px;font-style:italic;">
                <i class="bi bi-info-circle"></i> Yellow will be shown between the red and green percentages.
              </p>
            </div>
                  </div>
                </div>
              </div>
              
              <!-- Section 2: Partner Staff -->
              <div class="accordion-item" style="border:1px solid #e5e7eb;border-radius:12px;margin-bottom:16px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#partnerSection" aria-expanded="false" 
                    style="background:linear-gradient(to right, #f0f9ff, #ffffff);font-weight:600;padding:20px 24px;border:none;">
                    <i class="bi bi-people-fill" style="margin-right:14px;font-size:24px;color:#3b82f6;"></i>
                    <span style="font-size:16px;">Partner Staff</span>
                    <span class="badge bg-primary" id="partner-count-badge" style="margin-left:14px;font-size:12px;padding:5px 12px;border-radius:20px;font-weight:500;">0 selected</span>
                  </button>
                </h2>
                <div id="partnerSection" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                  <div class="accordion-body" style="padding:24px;background:#fafbfc;">
                    <div style="background:#dbeafe;border-left:4px solid #3b82f6;padding:14px 18px;border-radius:8px;margin-bottom:24px;">
                      <p style="color:#1e40af;margin:0;font-size:14px;display:flex;align-items:start;gap:10px;">
                        <i class="bi bi-info-circle-fill" style="margin-top:2px;flex-shrink:0;"></i>
                        <span>Select which staff members are considered partners. The dashboard will show a green <strong>✓</strong> if at least one partner is working that day.</span>
                      </p>
                    </div>
                    
                    <div id="partner-staff-loading" style="text-align:center;padding:40px;">
                      <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;"></div>
                      <p style="margin-top:16px;color:#64748b;font-size:15px;">Loading staff list...</p>
                    </div>
                    
                    <div id="partner-staff-list" style="display:none;">
                      <!-- Staff checkboxes will be populated here -->
                    </div>
                    
                    <div id="partner-staff-empty" style="display:none;text-align:center;padding:60px 20px;color:#94a3b8;">
                      <i class="bi bi-inbox" style="font-size:4rem;opacity:0.5;"></i>
                      <p style="margin-top:20px;font-size:15px;">No staff members found in session data.</p>
                    </div>
                  </div>
                </div>
              </div>
              
            </div>
            
            <!-- Save Button -->
            <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;margin-top:32px;padding-top:24px;border-top:2px solid #e5e7eb;">
              <div style="display:flex;align-items:center;gap:10px;color:#64748b;font-size:14px;">
                <i class="bi bi-lightbulb" style="color:#f59e0b;"></i>
                <span>Make sure to save your changes before leaving this page</span>
              </div>
              <div style="display:flex;gap:12px;">
                <button id="rules-cancel" class="btn btn-outline-secondary" style="padding:12px 24px;border-radius:10px;font-weight:600;">
                  <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button id="rules-save" class="btn btn-primary" style="padding:12px 32px;border-radius:10px;font-weight:600;font-size:15px;box-shadow:0 4px 12px rgba(59,130,246,0.3);">
                  <i class="bi bi-check-circle-fill"></i> Save All Settings
                </button>
              </div>
            </div>
            
            <div id="rules-success" style="display:none;margin-top:20px;padding:16px 20px;background:linear-gradient(to right, #d1fae5, #a7f3d0);color:#065f46;border-radius:12px;text-align:center;font-weight:600;border:2px solid #10b981;box-shadow:0 4px 12px rgba(16,185,129,0.2);">
              <i class="bi bi-check-circle-fill" style="font-size:20px;margin-right:8px;"></i>
              <span style="font-size:15px;">Settings saved successfully! Refresh the Dashboard to see changes.</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Calendar Page -->
      <section id="page-calendar" class="page-view" style="display:none;">
        <div style="background:white;border-radius:16px;padding:32px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-top:14px;">
          
          <!-- Calendar Header -->
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;">
            <div>
              <h2 id="calendar-month-title" style="margin:0;font-size:28px;font-weight:700;color:#1e293b;">
                <i class="bi bi-calendar-month" style="color:#3b82f6;margin-right:12px;"></i>
                <span id="current-month-year">October 2025</span>
              </h2>
              <p style="color:#64748b;margin:8px 0 0 48px;font-size:14px;">Staff Schedule Overview</p>
            </div>
            <div style="display:flex;gap:12px;align-items:center;">
              <button id="calendar-prev-month" class="btn btn-outline-primary" style="border-radius:10px;padding:10px 20px;">
                <i class="bi bi-chevron-left"></i> Previous
              </button>
              <button id="calendar-today" class="btn btn-primary" style="border-radius:10px;padding:10px 24px;font-weight:600;">
                <i class="bi bi-calendar-day"></i> Today
              </button>
              <button id="calendar-next-month" class="btn btn-outline-primary" style="border-radius:10px;padding:10px 20px;">
                Next <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>

          <!-- Loading State -->
          <div id="calendar-loading" style="text-align:center;padding:80px 20px;">
            <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p style="margin-top:20px;color:#64748b;font-size:15px;">Loading staff schedules...</p>
          </div>

          <!-- Calendar Grid -->
          <div id="calendar-grid" style="display:none;">
            <!-- Day headers -->
            <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e5e7eb;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;margin-bottom:1px;">
              <div style="background:#f8fafc;padding:16px;text-align:center;font-weight:700;color:#475569;font-size:14px;">Monday</div>
              <div style="background:#f8fafc;padding:16px;text-align:center;font-weight:700;color:#475569;font-size:14px;">Tuesday</div>
              <div style="background:#f8fafc;padding:16px;text-align:center;font-weight:700;color:#475569;font-size:14px;">Wednesday</div>
              <div style="background:#f8fafc;padding:16px;text-align:center;font-weight:700;color:#475569;font-size:14px;">Thursday</div>
              <div style="background:#f8fafc;padding:16px;text-align:center;font-weight:700;color:#475569;font-size:14px;">Friday</div>
              <div style="background:#f1f5f9;padding:16px;text-align:center;font-weight:700;color:#94a3b8;font-size:14px;">Saturday</div>
              <div style="background:#f1f5f9;padding:16px;text-align:center;font-weight:700;color:#94a3b8;font-size:14px;">Sunday</div>
            </div>

            <!-- Calendar days (will be populated by JavaScript) -->
            <div id="calendar-days" style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e5e7eb;border:1px solid #e5e7eb;border-bottom-left-radius:12px;border-bottom-right-radius:12px;overflow:hidden;">
              <!-- Days will be inserted here -->
            </div>
          </div>

          <!-- Selected Day Detail Modal -->
          <div id="day-detail-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;padding:40px;overflow-y:auto;" onclick="if(event.target === this) closeDayDetail()">
            <div style="background:white;border-radius:16px;max-width:800px;margin:0 auto;padding:0;box-shadow:0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
              <!-- Modal Header -->
              <div style="padding:24px 32px;border-bottom:2px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg, #3b82f6, #2563eb);color:white;border-top-left-radius:16px;border-top-right-radius:16px;">
                <div>
                  <h3 id="modal-day-title" style="margin:0;font-size:24px;font-weight:700;">Monday, 14 October 2025</h3>
                  <p id="modal-staff-count" style="margin:8px 0 0 0;opacity:0.9;font-size:14px;">5 staff members working</p>
                </div>
                <button onclick="closeDayDetail()" style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:28px;cursor:pointer;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
              </div>
              
              <!-- Modal Body -->
              <div id="modal-staff-list" style="padding:32px;max-height:600px;overflow-y:auto;">
                <!-- Staff schedules will be inserted here -->
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- AI Rules Page -->
      <section id="page-ai-rules" class="page-view" style="display:none;">
        <div style="background:white;border-radius:16px;padding:32px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-top:14px;">
          
          <!-- Header -->
          <div style="margin-bottom:32px;">
            <h2 style="margin:0;font-size:28px;font-weight:700;color:#1e293b;">
              <i class="bi bi-stars" style="color:#3b82f6;margin-right:12px;"></i>
              Rule Creator
            </h2>
            <p style="color:#64748b;margin:12px 0 0;font-size:15px;">Create validation rules using AI or build them manually with form controls.</p>
          </div>

          <!-- Tab Navigation -->
          <ul class="nav nav-tabs" style="margin-bottom:24px;border-bottom:2px solid #e2e8f0;">
            <li class="nav-item">
              <button class="nav-link active" id="ai-creator-tab" onclick="AIRules.switchCreatorTab('ai')" style="border:none;background:none;padding:12px 24px;font-weight:600;color:#64748b;cursor:pointer;border-bottom:3px solid transparent;">
                <i class="bi bi-magic"></i> AI Creator
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" id="manual-creator-tab" onclick="AIRules.switchCreatorTab('manual')" style="border:none;background:none;padding:12px 24px;font-weight:600;color:#64748b;cursor:pointer;border-bottom:3px solid transparent;">
                <i class="bi bi-sliders"></i> Manual Creator
              </button>
            </li>
          </ul>

          <!-- Rule Creator Section -->
          <div style="display:grid;grid-template-columns:1fr 400px;gap:24px;">
            
            <!-- Left Column: Input & Generation -->
            <div>
              <!-- AI Creator Tab -->
              <div id="ai-creator-content">
              <div style="background:#f8fafc;border-radius:12px;padding:24px;border:1px solid #e2e8f0;margin-bottom:20px;">
                <label style="display:block;font-weight:600;color:#1e293b;margin-bottom:12px;font-size:15px;">
                  <i class="bi bi-chat-left-text" style="color:#3b82f6;margin-right:8px;"></i>
                  Describe Your Rule
                </label>
                <textarea 
                  id="ai-rule-input" 
                  placeholder="Example: Dr Saeed cannot have appointments less than 60 minutes..."
                  style="width:100%;min-height:120px;padding:14px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;font-family:inherit;resize:vertical;"
                ></textarea>
                
                <!-- Severity Selector -->
                <div style="margin-top:16px;">
                  <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;font-size:14px;">
                    Severity Level
                  </label>
                  <select id="ai-rule-severity" class="form-select" style="border-radius:8px;border:1px solid #cbd5e1;">
                    <option value="error" selected>🔴 Error (Critical - Must be fixed)</option>
                    <option value="warning">🟡 Warning (Important - Should be reviewed)</option>
                    <option value="info">🔵 Info (Advisory - For reference)</option>
                  </select>
                </div>
                
                <div style="display:flex;gap:12px;margin-top:16px;">
                  <button id="ai-generate-btn" class="btn btn-primary" style="flex:1;padding:12px;font-weight:600;border-radius:10px;">
                    <i class="bi bi-magic"></i> Generate Rule
                  </button>
                  <button id="ai-clear-btn" class="btn btn-outline-secondary" style="padding:12px 20px;border-radius:10px;">
                    <i class="bi bi-x-lg"></i> Clear
                  </button>
                </div>

                <!-- Quick Examples -->
                <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e2e8f0;">
                  <p style="font-size:13px;color:#64748b;margin-bottom:8px;font-weight:500;">Quick Examples:</p>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    <button class="quick-example-btn" data-example="Dr Saeed cannot have appointments less than 60 minutes">Min Duration</button>
                    <button class="quick-example-btn" data-example="There must be at least 5 emergency slots each weekday">Daily Count</button>
                    <button class="quick-example-btn" data-example="Dr Smith cannot perform surgery appointments">Clinician Restriction</button>
                  </div>
                </div>
              </div>

              <!-- Generated Rule Preview -->
              <div id="ai-rule-preview" style="display:none;background:#f0fdf4;border:2px solid #86efac;border-radius:12px;padding:20px;">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
                  <h4 style="margin:0;font-size:16px;font-weight:600;color:#166534;">
                    <i class="bi bi-check-circle-fill" style="color:#22c55e;margin-right:8px;"></i>
                    Generated Rule
                  </h4>
                  <div style="display:flex;gap:8px;">
                    <button id="ai-save-btn" class="btn btn-success btn-sm" style="border-radius:8px;font-weight:600;">
                      <i class="bi bi-save"></i> Save Rule
                    </button>
                    <button id="ai-test-btn" class="btn btn-outline-success btn-sm" style="border-radius:8px;">
                      <i class="bi bi-play-circle"></i> Test
                    </button>
                  </div>
                </div>
                
                <div id="ai-rule-details" style="background:white;border-radius:8px;padding:16px;">
                  <!-- Rule details will be inserted here -->
                </div>
              </div>

              <!-- Test Results -->
              <div id="ai-test-results" style="display:none;margin-top:20px;background:#fef3c7;border:2px solid #fbbf24;border-radius:12px;padding:20px;">
                <h4 style="margin:0 0 12px;font-size:16px;font-weight:600;color:#92400e;">
                  <i class="bi bi-clipboard-check" style="color:#f59e0b;margin-right:8px;"></i>
                  Test Results
                </h4>
                <div id="ai-test-content">
                  <!-- Test results will be inserted here -->
                </div>
              </div>
              </div>

              <!-- Manual Creator Tab -->
              <div id="manual-creator-content" style="display:none;">
                <div style="background:#f8fafc;border-radius:12px;padding:24px;border:1px solid #e2e8f0;">
                  
                  <!-- Rule Name -->
                  <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px;">
                      <i class="bi bi-tag" style="color:#3b82f6;margin-right:8px;"></i>
                      Rule Name
                    </label>
                    <input type="text" id="manual-rule-name" class="form-control" placeholder="e.g., Dr Smith Duration Check" style="border-radius:8px;">
                  </div>

                  <!-- Rule Type Selector -->
                  <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px;">
                      <i class="bi bi-gear" style="color:#3b82f6;margin-right:8px;"></i>
                      Rule Type
                    </label>
                    <select id="manual-rule-type" class="form-select" style="border-radius:8px;" onchange="AIRules.updateManualForm()">
                      <option value="">Select rule type...</option>
                      <option value="slot_duration">Slot Duration</option>
                      <option value="slot_count">Slot Count</option>
                      <option value="daily_check">Daily Check</option>
                      <option value="custom">Custom Rule</option>
                    </select>
                  </div>

                  <!-- Dynamic Form Fields -->
                  <div id="manual-form-fields">
                    <p style="text-align:center;color:#64748b;padding:40px;">Select a rule type to configure</p>
                  </div>

                  <!-- Severity -->
                  <div style="margin-top:20px;margin-bottom:20px;">
                    <label style="display:block;font-weight:600;color:#1e293b;margin-bottom:8px;font-size:14px;">
                      Severity Level
                    </label>
                    <select id="manual-rule-severity" class="form-select" style="border-radius:8px;">
                      <option value="error" selected>🔴 Error (Critical)</option>
                      <option value="warning">🟡 Warning (Important)</option>
                      <option value="info">🔵 Info (Advisory)</option>
                    </select>
                  </div>

                  <!-- Action Buttons -->
                  <div style="display:flex;gap:12px;margin-top:20px;">
                    <button id="manual-create-btn" class="btn btn-primary" style="flex:1;padding:12px;font-weight:600;border-radius:10px;" onclick="AIRules.createManualRule()">
                      <i class="bi bi-plus-circle"></i> Create Rule
                    </button>
                    <button class="btn btn-outline-secondary" style="padding:12px 20px;border-radius:10px;" onclick="AIRules.clearManualForm()">
                      <i class="bi bi-x-lg"></i> Clear
                    </button>
                  </div>

                </div>
              </div>
            </div>

            <!-- Right Column: Existing Rules -->
            <div>
              <div style="background:#f8fafc;border-radius:12px;padding:20px;border:1px solid #e2e8f0;max-height:calc(100vh - 200px);overflow-y:auto;">
                <h4 style="margin:0 0 16px;font-size:16px;font-weight:600;color:#1e293b;">
                  <i class="bi bi-list-check" style="color:#3b82f6;margin-right:8px;"></i>
                  Active Rules
                </h4>
                
                <div id="ai-rules-loading" style="text-align:center;padding:40px 20px;">
                  <div class="spinner-border text-primary" role="status" style="width:2rem;height:2rem;">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p style="margin-top:12px;color:#64748b;font-size:14px;">Loading rules...</p>
                </div>

                <div id="ai-rules-list" style="display:none;">
                  <!-- Rules will be inserted here -->
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- EMIS Apps (filled) table - hidden -->
      <section id="view-filled" class="view" style="display:none;">
        <div class="card" style="margin-top:14px;">
          <div class="card-hd">EMIS Filled Rows (Legacy)</div>
          <div class="card-bd">
            <div id="filled-error" class="alert alert-danger" role="alert" style="display:none"></div>
            <div class="table-responsive" style="max-height:60vh; overflow:auto;">
              <table class="table table-sm align-middle" id="filled-table">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                  <tr>
                    <th scope="col">Row #</th>
                    <th scope="col">Created</th>
                    <th scope="col">Full name</th>
                    <th scope="col">Day</th>
                    <th scope="col">Appt Date</th>
                    <th scope="col">Appt Time</th>
                    <th scope="col">Slot Type</th>
                    <th scope="col">Count</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <div id="filled-status" class="text-muted small">Loading…</div>
              <div class="d-flex align-items-center" style="gap:6px;">
                <button id="filled-prev" class="btn btn-outline-secondary btn-sm" type="button" disabled>Prev</button>
                <button id="filled-next" class="btn btn-outline-secondary btn-sm" type="button" disabled>Next</button>
                <label for="filled-page-size" class="small text-muted mb-0" style="margin-left:8px;">Page size</label>
                <select id="filled-page-size" class="form-select form-select-sm" style="width:auto;">
                  <option value="25">25</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    
    <!-- Progress overlay (moved into Step 2 card as inline `progress-inline`) -->
    <!-- The element keeps id="progress-overlay" so existing JS can toggle .show and update #progress-bar and #status-message -->
    
    <!-- AI Debug Panel -->
    <div id="ai-debug-panel" style="position:fixed; bottom:20px; right:20px; background-color:#ffffff; border:1px solid #e2e8f0; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:15px; z-index:1000; max-width:400px; display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h4 style="margin:0; font-size:16px; font-weight:600;">AI Debug Controls</h4>
        <button id="close-debug-panel" style="background:none; border:none; cursor:pointer; color:#64748b; font-size:18px;">×</button>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <button id="ai-test-btn" style="background-color:#3b82f6; color:white; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; font-size:14px;">Test AI connectivity</button>
        <button id="ai-req-btn" style="background-color:#4ade80; color:white; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; font-size:14px;">Show Last Request</button>
        <button id="ai-res-btn" style="background-color:#f59e0b; color:white; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; font-size:14px;">Show Last Response</button>
        <button id="ai-retry-btn" style="background-color:#ef4444; color:white; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; font-size:14px;">Retry Classification</button>
      </div>
      <div id="ai-status" style="margin-top:10px; padding:8px; background-color:#f8fafc; border-radius:4px; font-size:13px; color:#334155;">Status: Ready</div>
      <div style="margin-top:10px; text-align:right;">
        <a href="#" id="toggle-debug-panel" style="font-size:12px; color:#3b82f6; text-decoration:none;">Toggle Debug Panel</a>
      </div>
    </div>

    <!-- Rule Test Results Modal -->
    <div class="modal fade" id="ruleTestModal" tabindex="-1" aria-labelledby="ruleTestModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="ruleTestModalLabel">Rule Test Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="ruleTestModalBody">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Running test...</span>
              </div>
              <p class="mt-3 text-muted">Testing rule...</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    

    <!-- Add scripts here -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Debug Panel Controls -->
    <script>
      // Page navigation
      function showPage(pageName) {
        // Hide all pages
        document.querySelectorAll('.page-view').forEach(page => {
          page.style.display = 'none';
        });
        
        // Show selected page
        const selectedPage = document.getElementById('page-' + pageName);
        if (selectedPage) {
          selectedPage.style.display = 'block';
        }
        
        // Update nav button styles
        document.querySelectorAll('.nav-btn').forEach(btn => {
          const isActive = btn.getAttribute('data-page') === pageName;
          btn.style.color = isActive ? '#2563eb' : '#64748b';
          btn.style.background = isActive ? '#eff6ff' : 'transparent';
          btn.style.fontWeight = isActive ? '600' : '500';
        });
        
        // Load data if needed
        if (pageName === 'raw-data' && !window.dataLoaded) {
          loadPage();
          window.dataLoaded = true;
        }
        
        // Update dashboard stats if on dashboard
        if (pageName === 'dashboard') {
          updateDashboardStats();
        }
      }

      // Update dashboard statistics
      async function updateDashboardStats() {
        try {
          const sb = window.supabase;
          if (!sb) return;
          
          // Get total appointments count
          const { count: totalCount } = await sb
            .from('emis_apps_filled')
            .select('*', { count: 'exact', head: true });
          
          document.getElementById('stat-total').textContent = totalCount || '—';
          document.getElementById('stat-otd').textContent = '—';
          document.getElementById('stat-rules').textContent = '—';
          document.getElementById('stat-alerts').textContent = '—';
        } catch (err) {
          console.error('Error loading dashboard stats:', err);
        }
      }

      // Nav button click handlers - initialize after DOM loads
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const pageName = btn.getAttribute('data-page');
            if (window.showPage) {
              window.showPage(pageName);
            }
          });
        });
        
        // Load dashboard on initial load
        if (typeof updateDashboardStats === 'function') {
          updateDashboardStats();
        }
      });

      // Page navigation system
      function showPage(pageName) {
        // Hide all pages
        document.querySelectorAll('.page-view').forEach(page => {
          page.style.display = 'none';
        });
        
        // Show selected page
        const selectedPage = document.getElementById('page-' + pageName);
        if (selectedPage) {
          selectedPage.style.display = 'block';
        }
        
        // Update nav button styles
        document.querySelectorAll('.nav-btn').forEach(btn => {
          const isActive = btn.getAttribute('data-page') === pageName;
          btn.style.color = isActive ? '#2563eb' : '#64748b';
          btn.style.background = isActive ? '#eff6ff' : 'transparent';
          btn.style.fontWeight = isActive ? '600' : '500';
        });
        
        // Load data if needed
        if (pageName === 'raw-data' && typeof loadPage === 'function') {
          loadPage();
        }
        
        // Update dashboard stats if on dashboard
        if (pageName === 'dashboard') {
          updateDashboardStats();
        }
      }

      // Dashboard appointment loading
      const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
      
      // Get Monday of current week
      function getMonday(d) {
        d = new Date(d);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
      }
      
      // Format date as "13 Oct..." or "20 October"
      function formatDate(date, short = true) {
        const day = date.getDate();
        const month = date.toLocaleDateString('en-GB', { month: short ? 'short' : 'long' });
        return `${day} ${month}${short ? '...' : ''}`;
      }
      
      // Get date string in DD-Mon-YYYY format to match database format
      function getDateString(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = date.toLocaleDateString('en-GB', { month: 'short' });
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
      }
      
      // Add days to a date
      function addDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
      }
      
      // Get threshold for a specific day and metric
      function getThreshold(dayOfWeek, metric) {
        if (!window.thresholdRules) {
          // Default thresholds if rules not loaded
          return dayOfWeek === 'Monday' ? 25 : 20;
        }
        
        const dayKey = dayOfWeek.toLowerCase();
        if (metric === 'otd') {
          return window.thresholdRules.otd[dayKey] || 20;
        } else if (metric === 'not-bkd') {
          return window.thresholdRules.notBkd[dayKey] || 20;
        }
        return 20;
      }
      
      // Calculate gradient color based on value and threshold
      function getGradientColor(value, threshold) {
        if (!window.thresholdRules || !window.thresholdRules.gradient) {
          // Legacy behavior: solid red or green
          return value >= threshold ? 'green' : 'red';
        }
        
        const percentage = (value / threshold) * 100;
        const redThreshold = window.thresholdRules.gradient.red;
        const greenThreshold = window.thresholdRules.gradient.green;
        
        if (percentage < redThreshold) {
          // Red zone
          return 'red';
        } else if (percentage >= greenThreshold) {
          // Green zone
          return 'green';
        } else {
          // Yellow zone (between red and green)
          return 'yellow';
        }
      }
      
      // Create day card HTML
      function createDayCard(dayName, date, metrics) {
        const otdThreshold = getThreshold(dayName, 'otd');
        const notBkdThreshold = getThreshold(dayName, 'not-bkd');
        
        const otdColor = getGradientColor(metrics.otd, otdThreshold);
        const notBkdColor = getGradientColor(metrics.notBkd, notBkdThreshold);
        
        return `
          <div class="day-card">
            <div class="day-name">${dayName}</div>
            <div class="day-date">${formatDate(date)}</div>
            
            <div class="metric otd ${otdColor}">
              <span class="metric-label">OTD</span>
              <span class="metric-value">${metrics.otd}</span>
            </div>
            
            <div class="metric not-bkd ${notBkdColor}">
              <span class="metric-label">Not BKD</span>
              <span class="metric-value">${metrics.notBkd}</span>
            </div>
            
            <div class="metric partner ${metrics.partnerIn ? '' : 'red'}">
              <span class="metric-label">Partner In</span>
              <span class="checkmark">${metrics.partnerIn ? '✓' : '✗'}</span>
            </div>
            
            <div class="metric duty ${metrics.hasDuty ? '' : 'red'}">
              <span class="metric-label">Duty</span>
              <span class="checkmark">${metrics.hasDuty ? '✓' : '✗'}</span>
            </div>
          </div>
        `;
      }
      
      // Load slot type mappings
      async function loadSlotMappings() {
        try {
          const { data: user } = await window.supabase.auth.getUser();
          if (!user || !user.user) {
            throw new Error('Not authenticated');
          }
          
          const { data: userProfile } = await window.supabase
            .from('master_users')
            .select('site_id')
            .eq('auth_user_id', user.user.id)
            .single();
          
          if (!userProfile || !userProfile.site_id) {
            throw new Error('Site ID not found');
          }
          
          const { data: mappings, error } = await window.supabase
            .from('slot_type_mappings')
            .select('*')
            .eq('site_id', userProfile.site_id)
            .eq('is_active', true);
          
          if (error) throw error;
          
          console.log('Loaded slot mappings:', mappings);
          
          // Build lookup maps - using correct column names: category_key and emis_slot_type
          const bookOnDayTypes = [];
          const dutyTypes = [];
          
          (mappings || []).forEach(mapping => {
            if (mapping.category_key === 'on_the_day') {
              bookOnDayTypes.push(mapping.emis_slot_type);
            }
            if (mapping.category_key === 'duty' || mapping.emis_slot_type.toLowerCase().includes('duty')) {
              dutyTypes.push(mapping.emis_slot_type);
            }
          });
          
          console.log('Book on day types:', bookOnDayTypes);
          console.log('Duty types:', dutyTypes);
          
          return {
            bookOnDayTypes,
            dutyTypes
          };
        } catch (error) {
          console.error('Error loading slot mappings:', error);
          return {
            bookOnDayTypes: [],
            dutyTypes: []
          };
        }
      }
      
      // Load appointment data for a specific date
      async function loadAppointmentsForDate(dateStr, slotMappings) {
        try {
          console.log(`\n=== Loading data for ${dateStr} ===`);
          console.log('Slot mappings:', slotMappings);
          
          // Get OTD (Book on the Day) count - using correct column names with quotes
          let otdCount = 0;
          if (slotMappings.bookOnDayTypes.length > 0) {
            console.log(`Querying OTD: WHERE "Appointment Date" = '${dateStr}' AND "Slot Type" IN [${slotMappings.bookOnDayTypes.join(', ')}]`);
            
            const { count: otdData, error: otdError } = await window.supabase
              .from('emis_apps_filled')
              .select('*', { count: 'exact', head: true })
              .eq('"Appointment Date"', dateStr)
              .in('"Slot Type"', slotMappings.bookOnDayTypes);
            
            if (!otdError) {
              otdCount = otdData || 0;
              console.log(`OTD count result: ${otdCount}`);
            } else {
              console.error('Error loading OTD count:', otdError);
            }
            
            // Get a sample row to check date format
            const { data: sampleRows } = await window.supabase
              .from('emis_apps_filled')
              .select('"Appointment Date", "Slot Type"')
              .limit(5);
            console.log('Sample rows from database:', sampleRows);
          }
          
          // Get Not BKD (Available + Embargoed appointments) count
          let notBkdCount = 0;
          if (slotMappings.bookOnDayTypes.length > 0) {
            console.log(`Querying Not BKD: WHERE "Appointment Date" = '${dateStr}' AND "Availability" IN ['Available', 'Embargoed'] AND "Slot Type" IN [${slotMappings.bookOnDayTypes.join(', ')}]`);
            
            const { count: availData, error: availError } = await window.supabase
              .from('emis_apps_filled')
              .select('*', { count: 'exact', head: true })
              .eq('"Appointment Date"', dateStr)
              .in('"Availability"', ['Available', 'Embargoed'])
              .in('"Slot Type"', slotMappings.bookOnDayTypes);
            
            if (!availError) {
              notBkdCount = availData || 0;
              console.log(`Not BKD count result: ${notBkdCount} (Available + Embargoed)`);
            } else {
              console.error('Error loading Not BKD count:', availError);
            }
          }
          
          // Check for Duty slots
          let hasDuty = false;
          if (slotMappings.dutyTypes.length > 0) {
            const { data: dutyData, error: dutyError } = await window.supabase
              .from('emis_apps_filled')
              .select('id')
              .eq('"Appointment Date"', dateStr)
              .in('"Slot Type"', slotMappings.dutyTypes)
              .limit(1);
            
            if (!dutyError && dutyData && dutyData.length > 0) {
              hasDuty = true;
            } else if (dutyError) {
              console.error('Error checking duty slots:', dutyError);
            }
          }

          // Check for Partner presence
          let hasPartner = false;
          const partners = window.thresholdRules?.partners || [];
          if (partners.length > 0) {
            console.log(`Checking for partners on ${dateStr}:`, partners);
            const { data: partnerData, error: partnerError } = await window.supabase
              .from('emis_apps_filled')
              .select('"Full Name of the Session Holder of the Session"')
              .eq('"Appointment Date"', dateStr)
              .in('"Full Name of the Session Holder of the Session"', partners)
              .limit(1);
            
            if (!partnerError && partnerData && partnerData.length > 0) {
              hasPartner = true;
              console.log(`✅ Partner found for ${dateStr}:`, partnerData[0]['Full Name of the Session Holder of the Session']);
            } else if (partnerError) {
              console.error('❌ Error checking partner presence:', partnerError);
            } else {
              console.log(`❌ No partner found for ${dateStr}`);
            }
          } else {
            console.log('No partners configured');
          }
          
          console.log(`Final results for ${dateStr}: OTD=${otdCount}, Not BKD=${notBkdCount}, Duty=${hasDuty}, Partner=${hasPartner}`);
          
          return {
            otd: otdCount,
            notBkd: notBkdCount,
            partnerIn: hasPartner, // Use real partner check instead of placeholder
            hasDuty: hasDuty
          };
        } catch (error) {
          console.error(`Error loading data for ${dateStr}:`, error);
          return {
            otd: 0,
            notBkd: 0,
            partnerIn: 999,
            hasDuty: false
          };
        }
      }
      
      // Update dashboard statistics
      async function updateDashboardStats() {
        try {
          console.log('Starting dashboard update...');
          
          // Reset all display states
          const loadingEl = document.getElementById('dashboard-loading');
          const errorEl = document.getElementById('dashboard-error');
          const contentEl = document.getElementById('dashboard-content');
          
          // Show loading, hide everything else
          loadingEl.style.display = 'block';
          errorEl.style.display = 'none';
          contentEl.style.display = 'none';
          contentEl.classList.remove('loaded');
          contentEl.style.opacity = '0';
          
          console.log('⏳ Loading slot type mappings...');
          
          // Load slot type mappings first
          const slotMappings = await loadSlotMappings();
          console.log('✅ Slot mappings loaded');
          
          console.log('=== DASHBOARD DEBUG INFO ===');
          console.log('Looking for these "On the Day" slot types:', slotMappings.bookOnDayTypes);
          console.log('Looking for these "Duty" slot types:', slotMappings.dutyTypes);
          
          // Get sample of actual slot types in the database
          try {
            const { data: sampleData } = await window.supabase
              .from('emis_apps_filled')
              .select('Slot Type')
              .limit(20);
            
            const uniqueSlotTypes = [...new Set((sampleData || []).map(row => row['Slot Type']).filter(Boolean))];
            console.log('Actual slot types found in database (sample):', uniqueSlotTypes);
            console.log('=== END DEBUG INFO ===');
          } catch (e) {
            console.error('Could not fetch sample slot types:', e);
          }
          
          if (slotMappings.bookOnDayTypes.length === 0) {
            // Show helpful message with link to checker
            document.getElementById('dashboard-loading').style.display = 'none';
            document.getElementById('dashboard-error').style.display = 'block';
            document.getElementById('dashboard-error').innerHTML = `
              <div style="display:flex;align-items:center;gap:12px;">
                <i class="bi bi-info-circle" style="font-size:24px;"></i>
                <div style="flex:1;">
                  <strong>No slot type mappings found</strong>
                  <p style="margin:8px 0 12px 0;opacity:0.9;">You need to configure which EMIS slot types should be counted as "On the Day" and "Duty" slots before viewing the dashboard.</p>
                  <a href="emis_checker.html" class="btn btn-light" style="color:#fff;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);">
                    <i class="bi bi-gear"></i> Go to EMIS Checker
                  </a>
                </div>
              </div>
            `;
            return;
          }
          
          // Get current week's Monday
          const today = new Date();
          const currentMonday = getMonday(today);
          const nextMonday = addDays(currentMonday, 7);
          
          console.log('⏳ Loading current week data (5 days)...');
          
          // Load data for current week
          const currentWeekData = [];
          for (let i = 0; i < 5; i++) {
            const date = addDays(currentMonday, i);
            const dateStr = getDateString(date);
            console.log(`  📅 Loading day ${i+1}/5: ${dateStr}`);
            const metrics = await loadAppointmentsForDate(dateStr, slotMappings);
            currentWeekData.push({
              day: DAYS[i],
              date: date,
              metrics: metrics
            });
          }
          console.log('✅ Current week loaded');
          
          console.log('⏳ Loading next week data (5 days)...');
          
          // Load data for next week
          const nextWeekData = [];
          for (let i = 0; i < 5; i++) {
            const date = addDays(nextMonday, i);
            const dateStr = getDateString(date);
            console.log(`  📅 Loading day ${i+1}/5: ${dateStr}`);
            const metrics = await loadAppointmentsForDate(dateStr, slotMappings);
            nextWeekData.push({
              day: DAYS[i],
              date: date,
              metrics: metrics
            });
          }
          console.log('✅ Next week loaded');
          
          console.log('⏳ Rendering dashboard cards...');
          
          // Render current week
          const currentWeekHtml = currentWeekData.map(day => 
            createDayCard(day.day, day.date, day.metrics)
          ).join('');
          document.getElementById('current-week').innerHTML = currentWeekHtml;
          console.log('✅ Current week rendered');
          
          // Render next week
          const nextWeekHtml = nextWeekData.map(day => 
            createDayCard(day.day, day.date, day.metrics)
          ).join('');
          document.getElementById('next-week').innerHTML = nextWeekHtml;
          console.log('✅ Next week rendered');
          
          console.log('✅ All data loaded successfully! Displaying dashboard with', currentWeekData.length + nextWeekData.length, 'day cards');
          
          // Show the dashboard now that everything is ready
          loadingEl.style.display = 'none';
          errorEl.style.display = 'none';
          contentEl.style.display = 'block';
          contentEl.style.opacity = '1';
          contentEl.classList.add('loaded');
          
          console.log('🎉 Dashboard is now fully visible and ready!');
          
        } catch (err) {
          console.error('❌ Error loading dashboard:', err);
          console.error('Error stack:', err.stack);
          
          const loadingEl = document.getElementById('dashboard-loading');
          const errorEl = document.getElementById('dashboard-error');
          
          loadingEl.style.display = 'none';
          errorEl.style.display = 'block';
          errorEl.textContent = `Error: ${err.message}`;
        }
      }

      // Make showPage globally available
      window.showPage = showPage;

      // Load and render emis_apps_filled table (ordered by csv_row_number asc)
      document.addEventListener('DOMContentLoaded', () => {
        const filledTable = document.getElementById('filled-table');
        const tableHead = filledTable?.querySelector('thead');
        const tableBody = filledTable?.querySelector('tbody');
        const statusEl = document.getElementById('filled-status');
        const errorEl = document.getElementById('filled-error');
        const prevBtn = document.getElementById('filled-prev');
        const nextBtn = document.getElementById('filled-next');
        const pageSizeSel = document.getElementById('filled-page-size');

        if (!tableBody || !tableHead || !statusEl || !prevBtn || !nextBtn || !pageSizeSel) {
          console.log('Table elements not found - skipping table initialization');
          return;
        }

        let from = 0;
        let pageSize = Number(pageSizeSel.value || 50);
        let currentColumns = null; // computed from first non-empty page

        pageSizeSel.addEventListener('change', () => {
          pageSize = Number(pageSizeSel.value || 50);
          from = 0;
          loadPage();
        });

        prevBtn.addEventListener('click', () => {
          if (from === 0) return;
          from = Math.max(0, from - pageSize);
          loadPage();
        });

        nextBtn.addEventListener('click', () => {
          from += pageSize;
          loadPage();
        });

        function orderColumns(keys) {
          const preferred = ['csv_row_number','created_at'];
          const set = new Set(keys);
          const rest = keys.filter(k => !preferred.includes(k)).sort();
          return preferred.filter(k => set.has(k)).concat(rest);
        }

        function renderHeader(keys) {
          const cols = orderColumns(keys);
          currentColumns = cols;
          const ths = cols.map(k => `<th scope="col">${k}</th>`).join('');
          tableHead.innerHTML = `<tr>${ths}</tr>`;
        }

        function renderRows(rows) {
          const safe = (v) => {
            if (v == null) return '';
            if (typeof v === 'object') {
              try { return JSON.stringify(v); } catch { return String(v); }
            }
            return String(v);
          };
          tableBody.innerHTML = rows.map(r => {
            const tds = currentColumns.map(k => `<td>${safe(r[k])}</td>`).join('');
            return `<tr>${tds}</tr>`;
          }).join('');
        }

        async function loadPage() {
          try {
            const sb = window.supabase || (window.getSupabase && window.getSupabase());
            if (!sb) throw new Error('Supabase client not available');

            errorEl.style.display = 'none';
            statusEl.textContent = 'Loading…';
            prevBtn.disabled = from === 0;
            nextBtn.disabled = true;

            // Request one extra row to determine if there is a next page
            const to = from + pageSize;
            const { data, error } = await sb
              .from('emis_apps_filled')
              .select('*')
              .order('csv_row_number', { ascending: true })
              .range(from, to); // inclusive range

            if (error) throw error;

            // If we got more than pageSize rows, there is a next page
            const hasNext = (data?.length || 0) > pageSize;
            const rows = hasNext ? data.slice(0, pageSize) : (data || []);

            // Compute columns dynamically on first load with data
            if (!currentColumns) {
              const sample = rows[0] || {};
              const keys = Object.keys(sample);
              if (!keys.length) {
                // If page empty, try to fetch 1 row from start to discover columns
                const { data: probe } = await sb
                  .from('emis_apps_filled')
                  .select('*')
                  .order('csv_row_number', { ascending: true })
                  .range(0, 0);
                const probeKeys = Object.keys((probe && probe[0]) || {});
                if (probeKeys.length) renderHeader(probeKeys);
              } else {
                renderHeader(keys);
              }
            }

            // Render body
            if (currentColumns) renderRows(rows);
            else tableBody.innerHTML = '';

            // Update controls
            nextBtn.disabled = !hasNext;
            const page = Math.floor(from / pageSize) + 1;
            statusEl.textContent = `Page ${page} • showing ${rows.length} rows • ${currentColumns ? currentColumns.length : 0} columns`;
          } catch (e) {
            console.error('Failed to load emis_apps_filled:', e);
            errorEl.textContent = e.message || String(e);
            errorEl.style.display = 'block';
            statusEl.textContent = 'Failed to load';
          }
        }

        // initial load
        loadPage();
      });

      // Initialize debug panel on document load
      document.addEventListener('DOMContentLoaded', function() {
        // Show debug panel with Alt+D keyboard shortcut
        document.addEventListener('keydown', function(e) {
          if (e.altKey && e.key === 'd') {
            toggleDebugPanel();
          }
        });
        
        // Toggle debug panel visibility
        function toggleDebugPanel() {
          const panel = document.getElementById('ai-debug-panel');
          if (panel) {
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
          }
        }
        
        // Set up event listeners for debug panel buttons
        document.getElementById('close-debug-panel')?.addEventListener('click', function() {
          document.getElementById('ai-debug-panel').style.display = 'none';
        });
        
        document.getElementById('toggle-debug-panel')?.addEventListener('click', function(e) {
          e.preventDefault();
          toggleDebugPanel();
        });
        
        document.getElementById('ai-test-btn')?.addEventListener('click', async function() {
          try {
            updateAiStatus('Testing AI connectivity...');
            const result = await window.aiConnectivityTest();
            updateAiStatus(`Test result: ${result.ok ? 'SUCCESS' : 'FAILED'} - ${result.detail || ''}`);
            console.log('AI connectivity test result:', result);
          } catch (err) {
            updateAiStatus(`Test error: ${err.message || String(err)}`);
            console.error('AI test error:', err);
          }
        });
        
        document.getElementById('ai-req-btn')?.addEventListener('click', function() {
          try {
            const req = window.aiRequest();
            updateAiStatus('Request data shown in console');
            alert('Last request data logged to console');
          } catch (err) {
            updateAiStatus(`Error showing request: ${err.message}`);
            console.error('Error showing request:', err);
          }
        });
        
        document.getElementById('ai-res-btn')?.addEventListener('click', function() {
          try {
            const res = window.aiResponse();
            updateAiStatus('Response data shown in console');
            alert('Last response data logged to console');
          } catch (err) {
            updateAiStatus(`Error showing response: ${err.message}`);
            console.error('Error showing response:', err);
          }
        });
        
        document.getElementById('ai-retry-btn')?.addEventListener('click', async function() {
          try {
            updateAiStatus('Resetting cache and reclassifying...');
            // Clear classification cache
            window.slotTypeClassification = null;
            window.__classificationPromise = null;
            
            // Request new classification
            const classification = await window.ensureClassificationOnce();
            updateAiStatus(`Classification complete with ${Object.keys(classification || {}).length} categories`);
            console.log('New classification result:', classification);
          } catch (err) {
            updateAiStatus(`Classification error: ${err.message || String(err)}`);
            console.error('Classification retry error:', err);
          }
        });
        
        // Helper function to update AI status in the debug panel
        function updateAiStatus(message) {
          const statusEl = document.getElementById('ai-status');
          if (statusEl) {
            statusEl.textContent = `Status: ${message}`;
            
            // Add visual feedback
            statusEl.style.backgroundColor = '#f0f9ff';
            setTimeout(() => {
              statusEl.style.backgroundColor = '#f8fafc';
            }, 300);
          }
        }
        
        // Make debug panel draggable
        makeDraggable(document.getElementById('ai-debug-panel'));
        
        // Show debug panel if the URL has a debug parameter
        if (window.location.search.includes('debug=1') || window.location.hash === '#debug') {
          document.getElementById('ai-debug-panel').style.display = 'block';
        }
      });
      
      // Make an element draggable
      function makeDraggable(el) {
        if (!el) return;
        
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        const header = el.querySelector('h4') || el;
        
        if (header) {
          header.style.cursor = 'move';
          header.onmousedown = dragMouseDown;
        }
        
        function dragMouseDown(e) {
          e = e || window.event;
          e.preventDefault();
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.onmouseup = closeDragElement;
          document.onmousemove = elementDrag;
        }
        
        function elementDrag(e) {
          e = e || window.event;
          e.preventDefault();
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;
          
          // Calculate new position
          const newTop = (el.offsetTop - pos2);
          const newLeft = (el.offsetLeft - pos1);
          
          // Apply position limits to keep panel on screen
          const maxTop = window.innerHeight - el.offsetHeight;
          const maxLeft = window.innerWidth - el.offsetWidth;
          
          el.style.top = Math.max(0, Math.min(maxTop, newTop)) + "px";
          el.style.left = Math.max(0, Math.min(maxLeft, newLeft)) + "px";
        }
        
        function closeDragElement() {
          document.onmouseup = null;
          document.onmousemove = null;
        }
      }
    </script>

    <script>
        // --- Core Classification Functions (Global Scope) ---
        // These must be at top level so ensureClassificationOnce can find them
        
        // Low-level: call edge function, fallback to direct fetch; return { data, error, status }
        async function callClassify(slotTypes) {
          const body = { slotTypes };
          const url = (window.CONFIG && window.CONFIG.SUPABASE_URL ? window.CONFIG.SUPABASE_URL : '') + '/functions/v1/classify-slot-types';
          // Try supabase.functions.invoke first
          try {
            const t0 = Date.now();
            const { data, error } = await window.supabase.functions.invoke('classify-slot-types', { body });
            const ms = Date.now() - t0;
            if (error) return { data: null, error: new Error(error.message || String(error)), status: `invoke_error_${ms}ms` };
            // Stash minimal debug when server doesn't send debug block
            try { if (!window.lastAIRawResponse) window.lastAIRawResponse = JSON.stringify(data).slice(0, 4000); } catch(_) {}
            return { data, error: null, status: `invoke_ok_${ms}ms` };
          } catch (e) {
            // Fallback to direct fetch
            try {
              const t1 = Date.now();
              const res = await fetch(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${(window.CONFIG && window.CONFIG.SUPABASE_ANON_KEY) || ''}`
                },
                body: JSON.stringify(body)
              });
              const ms2 = Date.now() - t1;
              let txt = '';
              try { txt = await res.text(); } catch(_) {}
              try { window.lastAIRawResponse = txt; } catch(_) {}
              if (!res.ok) return { data: null, error: new Error(`HTTP ${res.status} ${res.statusText}`), status: `fetch_error_${ms2}ms` };
              let data = null; try { data = JSON.parse(txt); } catch { data = null; }
              return { data, error: null, status: `fetch_ok_${ms2}ms` };
            } catch (e2) {
              return { data: null, error: e2, status: 'fetch_throw' };
            }
          }
        }
        
        // Expose globally
        window.callClassify = callClassify;
    
        // Appointment Type Setup functionality
        function setupAppointmentTypes() {
            const statusEl = document.getElementById('appt-setup-status');
            const bodyEl = document.getElementById('appt-setup-body');
            const btnAll = document.getElementById('appt-match-all');
            const btnClear = document.getElementById('appt-clear');
            
            // Skip if elements not found (wrong step)
            if (!statusEl || !bodyEl || !btnAll || !btnClear) return;

            const urgentPattern = /\b(emergency|urgent|same\s*day|book\s*on\s*day|bod)\b/i;

            // Categories to identify
            const categories = [
              { key: 'on_the_day',    label: 'Book on the day',     source: 'ai' },
              { key: 'within_1_week', label: 'Within 1 week',       source: 'ai' },
              { key: 'within_2_weeks',label: 'Within 2 weeks',      source: 'ai' },
              { key: 'duty',          label: 'Duty slot (today only)', pattern: /\b(duty|duty\s*dr|duty\s*slot)\b/i },
              { key: 'nhs_111',       label: '111 slots',             pattern: /\b(111|nhs\s*111)\b/i },
              { key: 'break',         label: 'Breaks',                pattern: /\b(break|comfort)\b/i },
              { key: 'lunch',         label: 'Lunch',                 pattern: /\b(lunch|meal)\b/i },
              { key: 'admin',         label: 'Admin slots',           pattern: /\b(admin|administration|paperwork)\b/i },
            ];

            // Local selection state
            const selections = {}; // { key: selectedLabel }

            function setStatus(text){ if(statusEl) statusEl.textContent = text; }

            function normalizeLabel(s){ return String(s || '').trim().replace(/\s+/g,' '); }

            async function ensureSlotTypes(){
              // Reuse already loaded values when present
              if (Array.isArray(window.loadedSlotTypes) && window.loadedSlotTypes.length) return window.loadedSlotTypes;

              const started = performance.now();
              const sb = window.supabase || (window.getSupabase && window.getSupabase());
              if (!sb) throw new Error('Supabase client not available');

              const PAGE_SIZE = 1000;
              let offset = 0;
              const seen = new Set();
              const originals = new Map();

              setStatus('Loading slot types from EMIS…');
              while (true) {
                const { data, error } = await sb
                  .from('emis_apps_raw')
                  .select('slot_type')
                  .not('slot_type', 'is', null)
                  .order('slot_type', { ascending: true })
                  .range(offset, offset + PAGE_SIZE - 1);
                if (error) throw error;
                if (!data || !data.length) break;

                for (const r of data) {
                  const label = normalizeLabel(r.slot_type);
                  if (!label) continue;
                  const key = label.replace(/\s+/g,'');
                  if (!seen.has(key)) { seen.add(key); originals.set(key, label); }
                }

                if (data.length < PAGE_SIZE) break;
                offset += PAGE_SIZE;
              }

              const values = Array.from(seen).sort().map(k => originals.get(k));
              window.loadedSlotTypes = values;
              const dur = Math.round(performance.now() - started);
              setStatus(`Loaded ${values.length} slot types (${dur}ms)`);
              return values;
            }

            function nudgeUrgent(classification){
              const nudged = {
                on_the_day: [...(classification.on_the_day || [])],
                within_1_week: [],
                within_2_weeks: []
              };
              (classification.within_1_week || []).forEach(s => urgentPattern.test(s) ? nudged.on_the_day.push(s) : nudged.within_1_week.push(s));
              (classification.within_2_weeks || []).forEach(s => urgentPattern.test(s) ? nudged.on_the_day.push(s) : nudged.within_2_weeks.push(s));
              nudged.on_the_day = [...new Set(nudged.on_the_day)];
              return nudged;
            }
            
            // Render a lightweight Step 4 UI (client-only, does not call Supabase)
            // Removed duplicate renderStep4Setup() - using the more complete version below at line ~1979
            // Appointment type setup functionality
            async function initAppointmentSetup() {
              const setupStatus = document.getElementById('appt-setup-status');
              const setupBody = document.getElementById('appt-setup-body');
              const saveBtn = document.getElementById('appt-save');
              const matchAllBtn = document.getElementById('appt-match-all');
              const clearBtn = document.getElementById('appt-clear');
              
              if (!setupStatus || !setupBody) return;
              
              // Make sure we have slot types loaded
              if (!window.loadedSlotTypes || !window.loadedSlotTypes.length) {
                setupStatus.textContent = 'Loading slot types...';
                try {
                  await loadSlotTypesDropdown();
                } catch (err) {
                  setupStatus.textContent = 'Error loading slot types';
                  setupStatus.classList.add('error');
                  return;
                }
              }
              
              const slotTypes = window.loadedSlotTypes || [];
              if (!slotTypes.length) {
                setupStatus.textContent = 'No slot types available';
                setupStatus.classList.add('error');
                return;
              }
              
              // Get classifications if available
              let classification = window.slotTypeClassification;
              if (!classification) {
                setupStatus.textContent = 'Classifying slot types...';
                try {
                  classification = await ensureClassification(slotTypes);
                } catch (err) {
                  console.error('Classification error:', err);
                  // Continue without classification, we'll just show empty dropdowns
                }
              }
              
              // Build the UI with our categories
              setupStatus.textContent = 'Ready';
              setupStatus.classList.remove('error');
              buildAppointmentSetupRows(setupBody, slotTypes, classification);
              
              // Build the UI with our categories
              setupStatus.textContent = 'Ready';
              setupStatus.classList.remove('error');
              buildAppointmentSetupRows(setupBody, slotTypes, classification);
              
              // Setup buttons
              if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                  setupStatus.textContent = 'Configuration saved';
                  setTimeout(() => { setupStatus.textContent = 'Ready'; }, 2000);
                });
              }
              
              if (matchAllBtn) {
                matchAllBtn.addEventListener('click', () => {
                  setupBody.querySelectorAll('input[type="checkbox"]:not(:checked)').forEach(cb => {
                    const sel = cb.closest('tr').querySelector('select');
                    if (sel && sel.value !== '— Select —') {
                      cb.checked = true;
                    }
                  });
                });
              }
              
              if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                  setupBody.querySelectorAll('select').forEach(sel => {
                    sel.value = '— Select —';
                  });
                  setupBody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                  });
                });
              }
            }
            
            function buildAppointmentSetupRows(bodyEl, slotTypes, classification) {
              bodyEl.innerHTML = '';
              const opts = ['— Select —', ...slotTypes];
              
              // Sample categories - matching the screenshot
              const setupCategories = [
                { key: 'on_the_day', label: 'Book on the day', source: 'ai' },
                { key: 'within_1_week', label: 'Within 1 week', source: 'ai' },
                { key: 'within_2_weeks', label: 'Within 2 weeks', source: 'ai' },
                { key: 'duty', label: 'Duty slot', pattern: /\b(duty|triage)\b/i },
                { key: '111', label: '111 slots', pattern: /\b111\b/i },
                { key: 'breaks', label: 'Breaks', pattern: /\b(break|lunch)\b/i },
                { key: 'admin', label: 'Admin slots', pattern: /\b(admin|meeting)\b/i }
              ];

              function suggestedFor(cat) {
                if (!classification) return '';
                
                if (cat.source === 'ai') {
                  const arr = classification[cat.key] || [];
                  return arr[0] || '';
                }
                if (cat.pattern) {
                  const m = slotTypes.find(s => cat.pattern.test(s));
                  return m || '';
                }
                return '';
              }

              setupCategories.forEach(cat => {
                const tr = document.createElement('tr');
                const tdName = document.createElement('td');
                const tdSel = document.createElement('td');
                const tdConfirm = document.createElement('td');

                tdName.innerHTML = `<div class="cat-name">${cat.label}</div>`;

                const sel = document.createElement('select');
                sel.dataset.catKey = cat.key;
                opts.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
                const suggestion = suggestedFor(cat);
                if (suggestion) sel.value = suggestion;

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.dataset.catKey = cat.key;
                cb.checked = !!suggestion;

                tdSel.appendChild(sel);
                tdConfirm.appendChild(cb);
                tr.appendChild(tdName);
                tr.appendChild(tdSel);
                tr.appendChild(tdConfirm);
                bodyEl.appendChild(tr);
                
                // Hook up events
                sel.addEventListener('change', () => {
                  if (sel.value !== '— Select —') {
                    cb.checked = true;
                  }
                });
              });
            }
            
            

            async function ensureClassification(slotTypes){
              if (window.slotTypeClassification) return window.slotTypeClassification;
              const sb = window.supabase || (window.getSupabase && window.getSupabase());
              if (!sb) throw new Error('Supabase client not available');

              const t0 = performance.now();
              setStatus('Classifying slot types…');
              const { data, error } = await sb.functions.invoke('classify-slot-types', { body: { slotTypes } });
              if (error) throw new Error(error.message || 'Edge function failed');
              const raw = data?.classification || data;
              if (!raw) throw new Error('No classification returned');
              const nudged = nudgeUrgent(raw);
              window.slotTypeClassification = nudged;
              const dt = Math.round(performance.now() - t0);
              setStatus(`Classified in ${dt}ms`);
              return nudged;
            }

            function buildRows(slotTypes, classification){
              bodyEl.innerHTML = '';
              const opts = ['— Select —', ...slotTypes];

              function suggestedFor(cat){
                if (cat.source === 'ai') {
                  const arr = classification[cat.key] || [];
                  // Prefer first AI suggestion
                  return arr[0] || '';
                }
                if (cat.pattern) {
                  const m = slotTypes.find(s => cat.pattern.test(s));
                  return m || '';
                }
                return '';
              }

              categories.forEach(cat => {
                const tr = document.createElement('tr');
                const tdName = document.createElement('td');
                const tdSel = document.createElement('td');
                const tdConfirm = document.createElement('td');

                tdName.innerHTML = `<div class="cat-name">${cat.label}</div>`;

                const sel = document.createElement('select');
                opts.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
                const suggestion = suggestedFor(cat);
                if (suggestion) sel.value = suggestion; else sel.value = '— Select —';

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.ariaLabel = `Confirm ${cat.label}`;
                cb.addEventListener('change',() => {
                  if (cb.checked && sel.value && sel.value !== '— Select —') {
                    tr.classList.add('row-confirmed');
                    selections[cat.key] = sel.value;
                  } else {
                    tr.classList.remove('row-confirmed');
                    delete selections[cat.key];
                  }
                  setStatus(Object.keys(selections).length ? `Confirmed ${Object.keys(selections).length} / ${categories.length}` : 'No selections yet');
                });

                sel.addEventListener('change', () => {
                  if (cb.checked) cb.dispatchEvent(new Event('change'));
                });

                tdSel.appendChild(sel);
                tdConfirm.appendChild(cb);
                tr.appendChild(tdName); tr.appendChild(tdSel); tr.appendChild(tdConfirm);
                bodyEl.appendChild(tr);

                // Auto-confirm suggested matches for AI categories
                if (suggestion && cat.source === 'ai') {
                  cb.checked = true; cb.dispatchEvent(new Event('change'));
                }
              });
            }

            btnAll.addEventListener('click', () => {
              // Confirm all rows with current selections; if not selected, try to set suggestion and confirm
              Array.from(bodyEl.querySelectorAll('tr')).forEach((tr, idx) => {
                const cat = categories[idx];
                const sel = tr.querySelector('select');
                const cb = tr.querySelector('input[type="checkbox"]');
                if (sel && (!sel.value || sel.value === '— Select —')) {
                  // set suggestion if available
                  const slotTypes = window.loadedSlotTypes || [];
                  const classification = window.slotTypeClassification || { on_the_day:[], within_1_week:[], within_2_weeks:[] };
                  let s = '';
                  if (cat.source === 'ai') s = (classification[cat.key]||[])[0] || '';
                  else if (cat.pattern) s = (slotTypes.find(x => cat.pattern.test(x)) || '');
                  if (s) sel.value = s;
                }
                if (cb && sel && sel.value && sel.value !== '— Select —') { cb.checked = true; cb.dispatchEvent(new Event('change')); }
              });
              setStatus(`All matched where possible (${Object.keys(selections).length} confirmed)`);
            });

            btnClear.addEventListener('click', () => {
              Object.keys(selections).forEach(k => delete selections[k]);
              Array.from(bodyEl.querySelectorAll('tr')).forEach(tr => { tr.classList.remove('row-confirmed'); });
              Array.from(bodyEl.querySelectorAll('input[type="checkbox"]')).forEach(cb => cb.checked = false);
              setStatus('Cleared selections');
            });

            (async function init(){
              try {
                const slotTypes = await ensureSlotTypes();
                const classification = await ensureClassification(slotTypes);
                buildRows(slotTypes, classification);
              } catch (e) {
                console.error('Appointment setup init error:', e);
                setStatus('Error: ' + (e?.message || String(e)));
              }
            })();
        }

        // Helper: load unique slot types from emis_apps_raw into window.loadedSlotTypes
        async function loadUniqueSlotTypes() {
          if (Array.isArray(window.loadedSlotTypes) && window.loadedSlotTypes.length) return window.loadedSlotTypes;
          const sb = window.supabase || (window.getSupabase && window.getSupabase());
          if (!sb) throw new Error('Supabase client not available');
          const PAGE_SIZE = 1000;
          let offset = 0;
          const seen = new Set();
          const originals = new Map();
          while (true) {
            const { data, error } = await sb
              .from('emis_apps_raw')
              .select('slot_type')
              .not('slot_type', 'is', null)
              .order('slot_type', { ascending: true })
              .range(offset, offset + PAGE_SIZE - 1);
            if (error) throw error;
            if (!data || !data.length) break;
            for (const r of data) {
              const label = String(r.slot_type || '').trim();
              if (!label) continue;
              const key = label.replace(/\s+/g,'');
              if (!seen.has(key)) { seen.add(key); originals.set(key, label); }
            }
            if (data.length < PAGE_SIZE) break;
            offset += PAGE_SIZE;
          }
          const values = Array.from(seen).sort().map(k => originals.get(k));
          window.loadedSlotTypes = values;
          return values;
        }

        // Orchestrator: ensure slot types are fully loaded (single in-flight promise)
        let __slotTypesLoadPromise = null;
        async function ensureSlotTypesOnce() {
          if (Array.isArray(window.loadedSlotTypes) && window.loadedSlotTypes.length) return window.loadedSlotTypes;
          if (!__slotTypesLoadPromise) {
            __slotTypesLoadPromise = loadUniqueSlotTypes()
              .catch(err => { __slotTypesLoadPromise = null; throw err; });
          }
          return __slotTypesLoadPromise;
        }

        // Orchestrator: ensure classification happens after slot types are loaded, prevent duplicate invokes
        let __classificationPromise = null;
        async function ensureClassificationOnce() {
          await ensureSlotTypesOnce();
          if (window.slotTypeClassification && window.slotTypeClassification.on_the_day) return window.slotTypeClassification;
          if (!__classificationPromise) {
            // Use the global window.classifySlotTypes if available
            if (typeof window.classifySlotTypes === 'function') {
              __classificationPromise = window.classifySlotTypes()
                .catch(err => { __classificationPromise = null; throw err; });
            } else if (typeof classifySlotTypes === 'function') {
              __classificationPromise = classifySlotTypes()
                .catch(err => { __classificationPromise = null; throw err; });
            } else if (typeof ensureClassification === 'function') {
              __classificationPromise = (async () => {
                try {
                  const slotTypes = window.loadedSlotTypes || (await ensureSlotTypesOnce());
                  const res = await ensureClassification(slotTypes);
                  return res;
                } catch (err) { __classificationPromise = null; throw err; }
              })();
            } else {
              throw new Error('No classification function available');
            }
          }
          return __classificationPromise;
        }

        function resetClassificationCache() {
          try { window.slotTypeClassification = null; } catch(_) {}
          __classificationPromise = null;
        }
        
        // Global availability for test functions
        // Simple connectivity and auth diagnostic
        window.aiConnectivityTest = async function() {
          console.log('Running AI connectivity test...');
          const sample = ['Urgent on day','Routine appt','Follow-up in 10 days'];
          try {
            const sb = window.supabase || (window.getSupabase && window.getSupabase());
            if (!sb) throw new Error('No Supabase client found');
            
            console.log('Testing with direct invoke');
            const { data, error } = await sb.functions.invoke('classify-slot-types', { 
              body: { slotTypes: sample }
            });
            
            if (error) throw new Error(error.message || String(error));
            console.log('Test result:', data);
            
            const cls = data && (data.classification || data);
            const ok = cls && (Array.isArray(cls.on_the_day) || Array.isArray(cls.within_1_week) || Array.isArray(cls.within_2_weeks));
            return { ok: !!ok, detail: 'invoke_ok' };
          } catch (e) {
            console.error('Test error:', e);
            return { ok: false, detail: e?.message || String(e) };
          }
        };
        
        // Last request payload sent to AI
        window.lastAIRequest = null;
        
        // Last response received from AI
        window.lastAIResponse = null;
        
        // Display the last request payload
        window.aiRequest = function() {
          console.log('Last AI request payload:', window.lastAIRequest);
          return window.lastAIRequest;
        };
        
        // Display the last response from AI
        window.aiResponse = function() {
          console.log('Last AI response:', window.lastAIResponse);
          return window.lastAIResponse;
        };

        // Expose a global renderer for Step 4 so callers outside
        // the nested setup function can invoke it (MutationObserver,
        // showWelcomeStep, etc.). This mirrors the inner function's
        // behavior but lives at top-level.
        async function renderStep4Setup() {
          console.log('global renderStep4Setup() called');
          const step4Bd = document.querySelector('.wstep[data-wstep="4"] .card-bd');
          if (!step4Bd) return;

          // Idempotency & race guard:
          // - If fully rendered, skip immediately.
          // - If another render is in progress, skip to avoid concurrent builds.
          if (step4Bd.dataset.step4Rendered === '1') {
            console.log('renderStep4Setup: already rendered, skipping');
            return;
          }
          if (step4Bd.dataset.step4Rendering === '1') {
            console.log('renderStep4Setup: render already in progress, skipping');
            return;
          }

          // Mark rendering-in-progress to avoid races from other callers
          step4Bd.dataset.step4Rendering = '1';

          // Clear existing content - render directly in the card like other steps
          step4Bd.innerHTML = '';
          const container = step4Bd;

          const heading = document.createElement('h4');
          heading.textContent = 'Appointment Type Setup';
          heading.style.marginTop = '0';
          heading.style.fontSize = '1.5rem';
          heading.style.fontWeight = '600';
          heading.style.color = '#1e293b';
          heading.style.borderBottom = '2px solid #3b82f6';
          heading.style.paddingBottom = '8px';
          heading.style.marginBottom = '16px';
          container.appendChild(heading);

          const hint = document.createElement('div');
          hint.className = 'hint';
          hint.textContent = 'Select the slot type that corresponds to each appointment category and confirm.';
          hint.style.backgroundColor = '#f0f9ff';
          hint.style.border = '1px solid #bae6fd';
          hint.style.borderLeft = '4px solid #38bdf8';
          hint.style.borderRadius = '6px';
          hint.style.padding = '12px 16px';
          hint.style.marginBottom = '20px';
          hint.style.color = '#0c4a6e';
          hint.style.fontSize = '0.95rem';
          hint.style.lineHeight = '1.5';
          container.appendChild(hint);

          // AI status + controls row
          const aiRow = document.createElement('div');
          aiRow.style.display = 'flex';
          aiRow.style.alignItems = 'center';
          aiRow.style.gap = '10px';
          aiRow.style.margin = '6px 0 8px 0';
          const aiStatus = document.createElement('span');
          aiStatus.id = 'ai-status-line';
          aiStatus.style.fontSize = '12px';
          aiStatus.style.color = '#334155';
          aiStatus.textContent = 'AI status: idle';
          const aiRetry = document.createElement('button');
          aiRetry.id = 'step4-ai-retry-btn';
          aiRetry.type = 'button';
          aiRetry.textContent = 'Retry classify';
          aiRetry.style.padding = '6px 10px';
          aiRetry.style.borderRadius = '6px';
          aiRetry.style.border = '1px solid #e2e8f0';
          aiRetry.style.background = '#fff';
          aiRetry.style.cursor = 'pointer';
          const aiTest = document.createElement('button');
          aiTest.id = 'step4-ai-test-btn';
          aiTest.type = 'button';
          aiTest.textContent = 'Test AI connectivity';
          aiTest.style.padding = '6px 10px';
          aiTest.style.borderRadius = '6px';
          aiTest.style.border = '1px solid #e2e8f0';
          aiTest.style.background = '#fff';
          aiTest.style.cursor = 'pointer';
          aiRow.appendChild(aiStatus);
          aiRow.appendChild(aiRetry);
          aiRow.appendChild(aiTest);
          container.appendChild(aiRow);

          const table = document.createElement('table');
          table.style.width = '100%';
          table.style.borderCollapse = 'collapse';
          table.style.marginTop = '12px';
          table.style.border = '1px solid #e2e8f0';

          const thead = document.createElement('thead');
          thead.innerHTML = '<tr><th style="width:260px;text-align:left;padding:12px 16px;border-bottom:2px solid #3b82f6;background-color:#f1f5f9;color:#334155;font-weight:600;font-size:0.95rem;">Type to identify</th><th style="text-align:left;padding:12px 16px;border-bottom:2px solid #3b82f6;background-color:#f1f5f9;color:#334155;font-weight:600;font-size:0.95rem;">Slot type (from EMIS)</th><th style="width:120px;padding:12px 16px;border-bottom:2px solid #3b82f6;background-color:#f1f5f9;color:#334155;font-weight:600;font-size:0.95rem;text-align:center">Confirm</th></tr>';
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          table.appendChild(tbody);
          
          // Add a loading indicator while waiting for data
          const loadingRow = document.createElement('tr');
          
          // Create loading cell with animation
          const loadingCell = document.createElement('td');
          loadingCell.colSpan = 3;
          loadingCell.style.textAlign = 'center';
          loadingCell.style.padding = '30px 20px';
          
          // Create loading content
          const loadingContent = document.createElement('div');
          loadingContent.style.display = 'flex';
          loadingContent.style.alignItems = 'center';
          loadingContent.style.justifyContent = 'center';
          loadingContent.style.gap = '12px';
          
          // Create spinner animation
          const spinner = document.createElement('div');
          spinner.style.width = '24px';
          spinner.style.height = '24px';
          spinner.style.border = '3px solid rgba(59, 130, 246, 0.2)';
          spinner.style.borderRadius = '50%';
          spinner.style.borderTop = '3px solid #3b82f6';
          spinner.style.animation = 'spin 1s linear infinite';
          
          // Create loading text
          const loadingText = document.createElement('span');
          loadingText.textContent = 'Loading slot types...';
          loadingText.style.color = '#64748b';
          loadingText.style.fontWeight = '500';
          
          // Assemble loading indicator
          loadingContent.appendChild(spinner);
          loadingContent.appendChild(loadingText);
          loadingCell.appendChild(loadingContent);
          loadingRow.appendChild(loadingCell);
          
          // Add animation style if not already added
          if (!document.getElementById('loading-animation-style')) {
            const style = document.createElement('style');
            style.id = 'loading-animation-style';
            style.textContent = `
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
            `;
            document.head.appendChild(style);
          }
          
          tbody.appendChild(loadingRow);

          // Ensure slot types are loaded from the database (via orchestrator)
          let slotTypes = (Array.isArray(window.loadedSlotTypes) && window.loadedSlotTypes.length) ? window.loadedSlotTypes : [];
          if (!slotTypes.length) {
            try { slotTypes = await ensureSlotTypesOnce(); } catch (e) { console.warn('Failed to load slot types for Step 4:', e); }
          }
          
          // Clear loading indicator once data is loaded
          tbody.innerHTML = '';

          const categoriesForUI = [
            { key: 'on_the_day', label: 'Book on the day' },
            { key: 'within_1_week', label: 'Within 1 week' },
            { key: 'within_2_weeks', label: 'Within 2 weeks' },
            { key: 'duty', label: 'Duty slot' },
            { key: 'nhs_111', label: '111 slots' },
            { key: 'break', label: 'Breaks' },
            { key: 'admin', label: 'Admin slots' }
          ];

          // If we have slot types, classify (via orchestrator) and preselect AI suggestions
          let classification = window.slotTypeClassification;
          if ((!classification || !classification.on_the_day) && slotTypes.length) {
            try {
              const statusEl = document.getElementById('ai-status-line');
              if (statusEl) statusEl.textContent = `AI status: classifying ${slotTypes.length} slot types…`;
              classification = await ensureClassificationOnce();
              if (statusEl) {
                const counts = {
                  o: (classification.on_the_day||[]).length,
                  w1: (classification.within_1_week||[]).length,
                  w2: (classification.within_2_weeks||[]).length
                };
                statusEl.textContent = `AI status: classified (on_the_day ${counts.o}, within_1_week ${counts.w1}, within_2_weeks ${counts.w2})`;
              }
            } catch (err) {
              console.warn('Classification failed in Step 4:', err);
              const statusEl = document.getElementById('ai-status-line');
              if (statusEl) statusEl.textContent = `AI status: error — ${err?.message || err}`;
            }
          }

          categoriesForUI.forEach(cat => {
            const tr = document.createElement('tr');
            
            // Add hover effect for the row
            tr.addEventListener('mouseover', function() {
              this.style.backgroundColor = '#f8fafc';
            });
            
            tr.addEventListener('mouseout', function() {
              this.style.backgroundColor = '';
            });
            
            const tdName = document.createElement('td');
            const tdSel = document.createElement('td');
            const tdConfirm = document.createElement('td');

            // Style the cells
            tdName.style.padding = '12px 10px';
            tdName.style.borderBottom = '1px solid #e2e8f0';
            tdSel.style.padding = '8px';
            tdSel.style.borderBottom = '1px solid #e2e8f0';
            tdConfirm.style.textAlign = 'center';
            tdConfirm.style.padding = '8px';
            tdConfirm.style.borderBottom = '1px solid #e2e8f0';

            tdName.innerHTML = `<div class="cat-name" style="font-weight:600;">${cat.label}</div>`;

            const sel = document.createElement('select');
            sel.style.width = '100%';
            sel.style.padding = '10px';
            sel.style.borderRadius = '4px';
            sel.style.border = '1px solid #cbd5e0';
            sel.style.backgroundColor = '#f7fafc';
            sel.dataset.catKey = cat.key;
            
            const defaultOpt = document.createElement('option'); 
            defaultOpt.value = ''; 
            defaultOpt.textContent = '— Select —'; 
            sel.appendChild(defaultOpt);
            
            const options = slotTypes.length ? slotTypes : ['-- No slot types loaded --', 'Example Slot A', 'Example Slot B'];
            options.forEach(s => { 
              const o = document.createElement('option'); 
              o.value = s; 
              o.textContent = s; 
              sel.appendChild(o); 
            });

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.style.transform = 'scale(1.1)';
            cb.style.marginLeft = '6px';

            // Preselect AI suggestion when available for the three AI categories
            if (classification && (cat.key === 'on_the_day' || cat.key === 'within_1_week' || cat.key === 'within_2_weeks')) {
              const arr = Array.isArray(classification[cat.key]) ? classification[cat.key] : [];
              if (arr.length) {
                sel.value = arr[0];
                if (sel.value) cb.checked = true;
              }
            } else {
              // Heuristic suggestions for the non-AI categories
              if (options.length) {
                const patternMap = {
                  duty: /(\bduty\b|duty\s*dr|duty\s*slot)/i,
                  nhs_111: /(111|nhs\s*111)/i,
                  break: /\b(break|comfort)\b/i,
                  admin: /\b(admin|administration|paperwork)\b/i
                };
                const pat = patternMap[cat.key];
                if (pat) {
                  const match = options.find(s => pat.test(s));
                  if (match) { sel.value = match; cb.checked = true; }
                }
              }
            }

            tdSel.appendChild(sel);
            tdConfirm.appendChild(cb);
            tr.appendChild(tdName); 
            tr.appendChild(tdSel); 
            tr.appendChild(tdConfirm);
            tbody.appendChild(tr);

            sel.addEventListener('change', () => { if (sel.value) cb.checked = true; });
            
            // Highlight confirmed rows
            if (cb.checked) {
              tr.style.backgroundColor = '#f0fdf4';
              sel.style.backgroundColor = '#e6fffa';
              sel.style.borderColor = '#38b2ac';
            }
            
            cb.addEventListener('change', function() {
              if (this.checked && sel.value) {
                tr.style.backgroundColor = '#f0fdf4';
                sel.style.backgroundColor = '#e6fffa';
                sel.style.borderColor = '#38b2ac';
              } else {
                tr.style.backgroundColor = '';
                sel.style.backgroundColor = '#f7fafc';
                sel.style.borderColor = '#cbd5e0';
              }
            });
          });

          container.appendChild(table);
          console.log('STEP4: rows rendered:', document.querySelectorAll('.wstep[data-wstep="4"] .card-bd tbody tr').length);

          // Actions row
          const actions = document.createElement('div');
          actions.style.display = 'flex'; 
          actions.style.gap = '8px'; 
          actions.style.marginTop = '16px';
          actions.style.justifyContent = 'flex-start';

          const btnConfirmAll = document.createElement('button'); 
          btnConfirmAll.className = 'btn-primary'; 
          btnConfirmAll.type = 'button'; 
          btnConfirmAll.textContent = 'Confirm All';
          btnConfirmAll.style.padding = '10px 16px';
          btnConfirmAll.style.backgroundColor = '#3b82f6';
          btnConfirmAll.style.color = 'white';
          btnConfirmAll.style.border = 'none';
          btnConfirmAll.style.borderRadius = '6px';
          btnConfirmAll.style.fontWeight = '600';
          btnConfirmAll.style.cursor = 'pointer';
          btnConfirmAll.style.boxShadow = '0 2px 6px rgba(37,99,235,0.2)';
          
          const btnClear = document.createElement('button'); 
          btnClear.className = 'btn-secondary'; 
          btnClear.type = 'button'; 
          btnClear.textContent = 'Clear';
          btnClear.style.padding = '10px 16px';
          btnClear.style.backgroundColor = 'white';
          btnClear.style.color = '#334155';
          btnClear.style.border = '1px solid #e2e8f0';
          btnClear.style.borderRadius = '6px';
          btnClear.style.fontWeight = '500';
          btnClear.style.cursor = 'pointer';

          btnConfirmAll.addEventListener('click', () => {
            tbody.querySelectorAll('tr').forEach(tr => {
              const sel = tr.querySelector('select'); 
              const cb = tr.querySelector('input[type="checkbox"]');
              if (sel && cb && sel.value && sel.value !== '') {
                cb.checked = true;
                tr.style.backgroundColor = '#f0fdf4';
                sel.style.backgroundColor = '#e6fffa';
                sel.style.borderColor = '#38b2ac';
              }
            });
            
            // Add a success message
            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success';
            successMsg.style.marginTop = '16px';
            successMsg.style.padding = '10px 14px';
            successMsg.style.backgroundColor = '#f0fdf4';
            successMsg.style.borderLeft = '4px solid #22c55e';
            successMsg.style.borderRadius = '4px';
            successMsg.innerHTML = '<strong>All applicable slot types confirmed!</strong>';
            
            // Remove any existing success message before adding a new one
            const existingMsg = container.querySelector('.alert-success');
            if (existingMsg) existingMsg.remove();
            
            container.appendChild(successMsg);
          });

          btnClear.addEventListener('click', () => {
            tbody.querySelectorAll('tr').forEach(tr => {
              const sel = tr.querySelector('select'); 
              const cb = tr.querySelector('input[type="checkbox"]');
              if (sel) {
                sel.value = '';
                sel.style.backgroundColor = '#f7fafc';
                sel.style.borderColor = '#cbd5e0';
              }
              if (cb) cb.checked = false;
              tr.style.backgroundColor = '';
            });
            
            // Remove any success messages
            const existingMsg = container.querySelector('.alert-success');
            if (existingMsg) existingMsg.remove();
          });

          actions.appendChild(btnConfirmAll); 
          actions.appendChild(btnClear);
          container.appendChild(actions);

          // Wire AI buttons (using step4-specific IDs to avoid conflicts with global debug panel)
          try {
            const statusEl = document.getElementById('ai-status-line');
            const retryBtn = document.getElementById('step4-ai-retry-btn');
            const testBtn = document.getElementById('step4-ai-test-btn');
            if (retryBtn) retryBtn.addEventListener('click', async () => {
              try {
                resetClassificationCache();
                if (statusEl) statusEl.textContent = 'AI status: retrying…';
                const cls = await ensureClassificationOnce();
                const counts = { o: (cls.on_the_day||[]).length, w1: (cls.within_1_week||[]).length, w2: (cls.within_2_weeks||[]).length };
                if (statusEl) statusEl.textContent = `AI status: classified (on_the_day ${counts.o}, within_1_week ${counts.w1}, within_2_weeks ${counts.w2})`;
              } catch (e) { if (statusEl) statusEl.textContent = `AI status: error — ${e?.message || e}`; }
            });
            if (testBtn) testBtn.addEventListener('click', async () => {
              try {
                if (statusEl) statusEl.textContent = 'AI test: pinging function…';
                const diag = await window.aiConnectivityTest();
                if (statusEl) statusEl.textContent = `AI test: ${diag.ok ? 'OK' : 'FAIL'} (${diag.detail})`;
              } catch (e) { if (statusEl) statusEl.textContent = `AI test: error — ${e?.message || e}`; }
            });
          } catch(_) {}

          // Watch for accidental clears of the card body and re-render once if it happens shortly after
          try {
            const obs = new MutationObserver((mutations) => {
              const hasChildren = step4Bd.childNodes && step4Bd.childNodes.length > 0;
              if (!hasChildren) {
                obs.disconnect();
                console.warn('Step 4 card body was cleared; re-rendering');
                setTimeout(() => { try { renderStep4Setup(); } catch(_) {} }, 120);
              }
            });
            obs.observe(step4Bd, { childList: true, subtree: false });
            // Stop observing after 2.5s to avoid long-lived observers
            setTimeout(() => { try { obs.disconnect(); } catch(_) {} }, 2500);
          } catch (e) { console.warn('Could not attach Step 4 observer', e); }
          // Mark fully rendered and clear the rendering-in-progress flag
          try { step4Bd.dataset.step4Rendered = '1'; delete step4Bd.dataset.step4Rendering; } catch(_) {}
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Welcome/setup wizard removed. The page now directly shows the upload UI.
            // Existing upload handlers, classification functions and other utilities remain in-place below.
        });
            // --- Setup (step 4) : Populate slot type dropdown from emis_apps_raw ---
            async function loadSlotTypesDropdown() {
              const select = document.getElementById('emis-slottype-select');
              if (!select) return;
              select.innerHTML = '';

              try {
                const sb = window.supabase || (window.getSupabase && window.getSupabase());
                if (!sb) throw new Error('Supabase client not available');

                // Page through the table in 1k chunks (Supabase PostgREST default max rows)
                // Order by slot_type so we don't depend on csv_row_number distribution
                const PAGE_SIZE = 1000;
                let offset = 0;
                const seen = new Set();
                const originalValues = new Map(); // normalized -> original label

                while (true) {
                  const { data, error } = await sb
                    .from('emis_apps_raw')
                    .select('slot_type')
                    .not('slot_type', 'is', null)
                    .order('slot_type', { ascending: true })
                    .range(offset, offset + PAGE_SIZE - 1);

                  if (error) throw error;
                  if (!data || data.length === 0) break;

                  for (const r of data) {
                    const orig = r?.slot_type;
                    if (orig === null || orig === undefined) continue;
                    const trimmed = String(orig).trim();
                    if (!trimmed) continue;
                    const normalized = trimmed.replace(/\s+/g, '');
                    if (!normalized) continue;
                    if (!seen.has(normalized)) {
                      seen.add(normalized);
                      // preserve the first encountered, nicely trimmed version as the label
                      originalValues.set(normalized, trimmed);
                    }
                  }

                  // Advance to next page; stop when we get a short page
                  if (data.length < PAGE_SIZE) break;
                  offset += PAGE_SIZE;
                }

                // Sort alphabetically by normalized key
                const values = Array.from(seen).sort();

                // Populate select with original label but normalized value
                values.forEach(normalized => {
                  const opt = document.createElement('option');
                  opt.value = normalized;
                  opt.textContent = originalValues.get(normalized) || normalized; // display with spaces
                  select.appendChild(opt);
                });

                console.log(`Loaded ${values.length} unique Slot Types from emis_apps_raw`);

                // Store the loaded values globally for classification
                window.loadedSlotTypes = Array.from(values).map(norm => originalValues.get(norm) || norm);

                // Trigger classification now that values are fully loaded (no race with pagination)
                try { await ensureClassificationOnce(); } catch (e) { console.warn('Classification failed after loading slot types', e); }

                // If nothing found, show a single disabled option
                if (values.length === 0) {
                  const opt = document.createElement('option');
                  opt.value = '';
                  opt.textContent = 'No Slot Type values found';
                  opt.disabled = true;
                  select.appendChild(opt);
                }

              } catch (err) {
                console.error('Failed to load Slot Type values:', err);
                const select = document.getElementById('emis-slottype-select');
                if (select) {
                  select.innerHTML = '';
                  const opt = document.createElement('option');
                  opt.value = '';
                  opt.textContent = 'Error loading values';
                  opt.disabled = true;
                  select.appendChild(opt);
                }
              }
            }

            // Note: callClassify is now defined at top-level scope
            // Note: aiConnectivityTest is now defined as window.aiConnectivityTest at top-level scope

            async function classifySlotTypes() {
              console.log('═══════════════════════════════════════════════════════════');
              console.log('🔍 CLASSIFICATION DEBUG - FULL TRACE');
              console.log('═══════════════════════════════════════════════════════════');
              
              // Step 1: Check if data is loaded
              console.log('📋 Step 1: Checking loaded slot types...');
              if (!window.loadedSlotTypes || window.loadedSlotTypes.length === 0) {
                console.error('❌ No slot types loaded in window.loadedSlotTypes');
                console.log('   Current value:', window.loadedSlotTypes);
                return;
              }
              console.log(`✅ Found ${window.loadedSlotTypes.length} slot types to classify`);
              console.log('   First 5 slot types:', window.loadedSlotTypes.slice(0, 5));

              console.log('\n🤖 Step 2: Preparing API request...');
              const slotTypesList = window.loadedSlotTypes.join('\n');
              console.log('   Total characters in list:', slotTypesList.length);
              
              const requestBody = {
                text: `You are an expert healthcare appointment scheduler. Below is a list of appointment slot types from an EMIS system. Please classify each into ONE of these categories:
1. "On the day" - Appointments available same-day or urgent/emergency appointments
2. "Within 1 week" - Appointments within the next 7 days (including routine/standard appointments)
3. "Within 2 weeks" - Appointments scheduled 8-14 days ahead (including follow-ups)

Return ONLY valid JSON in this exact format with no other text:
{
  "on_the_day": ["slot_type_1", "slot_type_2"],
  "within_1_week": ["slot_type_3", "slot_type_4"],
  "within_2_weeks": ["slot_type_5", "slot_type_6"]
}

Slot Types to classify:
${slotTypesList}`
              };
              
              console.log('   Request body size:', JSON.stringify(requestBody).length, 'bytes');
              console.log('   Target Function: classify-slot-types at', (window.CONFIG && window.CONFIG.SUPABASE_URL ? window.CONFIG.SUPABASE_URL + '/functions/v1/classify-slot-types' : '(missing CONFIG.SUPABASE_URL)'));
              try { window.lastAIRequest = JSON.stringify({ slot_types: window.loadedSlotTypes, format: { on_the_day: [], within_1_week: [], within_2_weeks: [] } }, null, 2); } catch(_) {}

              try {
                console.log('\n📡 Step 3: Sending request to Supabase Edge Function...');
                console.log('   Using supabase.functions.invoke("classify-slot-types") with fallback');
                console.log('   Current page origin:', window.location.origin);

                const fnStart = Date.now();
                // Store the request payload for debugging
                window.lastAIRequest = {
                  slotTypes: window.loadedSlotTypes,
                  count: window.loadedSlotTypes.length
                };
                console.log('   Debug: payload sent to function:', { slotTypesCount: window.loadedSlotTypes.length });
                const result = await callClassify(window.loadedSlotTypes);
                const fnDuration = Date.now() - fnStart;
                console.log(`✅ Function call finished (${result.status}) in ${fnDuration}ms`);
                
                // Store the response for debugging
                window.lastAIResponse = result;
                
                if (result.error) {
                  console.error('❌ Function call error:', result.error);
                  throw new Error(result.error.message || String(result.error));
                }

                console.log('\n📦 Step 4: Parsing function response...');
                console.log('   Raw function response:', result.data);
                // If the function provided debug fields with the prompt and raw AI text, surface them in console
                try {
                  if (result.data && result.data.debug) {
                    console.log('   AI prompt sent (server):', result.data.debug.prompt);
                    console.log('   AI raw response (server):', result.data.debug.aiRaw);
                    // Also attach to global debug store for UI panels
                    window.lastAIRequest = result.data.debug.prompt;
                    window.lastAIRawResponse = result.data.debug.aiRaw;
                  } else {
                    // Build a synthetic prompt so the debug panel still shows something meaningful
                    const syntheticPrompt = `SYSTEM: You classify GP appointment "Slot Types" into exactly three buckets (on_the_day, within_1_week, within_2_weeks).\nRules: strict JSON keys and arrays only.\n\nUSER JSON:\n` + JSON.stringify({ slot_types: window.loadedSlotTypes }, null, 2);
                    window.lastAIRequest = syntheticPrompt;
                    // No raw response available if server doesn't forward it
                    if (!window.lastAIRawResponse) window.lastAIRawResponse = '— Raw AI response not provided by server —';
                  }
                } catch (_) {}

                // Auto-print a compact debug summary to the on-screen debugger
                try {
                  console.info('AI REQUEST: (compact preview)');
                  console.log((window.lastAIRequest || '').slice(0, 500) + '...');
                } catch (_) {}
                // The function returns { success: true, classification: { ... } }
                if (!result.data) {
                  throw new Error('Empty response from classify-slot-types function');
                }

                const classification = result.data.classification || result.data || null;
                if (!classification) {
                  console.error('❌ No classification object in function response');
                  throw new Error('Function did not return classification');
                }
                console.log('   Classification keys:', Object.keys(classification));
                console.log('   Full classification:', JSON.stringify(classification, null, 2));

                // Client-side nudge: enforce urgent/emergency slots are in "on_the_day"
                const urgentPattern = /\b(emergency|urgent|same\s*day|book\s*on\s*day|bod)\b/i;
                const nudgedClassification = {
                  on_the_day: [...(classification.on_the_day || [])],
                  within_1_week: [],
                  within_2_weeks: []
                };
                
                // Check within_1_week for urgent slots
                (classification.within_1_week || []).forEach(slot => {
                  if (urgentPattern.test(slot)) {
                    console.log(`🔄 Client nudge: Moving "${slot}" from within_1_week → on_the_day`);
                    nudgedClassification.on_the_day.push(slot);
                  } else {
                    nudgedClassification.within_1_week.push(slot);
                  }
                });
                
                // Check within_2_weeks for urgent slots
                (classification.within_2_weeks || []).forEach(slot => {
                  if (urgentPattern.test(slot)) {
                    console.log(`🔄 Client nudge: Moving "${slot}" from within_2_weeks → on_the_day`);
                    nudgedClassification.on_the_day.push(slot);
                  } else {
                    nudgedClassification.within_2_weeks.push(slot);
                  }
                });
                
                // Dedupe on_the_day in case AI already included some
                nudgedClassification.on_the_day = [...new Set(nudgedClassification.on_the_day)];
                
                console.log('   Classification after client nudge:', JSON.stringify(nudgedClassification, null, 2));

                // Validate structure
                console.log('\n✔️ Step 7: Validating classification structure...');
                const requiredKeys = ['on_the_day', 'within_1_week', 'within_2_weeks'];
                const missingKeys = requiredKeys.filter(k => !(k in nudgedClassification));
                if (missingKeys.length > 0) {
                  console.warn('⚠️ Missing expected keys:', missingKeys);
                } else {
                  console.log('✅ All expected keys present');
                }

                // Store classification globally
                window.slotTypeClassification = nudgedClassification;
                console.log('\n💾 Step 8: Classification stored in window.slotTypeClassification');
                
                // Display classification results in the UI
                displayClassificationResults(nudgedClassification, fnDuration);
                
                console.log('\n✅ ═══════════════════════════════════════════════════════');
                console.log('✅ CLASSIFICATION COMPLETE - SUMMARY');
                console.log('✅ ═══════════════════════════════════════════════════════');
                console.log(`📊 On the day: ${nudgedClassification.on_the_day?.length || 0} types`);
                if (nudgedClassification.on_the_day?.length) {
                  console.log('   →', nudgedClassification.on_the_day.slice(0, 3).join(', '), nudgedClassification.on_the_day.length > 3 ? '...' : '');
                }
                console.log(`📊 Within 1 week: ${nudgedClassification.within_1_week?.length || 0} types`);
                if (nudgedClassification.within_1_week?.length) {
                  console.log('   →', nudgedClassification.within_1_week.slice(0, 3).join(', '), nudgedClassification.within_1_week.length > 3 ? '...' : '');
                }
                console.log(`📊 Within 2 weeks: ${nudgedClassification.within_2_weeks?.length || 0} types`);
                if (nudgedClassification.within_2_weeks?.length) {
                  console.log('   →', nudgedClassification.within_2_weeks.slice(0, 3).join(', '), nudgedClassification.within_2_weeks.length > 3 ? '...' : '');
                }
                console.log('═══════════════════════════════════════════════════════════\n');

                // Return the nudged classification so callers can use it immediately
                return nudgedClassification;

              } catch (err) {
                console.error('\n❌ CLASSIFICATION FAILED', err);
                // Keep classification error available to background logic, but don't inject UI into step 4
                try { window.classificationError = { message: err.message || String(err) }; } catch (_) {}
                throw err;
              }
            }
            
            // Function to display classification results in the UI
            function displayClassificationResults(classification, timingMs) {
              // Store classification for background use and log a concise summary. Do not inject UI into step 4.
              try { window.slotTypeClassification = classification || {}; } catch (_) {}
              try { window.classificationTimingMs = timingMs; } catch (_) {}
              console.log('Appointment types classified (background only). Timing:', timingMs, 'ms');
              console.log('Classification summary:', {
                on_the_day: (classification?.on_the_day || []).length,
                within_1_week: (classification?.within_1_week || []).length,
                within_2_weeks: (classification?.within_2_weeks || []).length
              });
            }
            
            // Make classifySlotTypes globally accessible (callClassify already exposed at top level)
            window.classifySlotTypes = classifySlotTypes;
            
            // Helper to create a category card
            function createCategoryCard(title, items, color) {
              const card = document.createElement('div');
              card.style.padding = '16px';
              card.style.borderRadius = '8px';
              card.style.border = `1px solid ${color}20`;
              card.style.backgroundColor = `${color}08`;
              
              const titleEl = document.createElement('h5');
              titleEl.style.color = color;
              titleEl.style.fontWeight = '600';
              titleEl.style.marginBottom = '10px';
              titleEl.style.display = 'flex';
              titleEl.style.alignItems = 'center';
              titleEl.style.gap = '8px';
              
              const dot = document.createElement('span');
              dot.style.width = '10px';
              dot.style.height = '10px';
              dot.style.borderRadius = '50%';
              dot.style.backgroundColor = color;
              dot.style.display = 'inline-block';
              titleEl.appendChild(dot);
              
              const textSpan = document.createElement('span');
              textSpan.textContent = title;
              titleEl.appendChild(textSpan);
              
              const countSpan = document.createElement('span');
              countSpan.style.fontSize = '12px';
              countSpan.style.backgroundColor = `${color}20`;
              countSpan.style.color = color;
              countSpan.style.padding = '2px 8px';
              countSpan.style.borderRadius = '999px';
              countSpan.style.marginLeft = 'auto';
              countSpan.textContent = items.length;
              titleEl.appendChild(countSpan);
              
              card.appendChild(titleEl);
              
              if (items.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.color = '#64748b';
                emptyMsg.style.fontStyle = 'italic';
                emptyMsg.style.fontSize = '14px';
                emptyMsg.textContent = 'No appointments in this category';
                card.appendChild(emptyMsg);
              } else {
                const list = document.createElement('ul');
                list.style.paddingLeft = '16px';
                list.style.marginBottom = '0';
                list.style.fontSize = '14px';
                list.style.maxHeight = '300px';
                list.style.overflowY = 'auto';
                
                items.forEach(item => {
                  const li = document.createElement('li');
                  li.textContent = item;
                  li.style.marginBottom = '4px';
                  list.appendChild(li);
                });
                
                card.appendChild(list);
              }
              
              return card;
            }

            // Load when step 4 or 5 becomes active
            const observer = new MutationObserver((mutations) => {
              for (const m of mutations) {
                if (m.type === 'attributes' && m.attributeName === 'class') {
                  const target = m.target;
                  if (target && target.dataset) {
                    const step = Number(target.dataset.wstep);
                    if (step === 4 && target.classList.contains('on')) {
                      // Render the Step 4 appointment setup UI (client-only).
                      setTimeout(() => { if (typeof renderStep4Setup === 'function') renderStep4Setup(); }, 150);
                    }
                    if (step === 5 && target.classList.contains('on')) {
                      setTimeout(() => { initAppointmentSetup(); }, 150);
                    }
                  }
                }
              }
            });
            document.querySelectorAll('.wstep').forEach(el => observer.observe(el, { attributes: true }));

      // EMIS upload handling removed per user request. Upload UI, CSV parsing and upload functions
      // were intentionally deleted to remove the EMIS data part. Remaining code handles AI
      // classification, debug panels, and user avatar functionality.
  </script>

    <!-- Bottom-left user avatar: exact copy of admin dashboard styling -->
    <style>
    /* CSS Variables (same as admin dashboard) */
    :root {
      --accent: #0ea5e9;
      --accent-2: #38bdf8;
      --panel-bg: #ffffff;
      --border-color: #e2e8f0;
      --ink: #0f172a;
      --muted: #64748b;
    }
    
    /* User avatar - exact copy from admin dashboard */
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      transition: transform 0.15s ease;
      flex-shrink: 0;
      cursor: pointer;
      position: fixed;
      right: 18px;
      top: 12px;
      z-index: 9999;
    }
    /* Presence indicator (admin dashboard style) */
    .user-avatar { position: fixed; }
    /* .user-avatar::after {
      content: '';
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 16px;
      height: 16px;
      background: #41d656; 
      border: 2px solid var(--panel-bg);
      border-radius: 50%;
    } */
    .user-avatar.inactive::after { background: var(--muted); }
    .user-avatar:hover { transform: scale(1.04); }
    
    /* User popover - same styling as email-popover */
    .user-popover {
      position: fixed;
      right: 18px;
      top: 62px;
      min-width: 260px;
      max-width: 360px;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(2,6,23,0.25);
      color: var(--ink);
      z-index: 10000;
      transform-origin: top right;
      animation: popIn .18s cubic-bezier(.2,.9,.2,1);
      display: none;
    }
    
    @keyframes popIn {
      from { transform: scale(.92) translateY(6px); opacity: 0; }
      to { transform: scale(1) translateY(0); opacity: 1; }
    }
    
    /* Appointment setup styles */
    .setup-grid { 
      margin-top: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
    }
    #appt-setup-grid {
      width: 100%;
      border-collapse: collapse;
    }
    #appt-setup-grid thead th {
      text-align: left;
      font-size: 12px;
      color: #64748b;
      padding: 10px 8px;
      background: #f8fafc;
      border-bottom: 1px solid #eef2f7;
    }
    #appt-setup-grid tbody td {
      padding: 10px 8px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
    }
    #appt-setup-grid .cat-name {
      font-weight: 600;
      color: #0f172a;
    }
    #appt-setup-grid select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      color: #0f172a;
      font-size: 13px;
    }
    .setup-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      justify-content: flex-start;
    }
    #appt-save {
      background: #3b82f6;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      border: none;
      cursor: pointer;
    }
    #appt-match-all, #appt-clear {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      border: 1px solid #e2e8f0;
      background: white;
      color: #334155;
      cursor: pointer;
    }
    .wizard-nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }
    #appt-back {
      background: white;
      color: #334155;
      padding: 8px 24px;
      border-radius: 6px;
      font-weight: 500;
      border: 1px solid #e2e8f0;
      cursor: pointer;
    }
    #appt-finish {
      background: #3b82f6;
      color: white;
      padding: 8px 24px;
      border-radius: 6px;
      font-weight: 500;
      border: none;
      cursor: pointer;
    }
    .row-confirmed {
      background: #f0fdf4;
    }
    
    .user-popover .user-email {
      font-weight: 600;
      color: var(--ink);
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .user-popover .user-role {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 12px;
    }
    
    .user-popover .btn-signout {
      width: 100%;
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: transparent;
      color: var(--ink);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .user-popover .btn-signout:hover {
      background: #f8fafc;
      border-color: var(--muted);
    }
    </style>

    <!-- User avatar in bottom-left (exact copy of admin dashboard structure) -->
    <div class="user-avatar" id="user-avatar" title="User menu" aria-haspopup="true" aria-expanded="false">
      <span id="user-initials">U</span>
    </div>
    
    <!-- User popover -->
    <div class="user-popover" id="user-popover" role="dialog" aria-hidden="true">
      <div class="user-email" id="user-email">—</div>
      <div class="user-role" id="user-role">—</div>
      <button class="btn-signout" id="btn-signout">Sign out</button>
    </div>
  </div>

  
  <!-- On-screen debug UI -->
  <style>
    #debug-toggle{position:fixed;left:12px;bottom:12px;width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#2563eb,#1d4ed8);color:#fff;display:grid;place-items:center;z-index:11000;cursor:pointer;box-shadow:0 8px 22px rgba(37,99,235,.18);font-weight:700}
  #debug-panel{position:fixed;left:12px;bottom:68px;width:460px;max-height:70vh;background:rgba(255,255,255,0.98);border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 12px 30px rgba(2,6,23,.2);padding:8px;z-index:11000;display:none;overflow:visible;font-family:monospace}
  #debug-panel .dbg-hd{display:flex;align-items:center;justify-content:space-between;padding:6px 4px 8px 4px;border-bottom:1px solid #eef2f7}
  #debug-panel .dbg-hd .dbg-actions button#debug-autoscroll{margin-left:6px;padding:6px 8px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;cursor:pointer}
    #debug-panel .dbg-hd .title{font-weight:700;color:#0f172a}
    #debug-panel .dbg-actions button{margin-left:6px;padding:6px 8px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;cursor:pointer}
  #debug-logs{overflow:auto;padding:6px;max-height:calc(70vh - 56px);font-size:12px;color:#0f172a}
    .debug-line{padding:6px;border-bottom:1px solid #f6f8fb;white-space:pre-wrap}
    .debug-log{color:#0f172a}
    .debug-info{color:#0b74c9}
    .debug-warn{color:#b45309}
    .debug-error{color:#dc2626}
  </style>

  <div id="debug-toggle" title="Toggle debug">🐞</div>
  <div id="debug-panel" aria-hidden="true">
    <div class="dbg-hd">
      <div class="title">Debug</div>
      <div class="dbg-actions">
        <button id="debug-clear" type="button">Clear</button>
        <button id="debug-copy" type="button">Copy</button>
        <button id="debug-autoscroll" type="button" title="Toggle auto-scroll">Auto</button>
        <button id="debug-close" type="button">Close</button>
        <button id="debug-ai-req" type="button">AI Req</button>
        <button id="debug-ai-res" type="button">AI Res</button>
        <button id="debug-ai-class" type="button">AI Class</button>
      </div>
    </div>
    <div id="debug-logs" role="log" aria-live="polite"></div>
  </div>

  <script>
    (function(){
      // Soft buffer sizes: allow many lines but trim in batches to avoid huge DOM slowdowns
      const MAX_LINES = 50000;
      const TRIM_BATCH = 500; // remove this many when exceeding MAX_LINES
      const toggle = document.getElementById('debug-toggle');
      const panel = document.getElementById('debug-panel');
      const logs = document.getElementById('debug-logs');
      const clearBtn = document.getElementById('debug-clear');
      const copyBtn = document.getElementById('debug-copy');
      const autoBtn = document.getElementById('debug-autoscroll');
      const closeBtn = document.getElementById('debug-close');
    const aiReqBtn = document.getElementById('debug-ai-req');
    const aiResBtn = document.getElementById('debug-ai-res');
    const aiClassBtn = document.getElementById('debug-ai-class');
    let autoScroll = true;

      function formatArg(a){
        try {
          if (typeof a === 'string') return a;
          return JSON.stringify(a);
        } catch(e){ return String(a); }
      }

      function append(level, args){
        try{
          if (!logs) return;
          const el = document.createElement('div');
          el.className = 'debug-line debug-' + level;
          const t = new Date();
          const ts = t.toISOString().replace('T',' ').split('.')[0];
          const text = args.map(formatArg).join(' ');
          el.textContent = `[${ts}] ${level.toUpperCase()}: ${text}`;
          logs.appendChild(el);
          // soft-trim in batches when we exceed MAX_LINES to avoid long loops
          if (logs.childNodes.length > MAX_LINES) {
            for (let i = 0; i < TRIM_BATCH && logs.childNodes.length > 0; i++) {
              logs.removeChild(logs.firstChild);
            }
          }
          // Auto-scroll unless the user has scrolled up
          if (autoScroll) logs.scrollTop = logs.scrollHeight;
        }catch(e){/* ignore */}
      }

      // Wrap console methods
      ['log','info','warn','error'].forEach((method)=>{
        const orig = console[method] && console[method].bind(console) || function(){};
        console[method] = function(...args){
          try{ append(method, args); }catch(e){}
          try{ orig(...args); }catch(e){}
        };
      });

      // Global error handlers
      window.addEventListener('error', (ev)=>{
        try{ console.error(ev.message + ' @ ' + (ev.filename||'') + ':' + (ev.lineno||'') ); }catch(e){}
      });
      window.addEventListener('unhandledrejection', (ev)=>{
        try{ console.error('UnhandledRejection', ev.reason); }catch(e){}
      });

      // Toggle behaviour
      toggle.addEventListener('click', ()=>{
        if (!panel) return;
        const showing = panel.style.display === 'block';
        panel.style.display = showing ? 'none' : 'block';
        panel.setAttribute('aria-hidden', showing ? 'true' : 'false');
      });
      closeBtn.addEventListener('click', ()=>{ panel.style.display = 'none'; panel.setAttribute('aria-hidden','true'); });
      clearBtn.addEventListener('click', ()=>{ if (logs) logs.innerHTML = ''; });
      // Robust copy handler with fallback for older browsers
      copyBtn.addEventListener('click', async ()=>{
        const origText = copyBtn.textContent;
        try{
          const text = Array.from(logs.children).map(ch=>ch.textContent).join('\n');
          // Try navigator.clipboard first
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            // Fallback to textarea + execCommand
            const ta = document.createElement('textarea');
            ta.value = text;
            // Avoid page jump
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            if (!ok) throw new Error('Fallback copy failed');
          }

          copyBtn.textContent = 'Copied!';
          setTimeout(()=>{ copyBtn.textContent = origText; }, 1500);
        }catch(e){ 
          console.error('Copy failed:', e);
          copyBtn.textContent = 'Copy failed';
          setTimeout(()=>{ copyBtn.textContent = origText; }, 2000);
          alert('Copy failed: ' + (e && e.message ? e.message : String(e)) ); 
        }
      });

      // Auto-scroll toggle
      function setAutoScroll(val){
        autoScroll = !!val;
        if (!autoBtn) return;
        autoBtn.textContent = autoScroll ? 'Auto' : 'Paused';
        autoBtn.style.background = autoScroll ? '#fff' : '#f8fafc';
      }
      if (autoBtn) {
        autoBtn.addEventListener('click', () => {
          setAutoScroll(!autoScroll);
          if (autoScroll) logs.scrollTop = logs.scrollHeight;
        });
        setAutoScroll(true);
      }

      // Pause auto-scroll when user scrolls up
      if (logs) {
        logs.addEventListener('scroll', () => {
          try {
            const atBottom = logs.scrollHeight - logs.scrollTop - logs.clientHeight <= 20;
            if (!atBottom && autoScroll) {
              setAutoScroll(false);
            } else if (atBottom && !autoScroll) {
              setAutoScroll(true);
            }
          } catch (e) { /* ignore */ }
        });
      }

      // make sure panel exists before any early logs
      console.log('Debug panel initialized');

      // Wire AI debug buttons (show prompt, raw response, and classification in-panel)
      try {
        if (aiReqBtn) aiReqBtn.addEventListener('click', () => {
          try {
            const txt = window.lastAIRequest || '— No AI request captured —';
            append('info', ['AI REQUEST:']);
            append('log', [txt]);
          } catch (e) { append('error', ['Failed to show AI request', e.message || e]); }
        });

        if (aiResBtn) aiResBtn.addEventListener('click', () => {
          try {
            const txt = window.lastAIRawResponse || '— No AI raw response captured —';
            append('info', ['AI RAW RESPONSE:']);
            append('log', [txt]);
          } catch (e) { append('error', ['Failed to show AI raw response', e.message || e]); }
        });

        if (aiClassBtn) aiClassBtn.addEventListener('click', () => {
          try {
            const cls = window.slotTypeClassification || window.classificationError || null;
            append('info', ['AI CLASSIFICATION (window.slotTypeClassification):']);
            append('log', [JSON.stringify(cls, null, 2) || '— none —']);
          } catch (e) { append('error', ['Failed to show classification', e.message || e]); }
        });
      } catch (e) { /* ignore wiring errors */ }
    })();
  </script>

  <script>
    // User avatar functionality — synced with admin dashboard
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const userAvatar = document.getElementById('user-avatar');
        const userPopover = document.getElementById('user-popover');
        const userInitials = document.getElementById('user-initials');
        const userEmailEl = document.getElementById('user-email'); // will show NAME here
        const userRoleEl = document.getElementById('user-role');
        const btnSignout = document.getElementById('btn-signout');

        const sb = window.supabase || (window.getSupabase && window.getSupabase());
        if (!sb) return;

        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
          sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
          window.location.replace('admin-login.html');
          return;
        }

        const user = session.user;

        // Load profile. Prefer profile passed from emis_checker via sessionStorage
        let profile = null;
        try {
          const passed = sessionStorage.getItem('emisPassedProfile');
          if (passed) {
            try {
              profile = JSON.parse(passed);
              // Clear after reading to avoid stale reuse
              sessionStorage.removeItem('emisPassedProfile');
              console.log('Using passed profile from sessionStorage');
            } catch (e) {
              console.warn('Failed to parse passed profile, falling back to DB', e);
              profile = null;
            }
          }

          if (!profile) {
            const { data } = await sb
              .from('master_users')
              .select('site_id, access_type, full_name, avatar_url')
              .eq('auth_user_id', user.id)
              .maybeSingle();
            profile = data || null;
          }
        } catch (e) { console.error('Profile fetch error:', e); }

        // Build display name exactly like admin dashboard
        let displayName = profile?.full_name ||
                          user?.user_metadata?.nickname ||
                          user?.user_metadata?.full_name ||
                          user?.user_metadata?.name ||
                          (user.email ? user.email.split('@')[0]
                            .replace(/[._-]/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase()) : 'User');

        // Set initials (first + last) like admin dashboard
        const baseName = displayName || user.email || 'User';
        const parts = baseName.trim().split(' ');
        const initials = parts.length >= 2
          ? (parts[0][0] + parts[parts.length - 1][0]).toUpperCase()
          : baseName.substring(0, 2).toUpperCase();
        if (userInitials) userInitials.textContent = initials;

        // Prefer stored avatar URL, fallback to user metadata
        try {
          let avatarUrl = profile?.avatar_url || user?.user_metadata?.avatar_url || null;
          if (!avatarUrl) {
            try {
              const { data: saw } = await sb
                .from('master_users')
                .select('avatar_url, updated_at')
                .eq('auth_user_id', user.id)
                .order('updated_at', { ascending: false })
                .limit(1)
                .maybeSingle();
              avatarUrl = saw?.avatar_url || avatarUrl;
            } catch (_) {}
          }
          if (avatarUrl) {
            let img = userAvatar.querySelector('img');
            if (!img) {
              img = document.createElement('img');
              img.alt = 'Avatar';
              img.style.width = '100%';
              img.style.height = '100%';
              img.style.borderRadius = '50%';
              img.style.objectFit = 'cover';
              userAvatar.appendChild(img);
            }
            img.src = avatarUrl;
            if (userInitials) userInitials.style.display = 'none';
          }
        } catch (e) { console.warn('Avatar render failed', e); }

        // Role text exactly like admin dashboard, but without email override
        let detectedRole = String(profile?.access_type || user?.user_metadata?.role || '').toLowerCase();
        let roleText = (detectedRole === 'admin' || detectedRole === 'owner')
                        ? 'Admin'
                        : (detectedRole ? detectedRole.charAt(0).toUpperCase() + detectedRole.slice(1) : 'Staff');

        // Site name (same fallback)
        let siteName = '';
        try {
          if (profile?.site_id) {
            const { data: site } = await sb
              .from('sites')
              .select('name')
              .eq('id', profile.site_id)
              .maybeSingle();
            siteName = site?.name || '';
          } else {
            siteName = 'Harley Street Medical Centre';
          }
        } catch (_) {}

        // Populate popover text — NAME on first line, then `Role  Site`
        if (userEmailEl) userEmailEl.textContent = displayName;
        if (userRoleEl) userRoleEl.textContent = siteName ? `${roleText}  ${siteName}` : roleText;

        // Toggle popover
        userAvatar.addEventListener('click', (e) => {
          e.stopPropagation();
          const isVisible = userPopover.style.display === 'block';
          document.querySelectorAll('.user-popover').forEach(p => { if (p !== userPopover) p.style.display = 'none'; });
          userPopover.style.display = isVisible ? 'none' : 'block';
          userAvatar.setAttribute('aria-expanded', !isVisible);
        });
        document.addEventListener('click', (e) => {
          if (!userAvatar.contains(e.target) && !userPopover.contains(e.target)) {
            userPopover.style.display = 'none';
            userAvatar.setAttribute('aria-expanded', false);
          }
        });

        // Sign out handler
        btnSignout.addEventListener('click', async () => {
          try { await sb.auth.signOut(); } catch(e) { console.error('Sign out failed', e); }
          window.location.replace('home.html');
        });

      } catch (err) {
        console.error('User avatar init error', err);
      }
    });

    // ===== RULES & ALERTS PAGE =====
    // Global variable to store loaded rules for use in dashboard
    window.thresholdRules = null;

    // Load partner staff list from emis_apps_filled
    async function loadPartnerStaffList() {
      try {
        document.getElementById('partner-staff-loading').style.display = 'block';
        document.getElementById('partner-staff-list').style.display = 'none';
        document.getElementById('partner-staff-empty').style.display = 'none';

        const { data: user } = await window.supabase.auth.getUser();
        if (!user || !user.user) throw new Error('Not authenticated');

        let siteId = 2;
        const { data: userProfile } = await window.supabase
          .from('master_users')
          .select('site_id')
          .eq('auth_user_id', user.user.id)
          .single();
        if (userProfile && userProfile.site_id) {
          siteId = userProfile.site_id;
        }

        // Query ALL distinct session holders from emis_apps_filled
        // Fetch in batches to get all records
        let allSessions = [];
        let hasMore = true;
        let page = 0;
        const pageSize = 1000;

        while (hasMore) {
          const { data: sessions, error } = await window.supabase
            .from('emis_apps_filled')
            .select('"Full Name of the Session Holder of the Session"')
            .eq('site_id', siteId)
            .not('Full Name of the Session Holder of the Session', 'is', null)
            .range(page * pageSize, (page + 1) * pageSize - 1);

          if (error) {
            console.error('Error loading staff list:', error);
            throw error;
          }

          if (!sessions || sessions.length === 0) {
            hasMore = false;
          } else {
            allSessions = allSessions.concat(sessions);
            page++;
            
            // Safety limit to prevent infinite loop
            if (page > 50) {
              console.log('Reached safety limit of 50 pages (50,000 records)');
              hasMore = false;
            }
            
            // If we got less than pageSize, we're done
            if (sessions.length < pageSize) {
              hasMore = false;
            }
          }
        }

        console.log(`Loaded ${allSessions.length} total session records`);

        // Get unique staff names and sort, filter out 'Unknown'
        const uniqueStaff = [...new Set(
          allSessions
            .map(s => s['Full Name of the Session Holder of the Session'])
            .filter(n => n && n.trim() && n.toLowerCase() !== 'unknown')
        )].sort();

        if (uniqueStaff.length === 0) {
          document.getElementById('partner-staff-loading').style.display = 'none';
          document.getElementById('partner-staff-empty').style.display = 'block';
          return;
        }

        // Get currently selected partners
        const currentPartners = window.thresholdRules?.partners || [];

        // Build checkbox list with search box
        const listContainer = document.getElementById('partner-staff-list');
        listContainer.innerHTML = `
          <div style="margin-bottom:20px;position:relative;">
            <div style="position:relative;">
              <i class="bi bi-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#94a3b8;font-size:16px;"></i>
              <input type="text" id="partner-search" class="form-control" placeholder="Search staff members..." 
                style="padding-left:40px;border-radius:10px;border:2px solid #e2e8f0;font-size:14px;transition:all 0.2s;">
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
              <p style="color:#64748b;font-size:13px;margin:0;">
                <i class="bi bi-person-badge" style="margin-right:6px;"></i>
                <strong>${uniqueStaff.length}</strong> staff members
              </p>
              <div style="display:flex;gap:8px;">
                <button type="button" id="select-all-partners" class="btn btn-sm btn-outline-primary" style="font-size:12px;padding:4px 12px;border-radius:6px;">
                  <i class="bi bi-check-square"></i> Select All
                </button>
                <button type="button" id="clear-all-partners" class="btn btn-sm btn-outline-secondary" style="font-size:12px;padding:4px 12px;border-radius:6px;">
                  <i class="bi bi-square"></i> Clear All
                </button>
              </div>
            </div>
          </div>
          <div id="partner-checkboxes" style="max-height:400px;overflow-y:auto;padding-right:8px;">
            ${uniqueStaff.map((staff, index) => {
              const isChecked = currentPartners.includes(staff);
              const iconClass = staff.includes('(Dr)') ? 'bi-heart-pulse-fill' : 
                               staff.includes('(Miss)') || staff.includes('(Ms)') || staff.includes('(Mrs)') ? 'bi-person-fill' : 
                               'bi-person-badge-fill';
              const iconColor = staff.includes('(Dr)') ? '#3b82f6' : '#10b981';
              
              return `
              <div class="form-check partner-item" style="padding:14px 16px;border-radius:10px;margin-bottom:10px;background:${isChecked ? '#f0f9ff' : '#ffffff'};border:2px solid ${isChecked ? '#3b82f6' : '#e5e7eb'};transition:all 0.2s;cursor:pointer;display:flex;align-items:center;gap:12px;" data-staff="${staff}">
                <input class="form-check-input partner-checkbox" type="checkbox" value="${staff}" 
                  id="partner-${staff.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}"
                  ${isChecked ? 'checked' : ''}
                  style="width:20px;height:20px;cursor:pointer;margin:0;flex-shrink:0;">
                <i class="bi ${iconClass}" style="font-size:20px;color:${iconColor};flex-shrink:0;"></i>
                <label class="form-check-label" for="partner-${staff.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}" 
                  style="font-weight:500;cursor:pointer;margin:0;flex:1;font-size:15px;color:#1e293b;">
                  ${staff}
                </label>
                ${isChecked ? '<i class="bi bi-check-circle-fill" style="color:#3b82f6;font-size:18px;flex-shrink:0;"></i>' : ''}
              </div>
            `}).join('')}
          </div>
        `;

        // Add search functionality with styling
        const searchInput = document.getElementById('partner-search');
        searchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          document.querySelectorAll('.partner-item').forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
          });
        });

        searchInput.addEventListener('focus', () => {
          searchInput.style.borderColor = '#3b82f6';
          searchInput.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
        });

        searchInput.addEventListener('blur', () => {
          searchInput.style.borderColor = '#e2e8f0';
          searchInput.style.boxShadow = 'none';
        });

        // Add checkbox click handlers with animation
        document.querySelectorAll('.partner-item').forEach(item => {
          const checkbox = item.querySelector('.partner-checkbox');
          
          item.addEventListener('click', (e) => {
            if (e.target !== checkbox) {
              checkbox.checked = !checkbox.checked;
              checkbox.dispatchEvent(new Event('change'));
            }
          });

          checkbox.addEventListener('change', (e) => {
            if (e.target.checked) {
              item.style.background = '#f0f9ff';
              item.style.borderColor = '#3b82f6';
              item.innerHTML = item.innerHTML.replace('</label>', '</label><i class="bi bi-check-circle-fill" style="color:#3b82f6;font-size:18px;flex-shrink:0;"></i>');
            } else {
              item.style.background = '#ffffff';
              item.style.borderColor = '#e5e7eb';
              const checkIcon = item.querySelector('.bi-check-circle-fill');
              if (checkIcon) checkIcon.remove();
            }
          });

          item.addEventListener('mouseenter', () => {
            if (!checkbox.checked) {
              item.style.background = '#f8fafc';
              item.style.borderColor = '#cbd5e1';
            }
          });

          item.addEventListener('mouseleave', () => {
            if (!checkbox.checked) {
              item.style.background = '#ffffff';
              item.style.borderColor = '#e5e7eb';
            }
          });
        });

        // Select All button
        document.getElementById('select-all-partners').addEventListener('click', () => {
          document.querySelectorAll('.partner-checkbox').forEach(cb => {
            if (!cb.checked) {
              cb.checked = true;
              cb.dispatchEvent(new Event('change'));
            }
          });
        });

        // Clear All button
        document.getElementById('clear-all-partners').addEventListener('click', () => {
          document.querySelectorAll('.partner-checkbox').forEach(cb => {
            if (cb.checked) {
              cb.checked = false;
              cb.dispatchEvent(new Event('change'));
            }
          });
        });

        // Function to update partner count badge
        function updatePartnerCountBadge() {
          const checkedCount = document.querySelectorAll('.partner-checkbox:checked').length;
          const badge = document.getElementById('partner-count-badge');
          if (badge) {
            badge.textContent = `${checkedCount} selected`;
            badge.style.background = checkedCount > 0 ? '#3b82f6' : '#94a3b8';
          }
        }

        // Update badge on any checkbox change
        document.querySelectorAll('.partner-checkbox').forEach(cb => {
          cb.addEventListener('change', updatePartnerCountBadge);
        });

        // Initial badge update
        updatePartnerCountBadge();

        document.getElementById('partner-staff-loading').style.display = 'none';
        document.getElementById('partner-staff-list').style.display = 'block';

      } catch (error) {
        console.error('Error loading staff list:', error);
        console.error('Error details:', error.message, error.stack);
        document.getElementById('partner-staff-loading').style.display = 'none';
        document.getElementById('partner-staff-list').style.display = 'none';
        document.getElementById('partner-staff-empty').style.display = 'block';
        document.getElementById('partner-staff-empty').innerHTML = `
          <div style="text-align:center;padding:40px;color:#ef4444;">
            <i class="bi bi-exclamation-triangle-fill" style="font-size:3rem;opacity:0.5;"></i>
            <p style="margin-top:16px;font-size:15px;font-weight:600;">Failed to load staff list</p>
            <p style="font-size:13px;color:#64748b;margin-top:8px;">${error.message}</p>
            <button onclick="loadPartnerStaffList()" class="btn btn-sm btn-primary" style="margin-top:12px;">
              <i class="bi bi-arrow-clockwise"></i> Retry
            </button>
          </div>
        `;
      }
    }

    // Load rules from database
    async function loadRules() {
      try {
        const { data: user } = await window.supabase.auth.getUser();
        if (!user || !user.user) throw new Error('Not authenticated');

        let siteId = 2; // Default to site 2
        
        // Try to get user's site_id from master_users
        const { data: userProfile, error: profileError } = await window.supabase
          .from('master_users')
          .select('site_id')
          .eq('auth_user_id', user.user.id)
          .single();

        if (userProfile && userProfile.site_id) {
          siteId = userProfile.site_id;
          console.log('Using user site_id:', siteId);
        } else {
          console.warn('Site ID not found in master_users, defaulting to site 2', profileError);
        }

        // Load threshold rules and partner config
        const { data: rules, error } = await window.supabase
          .from('emis_rules')
          .select('*')
          .eq('site_id', siteId)
          .eq('is_active', true)
          .in('rule_type', ['otd_threshold', 'not_bkd_threshold', 'partner_staff']);

        if (error) throw error;

        console.log('Loaded rules:', rules);

        // Convert to usable format
        const rulesObj = {
          otd: {},
          notBkd: {},
          gradient: {
            red: 80,
            green: 100
          },
          partners: []
        };

        (rules || []).forEach(rule => {
          const config = rule.rule_config;
          if (rule.rule_type === 'otd_threshold') {
            rulesObj.otd = {
              monday: config.monday || 25,
              tuesday: config.tuesday || 20,
              wednesday: config.wednesday || 20,
              thursday: config.thursday || 20,
              friday: config.friday || 20
            };
            if (config.gradient) {
              rulesObj.gradient.red = (config.gradient.red_below || 0.8) * 100;
              rulesObj.gradient.green = (config.gradient.green_above || 1.0) * 100;
            }
          } else if (rule.rule_type === 'not_bkd_threshold') {
            rulesObj.notBkd = {
              monday: config.monday || 25,
              tuesday: config.tuesday || 20,
              wednesday: config.wednesday || 20,
              thursday: config.thursday || 20,
              friday: config.friday || 20
            };
          } else if (rule.rule_type === 'partner_staff') {
            rulesObj.partners = config.partners || [];
          }
        });

        // Store globally for dashboard to use
        window.thresholdRules = rulesObj;

        return rulesObj;
      } catch (error) {
        console.error('Error loading rules:', error);
        // Return defaults
        return {
          otd: { monday: 25, tuesday: 20, wednesday: 20, thursday: 20, friday: 20 },
          notBkd: { monday: 25, tuesday: 20, wednesday: 20, thursday: 20, friday: 20 },
          gradient: { red: 80, green: 100 },
          partners: []
        };
      }
    }

    // Populate rules form
    function populateRulesForm(rules) {
      // OTD thresholds
      document.getElementById('otd-monday').value = rules.otd.monday;
      document.getElementById('otd-tuesday').value = rules.otd.tuesday;
      document.getElementById('otd-wednesday').value = rules.otd.wednesday;
      document.getElementById('otd-thursday').value = rules.otd.thursday;
      document.getElementById('otd-friday').value = rules.otd.friday;

      // Not BKD thresholds
      document.getElementById('notbkd-monday').value = rules.notBkd.monday;
      document.getElementById('notbkd-tuesday').value = rules.notBkd.tuesday;
      document.getElementById('notbkd-wednesday').value = rules.notBkd.wednesday;
      document.getElementById('notbkd-thursday').value = rules.notBkd.thursday;
      document.getElementById('notbkd-friday').value = rules.notBkd.friday;

      // Gradient settings
      document.getElementById('gradient-red').value = rules.gradient.red;
      document.getElementById('gradient-green').value = rules.gradient.green;
    }

    // Save rules to database
    async function saveRules() {
      const saveBtn = document.getElementById('rules-save');
      try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Saving...';

        const { data: user } = await window.supabase.auth.getUser();
        if (!user || !user.user) throw new Error('Not authenticated');

        let siteId = 2; // Default to site 2
        let userEmail = user.user.email || 'unknown@checkloops.com';
        
        // Try to get user's site_id and email from master_users
        const { data: userProfile, error: profileError } = await window.supabase
          .from('master_users')
          .select('site_id, user_email')
          .eq('auth_user_id', user.user.id)
          .single();

        if (userProfile) {
          if (userProfile.site_id) {
            siteId = userProfile.site_id;
          }
          if (userProfile.user_email) {
            userEmail = userProfile.user_email;
          }
          console.log('Saving rules for site_id:', siteId, 'user:', userEmail);
        } else {
          console.warn('Profile not found in master_users, using defaults', profileError);
        }

        // Collect form values
        const otdConfig = {
          monday: parseInt(document.getElementById('otd-monday').value),
          tuesday: parseInt(document.getElementById('otd-tuesday').value),
          wednesday: parseInt(document.getElementById('otd-wednesday').value),
          thursday: parseInt(document.getElementById('otd-thursday').value),
          friday: parseInt(document.getElementById('otd-friday').value),
          gradient: {
            red_below: parseFloat(document.getElementById('gradient-red').value) / 100,
            yellow_between: [
              parseFloat(document.getElementById('gradient-red').value) / 100,
              parseFloat(document.getElementById('gradient-green').value) / 100
            ],
            green_above: parseFloat(document.getElementById('gradient-green').value) / 100
          }
        };

        const notBkdConfig = {
          monday: parseInt(document.getElementById('notbkd-monday').value),
          tuesday: parseInt(document.getElementById('notbkd-tuesday').value),
          wednesday: parseInt(document.getElementById('notbkd-wednesday').value),
          thursday: parseInt(document.getElementById('notbkd-thursday').value),
          friday: parseInt(document.getElementById('notbkd-friday').value),
          gradient: otdConfig.gradient // Same gradient for both
        };

        // Upsert OTD threshold
        const { error: otdError } = await window.supabase
          .from('emis_rules')
          .upsert({
            site_id: siteId,
            rule_type: 'otd_threshold',
            rule_config: otdConfig,
            is_active: true,
            created_by_user_id: user.user.id,
            created_by_email: userEmail,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'site_id,rule_type',
            ignoreDuplicates: false
          });

        if (otdError) {
          console.error('Error upserting OTD threshold:', otdError);
          throw otdError;
        }

        // Upsert Not BKD threshold
        const { error: notBkdError } = await window.supabase
          .from('emis_rules')
          .upsert({
            site_id: siteId,
            rule_type: 'not_bkd_threshold',
            rule_config: notBkdConfig,
            is_active: true,
            created_by_user_id: user.user.id,
            created_by_email: userEmail,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'site_id,rule_type',
            ignoreDuplicates: false
          });

        if (notBkdError) {
          console.error('Error upserting Not BKD threshold:', notBkdError);
          throw notBkdError;
        }

        // Collect selected partners
        const checkboxes = document.querySelectorAll('.partner-checkbox:checked');
        const selectedPartners = Array.from(checkboxes).map(cb => cb.value);

        const partnerConfig = {
          partners: selectedPartners
        };

        // Upsert Partner Staff configuration
        const { error: partnerError } = await window.supabase
          .from('emis_rules')
          .upsert({
            site_id: siteId,
            rule_type: 'partner_staff',
            rule_config: partnerConfig,
            is_active: true,
            created_by_user_id: user.user.id,
            created_by_email: userEmail,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'site_id,rule_type',
            ignoreDuplicates: false
          });

        if (partnerError) {
          console.error('Error upserting partner config:', partnerError);
          throw partnerError;
        }

        console.log('Rules saved successfully for site_id:', siteId, 'Partners:', selectedPartners);

        // Reload rules into global variable
        await loadRules();

        // Show success message with animation
        const successDiv = document.getElementById('rules-success');
        successDiv.style.display = 'block';
        successDiv.style.animation = 'fxPop 0.4s cubic-bezier(.2,.9,.2,1)';
        
        setTimeout(() => {
          successDiv.style.opacity = '0';
          successDiv.style.transition = 'opacity 0.3s ease';
          setTimeout(() => {
            successDiv.style.display = 'none';
            successDiv.style.opacity = '1';
          }, 300);
        }, 5000);

        // Update save button with success state
        saveBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        saveBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Saved Successfully!';
        
        setTimeout(() => {
          saveBtn.disabled = false;
          saveBtn.style.background = '';
          saveBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Save All Settings';
        }, 2000);

      } catch (error) {
        console.error('Error saving rules:', error);
        saveBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        saveBtn.innerHTML = '<i class="bi bi-x-circle-fill"></i> Save Failed';
        setTimeout(() => {
          saveBtn.disabled = false;
          saveBtn.style.background = '';
          saveBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Save All Settings';
        }, 3000);
        alert(`Error saving settings: ${error.message}`);
      }
    }

    // Initialize rules page when navigating to it
    document.addEventListener('DOMContentLoaded', async () => {
      // Set up navigation listener
      const originalShowPage = window.showPage;
      window.showPage = async function(pageName) {
        originalShowPage(pageName);
        
        // Load rules when navigating to rules page
        if (pageName === 'rules-alerts') {
          document.getElementById('rules-loading').style.display = 'block';
          document.getElementById('rules-content').style.display = 'none';
          
          const rules = await loadRules();
          populateRulesForm(rules);
          
          document.getElementById('rules-loading').style.display = 'none';
          document.getElementById('rules-content').style.display = 'block';
        }
      };

      // Set up save button
      document.getElementById('rules-save')?.addEventListener('click', saveRules);

      // Set up cancel button
      document.getElementById('rules-cancel')?.addEventListener('click', async () => {
        const rules = await loadRules();
        populateRulesForm(rules);
        document.getElementById('rules-success').style.display = 'none';
      });

      // Load partner staff list when accordion section is opened
      const partnerSection = document.getElementById('partnerSection');
      if (partnerSection) {
        console.log('Setting up partner section accordion listener');
        partnerSection.addEventListener('shown.bs.collapse', async function() {
          console.log('Partner section opened, loading staff list...');
          try {
            await loadPartnerStaffList();
          } catch (error) {
            console.error('Failed to load partner staff list:', error);
          }
        });
      } else {
        console.error('Partner section element not found!');
      }

      // Load rules on initial page load (for dashboard)
      await loadRules();
    });

    // ============================================================================
    // AI RULES PAGE LOGIC
    // ============================================================================
    
    const AIRules = {
      currentSite: null,
      contextData: { clinicians: [], slotTypes: [] },
      generatedRule: null,

      async init() {
        // Setup event listeners
        document.getElementById('ai-generate-btn')?.addEventListener('click', () => this.generateRule());
        document.getElementById('ai-clear-btn')?.addEventListener('click', () => this.clearInput());
        document.getElementById('ai-save-btn')?.addEventListener('click', () => this.saveRule());
        document.getElementById('ai-test-btn')?.addEventListener('click', () => this.testRule());
        
        // Quick example buttons
        document.querySelectorAll('.quick-example-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.getElementById('ai-rule-input').value = btn.dataset.example;
          });
        });

        // Wrap showPage to load AI rules when navigating to AI Rules page
        const originalShowPage = window.showPage;
        window.showPage = async function(pageName) {
          originalShowPage(pageName);
          
          if (pageName === 'ai-rules') {
            await AIRules.loadPage();
          }
        };
      },

      async loadPage() {
        console.log('Loading AI Rules page...');
        
        // Get user's site_id from their profile
        try {
          const { data: user } = await window.supabase.auth.getUser();
          if (user && user.user) {
            const { data: userProfile } = await window.supabase
              .from('master_users')
              .select('site_id')
              .eq('auth_user_id', user.user.id)
              .single();
            
            if (userProfile && userProfile.site_id) {
              this.currentSite = userProfile.site_id;
            }
          }
        } catch (error) {
          console.warn('Could not load user site_id:', error);
        }
        
        // Fallback to site 2 if no site found
        if (!this.currentSite) {
          console.log('No site found for user, defaulting to site 2');
          this.currentSite = 2;
        }
        
        console.log('Using site_id:', this.currentSite);

        // Load context data and existing rules
        await Promise.all([
          this.loadContextData(),
          this.loadExistingRules()
        ]);
      },

      async loadContextData() {
        try {
          console.log('Loading context data for site:', this.currentSite);
          
          // Query distinct clinicians
          const { data: cliniciansData, error: cliniciansError } = await window.supabase
            .from('emis_apps_raw')
            .select('full_name_session_holder')
            .eq('site_id', this.currentSite)
            .not('full_name_session_holder', 'is', null);

          if (cliniciansError) throw cliniciansError;

          // Query distinct slot types
          const { data: slotTypesData, error: slotTypesError } = await window.supabase
            .from('emis_apps_raw')
            .select('slot_type')
            .eq('site_id', this.currentSite)
            .not('slot_type', 'is', null);

          if (slotTypesError) throw slotTypesError;

          this.contextData = {
            clinicians: [...new Set(cliniciansData.map(r => r.full_name_session_holder))].filter(n => n && n.trim()).sort(),
            slotTypes: [...new Set(slotTypesData.map(r => r.slot_type))].filter(t => t && t.trim()).sort()
          };

          console.log('Context loaded:', this.contextData.clinicians.length, 'clinicians,', this.contextData.slotTypes.length, 'slot types');
        } catch (error) {
          console.error('Failed to load context data:', error);
        }
      },

      async loadExistingRules() {
        try {
          const { data, error } = await window.supabase
            .from('emis_validation_rules')
            .select('*')
            .eq('site_id', this.currentSite)
            .order('created_at', { ascending: false });

          if (error) throw error;

          this.allRules = data || []; // Store rules for later access
          this.displayRules(this.allRules);
        } catch (error) {
          console.error('Failed to load rules:', error);
          document.getElementById('ai-rules-loading').style.display = 'none';
          document.getElementById('ai-rules-list').innerHTML = '<p style="color:#ef4444;text-align:center;">Failed to load rules</p>';
        }
      },

      displayRules(rules) {
        const loading = document.getElementById('ai-rules-loading');
        const list = document.getElementById('ai-rules-list');
        
        loading.style.display = 'none';
        list.style.display = 'block';

        if (rules.length === 0) {
          list.innerHTML = '<p style="color:#64748b;text-align:center;padding:20px;">No rules created yet</p>';
          return;
        }

        list.innerHTML = rules.map(rule => `
          <div class="rule-card">
            <div class="rule-card-header">
              <div style="flex:1;">
                <div class="rule-card-title">${this.escapeHtml(rule.name)}</div>
                <div style="font-size:11px;color:#64748b;margin-top:4px;">${rule.rule_type}</div>
              </div>
              <div class="rule-toggle ${rule.enabled ? 'active' : ''}" onclick="AIRules.toggleRule(${rule.id}, ${!rule.enabled})"></div>
            </div>
            <div style="font-size:12px;color:#475569;margin-top:8px;">${this.escapeHtml(rule.description || '')}</div>
            
            <div style="display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
              <button class="btn btn-sm btn-outline-primary" onclick="AIRules.runRule(${rule.id})" style="flex:1;">
                <i class="bi bi-play-circle"></i> Run
              </button>
              <button class="btn btn-sm btn-outline-secondary" onclick="AIRules.renameRule(${rule.id})">
                <i class="bi bi-pencil"></i> Rename
              </button>
              <button class="btn btn-sm btn-outline-info" onclick="AIRules.amendRule(${rule.id})">
                <i class="bi bi-gear"></i> Edit
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="AIRules.deleteRule(${rule.id})">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        `).join('');
      },

      async generateRule() {
        const input = document.getElementById('ai-rule-input').value.trim();
        if (!input) {
          alert('Please enter a rule description');
          return;
        }

        const selectedSeverity = document.getElementById('ai-rule-severity').value;

        console.log('🤖 === GENERATING RULE ===');
        console.log('User input:', input);
        console.log('Severity:', selectedSeverity);
        console.log('Site ID:', this.currentSite);
        console.log('Context - Clinicians:', this.contextData.clinicians.length, 'available');
        console.log('Context - Slot Types:', this.contextData.slotTypes.length, 'available');

        const btn = document.getElementById('ai-generate-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Generating...';

        try {
          console.log('📡 Calling AI edge function...');
          
          const requestBody = {
            rule_text: input,
            site_id: this.currentSite,
            context: {
              available_clinicians: this.contextData.clinicians,
              available_slot_types: this.contextData.slotTypes
            }
          };
          
          console.log('Request body:', JSON.stringify(requestBody, null, 2));
          
          const { data, error } = await window.supabase.functions.invoke('ai-rule-generator', {
            body: requestBody
          });

          console.log('📥 AI response received:', data);

          if (error) {
            console.error('❌ Edge function error:', error);
            throw error;
          }
          
          if (!data.success) {
            console.error('❌ AI generation failed:', data.error);
            throw new Error(data.error || 'Failed to generate rule');
          }

          console.log('✅ AI generated rule:', JSON.stringify(data.rule, null, 2));
          console.log('Human readable:', data.human_readable);
          
          if (data.debug) {
            console.log('🐛 Debug info from AI:', data.debug);
          }

          // Override severity with user's selection
          data.rule.severity = selectedSeverity;
          
          console.log('Final rule (with user severity):', JSON.stringify(data.rule, null, 2));
          
          this.generatedRule = data.rule;
          this.displayGeneratedRule(data.rule, data.human_readable);
          
        } catch (error) {
          console.error('❌ Failed to generate rule:', error);
          console.error('Error details:', JSON.stringify(error, null, 2));
          alert('Failed to generate rule: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-magic"></i> Generate Rule';
        }
      },

      displayGeneratedRule(rule, humanReadable) {
        const preview = document.getElementById('ai-rule-preview');
        const details = document.getElementById('ai-rule-details');
        
        preview.style.display = 'block';
        
        details.innerHTML = `
          <div style="margin-bottom:12px;">
            <div style="font-weight:600;color:#166534;margin-bottom:4px;">${this.escapeHtml(rule.name)}</div>
            <div style="font-size:13px;color:#15803d;">${this.escapeHtml(humanReadable || rule.description)}</div>
          </div>
          <div style="display:grid;grid-template-columns:auto 1fr;gap:8px 12px;font-size:12px;">
            <span style="color:#64748b;font-weight:500;">Type:</span>
            <span>${rule.rule_type}</span>
            <span style="color:#64748b;font-weight:500;">Severity:</span>
            <span style="text-transform:capitalize;">${rule.severity}</span>
          </div>
        `;

        preview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      },

      async saveRule() {
        if (!this.generatedRule) return;

        console.log('💾 === SAVING RULE ===');
        console.log('Rule to save:', JSON.stringify(this.generatedRule, null, 2));

        const btn = document.getElementById('ai-save-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Saving...';

        try {
          console.log('📤 Sending to database...');
          
          const { data, error } = await window.supabase
            .from('emis_validation_rules')
            .insert([this.generatedRule])
            .select();

          if (error) {
            console.error('❌ Database error:', error);
            console.error('Error details:', JSON.stringify(error, null, 2));
            throw error;
          }

          console.log('✅ Rule saved successfully:', data);

          // Success!
          document.getElementById('ai-rule-preview').style.display = 'none';
          document.getElementById('ai-rule-input').value = '';
          this.generatedRule = null;

          // Reload rules list
          await this.loadExistingRules();

          // Show success message
          alert('✅ Rule saved successfully!');
          
        } catch (error) {
          console.error('❌ Failed to save rule:', error);
          console.error('Error message:', error.message);
          console.error('Error details:', JSON.stringify(error, null, 2));
          
          // Show detailed error to user
          alert(`Failed to save rule:\n\n${error.message}\n\nCheck browser console for full details.`);
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-save"></i> Save Rule';
        }
      },

      async testRule() {
        if (!this.generatedRule) return;

        const btn = document.getElementById('ai-test-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Testing...';

        try {
          // Query appointments that might violate this rule
          const results = await this.runRuleTest(this.generatedRule);
          this.displayTestResults(results);
          
        } catch (error) {
          console.error('Failed to test rule:', error);
          alert('Failed to test rule: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-play-circle"></i> Test';
        }
      },

      async runRuleTest(rule) {
        console.log('🧪 === RUNNING RULE TEST ===');
        console.log('Rule:', JSON.stringify(rule, null, 2));
        
        // Simple test: query recent appointments from emis_apps_filled
        const daysToCheck = 30;  // ← INCREASED FROM 7 TO 30 DAYS
        const startDate = new Date(Date.now() - daysToCheck * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        console.log(`📅 Querying appointments from ${startDate} onwards (${daysToCheck} days)`);
        
        const { data, error } = await window.supabase
          .from('emis_apps_filled')
          .select('*')
          .eq('site_id', this.currentSite)
          .gte('"Appointment Date"', startDate)
          .limit(1000);

        if (error) throw error;

        console.log(`📊 Retrieved ${data.length} appointments to test`);
        
        // Log sample data structure
        if (data.length > 0) {
          const sample = data[0];
          console.log('Sample appointment structure:', {
            date: sample['Appointment Date'],
            time: sample['Appointment Time'],
            duration: sample['Slot Duration'],
            slotType: sample['Slot Type'],
            clinician: sample['Full Name of the Session Holder of the Session']
          });
          
          // Get unique clinicians to help debug matching
          const uniqueClinicians = [...new Set(data.map(row => row['Full Name of the Session Holder of the Session']))];
          console.log(`📋 Unique clinicians in dataset (${uniqueClinicians.length}):`, uniqueClinicians.slice(0, 10));
          
          // Check if we have any Saeed appointments
          const saeedAppointments = data.filter(row => {
            const clinician = row['Full Name of the Session Holder of the Session'] || '';
            return clinician.toLowerCase().includes('saeed');
          });
          console.log(`🔍 Found ${saeedAppointments.length} appointments with "saeed" in clinician name`);
          
          if (saeedAppointments.length > 0) {
            console.log('Sample Saeed appointments:', saeedAppointments.slice(0, 3).map(a => ({
              date: a['Appointment Date'],
              time: a['Appointment Time'],
              duration: a['Slot Duration'],
              clinician: a['Full Name of the Session Holder of the Session']
            })));
          }
        }

        // Apply rule logic based on rule type
        const violations = [];
        
        if (rule.rule_type === 'slot_duration') {
          console.log('🔍 Testing slot_duration rule...');
          
          const config = rule.config;
          console.log('Rule config:', JSON.stringify(config, null, 2));
          
          // Extract config values
          const slotTypes = config.slot_types || [];
          const operator = config.operator || 'gte';
          const value = config.value || config.min_duration || 0;
          const appliesToAllClinicians = config.applies_to_all_clinicians !== false;
          const clinicianNames = config.clinician_names || [];
          
          console.log(`📋 Rule parameters:
  - Slot types filter: ${slotTypes.length > 0 ? slotTypes.join(', ') : 'ALL SLOT TYPES'}
  - Operator: ${operator}
  - Value: ${value} minutes
  - Applies to all clinicians: ${appliesToAllClinicians}
  - Specific clinicians: ${clinicianNames.length > 0 ? clinicianNames.join(', ') : 'N/A'}`);
          
          let testedCount = 0;
          let matchedClinicianCount = 0;
          let matchedSlotTypeCount = 0;
          let debugMatchAttempts = 0;
          
          data.forEach(row => {
            const duration = parseInt(row['Slot Duration']) || 0;
            const rowSlotType = row['Slot Type'] || '';
            const rowClinician = row['Full Name of the Session Holder of the Session'] || '';
            
            // Debug: Log first few matching attempts
            if (debugMatchAttempts < 5 && clinicianNames.length > 0) {
              console.log(`Attempt ${debugMatchAttempts + 1}: Comparing "${rowClinician}" with [${clinicianNames.join(', ')}]`);
              debugMatchAttempts++;
            }
            
            // Check if this appointment matches our filters
            
            // 1. Clinician filter
            let clinicianMatch = appliesToAllClinicians;
            if (!appliesToAllClinicians && clinicianNames.length > 0) {
              clinicianMatch = clinicianNames.some(name => 
                rowClinician.toLowerCase().includes(name.toLowerCase()) ||
                name.toLowerCase().includes(rowClinician.toLowerCase())
              );
              
              // Debug: Log first match
              if (clinicianMatch && matchedClinicianCount === 0) {
                console.log(`✅ First clinician match! Row clinician: "${rowClinician}", Matched against: "${clinicianNames.join(', ')}"`);
              }
            }
            
            if (clinicianMatch) matchedClinicianCount++;
            
            // 2. Slot type filter (empty array = all slot types)
            let slotTypeMatch = slotTypes.length === 0;
            if (!slotTypeMatch) {
              slotTypeMatch = slotTypes.some(type => 
                rowSlotType.toLowerCase().includes(type.toLowerCase()) ||
                type.toLowerCase().includes(rowSlotType.toLowerCase())
              );
            }
            
            if (slotTypeMatch) matchedSlotTypeCount++;
            
            // Only test if both filters pass
            if (!clinicianMatch || !slotTypeMatch) {
              return; // Skip this row
            }
            
            testedCount++;
            
            // Apply operator
            let violates = false;
            switch (operator) {
              case 'gte': violates = duration < value; break;
              case 'gt':  violates = duration <= value; break;
              case 'lte': violates = duration > value; break;
              case 'lt':  violates = duration >= value; break;
              case 'eq':  violates = duration !== value; break;
              default:    violates = duration < value;
            }
            
            if (violates) {
              violations.push({
                date: row['Appointment Date'],
                time: row['Appointment Time'],
                clinician: rowClinician,
                slot_type: rowSlotType,
                duration: duration,
                reason: `Duration ${duration}min violates rule (${operator} ${value}min)`
              });
            }
          });
          
          console.log(`✅ Test complete:
  - Total appointments: ${data.length}
  - Matched clinician filter: ${matchedClinicianCount}
  - Matched slot type filter: ${matchedSlotTypeCount}
  - Actually tested: ${testedCount}
  - Violations found: ${violations.length}`);
          
          if (violations.length > 0) {
            console.log('❌ Sample violations:', violations.slice(0, 3));
          }
        }
        
        else if (rule.rule_type === 'slot_count') {
          const { slot_type, min_count } = rule.config;

          // Normalize helper
          const normalizeDate = v => {
            if (!v) return null;
            const d = new Date(v);
            if (isNaN(d)) return null;
            return d.toISOString().split('T')[0];
          };

          const lastDates = [];
          for (let i = 0; i < daysToCheck; i++) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            lastDates.push(d.toISOString().split('T')[0]);
          }

          // Count slots per day for this slot type
          lastDates.forEach(dateStr => {
            const matchingSlots = data.filter(row => {
              const rowDate = normalizeDate(row['Appointment Date']);
              return rowDate === dateStr && row['Slot Type'] === slot_type;
            });

            const slotCount = matchingSlots.length;
            
            if (slotCount < min_count) {
              violations.push({
                date: dateStr,
                time: 'All Day',
                clinician: 'All clinicians',
                slot_type: slot_type,
                duration: slotCount,
                reason: `Found ${slotCount} slots, requirement is at least ${min_count}`
              });
            }
          });
        }
        
        else if (rule.rule_type === 'daily_check') {
          const { slot_type, min_count, days } = rule.config;

          // Normalize helper
          const normalizeDate = v => {
            if (!v) return null;
            const d = new Date(v);
            if (isNaN(d)) return null;
            return d.toISOString().split('T')[0];
          };

          const lastDates = [];
          const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
          for (let i = 0; i < daysToCheck; i++) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            lastDates.push({
              dateStr: d.toISOString().split('T')[0],
              dayName: dayNames[d.getDay()]
            });
          }

          // For each date, check if it's in the allowed days and count slots
          lastDates.forEach(({ dateStr, dayName }) => {
            if (!days.includes(dayName)) return; // Skip days not in the rule

            const matchingSlots = data.filter(row => {
              const rowDate = normalizeDate(row['Appointment Date']);
              return rowDate === dateStr && row['Slot Type'] === slot_type;
            });

            const slotCount = matchingSlots.length;
            
            if (slotCount < min_count) {
              violations.push({
                date: dateStr,
                time: 'All Day',
                clinician: 'All clinicians',
                slot_type: slot_type,
                duration: slotCount,
                reason: `Found ${slotCount} ${slot_type} slots on ${dayName}, requirement is at least ${min_count}`
              });
            }
          });
        }
        
        else if (rule.rule_type === 'custom') {
          // For custom rules, just show a message that testing is not automated
          violations.push({
            date: 'N/A',
            time: 'N/A',
            clinician: 'N/A',
            slot_type: 'Custom Rule',
            duration: 0,
            reason: 'Custom rules require manual validation - automated testing not available'
          });
        }
        
        else {
          console.log(`⚠️ Unknown rule type: ${rule.rule_type} - cannot test automatically`);
          violations.push({
            date: 'N/A',
            time: 'N/A',
            clinician: 'N/A',
            slot_type: 'Unknown Rule Type',
            duration: 0,
            reason: `Rule type "${rule.rule_type}" testing not yet implemented`
          });
        }

        console.log('🏁 === TEST COMPLETE ===');
        
        return { 
          total: data.length, 
          violations,
          debug: {
            rule_type: rule.rule_type,
            rule_config: rule.config,
            date_range: `${startDate} to today`,
            total_appointments_queried: data.length,
            violations_found: violations.length
          }
        };
      },

      displayTestResults(results) {
        console.log('📊 Displaying test results:', results);
        
        const testResults = document.getElementById('ai-test-results');
        const content = document.getElementById('ai-test-content');
        
        testResults.style.display = 'block';
        
        if (results.violations.length === 0) {
          content.innerHTML = `
            <div style="text-align:center;padding:20px;">
              <i class="bi bi-check-circle-fill" style="font-size:48px;color:#22c55e;"></i>
              <p style="margin-top:12px;font-weight:600;color:#166534;">No violations found!</p>
              <p style="font-size:13px;color:#64748b;">Tested ${results.total} appointments from the last 7 days (limit 1000)</p>
              ${results.debug ? `
                <details style="margin-top:12px;text-align:left;font-size:11px;color:#64748b;">
                  <summary style="cursor:pointer;font-weight:600;">📊 Debug Info (click to expand)</summary>
                  <pre style="background:#f8fafc;padding:8px;border-radius:4px;margin-top:8px;overflow-x:auto;">${this.escapeHtml(JSON.stringify(results.debug, null, 2))}</pre>
                </details>
              ` : ''}
            </div>
          `;
        } else {
          content.innerHTML = `
            <p style="font-weight:600;color:#92400e;margin-bottom:12px;">
              Found ${results.violations.length} violations in ${results.total} appointments tested
            </p>
            ${results.debug ? `
              <details style="margin-bottom:12px;font-size:11px;color:#64748b;">
                <summary style="cursor:pointer;font-weight:600;">📊 Debug Info (click to expand)</summary>
                <pre style="background:#f8fafc;padding:8px;border-radius:4px;margin-top:8px;overflow-x:auto;font-size:10px;">${this.escapeHtml(JSON.stringify(results.debug, null, 2))}</pre>
              </details>
            ` : ''}
            <div style="max-height:300px;overflow-y:auto;background:white;border-radius:8px;padding:12px;">
              ${results.violations.slice(0, 20).map(v => `
                <div style="border-bottom:1px solid #f3f4f6;padding:8px 0;">
                  <div style="font-size:12px;font-weight:600;color:#1e293b;">${v.date} ${v.time} - ${this.escapeHtml(v.clinician)}</div>
                  <div style="font-size:11px;color:#64748b;margin-top:2px;">${this.escapeHtml(v.slot_type)} - ${v.reason}</div>
                </div>
              `).join('')}
              ${results.violations.length > 20 ? `<p style="text-align:center;color:#64748b;font-size:11px;margin-top:8px;">... and ${results.violations.length - 20} more</p>` : ''}
            </div>
          `;
        }

        testResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      },

      async toggleRule(ruleId, enabled) {
        try {
          const { error } = await window.supabase
            .from('emis_validation_rules')
            .update({ enabled })
            .eq('id', ruleId);

          if (error) throw error;

          await this.loadExistingRules();
        } catch (error) {
          console.error('Failed to toggle rule:', error);
          alert('Failed to update rule');
        }
      },

      async runRule(ruleId) {
        try {
          // Get the rule details
          const { data: rule, error: ruleError } = await window.supabase
            .from('emis_validation_rules')
            .select('*')
            .eq('id', ruleId)
            .single();

          if (ruleError) throw ruleError;

          // Show modal
          const modal = new bootstrap.Modal(document.getElementById('ruleTestModal'));
          document.getElementById('ruleTestModalLabel').textContent = `Testing: ${rule.name}`;
          document.getElementById('ruleTestModalBody').innerHTML = `
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Running test...</span>
              </div>
              <p class="mt-3 text-muted">Testing rule...</p>
            </div>
          `;
          modal.show();

          // Run the test
          const results = await this.runRuleTest(rule);

          // Display results in modal
          const modalBody = document.getElementById('ruleTestModalBody');
          
          if (results.violations.length === 0) {
            modalBody.innerHTML = `
              <div style="text-align:center;padding:40px;">
                <i class="bi bi-check-circle-fill" style="font-size:64px;color:#22c55e;"></i>
                <h4 style="margin-top:20px;font-weight:600;color:#166534;">No violations found!</h4>
                <p style="font-size:14px;color:#64748b;margin-top:8px;">Tested ${results.total} appointments from the last 7 days</p>
              </div>
            `;
          } else {
            modalBody.innerHTML = `
              <div class="alert alert-warning">
                <strong>${results.violations.length} violation${results.violations.length > 1 ? 's' : ''} found</strong> in ${results.total} appointments tested
              </div>
              <div style="max-height:400px;overflow-y:auto;">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Clinician</th>
                      <th>Slot Type</th>
                      <th>Reason</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${results.violations.map(v => `
                      <tr>
                        <td>${v.date}</td>
                        <td>${v.time}</td>
                        <td style="font-size:11px;">${this.escapeHtml(v.clinician)}</td>
                        <td style="font-size:11px;">${this.escapeHtml(v.slot_type)}</td>
                        <td style="font-size:11px;">${v.reason}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `;
          }

        } catch (error) {
          console.error('Failed to run rule:', error);
          document.getElementById('ruleTestModalBody').innerHTML = `
            <div class="alert alert-danger">
              <strong>Error:</strong> ${error.message}
            </div>
          `;
        }
      },

      async deleteRule(ruleId) {
        if (!confirm('Are you sure you want to delete this rule? This action cannot be undone.')) {
          return;
        }

        try {
          const { error } = await window.supabase
            .from('emis_validation_rules')
            .delete()
            .eq('id', ruleId);

          if (error) throw error;

          await this.loadExistingRules();
        } catch (error) {
          console.error('Failed to delete rule:', error);
          alert('Failed to delete rule: ' + error.message);
        }
      },

      async renameRule(ruleId) {
        try {
          // Get current rule
          const { data: rule, error: fetchError } = await window.supabase
            .from('emis_validation_rules')
            .select('name')
            .eq('id', ruleId)
            .single();

          if (fetchError) throw fetchError;

          const newName = prompt('Enter new name for this rule:', rule.name);
          if (!newName || newName.trim() === '') return;

          const { error } = await window.supabase
            .from('emis_validation_rules')
            .update({ name: newName.trim() })
            .eq('id', ruleId);

          if (error) throw error;

          await this.loadExistingRules();
        } catch (error) {
          console.error('Failed to rename rule:', error);
          alert('Failed to rename rule: ' + error.message);
        }
      },

      async amendRule(ruleId) {
        try {
          // Get current rule
          const { data: rule, error: fetchError } = await window.supabase
            .from('emis_validation_rules')
            .select('*')
            .eq('id', ruleId)
            .single();

          if (fetchError) throw fetchError;

          // Show config in a prompt (simplified - could be enhanced with a proper modal form)
          const currentConfig = JSON.stringify(rule.config, null, 2);
          const newConfig = prompt('Edit rule configuration (JSON format):\n\nBe careful with the format!', currentConfig);
          
          if (!newConfig || newConfig.trim() === '') return;

          try {
            const parsedConfig = JSON.parse(newConfig);
            
            const { error } = await window.supabase
              .from('emis_validation_rules')
              .update({ config: parsedConfig })
              .eq('id', ruleId);

            if (error) throw error;

            await this.loadExistingRules();
            alert('Rule configuration updated successfully!');
          } catch (parseError) {
            alert('Invalid JSON format. Please check your configuration and try again.');
          }
        } catch (error) {
          console.error('Failed to amend rule:', error);
          alert('Failed to amend rule: ' + error.message);
        }
      },

      clearInput() {
        document.getElementById('ai-rule-input').value = '';
        document.getElementById('ai-rule-preview').style.display = 'none';
        document.getElementById('ai-test-results').style.display = 'none';
        this.generatedRule = null;
      },

      switchCreatorTab(tab) {
        // Update tab styling
        const aiTab = document.getElementById('ai-creator-tab');
        const manualTab = document.getElementById('manual-creator-tab');
        const aiContent = document.getElementById('ai-creator-content');
        const manualContent = document.getElementById('manual-creator-content');

        if (tab === 'ai') {
          aiTab.style.color = '#3b82f6';
          aiTab.style.borderBottom = '3px solid #3b82f6';
          manualTab.style.color = '#64748b';
          manualTab.style.borderBottom = '3px solid transparent';
          aiContent.style.display = 'block';
          manualContent.style.display = 'none';
        } else {
          manualTab.style.color = '#3b82f6';
          manualTab.style.borderBottom = '3px solid #3b82f6';
          aiTab.style.color = '#64748b';
          aiTab.style.borderBottom = '3px solid transparent';
          manualContent.style.display = 'block';
          aiContent.style.display = 'none';
        }
      },

      updateManualForm() {
        const ruleType = document.getElementById('manual-rule-type').value;
        const formFields = document.getElementById('manual-form-fields');

        if (!ruleType) {
          formFields.innerHTML = '<p style="text-align:center;color:#64748b;padding:40px;">Select a rule type to configure</p>';
          return;
        }

        let html = '';

        if (ruleType === 'slot_duration') {
          html = `
            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Slot Type</label>
              <select id="manual-slot-type" class="form-select" style="border-radius:8px;">
                <option value="">All Slot Types</option>
                ${this.contextData.slotTypes.map(s => `<option value="${this.escapeHtml(s)}">${this.escapeHtml(s)}</option>`).join('')}
              </select>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <div>
                <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Minimum Duration (minutes)</label>
                <input type="number" id="manual-duration" class="form-control" placeholder="e.g., 15" min="1" style="border-radius:8px;">
              </div>
              <div>
                <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Priority</label>
                <select id="manual-priority" class="form-select" style="border-radius:8px;">
                  <option value="info">Info</option>
                  <option value="warning" selected>Warning</option>
                  <option value="error">Error</option>
                </select>
              </div>
            </div>
          `;
        } 
        
        else if (ruleType === 'slot_count') {
          html = `
            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Slot Type</label>
              <select id="manual-slot-type" class="form-select" style="border-radius:8px;">
                ${this.contextData.slotTypes.map(s => `<option value="${this.escapeHtml(s)}">${this.escapeHtml(s)}</option>`).join('')}
              </select>
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Minimum Count</label>
              <input type="number" id="manual-count" class="form-control" placeholder="e.g., 5" min="1" style="border-radius:8px;">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Priority</label>
              <select id="manual-priority" class="form-select" style="border-radius:8px;">
                <option value="info">Info</option>
                <option value="warning" selected>Warning</option>
                <option value="error">Error</option>
              </select>
            </div>
          `;
        }
        
        else if (ruleType === 'daily_check') {
          html = `
            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Slot Type to Check</label>
              <select id="manual-slot-type" class="form-select" style="border-radius:8px;">
                ${this.contextData.slotTypes.map(s => `<option value="${this.escapeHtml(s)}">${this.escapeHtml(s)}</option>`).join('')}
              </select>
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Minimum Count Per Day</label>
              <input type="number" id="manual-min-count" class="form-control" placeholder="e.g., 1" min="1" style="border-radius:8px;">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Days of Week</label>
              <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;">
                <label style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" value="Monday" class="manual-days" checked> Mon
                </label>
                <label style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" value="Tuesday" class="manual-days" checked> Tue
                </label>
                <label style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" value="Wednesday" class="manual-days" checked> Wed
                </label>
                <label style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" value="Thursday" class="manual-days" checked> Thu
                </label>
                <label style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" value="Friday" class="manual-days" checked> Fri
                </label>
                <label style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" value="Saturday" class="manual-days"> Sat
                </label>
                <label style="display:flex;align-items:center;gap:6px;">
                  <input type="checkbox" value="Sunday" class="manual-days"> Sun
                </label>
              </div>
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Priority</label>
              <select id="manual-priority" class="form-select" style="border-radius:8px;">
                <option value="info">Info</option>
                <option value="warning" selected>Warning</option>
                <option value="error">Error</option>
              </select>
            </div>
          `;
        }
        
        else if (ruleType === 'custom') {
          html = `
            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Custom Rule Configuration (JSON)</label>
              <textarea id="manual-custom-config" class="form-control" rows="8" placeholder='{"key": "value"}' style="border-radius:8px;font-family:monospace;font-size:12px;"></textarea>
              <small style="color:#64748b;">Enter a valid JSON configuration object</small>
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;font-weight:500;color:#475569;margin-bottom:8px;">Reason/Description</label>
              <textarea id="manual-reason" class="form-control" rows="3" placeholder="Explain the rule logic..." style="border-radius:8px;"></textarea>
            </div>
          `;
        }

        formFields.innerHTML = html;
      },

      async createManualRule() {
        const name = document.getElementById('manual-rule-name').value.trim();
        const ruleType = document.getElementById('manual-rule-type').value;
        const severity = document.getElementById('manual-rule-severity').value;

        if (!name) {
          alert('Please enter a rule name');
          return;
        }

        if (!ruleType) {
          alert('Please select a rule type');
          return;
        }

        let config = {};
        let description = '';

        try {
          if (ruleType === 'slot_duration') {
            const slotType = document.getElementById('manual-slot-type').value;
            const duration = parseInt(document.getElementById('manual-duration').value);
            const priority = document.getElementById('manual-priority').value;

            if (!duration || duration < 1) {
              alert('Please enter a valid minimum duration');
              return;
            }

            config = {
              slot_type: slotType || null,
              min_duration: duration,
              priority: priority
            };

            description = slotType 
              ? `${slotType} appointments must be at least ${duration} minutes long`
              : `All appointments must be at least ${duration} minutes long`;
          }
          
          else if (ruleType === 'slot_count') {
            const slotType = document.getElementById('manual-slot-type').value;
            const count = parseInt(document.getElementById('manual-count').value);
            const priority = document.getElementById('manual-priority').value;

            if (!slotType) {
              alert('Please select a slot type');
              return;
            }

            if (!count || count < 1) {
              alert('Please enter a valid minimum count');
              return;
            }

            config = {
              slot_type: slotType,
              min_count: count,
              priority: priority
            };

            description = `Must have at least ${count} ${slotType} slots per day`;
          }
          
          else if (ruleType === 'daily_check') {
            const slotType = document.getElementById('manual-slot-type').value;
            const minCount = parseInt(document.getElementById('manual-min-count').value);
            const days = Array.from(document.querySelectorAll('.manual-days:checked')).map(cb => cb.value);
            const priority = document.getElementById('manual-priority').value;

            if (!slotType) {
              alert('Please select a slot type');
              return;
            }

            if (!minCount || minCount < 1) {
              alert('Please enter a valid minimum count');
              return;
            }

            if (days.length === 0) {
              alert('Please select at least one day');
              return;
            }

            config = {
              slot_type: slotType,
              min_count: minCount,
              days: days,
              priority: priority
            };

            description = `Must have at least ${minCount} ${slotType} slots on ${days.join(', ')}`;
          }
          
          else if (ruleType === 'custom') {
            const customConfig = document.getElementById('manual-custom-config').value.trim();
            const reason = document.getElementById('manual-reason').value.trim();

            if (!customConfig) {
              alert('Please enter a configuration');
              return;
            }

            try {
              config = JSON.parse(customConfig);
            } catch (e) {
              alert('Invalid JSON configuration: ' + e.message);
              return;
            }

            description = reason || 'Custom validation rule';
          }

          // Create the rule
          const rule = {
            site_id: this.currentSite,
            name: name,
            description: description,
            rule_type: ruleType,
            severity: severity,
            config: config,
            enabled: true
          };

          console.log('Creating rule:', JSON.stringify(rule, null, 2));

          const btn = document.getElementById('manual-create-btn');
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

          const { data, error } = await window.supabase
            .from('emis_validation_rules')
            .insert([rule])
            .select();

          if (error) {
            console.error('Database error:', error);
            throw error;
          }
          
          console.log('Rule created successfully:', data);

          alert('✅ Rule created successfully!');
          this.clearManualForm();
          await this.loadExistingRules();

        } catch (error) {
          console.error('Failed to create rule:', error);
          alert('Failed to create rule: ' + error.message);
        } finally {
          const btn = document.getElementById('manual-create-btn');
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-plus-circle"></i> Create Rule';
        }
      },

      clearManualForm() {
        document.getElementById('manual-rule-name').value = '';
        document.getElementById('manual-rule-type').value = '';
        document.getElementById('manual-rule-severity').value = 'error';
        document.getElementById('manual-form-fields').innerHTML = '<p style="text-align:center;color:#64748b;padding:40px;">Select a rule type to configure</p>';
      },

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    };

    // Initialize AI Rules when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      AIRules.init();
    });
  </script>

  
</body>
</html>

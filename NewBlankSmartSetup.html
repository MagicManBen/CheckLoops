<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoops • Smart Setup</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a1f4a;
      --bg2: #0c2a67;
      --panel: #0f2f73;
      --ink: #eaf1ff;
      --muted: #b5c3e6;
      --nhs: #005EB8;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --border: #ffffff22;
      --card1: #0e2c6e;
      --card2: #0b245a;
      --shadow: 0 20px 50px rgba(0, 0, 0, .45);
      --glow: #60a5fa;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      color: var(--ink);
      background: radial-gradient(1200px 800px at 20% -10%, #1a4fcc66 0%, transparent 60%),
                  radial-gradient(1200px 800px at 100% 10%, #0ea5e955 0%, transparent 60%),
                  linear-gradient(160deg, var(--bg), var(--bg2));
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow-x: hidden;
    }

    /* Navigation */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: saturate(140%) blur(8px);
      background: linear-gradient(180deg, rgba(10, 24, 60, .85), rgba(10, 24, 60, .60));
      border-bottom: 1px solid var(--border);
    }

    .nav {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
    }

    .brand .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7dd3fc, #60a5fa);
      box-shadow: 0 0 20px #60a5fa99;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .navfill {
      flex: 1;
    }

    /* Progress Steps */
    .stepper {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }

    .step {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: linear-gradient(180deg, #0d2b69, #0a2357);
      transition: all 0.3s;
    }

    .step.active {
      border-color: var(--glow);
      color: #dbeafe;
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
    }

    .step.done {
      border-color: var(--ok);
      color: #bbf7d0;
    }

    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      min-height: calc(100vh - 60px);
    }

    /* Pages */
    .page {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Welcome Page */
    .welcome {
      text-align: center;
      padding: 80px 20px;
    }

    .welcome h1 {
      font-size: 48px;
      font-weight: 800;
      background: linear-gradient(135deg, #60a5fa, #22d3ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 20px;
      animation: slideIn 0.6s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .welcome p {
      font-size: 20px;
      color: var(--muted);
      margin-bottom: 40px;
      animation: slideIn 0.8s ease;
    }

    .welcome .searchbar { max-width: 1100px; margin: 0 auto 20px; }
    .welcome .list { text-align: left; }

    /* Buttons */
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #0f3b8a, #0c2d6a);
      color: #e6f0ff;
      padding: 14px 28px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-block;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(13, 70, 160, .4);
    }

    .btn.primary {
      background: linear-gradient(180deg, #1e63d0, #134da6);
      border-color: #4b7bd6;
      animation: glow 3s infinite;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.2); }
      50% { box-shadow: 0 0 30px rgba(96, 165, 250, 0.4); }
    }

    .btn.success {
      background: linear-gradient(180deg, #16a34a, #12843f);
      border-color: #2bd47a;
    }

    .btn.ghost {
      background: transparent;
      border-color: var(--border);
    }

    .btn.slim {
      padding: 10px 16px;
      font-size: 13px;
    }

    /* Cards */
    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: linear-gradient(180deg, var(--card1), var(--card2));
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
      animation: floatIn 0.5s ease;
    }

    @keyframes floatIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    /* Search */
    .searchbar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .searchbar input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #0c285f, #0a2252);
      color: #eaf1ff;
      font-size: 16px;
      transition: all 0.3s;
    }

    .searchbar input:focus {
      outline: none;
      border-color: var(--glow);
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.2);
    }

    .searchbar input::placeholder {
      color: #6b82a6;
    }

    /* Results List */
    .list {
      display: grid;
      gap: 12px;
      max-height: 400px;
      overflow: auto;
      padding: 4px;
    }

    .list::-webkit-scrollbar {
      width: 8px;
    }

    .list::-webkit-scrollbar-track {
      background: #0a1633;
      border-radius: 4px;
    }

    .list::-webkit-scrollbar-thumb {
      background: #1f3a6e;
      border-radius: 4px;
    }

    .item {
      background: linear-gradient(180deg, #102f74, #0b255a);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      display: flex;
      align-items: flex-start; /* top-align content */
      justify-content: space-between;
      gap: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .item:hover {
      transform: translateX(4px);
      border-color: var(--glow);
      box-shadow: 0 10px 24px rgba(13, 70, 160, .25);
    }

    .item.selected {
      border-color: var(--ok);
      background: linear-gradient(180deg, #0f3b7d, #0a2c5f);
    }

    .item .meta { display: flex; flex-direction: column; gap: 2px; }
    .item .meta strong { margin: 0; line-height: 1.25; }
    .item .meta small { display: block; line-height: 1.25; }
    .item .ods { white-space: nowrap; color: var(--muted); }

    .item strong {
      font-size: 15px;
      display: block;
    }

    .item small {
      color: var(--muted);
      font-size: 13px;
    }

    /* Loading Animation */
    .loading {
      text-align: center;
      padding: 60px 20px;
    }

    .spinner {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      border: 3px solid var(--border);
      border-top-color: var(--glow);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 18px;
      color: var(--muted);
      animation: pulse 1.5s ease infinite;
    }

    /* Progress Bar */
    .progress-bar {
      height: 6px;
      background: #0a1633;
      border-radius: 3px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #60a5fa, #22d3ee);
      border-radius: 3px;
      transition: width 0.5s ease;
      animation: shimmer 2s linear infinite;
    }
    /* Make Page 2 mini bar stable (no shimmer) */
    #progressMini { animation: none; }

    /* Solid green when complete */
    .progress-fill.complete { animation: none; background: linear-gradient(90deg, #22c55e, #16a34a); }

    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    /* Meta Info */
    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px 16px;
      font-size: 14px;
    }

    .kv div {
      padding: 8px 0;
      border-bottom: 1px dashed #ffffff20;
    }

    .kv div:first-child {
      color: var(--muted);
    }

    /* Stack */
    .stack {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* Pills */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(180deg, #0e2c6e, #0b245a);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
    }

    .status.ok { border-color: var(--ok); color: #bbf7d0; }
    .status.warn { border-color: var(--warn); color: #ffecb3; }
    .status.err { border-color: var(--err); color: #fecaca; }


    .checkbox-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }

    /* Animations for data import */
    .import-animation {
      display: flex;
      justify-content: center;
      gap: 40px;
      padding: 40px 0;
    }

    .import-step {
      text-align: center;
      opacity: 0.3;
      transition: opacity 0.5s;
    }

    .import-step.active {
      opacity: 1;
    }

    .import-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0e2c6e, #0b245a);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      position: relative;
    }

    .import-step.active .import-icon {
      border-color: var(--glow);
      animation: pulse 1.5s infinite;
    }

    .import-step.done .import-icon {
      border-color: var(--ok);
      background: linear-gradient(135deg, #16a34a33, #12843f33);
    }

    .completion {
      text-align: center;
      padding: 60px 20px;
    }

    .completion .checkmark {
      width: 100px;
      height: 100px;
      margin: 0 auto 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, #16a34a, #12843f);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      animation: scaleIn 0.5s ease;
    }

    @keyframes scaleIn {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stepper {
        display: none;
      }

      .welcome h1 {
        font-size: 32px;
      }

      .import-animation {
        flex-direction: column;
        gap: 20px;
      }
    }
    /* --- Page 2: "Smart Fetch" scan UI --- */
    .scan {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 16px;
      background:
        radial-gradient(1000px 600px at 20% -20%, #1a4fcc33, transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      overflow: hidden;
      padding: 16px;
    }
    .scan::before {
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient( to right, #ffffff06 0 1px, transparent 1px 80px),
        repeating-linear-gradient( to bottom, #ffffff07 0 1px, transparent 1px 80px);
      pointer-events:none;
    }
    .sweep {
      position:absolute; left:0; right:0; height:160px; top:-160px;
      background: linear-gradient(180deg, transparent, rgba(96,165,250,.20), transparent);
      filter: blur(2px);
      animation: sweep 3s linear infinite;
    }
    @keyframes sweep { from{ top:-160px } to{ top:100% } }

    .streams { display: grid; grid-template-columns: 1fr; gap: 10px; position: relative; z-index:1; }
    .stream {
      display:grid; grid-template-columns: 220px 1fr 90px; align-items:center;
      gap:12px; padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background: linear-gradient(180deg, #0e2c6e, #0b245a);
    }
    .stream .label { font-weight:600; font-size:14px; letter-spacing:.2px; }
    .meter { height:8px; background:#0a1633; border-radius:999px; overflow:hidden; }
    .meter .fill { height:100%; width:0%; background: linear-gradient(90deg, #60a5fa, #22d3ee); transition: width .6s ease; }
    .stream .state { text-align:right; font-size:12px; color: var(--muted); }

    .stream.queued .state::before { content:"Queued"; }
    .stream.active { border-color: var(--glow); box-shadow: 0 0 20px rgba(96,165,250,.15); }
    .stream.active .state { color:#dbeafe; }
    .stream.active .state::before { content:"Fetching…"; }
    .stream.done { border-color: var(--ok); background: linear-gradient(180deg, #0e2c6e, #0b2f5a); }
    .stream.done .state { color:#bbf7d0; }
    .stream.done .state::before { content:"Saved ✓"; }

    .telemetry {
      margin-top: 16px; border:1px dashed #ffffff22; border-radius:12px; padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size:12px; color:#9db2d6; max-height:140px; overflow:auto;
      background: linear-gradient(180deg, #0b245a, #091d49);
    }
    .telemetry .line { opacity:.85; white-space:nowrap; }
    .telemetry .line.dim { opacity:.6; }

    /* --- Page 2: Tick Cards --- */
    .ticklist { display:grid; gap:12px; position:relative; }
    .tickcard { display:grid; grid-template-columns: 44px 1fr auto; align-items:center; gap:12px; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background: linear-gradient(180deg, var(--card1), var(--card2)); }
    .tickcard .label { font-weight:600; font-size:14px; letter-spacing:.2px; }
    .tickcard .state { font-size:12px; color: var(--muted); }
    .tickcard.queued .state::before { content:"Queued"; }
    .tickcard.done .state { color:#bbf7d0; }
    .tickcard.done .state::before { content:"Done ✓"; }

    .bullet { position:relative; width:28px; height:28px; border-radius:50%; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg,#0e2c6e,#0b245a); }
    .bullet .tick { font-size:16px; line-height:1; opacity:.15; transform: translateY(6px) scale(.9); transition: opacity .25s ease, transform .25s ease; color:#a7f3d0; }
    .tickcard.done .bullet { border-color:#22c55e66; box-shadow: 0 0 0 2px #22c55e22, 0 0 22px #22c55e55, inset 0 0 10px #22c55e22; background: radial-gradient(60% 60% at 50% 50%, #16a34a66, transparent 60%), linear-gradient(180deg,#0e2c6e,#0b245a); }
    .tickcard.done .bullet .tick { opacity:1; transform: translateY(0) scale(1); text-shadow: 0 0 12px rgba(34,197,94,.9), 0 0 30px rgba(34,197,94,.5); }

    .bullet .tick-fade { position:absolute; opacity:0; font-size:16px; color:#a7f3d0; text-shadow: 0 0 14px rgba(34,197,94,.9), 0 0 30px rgba(34,197,94,.6); }
    .tickcard.flash .bullet .tick-fade { animation: floatTick .9s ease forwards; }

    @keyframes floatTick {
      0% { opacity:0; transform: translateY(6px) scale(.8); }
      20% { opacity:1; transform: translateY(0) scale(1); }
      100% { opacity:0; transform: translateY(-14px) scale(1.12); }
    }

    /* --- Page 2: Weave Loader (complete redo) --- */
    .weave { display:flex; flex-direction:column; align-items:center; gap:22px; }
    .rings { position:relative; width:150px; height:150px; }
    .ring { position:absolute; inset:0; border-radius:50%; border:2px solid #2b4b94; box-shadow: inset 0 0 20px #0a2b66; }
    .ring.r2 { inset:10px; border-color:#3762c4; animation: spinCW 9s linear infinite; }
    .ring.r3 { inset:22px; border-color:#60a5fa; filter: drop-shadow(0 0 12px #60a5fa77); animation: spinCCW 6s linear infinite; }
    @keyframes spinCW { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes spinCCW { from { transform: rotate(360deg); } to { transform: rotate(0deg); } }
    .spark { position:absolute; left:50%; top:50%; width:6px; height:6px; border-radius:50%; background:#60a5fa; box-shadow: 0 0 12px #60a5fa; transform-origin:-50px 0; animation: orbit 2.2s linear infinite; }
    .spark.s2 { transform-origin:-34px 0; opacity:.75; animation-duration: 1.6s; }
    .spark.s3 { transform-origin:-22px 0; opacity:.55; animation-duration: 1.1s; }
    @keyframes orbit { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .statusline { color: var(--muted); font-size:14px; min-height:20px; }

    .chips { display:grid; grid-template-columns: repeat(2, minmax(260px, 1fr)); gap:12px; width:100%; max-width: 820px; }
    .chip { position:relative; display:flex; align-items:center; gap:10px; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background: linear-gradient(180deg, var(--card1), var(--card2)); transition: all .35s ease; opacity:.9; }
    .chip .indicator { width:10px; height:10px; border-radius:50%; background:#163066; box-shadow: inset 0 0 6px #000; }
    .chip .label { font-weight:600; font-size:14px; letter-spacing:.2px; }
    .chip.on { border-color:#4b7bd6; box-shadow: 0 0 20px rgba(96,165,250,.18); }
    .chip.on .indicator { background:#60a5fa; box-shadow: 0 0 10px #60a5fa; }
    .chip.done { border-color:#22c55e; background: linear-gradient(180deg, #0f3f2a, #0b2f22); }
    .chip.done .indicator { background:#22c55e; box-shadow: 0 0 12px #22c55e; }
    .chip.done::after { content:'✓'; margin-left:auto; color:#bbf7d0; font-weight:800; text-shadow:0 0 12px #22c55e; }
    .chip.burst::before { content:''; position:absolute; inset:-2px; border-radius:14px; background: radial-gradient(120px 50px at 20% -20%, rgba(34,197,94,.35), transparent 60%); opacity:0; animation: burst .9s ease forwards; }
    @keyframes burst { 0%{opacity:.0; transform: translateY(6px);} 25%{opacity:.9;} 100%{opacity:0; transform: translateY(-10px);} }

    @media (max-width: 680px){ .chips{ grid-template-columns: 1fr; } }
  </style>
  <!--
    IMPORTANT ⚠️
    - Do NOT paste your Supabase SERVICE KEY in this file. It must never be shipped to browsers.
    - This page uses only the Supabase ANON (publishable) key.
    - CQC/NHS calls are attempted directly. If you hit CORS/rate limits, create a Supabase Edge Function
      and call it from here (we include an optional attempt below).
  -->
</head>
<body>
  <!-- Navigation -->
  <header>
    <div class="nav">
      <div class="brand">
        <span class="dot"></span>
        CheckLoops • Smart Setup
      </div>
      <div class="navfill"></div>
      <div class="stepper">
        <span class="step active" id="step1">Welcome</span>
        <span class="step" id="step2">Fetching</span>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Page 1: Welcome -->
    <div class="page active" id="page1">
      <div class="welcome">
        <h1>Welcome to Smart Setup</h1>
        <p>Let's set up your GP practice in just a few steps</p>
        <div class="searchbar">
          <input id="q" placeholder="Enter practice name (e.g., Park Medical Centre)" />
          <button class="btn primary" id="go">Search</button>
        </div>
        <div id="searchStatus" style="margin-top: 20px; display: none;">
          <div class="loading">
            <div class="spinner"></div>
            <div class="loading-text">Searching...</div>
          </div>
        </div>
        <div id="results" class="list" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Page 2: Fetching -->
    <div class="page" id="page2">
      <div class="completion" style="padding-top: 40px;">
<h2 style="font-size: 32px; margin-bottom: 6px;">Setting up your practice…</h2>
<p id="fetchingSubtitle" style="color: var(--muted); font-size: 16px; margin-bottom: 4px;">We’re gathering the important bits.</p>
<div class="weave">
  <div class="rings">
    <div class="ring r1"></div>
    <div class="ring r2"></div>
    <div class="ring r3"></div>
    <div class="spark s1"></div>
    <div class="spark s2"></div>
    <div class="spark s3"></div>
  </div>
  <div class="statusline"><span id="scanMsg">Preparing sources…</span></div>
  <div class="chips" id="chips">
    <div class="chip" id="s-location"><span class="indicator"></span><span class="label">Location & Contact</span></div>
    <div class="chip" id="s-opening"><span class="indicator"></span><span class="label">Opening Times</span></div>
    <div class="chip" id="s-cqc"><span class="indicator"></span><span class="label">CQC Rating & Report</span></div>
    <div class="chip" id="s-patient"><span class="indicator"></span><span class="label">Patient Feedback</span></div>
    <div class="chip" id="s-guest"><span class="indicator"></span><span class="label">Guest Feedback</span></div>
    <div class="chip" id="s-improve"><span class="indicator"></span><span class="label">Improvement Points</span></div>
    <div class="chip" id="s-compare"><span class="indicator"></span><span class="label">Local Comparisons</span></div>
  </div>
</div>
<div id="successMsg" style="display:none; margin: 6px auto 0; text-align:center; color:#bbf7d0; font-weight:600;">✓ All done — practice data saved.</div>
      </div>
    </div>

    <!-- Page 3, 4, 5 removed -->
  </div>


<script>
  // ===== Config (client-safe) =====
  const SUPABASE_URL = 'https://unveoqnlqnobufhublyw.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_wpy7lxfbI2HwvsznlWJVKg_Zx7HnAc4';
  const TABLE = 'CQC All GPs'; // exact name in your DB
  const EDGE_FN = 'fetch-nhs-data-complete'; // optional: if you already have it deployed

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const el = (id)=>document.getElementById(id);
  const logEl = null;
  function log(msg, data){
    try { console.debug(msg, data !== undefined ? data : ''); } catch (e) {}
  }
  function setRaw(obj){
    try { console.debug('[raw]', obj); } catch (e) {}
  }
  function setStatus(txt, cls='warn'){
    try { console.debug('[status]', txt); } catch (e) {}
  }

  let current = null; // { location_id, provider_id, ods_code?, row? }
  let currentPage = 1;
  let isImporting = false; // prevents duplicate background imports
  let miniProgress = 0; // ensures the Page 2 bar only moves forward

  const STREAM_IDS = ['s-location','s-opening','s-cqc','s-patient','s-guest','s-improve','s-compare'];
  let scanInterval = null;
  let tickIndex = -1; // which card is currently completed

  // ===== Page Navigation =====
  function goToPage(pageNum) {
    if (pageNum > 2) { pageNum = 2; }
    // Hide all pages
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

    // Show the selected page
    el('page' + pageNum).classList.add('active');

    // Update steps
    document.querySelectorAll('.step').forEach((s, i) => {
      s.classList.remove('active', 'done');
      if (i + 1 < pageNum) {
        s.classList.add('done');
      } else if (i + 1 === pageNum) {
        s.classList.add('active');
      }
    });

    currentPage = pageNum;

    // Start/stop the scan animation for Page 2
    if (pageNum === 2) { startScanAnimation(); } else { stopScanAnimation(); }

    // Focus search input when on search page or welcome (search now on both)
    if (pageNum === 1 || pageNum === 2) {
      setTimeout(() => { const q = el('q'); if (q) q.focus(); }, 100);
    }
  }

  // ===== Utils: debounce for live search =====
  function debounce(fn, delay){
    let t; return function(...args){
      clearTimeout(t); t = setTimeout(()=>fn.apply(this, args), delay);
    };
  }

  // ===== Search with Animation =====
  async function search(qStr){
    const q = (typeof qStr === 'string' ? qStr : el('q').value).trim();
    if(q.length < 2){
      // Too short: clear results and hide loader
      const list = el('results');
      if(list) list.innerHTML = '';
      const ss = el('searchStatus');
      if(ss) ss.style.display = 'none';
      return;
    }

    // Show loading animation
    el('searchStatus').style.display = 'block';

    setStatus('Searching…');

    // Build query
    let query = supabase.from(TABLE)
      .select('location_id, location_name, postcode, region, ods_code, provider_id')
      .ilike('location_name', `%${q}%`)
      .limit(20);


    const { data, error } = await query;

    // Hide loading animation
    el('searchStatus').style.display = 'none';

    if(error){
      setStatus('Search failed', 'err');
      log('Search failed', error);
      return;
    }

    setStatus(`Found ${data.length} results`, 'ok');
    renderResults(data);
  }

  function renderResults(rows){
    const list = el('results');
    if(!rows.length){
      list.innerHTML = '<div class="item"><small>No matches found. Try a different search term.</small></div>';
      return;
    }
    list.innerHTML = '';
    rows.forEach(r=>{
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div class="meta"><strong>${r.location_name}</strong><small>${r.region||'—'} · ${r.postcode||'—'}</small></div><div class="ods"><small>${r.ods_code?('ODS '+r.ods_code):''}</small></div>`;
      div.onclick = ()=>selectPractice(r.location_id);
      list.appendChild(div);
    });
  }

  // ===== Load + show one row =====
  async function selectPractice(location_id){
    setStatus('Loading practice...');
    const { data, error } = await supabase.from(TABLE).select('*').eq('location_id', location_id).single();
    if(error){ setStatus('Load failed', 'err'); log('Load failed', error); return; }

    current = {
      location_id: data.location_id,
      provider_id: data.provider_id || null,
      ods_code: data.ods_code || null,
      row: data
    };

    setStatus('Practice loaded', 'ok');
    renderMeta(data);
    setRaw({ saved_row: data });
    goToPage(2);
    if(!isImporting){ isImporting = true; originalFetchBoth(); }
  }

  function renderMeta(row){
    const m = el('meta');
    if (!m) { return; }
    const addr = [row.address_line_1,row.address_line_2,row.town_city,row.postcode].filter(Boolean).join(', ');
    m.innerHTML = ''+
      kv('Location name', row.location_name) +
      kv('Location ID', row.location_id) +
      kv('Provider ID', row.provider_id||'—') +
      kv('ODS code', row.ods_code||'—') +
      kv('Phone', row.main_phone_number||'—') +
      kv('Website', row.website||'—') +
      kv('Address', addr||'—') +
      kv('Region', row.region||'—') +
      kv('Last NHS update', row.last_nhs_update? String(row.last_nhs_update).replace('T',' ').split('.')[0] : '—');
  }
  function kv(k,v){ return `<div style="color:var(--muted)">${k}</div><div>${v??'—'}</div>`; }

  // ===== CQC fetch with animations =====
  async function fetchCQC(){
    if(!current){ return; }
    const locId = current.location_id;
    const provId = current.provider_id;

    setStatus('Fetching CQC…');
    animateImportStep('import-cqc', 'active');
    updateProgressBar(20);

    try{
      // Try Edge Function first (if present)
      const viaEdge = await tryEdge({ location_id: locId, provider_id: provId, ods_code: current.ods_code||null, data_sources:['cqc'] });
      if(viaEdge){ await afterCqc(viaEdge); return; }

      // Fallback: direct CQC API (public)
      const loc = await fetchJson(`https://api.cqc.org.uk/public/v1/locations/${encodeURIComponent(locId)}`);
      let prov = null;
      if(provId){ prov = await fetchJson(`https://api.cqc.org.uk/public/v1/providers/${encodeURIComponent(provId)}`); }
      const payload = { location: loc, provider: prov };
      await afterCqc({ data: payload });
    }catch(e){
      setStatus('CQC error', 'err');
      log('CQC fetch error', String(e));
      animateImportStep('import-cqc', '');
    }
  }

  async function afterCqc(resp){
    const cqc = resp?.data || resp; // support both shapes
    setRaw({ cqc });
    const update = buildUpdateFromCqc(cqc);
    await saveUpdate(update);

    // refresh current
    await selectPractice(current.location_id);
    setStatus('CQC saved', 'ok');
    animateImportStep('import-cqc', 'done');
    updateProgressBar(40);
  }

  function buildUpdateFromCqc(cqc){
    if(!cqc) return {};
    const loc = cqc.location || cqc.cqc_location || cqc.Location || cqc || null;
    const prov = cqc.provider || cqc.cqc_provider || cqc.Provider || null;

    const pick = (a,b,c)=> a!==undefined ? a : (b!==undefined ? b : c);
    const ratingObj = loc?.currentRatings||null;

    const telecomPhone = null; // CQC payloads rarely carry telecom arrays

    return compact({
      location_source: loc ? JSON.stringify(loc) : undefined,
      provider_source: prov ? JSON.stringify(prov) : undefined,

      location_name: pick(loc?.name, prov?.name, undefined),
      provider_name: pick(prov?.name, undefined, undefined),
      provider_id: pick(loc?.providerId, prov?.providerId, undefined),
      organisation_type: pick(loc?.organisationType, undefined, undefined),
      location_type: pick(loc?.type, undefined, undefined),
      region: pick(loc?.region, undefined, undefined),

      address_line_1: pick(loc?.postalAddressLine1, undefined, undefined),
      address_line_2: pick(loc?.postalAddressLine2, undefined, undefined),
      town_city: pick(loc?.postalAddressTownCity, undefined, undefined),
      postcode: pick(loc?.postalCode, undefined, undefined),
      uprn: pick(loc?.uprn, undefined, undefined),
      latitude: (loc?.onspdLatitude!=null)? String(loc.onspdLatitude) : undefined,
      longitude:(loc?.onspdLongitude!=null)? String(loc.onspdLongitude): undefined,
      main_phone_number: pick(loc?.mainPhoneNumber, prov?.mainPhoneNumber, telecomPhone||undefined),
      website: pick(loc?.website, prov?.website, undefined),

      onspd_ccg_code: pick(loc?.onspdCcgCode, undefined, undefined),
      onspd_ccg_name: pick(loc?.onspdCcgName, undefined, undefined),
      onspd_icb_code: pick(loc?.onspdIcbCode, undefined, undefined),
      onspd_icb_name: pick(loc?.onspdIcbName, undefined, undefined),
      ods_ccg_code: pick(loc?.odsCcgCode, undefined, undefined),
      ods_ccg_name: pick(loc?.odsCcgName, undefined, undefined),

      overall_rating: ratingObj?.overall?.rating,
      last_inspection_date: pick(loc?.lastInspection?.date, undefined, undefined),
      last_report_date: pick(loc?.lastReport?.publicationDate, undefined, undefined),

      regulated_activities: loc?.regulatedActivities ? JSON.stringify(loc.regulatedActivities) : undefined,
      inspection_areas: loc?.inspectionAreas ? JSON.stringify(loc.inspectionAreas) : undefined,
      inspection_categories: loc?.inspectionCategories ? JSON.stringify(loc.inspectionCategories) : undefined,
      gac_service_types: loc?.gacServiceTypes ? JSON.stringify(loc.gacServiceTypes) : undefined,
      specialisms: loc?.specialisms ? JSON.stringify(loc.specialisms) : undefined,

      provider_website: prov?.website,
      provider_main_phone_number: prov?.mainPhoneNumber,
      provider_registration_status: prov?.registrationStatus,
      provider_registration_date: prov?.registrationDate,
      ownership_type: prov?.ownershipType,
      provider_region: prov?.region,
      provider_address_line_1: prov?.postalAddressLine1,
      provider_address_line_2: prov?.postalAddressLine2,
      provider_town_city: prov?.postalAddressTownCity,
      provider_postcode: prov?.postalCode,
      provider_location_ids: prov?.locationIds ? JSON.stringify(prov.locationIds) : undefined,
      provider_inspection_areas: prov?.inspectionAreas ? JSON.stringify(prov.inspectionAreas) : undefined,

      ods_code: normalizeOds(loc?.odsCode),
      updated_at: new Date().toISOString(),
    });
  }

  // ===== NHS ODS fetch with animations =====
  async function fetchODS(){
    if(!current){ return; }
    setStatus('Fetching NHS ODS…');
    animateImportStep('import-nhs', 'active');
    updateProgressBar(60);

    try{
      // Try Edge Function first (if present)
      const viaEdge = await tryEdge({ location_id: current.location_id, ods_code: current.ods_code||null, data_sources:['ods'] });
      if(viaEdge){ await afterOds(viaEdge); return; }

      let odsData = null;
      if(current.ods_code){
        odsData = await fetchJson(`https://directory.spineservices.nhs.uk/ORD/2-0-0/organisations/${encodeURIComponent(current.ods_code)}`);
      } else if(current.row){
        // Fallback: search by name (coarse)
        const name = encodeURIComponent(current.row.location_name);
        const list = await fetchJson(`https://directory.spineservices.nhs.uk/ORD/2-0-0/organisations?Name=${name}`);
        odsData = Array.isArray(list?.organisations) ? list.organisations[0] || null : list || null;
      }
      await afterOds({ data: { ods_data: odsData } });
    }catch(e){
      setStatus('NHS error', 'err');
      log('NHS fetch error', String(e));
      animateImportStep('import-nhs', '');
    }
  }

  async function afterOds(resp){
    const ods = resp?.data?.ods_data || resp?.data || resp || null;
    setRaw({ ods });
    const update = buildUpdateFromOds(ods);
    await saveUpdate(update);
    await selectPractice(current.location_id);
    setStatus('NHS saved', 'ok');
    animateImportStep('import-nhs', 'done');
    updateProgressBar(80);
  }

  function buildUpdateFromOds(ods){
    if(!ods) return {};
    // Flexible extraction (the ORD API can return {identifier:{value}}, or arrays, etc.)
    let ident = '';
    if(ods.identifier?.value){ ident = ods.identifier.value; }
    else if(Array.isArray(ods.identifier)){ const m = ods.identifier.find(x=>String(x.system||'').toLowerCase().includes('ods')); ident = m?.value || ods.identifier[0]?.value || ''; }
    else if(typeof ods.identifier==='string'){ ident = ods.identifier; }
    else if(ods.code){ ident = ods.code; }

    const telecom = Array.isArray(ods.telecom)? ods.telecom : [];
    const phone = telecom.find(t=>String(t.system||'').toLowerCase()==='phone')?.value || null;
    const url = telecom.find(t=>String(t.system||'').toLowerCase()==='url')?.value || (ods.website||null);

    const addr = Array.isArray(ods.address)? ods.address[0] : (ods.address||null);
    const line = Array.isArray(addr?.line)? addr.line : [];

    return compact({
      nhs_ods_data: JSON.stringify(ods),
      last_nhs_update: new Date().toISOString(),
      ods_code: normalizeOds(ident)||undefined,
      main_phone_number: phone||undefined,
      website: url||undefined,
      address_line_1: addr?.line1 || line[0] || addr?.addressLine1 || undefined,
      address_line_2: addr?.line2 || line[1] || addr?.addressLine2 || undefined,
      town_city: addr?.city || addr?.town || addr?.postalAddressTownCity || undefined,
      postcode: addr?.postalCode || addr?.postcode || undefined,
      region: ods.region || undefined,
      location_name: ods.name || undefined,
      updated_at: new Date().toISOString(),
    });
  }

  // ===== Save helper with animation =====
  async function saveUpdate(update){
    if(!current) return;
    const clean = compact(update);
    if(!Object.keys(clean).length){ log('Nothing to update'); return; }

    animateImportStep('import-save', 'active');

    const { data, error } = await supabase.from(TABLE).update(clean).eq('location_id', current.location_id).select('*');

    if(error){
      setStatus('Save failed','err');
      log('Save failed', error);
      animateImportStep('import-save', '');
      return;
    }

    log('Saved', { keys: Object.keys(clean) });
    animateImportStep('import-save', 'done');
    updateProgressBar(100);
    return data?.[0] || null;
  }

  // ===== Utilities =====
  async function fetchJson(url){
    const res = await fetch(url);
    if(!res.ok){ throw new Error(`${res.status} ${res.statusText}`); }
    return await res.json();
  }
  function compact(obj){ const out={}; Object.keys(obj||{}).forEach(k=>{ const v=obj[k]; if(v!==undefined) out[k]=v; }); return out; }
  function normalizeOds(c){ if(!c) return ''; const u=String(c).trim().toUpperCase(); return /^[A-Z0-9]{3,8}$/.test(u)?u:''; }

  async function tryEdge(body){
    try{
      const { data, error } = await supabase.functions.invoke(EDGE_FN, { body });
      if(error){ log('Edge function error (ignored)', error); return null; }
      if(data){ setRaw({ edge_response:data }); return data; }
      return null;
    }catch(e){ log('Edge function call failed (ignored)', String(e)); return null; }
  }

  // ===== Animation helpers =====
  function animateImportStep(stepId, status) {
    const step = el(stepId);
    if (!step) return;

    step.classList.remove('active', 'done');
    if (status) {
      step.classList.add(status);
    }
  }

  function updateProgressBar(percent) {
    const main = (typeof el === 'function') ? el('progressBar') : document.getElementById('progressBar');
    const mini = document.getElementById('progressMini');

    // Never move backwards visually
    let p = Math.max(miniProgress || 0, Number(percent) || 0);
    miniProgress = p;

    // Update the streams visualisation
    try { updateStreamsForMiniProgress(p); } catch(e) {}

    if (p >= 100) {
      if (main) main.style.width = '100%';
      if (mini) {
        mini.style.width = '100%';
        mini.classList.add('complete');
      }

      const msg = document.getElementById('successMsg');
      if (msg) msg.style.display = 'block';

      const sub = document.getElementById('fetchingSubtitle');
      if (sub) sub.textContent = 'All done — practice data saved.';

      ['p2-cqc','p2-ods','p2-save'].forEach(id=>{ const e=document.getElementById(id); if(e){ e.classList.add('done'); e.classList.remove('active'); }});

      if (typeof isImporting !== 'undefined') { isImporting = false; }
      stopScanAnimation();
      return;
    }

    if (main) main.style.width = p + '%';
    if (mini) {
      mini.style.width = p + '%';
      mini.classList.remove('complete');
    }
  }

  // ===== Debug Panel =====
  function toggleDebug() { /* no-op: debug UI removed */ }

  // ===== Fetch both with animation sequence =====
  const originalFetchBoth = async function() {
    // Reset all animations
    ['import-cqc', 'import-nhs', 'import-save'].forEach(id => {
      animateImportStep(id, '');
    });
    miniProgress = 0;
    updateProgressBar(0);

    await fetchCQC();
    await fetchODS();
  };

  // ===== Wire up =====
  el('go').onclick = search;
  el('q').addEventListener('keydown', e=>{ if(e.key==='Enter') search(); });
  const debouncedSearch = debounce(()=>search(), 300);
  el('q').addEventListener('input', debouncedSearch);
  const rld = el('btnReload'); if (rld) rld.onclick = ()=> current && selectPractice(current.location_id);
  const cqc = el('btnFetchCQC'); if (cqc) cqc.onclick = fetchCQC;
  const ods = el('btnFetchODS'); if (ods) ods.onclick = fetchODS;
  const both = el('btnFetchBoth'); if (both) both.onclick = originalFetchBoth;

  // Focus search on load
  window.addEventListener('load', ()=>{
    if (currentPage === 1 || currentPage === 2) {
      const q = el('q'); if (q) q.focus();
    }
  });
// === Weave Loader (Page 2) ===
const WEAVE_MESSAGES = [
  'Normalising postcode and region…',
  'Pulling NHS ODS directory entry…',
  'Reading CQC provider record…',
  'Extracting opening hours…',
  'Scanning patient feedback…',
  'Scanning guest feedback…',
  'Mining improvement points…',
  'Comparing with nearby practices…',
  'Geo-matching ICB/CCG…'
];
let msgTimer = null, chipTimer = null;
let chipOrder = [];

function buildWeaveUI(){
  // reset chips
  STREAM_IDS.forEach(id=>{
    const n = el(id); if(!n) return;
    n.classList.remove('on','done','burst');
  });
  // shuffled order
  chipOrder = [...STREAM_IDS].sort(()=> Math.random() - 0.5);
  const msg = el('scanMsg'); if (msg) msg.textContent = 'Preparing sources…';
}

function setChipOn(id){ const n = el(id); if(n) n.classList.add('on'); }
function setChipDone(id){ const n = el(id); if(!n) return; n.classList.remove('on'); n.classList.add('done','burst'); setTimeout(()=> n.classList.remove('burst'), 900); }

function rotateMessage(){
  const msg = el('scanMsg'); if(!msg) return;
  const next = WEAVE_MESSAGES[Math.floor(Math.random()*WEAVE_MESSAGES.length)];
  msg.textContent = next;
}

function startScanAnimation(){
  if (scanInterval) return; // keep existing guard
  buildWeaveUI();
  // kick a couple of chips to look alive
  setTimeout(()=> setChipOn(chipOrder[0]), 200);
  setTimeout(()=> setChipOn(chipOrder[1]), 400);
  // sequentially complete chips
  chipTimer = setInterval(()=>{
    const id = chipOrder.shift();
    if (!id){ clearInterval(chipTimer); chipTimer = null; return; }
    setChipDone(id);
  }, 800);
  // message rotator
  msgTimer = setInterval(rotateMessage, 1100);
  // dummy handle to reuse existing variable
  scanInterval = true;
}

function stopScanAnimation(){
  if (msgTimer){ clearInterval(msgTimer); msgTimer = null; }
  if (chipTimer){ clearInterval(chipTimer); chipTimer = null; }
  scanInterval = null;
}

function updateStreamsForMiniProgress(p){
  if (p >= 100){
    // Finish any remaining chips and tidy up
    STREAM_IDS.forEach(id=> setChipDone(id));
    const msg = el('scanMsg'); if (msg) msg.textContent = 'All done — practice data saved.';
    stopScanAnimation();
  }
}
</script>
</body>
</html>
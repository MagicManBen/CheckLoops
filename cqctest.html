<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CQC Search & Enrich</title>
<link rel="preconnect" href="https://unpkg.com" />
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<style>
  :root { --bg:#0b1020; --panel:#121a33; --muted:#7b8aa5; --text:#e7eefb; --brand:#4cc9f0; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --chip:#1f2a4a; --diff:#113b25; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.22);padding:16px;border:1px solid rgba(255,255,255,.05)}
  h1{font-size:20px;margin:0 0 12px;display:flex;gap:10px;align-items:center}
  .muted{color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  input,button,select{border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0f1630;color:var(--text);padding:10px 12px}
  input{flex:1;min-width:240px}
  button{cursor:pointer}
  .split{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
  .list{max-height:420px;overflow:auto}
  .item{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;gap:10px}
  .item:hover{background:#0f1733}
  .tag{background:var(--chip);border:1px solid rgba(255,255,255,.06);padding:2px 8px;border-radius:999px;font-size:12px}
  .btn{background:linear-gradient(135deg, #3a86ff, #4cc9f0);border:none}
  .btn.warn{background:linear-gradient(135deg, #f59e0b, #f97316)}
  .btn.good{background:linear-gradient(135deg, #22c55e, #10b981)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:6px;align-items:center}
  .code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#0e162d;border:1px solid rgba(255,255,255,.06); padding:10px;border-radius:10px}
  .changed{background:var(--diff);border:1px solid rgba(34,197,94,.35);}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ðŸ”Ž CQC Search & Enrich <span class="tag" id="status">idle</span></h1>
    <div class="row">
      <input id="q" placeholder="Search name, postcode or ODS code (e.g. M83076, 'Springview', 'BL3 1HQ')" />
      <select id="limit">
        <option value="25">25</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
      </select>
      <button class="btn" id="btnSearch">Search</button>
      <button class="btn warn" id="btnClear">Clear</button>
    </div>
  </div>

  <div class="split" style="margin-top:14px">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="muted">Results</div>
        <div id="count" class="tag">0</div>
      </div>
      <div id="list" class="list"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="muted">Details</div>
        <div class="row">
          <button class="btn good" id="btnEnrich" disabled>Pull remaining data</button>
        </div>
      </div>
      <div id="detail" class="grid2"></div>
      <div id="diffNote" class="hint" style="margin-top:8px;display:none">Green highlights indicate fields updated from the API just now.</div>
      <div id="log" class="code" style="margin-top:10px;white-space:pre-wrap;max-height:160px;overflow:auto"></div>
    </div>
  </div>
</div>

<script>
/** === CONFIG (replace later if you rotate) === */
const SUPABASE_URL = 'https://unveoqnlqnobufhublyw.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME';
const CQC_KEY = '5b91c30763b4466e89727c0c555e47a6'; // primary key (test); rotates later
const TABLE = 'CQC All GPs'; // quoted on the server

/** Supabase client (anon) */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/** UI helpers */
const el = id => document.getElementById(id);
const log = (m) => { const L=el('log'); L.textContent += (L.textContent?'\n':'') + m; L.scrollTop=L.scrollHeight; };
const setStatus = (t) => el('status').textContent = t;

/** Search */
el('btnSearch').onclick = async () => {
  setStatus('searchingâ€¦');
  el('list').innerHTML = '';
  el('detail').innerHTML = '';
  el('btnEnrich').disabled = true;
  el('diffNote').style.display = 'none';
  el('log').textContent = '';

  const q = el('q').value.trim();
  const lim = parseInt(el('limit').value, 10);

  // Simple OR filter: name / postcode / ODS (odsCode is inside location_source JSON from CSV)
  let req = sb.from(TABLE)
    .select(`
      location_id, location_name, postcode, provider_id,
      overall_rating, last_inspection_date,
      location_source
    `)
    .limit(lim);

  if (q) {
    const like = `%${q}%`;
    req = req.or([
      `location_name.ilike.${like}`,
      `postcode.ilike.${like}`,
      `location_source->>odsCode.ilike.${like}`
    ].join(','));
  }

  const { data, error } = await req;
  if (error) { setStatus('error'); log('Search error: '+error.message); return; }

  el('count').textContent = data.length;
  setStatus('ready');

  data.forEach(row => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div>
        <div><strong>${row.location_name || '(no name)'}</strong></div>
        <div class="muted">${row.postcode || ''}</div>
      </div>
      <div class="row">
        ${row.overall_rating ? `<span class="tag">${row.overall_rating}</span>` : ''}
        <button class="btn" data-id="${row.location_id}">Open</button>
      </div>
    `;
    div.querySelector('button').onclick = () => showDetails(row.location_id);
    el('list').appendChild(div);
  });
};

/** Load & render details */
async function showDetails(locationId){
  setStatus('loadingâ€¦');
  el('diffNote').style.display = 'none';
  el('log').textContent = '';

  const { data, error } = await sb.from(TABLE)
    .select('*')
    .eq('location_id', locationId)
    .maybeSingle();
  if (error || !data) { setStatus('error'); log('Load error: '+(error?.message||'not found')); return; }

  renderDetails(data);
  el('btnEnrich').disabled = false;
  el('btnEnrich').onclick = () => enrichNow(data);
  setStatus('ready');
}

/** Render with optional change highlighting */
function renderDetails(row, before=null){
  const d = el('detail');
  d.innerHTML = '';

  const pairs = [
    ['Location ID', row.location_id],
    ['Name', row.location_name],
    ['Postcode', row.postcode],
    ['Town/City', row.town_city],
    ['County', row.county],
    ['Region', row.region],
    ['Provider ID', row.provider_id],
    ['Overall rating', row.overall_rating],
    ['Last inspection', row.last_inspection_date],
    ['Reg. status', row.registration_status],
    ['Reg. date', row.registration_date],
    ['De-reg. date', row.deregistration_date],
    ['Latitude', row.latitude],
    ['Longitude', row.longitude]
  ];

  for (const [k,v] of pairs){
    const wrap = document.createElement('div');
    wrap.className = 'kv';
    const left = document.createElement('div'); left.className='muted'; left.textContent = k;
    const right = document.createElement('div'); right.textContent = v ?? '';
    if (before && (before[k] !== String(v ?? ''))) {
      right.classList.add('changed');
    }
    wrap.append(left, right);
    d.appendChild(wrap);
  }

  // Small JSON views (collapsed to top level info)
  const jsonBlocks = [
    ['location_source', row.location_source],
    ['provider_source', row.provider_source],
    ['reports', row.reports],
    ['ratings', row.ratings],
    ['regulated_activities', row.regulated_activities],
    ['inspection_areas', row.inspection_areas],
    ['contacts', row.contacts]
  ];

  for (const [label, js] of jsonBlocks){
    const wrap = document.createElement('div');
    wrap.className = 'kv';
    const left = document.createElement('div'); left.className='muted'; left.textContent = label;
    const right = document.createElement('pre'); right.className='code';
    try { right.textContent = JSON.stringify(js, null, 2); } catch { right.textContent = String(js ?? ''); }
    wrap.append(left, right);
    d.appendChild(wrap);
  }
}

/** Enrichment: fetch CQC API â†’ RPC merge â†’ reload & diff */
async function enrichNow(currentRow){
  try{
    setStatus('enrichingâ€¦');
    log('Calling CQC APIâ€¦');

    // 1) location
    const locUrl = `https://api.service.cqc.org.uk/public/v1/locations/${encodeURIComponent(currentRow.location_id)}`;
    const locRes = await fetch(locUrl, {
      headers: {
        'Accept':'application/json',
        'Ocp-Apim-Subscription-Key': CQC_KEY
      }
    });
    if (!locRes.ok) {
      const txt = await locRes.text();
      log(`Location fetch failed ${locRes.status}: ${txt}`);
      setStatus('error'); return;
    }
    const location = await locRes.json();

    // 2) provider (optional but nice)
    let provider = null;
    const providerId = location?.providerId || currentRow.provider_id;
    if (providerId){
      const provUrl = `https://api.service.cqc.org.uk/public/v1/providers/${encodeURIComponent(providerId)}`;
      const provRes = await fetch(provUrl, {
        headers: {
          'Accept':'application/json',
          'Ocp-Apim-Subscription-Key': CQC_KEY
        }
      });
      if (provRes.ok) provider = await provRes.json();
      else log(`Provider fetch failed ${provRes.status} (continuing)`);
    }

    // 3) reports metadata (optional quick pass from location.reports)
    let reports = Array.isArray(location?.reports) ? location.reports : [];

    // Snapshot "before" for change highlighting
    const beforeMap = {
      'Location ID': currentRow.location_id,
      'Name': currentRow.location_name ?? '',
      'Postcode': currentRow.postcode ?? '',
      'Town/City': currentRow.town_city ?? '',
      'County': currentRow.county ?? '',
      'Region': currentRow.region ?? '',
      'Provider ID': currentRow.provider_id ?? '',
      'Overall rating': currentRow.overall_rating ?? '',
      'Last inspection': currentRow.last_inspection_date ?? '',
      'Reg. status': currentRow.registration_status ?? '',
      'Reg. date': currentRow.registration_date ?? '',
      'De-reg. date': currentRow.deregistration_date ?? '',
      'Latitude': currentRow.latitude ?? '',
      'Longitude': currentRow.longitude ?? ''
    };

    log('Merging into Supabase via RPCâ€¦');

    // 4) Merge into the row using SECURITY DEFINER RPC
    const { data: rpcData, error: rpcErr } = await sb
      .rpc('cqc_merge_location_json', {
        _location_id: currentRow.location_id,
        _location: location,
        _provider: provider,
        _reports: reports
      });

    if (rpcErr) { log('Merge error: '+rpcErr.message); setStatus('error'); return; }

    // 5) Reload the row and show diffs
    const { data: fresh, error: reloadErr } = await sb.from(TABLE).select('*')
      .eq('location_id', currentRow.location_id).maybeSingle();

    if (reloadErr || !fresh){ log('Reload error: '+(reloadErr?.message || 'not found')); setStatus('error'); return; }

    renderDetails(fresh, beforeMap);
    el('diffNote').style.display = 'block';
    setStatus('ready');
    log('Done âœ…');
  }catch(e){
    log('Unexpected error: '+e.message);
    setStatus('error');
  }
}

/** Minor extras */
el('btnClear').onclick = () => {
  el('q').value = '';
  el('list').innerHTML = '';
  el('detail').innerHTML = '';
  el('btnEnrich').disabled = true;
  el('diffNote').style.display = 'none';
  el('log').textContent = '';
  setStatus('idle');
};

// Auto-focus search
el('q').focus();
</script>
</body>
</html>
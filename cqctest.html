<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CQC Syndication ‚Äì GP Practice Explorer (demo)</title>
  <style>
    :root {
      --bg: #0b0f14; --panel:#111824; --muted:#8aa0b7; --text:#e6edf3; --accent:#5fb3ff; --ok:#24c27a; --warn:#ffb454;
      --radius: 14px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; backdrop-filter:saturate(1.2) blur(8px); background:linear-gradient(180deg, rgba(17,24,36,.9), rgba(17,24,36,.6)); border-bottom:1px solid #1f2a3a; z-index:5}
    .wrap{max-width:1050px; margin:0 auto; padding:18px}
    h1{margin:0 0 10px; font-size:20px}
    .search{display:grid; grid-template-columns: 1fr auto auto; gap:10px; align-items:center}
    input, select, button{height:44px; border-radius:var(--radius); border:1px solid #263449; background:#0f1622; color:var(--text); padding:0 14px; font-size:15px}
    button{cursor:pointer; border-color:#2a3a52}
    button.primary{background:linear-gradient(180deg, #1976d2, #0e5aa7); border:0}
    small{color:var(--muted)}
    main{padding:22px 18px 60px}
    .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(320px,1fr)); gap:14px}
    .card{background:var(--panel); border:1px solid #1c2737; border-radius:var(--radius); padding:14px}
    .card h3{margin:0 0 6px; font-size:16px}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#0f1a28; border:1px solid #213047; font-size:12px; color:var(--muted)}
    details{background:#0e1622; border:1px solid #1b283a; border-radius:10px; padding:10px; margin-top:10px}
    details>summary{cursor:pointer; color:#bbd9ff}
    pre{white-space:pre-wrap; overflow:auto; max-height:360px; margin:10px 0 0}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .footer{margin-top:26px; text-align:center; color:var(--muted)}
    .inline{display:inline-flex; gap:8px; align-items:center}
    .hidden{display:none}
    /* --- Debug panel styles --- */
    .debug-panel{background:#0c131f; border-top:1px solid #1c2737; padding:12px 0 0; margin-top:14px}
    .debug-head{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:0 18px 8px}
    .debug-head .left{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .debug-head .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .debug-btn{height:32px; padding:0 10px; border-radius:10px; border:1px solid #2a3a52; background:#111a29; color:var(--text); cursor:pointer}
    .debug-toggle{display:inline-flex; gap:6px; align-items:center; color:var(--muted); font-size:13px}
    #debugOut{white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0a0f18; border-top:1px solid #1b283a; margin:0; padding:12px 18px; max-height:360px; overflow:auto}
    .debug-meta{color:#9bb1c9; font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ü©∫ CQC Syndication ‚Äì GP Practice Explorer (demo)</h1>
      <form id="searchForm" class="search">
        <input id="q" placeholder="Search GP practice (name, partial name, or postcode)‚Ä¶" autocomplete="on" />
        <select id="perPage" title="Results per page">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
        </select>
        <button class="primary" type="submit">Search</button>
      </form>
      <div class="row" style="margin-top:8px">
        <label class="inline"><input type="checkbox" id="gpOnly" /> GP services only (filter results client‚Äëside)</label>
        <label class="inline">Proxy:
          <select id="proxyChoice" style="height:30px">
            <option value="none" selected>None (direct)</option>
            <option value="allorigins">allorigins.win</option>
            <option value="isogit">isomorphic-git proxy</option>
            <option value="thingproxy">thingproxy</option>
            <option value="custom">Custom‚Ä¶</option>
          </select>
        </label>
        <label class="inline">Custom proxy URL: <input id="customProxy" placeholder="https://your-proxy.example.com/" style="height:30px; width:320px" /></label>
        <button class="debug-btn" id="testEndpoint" type="button" title="Ping the API root">Test API</button>
        <label class="inline">Partner code: <input id="partnerCode" value="WalletWondersTest" style="height:30px" /></label>
      </div>
      <small>Data source: CQC Syndication API (public). This is a simple, unauthenticated demo for testing and play.</small>
      <div><small>Tip: If you see 403 Forbidden in the Debug log, switch Proxy above or run via a small server (WAF may block direct browser/proxy calls).</small></div>
    </div>
  </header>

  <section class="debug-panel" id="debugPanel">
    <div class="debug-head">
      <div class="left">
        <strong>Debug log</strong>
        <span class="debug-meta" id="envMeta"></span>
      </div>
      <div class="right">
        <label class="debug-toggle"><input type="checkbox" id="autoScroll" checked /> Autoscroll</label>
        <label class="debug-toggle"><input type="checkbox" id="includeBodies" checked /> Include response bodies</label>
        <button class="debug-btn" id="copyDebug">Copy all</button>
        <button class="debug-btn" id="clearDebug">Clear</button>
      </div>
    </div>
    <pre id="debugOut"></pre>
  </section>

  <main class="wrap">
    <div id="resultsMeta"></div>
    <div id="results" class="grid"></div>
    <p id="empty" class="footer hidden">No results. Try a broader term (e.g. part of the practice name) or untick ‚ÄúGP services only‚Äù.</p>

    <div class="footer">
      <p>
        Tip: Click a card‚Äôs ‚ÄúRaw JSON‚Äù to see everything the API returns. Use the provider & reports buttons to pull more data.
      </p>
    </div>
  </main>

  <script>
  const state = {
    baseUrl: 'https://api.cqc.org.uk/public/v1',
    proxy: 'none',
    logs: []
  };

  function qs(id){ return document.getElementById(id); }
  function h(el, html){ el.innerHTML = html; }
  function esc(s){ return (s==null?'' : String(s)).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

  function withProxy(url){
    const p = state.proxy;
    if(p === 'none') return url;
    if(p === 'allorigins') return `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    if(p === 'isogit') return `https://cors.isomorphic-git.org/${url}`;
    if(p === 'thingproxy') return `https://thingproxy.freeboard.io/fetch/${url}`;
    if(p === 'custom'){
      const base = (qs('customProxy').value || '').trim();
      // Accept either a base that already includes ?url= or behaves as a prefix
      if(!base){ return url; }
      if(base.includes('{url}')) return base.replace('{url}', encodeURIComponent(url));
      if(/\?$/.test(base)) return base + 'url=' + encodeURIComponent(url);
      if(/\/$/.test(base)) return base + url; // prefix mode
      return base + (base.includes('?') ? '&' : '?') + 'url=' + encodeURIComponent(url);
    }
    return url;
  }

  function now(){
    const d = new Date();
    return d.toISOString().replace('T',' ').replace('Z',' UTC');
  }
  function pushLog(obj){
    try { state.logs.push(obj); } catch(_) {}
    const includeBodies = qs('includeBodies')?.checked !== false;
    const out = qs('debugOut');
    const safe = (v)=>{
      if(v==null) return '';
      if(typeof v === 'string') return v;
      try{ return JSON.stringify(v, null, 2); } catch{ return String(v); }
    };
    const parts = [
      `[#${state.logs.length}] ${obj.time || now()} ‚Äî ${obj.event || 'event'}`,
      obj.url ? `URL: ${obj.url}` : '',
      obj.meta ? `META: ${safe(obj.meta)}` : '',
      obj.request ? `REQUEST: ${safe(obj.request)}` : '',
      obj.status!=null ? `STATUS: ${obj.status}` : '',
      obj.headers ? `HEADERS: ${safe(obj.headers)}` : '',
      obj.durationMs!=null ? `DURATION_MS: ${obj.durationMs}` : '',
      obj.error ? `ERROR: ${safe(obj.error)}` : '',
      includeBodies && obj.body ? `BODY: ${typeof obj.body==='string'?obj.body:safe(obj.body)}` : ''
    ].filter(Boolean).join('\n');
    out.textContent += (out.textContent ? '\n\n' : '') + parts;
    if(qs('autoScroll')?.checked){ out.scrollTop = out.scrollHeight; }
  }
  function copyLogs(){
    const payload = state.logs.map(l=>{
      const copy = { ...l };
      if(!qs('includeBodies')?.checked){ delete copy.body; }
      return copy;
    });
    const text = JSON.stringify(payload, null, 2);
    if(navigator.clipboard?.writeText){
      navigator.clipboard.writeText(text).then(()=>{ alert('Debug log copied to clipboard.'); });
    } else {
      // Fallback
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      alert('Debug log copied (fallback).');
    }
  }
  function clearLogs(){ state.logs = []; qs('debugOut').textContent=''; }

  function buildUrl(path, params){
    const url = new URL(state.baseUrl + path);
    Object.entries(params||{}).forEach(([k,v])=>{ if(v!==undefined && v!==null && v!==''){
      if(Array.isArray(v)) v.forEach(x=>url.searchParams.append(k,x)); else url.searchParams.set(k,v);
    }});
    const pc = qs('partnerCode').value.trim();
    if(pc) url.searchParams.set('partnerCode', pc);
    pushLog({ event:'buildUrl', url: url.toString(), meta:{ path, params, proxy: state.proxy } });
    return url.toString();
  }

  async function fetchJson(url){
    const proxied = withProxy(url);
    const started = performance.now();
    pushLog({ event:'fetch:start', url: proxied, request:{ method:'GET' }, meta:{ baseUrl: state.baseUrl, partnerCode: qs('partnerCode').value.trim(), proxy: state.proxy } });
    let res, text;
    try{
      res = await fetch(proxied, { method:'GET' });
      const durationMs = Math.round(performance.now()-started);
      const headers = {}; res.headers && res.headers.forEach && res.headers.forEach((v,k)=>{ headers[k]=v; });
      text = await res.text();
      let bodyToShow = text && text.length>5000 ? text.slice(0,5000)+`\n‚Ä¶[truncated ${text.length-5000} chars]` : text;
      pushLog({ event:'fetch:response', url: proxied, status: res.status, headers, durationMs, body: bodyToShow });
      if(!res.ok){
        const hint = res.status === 403 ? 'Hint: 403 from CQC often means their gateway blocked the request (Origin/UA/WAF). Try a different proxy or run via a server.' : '';
        throw new Error(`HTTP ${res.status} ${res.statusText}${hint ? ' ‚Äî '+hint : ''}`);
      }
      try{ return text ? JSON.parse(text) : {}; }
      catch(parseErr){
        pushLog({ event:'fetch:json-parse-error', url: proxied, error: String(parseErr), body: text });
        throw new Error('Failed to parse JSON: '+ parseErr.message);
      }
    } catch(err){
      const durationMs = Math.round(performance.now()-started);
      pushLog({ event:'fetch:error', url: proxied, durationMs, error: String(err), body: text });
      throw err;
    }
  }

  function isLikelyGP(location){
    // Heuristic: look at service types / inspection directorate / name
    const svc = (location.gacServiceTypes || location.serviceTypes || []).join(' | ').toLowerCase();
    const dir = (location.inspectionDirectorate || '').toLowerCase();
    const nm = (location.locationName || location.name || '').toLowerCase();
    return dir.includes('primary medical') || svc.includes('gp') || nm.includes('gp') || nm.includes('medical centre') || nm.includes('surgery');
  }

  function card(location){
    const id = location.locationId || location.id;
    const name = location.locationName || location.name || 'Unknown name';
    const addr = [location.postcode, location.addressLine1, location.addressLine2, location.townCity].filter(Boolean).join(', ');
    const rating = location.ratings && (location.ratings.overallRating || location.ratings.rating) || location.currentRatings && location.currentRatings.overall || location.overallRating;
    const providerId = location.providerId || (location.relationships && (location.relationships.providerId || (location.relationships.provider && location.relationships.provider.id)));

    return `
      <div class="card" id="loc-${esc(id)}">
        <h3>${esc(name)}</h3>
        <div class="row" style="gap:8px; align-items:center">
          ${rating ? `<span class="pill">Rating: <strong style="margin-left:6px">${esc(rating)}</strong></span>` : ''}
          ${location.onspdCcgName ? `<span class="pill">CCG: ${esc(location.onspdCcgName)}</span>` : ''}
          ${location.postcode ? `<span class="pill">${esc(location.postcode)}</span>` : ''}
          ${location.inspectionDirectorate ? `<span class="pill">${esc(location.inspectionDirectorate)}</span>` : ''}
          ${location.registrationStatus ? `<span class="pill">${esc(location.registrationStatus)}</span>` : ''}
        </div>
        <p style="margin:8px 0 6px; color:var(--muted)">${esc(addr)}</p>
        <div class="row">
          ${id ? `<a class="pill" href="https://www.cqc.org.uk/location/${encodeURIComponent(id)}" target="_blank" rel="noopener">View on cqc.org.uk</a>` : ''}
          ${id ? `<button data-action="details" data-id="${esc(id)}">Location details</button>` : ''}
          ${providerId ? `<button data-action="provider" data-provider-id="${esc(providerId)}">Provider</button>` : ''}
          ${id ? `<button data-action="reports" data-id="${esc(id)}">Reports</button>` : ''}
          <button data-action="raw" data-json='${esc(JSON.stringify(location))}'>Raw JSON</button>
        </div>
        <div class="more"></div>
      </div>`;
  }

  async function search(e){
    e && e.preventDefault();
    const q = qs('q').value.trim();
    const perPage = qs('perPage').value;
    pushLog({ event:'search:submit', meta:{ query:q, perPage, gpOnly: qs('gpOnly').checked } });
    if(!q){ alert('Enter part of a GP practice name or a postcode.'); return; }

    h(qs('resultsMeta'), `<small>Searching locations for ‚Äú${esc(q)}‚Äù‚Ä¶</small>`);
    h(qs('results'), '');

    try{
      // Use Locations endpoint ‚Äì name search (broad). Fall back to postcode query if looks like one.
      const params = { page: 1, perPage };
      // Heuristic filters for quick GP lookups
      // If query looks like a postcode, filter by postcode prefix
      if(/^[A-Z]{1,2}\d[\dA-Z]? ?\d[A-Z]{2}$/i.test(q)) params.postalCode = q.toUpperCase();
      // If user typed gp or doctor, prefer Primary medical services / GP categories
      if(/\bgp\b|doctor|surgery/i.test(q)){
        params.inspectionDirectorate = 'Primary medical services';
        // narrowing further increases chance of results while testing
      }

      const url = buildUrl('/locations', params);
      const data = await fetchJson(url);
      pushLog({ event:'search:results', url, meta:{ totalClient: Array.isArray(data)?data.length:(data && (data.locations?.length||data.items?.length||data.data?.length||data.results?.length||0)) }, body:data });

      // Data can be either { locations:[...] } or { data:[...] } or raw array ‚Äì handle generously
      const list = (data && (data.locations || data.items || data.data || data.results || (Array.isArray(data) ? data : []))) || [];

      const gpOnly = qs('gpOnly').checked;
      const filtered = gpOnly ? list.filter(isLikelyGP) : list;

      h(qs('resultsMeta'), `<small>Found ${filtered.length} of ${list.length} matching locations on page 1. (${esc(url)})</small>`);

      if(filtered.length === 0){
        qs('empty').classList.remove('hidden');
        return;
      } else {
        qs('empty').classList.add('hidden');
      }

      h(qs('results'), filtered.map(card).join(''));
    } catch(err){
      h(qs('resultsMeta'), `<small style="color:#ff8a80">${esc(err.message)}</small>`);
    }
  }

  async function onCardClick(e){
    const btn = e.target.closest('button');
    if(!btn) return;
    const action = btn.dataset.action;
    pushLog({ event:'ui:cardClick', meta:{ action, id: btn.dataset.id||null, providerId: btn.dataset.providerId||null } });
    const host = btn.closest('.card');
    const more = host.querySelector('.more');

    if(action === 'raw'){
      const json = JSON.parse(btn.dataset.json);
      more.innerHTML = `<details open><summary>Raw JSON</summary><pre>${esc(JSON.stringify(json, null, 2))}</pre></details>`;
      return;
    }

    if(action === 'details'){
      const id = btn.dataset.id;
      try{
        const url = buildUrl(`/locations/${encodeURIComponent(id)}`, {});
        const data = await fetchJson(url);
        more.innerHTML = `<details open><summary>Location details (${esc(id)})</summary><pre>${esc(JSON.stringify(data, null, 2))}</pre></details>`;
      } catch(err){
        more.innerHTML = `<small style="color:#ff8a80">${esc(err.message)}</small>`;
      }
      return;
    }

    if(action === 'provider'){
      const providerId = btn.dataset.providerId;
      if(!providerId){ more.innerHTML = `<small>No providerId on this location.</small>`; return; }
      try{
        const url = buildUrl(`/providers/${encodeURIComponent(providerId)}`, {});
        const data = await fetchJson(url);
        more.innerHTML = `<details open><summary>Provider ${esc(providerId)}</summary><pre>${esc(JSON.stringify(data, null, 2))}</pre></details>`;
      } catch(err){
        more.innerHTML = `<small style="color:#ff8a80">${esc(err.message)}</small>`;
      }
      return;
    }

    if(action === 'reports'){
      const id = btn.dataset.id;
      try{
        // The reports API typically needs a reportId (UUID), but some installations expose a list from the location details.
        // Here we try a helpful guess: /locations/{id} then show any report links if present.
        const url = buildUrl(`/locations/${encodeURIComponent(id)}`, {});
        const data = await fetchJson(url);
        const reportLinks = [];
        // Look in common places for links/IDs
        if(data && data.reports && Array.isArray(data.reports)){
          data.reports.forEach(r=>{
            if(r.reportId) reportLinks.push(r.reportId);
            if(r.links && r.links.pdf) reportLinks.push(r.links.pdf);
          });
        }
        const body = reportLinks.length
          ? `<ul>${reportLinks.map(x=>`<li><a href="${typeof x==='string' && x.startsWith('http') ? x : ('https://api.cqc.org.uk/public/v1/reports/' + x)}" target="_blank" rel="noopener">${esc(x)}</a></li>`).join('')}</ul>`
          : `<em>No report links found on the location details response. Check the Raw JSON or the CQC website page.</em>`;
        more.innerHTML = `<details open><summary>Reports for location ${esc(id)}</summary>${body}</details>`;
      } catch(err){
        more.innerHTML = `<small style="color:#ff8a80">${esc(err.message)}</small>`;
      }
      return;
    }
  }

  qs('searchForm').addEventListener('submit', search);
  qs('results').addEventListener('click', onCardClick);

  // Convenience: prefill query from URL ?q=
  const urlQ = new URL(location.href).searchParams.get('q');
  if(urlQ){ qs('q').value = urlQ; search(); }

  // Set environment meta
  (function(){
    const ua = navigator.userAgent;
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const meta = `UA: ${ua} | TZ: ${tz}`;
    const el = qs('envMeta'); if(el) el.textContent = meta;
    pushLog({ event:'env:init', meta:{ ua, tz, location: location.href } });
  })();

  // Wire debug buttons
  qs('copyDebug').addEventListener('click', copyLogs);
  qs('clearDebug').addEventListener('click', clearLogs);

  // Proxy selector
  qs('proxyChoice').addEventListener('change', (e)=>{ state.proxy = e.target.value; pushLog({ event:'proxy:change', meta:{ value: state.proxy } }); });
  state.proxy = qs('proxyChoice').value;
  qs('customProxy').addEventListener('change', ()=>{
    pushLog({ event:'proxy:customChanged', meta:{ value: qs('customProxy').value } });
  });

  // Test API root
  qs('testEndpoint').addEventListener('click', async ()=>{
    const url = buildUrl('/locations', { page:1, perPage:1 });
    try{
      const data = await fetchJson(url);
      alert('OK: API reachable. See Debug log.');
    } catch(err){
      alert('Test failed: '+ err.message);
    }
  });
  </script>
</body>
</html>
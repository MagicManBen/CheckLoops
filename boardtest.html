<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#0a58ff">
<title>CheckLoops — Device Setup</title>
<meta name="color-scheme" content="light dark">
<style>
/* ================================
   iOS-like blue aesthetic (portrait)
   ================================ */
:root{
  --blue-0:#0a58ff; --blue-1:#0b5dff; --blue-2:#0d4ed8; --indigo:#3b82f6;
  --ink:#f7faff; --ink-2:#dbe8ff; --muted:#c7d7ff;
  --glass: rgba(255,255,255,.10); --glass-2: rgba(255,255,255,.06);
  --stroke: rgba(255,255,255,.18); --shadow: 0 20px 40px rgba(3,12,50,.35);
  --ok:#34c759; --radius: 22px; --pill: 18px;
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  color:var(--ink);
  background:
    radial-gradient(900px 600px at 80% -10%, #70a1ff2b 0, transparent 60%),
    radial-gradient(1100px 700px at -10% 110%, #93c5ff26 0, transparent 60%),
    linear-gradient(180deg, #0b3cff, #0a2cff 20%, #071e6d 100%);
  overflow:hidden;
}
/* soft animated blobs */
.bg-blob{position:fixed; inset:-20vmax; pointer-events:none; filter:blur(50px) saturate(120%); opacity:.55}
.bg-blob::before, .bg-blob::after{
  content:""; position:absolute; width:55vmax; height:55vmax; border-radius:50%;
  background: radial-gradient(closest-side, #5ea1ff77, transparent 70%);
  animation: drift 22s ease-in-out infinite alternate;
}
.bg-blob::after{
  left:45vmax; top:20vmax;
  background: radial-gradient(closest-side, #8fb8ff66, transparent 70%);
  animation-duration: 26s;
}
@keyframes drift{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(6vmax,-4vmax,0) scale(1.06)}}

/* App shell */
.app{
  position:relative; width:min(430px, 100vw); height:100vh; margin:0 auto;
  display:flex; flex-direction:column; padding: env(safe-area-inset-top) 16px calc(18px + env(safe-area-inset-bottom));
}

/* Header */
.topbar{display:flex; align-items:center; justify-content:space-between; padding:18px 6px 10px}
.brand{display:flex; align-items:center; gap:10px}
.badge{padding:7px 12px; border-radius:999px; border:1px solid var(--stroke); color:var(--ink-2);
  background:linear-gradient(180deg, var(--glass), var(--glass-2));
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);}
.h1{font-weight:800; font-size:20px; letter-spacing:.01em; margin:0}

/* Pager dots (iOS style) */
.dots{display:flex; gap:8px; align-items:center; padding:6px 0 10px 6px}
.dot{width:7px; height:7px; border-radius:50%; background:#a9c7ff44; transition:all .25s ease}
.dot.active{width:18px; border-radius:10px; background:#e9f2ff}

/* Card (glass sheet) */
.sheet{
  position:relative; flex:1; border-radius:var(--radius);
  border:1px solid var(--stroke); background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
  box-shadow: var(--shadow); overflow:hidden; padding:12px;
  backdrop-filter: blur(22px) saturate(160%);
}

/* Screens */
.viewport{position:relative; width:100%; height:100%}
.screen{
  position:absolute; inset:0; padding:18px 14px 14px; display:flex; flex-direction:column; gap:14px;
  transform: translateX(6%) scale(.98); opacity:0; pointer-events:none;
  transition: transform .38s cubic-bezier(.22,.61,.36,1), opacity .28s ease;
}
.screen.active{transform: translateX(0) scale(1); opacity:1; pointer-events:auto}
.screen.exit-left{transform: translateX(-8%) scale(.98); opacity:0}

/* Hero icon */
.hero{
  width:84px; height:84px; border-radius:26px; display:grid; place-items:center;
  background:linear-gradient(180deg,#ffffff30,#ffffff14); border:1px solid var(--stroke); box-shadow:var(--shadow)
}
.hero svg{overflow:visible}
.hero path{fill:none; stroke:#fff; stroke-linecap:round; opacity:.95}
.hero .arc1,.hero .arc2,.hero .arc3{stroke-width:2.4}
.hero .dot{fill:#fff}
@keyframes arcPulse{0%{opacity:.25; transform:scale(.94)}50%{opacity:1; transform:scale(1)}100%{opacity:.25; transform:scale(.94)}}
.hero .arc1{animation: arcPulse 2.2s ease-in-out infinite .0s}
.hero .arc2{animation: arcPulse 2.2s ease-in-out infinite .2s}
.hero .arc3{animation: arcPulse 2.2s ease-in-out infinite .4s}

/* Text & chips */
.title{font-size:24px; font-weight:800; letter-spacing:.01em; margin:0}
.sub{color:var(--muted)}
.chip{
  display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:14px;
  background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
  border:1px solid var(--stroke); color:var(--ink-2); font-weight:600;
}

/* Buttons */
.row{display:flex; gap:10px; flex-wrap:wrap}
button,a.button{
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  padding:14px 18px; border:0; border-radius:16px; font-weight:800; letter-spacing:.01em;
  text-decoration:none; cursor:pointer; box-shadow:0 10px 20px rgba(10,88,255,.28); transform:translateZ(0);
  transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
}
button:active, a.button:active{transform:scale(.98)}
.primary{background: linear-gradient(180deg, #2e8bff, #0a58ff); color:#fff}
.ghost{background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); color:#fff; border:1px solid var(--stroke); box-shadow:none}

/* Success badge */
.success{
  display:inline-flex; align-items:center; gap:10px; padding:12px 14px; border-radius:16px;
  background: linear-gradient(180deg, rgba(52,199,89,.28), rgba(52,199,89,.16));
  border:1px solid rgba(52,199,89,.45); color:#eafff3; font-weight:800;
}

/* Safe-area padding for bottom CTAs */
.bottom-pad{height:calc(6px + env(safe-area-inset-bottom))}

/* Reduced motion */
@media (prefers-reduced-motion:reduce){
  .screen{transition:none}
  .hero .arc1,.hero .arc2,.hero .arc3{animation:none}
  button,a.button{transition:none}
}
</style>
</head>
<body>
<div class="bg-blob"></div>

<div class="app" id="app">
  <div class="topbar">
    <div class="brand"><div class="badge">CheckLoops</div></div>
    <div class="badge" id="phase">Start</div>
  </div>

  <div class="dots" aria-hidden="true">
    <div class="dot" data-k="1"></div>
    <div class="dot" data-k="2"></div>
    <div class="dot" data-k="3"></div>
    <div class="dot" data-k="4"></div>
  </div>

  <div class="sheet">
    <div class="viewport">
      <!-- STEP 1 -->
      <section class="screen active" data-step="1" id="s1" aria-labelledby="s1t">
        <div class="row" style="align-items:center">
          <div class="hero" aria-hidden="true">
            <svg width="54" height="54" viewBox="0 0 44 44">
              <path class="arc3" d="M5 16c6-6 28-6 34 0"/>
              <path class="arc2" d="M9 22c4-4 22-4 26 0"/>
              <path class="arc1" d="M14 28c3-3 13-3 16 0"/>
              <circle class="dot" cx="22" cy="33" r="2.4"/>
            </svg>
          </div>
          <div>
            <h2 class="title" id="s1t">Join the device Wi-Fi</h2>
            <div class="sub">Open Wi-Fi settings and connect to the device network.</div>
          </div>
        </div>

        <div class="row">
          <div class="chip"><strong>Network</strong> CheckLoops-Setup-<span style="opacity:.8">XXYY</span></div>
          <div class="chip"><strong>Password</strong> checkloops</div>
        </div>

        <div class="sub">iPhone may show a small “Sign-In” sheet — use it to continue.</div>

        <div style="margin-top:auto"></div>
        <div class="row">
          <button class="ghost" id="s1Help">Can’t find it</button>
          <button class="primary" id="s1Next">I’m on the device Wi-Fi</button>
        </div>
        <div id="s1HelpTxt" class="sub" style="display:none">Power-cycle the device, wait ~10s, then look for <b>CheckLoops-Setup-XXYY</b>.</div>
        <div class="bottom-pad"></div>
      </section>

      <!-- STEP 2 -->
      <section class="screen" data-step="2" id="s2" aria-labelledby="s2t">
        <div class="row" style="align-items:center">
          <div class="hero" aria-hidden="true">
            <svg width="54" height="54" viewBox="0 0 44 44">
              <path class="arc3" d="M5 16c6-6 28-6 34 0"/>
              <path class="arc2" d="M9 22c4-4 22-4 26 0"/>
              <path class="arc1" d="M14 28c3-3 13-3 16 0"/>
              <circle class="dot" cx="22" cy="33" r="2.4"/>
            </svg>
          </div>
          <div>
            <h2 class="title" id="s2t">Connect the device</h2>
            <div class="sub" id="s2Msg">We’ll open the device page to pick your home Wi-Fi.</div>
          </div>
        </div>

        <div class="row">
          <a class="button primary" id="openBtn" href="#">Open device setup (192.168.4.1)</a>
          <button class="ghost" id="s2Back">Back</button>
        </div>
        <div class="sub">On the device page: choose your Wi-Fi, enter the password, then tap <b>Save &amp; Connect</b>. You’ll return here automatically.</div>

        <div class="bottom-pad"></div>
      </section>

      <!-- STEP 3 -->
      <section class="screen" data-step="3" id="s3" aria-labelledby="s3t">
        <div class="success">
          <svg width="18" height="18" viewBox="0 0 20 20" aria-hidden="true">
            <path d="M7.5 12.6l-2.7-2.7a1 1 0 0 0-1.4 1.4l3.4 3.4a1 1 0 0 0 1.4 0l7-7a1 1 0 1 0-1.4-1.4l-6.3 6.3z" fill="#fff"/>
          </svg>
          Connected
        </div>
        <h2 class="title" id="s3t" style="margin:4px 0 0 0">You’re all set</h2>
        <div class="sub">Your device is online and ready.</div>

        <div id="macBox" class="chip" style="display:none"><strong>Device ID</strong> <span id="macVal"></span></div>

        <div style="margin-top:auto"></div>
        <div class="row">
          <a class="button primary" id="toPair" href="#">Pair Eyoyo scanner</a>
          <a class="button ghost" id="finishLink" href="https://checkloops.app/pair/success">Finish on CheckLoops</a>
        </div>
        <div class="sub">The device shows a ✓ on its LED matrix and its LED is solid when connected. Next, we’ll pair your Eyoyo scanner.</div>
        <div class="row" style="margin-top:6px">
          <button class="ghost" id="again">Set up another</button>
        </div>
      </section>

      <!-- STEP 4 -->
      <section class="screen" data-step="4" id="s4" aria-labelledby="s4t">
        <div class="row" style="align-items:center">
          <div class="hero" aria-hidden="true">
            <svg width="54" height="54" viewBox="0 0 44 44">
              <path class="arc3" d="M5 16c6-6 28-6 34 0"/>
              <path class="arc2" d="M9 22c4-4 22-4 26 0"/>
              <path class="arc1" d="M14 28c3-3 13-3 16 0"/>
              <circle class="dot" cx="22" cy="33" r="2.4"/>
            </svg>
          </div>
          <div>
            <h2 class="title" id="s4t">Pair your Eyoyo scanner</h2>
            <div class="sub">Make sure your phone is back on your home Wi‑Fi. We’ll open the device’s pairing page on your network.</div>
          </div>
        </div>

        <div class="row">
          <a class="button primary" id="openLocal" href="#">Open device pairing page</a>
          <button class="ghost" id="backToOnline">Back</button>
        </div>

        <label for="ip">Or enter device IP</label>
        <div class="row">
          <input id="ip" placeholder="e.g. 192.168.1.42">
          <button class="ghost" id="ipGo">Open</button>
        </div>

        <div class="sub" id="localHints" style="line-height:1.4">
          If the button above doesn’t work, try these local addresses:
          <div class="row" style="gap:8px; margin-top:8px">
            <a id="cand1" class="button ghost" href="#" style="box-shadow:none">checkloops‑xxxx.local</a>
            <a id="cand2" class="button ghost" href="#" style="box-shadow:none">checkloops.local</a>
          </div>
        </div>

        <div class="bottom-pad"></div>
      </section>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const screens = [...document.querySelectorAll('.screen')];
  const dots = [...document.querySelectorAll('.dot')];
  const state = { step: 1, mac: null };

  function setStep(n, animate = true){
    state.step = Math.max(1, Math.min(4, n));
    const active = screens.find(x=>x.classList.contains('active'));
    screens.forEach(x=>x.classList.remove('exit-left'));
    if(animate && active && +active.dataset.step !== state.step){ active.classList.add('exit-left'); }
    screens.forEach(x=>x.classList.toggle('active', +x.dataset.step === state.step));
    dots.forEach(d=>{ const k=+d.dataset.k; d.classList.toggle('active', k===state.step); });
    $('#phase').textContent = (state.step===1?'Start':state.step===2?'Connect':state.step===3?'Online':'Pair');
    try{ localStorage.setItem('cl_setup_step', String(state.step)); }catch(_){}
  }

  function baseURL(){ return location.origin + location.pathname; }

  function autoOpenDevice(){
    const ret = encodeURIComponent(baseURL());
    const url = `http://192.168.4.1/?return=${ret}`;
    $('#openBtn').href = url;
    if(location.protocol === 'http:'){
      const img = new Image(); let done = false;
      img.onload = ()=>{ if(done) return; done=true; location.href = url; };
      img.onerror= ()=>{ if(done) return; done=true; /* user taps */ };
      img.src = `http://192.168.4.1/favicon.ico?ts=${Date.now()}`;
      setTimeout(()=>{ if(!done){ done=true; } }, 1100);
    } else {
      setTimeout(()=>{ location.href = url; }, 160);
    }
  }

  function onReturn(){
    const u = new URL(location.href);
    const mac = u.searchParams.get('mac');
    const ok  = u.searchParams.get('ok');
    if(mac && ok==='1'){
      state.mac = mac;
      try{ localStorage.setItem('checkloops_device_mac', mac); }catch(_){}
      $('#macVal').textContent = mac; $('#macBox').style.display='inline-flex';
      const f = new URL($('#finishLink').href);
      f.searchParams.set('mac', mac); f.searchParams.set('ok', '1');
      $('#finishLink').href = f.toString();
      try{ setPairCandidates(); }catch(_){}
      history.replaceState({}, '', baseURL());
      setStep(3, false);
      // pop-in
      requestAnimationFrame(()=>{
        $('#macBox').animate([{transform:'scale(.96)', opacity:.7},{transform:'scale(1)', opacity:1}], {duration:220, easing:'cubic-bezier(.22,.61,.36,1)'});
      });
      return true;
    }
    return false;
  }

  function macSuffix(mac){
    if(!mac) return '';
    const parts = mac.split(':').map(s => s.trim());
    if(parts.length < 6) return '';
    return (parts[4] + parts[5]).toUpperCase();
  }
  function buildLocalCandidates(){
    const suffix = macSuffix(state.mac);
    const list = [];
    if(suffix) list.push(`http://checkloops-${suffix}.local/pair`);
    list.push(`http://checkloops.local/pair`);
    return list;
  }
  function setPairCandidates(){
    const cands = buildLocalCandidates();
    const [first, second] = [cands[0], cands[1] || cands[0]];
    const a = document.getElementById('openLocal');
    const c1 = document.getElementById('cand1');
    const c2 = document.getElementById('cand2');
    if(a) a.href = first;
    if(c1){
      c1.textContent = (first.replace(/^https?:\/\//,'').replace('/pair',''));
      c1.href = first;
    }
    if(c2){
      c2.textContent = (second.replace(/^https?:\/\//,'').replace('/pair',''));
      c2.href = second;
    }
  }

  // Init
  if(!onReturn()){
    try{ setStep(Math.min(parseInt(localStorage.getItem('cl_setup_step')||'1',10), 2), false); }catch(_){}
    try{
      const saved = localStorage.getItem('checkloops_device_mac');
      if(saved){
        $('#macVal').textContent = saved; $('#macBox').style.display='inline-flex';
        const f = new URL($('#finishLink').href); f.searchParams.set('mac', saved); $('#finishLink').href = f.toString();
      }
    }catch(_){}
  }

  // Hooks
  $('#s1Next').onclick = ()=>{ setStep(2); autoOpenDevice(); };
  $('#s1Help').onclick = ()=>{ const v=$('#s1HelpTxt'); v.style.display = (v.style.display==='none' || !v.style.display) ? 'block' : 'none'; };
  $('#s2Back').onclick = ()=> setStep(1);
  $('#openBtn').onclick = ()=>{}; // href does it
  $('#again').onclick = ()=>{ try{ localStorage.removeItem('cl_setup_step'); }catch(_){} location.href = baseURL(); };

  // Step 3 → Step 4
  const toPairBtn = document.getElementById('toPair');
  if(toPairBtn){
    toPairBtn.onclick = (e)=>{ e.preventDefault(); setPairCandidates(); setStep(4); };
  }
  const backToOnline = document.getElementById('backToOnline');
  if(backToOnline){
    backToOnline.onclick = ()=> setStep(3);
  }
  const openLocal = document.getElementById('openLocal');
  if(openLocal){
    openLocal.onclick = (e)=>{ /* allow default navigation to HTTP local address */ };
  }
  const ipGo = document.getElementById('ipGo');
  if(ipGo){
    ipGo.onclick = ()=>{
      const ip = (document.getElementById('ip').value||'').trim();
      if(ip) window.location.href = `http://${ip}/pair`;
    };
  }

  // If user was already on step 2 (back gesture), refresh link
  if((+document.querySelector('.screen.active')?.dataset.step||1)===2){ autoOpenDevice(); }
  if((+document.querySelector('.screen.active')?.dataset.step||1)===4){ setPairCandidates(); }
})();
</script>
</body>
</html>
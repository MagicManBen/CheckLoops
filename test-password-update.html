<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Test Password Update</title>
  <script src="config.js"></script>
</head>
<body>
  <h1>Testing Password Update Flow</h1>
  <div id="status"></div>
  <button id="testBtn">Test Password Update</button>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const projectRef = CONFIG.SUPABASE_URL.replace(/^https?:\/\//, '').split('.')[0];
    const storageKey = `sb-${projectRef}-auth-token`;

    const supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        flowType: 'pkce',
        storage: window.localStorage,
        storageKey
      }
    });

    const statusEl = document.getElementById('status');
    const testBtn = document.getElementById('testBtn');

    function log(message, color = 'black') {
      const div = document.createElement('div');
      div.style.color = color;
      div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      statusEl.appendChild(div);
      console.log(message);
    }

    // Parse URL parameters
    const url = new URL(window.location.href);
    const hashParams = new URLSearchParams(window.location.hash.replace(/^#/, ''));

    const inviteTokens = {
      accessToken: hashParams.get('access_token'),
      refreshToken: hashParams.get('refresh_token'),
      type: hashParams.get('type')
    };

    log('Checking URL for tokens...');
    if (inviteTokens.accessToken) {
      log('Found access token in URL', 'green');
      log(`Type: ${inviteTokens.type}`, 'blue');
    } else {
      log('No tokens in URL', 'orange');
    }

    async function checkSession() {
      log('Checking current session...');

      // First, check if we have tokens in the URL
      if (inviteTokens.accessToken && inviteTokens.refreshToken) {
        log('Setting session from URL tokens...', 'blue');

        const { data, error } = await supabase.auth.setSession({
          access_token: inviteTokens.accessToken,
          refresh_token: inviteTokens.refreshToken
        });

        if (error) {
          log(`Error setting session: ${error.message}`, 'red');
        } else {
          log('Session set successfully!', 'green');

          // Clear the URL
          try {
            history.replaceState({}, '', window.location.pathname);
          } catch (e) {
            console.warn('Could not clear URL');
          }
        }
      }

      // Get current user
      const { data: userData, error: userError } = await supabase.auth.getUser();

      if (userError) {
        log(`Error getting user: ${userError.message}`, 'red');
      } else if (userData.user) {
        log(`Current user: ${userData.user.email}`, 'green');
        log(`User ID: ${userData.user.id}`, 'blue');
        log(`Metadata: ${JSON.stringify(userData.user.user_metadata)}`, 'blue');
      } else {
        log('No user session found', 'orange');
      }

      // Check session
      const { data: sessionData, error: sessionError } = await supabase.auth.getSession();

      if (sessionError) {
        log(`Session error: ${sessionError.message}`, 'red');
      } else if (sessionData.session) {
        log('Session exists!', 'green');
      } else {
        log('No session found', 'orange');
      }
    }

    testBtn.addEventListener('click', async () => {
      log('Testing password update...');

      const newPassword = 'TestPassword123!';

      try {
        const { data, error } = await supabase.auth.updateUser({
          password: newPassword
        });

        if (error) {
          log(`Password update error: ${error.message}`, 'red');
          log(`Error details: ${JSON.stringify(error)}`, 'red');
        } else {
          log('Password updated successfully!', 'green');
          log(`Updated user: ${data.user?.email}`, 'blue');

          // Try refreshing session
          log('Refreshing session after password update...', 'blue');
          const { data: refreshData, error: refreshError } = await supabase.auth.refreshSession();

          if (refreshError) {
            log(`Refresh error: ${refreshError.message}`, 'orange');
          } else {
            log('Session refreshed successfully!', 'green');
          }

          // Test redirect
          log('Ready to redirect to staff-welcome.html', 'green');
          log(`Would redirect to: ${CONFIG.baseUrl}/staff-welcome.html`, 'blue');
        }
      } catch (err) {
        log(`Caught error: ${err.message}`, 'red');
      }
    });

    // Initial check
    checkSession();
  </script>
</body>
</html>
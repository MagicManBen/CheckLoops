<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edge Function Test - Classify Slot Types</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<style>
  body {
    font-family: system-ui, -apple-system, sans-serif;
    max-width: 900px;
    margin: 40px auto;
    padding: 0 20px;
    background: #f8fafc;
  }
  h1 { color: #1e293b; }
  .test-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  button {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    margin-right: 10px;
    margin-bottom: 10px;
  }
  button:hover { background: #2563eb; }
  button:disabled {
    background: #94a3b8;
    cursor: not-allowed;
  }
  .result {
    margin-top: 15px;
    padding: 15px;
    background: #f1f5f9;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .success { background: #dcfce7; border-left: 4px solid #22c55e; }
  .error { background: #fee2e2; border-left: 4px solid #ef4444; }
  .info { background: #dbeafe; border-left: 4px solid #3b82f6; }
  .status {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }
  .status.ok { background: #22c55e; color: white; }
  .status.fail { background: #ef4444; color: white; }
  .slot-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 8px;
    margin-top: 10px;
  }
  .slot-item {
    padding: 8px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 13px;
  }
  .category {
    font-weight: 600;
    color: #1e293b;
    margin-top: 15px;
    margin-bottom: 8px;
  }
  .category.day { color: #dc2626; }
  .category.week1 { color: #ea580c; }
  .category.week2 { color: #0891b2; }
</style>
</head>
<body>
  <h1>üß™ Edge Function Test: classify-slot-types</h1>
  
  <div class="test-section">
    <h2>Configuration</h2>
    <p><strong>Supabase URL:</strong> <span id="config-url">Loading...</span></p>
    <p><strong>Has Anon Key:</strong> <span id="config-key">Loading...</span></p>
    <p><strong>Supabase Client:</strong> <span id="config-client">Loading...</span></p>
  </div>

  <div class="test-section">
    <h2>Test 1: Simple Connectivity</h2>
    <p>Test if we can reach the Edge Function with a small sample.</p>
    <button id="test-connectivity">Run Connectivity Test</button>
    <div id="result-connectivity" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Sample Classification</h2>
    <p>Send 10 sample slot types and verify classification.</p>
    <button id="test-sample">Run Sample Classification</button>
    <div id="result-sample" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Load Real Data from Database</h2>
    <p>Query emis_apps_raw table and classify actual slot types.</p>
    <button id="test-real">Load & Classify Real Data</button>
    <button id="test-count">Count Slot Types in DB</button>
    <div id="result-real" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Error Handling</h2>
    <p>Test with invalid inputs to verify error handling.</p>
    <button id="test-empty">Send Empty Array</button>
    <button id="test-invalid">Send Invalid Data</button>
    <div id="result-error" class="result" style="display:none;"></div>
  </div>

  <script>
    let supabase;
    
    // Initialize Supabase
    window.addEventListener('load', async () => {
      try {
        if (!window.CONFIG) {
          throw new Error('CONFIG not loaded');
        }
        
        const { createClient } = supabase;
        supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        window.supabase = supabase;
        
        document.getElementById('config-url').textContent = CONFIG.SUPABASE_URL;
        document.getElementById('config-key').innerHTML = '<span class="status ok">YES</span>';
        document.getElementById('config-client').innerHTML = '<span class="status ok">READY</span>';
      } catch (err) {
        document.getElementById('config-url').textContent = 'Error loading config';
        document.getElementById('config-key').innerHTML = '<span class="status fail">NO</span>';
        document.getElementById('config-client').innerHTML = '<span class="status fail">ERROR</span>';
        console.error('Init error:', err);
      }
    });

    // Test 1: Connectivity
    document.getElementById('test-connectivity').addEventListener('click', async () => {
      const btn = document.getElementById('test-connectivity');
      const result = document.getElementById('result-connectivity');
      
      btn.disabled = true;
      result.style.display = 'block';
      result.className = 'result info';
      result.textContent = '‚è≥ Testing connectivity...';
      
      try {
        const testTypes = ['Urgent', 'Routine', 'Follow-up'];
        
        const startTime = Date.now();
        const { data, error } = await supabase.functions.invoke('classify-slot-types', {
          body: { slotTypes: testTypes }
        });
        const duration = Date.now() - startTime;
        
        if (error) {
          throw new Error(error.message || JSON.stringify(error));
        }
        
        result.className = 'result success';
        result.textContent = `‚úÖ SUCCESS (${duration}ms)\n\n` + JSON.stringify(data, null, 2);
      } catch (err) {
        result.className = 'result error';
        result.textContent = `‚ùå ERROR\n\n${err.message}\n\n${err.stack || ''}`;
      } finally {
        btn.disabled = false;
      }
    });

    // Test 2: Sample Classification
    document.getElementById('test-sample').addEventListener('click', async () => {
      const btn = document.getElementById('test-sample');
      const result = document.getElementById('result-sample');
      
      btn.disabled = true;
      result.style.display = 'block';
      result.className = 'result info';
      result.textContent = '‚è≥ Classifying sample slot types...';
      
      try {
        const sampleTypes = [
          'Urgent on day',
          'Emergency appointment',
          'Same day appointment',
          'Routine appointment',
          'GP appointment',
          'Follow-up 1 week',
          'Follow-up 2 weeks',
          'Review in 10 days',
          'Nurse appointment',
          'Telephone consultation'
        ];
        
        const startTime = Date.now();
        const { data, error } = await supabase.functions.invoke('classify-slot-types', {
          body: { slotTypes: sampleTypes }
        });
        const duration = Date.now() - startTime;
        
        if (error) {
          throw new Error(error.message || JSON.stringify(error));
        }
        
        const classification = data.classification || data;
        const total = (classification.on_the_day?.length || 0) + 
                     (classification.within_1_week?.length || 0) + 
                     (classification.within_2_weeks?.length || 0);
        
        let output = `‚úÖ SUCCESS (${duration}ms)\n`;
        output += `üìä Classified ${total}/${sampleTypes.length} slot types\n\n`;
        
        if (classification.on_the_day?.length > 0) {
          output += `üìç On the Day (${classification.on_the_day.length}):\n`;
          classification.on_the_day.forEach(s => output += `  ‚Ä¢ ${s}\n`);
          output += '\n';
        }
        
        if (classification.within_1_week?.length > 0) {
          output += `üìÖ Within 1 Week (${classification.within_1_week.length}):\n`;
          classification.within_1_week.forEach(s => output += `  ‚Ä¢ ${s}\n`);
          output += '\n';
        }
        
        if (classification.within_2_weeks?.length > 0) {
          output += `üìÜ Within 2 Weeks (${classification.within_2_weeks.length}):\n`;
          classification.within_2_weeks.forEach(s => output += `  ‚Ä¢ ${s}\n`);
        }
        
        result.className = 'result success';
        result.textContent = output;
      } catch (err) {
        result.className = 'result error';
        result.textContent = `‚ùå ERROR\n\n${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });

    // Test 3: Real data
    document.getElementById('test-real').addEventListener('click', async () => {
      const btn = document.getElementById('test-real');
      const result = document.getElementById('result-real');
      
      btn.disabled = true;
      result.style.display = 'block';
      result.className = 'result info';
      result.textContent = '‚è≥ Loading slot types from database...';
      
      try {
        // Load unique slot types from database
        const PAGE_SIZE = 1000;
        let offset = 0;
        const seen = new Set();
        
        while (true) {
          const { data, error } = await supabase
            .from('emis_apps_raw')
            .select('slot_type')
            .not('slot_type', 'is', null)
            .order('slot_type', { ascending: true })
            .range(offset, offset + PAGE_SIZE - 1);
          
          if (error) throw error;
          if (!data || !data.length) break;
          
          data.forEach(r => {
            const type = String(r.slot_type || '').trim();
            if (type) seen.add(type);
          });
          
          result.textContent = `‚è≥ Loaded ${seen.size} unique slot types...`;
          
          if (data.length < PAGE_SIZE) break;
          offset += PAGE_SIZE;
        }
        
        const slotTypes = Array.from(seen).sort();
        result.textContent = `‚è≥ Classifying ${slotTypes.length} slot types...`;
        
        const startTime = Date.now();
        const { data: classifyData, error: classifyError } = await supabase.functions.invoke('classify-slot-types', {
          body: { slotTypes }
        });
        const duration = Date.now() - startTime;
        
        if (classifyError) {
          throw new Error(classifyError.message || JSON.stringify(classifyError));
        }
        
        const classification = classifyData.classification || classifyData;
        const total = (classification.on_the_day?.length || 0) + 
                     (classification.within_1_week?.length || 0) + 
                     (classification.within_2_weeks?.length || 0);
        
        let output = `‚úÖ SUCCESS (${duration}ms)\n`;
        output += `üìä Loaded ${slotTypes.length} unique slot types\n`;
        output += `üìä Classified ${total} slot types\n\n`;
        
        if (classification.on_the_day?.length > 0) {
          output += `üìç On the Day (${classification.on_the_day.length}):\n`;
          classification.on_the_day.slice(0, 10).forEach(s => output += `  ‚Ä¢ ${s}\n`);
          if (classification.on_the_day.length > 10) {
            output += `  ... and ${classification.on_the_day.length - 10} more\n`;
          }
          output += '\n';
        }
        
        if (classification.within_1_week?.length > 0) {
          output += `üìÖ Within 1 Week (${classification.within_1_week.length}):\n`;
          classification.within_1_week.slice(0, 10).forEach(s => output += `  ‚Ä¢ ${s}\n`);
          if (classification.within_1_week.length > 10) {
            output += `  ... and ${classification.within_1_week.length - 10} more\n`;
          }
          output += '\n';
        }
        
        if (classification.within_2_weeks?.length > 0) {
          output += `üìÜ Within 2 Weeks (${classification.within_2_weeks.length}):\n`;
          classification.within_2_weeks.slice(0, 10).forEach(s => output += `  ‚Ä¢ ${s}\n`);
          if (classification.within_2_weeks.length > 10) {
            output += `  ... and ${classification.within_2_weeks.length - 10} more\n`;
          }
        }
        
        result.className = 'result success';
        result.textContent = output;
      } catch (err) {
        result.className = 'result error';
        result.textContent = `‚ùå ERROR\n\n${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });

    // Test count
    document.getElementById('test-count').addEventListener('click', async () => {
      const btn = document.getElementById('test-count');
      const result = document.getElementById('result-real');
      
      btn.disabled = true;
      result.style.display = 'block';
      result.className = 'result info';
      result.textContent = '‚è≥ Counting slot types...';
      
      try {
        const { count, error } = await supabase
          .from('emis_apps_raw')
          .select('slot_type', { count: 'exact', head: true })
          .not('slot_type', 'is', null);
        
        if (error) throw error;
        
        result.className = 'result success';
        result.textContent = `‚úÖ Found ${count} records with slot_type in database`;
      } catch (err) {
        result.className = 'result error';
        result.textContent = `‚ùå ERROR\n\n${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });

    // Test 4: Error handling
    document.getElementById('test-empty').addEventListener('click', async () => {
      const btn = document.getElementById('test-empty');
      const result = document.getElementById('result-error');
      
      btn.disabled = true;
      result.style.display = 'block';
      result.className = 'result info';
      result.textContent = '‚è≥ Testing with empty array...';
      
      try {
        const { data, error } = await supabase.functions.invoke('classify-slot-types', {
          body: { slotTypes: [] }
        });
        
        result.className = 'result success';
        result.textContent = `‚úÖ Response received\n\n${JSON.stringify(data || error, null, 2)}`;
      } catch (err) {
        result.className = 'result error';
        result.textContent = `‚ùå ERROR\n\n${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('test-invalid').addEventListener('click', async () => {
      const btn = document.getElementById('test-invalid');
      const result = document.getElementById('result-error');
      
      btn.disabled = true;
      result.style.display = 'block';
      result.className = 'result info';
      result.textContent = '‚è≥ Testing with invalid data...';
      
      try {
        const { data, error } = await supabase.functions.invoke('classify-slot-types', {
          body: { invalid: 'data' }
        });
        
        result.className = 'result success';
        result.textContent = `‚úÖ Response received\n\n${JSON.stringify(data || error, null, 2)}`;
      } catch (err) {
        result.className = 'result error';
        result.textContent = `‚ùå ERROR\n\n${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>

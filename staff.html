<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — Staff</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://img.icons8.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <link rel="stylesheet" href="staff.css">
  <link rel="stylesheet" href="welcome-tour.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="fix-navigation-style.js"></script>
  <style>
    /* Page-specific tweaks only; core styles live in staff.css */
    .subtitle{ color:#64748b; font-weight:600; }
    .staff-avatar{ width:64px; height:64px; border-radius:50%; background:#fff; background-size:cover; background-position:center; box-shadow:0 4px 10px rgba(2,6,23,.10); border:1px solid var(--border-color); }
    .staff-hero-avatar{ width:96px; height:96px; border-radius:50%; background:#fff; background-size:cover; background-position:center; box-shadow:0 6px 16px rgba(2,6,23,.12); border:1px solid var(--border-color); }

    /* Recent Activity Card Styles */
    .activity-card {
      background: #ffffff !important;
      border-radius: 14px;
      padding: 16px;
      margin: 12px 0;
      box-shadow: 0 6px 18px rgba(2,6,23,0.15);
      border: 1px solid rgba(2,6,23,0.06);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      animation: slideInUp 0.4s ease-out;
      position: relative;
      overflow: hidden;
    }

    .activity-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(135deg, var(--card-color-start), var(--card-color-end));
    }

    .activity-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(2,6,23,0.20);
      background: #ffffff !important;
    }

    .activity-card.new-member { border-color: rgba(251, 113, 133, 0.35); background: #fff !important; }
    .activity-card.holiday-request { border-color: rgba(34, 211, 238, 0.35); background: #fff !important; }
    .activity-card.profile-update { border-color: rgba(139, 92, 246, 0.35); background: #fff !important; }

    .activity-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .activity-icon-badge {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      position: absolute;
      right: -2px;
      bottom: -2px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes popIn {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      80% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -200% center;
      }
      100% {
        background-position: 200% center;
      }
    }

    .activity-new-badge {
      display: inline-block;
      padding: 2px 8px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      font-size: 10px;
      font-weight: bold;
      border-radius: 12px;
      margin-left: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .activity-celebration {
      animation: celebrate 0.5s ease;
    }

    @keyframes celebrate {
      0%, 100% {
        transform: rotate(0deg);
      }
      25% {
        transform: rotate(-5deg);
      }
      75% {
        transform: rotate(5deg);
      }
    }

    /* Custom scrollbar for timeline */
    .timeline::-webkit-scrollbar {
      width: 6px;
    }

    .timeline::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .timeline::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 3px;
    }

    .timeline::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #764ba2, #667eea);
    }

    /* Activity hover effects */
    .activity-card::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      transform: translate(-50%, -50%) scale(0);
      transition: transform 0.5s ease;
      pointer-events: none;
    }

    .activity-card:hover::after {
      transform: translate(-50%, -50%) scale(1.5);
    }

    /* Sparkle animation for new activities */
    @keyframes sparkle {
      0%, 100% {
        opacity: 0;
        transform: scale(0) rotate(0deg);
      }
      50% {
        opacity: 1;
        transform: scale(1) rotate(180deg);
      }
    }

    .sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: radial-gradient(circle, #fbbf24 0%, transparent 70%);
      border-radius: 50%;
      animation: sparkle 1.5s ease-in-out infinite;
    }
    
    /* Quiz Alert Styles */
    .quiz-alert {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      border: 2px solid #fbbf24;
      animation: slideInDown 0.6s ease-out, pulseGlow 2s infinite;
    }
    
    .quiz-alert-content {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
    }
    
    .quiz-alert-icon {
      width: 40px;
      height: 40px;
      animation: bounce 2s infinite;
    }
    .quiz-alert-icon img { width: 100%; height: 100%; display:block; }
    
    .quiz-alert-text {
      flex: 1;
    }
    
    .quiz-alert-title {
      font-weight: 800;
      font-size: 1.2em;
      margin-bottom: 4px;
    }
    
    .quiz-alert-subtitle {
      font-size: 0.9em;
      opacity: 0.9;
    }
    
    .quiz-alert-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .quiz-alert-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }    /* Quiz Bubble Animation */
    .quiz-bubble {
      position: relative;
    }
    
    .quiz-bubble.due {
      animation: pulse 2s infinite;
    }
    
    .quiz-bubble.due::after {
      content: '!';
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ef4444;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 12px;
      animation: bounce 1.5s infinite;
    }
    
    /* Animations */
    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulseGlow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
      }
      50% {
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
      }
    }
    
    /* Disabled holiday button styles */
    .disabled-bubble {
      position: relative;
      transition: all 0.3s ease !important;
    }
    
    .disabled-bubble:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .disabled-bubble[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      max-width: 250px;
      white-space: normal;
      text-align: center;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: fadeIn 0.2s ease;
      pointer-events: none;
    }
    
    .disabled-bubble[title]:hover::before {
      content: '';
      position: absolute;
      bottom: 92%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      z-index: 1001;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(5px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }
    
    /* Personal Dashboard Styles */
    .personal-dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      padding: 0 8px;
    }
    
    .dashboard-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
      transition: all 0.3s ease;
      animation: fadeInScale 0.5s ease-out;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    
    .dashboard-card:hover {
      transform: translateY(-2px);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background: linear-gradient(to bottom, var(--card-accent-top), var(--card-accent-bottom));
      opacity: 0.8;
    }
    
    #training-card {
      --card-accent-top: #60a5fa;
      --card-accent-bottom: #3b82f6;
    }
    
    #scans-card {
      --card-accent-top: #a78bfa;
      --card-accent-bottom: #8b5cf6;
    }
    
    #holiday-card {
      --card-accent-top: #34d399;
      --card-accent-bottom: #10b981;
    }
    
    #quiz-card {
      --card-accent-top: #fbbf24;
      --card-accent-bottom: #f59e0b;
    }
    
    .dashboard-card-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      gap: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .dashboard-card-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .dashboard-card-title {
      font-weight: 600;
      font-size: 14px;
      color: #f8fbff;
    }
    
    .dashboard-card-content {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
    }
    
    .dashboard-metric {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      flex: 1;
    }
    
    .dashboard-message {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
      font-style: italic;
      padding-top: 6px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    /* Training Card Specific Styles */
    .circle-progress {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: conic-gradient(#3b82f6 0%, rgba(255, 255, 255, 0.1) 0%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin-bottom: 10px;
    }
    
    .circle-progress::before {
      content: '';
      position: absolute;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(24, 28, 51, 0.6);
    }
    
    .circle-progress-value {
      position: relative;
      font-size: 16px;
      font-weight: 700;
      color: white;
      z-index: 1;
    }
    
    .dashboard-stats {
      display: flex;
      gap: 12px;
      margin-top: 5px;
      margin-bottom: 5px;
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(255, 255, 255, 0.06);
      padding: 6px 12px;
      border-radius: 6px;
    }
    
    .stat-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .stat-value {
      font-size: 14px;
      font-weight: 600;
      color: white;
    }
    
    /* Scans Card Specific Styles */
    .scan-stats {
      display: flex;
      justify-content: space-around;
      width: 100%;
      margin: 5px 0 10px;
    }
    
    .scan-stat {
      text-align: center;
    }
    
    .scan-count {
      font-size: 22px;
      font-weight: 700;
      color: white;
      text-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .scan-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 2px;
    }
    
    /* Holiday Card Specific Styles */
    .holiday-stats {
      display: flex;
      justify-content: space-around;
      width: 100%;
      margin: 5px 0;
    }
    
    .holiday-stat {
      text-align: center;
      background: rgba(255, 255, 255, 0.06);
      padding: 8px 14px;
      border-radius: 8px;
      min-width: 80px;
    }
    
    .holiday-count {
      font-size: 20px;
      font-weight: 700;
      color: white;
    }
    
    .holiday-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 2px;
    }
    
    .holiday-next {
      text-align: center;
      margin-top: 10px;
      background: rgba(255, 255, 255, 0.06);
      padding: 8px;
      border-radius: 8px;
    }
    
    .next-holiday-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .next-holiday-date {
      font-size: 14px;
      font-weight: 600;
      color: white;
    }
    
    /* Quiz Card Specific Styles */
    .quiz-stats {
      display: flex;
      justify-content: space-around;
      align-items: center;
      width: 100%;
      padding: 5px 0;
    }
    
    .quiz-score-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .quiz-score-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: conic-gradient(#f59e0b 0%, rgba(255, 255, 255, 0.1) 0%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin-bottom: 4px;
    }
    
    .quiz-score-circle::before {
      content: '';
      position: absolute;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(24, 28, 51, 0.6);
    }
    
    .quiz-score-value {
      position: relative;
      font-size: 16px;
      font-weight: 700;
      color: white;
      z-index: 1;
    }
    
    .quiz-score-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .quiz-attempts {
      text-align: center;
      background: rgba(255, 255, 255, 0.06);
      padding: 8px 12px;
      border-radius: 8px;
    }
    
    .quiz-attempts-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 4px;
    }
    
    .quiz-attempts-stats {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
    }
    
    .quiz-attempts-pass {
      font-size: 16px;
      font-weight: 700;
      color: #34d399;
    }
    
    .quiz-attempts-separator {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.5);
    }
    
    .quiz-attempts-total {
      font-size: 16px;
      font-weight: 700;
      color: white;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .personal-dashboard {
        grid-template-columns: 1fr;
      }
    }
    
    /* Meetings Section Styles — High‑contrast redesign */
    .meetings-section { margin-top: 20px; }

    .meetings-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      border-bottom: 2px solid #dbe2ea;
      align-items: flex-end;
    }

    .meetings-tab {
      padding: 10px 14px;
      background: #f3f5f8;
      color: #0f172a;
      border: 1px solid #cbd5e1;
      border-bottom: 3px solid transparent;
      border-radius: 10px 10px 0 0;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s ease, color .2s ease, border-color .2s ease, transform .1s ease;
    }
    
    .btn-generate-pdf {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
    }
    
    .meeting-history-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .meeting-history-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .meeting-form-group {
      margin-bottom: 15px;
    }
    
    .meeting-form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #374151;
    }
    
    .meeting-form-group input,
    .meeting-form-group textarea,
    .meeting-form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: inherit;
      color: #e6f0ff;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .meeting-form-group select option {
      color: #333;
      background: white;
    }
    
    .attendees-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    .attendee-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .attendee-badge.accepted {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .attendee-badge.declined {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .attendee-badge.pending {
      background: #fef3c7;
      color: #d97706;
    }

    /* Achievement Styles */
    .ach-grid {
      display: grid;
      gap: 12px;
    }

    .ach {
      display: flex;
      gap: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: fadeInScale 0.5s ease-out;
      transition: transform 0.2s ease;
    }

    .ach:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.12);
    }

    .ach.new {
      animation: achievementUnlock 0.8s ease-out;
      box-shadow: 0 0 30px rgba(99, 102, 241, 0.6), 0 0 60px rgba(34, 211, 238, 0.4);
      border-color: rgba(99, 102, 241, 0.5);
    }

    .ach .ico {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .ach .ico img {
      width: 28px;
      height: 28px;
    }

    .ach .txt {
      flex: 1;
    }

    .ach .name {
      font-weight: 600;
      color: #f8fbff;
      margin-bottom: 2px;
      font-size: 14px;
    }

    .ach .desc {
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      line-height: 1.3;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes achievementUnlock {
      0% {
        opacity: 0;
        transform: scale(0.5) rotate(-10deg);
      }
      50% {
        transform: scale(1.1) rotate(5deg);
      }
      100% {
        opacity: 1;
        transform: scale(1) rotate(0);
      }
    }

    /* Help Tour Button */
    #help-tour-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      background: #0b69ff;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      box-shadow: 0 4px 20px rgba(11, 105, 255, 0.4);
      transition: all 0.3s ease;
      z-index: 1000;
      gap: 2px;
    }

    #help-tour-btn:hover {
      background: #0956cc;
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(11, 105, 255, 0.5);
    }

    #help-tour-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Enhanced Glassmorphism styling to match holiday page design */
    .glassmorphism-bg {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 25%, #1d4ed8 50%, #2563eb 75%, #3b82f6 100%);
      min-height: 100vh;
      position: relative;
    }
    
    .glassmorphism-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -5;
      overflow: hidden;
    }
    
    .glassmorphism-gradient-1,
    .glassmorphism-gradient-2,
    .glassmorphism-gradient-3 {
      position: absolute;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.4;
      animation: glassmorphismFloat 20s ease-in-out infinite;
    }
    
    .glassmorphism-gradient-1 {
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.8) 0%, transparent 70%);
      top: -200px;
      left: -100px;
      animation-delay: 0s;
    }
    
    .glassmorphism-gradient-2 {
      width: 800px;
      height: 800px;
      background: radial-gradient(circle, rgba(99, 102, 241, 0.6) 0%, transparent 70%);
      top: 50%;
      right: -200px;
      animation-delay: -7s;
    }
    
    .glassmorphism-gradient-3 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(139, 92, 246, 0.7) 0%, transparent 70%);
      bottom: -150px;
      left: 30%;
      animation-delay: -14s;
    }
    
    .glassmorphism-blur-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      backdrop-filter: blur(1px);
      background: rgba(30, 58, 138, 0.1);
    }
    
    @keyframes glassmorphismFloat {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(20px, -30px) scale(1.1); }
      50% { transform: translate(-15px, 20px) scale(0.9); }
      75% { transform: translate(25px, 10px) scale(1.05); }
    }
    
    /* Enhanced panel styling for glassmorphism effect */
    .panel {
      background: rgba(255, 255, 255, 0.1) !important;
      backdrop-filter: blur(20px) saturate(180%) !important;
      -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      border-radius: 20px !important;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        0 0 0 1px rgba(255, 255, 255, 0.05) !important;
    }
    
    /* Special styling for topbar panel */
    .topbar.panel {
      background: rgba(255, 255, 255, 0.15) !important;
      backdrop-filter: blur(25px) saturate(200%) !important;
      -webkit-backdrop-filter: blur(25px) saturate(200%) !important;
      border: 1px solid rgba(255, 255, 255, 0.25) !important;
    }
    
    /* Enhanced activity cards for glassmorphism */
    .activity-card {
      background: rgba(255, 255, 255, 0.12) !important;
      backdrop-filter: blur(15px) saturate(150%) !important;
      -webkit-backdrop-filter: blur(15px) saturate(150%) !important;
      border: 1px solid rgba(255, 255, 255, 0.15) !important;
      border-radius: 16px !important;
      box-shadow: 
        0 4px 24px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.15) !important;
    }
    
    /* Enhanced bubble actions for glassmorphism */
    .bubble {
      background: rgba(255, 255, 255, 0.1) !important;
      backdrop-filter: blur(15px) saturate(160%) !important;
      -webkit-backdrop-filter: blur(15px) saturate(160%) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      box-shadow: 
        0 6px 20px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
    }
    
    .bubble:hover {
      background: rgba(255, 255, 255, 0.15) !important;
      transform: translateY(-4px) scale(1.02) !important;
      box-shadow: 
        0 12px 32px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.25) !important;
    }
    
    /* Enhanced text styling on glassmorphism background */
    .h1, .panel-title, .hero .subtitle {
      color: white !important;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* Enhanced pills for glassmorphism */
    .pill {
      background: rgba(255, 255, 255, 0.12) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      color: white !important;
    }
    
    /* Enhanced buttons for glassmorphism */
    .btn {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(37, 99, 235, 0.8)) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3) !important;
    }
    
    .btn:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9)) !important;
      box-shadow: 0 6px 24px rgba(59, 130, 246, 0.4) !important;
    }
  </style>
</head>
<body class="staff-home-particles glassmorphism-bg">
  <!-- Enhanced glassmorphism background matching holiday page -->
  <div class="glassmorphism-backdrop">
    <div class="glassmorphism-gradient-1"></div>
    <div class="glassmorphism-gradient-2"></div>
    <div class="glassmorphism-gradient-3"></div>
    <div class="glassmorphism-blur-layer"></div>
  </div>
  
  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
    <div class="particles" id="particles"></div>
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>
  </div>
  <div class="mesh" aria-hidden="true"><div class="m1"></div><div class="m2"></div><div class="m3"></div></div>
  
  <!-- Floating orbs for extra depth -->
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <div class="orb orb3"></div>
  <main class="content">
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav">
        <!-- Navigation will be rendered by staff-common.js -->
      </div>
      <div class="spacer"></div>
      
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>


    <section class="panel g-12" style="margin:0; position:relative; overflow:hidden;">
      <div class="halo"></div>

      <!-- Quiz Due Alert -->
      <div id="quiz-alert" class="quiz-alert" style="display:none;">
        <div class="quiz-alert-content">
          <div class="quiz-alert-icon"><img data-i8="brain" data-i8-size="48" alt="Quiz"></div>
          <div class="quiz-alert-text">
            <div class="quiz-alert-title">Weekly Quiz Due!</div>
            <div class="quiz-alert-subtitle" id="quiz-alert-message">Complete your required knowledge check</div>
          </div>
          <a href="staff-quiz.html" class="quiz-alert-btn">Take Quiz</a>
        </div>
      </div>
      
      <div class="hero">
        <div class="ring bounce" id="compliance-ring" title="Training compliance" style="position:relative;">
          <div class="ring-progress"></div>
          <div class="ring-hole"></div>
          <img id="ring-avatar" alt="Avatar" />
        </div>
        <div style="min-width:200px;">
          <div class="subtitle" id="site-subtitle"></div>
          <div class="h1" id="welcome" style="font-size:32px;">Welcome</div>
          <!-- Badges removed as requested -->
        </div>
  <div class="spacer"></div>
        <div class="bubble-actions" aria-label="Quick actions">
          <a class="bubble" href="staff-scans.html" onclick="logActivity(supabase.auth.getUser().then(u => u.data.user.id), 'navigation', { to: 'staff-scans' })">
            <div class="i c-purple"><img data-i8="document" data-i8-size="48" alt="My Scans"/></div>
            <div class="t">My Scans</div>
          </a>
          <a class="bubble" href="staff-training.html" onclick="logActivity(supabase.auth.getUser().then(u => u.data.user.id), 'navigation', { to: 'staff-training' })">
            <div class="i c-blue"><img data-i8="graduation-cap" data-i8-size="48" alt="Training"/></div>
            <div class="t">Training</div>
          </a>
          <div class="bubble disabled-bubble" title="Coming Soon" style="cursor: pointer; opacity: 0.6; color: #9ca3af;" onclick="handleHolidaysClick()">
            <div class="i c-green" style="opacity: 0.6;"><img data-i8="calendar" data-i8-size="48" alt="My Holidays" style="opacity: 0.6;"/></div>
            <div class="t" style="color: #9ca3af;">My Holidays</div>
          </div>
          <a class="bubble quiz-bubble" href="staff-quiz.html" id="quiz-bubble" onclick="logActivity(supabase.auth.getUser().then(u => u.data.user.id), 'navigation', { to: 'staff-quiz' })">
            <div class="i c-orange"><img data-i8="puzzle" data-i8-size="48" alt="Quiz"/></div>
            <div class="t">Quiz</div>
          </a>
        </div>
      </div>
      <div class="progress-wrap" style="margin-top:10px; padding:0 8px;">
        <div class="progress" style="height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; border:1px solid var(--border-color);">
          <div id="training-progress-bar" class="bar" style="height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#a78bfa);"></div>
        </div>
        <div id="training-progress-label" class="meta-note" style="text-align:right; margin-top:4px;">0% Training</div>
      </div>
      <div class="tile-grid" style="margin-top:14px;">
        <div class="tile">
          <div class="panel-header" style="align-items:center; gap:10px;">
            <div class="illus-circle"><img data-i8="user-heart" alt="My Dashboard"></div>
            <div class="panel-title">My Dashboard</div>
          </div>
          <!-- Personal Mini Dashboard -->
          <div class="personal-dashboard">
            <!-- Training Status Card -->
            <div class="dashboard-card" id="training-card">
              <div class="dashboard-card-header">
                <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);">
                  <img data-i8="graduation-cap" data-i8-size="24" alt="Training">
                </div>
                <div class="dashboard-card-title">Training Status</div>
              </div>
              <div class="dashboard-card-content">
                <div class="dashboard-metric">
                  <div class="circle-progress" id="training-circle">
                    <div class="circle-progress-value">0%</div>
                  </div>
                  <div class="dashboard-stats">
                    <div class="stat-item">
                      <span class="stat-label">Up to date:</span>
                      <span class="stat-value" id="training-valid">0</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-label">Due soon:</span>
                      <span class="stat-value" id="training-due">0</span>
                    </div>
                  </div>
                </div>
                <div class="dashboard-message" id="training-message">
                  Keep your training up to date!
                </div>
              </div>
            </div>
            
            <!-- Recent Scans Card -->
            <div class="dashboard-card" id="scans-card">
              <div class="dashboard-card-header">
                <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #a78bfa, #8b5cf6);">
                  <img data-i8="document" data-i8-size="24" alt="Scans">
                </div>
                <div class="dashboard-card-title">Recent Scans</div>
              </div>
              <div class="dashboard-card-content">
                <div class="dashboard-metric">
                  <div class="scan-stats">
                    <div class="scan-stat">
                      <div class="scan-count" id="today-scans">0</div>
                      <div class="scan-label">Today</div>
                    </div>
                    <div class="scan-stat">
                      <div class="scan-count" id="week-scans">0</div>
                      <div class="scan-label">This Week</div>
                    </div>
                    <div class="scan-stat">
                      <div class="scan-count" id="month-scans">0</div>
                      <div class="scan-label">This Month</div>
                    </div>
                  </div>
                </div>
                <div class="dashboard-message" id="scans-message">
                  Loading your recent scan activity...
                </div>
              </div>
            </div>
            
            <!-- Holiday Status Card -->
            <div class="dashboard-card" id="holiday-card">
              <div class="dashboard-card-header">
                <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #34d399, #10b981);">
                  <img data-i8="beach" data-i8-size="24" alt="Holidays">
                </div>
                <div class="dashboard-card-title">Holiday Status</div>
              </div>
              <div class="dashboard-card-content">
                <div id="holiday-stats-container">
                  <div class="holiday-stats">
                    <div class="holiday-stat">
                      <div class="holiday-count" id="holiday-days-used">--</div>
                      <div class="holiday-label">Days Used</div>
                    </div>
                    <div class="holiday-stat">
                      <div class="holiday-count" id="holiday-days-remaining">--</div>
                      <div class="holiday-label">Days Remaining</div>
                    </div>
                  </div>
                  <div class="holiday-next" id="next-holiday-container">
                    <div class="next-holiday-label">Next Holiday:</div>
                    <div class="next-holiday-date" id="next-holiday-date">--</div>
                  </div>
                </div>
                <div class="dashboard-message" id="holiday-message">
                  Loading your holiday information...
                </div>
              </div>
            </div>

            <!-- Quiz Status Card -->
            <div class="dashboard-card" id="quiz-card">
              <div class="dashboard-card-header">
                <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                  <img data-i8="brain" data-i8-size="24" alt="Quiz">
                </div>
                <div class="dashboard-card-title">Quiz Performance</div>
              </div>
              <div class="dashboard-card-content">
                <div class="dashboard-metric">
                  <div class="quiz-stats">
                    <div class="quiz-score-container">
                      <div class="quiz-score-circle" id="quiz-score-circle">
                        <div class="quiz-score-value" id="quiz-score">--</div>
                      </div>
                      <div class="quiz-score-label">Last Score</div>
                    </div>
                    <div class="quiz-attempts">
                      <div class="quiz-attempts-label">Recent Quizzes:</div>
                      <div class="quiz-attempts-stats">
                        <div class="quiz-attempts-pass" id="quiz-attempts-pass">0</div>
                        <div class="quiz-attempts-separator">/</div>
                        <div class="quiz-attempts-total" id="quiz-attempts-total">0</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="dashboard-message" id="quiz-message">
                  Loading your quiz information...
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tile" style="position: relative;">
          <div class="panel-header" style="align-items:center; gap:10px;">
            <div class="illus-circle"><img data-i8="time-machine" alt="Recent Activity"></div>
            <div class="panel-title">Recent Activity</div>
          </div>
          <div id="recent-scans-loading" style="padding:10px; text-align:center;">Loading…</div>
          <div class="timeline" id="timeline" style="display:none; max-height: 450px; overflow-y: auto; padding-right: 5px;"></div>
          <div id="recent-scans-empty" class="empty" style="display:none">No activity yet.</div>

          <!-- Confetti container for celebrations -->
          <canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: none;"></canvas>
        </div>
      </div>
    </section>

  <!-- Meetings section removed (moved to dedicated page) -->

  <!-- Admin access panel removed from staff home (admin link remains available via top nav) -->

    <div class="muted" style="text-align:center; font-size:12px; padding:10px 0;">© CheckLoop • Staff</div>
  </main>

  <!-- Help Tour Button -->
  <button id="help-tour-btn" title="Take a guided tour of the dashboard">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
    </svg>
    ?
  </button>

  <script type="module">
  import { initSupabase, requireStaffSession, getCurrentUserSiteText, setTopbar, handleAuthState, navActivate, setRing, fmtDate, getUserAchievements, upsertAchievement, clearAuthData, computeCompliance } from './staff-common.js';
    
    // Global function to handle holidays click
    window.handleHolidaysClick = async function() {
      try {
        // Get current session
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          alert('Please sign in to access My Holidays.');
          return;
        }

        // Check if holidays are approved for this user in master_users table
        const { data: userData, error } = await supabase
          .from('master_users')
          .select('holiday_approved')
          .eq('auth_user_id', session.user.id)
          .single();

        if (error) {
          console.error('Error checking holiday approval:', error);
          alert('Unable to check holiday access. Please try again later.');
          return;
        }

        if (userData && userData.holiday_approved === true) {
          // Holidays are approved - navigate to holidays page
          window.location.href = 'my-holidays.html';
        } else {
          // Holidays not yet approved
          alert('Your holiday entitlement is awaiting admin approval. Please check back later or contact your admin.');
        }
      } catch (error) {
        console.error('Error in handleHolidaysClick:', error);
        alert('An error occurred. Please try again.');
      }
    };
    
    const supabase = await initSupabase();
    // Make supabase available globally for Admin Portal button
    window.supabase = supabase;
    
    handleAuthState(supabase);
    navActivate('home');

    // Quick client-side reveal: use locally stored session metadata to
    // show the Admin button immediately for admin/owner users while
    // the authoritative profileRow is loaded. This avoids a visible
    // 1-2s delay waiting for the DB-backed requireStaffSession call.
    try {
      supabase.auth.getSession().then(({ data }) => {
        const user = data?.session?.user || {};
        const earlyRole = user?.raw_user_meta_data?.role || user?.user_metadata?.role;
        if (earlyRole) {
        }
      }).catch(_=>{});
    } catch(_){}

    let isLoggingOut = false;
    function cleanupAndRedirect() {
      try { clearAuthData(true); } catch(_) {}
      try { sessionStorage.clear(); } catch(_) {}
      try { document.cookie.split(';').forEach(c => document.cookie = c.replace(/^ +/, '').replace(/=.*/, `=;expires=${new Date(0).toUTCString()};path=/`)); } catch(_) {}
  window.location.replace('home.html?_=' + Date.now());
    }
    async function forceLogout() {
      if (isLoggingOut) return;
      isLoggingOut = true;
      try { const { data } = await supabase.auth.getSession(); if (data?.session) await supabase.auth.signOut(); } catch (e) { console.error('Supabase signOut failed:', e); }
      cleanupAndRedirect();
    }
    document.getElementById('logout-btn').addEventListener('click', async (e) => { e.preventDefault(); e.stopPropagation(); await forceLogout(); });

    requireStaffSession(supabase).then(async ({ session, profileRow }) => {
      await loadDashboard(session.user, profileRow);
      
      // Load the personal mini dashboard
      await loadPersonalDashboard(session.user, profileRow);

      // Setup help tour button functionality
      setupHelpTourButton(profileRow, session);

      // Check holiday approval status and update button from master_users table
      try {
        const { data: userData, error } = await supabase
          .from('master_users')
          .select('holiday_approved')
          .eq('auth_user_id', session.user.id)
          .single();

        if (!error && userData) {
          const holidayBubble = document.querySelector('.disabled-bubble[onclick*="handleHolidaysClick"]');
          if (holidayBubble) {
            if (userData.holiday_approved === true) {
              // Convert to active link if approved
              const newLink = document.createElement('a');
              newLink.className = 'bubble';
              newLink.href = 'my-holidays.html';
              newLink.innerHTML = `
                <div class="i c-green"><img data-i8="calendar" data-i8-size="48" alt="My Holidays"/></div>
                <div class="t">My Holidays</div>
              `;
              holidayBubble.parentNode.replaceChild(newLink, holidayBubble);
            } else {
              // Keep it greyed out and add hover message
              holidayBubble.title = 'Holiday entitlement awaiting admin approval. You will be able to access your holidays once approved.';
              holidayBubble.style.cursor = 'not-allowed';
              
              const textEl = holidayBubble.querySelector('.t');
              if (textEl) {
                textEl.innerHTML = 'My Holidays<br><small style="font-size: 10px; opacity: 0.7; color: #f59e0b;">(Awaiting Approval)</small>';
              }
              
              // Add a subtle animation to indicate it's disabled but will become available
              holidayBubble.style.position = 'relative';
              holidayBubble.style.overflow = 'hidden';
              
              // Add a pulse effect to indicate pending status
              holidayBubble.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(251, 191, 36, 0.1)';
                this.style.borderColor = 'rgba(251, 191, 36, 0.3)';
              });
              
              holidayBubble.addEventListener('mouseleave', function() {
                this.style.background = '';
                this.style.borderColor = '';
              });
            }
          }
        }
      } catch (error) {
        console.error('Error checking holiday approval status:', error);
      }

      // Reveal Admin link if applicable

      // Show admin access panel for admins and owners
      const adminRole = (profileRow?.access_type || profileRow?.role || session.user?.raw_user_meta_data?.role || '').toLowerCase();
      if (adminRole === 'admin' || adminRole === 'owner') {
        const adminPanel = document.getElementById('admin-access-panel');
        if (adminPanel) {
          adminPanel.style.display = 'block';
        }
      }
    }).catch(e => {
  if (String(e.message).includes('NO_SESSION')) { window.location.replace('home.html'); return; }
  if (String(e.message).includes('NOT_STAFF')) { window.location.replace('home.html'); return; }
      console.error(e);
    });

    // Helper function to log user activity
    async function logActivity(userId, activityType, details = {}) {
      try {
        // Check if we have an activity_logs table or similar
        // For now, we'll just console log but this could be expanded
        console.log('User activity:', { userId, activityType, details, timestamp: new Date().toISOString() });

        // In the future, you could create an activity_logs table and do:
        // await supabase.from('activity_logs').insert({
        //   user_id: userId,
        //   activity_type: activityType,
        //   details: details,
        //   created_at: new Date().toISOString()
        // });
      } catch(e) {
        console.error('Failed to log activity:', e);
      }
    }

    // Confetti animation for celebrations
    function triggerConfetti() {
      const canvas = document.getElementById('confetti-canvas');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      canvas.style.display = 'block';
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const colors = ['#ec4899', '#fbbf24', '#8b5cf6', '#10b981', '#3b82f6'];

      // Create particles
      for (let i = 0; i < 100; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: -10,
          vx: (Math.random() - 0.5) * 2,
          vy: Math.random() * 3 + 2,
          radius: Math.random() * 3 + 1,
          color: colors[Math.floor(Math.random() * colors.length)],
          rotation: Math.random() * 360,
          rotationSpeed: (Math.random() - 0.5) * 10
        });
      }

      let animationId;
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        particles.forEach((p, index) => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.1; // gravity
          p.rotation += p.rotationSpeed;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.radius, -p.radius, p.radius * 2, p.radius * 2);
          ctx.restore();

          // Remove particles that are off screen
          if (p.y > canvas.height) {
            particles.splice(index, 1);
          }
        });

        if (particles.length > 0) {
          animationId = requestAnimationFrame(animate);
        } else {
          canvas.style.display = 'none';
          cancelAnimationFrame(animationId);
        }
      }

      animate();
    }

    async function loadPersonalDashboard(user, profileRow) {
      const siteId = profileRow?.site_id || user?.raw_user_meta_data?.site_id || null;
      const userId = user.id;
      
      // Load Training Data
      loadTrainingDashboard(user, profileRow, siteId);
      
      // Load Scans Data
      loadScansDashboard(user, profileRow, siteId);
      
      // Load Holiday Data
      loadHolidayDashboard(user, profileRow, siteId);
      
      // Load Quiz Data
      loadQuizDashboard(user, profileRow, siteId);
    }
    
    async function loadTrainingDashboard(user, profileRow, siteId) {
      const trainingCircle = document.getElementById('training-circle');
      const trainingValue = trainingCircle.querySelector('.circle-progress-value');
      const trainingValid = document.getElementById('training-valid');
      const trainingDue = document.getElementById('training-due');
      const trainingMessage = document.getElementById('training-message');
      
      try {
        // Get training data from profileRow or compute it
        let valid = 0, due = 0, total = 0, percent = 0;
        
        if (profileRow?.training_compliance_pct != null) {
          percent = Math.round(Number(profileRow.training_compliance_pct));
        } else if (profileRow?.training_percent != null) {
          percent = Math.round(Number(profileRow.training_percent));
        } else {
          try {
            if (siteId) {
              // Fetch the site's active training types and the user's training records
              const [{ data: types, error: typesErr }, { data: recs, error: recsErr }] = await Promise.all([
                supabase.from('training_types').select('id, validity_months, active').eq('site_id', siteId).eq('active', true),
                // training_records schema varies; attempt to match either user_id or staff_id
                supabase.from('training_records').select('*').eq('site_id', siteId).or(`user_id.eq.${user.id},staff_id.eq.${user.id}`)
              ]);
              
              if (!typesErr && types && types.length) {
                const comp = computeCompliance(types, recs || [], new Date());
                percent = comp.percent || 0;
                valid = comp.ok || 0;
                due = comp.due || 0;
                total = comp.total || 0;
              }
            }
          } catch (e) {
            console.error('Error computing training data:', e);
          }
        }
        
        // If we have percent but not the counts, try to estimate them
        if (percent > 0 && total === 0) {
          // Try to get training record counts from database
          try {
            const { data: records } = await supabase
              .from('staff_training_records')
              .select('id, expiry_date')
              .eq('user_id', user.id);
              
            if (records && records.length) {
              total = records.length;
              const now = new Date();
              valid = records.filter(r => {
                if (!r.expiry_date) return true; // No expiry means valid
                return new Date(r.expiry_date) > now;
              }).length;
              due = total - valid;
            }
          } catch (e) {
            console.warn('Error fetching training records count:', e);
            // Make up reasonable numbers based on percentage
            total = 10; // Assume 10 training items as default
            valid = Math.round((percent / 100) * total);
            due = total - valid;
          }
        }
        
        // Update UI
        trainingValue.textContent = `${percent}%`;
        trainingValid.textContent = valid;
        trainingDue.textContent = due;
        
        // Set circle progress
        trainingCircle.style.background = `conic-gradient(#3b82f6 ${percent * 3.6}deg, rgba(255, 255, 255, 0.1) ${percent * 3.6}deg)`;
        
        // Set message based on compliance
        if (percent >= 90) {
          trainingMessage.textContent = '🌟 Excellent! Your training is up to date.';
          trainingMessage.style.color = '#34d399';
        } else if (percent >= 70) {
          trainingMessage.textContent = '👍 Good progress on your training requirements.';
          trainingMessage.style.color = '#fbbf24';
        } else {
          trainingMessage.textContent = '⚠️ Some training items need your attention.';
          trainingMessage.style.color = '#f87171';
        }
        
      } catch (e) {
        console.error('Error loading training dashboard:', e);
        trainingMessage.textContent = 'Unable to load training data. Please try again later.';
      }
    }
    
    async function loadScansDashboard(user, profileRow, siteId) {
      const todayScans = document.getElementById('today-scans');
      const weekScans = document.getElementById('week-scans');
      const monthScans = document.getElementById('month-scans');
      const scansMessage = document.getElementById('scans-message');
      
      try {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        const weekAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7).toISOString();
        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()).toISOString();
        
        // Try first table name
        let todayCount = 0, weekCount = 0, monthCount = 0;
        
        try {
          // Check if submission_details table exists and has the data
          const [todayRes, weekRes, monthRes] = await Promise.all([
            supabase.from('submission_details')
              .select('id', { count: 'exact', head: true })
              .eq('user_id', user.id)
              .gte('created_at', today),
              
            supabase.from('submission_details')
              .select('id', { count: 'exact', head: true })
              .eq('user_id', user.id)
              .gte('created_at', weekAgo),
              
            supabase.from('submission_details')
              .select('id', { count: 'exact', head: true })
              .eq('user_id', user.id)
              .gte('created_at', monthAgo)
          ]);
          
          if (!todayRes.error) todayCount = todayRes.count || 0;
          if (!weekRes.error) weekCount = weekRes.count || 0;
          if (!monthRes.error) monthCount = monthRes.count || 0;
        } catch (e) {
          console.warn('Error getting scan counts from submission_details:', e);
        }
        
        // If we didn't get data, try v_submission_detail view
        if (todayCount === 0 && weekCount === 0 && monthCount === 0) {
          try {
            const [todayRes, weekRes, monthRes] = await Promise.all([
              supabase.from('v_submission_detail')
                .select('id', { count: 'exact', head: true })
                .eq('user_id', user.id)
                .gte('created_at', today),
                
              supabase.from('v_submission_detail')
                .select('id', { count: 'exact', head: true })
                .eq('user_id', user.id)
                .gte('created_at', weekAgo),
                
              supabase.from('v_submission_detail')
                .select('id', { count: 'exact', head: true })
                .eq('user_id', user.id)
                .gte('created_at', monthAgo)
            ]);
            
            if (!todayRes.error) todayCount = todayRes.count || 0;
            if (!weekRes.error) weekCount = weekRes.count || 0;
            if (!monthRes.error) monthCount = monthRes.count || 0;
          } catch (e) {
            console.warn('Error getting scan counts from v_submission_detail:', e);
          }
        }
        
        // Update UI with animation
        animateNumber(todayScans, todayCount, { duration: 1000 });
        animateNumber(weekScans, weekCount, { duration: 1200 });
        animateNumber(monthScans, monthCount, { duration: 1400 });
        
        // Set appropriate message
        if (todayCount > 0) {
          scansMessage.textContent = `🔍 You've completed ${todayCount} scan${todayCount !== 1 ? 's' : ''} today!`;
          scansMessage.style.color = '#34d399';
        } else if (weekCount > 0) {
          scansMessage.textContent = `👍 ${weekCount} scan${weekCount !== 1 ? 's' : ''} completed this week.`;
          scansMessage.style.color = '#fbbf24';
        } else if (monthCount > 0) {
          scansMessage.textContent = `📊 ${monthCount} scan${monthCount !== 1 ? 's' : ''} completed this month.`;
          scansMessage.style.color = '#f87171';
        } else {
          scansMessage.textContent = 'No recent scans. Go to "My Scans" to get started.';
          scansMessage.style.color = 'rgba(255, 255, 255, 0.7)';
        }
        
      } catch (e) {
        console.error('Error loading scans dashboard:', e);
        scansMessage.textContent = 'Unable to load scan data. Please try again later.';
      }
    }
    
    async function loadHolidayDashboard(user, profileRow, siteId) {
      const daysUsed = document.getElementById('holiday-days-used');
      const daysRemaining = document.getElementById('holiday-days-remaining');
      const nextHolidayDate = document.getElementById('next-holiday-date');
      const nextHolidayContainer = document.getElementById('next-holiday-container');
      const holidayMessage = document.getElementById('holiday-message');
      const holidayStatsContainer = document.getElementById('holiday-stats-container');
      
      try {
        // First check if holidays are approved for this user
        const { data: userData, error: userError } = await supabase
          .from('master_users')
          .select('holiday_approved, holiday_entitlement')
          .eq('auth_user_id', user.id)
          .single();
          
        if (userError) {
          throw new Error('Could not fetch holiday approval status');
        }
        
        if (!userData || userData.holiday_approved !== true) {
          // Holidays not approved
          holidayStatsContainer.style.display = 'none';
          holidayMessage.textContent = '⏳ Your holiday entitlement is awaiting admin approval.';
          holidayMessage.style.color = '#fbbf24';
          return;
        }
        
        // Holidays are approved, get holiday data
        const entitlement = userData.holiday_entitlement || 28; // Default to 28 days if not specified
        
        // Get approved holidays
        const today = new Date();
        const { data: holidays, error: holidaysError } = await supabase
          .from('4_holiday_requests') // Try the canonical table name
          .select('start_date, end_date, status')
          .eq('user_id', user.id)
          .eq('status', 'approved')
          .order('start_date', { ascending: true });
          
        if (holidaysError) {
          throw new Error('Could not fetch holiday data');
        }
        
        // Calculate days used
        let usedDays = 0;
        let nextHoliday = null;
        
        if (holidays && holidays.length > 0) {
          holidays.forEach(holiday => {
            const start = new Date(holiday.start_date);
            const end = new Date(holiday.end_date);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // Include both start and end days
            usedDays += diffDays;
            
            // Check if this is an upcoming holiday
            if (start > today && (nextHoliday === null || start < new Date(nextHoliday.start_date))) {
              nextHoliday = holiday;
            }
          });
        }
        
        // Update UI
        daysUsed.textContent = usedDays;
        daysRemaining.textContent = Math.max(0, entitlement - usedDays);
        
        if (nextHoliday) {
          const startDate = new Date(nextHoliday.start_date);
          const formattedDate = startDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
          nextHolidayDate.textContent = formattedDate;
          nextHolidayContainer.style.display = 'block';
          
          // Calculate days until next holiday
          const diffTime = Math.abs(startDate - today);
          const daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (daysUntil <= 7) {
            holidayMessage.textContent = `🏝️ Your holiday starts in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}!`;
            holidayMessage.style.color = '#34d399';
          } else {
            holidayMessage.textContent = `✈️ ${daysUntil} days until your next holiday.`;
            holidayMessage.style.color = '#fbbf24';
          }
        } else {
          nextHolidayContainer.style.display = 'none';
          if (entitlement - usedDays > 0) {
            holidayMessage.textContent = `🗓️ You have ${entitlement - usedDays} holiday days remaining this year.`;
            holidayMessage.style.color = '#34d399';
          } else {
            holidayMessage.textContent = '🏖️ You have used all your holiday entitlement.';
            holidayMessage.style.color = '#f87171';
          }
        }
        
      } catch (e) {
        console.error('Error loading holiday dashboard:', e);
        holidayStatsContainer.style.display = 'none';
        holidayMessage.textContent = 'Unable to load holiday data. Please try again later.';
        holidayMessage.style.color = '#f87171';
      }
    }
    
    async function loadQuizDashboard(user, profileRow, siteId) {
      const quizScore = document.getElementById('quiz-score');
      const quizScoreCircle = document.getElementById('quiz-score-circle');
      const quizPass = document.getElementById('quiz-attempts-pass');
      const quizTotal = document.getElementById('quiz-attempts-total');
      const quizMessage = document.getElementById('quiz-message');
      
      try {
        // First check master_users as the primary source of truth
        const { data: masterUser, error: masterUserError } = await supabase
          .from('master_users')
          .select('next_quiz_due, last_required_quiz_at')
          .eq('auth_user_id', user.id)
          .maybeSingle();
        
        // Check quiz_practices table (newer approach)
        const { data: quizPractices, error: quizPracticesError } = await supabase
          .from('quiz_practices')
          .select('id, score_percent, completed_at, score, total_questions')
          .eq('user_id', user.id)
          .order('completed_at', { ascending: false });
        
        // Check quiz_attempts table for backward compatibility
        const { data: quizAttempts, error: quizAttemptsError } = await supabase
          .from('quiz_attempts')
          .select('id, score_percent, is_practice, completed_at, total_questions, correct_answers')
          .eq('user_id', user.id)
          .eq('is_practice', false) // Only include real quizzes, not practice ones
          .order('completed_at', { ascending: false });
        
        // Get the latest quiz result - prioritizing master_users
        let latestQuizScore = null;
        let passedQuizzes = 0;
        let totalQuizzes = 0;
        
        // Prioritize master_users as source of truth
        if (masterUser?.last_required_quiz_at) {
          // We have a record of the user completing a quiz in master_users
          totalQuizzes = 1; // At least one quiz was completed
          
          // Default score if we don't have more details
          latestQuizScore = 80; // Assume a passing score (80%)
          passedQuizzes = 1;
          
          // Try to get a more accurate score from other tables
          if (quizPractices && quizPractices.length > 0) {
            // Use practice quizzes for more detailed stats
            const practiceScores = quizPractices.map(q => q.score_percent || Math.round((q.score / q.total_questions) * 100));
            const passedPractices = quizPractices.filter(q => {
              const score = q.score_percent || Math.round((q.score / q.total_questions) * 100);
              return score >= 80;
            }).length;
            
            latestQuizScore = practiceScores[0];
            passedQuizzes = passedPractices;
            totalQuizzes = quizPractices.length;
          } else if (quizAttempts && quizAttempts.length > 0) {
            // Use quiz_attempts data
            const attemptScores = quizAttempts.map(q => q.score_percent || Math.round((q.correct_answers / q.total_questions) * 100));
            const passedAttempts = quizAttempts.filter(q => {
              const score = q.score_percent || Math.round((q.correct_answers / q.total_questions) * 100);
              return score >= 80;
            }).length;
            
            latestQuizScore = attemptScores[0];
            passedQuizzes = passedAttempts;
            totalQuizzes = quizAttempts.length;
          } else {
            // Assume at least one passed quiz if no contradicting data
            latestQuizScore = 80; // Default assumption if we know they completed a quiz
            passedQuizzes = 1;
          }
        } else if (quizAttempts && quizAttempts.length > 0) {
          // Use quiz_attempts as fallback
          const attemptScores = quizAttempts.map(q => q.score_percent || Math.round((q.correct_answers / q.total_questions) * 100));
          const passedAttempts = quizAttempts.filter(q => {
              const score = q.score_percent || Math.round((q.correct_answers / q.total_questions) * 100);
              return score >= 80;
          }).length;
          
          latestQuizScore = attemptScores[0];
          passedQuizzes = passedAttempts;
          totalQuizzes = quizAttempts.length;
        } else if (quizPractices && quizPractices.length > 0) {
          // Use quiz_practices as another fallback
          const practiceScores = quizPractices.map(q => q.score_percent || Math.round((q.score / q.total_questions) * 100));
          const passedPractices = quizPractices.filter(q => {
              const score = q.score_percent || Math.round((q.score / q.total_questions) * 100);
              return score >= 80;
          }).length;
          
          latestQuizScore = practiceScores[0];
          passedQuizzes = passedPractices;
          totalQuizzes = quizPractices.length;
        }
        
        // Update UI based on available data
        if (latestQuizScore !== null && totalQuizzes > 0) {
          // We have some quiz data to display
          quizScore.textContent = `${latestQuizScore}%`;
          quizScoreCircle.style.background = `conic-gradient(${latestQuizScore >= 80 ? '#10b981' : '#f59e0b'} ${latestQuizScore * 3.6}deg, rgba(255, 255, 255, 0.1) ${latestQuizScore * 3.6}deg)`;
          
          quizPass.textContent = passedQuizzes;
          quizTotal.textContent = totalQuizzes;
          
          // Set message based on performance
          if (latestQuizScore >= 90) {
            quizMessage.textContent = '🏆 Excellent! You aced your last quiz.';
            quizMessage.style.color = '#34d399';
          } else if (latestQuizScore >= 80) {
            quizMessage.textContent = '👍 Good job! You passed your last quiz.';
            quizMessage.style.color = '#fbbf24';
          } else {
            quizMessage.textContent = '📚 Keep practicing to improve your score.';
            quizMessage.style.color = '#f87171';
          }
        } else {
          // No quizzes taken yet
          quizScore.textContent = '--';
          quizPass.textContent = '0';
          quizTotal.textContent = '0';
          quizMessage.textContent = '🧠 Take your first quiz to see your performance.';
          return;
        }
        
        // Check if quiz is due (prioritizing master_users table)
        if (masterUser?.next_quiz_due) {
          const nextDue = new Date(masterUser.next_quiz_due);
          const now = new Date();
          
          if (now >= nextDue) {
            quizMessage.textContent = '⚠️ Your weekly quiz is due now!';
            quizMessage.style.color = '#f87171';
          } else {
            // Calculate days until next quiz
            const daysUntilDue = Math.ceil((nextDue - now) / (1000 * 60 * 60 * 24));
            const hoursUntilDue = Math.ceil((nextDue - now) / (1000 * 60 * 60));
            
            if (hoursUntilDue <= 24) {
              quizMessage.textContent = `⏰ Your next quiz is due in ${hoursUntilDue} hour${hoursUntilDue > 1 ? 's' : ''}`;
              quizMessage.style.color = '#3b82f6';
            } else if (daysUntilDue <= 3) {
              quizMessage.textContent = `📆 Your next quiz is due in ${daysUntilDue} day${daysUntilDue > 1 ? 's' : ''}`;
              quizMessage.style.color = '#3b82f6';
            }
          }
        }
        
      } catch (e) {
        console.error('Error loading quiz dashboard:', e);
        quizMessage.textContent = 'Unable to load quiz data. Please try again later.';
      }
    }
    
    async function loadDashboard(user, profileRow){
      // Log dashboard access
      await logActivity(user.id, 'dashboard_viewed', { page: 'staff_home' });

      // Resolve a friendly display name
      let displayName = profileRow?.full_name || user?.raw_user_meta_data?.full_name || (user?.email?.split('@')[0]) || 'Staff Member';
      try{
        const { data: nickRow } = await supabase.from('master_users').select('nickname').eq('auth_user_id', user.id).maybeSingle();
        if (nickRow?.nickname) displayName = nickRow.nickname;
      }catch(_){/* ignore */}

      const siteId = profileRow?.site_id || user?.raw_user_meta_data?.site_id || null;
      const access_type = profileRow?.access_type;
      const role = profileRow?.access_type || profileRow?.role || user?.raw_user_meta_data?.role || 'Staff';
      const roleDetail = role.charAt(0).toUpperCase() + role.slice(1);  // Capitalize first letter

      document.getElementById('welcome').textContent = `Welcome, ${displayName}`;

      // Check quiz due status
      await checkQuizStatus(user, profileRow);

      
      // Resolve avatar and render into ring circle
      // Check sources in priority order (most authoritative first)
      try {
        let avatarUrl = null;
        let avatarVersion = null;
        const avatarCacheKey = `staff-avatar-${user.id}`;

        // 1. First check master_users table (most authoritative/recent)
        try {
          const { data: p } = await supabase.from('master_users').select('avatar_url, updated_at').eq('auth_user_id', user.id).maybeSingle();
          if (p?.avatar_url) {
            avatarUrl = p.avatar_url;
            console.log('Avatar from master_users:', avatarUrl);
            avatarVersion = p.updated_at || avatarVersion;
          }
        } catch(e) {
          console.warn('Error fetching Avatar from master_users:', e);
        }

        // 2. If not in profiles, check staff_app_welcome
        if (!avatarUrl) {
          try {
            if (siteId) {
              const { data: saw } = await supabase
                .from('master_users')
                .select('avatar_url, updated_at')
                .eq('auth_user_id', user.id)
                .eq('site_id', siteId)
                .order('updated_at', { ascending: false })
                .limit(1)
                .maybeSingle();
              if (saw?.avatar_url) {
                avatarUrl = saw.avatar_url;
                console.log('Avatar from staff_app_welcome:', avatarUrl);
                avatarVersion = saw.updated_at || avatarVersion;
              }
            }
          } catch(e) {
            console.warn('Error fetching avatar from staff_app_welcome:', e);
          }
        }

        // 3. Finally fall back to user metadata
        if (!avatarUrl) {
          // Get fresh user data to ensure we have the latest metadata
          const { data: { user: refreshedUser } } = await supabase.auth.getUser();
          avatarUrl = refreshedUser?.user_metadata?.avatar_url || user?.raw_user_meta_data?.avatar_url || null;
          if (avatarUrl) {
            console.log('Avatar from user metadata:', avatarUrl);
            avatarVersion = avatarVersion
              || refreshedUser?.user_metadata?.avatar_updated_at
              || refreshedUser?.updated_at
              || user?.updated_at
              || null;
          }
        }

        if (!avatarUrl) {
          console.log('No avatar found for user');
        }
        
        // Check if this is a full-body avatar (from uploads bucket)
        const isFullBodyAvatar = avatarUrl && (avatarUrl.includes('/uploads/') || avatarUrl.includes('/full_avatars/'));

        const img = document.getElementById('ring-avatar');
        if (img && avatarUrl) {
          // Build a stable cache seed so the browser can reuse the cached avatar between visits
          let versionToken = null;
          if (avatarVersion) {
            if (typeof avatarVersion === 'number') {
              versionToken = avatarVersion;
            } else {
              const parsedVersion = Date.parse(avatarVersion);
              if (!Number.isNaN(parsedVersion)) {
                versionToken = parsedVersion;
              }
            }
          }

          const separator = avatarUrl.includes('?') ? '&' : '?';
          const finalUrl = versionToken ? `${avatarUrl}${separator}v=${versionToken}` : avatarUrl;

          try {
            localStorage.setItem(avatarCacheKey, JSON.stringify({
              url: avatarUrl,
              version: versionToken || null,
              resolvedUrl: finalUrl
            }));
          } catch(_) { /* ignore storage errors */ }

          img.src = finalUrl;
          if (isFullBodyAvatar) {
            img.style.objectFit = 'contain';
            img.style.padding = '4px';
          }
        } else if (img) {
          try {
            const cached = JSON.parse(localStorage.getItem(avatarCacheKey) || 'null');
            if (cached?.resolvedUrl) {
              img.src = cached.resolvedUrl;
              if (cached?.url && (cached.url.includes('/uploads/') || cached.url.includes('/full_avatars/'))) {
                img.style.objectFit = 'contain';
                img.style.padding = '4px';
              }
            }
          } catch(_) { /* ignore */ }
        }

        // Small right-hand avatar removed from markup; we only use the ring avatar now
      } catch(_){}
  // Set top bar site/email/role using simple two-step site resolution
  setTopbar({ siteText: await getCurrentUserSiteText(supabase), email: user.email, role: roleDetail, access_type });
      if (!siteId){ document.getElementById('site-subtitle').textContent = 'Your staff dashboard'; }

      // Fetch live metrics: try an aggregated view first, fallback to counting submissions
      let valid = 0, due = 0, total = 0, ringPct = 0;
      try{
        // Prefer an aggregated view if available
        try {
          const agg = await supabase.from('v_submission_summary').select('valid_count,due_count,total_count').eq('site_id', siteId).eq('staff_name', displayName).maybeSingle();
          if (!agg.error && agg.data) {
            valid = Number(agg.data.valid_count || 0);
            due = Number(agg.data.due_count || 0);
            total = Number(agg.data.total_count || 0);
          }
        } catch(_) {
          // ignore - view might not exist
        }

        // If aggregation failed or returned nothing, compute counts heuristically
        if (!total) {
          // total submissions
          try {
            const tRes = await supabase.from('v_submission_detail').select('id', { head: true, count: 'exact' }).eq('site_id', siteId).eq('staff_name', displayName);
            if (!tRes.error) total = Number(tRes.count || 0);
          } catch(_){}

          // valid submissions (heuristic: check_value values that indicate pass)
          try {
            const vRes = await supabase.from('v_submission_detail').select('id', { head: true, count: 'exact' }).eq('site_id', siteId).eq('staff_name', displayName).in('check_value', ['Valid','OK','Pass','Good','Yes']);
            if (!vRes.error) valid = Number(vRes.count || 0);
          } catch(_){}

          // due = total - valid (fallback)
          due = Math.max(0, total - valid);
        }

        // Training/compliance percent: prefer an explicit profile field, otherwise
        // try computing from the training matrix (training_types + training_records).
        // If no training matrix exists for the site, fall back to the submissions heuristic.
        if (profileRow?.training_compliance_pct != null) {
          ringPct = Math.round(Number(profileRow.training_compliance_pct));
        } else if (profileRow?.training_percent != null) {
          ringPct = Math.round(Number(profileRow.training_percent));
        } else {
          try {
            if (siteId) {
              // Fetch the site's active training types and the user's training records
              const [{ data: types, error: typesErr }, { data: recs, error: recsErr }] = await Promise.all([
                supabase.from('training_types').select('id, validity_months, active').eq('site_id', siteId).eq('active', true),
                // training_records schema varies; attempt to match either user_id or staff_id
                supabase.from('training_records').select('*').eq('site_id', siteId).or(`user_id.eq.${user.id},staff_id.eq.${user.id}`)
              ]);
              if (!typesErr && types && types.length) {
                const comp = computeCompliance(types, recs || [], new Date());
                ringPct = comp.percent || 0;
              } else {
                ringPct = total ? Math.round((valid / total) * 100) : 0;
              }
            } else {
              ringPct = total ? Math.round((valid / total) * 100) : 0;
            }
          } catch (_){
            ringPct = total ? Math.round((valid / total) * 100) : 0;
          }
        }
      } catch(e){
        console.error('Error loading metrics', e);
      }

      // Update UI badges and progress bar
  const badgeValid = document.getElementById('badge-valid');
  const badgeDue = document.getElementById('badge-due');
  const badgeTotal = document.getElementById('badge-total');
  if (badgeValid) badgeValid.textContent = `${valid} valid`;
  if (badgeDue) badgeDue.textContent = `${due} due`;
  if (badgeTotal) badgeTotal.textContent = `${total} total`;
      try {
        const bar = document.getElementById('training-progress-bar');
        const lbl = document.getElementById('training-progress-label');
        if (bar) bar.style.width = `${ringPct}%`;
        if (lbl) lbl.textContent = `${ringPct}% Training`;
      } catch(_){}

      // Get kiosk_user_id from user profile
      const kioskUserId = profileRow?.kiosk_user_id;

      // Achievements: reflect persisted status first, then opportunistically unlock
      try{
        // Get all unlocked achievements and display them
        const achGrid = document.getElementById('achievements-grid');
        const noAchievements = document.getElementById('no-achievements');

        // 1) Read existing achievements from DB
        const existing = (kioskUserId) ? (await getUserAchievements(supabase, kioskUserId)) : [];
        const unlockedAchievements = (existing || []).filter(a => a.status === 'unlocked');

        // Define achievement details
        const achievementDetails = {
          'onboarding_completion': {
            name: 'Onboarding Complete',
            desc: 'Successfully completed the onboarding process!',
            icon: 'trophy',
            color: '#dcfce7'
          },
          'first_practice_quiz': {
            name: 'Practice Makes Perfect',
            desc: 'Completed your first practice quiz!',
            icon: 'star',
            color: '#dbeafe'
          },
          'first_training_upload': {
            name: 'Training Champion',
            desc: 'Uploaded your first training record!',
            icon: 'certificate',
            color: '#fef3c7'
          }
        };

        // Check for newly unlocked achievements (for animation)
        const viewedAchievements = JSON.parse(localStorage.getItem('viewedAchievements') || '[]');
        const newAchievements = unlockedAchievements
          .map(a => a.achievement_key)
          .filter(key => !viewedAchievements.includes(key));

        // Display achievements
        achGrid.innerHTML = '';
        if (unlockedAchievements.length === 0) {
          noAchievements.style.display = 'block';
          achGrid.style.display = 'none';
        } else {
          noAchievements.style.display = 'none';
          achGrid.style.display = 'grid';

          unlockedAchievements.forEach(achievement => {
            const key = achievement.achievement_key;
            const details = achievementDetails[key] || {
              name: 'Unknown Achievement',
              desc: 'You unlocked an achievement!',
              icon: 'medal',
              color: '#e0e7ff'
            };

            const isNew = newAchievements.includes(key);
            const achDiv = document.createElement('div');
            achDiv.className = 'ach' + (isNew ? ' new' : '');
            achDiv.setAttribute('data-key', key);
            achDiv.innerHTML = `
              <div class="ico" style="background:${details.color};">
                <img data-i8="${details.icon}" alt="${details.name}">
              </div>
              <div class="txt">
                <div class="name">${details.name}</div>
                <div class="desc">${details.desc}</div>
              </div>
            `;
            achGrid.appendChild(achDiv);

            // Wire up icon
            const img = achDiv.querySelector('img[data-i8]');
            if (img) {
              img.src = i8(details.icon);
            }
          });

          // Save viewed achievements
          if (newAchievements.length > 0) {
            const allViewed = [...viewedAchievements, ...newAchievements];
            localStorage.setItem('viewedAchievements', JSON.stringify(allViewed));
          }
        }

        const statusMap = new Map((existing||[]).map(r => [String(r.achievement_key), String(r.status||'locked')]));

        // 2) Compute new unlocks from live activity and upsert if needed
        const ensureUnlocked = async (key, condition) => {
          if (!kioskUserId) return;
          const already = statusMap.get(key) === 'unlocked';
          if (already) {
            // Achievement already unlocked
            return;
          }
          if (!condition) return;
          try {
            // Directly upsert to user_achievements table
            const { error } = await supabase
              .from('user_achievements')
              .upsert({
                kiosk_user_id: kioskUserId,
                user_id: user.id,  // Include user_id
                achievement_key: key,
                status: 'unlocked',
                progress_percent: 100,
                unlocked_at: new Date().toISOString()
              }, {
                onConflict: 'kiosk_user_id,achievement_key'
              });

            if (!error) {
              statusMap.set(key, 'unlocked');
              console.log('Achievement unlocked:', key);

              // Reload achievements display - removed location.reload() to prevent debugger interference
              // Instead, refresh just the achievements display
              if (typeof loadAchievements === 'function') {
                loadAchievements();
              } else if (typeof refreshAchievements === 'function') {
                refreshAchievements();
              }
            }
          } catch (e) { console.error('Upsert failed for', key, e); }
        };

        // Check if onboarding_completion achievement is already unlocked
        // It should have been unlocked during the onboarding process
        const onboardingComplete = profileRow?.onboarding_complete || false;
        if (onboardingComplete && statusMap.get('onboarding_completion') !== 'unlocked') {
          // If profile says onboarding is complete but achievement isn't unlocked, unlock it now
          await ensureUnlocked('onboarding_completion', true);
        }

        // Check if first_practice_quiz achievement should be unlocked
        // Check if user has completed any practice quizzes
        let hasCompletedPracticeQuiz = false;
        try {
          const { data: practiceData } = await supabase
            .from('quiz_practices')
            .select('id')
            .eq('user_id', user.id)
            .limit(1)
            .maybeSingle();
          hasCompletedPracticeQuiz = Boolean(practiceData);
        } catch(_) {}

        if (hasCompletedPracticeQuiz && statusMap.get('first_practice_quiz') !== 'unlocked') {
          await ensureUnlocked('first_practice_quiz', true);
        }

        // Check if first_training_upload achievement should be unlocked
        // Check if user has uploaded any training records
        let hasUploadedTraining = false;
        try {
          const { data: trainingData } = await supabase
            .from('staff_training_records')
            .select('id')
            .eq('user_id', user.id)
            .limit(1)
            .maybeSingle();
          hasUploadedTraining = Boolean(trainingData);
        } catch(_) {}

        if (hasUploadedTraining && statusMap.get('first_training_upload') !== 'unlocked') {
          await ensureUnlocked('first_training_upload', true);
        }

        // Refresh achievement display after checking
        setTimeout(() => checkAchievements(user, profileRow, kioskUserId), 100);

      }catch(e){ console.error('Achievement check failed', e); }

      // Finally load recent activity
      await loadRecentActivity(displayName, siteId);

      // Auto-refresh activity feed every 30 seconds
      setInterval(async () => {
        await loadRecentActivity(displayName, siteId);
      }, 30000);

  // Meetings moved to dedicated page
    }

    async function checkFuzzyMatches(user, profileRow) {
      try {
        // Get user's profile for name matching
        const fullName = profileRow?.full_name;
        const siteId = profileRow?.site_id;

        if (!fullName || !siteId) return;

        // Check for pending fuzzy matches
        const { data: matches, error } = await supabase
          .from('fuzzy_match_holidays')
          .select('id')
          .eq('site_id', siteId)
          .or(`matched_user_id.eq.${user.id},and(staff_name.ilike.${fullName},match_status.eq.pending)`)
          .in('match_status', ['pending', 'matched']);

        if (error) {
          console.error('Error checking fuzzy matches:', error);
          return;
        }

        // Filter to only count relevant pending matches
        const pendingMatches = matches?.filter(match => true) || [];

        if (pendingMatches.length > 0) {
          document.getElementById('fuzzy-match-count').textContent = pendingMatches.length;
          document.getElementById('fuzzy-match-notification').style.display = 'block';
        }
      } catch (error) {
        console.error('Error checking fuzzy matches:', error);
      }
    }

    async function checkQuizStatus(user, profileRow) {
      const quizAlert = document.getElementById('quiz-alert');
      const quizAlertMessage = document.getElementById('quiz-alert-message');
      const quizBubble = document.getElementById('quiz-bubble');

      try {
        const now = new Date();

        // Primary source of truth: master_users.next_quiz_due
        let nextDue = null;
        try {
          const { data: mu, error: muErr } = await supabase
            .from('master_users')
            .select('next_quiz_due, last_required_quiz_at')
            .eq('auth_user_id', user.id)
            .maybeSingle();
            
          if (!muErr && mu?.next_quiz_due) {
            nextDue = new Date(mu.next_quiz_due);
            console.log(`Quiz next due date from master_users: ${nextDue}`);
          } else {
            console.log('No next_quiz_due found in master_users table or error occurred');
          }
        } catch (e) {
          console.warn('checkQuizStatus: master_users lookup failed', e);
        }

        // 2) Fallback (legacy): derive nextDue from last non‑practice attempt if column missing
        if (!nextDue) {
          try {
            const { data: lastAny, error: lastErr } = await supabase
              .from('quiz_attempts')
              .select('completed_at,created_at')
              .eq('user_id', user.id)
              .eq('is_practice', false)
              .order('completed_at', { ascending: false, nullsFirst: false })
              .order('created_at', { ascending: false })
              .limit(1)
              .maybeSingle();
            if (!lastErr && lastAny) {
              const lastCompletedDate = lastAny.completed_at || lastAny.created_at || null;
              if (lastCompletedDate) {
                nextDue = new Date(lastCompletedDate);
                nextDue.setDate(nextDue.getDate() + 7);
              }
            }
          } catch (e) {
            console.warn('checkQuizStatus: quiz_attempts fallback failed', e);
          }
        }

        // 3) Render banner based on nextDue
        if (!nextDue || now >= nextDue) {
          // Due now or first time
          quizAlert.style.display = 'block';
          quizBubble.classList.add('due');
          if (!nextDue) {
            quizAlertMessage.textContent = 'Take your first weekly quiz now!';
          } else {
            const overdueDays = Math.floor((now - nextDue) / (1000 * 60 * 60 * 24));
            quizAlertMessage.textContent = overdueDays > 0
              ? `Quiz is ${overdueDays} day${overdueDays>1?'s':''} overdue!`
              : 'Your weekly quiz is due today!';
          }
        } else {
          const hoursUntilDue = (nextDue - now) / (1000 * 60 * 60);
          if (hoursUntilDue <= 24) {
            quizAlert.style.display = 'block';
            quizAlert.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
            quizAlertMessage.textContent = `Quiz due in ${Math.ceil(hoursUntilDue)} hour${Math.ceil(hoursUntilDue)>1?'s':''}`;
            quizBubble.classList.add('due');
          } else {
            quizAlert.style.display = 'none';
            quizBubble.classList.remove('due');
          }
        }
      } catch (error) {
        console.error('Error checking quiz status:', error);
        // Fail-safe: don’t block the page; just hide the banner
        try { quizAlert.style.display = 'none'; quizBubble.classList.remove('due'); } catch(_){}
      }
    }

    async function loadRecentActivity(displayName, siteId){
      const loadingEl = document.getElementById('recent-scans-loading');
      const timeline = document.getElementById('timeline');
      const emptyEl = document.getElementById('recent-scans-empty');

      try {
        // Get current user for user_id based queries
        const { data: { session } } = await supabase.auth.getSession();
        const userId = session?.user?.id;

        if (!userId) {
          loadingEl.style.display = 'none';
          emptyEl.style.display = 'block';
          return { count: 0 };
        }

        // Fetch activities from multiple sources
        const activities = [];
        const now = new Date();
        const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
        const oneWeekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);

        // 1. Quiz attempts
        try {
          const { data: quizData } = await supabase
            .from('quiz_attempts')
            .select('*')
            .eq('site_id', siteId)
            .order('created_at', { ascending: false })
            .limit(10);

          if (quizData) {
            quizData.forEach(q => {
              const isUserQuiz = q.user_id === userId;
              activities.push({
                timestamp: q.completed_at || q.created_at,
                type: 'quiz',
                category: 'quiz',
                title: isUserQuiz ? (q.is_practice ? 'You completed a practice quiz' : 'You completed the weekly quiz')
                                  : `${q.participant_name || 'Someone'} completed a ${q.is_practice ? 'practice' : 'weekly'} quiz`,
                detail: `Score: ${q.score_percent || 0}%`,
                status: q.score_percent >= 80 ? 'success' : 'warning',
                icon: '🧠',
                isOwn: isUserQuiz,
                color: q.score_percent >= 80 ? '#10b981' : '#f59e0b'
              });
            });
          }
        } catch(e) {
          console.log('Could not fetch quiz attempts:', e);
        }

        // 2. Training records
        try {
          const { data: trainingData } = await supabase
            .from('staff_training_records')
            .select('*')
            .eq('site_id', siteId)
            .order('created_at', { ascending: false })
            .limit(10);

          if (trainingData) {
            trainingData.forEach(t => {
              const isUserTraining = t.user_id === userId;
              activities.push({
                timestamp: t.created_at,
                type: 'training',
                category: 'training',
                title: isUserTraining ? `You uploaded ${t.training_type || 'training'}`
                                      : `${t.staff_name || 'Someone'} uploaded ${t.training_type || 'training'}`,
                detail: t.status || 'Certificate uploaded',
                status: 'info',
                icon: '🎓',
                isOwn: isUserTraining,
                color: '#8b5cf6'
              });
            });
          }
        } catch(e) {
          console.log('Could not fetch training records:', e);
        }

        // 3. New team members (from master_users)
        try {
          const { data: newMembers } = await supabase
            .from('master_users')
            .select('auth_user_id, full_name, avatar_url, created_at, nickname')
            .eq('site_id', siteId)
            .gte('created_at', oneWeekAgo.toISOString())
            .order('created_at', { ascending: false })
            .limit(5);

          if (newMembers) {
            for (const member of newMembers) {
              const isUser = member.auth_user_id === userId;
              activities.push({
                timestamp: member.created_at,
                type: 'new_member',
                category: 'team',
                title: isUser ? 'Welcome! You joined the team! 🎉'
                             : `${member.nickname || member.full_name || 'A new member'} joined the team!`,
                detail: isUser ? 'Great to have you here!' : 'Let\'s give them a warm welcome!',
                status: 'celebration',
                icon: '🎊',
                avatar: member.avatar_url,
                isOwn: isUser,
                color: '#ec4899',
                isNew: new Date(member.created_at) > oneDayAgo
              });
            }
          }
        } catch(e) {
          console.log('Could not fetch new members:', e);
        }

        // 4. Profile updates (nickname/avatar changes)
        try {
          const { data: profileUpdates } = await supabase
            .from('master_users')
            .select('auth_user_id, full_name, nickname, avatar_url, updated_at')
            .eq('site_id', siteId)
            .gte('updated_at', oneWeekAgo.toISOString())
            .order('updated_at', { ascending: false })
            .limit(10);

          if (profileUpdates) {
            profileUpdates.forEach(p => {
              const isUser = p.auth_user_id === userId;

              // Check if updated recently (not at creation)
              if (p.updated_at && new Date(p.updated_at) > new Date(p.created_at || 0)) {
                activities.push({
                  timestamp: p.updated_at,
                  type: 'profile_update',
                  category: 'profile',
                  title: isUser ? 'You updated your profile'
                               : `${p.nickname || p.full_name || 'Someone'} updated their profile`,
                  detail: 'Profile refreshed ✨',
                  status: 'info',
                  icon: '👤',
                  avatar: p.avatar_url,
                  isOwn: isUser,
                  color: '#6366f1'
                });
              }
            });
          }
        } catch(e) {
          console.log('Could not fetch profile updates:', e);
        }

        // 5. Holiday requests (support both names)
        try {
          let holidays = null;

          // First, canonical table name
          const canonical = await supabase
            .from('holiday_requests')
            .select('*')
            .eq('site_id', siteId)
            .order('created_at', { ascending: false })
            .limit(10);

          if (!canonical.error && canonical.data?.length) {
            holidays = canonical.data;
          } else {
            // Fallback to legacy "4_holiday_requests" table
            const legacy = await supabase
              .from('4_holiday_requests')
              .select('*')
              .eq('site_id', siteId)
              .order('created_at', { ascending: false })
              .limit(10);

            if (!legacy.error) holidays = legacy.data;
          }

          // Updated: skip showing approved holidays for other people
          if (holidays?.length) {
            holidays.forEach(h => {
              const isUserHoliday = h.user_id === userId;

              // ✂️ Do not show when someone else's holiday is approved
              if (h.status === 'approved' && !isUserHoliday) {
                return; // skip this activity
              }

              let title, icon, color;

              if (h.status === 'approved') {
                title = isUserHoliday
                  ? 'Your holiday was approved! ✅'
                  : `${h.staff_name || 'Someone'}’s holiday approved`;
                icon = '🏖️';
                color = '#10b981';
              } else if (h.status === 'declined' || h.status === 'rejected') {
                title = isUserHoliday
                  ? 'Your holiday request was declined'
                  : `${h.staff_name || 'Someone'}’s holiday declined`;
                icon = '📅';
                color = '#ef4444';
              } else {
                title = isUserHoliday
                  ? 'You requested holiday'
                  : `${h.staff_name || 'Someone'} requested holiday`;
                icon = '📆';
                color = '#06b6d4';
              }

              activities.push({
                timestamp: h.updated_at || h.created_at,
                type: 'holiday',
                category: 'holiday',
                title,
                detail: `${h.start_date} – ${h.end_date}`,
                status: h.status,
                icon,
                isOwn: isUserHoliday,
                color
              });
            });
          }
        } catch (e) {
          console.log('Could not fetch holiday requests:', e);
        }

        // 6. Meeting participation
        try {
          const { data: meetingData } = await supabase
            .from('meetings')
            .select('*')
            .eq('site_id', siteId)
            .order('created_at', { ascending: false })
            .limit(5);

          if (meetingData) {
            meetingData.forEach(m => {
              const isUserMeeting = m.user_id === userId || m.organizer_id === userId;
              activities.push({
                timestamp: m.meeting_date || m.created_at,
                type: 'meeting',
                category: 'meeting',
                title: isUserMeeting ? `You have a ${m.type || 'meeting'}`
                                    : `Team ${m.type || 'meeting'} scheduled`,
                detail: m.status || 'Scheduled',
                status: 'info',
                icon: '👥',
                isOwn: isUserMeeting,
                color: '#0891b2'
              });
            });
          }
        } catch(e) {
          console.log('Could not fetch meetings:', e);
        }

        // Sort all activities by timestamp (most recent first)
        activities.sort((a, b) => {
          const dateA = new Date(a.timestamp || 0);
          const dateB = new Date(b.timestamp || 0);
          return dateB - dateA;
        });

        // Take only the 15 most recent activities
        const recentActivities = activities.slice(0, 15);

        loadingEl.style.display = 'none';

        if (recentActivities.length === 0) {
          emptyEl.style.display = 'block';
          emptyEl.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.6);">
              <div style="font-size: 48px; margin-bottom: 16px;">🎯</div>
              <div style="font-size: 16px; font-weight: 500;">No recent activity yet</div>
              <div style="font-size: 14px; margin-top: 8px;">Activities will appear here as you and your team use CheckLoop</div>
            </div>
          `;
          return { count: 0 };
        }


        // Render the activities with improved cards
        timeline.style.display = 'block';

        // Store previous scroll position to maintain it after update
        const previousScrollTop = timeline.scrollTop;

        timeline.innerHTML = recentActivities.map((activity, index) => {
          const categoryClasses = {
            'team': 'new-member',
            'holiday': 'holiday-request',
            'profile': 'profile-update'
          };

          const cardClass = categoryClasses[activity.category] || '';
          // Determine NEW badge and avoid permanently marking everything as new.
          // Logic: prefer explicit activity.isNew flag. Otherwise mark as new only if within a short threshold
          // and the activity hasn't been seen by this user before (stored in localStorage).
          const NEW_THRESHOLD_MS = 6 * 60 * 60 * 1000; // 6 hours
          const seenKey = 'seenActivities_v1';
          let seenActivities = [];
          try { seenActivities = JSON.parse(localStorage.getItem(seenKey) || '[]'); } catch(_) { seenActivities = []; }
          const activityId = activity.id || `${activity.type}|${activity.timestamp}`;
          const withinThreshold = (new Date(activity.timestamp) > new Date(Date.now() - NEW_THRESHOLD_MS));
          const explicitNew = activity.isNew === true;
          const isNew = explicitNew || (withinThreshold && !seenActivities.includes(activityId));
          const animationDelay = index * 0.05;

          return `
            <div class="activity-card ${cardClass} ${activity.type === 'new_member' ? 'activity-celebration' : ''}"
                 style="--card-color-start: ${activity.color}; --card-color-end: ${activity.color}dd; animation-delay: ${animationDelay}s;">
              <div style="display: flex; gap: 12px; align-items: flex-start;">
                ${activity.avatar ? `
                  <div style="position: relative; flex-shrink: 0;">
                    <img src="${activity.avatar}" class="activity-avatar" alt="Avatar"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="display: none; width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, ${activity.color}40, ${activity.color}20); align-items: center; justify-content: center; font-size: 18px;">
                      ${activity.icon}
                    </div>
                  </div>
                ` : `
                  <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, ${activity.color}40, ${activity.color}20); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
                    ${activity.icon}
                  </div>
                `}

                <div style="flex: 1; min-width: 0;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <div style="color: #0f172a; font-weight: 600; font-size: 14px;">
                      ${activity.title}
                      ${isNew ? '<span class="activity-new-badge">NEW</span>' : ''}
                    </div>
                  </div>

                  ${activity.detail ? `
                    <div style="color: #334155; font-size: 13px; margin-bottom: 6px;">
                      ${activity.detail}
                    </div>
                  ` : ''}

                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="color: #475569; font-size: 11px;">
                      ${fmtDate(activity.timestamp)}
                    </div>
                    ${activity.isOwn ? `
                      <div style="display: inline-block; padding: 2px 6px; background: ${activity.color}15; color: ${activity.color}; border: 1px solid ${activity.color}30; border-radius: 6px; font-size: 10px; font-weight: 600;">
                        YOU
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        // Restore scroll position after update
        timeline.scrollTop = previousScrollTop;

        // Persist seen activities so that items don't show NEW repeatedly.
        try {
          const displayedIds = recentActivities.map(a => a.id || `${a.type}|${a.timestamp}`).filter(Boolean);
          // Merge with existing seen list and keep unique
          const existing = JSON.parse(localStorage.getItem('seenActivities_v1') || '[]');
          const merged = Array.from(new Set([...(existing || []), ...displayedIds]));
          // Save after a short delay to avoid race conditions while the user is scanning the list
          setTimeout(() => {
            try { localStorage.setItem('seenActivities_v1', JSON.stringify(merged)); } catch(_) {}
          }, 5000);
        } catch(_) {}

        return { count: recentActivities.length };

      } catch(e) {
        console.error('Activity load error', e);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
        emptyEl.innerHTML = `
          <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6);">
            <div style="font-size: 14px;">Unable to load activities</div>
          </div>
        `;
        return { count: 0 };
      }
    }

    // No training table on the new Home. We'll surface training in its own page.
    
  // Meetings code removed from home page
  </script>

  <script>
    (function(){
      function i8(name, opts){
        opts = opts || {}; 
        var style = opts.style || 'dusk';
        var size  = (opts.size == null) ? 48 : opts.size; // default 48px
        var base  = 'https://img.icons8.com';
        // Icons8 OMG-IMG pattern is style/size/name.png
        var path  = [style, String(size || 48), encodeURIComponent(name) + '.png'].join('/');
        return base + '/' + path;
      }
      function setIcon(el){
        var name  = el.getAttribute('data-i8');
        var size  = el.getAttribute('data-i8-size');
        var style = el.getAttribute('data-i8-style') || 'fluency';
        var fallback = (el.getAttribute('data-i8-fallback') || '').toLowerCase();
        
        if (fallback === 'auto') {
          var stylesToTry = [style, 'fluency', 'color'];
          var idx = 0;
          function tryNext(){
            if (idx >= stylesToTry.length) { el.onerror = null; return; }
            var url = i8(name, {style: stylesToTry[idx++], size: size ? parseInt(size,10) : undefined});
            if (el.src !== url) el.src = url; else tryNext();
          }
          el.onerror = tryNext;
          tryNext();
        } else {
          // Strict mode: stay in the requested style (default: dusk)
          var url = i8(name, {style: style, size: size ? parseInt(size,10) : undefined});
          el.src = url;
          el.onerror = null;
        }
        if (!el.alt) el.alt = (name || '').replace(/[\-_]/g,' ');
      }
      function wireIcons(){
        document.querySelectorAll('img[data-i8]').forEach(setIcon);
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', wireIcons);
      else wireIcons();
      window.i8 = i8; // optional helper for manual usage
    })();
  </script>
  
  <script>
    // Setup Help Tour Button
    function setupHelpTourButton(profileRow, session) {
      const helpBtn = document.getElementById('help-tour-btn');
      if (!helpBtn) return;

      helpBtn.addEventListener('click', () => {
        if (!window.CLWelcomeTour) {
          console.warn('Welcome tour not available');
          return;
        }

        const role = (profileRow?.access_type || profileRow?.role || session.user?.raw_user_meta_data?.role || '').toLowerCase();
        
        const steps = [
          { 
            selector: '#welcome', 
            title: 'Welcome to CheckLoop Staff! 👋', 
            body: 'This is your personal dashboard where you can access all staff tools, track your progress, and stay compliant with training requirements.' 
          },
          { 
            selector: '.nav', 
            title: 'Navigation Menu', 
            body: 'Use the top navigation to access different areas: Staff tools, Training modules, Admin functions (if you have access), and your profile settings.' 
          },
          { 
            selector: '#compliance-ring', 
            title: 'Your Training Compliance 📊', 
            body: 'This ring shows your overall training completion status. Keep it at 100% to maintain compliance! The ring fills up as you complete required training modules.' 
          },
          { 
            selector: '.bubble-actions', 
            title: 'Quick Action Hub ⚡', 
            body: 'These are your most-used tools: Scans for patient records, Training for courses, Holidays for time off, and Quiz for weekly assessments.' 
          },
          { 
            selector: 'a[href="staff-scans.html"]', 
            title: 'My Scans 📋', 
            body: 'Access and manage patient scan records. This is where you\'ll spend most of your clinical work time.' 
          },
          { 
            selector: 'a[href="staff-training.html"]', 
            title: 'Training Center 🎓', 
            body: 'Complete mandatory training modules, view certificates, and track your learning progress. Essential for maintaining compliance!' 
          },
          { 
            selector: '#quiz-bubble', 
            title: 'Weekly Quiz 🧠', 
            body: 'Complete your required weekly knowledge assessments here. The bubble will glow when a quiz is due!' 
          },
          { 
            selector: '.progress-wrap', 
            title: 'Training Progress Tracker 📈', 
            body: 'This bar shows your overall training completion percentage. Aim to keep this at 100% to stay compliant with requirements.' 
          },
          { 
            selector: '#training-card', 
            title: 'Personal Training Dashboard 📊', 
            body: 'This card shows your training compliance, with counts of up-to-date and due items. Keep this at 100% to maintain full compliance with requirements.' 
          },
          { 
            selector: '#scans-card', 
            title: 'Your Scan Activity 🔍', 
            body: 'Track your scanning activity across different time periods. This gives you a quick overview of your recent workload.' 
          },
          { 
            selector: '#holiday-card', 
            title: 'Holiday Entitlement 🏝️', 
            body: 'See your holiday balance, days used, and upcoming holidays. Plan your time off with this handy tracker.' 
          },
          { 
            selector: '#quiz-card', 
            title: 'Quiz Performance 🧠', 
            body: 'Keep track of your quiz scores and passing rate. Regular quizzes help maintain your clinical knowledge.' 
          },
          { 
            selector: '#timeline', 
            title: 'Recent Activity 📅', 
            body: 'Track your recent scans, training completions, and other activities. Great for staying on top of your work!' 
          },
          { 
            selector: '.topbar .pill', 
            title: 'Your Profile Info 👤', 
            body: 'These pills show your current site, email, and role. Make sure everything looks correct!' 
          }
        ];

        // Add admin-specific step if user is admin/owner
        if (role === 'admin' || role === 'owner') {
          steps.push({ 
            selector: '#admin-access-panel', 
            title: 'Admin Panel 🔧', 
            body: 'As an admin, you have access to the Admin Site for managing users, viewing reports, and configuring system settings.' 
          });
        }

        // Add final step
        steps.push({ 
          selector: '#logout-btn', 
          title: 'Sign Out Securely 🔒', 
          body: 'Always remember to sign out when you\'re done, especially on shared computers. Security is important! You\'re all set - enjoy using CheckLoop!' 
        });

        window.CLWelcomeTour.show(steps);
      });
    }
  </script>

  <script>
    // Create animated particles - only on staff home page
    // DISABLED: Commenting out particle animation to improve performance
    // Uncomment the block below to re-enable particles
    /*
    (function() {
      function createParticles() {
        // Only create particles if we're on the staff home page
        if (!document.body.classList.contains('staff-home-particles')) return;

        const particlesContainer = document.getElementById('particles');
        if (!particlesContainer) return;

        // Clear any existing particles
        particlesContainer.innerHTML = '';

        const particleCount = 35;
        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';

          // Randomize starting positions around screen edges
          const edge = Math.random() * 4;
          if (edge < 1) {
            // Bottom edge
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = '100vh';
          } else if (edge < 2) {
            // Left edge
            particle.style.left = '-10px';
            particle.style.top = Math.random() * 100 + '%';
          } else if (edge < 3) {
            // Right edge
            particle.style.left = '100vw';
            particle.style.top = Math.random() * 100 + '%';
          } else {
            // Top edge (some particles start from top)
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = '-10px';
          }

          // Random animation delay to stagger particles
          particle.style.animationDelay = Math.random() * 40 + 's';

          // Vary animation duration slightly for more natural feel
          const baseDuration = 25 + Math.random() * 15; // 25-40s
          particle.style.animationDuration = baseDuration + 's';

          particlesContainer.appendChild(particle);
        }
      }

      // Add mouse tracking for interactive effects
      document.addEventListener('mousemove', function(e) {
        const cards = document.querySelectorAll('.stat-card');
        cards.forEach(card => {
          const rect = card.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          card.style.setProperty('--mouse-x', x + '%');
          card.style.setProperty('--mouse-y', y + '%');
        });
      });

      // Initialize particles when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createParticles);
      } else {
        createParticles();
      }

      // Refresh particles every 2 minutes to keep the effect dynamic
      setInterval(createParticles, 120000);
    })();
    */
  </script>

  <script src="welcome-tour.js"></script>
  <!-- Debug Console - Persistent across all pages -->
  <script src="debug-console.js"></script>
    <script src="supabase-debug.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop ‚Äî Staff</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <link rel="stylesheet" href="staff.css">
  <style>
    .hero{ display:flex; gap:18px; align-items:center; flex-wrap:wrap; }
    .ring{ width:120px; height:120px; position:relative; display:grid; place-items:center; }
    .ring .ring-progress{ position:absolute; inset:0; border-radius:50%; background:conic-gradient(var(--accent) 0deg, #ffffff24 0deg); }
    .ring .ring-hole{ position:absolute; inset:10px; background: var(--panel-bg); border-radius:50%; border:1px solid var(--border-color); box-shadow: inset 0 0 40px #0000001f; }
    .ring .ring-label{ position:relative; font-weight:800; font-size:22px; }
    .quick-actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .quick-actions .btn{ display:flex; align-items:center; gap:8px; }
    .timeline{ display:grid; gap:10px; }
    .t-item{ display:grid; grid-template-columns: 120px 1fr auto; gap:10px; align-items:center; padding:10px; background:var(--glass); border:1px solid var(--glass-2); border-radius:12px; }
    .t-item .pill{ background:#ffffff1e; }
    .subtle{ opacity:.9; }
  </style>
</head>
<body>
  <div class="bg"><div class="wave"></div><div class="wave wave2"></div></div>
  <main class="content">
    <div class="topbar panel">
      <div class="nav">
        <a href="staff.html" data-page="home" class="active">Home</a>
        <a href="staff-scans.html" data-page="scans">My Scans</a>
        <a href="staff-training.html" data-page="training">My Training</a>
        <a href="staff-quiz.html" data-page="quiz">Quiz</a>
      </div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: ‚Äî</div>
      <div class="pill" id="email-pill">‚Äî</div>
      <div class="pill" id="role-pill">‚Äî</div>
      <a class="btn secondary" href="Home.html">New Scan</a>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>

    <section class="panel g-12" style="margin:0;">
      <div class="hero">
        <div class="ring" id="compliance-ring" title="Training compliance">
          <div class="ring-progress"></div>
          <div class="ring-hole"></div>
          <div class="ring-label">0%</div>
        </div>
        <div style="min-width:200px;">
          <div class="muted" id="site-subtitle">Loading your profile‚Ä¶</div>
          <div class="h1" id="welcome">Welcome</div>
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;" class="subtle">
            <span class="badge ok" id="badge-valid">0 valid</span>
            <span class="badge warn" id="badge-due">0 due</span>
            <span class="badge info" id="badge-total">0 total</span>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="quick-actions">
          <a class="btn" href="Home.html">‚ûï New Scan</a>
          <a class="btn secondary" href="staff-training.html">üìö Training</a>
          <a class="btn secondary" href="staff-quiz.html">üß† Quick Quiz</a>
        </div>
      </div>
      <div class="stat-row" style="margin-top:14px;">
        <div class="g-4">
          <div class="stat-card" style="--c: var(--stat-1-bg); --i: var(--stat-1-color)">
            <div class="icon-wrap">üßæ</div>
            <div>
              <div class="stat-num" id="kpi-scans">0</div>
              <div class="stat-label">Your scans (7‚Äì30d)</div>
            </div>
          </div>
        </div>
        <div class="g-4">
          <div class="stat-card" style="--c: var(--stat-2-bg); --i: var(--stat-2-color)">
            <div class="icon-wrap">‚úÖ</div>
            <div>
              <div class="stat-num" id="kpi-training-ok">0</div>
              <div class="stat-label">Training valid</div>
            </div>
          </div>
        </div>
        <div class="g-4">
          <div class="stat-card" style="--c: var(--stat-4-bg); --i: var(--stat-4-color)">
            <div class="icon-wrap">‚ö†Ô∏è</div>
            <div>
              <div class="stat-num" id="kpi-training-due">0</div>
              <div class="stat-label">Due / expired</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="grid">
      <div class="panel g-8">
        <div class="panel-header"><div class="panel-title">Recent Activity</div></div>
        <div id="recent-scans-loading" class="empty">Loading‚Ä¶</div>
        <div class="timeline" id="timeline" style="display:none;"></div>
        <div id="recent-scans-empty" class="empty" style="display:none">No activity yet. Use New Scan to get started.</div>
      </div>

      <div class="panel g-4">
        <div class="panel-header"><div class="panel-title">Mandatory Training</div></div>
        <div id="training-loading" class="empty">Loading‚Ä¶</div>
        <div class="table-wrap" id="training-wrap" style="display:none;">
          <table id="training-table">
            <thead><tr><th>Course</th><th>Status</th><th class="right">Valid until</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="training-empty" class="empty" style="display:none">No training records found yet.</div>
      </div>

      <div class="panel g-12">
        <div class="panel-header"><div class="panel-title">My Details</div></div>
        <div id="my-details"><div class="empty">Loading‚Ä¶</div></div>
        <div class="muted" style="font-size:12px; margin-top:8px;">Only you can see this page. Data shown respects your site's permissions.</div>
      </div>
    </div>

    <div class="muted" style="text-align:center; font-size:12px; padding:10px 0;">¬© CheckLoop ‚Ä¢ Staff Dashboard</div>
  </main>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, animateNumber, setRing, fmtDate, daysBetween, computeCompliance } from './staff-common.js';
    const supabase = await initSupabase();
    handleAuthState(supabase);

    let isLoggingOut = false;
    function cleanupAndRedirect() {
      try { localStorage.clear(); } catch(_) {}
      try { sessionStorage.clear(); } catch(_) {}
      try { document.cookie.split(';').forEach(c => document.cookie = c.replace(/^ +/, '').replace(/=.*/, `=;expires=${new Date(0).toUTCString()};path=/`)); } catch(_) {}
      window.location.replace('Home.html?_=' + Date.now());
    }
    async function forceLogout() {
      if (isLoggingOut) return;
      isLoggingOut = true;
      try { const { data } = await supabase.auth.getSession(); if (data?.session) await supabase.auth.signOut(); } catch (e) { console.error('Supabase signOut failed:', e); }
      cleanupAndRedirect();
    }
    document.getElementById('logout-btn').addEventListener('click', async (e) => { e.preventDefault(); e.stopPropagation(); await forceLogout(); });

    requireStaffSession(supabase).then(async ({ session, profileRow }) => {
      await loadDashboard(session.user, profileRow);
    }).catch(e => {
      if (String(e.message).includes('NO_SESSION')) { window.location.replace('Home.html'); return; }
      if (String(e.message).includes('NOT_STAFF')) { window.location.replace('index.html'); return; }
      console.error(e);
    });

    async function loadDashboard(user, profileRow){
      const displayName = profileRow?.full_name || user?.raw_user_meta_data?.full_name || (user?.email?.split('@')[0]) || 'Staff Member';
      const siteId = profileRow?.site_id || user?.raw_user_meta_data?.site_id || null;
      const roleDetail = user?.raw_user_meta_data?.role_detail || 'Staff';

      document.getElementById('welcome').textContent = `Welcome, ${displayName}`;
      setTopbar({ siteText: await getSiteText(supabase, siteId), email: user.email, role: roleDetail });
      if (!siteId){ document.getElementById('site-subtitle').textContent = 'Your staff dashboard'; }

      const [scanData, trainingData] = await Promise.all([
        loadRecentActivity(displayName, siteId),
        loadTraining(displayName, siteId, roleDetail)
      ]);

      // KPIs
      animateNumber(document.getElementById('kpi-scans'), scanData.count);
      animateNumber(document.getElementById('kpi-training-ok'), trainingData.ok);
      animateNumber(document.getElementById('kpi-training-due'), trainingData.due);
      setRing(document.getElementById('compliance-ring'), trainingData.percent);
      document.getElementById('badge-valid').textContent = `${trainingData.ok} valid`;
      document.getElementById('badge-due').textContent = `${trainingData.due} due`;
      document.getElementById('badge-total').textContent = `${trainingData.total} total`;
    }

    async function loadRecentActivity(displayName, siteId){
      const loadingEl = document.getElementById('recent-scans-loading');
      const timeline = document.getElementById('timeline');
      const emptyEl = document.getElementById('recent-scans-empty');
      try{
        let rows = [];
        if (siteId){
          const v = await supabase
            .from('v_submission_detail')
            .select('submitted_at,item_name,room,check_type,check_value,staff_name,site_id')
            .eq('site_id', siteId)
            .eq('staff_name', displayName)
            .order('submitted_at', { ascending:false })
            .limit(10);
          if (!v.error && v.data) rows = v.data;
        }
        if (!rows?.length){
          const s = await supabase
            .from('submissions')
            .select('submitted_at, staff_name, comment')
            .eq('staff_name', displayName)
            .order('submitted_at', { ascending:false })
            .limit(5);
          if (!s.error && s.data){ rows = s.data.map(r => ({ submitted_at:r.submitted_at, item_name:'‚Äî', room:'‚Äî', check_type:'‚Äî', check_value:r.comment||'Done' })); }
        }
        loadingEl.style.display='none';
        if (!rows?.length){ emptyEl.style.display='block'; return { count: 0 }; }
        timeline.style.display='grid';
        timeline.innerHTML = rows.map(r => `
          <div class="t-item">
            <div class="muted">${fmtDate(r.submitted_at)}</div>
            <div><strong>${r.item_name || '‚Äî'}</strong> ¬∑ ${r.check_type || '‚Äî'} ‚Üí <span class="muted">${r.check_value || '‚Äî'}</span></div>
            <div class="pill">${r.room || '‚Äî'}</div>
          </div>`).join('');
        return { count: rows.length };
      } catch(e){
        console.error('Activity load error', e);
        loadingEl.style.display='none';
        emptyEl.style.display='block';
        return { count: 0 };
      }
    }

    async function loadTraining(displayName, siteId, roleDetail){
      const loadingEl = document.getElementById('training-loading');
      const wrap = document.getElementById('training-wrap');
      const tbody = document.querySelector('#training-table tbody');
      const emptyEl = document.getElementById('training-empty');
      let required = [], myRecords = [];
      try{
        const clinical = /doctor|nurse|clin|pharmacist/i.test(roleDetail || '');
        if (siteId){
          const tt = await supabase
            .from('training_types')
            .select('id,name,validity_months,is_clinical_required,is_non_clinical_required,active')
            .eq('site_id', siteId)
            .eq('active', true);
          const allTypes = (!tt.error && tt.data) ? tt.data : [];
          required = allTypes.filter(t => clinical ? t.is_clinical_required : t.is_non_clinical_required);
        }
        let kioskId = null;
        if (siteId){
          const ku = await supabase
            .from('kiosk_users')
            .select('id')
            .eq('site_id', siteId)
            .eq('full_name', displayName)
            .maybeSingle();
          kioskId = ku?.data?.id || null;
        }
        if (siteId && kioskId){
          const tr = await supabase
            .from('training_records')
            .select('id,training_type_id,completion_date,expiry_date,certificate_url')
            .eq('site_id', siteId)
            .eq('staff_id', kioskId);
          if (!tr.error && tr.data) myRecords = tr.data;
        }
        const now = new Date();
        const comp = computeCompliance(required, myRecords, now);
        const rows = (required.length ? required : []).map(t => {
          const recs = myRecords.filter(r => r.training_type_id === t.id);
          const latest = recs.sort((a,b)=> new Date(b.expiry_date||b.completion_date||0) - new Date(a.expiry_date||a.completion_date||0))[0];
          let statusHtml = '<span class="badge info">Not started</span>';
          let validUntil = '‚Äî';
          if (latest){
            const expiry = latest.expiry_date || (t.validity_months ? new Date(new Date(latest.completion_date).setMonth(new Date(latest.completion_date).getMonth()+Number(t.validity_months))) : null);
            if (expiry){
              const days = daysBetween(expiry, now);
              validUntil = new Date(expiry).toLocaleDateString();
              if (days < 0){ statusHtml = '<span class="badge danger">Expired</span>'; }
              else if (days <= 30){ statusHtml = '<span class="badge warn">Due soon</span>'; }
              else { statusHtml = '<span class="badge ok">Valid</span>'; }
            } else {
              statusHtml = '<span class="badge ok">Completed</span>';
            }
          }
          return `<tr><td>${t.name}</td><td>${statusHtml}</td><td class="right">${validUntil}</td></tr>`;
        });
        loadingEl.style.display='none';
        if (!rows.length){ emptyEl.style.display='block'; }
        else { wrap.style.display=''; tbody.innerHTML = rows.join(''); }
        return comp;
      } catch(e){
        console.error('Training load error', e);
        loadingEl.style.display='none';
        emptyEl.style.display='block';
        return { ok:0, due:0, total:0, percent:0 };
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — Staff</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://img.icons8.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <link rel="stylesheet" href="staff.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Page-specific tweaks only; core styles live in staff.css */
    .subtitle{ color:#64748b; font-weight:600; }
    .staff-avatar{ width:64px; height:64px; border-radius:50%; background:#fff; background-size:cover; background-position:center; box-shadow:0 4px 10px rgba(2,6,23,.10); border:1px solid var(--border-color); }
    .staff-hero-avatar{ width:96px; height:96px; border-radius:50%; background:#fff; background-size:cover; background-position:center; box-shadow:0 6px 16px rgba(2,6,23,.12); border:1px solid var(--border-color); }
    
    /* Quiz Alert Styles */
    .quiz-alert {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      border: 2px solid #fbbf24;
      animation: slideInDown 0.6s ease-out, pulseGlow 2s infinite;
    }
    
    .quiz-alert-content {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
    }
    
    .quiz-alert-icon {
      width: 40px;
      height: 40px;
      animation: bounce 2s infinite;
    }
    .quiz-alert-icon img { width: 100%; height: 100%; display:block; }
    
    .quiz-alert-text {
      flex: 1;
    }
    
    .quiz-alert-title {
      font-weight: 800;
      font-size: 1.2em;
      margin-bottom: 4px;
    }
    
    .quiz-alert-subtitle {
      font-size: 0.9em;
      opacity: 0.9;
    }
    
    .quiz-alert-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .quiz-alert-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    
    /* Quiz Bubble Animation */
    .quiz-bubble {
      position: relative;
    }
    
    .quiz-bubble.due {
      animation: pulse 2s infinite;
    }
    
    .quiz-bubble.due::after {
      content: '!';
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ef4444;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 12px;
      animation: bounce 1.5s infinite;
    }
    
    /* Animations */
    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulseGlow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
      }
      50% {
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }
    
    /* Meetings Section Styles — High‑contrast redesign */
    .meetings-section { margin-top: 20px; }

    .meetings-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      border-bottom: 2px solid #dbe2ea;
      align-items: flex-end;
    }

    .meetings-tab {
      padding: 10px 14px;
      background: #f3f5f8;
      color: #0f172a;
      border: 1px solid #cbd5e1;
      border-bottom: 3px solid transparent;
      border-radius: 10px 10px 0 0;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s ease, color .2s ease, border-color .2s ease, transform .1s ease;
    }
    
    .btn-generate-pdf {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
    }
    
    .meeting-history-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .meeting-history-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .meeting-form-group {
      margin-bottom: 15px;
    }
    
    .meeting-form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #374151;
    }
    
    .meeting-form-group input,
    .meeting-form-group textarea,
    .meeting-form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: inherit;
      color: #e6f0ff;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .meeting-form-group select option {
      color: #333;
      background: white;
    }
    
    .attendees-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    .attendee-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .attendee-badge.accepted {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .attendee-badge.declined {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .attendee-badge.pending {
      background: #fef3c7;
      color: #d97706;
    }
  </style>
</head>
<body class="staff-home-particles">
  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
    <div class="particles" id="particles"></div>
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>
  </div>
  <div class="mesh" aria-hidden="true"><div class="m1"></div><div class="m2"></div><div class="m3"></div></div>
  
  <!-- Floating orbs for extra depth -->
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <div class="orb orb3"></div>
  <main class="content">
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav">
        <!-- Navigation will be rendered by staff-common.js -->
      </div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: —</div>
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>

    <section class="panel g-12" style="margin:0; position:relative; overflow:hidden;">
      <div class="halo"></div>
      
      <!-- Quiz Due Alert -->
      <div id="quiz-alert" class="quiz-alert" style="display:none;">
        <div class="quiz-alert-content">
          <div class="quiz-alert-icon"><img data-i8="brain" data-i8-size="48" alt="Quiz"></div>
          <div class="quiz-alert-text">
            <div class="quiz-alert-title">Weekly Quiz Due!</div>
            <div class="quiz-alert-subtitle" id="quiz-alert-message">Complete your required knowledge check</div>
          </div>
          <a href="staff-quiz.html" class="quiz-alert-btn">Take Quiz</a>
        </div>
      </div>
      
      <div class="hero">
        <div class="ring bounce" id="compliance-ring" title="Training compliance" style="position:relative;">
          <div class="ring-progress"></div>
          <div class="ring-hole"></div>
          <img id="ring-avatar" alt="Avatar" />
        </div>
        <div style="min-width:200px;">
          <div class="subtitle" id="site-subtitle"></div>
          <div class="h1" id="welcome" style="font-size:32px;">Welcome</div>
          <!-- Badges removed as requested -->
        </div>
  <div class="spacer"></div>
        <div class="bubble-actions" aria-label="Quick actions">
          <a class="bubble" href="staff-scans.html">
            <div class="i c-purple"><img data-i8="document" data-i8-size="48" alt="My Scans"/></div>
            <div class="t">My Scans</div>
          </a>
          <a class="bubble" href="staff-training.html">
            <div class="i c-blue"><img data-i8="graduation-cap" data-i8-size="48" alt="Training"/></div>
            <div class="t">Training</div>
          </a>
          <a class="bubble" href="my-holidays.html">
            <div class="i c-green"><img data-i8="calendar" data-i8-size="48" alt="My Holidays"/></div>
            <div class="t">My Holidays</div>
          </a>
          <a class="bubble quiz-bubble" href="staff-quiz.html" id="quiz-bubble">
            <div class="i c-orange"><img data-i8="puzzle" data-i8-size="48" alt="Quiz"/></div>
            <div class="t">Quiz</div>
          </a>
        </div>
      </div>
      <div class="progress-wrap" style="margin-top:10px; padding:0 8px;">
        <div class="progress" style="height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; border:1px solid var(--border-color);">
          <div id="training-progress-bar" class="bar" style="height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#a78bfa);"></div>
        </div>
        <div id="training-progress-label" class="meta-note" style="text-align:right; margin-top:4px;">0% Training</div>
      </div>
      <div class="tile-grid" style="margin-top:14px;">
        <div class="tile">
          <div class="panel-header" style="align-items:center; gap:10px;">
            <div class="illus-circle"><img data-i8="medal" alt="Achievements"></div>
            <div class="panel-title">Achievements</div>
          </div>
          <div class="ach-grid">
            <div class="ach">
            <div class="ico" style="background:#dcfce7;"><img data-i8="confetti" alt="First Login"></div>
              <div class="txt"><div class="name">First Login</div><div class="desc">Welcome aboard! You’re in.</div></div>
            </div>
            <div class="ach locked">
              <div class="ico" style="background:#fef3c7;"><img data-i8="clock" alt="On-Time"></div>
              <div class="txt"><div class="name">On‑Time Checker</div><div class="desc">Do today’s check before 10am.</div></div>
            </div>
            <div class="ach locked">
              <div class="ico" style="background:#e9d5ff;"><img data-i8="fire-element" alt="7-Day Streak"></div>
              <div class="txt"><div class="name">7‑Day Streak</div><div class="desc">Complete checks 7 days in a row.</div></div>
            </div>
            <div class="ach locked">
              <div class="ico" style="background:#fee2e2;"><img data-i8="checkmark" alt="100% Training"></div>
              <div class="txt"><div class="name">100% Training</div><div class="desc">All mandatory training valid.</div></div>
            </div>
            <div class="ach locked">
              <div class="ico" style="background:#dbeafe;"><img data-i8="idea" alt="Quiz Master"></div>
              <div class="txt"><div class="name">Quiz Master</div><div class="desc">Complete your weekly quiz.</div></div>
            </div>
            <div class="ach locked">
              <div class="ico" style="background:#fef3c7;"><img data-i8="trophy" alt="Perfect Score"></div>
              <div class="txt"><div class="name">Perfect Score</div><div class="desc">Get 100% on a quiz.</div></div>
            </div>
          </div>
        </div>
        <div class="tile">
          <div class="panel-header" style="align-items:center; gap:10px;">
            <div class="illus-circle"><img data-i8="time-machine" alt="Recent Activity"></div>
            <div class="panel-title">Recent Activity</div>
          </div>
          <div id="recent-scans-loading" style="padding:10px; text-align:center;">Loading…</div>
          <div class="timeline" id="timeline" style="display:none;"></div>
          <div id="recent-scans-empty" class="empty" style="display:none">No activity yet.</div>
        </div>
      </div>
    </section>

  <!-- Meetings section removed (moved to dedicated page) -->

  <!-- Admin access panel removed from staff home (admin link remains available via top nav) -->

    <div class="muted" style="text-align:center; font-size:12px; padding:10px 0;">© CheckLoop • Staff</div>
  </main>

  <script type="module">
  import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, setRing, fmtDate, getUserAchievements, upsertAchievement, clearAuthData, computeCompliance } from './staff-common.js';
    const supabase = await initSupabase();
    handleAuthState(supabase);
    navActivate('home');

    // Quick client-side reveal: use locally stored session metadata to
    // show the Admin button immediately for admin/owner users while
    // the authoritative profileRow is loaded. This avoids a visible
    // 1-2s delay waiting for the DB-backed requireStaffSession call.
    try {
      supabase.auth.getSession().then(({ data }) => {
        const user = data?.session?.user || {};
        const earlyRole = user?.raw_user_meta_data?.role || user?.user_metadata?.role;
        if (earlyRole) {
        }
      }).catch(_=>{});
    } catch(_){}

    let isLoggingOut = false;
    function cleanupAndRedirect() {
      try { clearAuthData(true); } catch(_) {}
      try { sessionStorage.clear(); } catch(_) {}
      try { document.cookie.split(';').forEach(c => document.cookie = c.replace(/^ +/, '').replace(/=.*/, `=;expires=${new Date(0).toUTCString()};path=/`)); } catch(_) {}
  window.location.replace('home.html?from=logout&_=' + Date.now());
    }
    async function forceLogout() {
      if (isLoggingOut) return;
      isLoggingOut = true;
      try { const { data } = await supabase.auth.getSession(); if (data?.session) await supabase.auth.signOut(); } catch (e) { console.error('Supabase signOut failed:', e); }
      cleanupAndRedirect();
    }
    document.getElementById('logout-btn').addEventListener('click', async (e) => { e.preventDefault(); e.stopPropagation(); await forceLogout(); });

    requireStaffSession(supabase).then(async ({ session, profileRow }) => {
      await loadDashboard(session.user, profileRow);
      // Reveal Admin link if applicable
      
      // Show admin access panel for admins and owners
      // Check both 'account_role' (new) and 'role' (old) for backward compatibility
      const accountRole = (profileRow?.account_role || profileRow?.role ||
                          session.user?.raw_user_meta_data?.account_role ||
                          session.user?.raw_user_meta_data?.role || '').toLowerCase();
      if (accountRole === 'admin' || accountRole === 'owner') {
        const adminPanel = document.getElementById('admin-access-panel');
        if (adminPanel) {
          adminPanel.style.display = 'block';
        }
      }
    }).catch(e => {
  if (String(e.message).includes('NO_SESSION')) { window.location.replace('home.html?force=login'); return; }
  if (String(e.message).includes('NOT_STAFF')) { window.location.replace('home.html?force=login'); return; }
      console.error(e);
    });

    async function loadDashboard(user, profileRow){
      // Resolve a friendly display name
      let displayName = profileRow?.full_name || user?.raw_user_meta_data?.full_name || (user?.email?.split('@')[0]) || 'Staff Member';
      try{
        const { data: nickRow } = await supabase.from('profiles').select('nickname').eq('user_id', user.id).maybeSingle();
        if (nickRow?.nickname) displayName = nickRow.nickname;
      }catch(_){/* ignore */}

      const siteId = profileRow?.site_id || user?.raw_user_meta_data?.site_id || null;

      // Get role for display - prioritize account_role for admin/owner, then job_role
      const accountRole = profileRow?.account_role ||
                         user?.raw_user_meta_data?.account_role ||
                         user?.user_metadata?.account_role;

      let displayRole;
      if (accountRole && ['admin', 'owner'].includes(accountRole.toLowerCase())) {
        displayRole = accountRole.charAt(0).toUpperCase() + accountRole.slice(1);
      } else {
        // For regular staff, show job role
        const jobRole = user?.raw_user_meta_data?.job_role ||
                        user?.raw_user_meta_data?.role_detail ||
                        profileRow?.job_role ||
                        'Staff';
        displayRole = jobRole.charAt(0).toUpperCase() + jobRole.slice(1);
      }
      const roleDetail = displayRole;

      document.getElementById('welcome').textContent = `Welcome, ${displayName}`;
      
      // Check quiz due status
      await checkQuizStatus(user, profileRow);
      
      // Resolve avatar and render into ring circle
      // Check sources in priority order (most authoritative first)
      try {
        let avatarUrl = null;

        // 1. First check profiles table (most authoritative/recent)
        try {
          const { data: p } = await supabase.from('profiles').select('avatar_url').eq('user_id', user.id).maybeSingle();
          if (p?.avatar_url) {
            avatarUrl = p.avatar_url;
            console.log('Avatar from profiles:', avatarUrl);
          }
        } catch(e) {
          console.warn('Error fetching avatar from profiles:', e);
        }

        // 2. If not in profiles, check staff_app_welcome
        if (!avatarUrl) {
          try {
            if (siteId) {
              const { data: saw } = await supabase
                .from('staff_app_welcome')
                .select('avatar_url, updated_at')
                .eq('user_id', user.id)
                .eq('site_id', siteId)
                .order('updated_at', { ascending: false })
                .limit(1)
                .maybeSingle();
              if (saw?.avatar_url) {
                avatarUrl = saw.avatar_url;
                console.log('Avatar from staff_app_welcome:', avatarUrl);
              }
            }
          } catch(e) {
            console.warn('Error fetching avatar from staff_app_welcome:', e);
          }
        }

        // 3. Finally fall back to user metadata
        if (!avatarUrl) {
          // Get fresh user data to ensure we have the latest metadata
          const { data: { user: refreshedUser } } = await supabase.auth.getUser();
          avatarUrl = refreshedUser?.user_metadata?.avatar_url || user?.raw_user_meta_data?.avatar_url || null;
          if (avatarUrl) {
            console.log('Avatar from user metadata:', avatarUrl);
          }
        }

        if (!avatarUrl) {
          console.log('No avatar found for user');
        }
        
        // Check if this is a full-body avatar (from uploads bucket)
        const isFullBodyAvatar = avatarUrl && (avatarUrl.includes('/uploads/') || avatarUrl.includes('/full_avatars/'));
        
        const img = document.getElementById('ring-avatar');
        if (img && avatarUrl) {
          // Add cache-busting parameter to ensure fresh avatar loads
          const cacheBuster = new Date().getTime();
          const separator = avatarUrl.includes('?') ? '&' : '?';
          img.src = `${avatarUrl}${separator}v=${cacheBuster}`;
          if (isFullBodyAvatar) {
            img.style.objectFit = 'contain';
            img.style.padding = '4px';
          }
        }
        
        // Small right-hand avatar removed from markup; we only use the ring avatar now
      } catch(_){}
      // Set top bar site/email/role
      setTopbar({ siteText: await getSiteText(supabase, siteId), email: user.email, role: roleDetail });
      if (!siteId){ document.getElementById('site-subtitle').textContent = 'Your staff dashboard'; }

      // Fetch live metrics: try an aggregated view first, fallback to counting submissions
      let valid = 0, due = 0, total = 0, ringPct = 0;
      try{
        // Prefer an aggregated view if available
        try {
          const agg = await supabase.from('v_submission_summary').select('valid_count,due_count,total_count').eq('site_id', siteId).eq('staff_name', displayName).maybeSingle();
          if (!agg.error && agg.data) {
            valid = Number(agg.data.valid_count || 0);
            due = Number(agg.data.due_count || 0);
            total = Number(agg.data.total_count || 0);
          }
        } catch(_) {
          // ignore - view might not exist
        }

        // If aggregation failed or returned nothing, compute counts heuristically
        if (!total) {
          // total submissions
          try {
            const tRes = await supabase.from('v_submission_detail').select('id', { head: true, count: 'exact' }).eq('site_id', siteId).eq('staff_name', displayName);
            if (!tRes.error) total = Number(tRes.count || 0);
          } catch(_){}

          // valid submissions (heuristic: check_value values that indicate pass)
          try {
            const vRes = await supabase.from('v_submission_detail').select('id', { head: true, count: 'exact' }).eq('site_id', siteId).eq('staff_name', displayName).in('check_value', ['Valid','OK','Pass','Good','Yes']);
            if (!vRes.error) valid = Number(vRes.count || 0);
          } catch(_){}

          // due = total - valid (fallback)
          due = Math.max(0, total - valid);
        }

        // Training/compliance percent: prefer an explicit profile field, otherwise
        // try computing from the training matrix (training_types + training_records).
        // If no training matrix exists for the site, fall back to the submissions heuristic.
        if (profileRow?.training_compliance_pct != null) {
          ringPct = Math.round(Number(profileRow.training_compliance_pct));
        } else if (profileRow?.training_percent != null) {
          ringPct = Math.round(Number(profileRow.training_percent));
        } else {
          try {
            if (siteId) {
              // Fetch the site's active training types and the user's training records
              const [{ data: types, error: typesErr }, { data: recs, error: recsErr }] = await Promise.all([
                supabase.from('training_types').select('id, validity_months, active').eq('site_id', siteId).eq('active', true),
                // training_records schema varies; attempt to match either user_id or staff_id
                supabase.from('training_records').select('*').eq('site_id', siteId).or(`user_id.eq.${user.id},staff_id.eq.${user.id}`)
              ]);
              if (!typesErr && types && types.length) {
                const comp = computeCompliance(types, recs || [], new Date());
                ringPct = comp.percent || 0;
              } else {
                ringPct = total ? Math.round((valid / total) * 100) : 0;
              }
            } else {
              ringPct = total ? Math.round((valid / total) * 100) : 0;
            }
          } catch (_){
            ringPct = total ? Math.round((valid / total) * 100) : 0;
          }
        }
      } catch(e){
        console.error('Error loading metrics', e);
      }

      // Update UI badges and progress bar
  const badgeValid = document.getElementById('badge-valid');
  const badgeDue = document.getElementById('badge-due');
  const badgeTotal = document.getElementById('badge-total');
  if (badgeValid) badgeValid.textContent = `${valid} valid`;
  if (badgeDue) badgeDue.textContent = `${due} due`;
  if (badgeTotal) badgeTotal.textContent = `${total} total`;
      try {
        const bar = document.getElementById('training-progress-bar');
        const lbl = document.getElementById('training-progress-label');
        if (bar) bar.style.width = `${ringPct}%`;
        if (lbl) lbl.textContent = `${ringPct}% Training`;
      } catch(_){}

      // Get kiosk_user_id from user profile
      const kioskUserId = profileRow?.kiosk_user_id;

      // Achievements: compute heuristics and upsert to DB if unlocked
      try{
        const achEls = document.querySelectorAll('.ach');
        // index mapping: 0=first_login, 1=on_time_submission, 2=seven_day_streak, 3=training_complete, 4=quiz_complete, 5=quiz_perfect

        // First Login: use auth user created_at (profileRow doesn't include created_at in current select)
        // Supabase auth user object has created_at; consider unlocked if exists and account age < 30 days OR any login occurs.
        let firstLogin = false;
        try {
          const createdAt = user?.created_at ? new Date(user.created_at) : null;
          if (createdAt) {
            const ageDays = (Date.now() - createdAt.getTime()) / 86400000;
            // If user has an auth record (always true here) treat as first_login achievement unlock once.
            firstLogin = true;
          }
        } catch(_) { firstLogin = true; }
        if (achEls[0]) achEls[0].classList.toggle('locked', !firstLogin);
        if (kioskUserId && firstLogin) {
          try { await upsertAchievement(supabase, kioskUserId, 'first_login', 'unlocked'); } catch(e) { console.error('Upsert first_login failed', e); }
        }

        // On-Time Checker: any submission today before 10:00
        let onTime = false;
        try{
          const start = new Date(); start.setHours(0,0,0,0);
          const end = new Date(); end.setHours(23,59,59,999);
          const todays = await supabase.from('v_submission_detail').select('submitted_at').eq('site_id', siteId).eq('staff_name', displayName).gte('submitted_at', start.toISOString()).lte('submitted_at', end.toISOString()).limit(50);
          if (!todays.error && todays.data && todays.data.length){
            for (const r of todays.data){
              const d = new Date(r.submitted_at);
              if (d.getHours() < 10) { onTime = true; break; }
            }
          }
        }catch(_){ }
        if (achEls[1]) achEls[1].classList.toggle('locked', !onTime);
        if (kioskUserId && onTime) {
          try { await upsertAchievement(supabase, kioskUserId, 'on_time_submission', 'unlocked'); } catch(e) { console.error('Upsert on_time failed', e); }
        }

        // 7-Day Streak: unique dates with submissions in last 7 days >=7
        let seven = false;
        try{
          const since = new Date(); since.setDate(since.getDate() - 7);
          const recent = await supabase.from('v_submission_detail').select('submitted_at').eq('site_id', siteId).eq('staff_name', displayName).gte('submitted_at', since.toISOString()).limit(200);
          if (!recent.error && recent.data){
            const days = new Set(recent.data.map(r => (new Date(r.submitted_at)).toISOString().slice(0,10)));
            seven = days.size >= 7;
          }
        }catch(_){ }
        if (achEls[2]) achEls[2].classList.toggle('locked', !seven);
        if (kioskUserId && seven) {
          try { await upsertAchievement(supabase, kioskUserId, 'seven_day_streak', 'unlocked'); } catch(e) { console.error('Upsert seven_day failed', e); }
        }

        // 100% Training: profile field or ringPct === 100
        const trainingOk = (profileRow?.training_compliance_pct != null && Number(profileRow.training_compliance_pct) >= 100) || ringPct === 100;
        if (achEls[3]) achEls[3].classList.toggle('locked', !trainingOk);
        if (kioskUserId && trainingOk) {
          try { await upsertAchievement(supabase, kioskUserId, 'training_complete', 'unlocked'); } catch(e) { console.error('Upsert training failed', e); }
        }

        // Quiz Master: has completed at least one quiz
        let quizComplete = false;
        try {
          const { data: quizData } = await supabase.from('quiz_attempts').select('id').eq('user_id', user.id).eq('is_practice', false).limit(1).maybeSingle();
          quizComplete = Boolean(quizData);
        } catch(_) {}
        if (achEls[4]) achEls[4].classList.toggle('locked', !quizComplete);
        if (kioskUserId && quizComplete) {
          try { await upsertAchievement(supabase, kioskUserId, 'quiz_complete', 'unlocked'); } catch(e) { console.error('Upsert quiz_complete failed', e); }
        }

        // Perfect Score: has gotten 100% on any quiz
        let perfectScore = false;
        try {
          const { data: perfectData } = await supabase.from('quiz_attempts').select('id').eq('user_id', user.id).eq('is_practice', false).eq('score_percent', 100).limit(1).maybeSingle();
          perfectScore = Boolean(perfectData);
        } catch(_) {}
        if (achEls[5]) achEls[5].classList.toggle('locked', !perfectScore);
        if (kioskUserId && perfectScore) {
          try { await upsertAchievement(supabase, kioskUserId, 'quiz_perfect', 'unlocked'); } catch(e) { console.error('Upsert quiz_perfect failed', e); }
        }

      }catch(e){ console.error('Achievement check failed', e); }

      // Finally load recent activity
      await loadRecentActivity(displayName, siteId);
      
  // Meetings moved to dedicated page
    }

    async function checkQuizStatus(user, profileRow) {
      const quizAlert = document.getElementById('quiz-alert');
      const quizAlertMessage = document.getElementById('quiz-alert-message');
      const quizBubble = document.getElementById('quiz-bubble');
      
      try {
        const now = new Date();
        // Helpers for current week (Sunday-Saturday)
        function getWeekStart(d=new Date()){ const c=new Date(d); const day=c.getDay(); c.setDate(c.getDate()-day); c.setHours(0,0,0,0); return c; }
        function getWeekEnd(d=new Date()){ const s=getWeekStart(d); const e=new Date(s.getTime()+6*24*60*60*1000); e.setHours(23,59,59,999); return e; }
        function getNextWeekStart(d=new Date()){ const e=getWeekEnd(d); return new Date(e.getTime()+24*60*60*1000); }

        const weekStart = getWeekStart();
        const localKey = `quiz_attempt_${user.id}_${weekStart.toISOString().split('T')[0]}`;

        let quizTakenThisWeek = false;
        // LocalStorage fallback (used by quiz page after save)
        try {
          const ls = localStorage.getItem(localKey);
          if (ls) {
            quizTakenThisWeek = true;
          }
        } catch(_) {}

        let lastCompletedDate = null;

        // DB check only if not already confirmed via localStorage
        if (!quizTakenThisWeek) {
          try {
            // Fetch any non‑practice attempt this week
            const { data: weekly, error: weeklyErr } = await supabase
              .from('quiz_attempts')
              .select('completed_at,created_at')
              .eq('user_id', user.id)
              .eq('is_practice', false)
              .gte('created_at', weekStart.toISOString())
              .lte('created_at', getWeekEnd().toISOString())
              .limit(1);
            if (!weeklyErr && weekly && weekly.length) {
              quizTakenThisWeek = true;
              const attempt = weekly[0];
              lastCompletedDate = attempt.completed_at || attempt.created_at;
            }
          } catch(_) {}
        }

        // If still not found, fetch the last attempt (any week) to compute next due date / upcoming window
        if (!lastCompletedDate) {
          try {
            const { data: lastAny, error: lastErr } = await supabase
              .from('quiz_attempts')
              .select('completed_at,created_at')
              .eq('user_id', user.id)
              .eq('is_practice', false)
              .order('completed_at', { ascending: false, nullsFirst: false })
              .order('created_at', { ascending: false })
              .limit(1)
              .maybeSingle();
            if (!lastErr && lastAny) {
              lastCompletedDate = lastAny.completed_at || lastAny.created_at || null;
            }
          } catch(_) {}
        }

        // Derive nextDue
        let nextDue = null;
        if (quizTakenThisWeek) {
          // Next due is start of next week
            nextDue = getNextWeekStart();
        } else if (profileRow?.next_quiz_due) {
          nextDue = new Date(profileRow.next_quiz_due);
        } else if (lastCompletedDate) {
          nextDue = new Date(lastCompletedDate);
          nextDue.setDate(nextDue.getDate() + 7);
        }

        // Logic to show/hide banner
        if (quizTakenThisWeek) {
          // Hide the alert entirely when completed
          quizAlert.style.display = 'none';
          quizBubble.classList.remove('due');
          return; // Nothing else to do
        }

        // If no record at all (first time) OR overdue
        if (!nextDue || now >= nextDue) {
          quizAlert.style.display = 'block';
          quizBubble.classList.add('due');
          if (!nextDue) {
            quizAlertMessage.textContent = 'Take your first weekly quiz now!';
          } else {
            const overdueDays = Math.floor((now - nextDue) / (1000 * 60 * 60 * 24));
            quizAlertMessage.textContent = overdueDays > 0 ? `Quiz is ${overdueDays} day${overdueDays>1?'s':''} overdue!` : 'Your weekly quiz is due today!';
          }
        } else {
          const hoursUntilDue = (nextDue - now) / (1000 * 60 * 60);
            if (hoursUntilDue <= 24) {
              quizAlert.style.display = 'block';
              quizAlert.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
              quizAlertMessage.textContent = `Quiz due in ${Math.ceil(hoursUntilDue)} hour${Math.ceil(hoursUntilDue)>1?'s':''}`;
            } else {
              quizAlert.style.display = 'none';
              quizBubble.classList.remove('due');
            }
        }
      } catch (error) {
        console.error('Error checking quiz status:', error);
      }
    }

    async function loadRecentActivity(displayName, siteId){
      const loadingEl = document.getElementById('recent-scans-loading');
      const timeline = document.getElementById('timeline');
      const emptyEl = document.getElementById('recent-scans-empty');
      try{
        let rows = [];
        if (siteId){
          const v = await supabase
            .from('v_submission_detail')
            .select('submitted_at,item_name,room,check_type,check_value,staff_name,site_id')
            .eq('site_id', siteId)
            .eq('staff_name', displayName)
            .order('submitted_at', { ascending:false })
            .limit(10);
          if (!v.error && v.data) rows = v.data;
        }
        if (!rows?.length){
          const s = await supabase
            .from('submissions')
            .select('submitted_at, staff_name, comment')
            .eq('staff_name', displayName)
            .order('submitted_at', { ascending:false })
            .limit(5);
          if (!s.error && s.data){ rows = s.data.map(r => ({ submitted_at:r.submitted_at, item_name:'—', room:'—', check_type:'—', check_value:r.comment||'Done' })); }
        }
        loadingEl.style.display='none';
        if (!rows?.length){ emptyEl.style.display='block'; return { count: 0 }; }
        timeline.style.display='grid';
        timeline.innerHTML = rows.map(r => `
          <div class="t-item">
            <div class="muted">${fmtDate(r.submitted_at)}</div>
            <div><strong>${r.item_name || '—'}</strong> · ${r.check_type || '—'} → <span class="muted">${r.check_value || '—'}</span></div>
            <div class="pill">${r.room || '—'}</div>
          </div>`).join('');
        return { count: rows.length };
      } catch(e){
        console.error('Activity load error', e);
        loadingEl.style.display='none';
        emptyEl.style.display='block';
        return { count: 0 };
      }
    }

    // No training table on the new Home. We'll surface training in its own page.
    
  // Meetings code removed from home page
  </script>

  <script>
    (function(){
      function i8(name, opts){
        opts = opts || {}; 
        var style = opts.style || 'dusk';
        var size  = (opts.size == null) ? 48 : opts.size; // default 48px
        var base  = 'https://img.icons8.com';
        // Icons8 OMG-IMG pattern is style/size/name.png
        var path  = [style, String(size || 48), encodeURIComponent(name) + '.png'].join('/');
        return base + '/' + path;
      }
      function setIcon(el){
        var name  = el.getAttribute('data-i8');
        var size  = el.getAttribute('data-i8-size');
        var style = el.getAttribute('data-i8-style') || 'fluency';
        var fallback = (el.getAttribute('data-i8-fallback') || '').toLowerCase();
        
        if (fallback === 'auto') {
          var stylesToTry = [style, 'fluency', 'color'];
          var idx = 0;
          function tryNext(){
            if (idx >= stylesToTry.length) { el.onerror = null; return; }
            var url = i8(name, {style: stylesToTry[idx++], size: size ? parseInt(size,10) : undefined});
            if (el.src !== url) el.src = url; else tryNext();
          }
          el.onerror = tryNext;
          tryNext();
        } else {
          // Strict mode: stay in the requested style (default: dusk)
          var url = i8(name, {style: style, size: size ? parseInt(size,10) : undefined});
          el.src = url;
          el.onerror = null;
        }
        if (!el.alt) el.alt = (name || '').replace(/[\-_]/g,' ');
      }
      function wireIcons(){
        document.querySelectorAll('img[data-i8]').forEach(setIcon);
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', wireIcons);
      else wireIcons();
      window.i8 = i8; // optional helper for manual usage
    })();
  </script>
  
  <script>
    // Create animated particles - only on staff home page
    (function() {
      function createParticles() {
        // Only create particles if we're on the staff home page
        if (!document.body.classList.contains('staff-home-particles')) return;
        
        const particlesContainer = document.getElementById('particles');
        if (!particlesContainer) return;
        
        // Clear any existing particles
        particlesContainer.innerHTML = '';
        
        const particleCount = 35;
        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          
          // Randomize starting positions around screen edges
          const edge = Math.random() * 4;
          if (edge < 1) {
            // Bottom edge
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = '100vh';
          } else if (edge < 2) {
            // Left edge
            particle.style.left = '-10px';
            particle.style.top = Math.random() * 100 + '%';
          } else if (edge < 3) {
            // Right edge
            particle.style.left = '100vw';
            particle.style.top = Math.random() * 100 + '%';
          } else {
            // Top edge (some particles start from top)
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = '-10px';
          }
          
          // Random animation delay to stagger particles
          particle.style.animationDelay = Math.random() * 40 + 's';
          
          // Vary animation duration slightly for more natural feel
          const baseDuration = 25 + Math.random() * 15; // 25-40s
          particle.style.animationDuration = baseDuration + 's';
          
          particlesContainer.appendChild(particle);
        }
      }
      
      // Add mouse tracking for interactive effects
      document.addEventListener('mousemove', function(e) {
        const cards = document.querySelectorAll('.stat-card');
        cards.forEach(card => {
          const rect = card.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          card.style.setProperty('--mouse-x', x + '%');
          card.style.setProperty('--mouse-y', y + '%');
        });
      });
      
      // Initialize particles when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createParticles);
      } else {
        createParticles();
      }
      
      // Refresh particles every 2 minutes to keep the effect dynamic
      setInterval(createParticles, 120000);
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — Staff</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://img.icons8.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="admin-nav.js"></script>
  <link rel="stylesheet" href="staff.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Page-specific tweaks only; core styles live in staff.css */
    .subtitle{ color:#64748b; font-weight:600; }
    .staff-avatar{ width:64px; height:64px; border-radius:50%; background:#fff; background-size:cover; background-position:center; box-shadow:0 4px 10px rgba(2,6,23,.10); border:1px solid var(--border-color); }
    .staff-hero-avatar{ width:96px; height:96px; border-radius:50%; background:#fff; background-size:cover; background-position:center; box-shadow:0 6px 16px rgba(2,6,23,.12); border:1px solid var(--border-color); }
    
    /* Quiz Alert Styles */
    .quiz-alert {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      border: 2px solid #fbbf24;
      animation: slideInDown 0.6s ease-out, pulseGlow 2s infinite;
    }
    
    .quiz-alert-content {
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
    }
    
    .quiz-alert-icon {
      width: 40px;
      height: 40px;
      animation: bounce 2s infinite;
    }
    .quiz-alert-icon img { width: 100%; height: 100%; display:block; }
    
    .quiz-alert-text {
      flex: 1;
    }
    
    .quiz-alert-title {
      font-weight: 800;
      font-size: 1.2em;
      margin-bottom: 4px;
    }
    
    .quiz-alert-subtitle {
      font-size: 0.9em;
      opacity: 0.9;
    }
    
    .quiz-alert-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .quiz-alert-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    
    /* Quiz Bubble Animation */
    .quiz-bubble {
      position: relative;
    }
    
    .quiz-bubble.due {
      animation: pulse 2s infinite;
    }
    
    .quiz-bubble.due::after {
      content: '!';
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ef4444;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 12px;
      animation: bounce 1.5s infinite;
    }
    
    /* Animations */
    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulseGlow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
      }
      50% {
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      60% {
        transform: translateY(-5px);
      }
    }
    
    /* Meetings Section Styles */
    .meetings-section {
      margin-top: 20px;
    }
    
    .meetings-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .meetings-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      color: #64748b;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .meetings-tab:hover {
      color: #4f89ff;
    }
    
    .meetings-tab.active {
      color: #4f89ff;
      border-bottom-color: #4f89ff;
    }
    
    .meetings-content {
      display: none;
    }
    
    .meetings-content.active {
      display: block;
    }
    
    #calendar {
      height: 500px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .agenda-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .agenda-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
    }
    
    .attendance-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .btn-accept {
      background: #10b981;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .btn-decline {
      background: #ef4444;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .meeting-notes {
      width: 100%;
      min-height: 300px;
      padding: 15px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-family: inherit;
      resize: vertical;
    }
    
    .btn-generate-pdf {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
    }
    
    .meeting-history-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .meeting-history-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .meeting-form-group {
      margin-bottom: 15px;
    }
    
    .meeting-form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #374151;
    }
    
    .meeting-form-group input,
    .meeting-form-group textarea,
    .meeting-form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: inherit;
    }
    
    .attendees-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    .attendee-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .attendee-badge.accepted {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .attendee-badge.declined {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .attendee-badge.pending {
      background: #fef3c7;
      color: #d97706;
    }
  </style>
</head>
<body>
  <div class="bg"><div class="wave"></div><div class="wave wave2"></div></div>
  <main class="content">
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav">
        <!-- Navigation will be rendered by staff-common.js -->
      </div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: —</div>
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>

    <section class="panel g-12" style="margin:0; position:relative; overflow:hidden;">
      <div class="halo"></div>
      
      <!-- Quiz Due Alert -->
      <div id="quiz-alert" class="quiz-alert" style="display:none;">
        <div class="quiz-alert-content">
          <div class="quiz-alert-icon"><img data-i8="brain" data-i8-size="48" alt="Quiz"></div>
          <div class="quiz-alert-text">
            <div class="quiz-alert-title">Weekly Quiz Due!</div>
            <div class="quiz-alert-subtitle" id="quiz-alert-message">Complete your required knowledge check</div>
          </div>
          <a href="staff-quiz.html" class="quiz-alert-btn">Take Quiz</a>
        </div>
      </div>
      
      <div class="hero">
        <div class="ring bounce" id="compliance-ring" title="Training compliance" style="position:relative;">
          <div class="ring-progress"></div>
          <div class="ring-hole"></div>
          <img id="ring-avatar" alt="Avatar" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:72px; height:72px; border-radius:50%; object-fit:cover; box-shadow:0 4px 10px rgba(2,6,23,.12);" />
        </div>
        <div style="min-width:200px;">
          <div class="subtitle" id="site-subtitle"></div>
          <div class="h1" id="welcome" style="font-size:32px;">Welcome</div>
          <!-- Badges removed as requested -->
        </div>
        <div class="spacer"></div>
        <div class="staff-avatar" id="staff-avatar" style="display:none;"></div>
        <div class="bubble-actions" aria-label="Quick actions">
          <a class="bubble" href="staff-scans.html">
            <div class="i c-purple"><img data-i8="document" data-i8-size="48" alt="My Scans"/></div>
            <div class="t">My Scans</div>
          </a>
          <a class="bubble" href="staff-training.html">
            <div class="i c-blue"><img data-i8="graduation-cap" data-i8-size="48" alt="Training"/></div>
            <div class="t">Training</div>
          </a>
          <a class="bubble quiz-bubble" href="staff-quiz.html" id="quiz-bubble">
            <div class="i c-orange"><img data-i8="puzzle" data-i8-size="48" alt="Quiz"/></div>
            <div class="t">Quiz</div>
          </a>
        </div>
      </div>
      <div class="progress-wrap" style="margin-top:10px; padding:0 8px;">
        <div class="progress" style="height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; border:1px solid var(--border-color);">
          <div id="training-progress-bar" class="bar" style="height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#a78bfa);"></div>
        </div>
        <div id="training-progress-label" class="meta-note" style="text-align:right; margin-top:4px;">0% Training</div>
      </div>
      <div class="tile-grid" style="margin-top:14px;">
        <div class="tile">
          <div class="panel-header" style="align-items:center; gap:10px;">
            <div class="illus-circle"><img data-i8="medal" alt="Achievements"></div>
            <div class="panel-title">Achievements</div>
          </div>
          <div class="ach-grid">
            <div class="ach">
            <div class="ico" style="background:#dcfce7;"><img data-i8="confetti" alt="First Login"></div>
              <div class="txt"><div class="name">First Login</div><div class="desc">Welcome aboard! You’re in.</div></div>
            </div>
            <div class="ach locked">
              <div class="ico" style="background:#fef3c7;"><img data-i8="clock" alt="On-Time"></div>
              <div class="txt"><div class="name">On‑Time Checker</div><div class="desc">Do today’s check before 10am.</div></div>
            </div>
            <div class="ach locked">
              <div class="ico" style="background:#e9d5ff;"><img data-i8="fire-element" alt="7-Day Streak"></div>
              <div class="txt"><div class="name">7‑Day Streak</div><div class="desc">Complete checks 7 days in a row.</div></div>
            </div>
            <div class="ach locked">
              <div class="ico" style="background:#fee2e2;"><img data-i8="checkmark" alt="100% Training"></div>
              <div class="txt"><div class="name">100% Training</div><div class="desc">All mandatory training valid.</div></div>
            </div>
            <div class="ach locked">
              <div class="ico" style="background:#dbeafe;"><img data-i8="idea" alt="Quiz Master"></div>
              <div class="txt"><div class="name">Quiz Master</div><div class="desc">Complete your weekly quiz.</div></div>
            </div>
            <div class="ach locked">
              <div class="ico" style="background:#fef3c7;"><img data-i8="trophy" alt="Perfect Score"></div>
              <div class="txt"><div class="name">Perfect Score</div><div class="desc">Get 100% on a quiz.</div></div>
            </div>
          </div>
        </div>
        <div class="tile">
          <div class="panel-header" style="align-items:center; gap:10px;">
            <div class="illus-circle"><img data-i8="time-machine" alt="Recent Activity"></div>
            <div class="panel-title">Recent Activity</div>
          </div>
          <div id="recent-scans-loading" style="padding:10px; text-align:center;">Loading…</div>
          <div class="timeline" id="timeline" style="display:none;"></div>
          <div id="recent-scans-empty" class="empty" style="display:none">No activity yet.</div>
        </div>
      </div>
    </section>

    <!-- Meetings Section -->
    <section class="meetings-section panel" style="margin-top: 20px;">
      <div class="panel-header">
        <h2 style="margin: 0; font-size: 24px; color: #1f2937;">Meetings Hub</h2>
      </div>
      
      <div class="meetings-tabs">
        <button class="meetings-tab active" data-tab="calendar">Calendar</button>
        <button class="meetings-tab" data-tab="agenda">Agenda Items</button>
        <button class="meetings-tab" data-tab="notes">Meeting Notes</button>
        <button class="meetings-tab" data-tab="history">Past Meetings</button>
      </div>
      
      <!-- Calendar Tab -->
      <div class="meetings-content active" id="calendar-content">
        <div id="calendar"></div>
        
        <!-- Meeting Details Modal (hidden by default) -->
        <div id="meeting-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 1000; max-width: 500px; width: 90%;">
          <h3 id="modal-meeting-title">Meeting Title</h3>
          <p id="modal-meeting-date">Date</p>
          <p id="modal-meeting-description">Description</p>
          
          <div class="attendees-list" id="modal-attendees">
            <!-- Attendees will be populated here -->
          </div>
          
          <div class="attendance-buttons">
            <button class="btn-accept" onclick="acceptMeeting()">Accept</button>
            <button class="btn-decline" onclick="declineMeeting()">Decline</button>
          </div>
          
          <button onclick="closeMeetingModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
        </div>
      </div>
      
      <!-- Agenda Tab -->
      <div class="meetings-content" id="agenda-content">
        <div class="agenda-form">
          <h3>Submit Agenda Item</h3>
          <div class="meeting-form-group">
            <label>Meeting</label>
            <select id="agenda-meeting-select">
              <option value="">Select a meeting...</option>
            </select>
          </div>
          <div class="meeting-form-group">
            <label>Agenda Item</label>
            <input type="text" id="agenda-item-title" placeholder="Enter agenda item title">
          </div>
          <div class="meeting-form-group">
            <label>Description</label>
            <textarea id="agenda-item-description" rows="3" placeholder="Provide details about this agenda item"></textarea>
          </div>
          <button class="btn" onclick="submitAgendaItem()" style="background: #4f89ff; color: white;">Submit Agenda Item</button>
        </div>
        
        <h3>Current Agenda Items</h3>
        <div id="agenda-items-list">
          <!-- Agenda items will be populated here -->
        </div>
      </div>
      
      <!-- Meeting Notes Tab -->
      <div class="meetings-content" id="notes-content">
        <div class="meeting-form-group">
          <label>Select Meeting</label>
          <select id="notes-meeting-select">
            <option value="">Select a meeting...</option>
          </select>
        </div>
        
        <div class="meeting-form-group">
          <label>Meeting Notes/Minutes</label>
          <textarea class="meeting-notes" id="meeting-notes-textarea" placeholder="Type your meeting notes here..."></textarea>
        </div>
        
        <button class="btn-generate-pdf" onclick="generateMeetingPDF()">Generate PDF with AI Enhancement</button>
        
        <div id="pdf-status" style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; display: none;">
          <p style="margin: 0; color: #0369a1;">Processing with AI...</p>
        </div>
      </div>
      
      <!-- History Tab -->
      <div class="meetings-content" id="history-content">
        <h3>Past Meetings</h3>
        <div id="meeting-history-list">
          <!-- Past meetings will be populated here -->
        </div>
      </div>
    </section>

    <!-- Admin Access Section -->
    <section class="admin-access-panel panel" id="admin-access-panel" style="display: none; margin-top: 20px; text-align: center; padding: 20px;">
      <h3 style="margin-top: 0; margin-bottom: 12px; color: #4f89ff;">Administrator Access</h3>
      <p style="margin-bottom: 16px; color: #64748b; font-size: 14px;">
        You have administrator privileges. Click below to access the admin dashboard.
      </p>
      <a href="admin-dashboard.html" class="btn admin-only" style="display: inline-block; width: auto; padding: 10px 20px; background: linear-gradient(135deg,#7db1ff,#4f89ff); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
        Admin Site
      </a>
    </section>

    <div class="muted" style="text-align:center; font-size:12px; padding:10px 0;">© CheckLoop • Staff</div>
  </main>

  <script type="module">
  import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, setRing, fmtDate, revealAdminNav, getUserAchievements, upsertAchievement, clearAuthData } from './staff-common.js';
    const supabase = await initSupabase();
    handleAuthState(supabase);
    navActivate('home');

    let isLoggingOut = false;
    function cleanupAndRedirect() {
      try { clearAuthData(true); } catch(_) {}
      try { sessionStorage.clear(); } catch(_) {}
      try { document.cookie.split(';').forEach(c => document.cookie = c.replace(/^ +/, '').replace(/=.*/, `=;expires=${new Date(0).toUTCString()};path=/`)); } catch(_) {}
      window.location.replace('Home.html?_=' + Date.now());
    }
    async function forceLogout() {
      if (isLoggingOut) return;
      isLoggingOut = true;
      try { const { data } = await supabase.auth.getSession(); if (data?.session) await supabase.auth.signOut(); } catch (e) { console.error('Supabase signOut failed:', e); }
      cleanupAndRedirect();
    }
    document.getElementById('logout-btn').addEventListener('click', async (e) => { e.preventDefault(); e.stopPropagation(); await forceLogout(); });

    requireStaffSession(supabase).then(async ({ session, profileRow }) => {
      await loadDashboard(session.user, profileRow);
      // Reveal Admin link if applicable
      revealAdminNav(profileRow?.role || session.user?.raw_user_meta_data?.role);
      
      // Show admin access panel for admins and owners
      const role = (profileRow?.role || session.user?.raw_user_meta_data?.role || '').toLowerCase();
      if (role === 'admin' || role === 'owner') {
        document.getElementById('admin-access-panel').style.display = 'block';
      }
    }).catch(e => {
      if (String(e.message).includes('NO_SESSION')) { window.location.replace('Home.html'); return; }
      if (String(e.message).includes('NOT_STAFF')) { window.location.replace('Home.html'); return; }
      console.error(e);
    });

    async function loadDashboard(user, profileRow){
      // Resolve a friendly display name
      let displayName = profileRow?.full_name || user?.raw_user_meta_data?.full_name || (user?.email?.split('@')[0]) || 'Staff Member';
      try{
        const { data: nickRow } = await supabase.from('profiles').select('nickname').eq('user_id', user.id).maybeSingle();
        if (nickRow?.nickname) displayName = nickRow.nickname;
      }catch(_){/* ignore */}

      const siteId = profileRow?.site_id || user?.raw_user_meta_data?.site_id || null;
      const role = profileRow?.role || user?.raw_user_meta_data?.role || 'Staff';
      const roleDetail = role.charAt(0).toUpperCase() + role.slice(1);  // Capitalize first letter

      document.getElementById('welcome').textContent = `Welcome, ${displayName}`;
      
      // Check quiz due status
      await checkQuizStatus(user, profileRow);
      
      // Resolve avatar and render into ring circle
      try {
        let avatarUrl = user?.raw_user_meta_data?.avatar_url || null;
        try {
          if (siteId) {
            const { data: saw } = await supabase
              .from('staff_app_welcome')
              .select('avatar_url, updated_at')
              .eq('user_id', user.id)
              .eq('site_id', siteId)
              .order('updated_at', { ascending: false })
              .limit(1)
              .maybeSingle();
            if (saw?.avatar_url) avatarUrl = saw.avatar_url;
          }
        } catch(_) {}
        if (!avatarUrl) {
          try {
            const { data: p } = await supabase.from('profiles').select('avatar_url').eq('user_id', user.id).maybeSingle();
            if (p?.avatar_url) avatarUrl = p.avatar_url;
          } catch(_) {}
        }
        const img = document.getElementById('ring-avatar');
        if (img && avatarUrl) { img.src = avatarUrl; }
      } catch(_){}
      // Set top bar site/email/role
      setTopbar({ siteText: await getSiteText(supabase, siteId), email: user.email, role: roleDetail });
      if (!siteId){ document.getElementById('site-subtitle').textContent = 'Your staff dashboard'; }

      // Fetch live metrics: try an aggregated view first, fallback to counting submissions
      let valid = 0, due = 0, total = 0, ringPct = 0;
      try{
        // Prefer an aggregated view if available
        try {
          const agg = await supabase.from('v_submission_summary').select('valid_count,due_count,total_count').eq('site_id', siteId).eq('staff_name', displayName).maybeSingle();
          if (!agg.error && agg.data) {
            valid = Number(agg.data.valid_count || 0);
            due = Number(agg.data.due_count || 0);
            total = Number(agg.data.total_count || 0);
          }
        } catch(_) {
          // ignore - view might not exist
        }

        // If aggregation failed or returned nothing, compute counts heuristically
        if (!total) {
          // total submissions
          try {
            const tRes = await supabase.from('v_submission_detail').select('id', { head: true, count: 'exact' }).eq('site_id', siteId).eq('staff_name', displayName);
            if (!tRes.error) total = Number(tRes.count || 0);
          } catch(_){}

          // valid submissions (heuristic: check_value values that indicate pass)
          try {
            const vRes = await supabase.from('v_submission_detail').select('id', { head: true, count: 'exact' }).eq('site_id', siteId).eq('staff_name', displayName).in('check_value', ['Valid','OK','Pass','Good','Yes']);
            if (!vRes.error) valid = Number(vRes.count || 0);
          } catch(_){}

          // due = total - valid (fallback)
          due = Math.max(0, total - valid);
        }

        // Training/compliance percent: prefer a profile field, otherwise derive from counts
        if (profileRow?.training_compliance_pct != null) {
          ringPct = Math.round(Number(profileRow.training_compliance_pct));
        } else if (profileRow?.training_percent != null) {
          ringPct = Math.round(Number(profileRow.training_percent));
        } else {
          ringPct = total ? Math.round((valid / total) * 100) : 0;
        }
      } catch(e){
        console.error('Error loading metrics', e);
      }

      // Update UI badges and progress bar
  const badgeValid = document.getElementById('badge-valid');
  const badgeDue = document.getElementById('badge-due');
  const badgeTotal = document.getElementById('badge-total');
  if (badgeValid) badgeValid.textContent = `${valid} valid`;
  if (badgeDue) badgeDue.textContent = `${due} due`;
  if (badgeTotal) badgeTotal.textContent = `${total} total`;
      try {
        const bar = document.getElementById('training-progress-bar');
        const lbl = document.getElementById('training-progress-label');
        if (bar) bar.style.width = `${ringPct}%`;
        if (lbl) lbl.textContent = `${ringPct}% Training`;
      } catch(_){}

      // Get kiosk_user_id for achievements
      let kioskUserId = null;
      try {
        const { data: ku } = await supabase.from('kiosk_users').select('id').eq('user_id', user.id).maybeSingle();
        if (ku) kioskUserId = ku.id;
      } catch(e) { console.error('Failed to get kiosk_user_id', e); }

      // Achievements: compute heuristics and upsert to DB if unlocked
      try{
        const achEls = document.querySelectorAll('.ach');
        // index mapping: 0=first_login, 1=on_time_submission, 2=seven_day_streak, 3=training_complete, 4=quiz_complete, 5=quiz_perfect

        // First Login: if profile has created_at
        const firstLogin = Boolean(profileRow?.created_at);
        if (achEls[0]) achEls[0].classList.toggle('locked', !firstLogin);
        if (kioskUserId && firstLogin) {
          try { await upsertAchievement(supabase, kioskUserId, 'first_login', 'unlocked'); } catch(e) { console.error('Upsert first_login failed', e); }
        }

        // On-Time Checker: any submission today before 10:00
        let onTime = false;
        try{
          const start = new Date(); start.setHours(0,0,0,0);
          const end = new Date(); end.setHours(23,59,59,999);
          const todays = await supabase.from('v_submission_detail').select('submitted_at').eq('site_id', siteId).eq('staff_name', displayName).gte('submitted_at', start.toISOString()).lte('submitted_at', end.toISOString()).limit(50);
          if (!todays.error && todays.data && todays.data.length){
            for (const r of todays.data){
              const d = new Date(r.submitted_at);
              if (d.getHours() < 10) { onTime = true; break; }
            }
          }
        }catch(_){ }
        if (achEls[1]) achEls[1].classList.toggle('locked', !onTime);
        if (kioskUserId && onTime) {
          try { await upsertAchievement(supabase, kioskUserId, 'on_time_submission', 'unlocked'); } catch(e) { console.error('Upsert on_time failed', e); }
        }

        // 7-Day Streak: unique dates with submissions in last 7 days >=7
        let seven = false;
        try{
          const since = new Date(); since.setDate(since.getDate() - 7);
          const recent = await supabase.from('v_submission_detail').select('submitted_at').eq('site_id', siteId).eq('staff_name', displayName).gte('submitted_at', since.toISOString()).limit(200);
          if (!recent.error && recent.data){
            const days = new Set(recent.data.map(r => (new Date(r.submitted_at)).toISOString().slice(0,10)));
            seven = days.size >= 7;
          }
        }catch(_){ }
        if (achEls[2]) achEls[2].classList.toggle('locked', !seven);
        if (kioskUserId && seven) {
          try { await upsertAchievement(supabase, kioskUserId, 'seven_day_streak', 'unlocked'); } catch(e) { console.error('Upsert seven_day failed', e); }
        }

        // 100% Training: profile field or ringPct === 100
        const trainingOk = (profileRow?.training_compliance_pct != null && Number(profileRow.training_compliance_pct) >= 100) || ringPct === 100;
        if (achEls[3]) achEls[3].classList.toggle('locked', !trainingOk);
        if (kioskUserId && trainingOk) {
          try { await upsertAchievement(supabase, kioskUserId, 'training_complete', 'unlocked'); } catch(e) { console.error('Upsert training failed', e); }
        }

        // Quiz Master: has completed at least one quiz
        let quizComplete = false;
        try {
          const { data: quizData } = await supabase.from('quiz_attempts').select('id').eq('user_id', user.id).eq('is_practice', false).limit(1).maybeSingle();
          quizComplete = Boolean(quizData);
        } catch(_) {}
        if (achEls[4]) achEls[4].classList.toggle('locked', !quizComplete);
        if (kioskUserId && quizComplete) {
          try { await upsertAchievement(supabase, kioskUserId, 'quiz_complete', 'unlocked'); } catch(e) { console.error('Upsert quiz_complete failed', e); }
        }

        // Perfect Score: has gotten 100% on any quiz
        let perfectScore = false;
        try {
          const { data: perfectData } = await supabase.from('quiz_attempts').select('id').eq('user_id', user.id).eq('is_practice', false).eq('score_percent', 100).limit(1).maybeSingle();
          perfectScore = Boolean(perfectData);
        } catch(_) {}
        if (achEls[5]) achEls[5].classList.toggle('locked', !perfectScore);
        if (kioskUserId && perfectScore) {
          try { await upsertAchievement(supabase, kioskUserId, 'quiz_perfect', 'unlocked'); } catch(e) { console.error('Upsert quiz_perfect failed', e); }
        }

      }catch(e){ console.error('Achievement check failed', e); }

      // Finally load recent activity
      await loadRecentActivity(displayName, siteId);
      
      // Initialize meetings functionality
      await initializeMeetingsAfterAuth();
    }

    async function checkQuizStatus(user, profileRow) {
      const quizAlert = document.getElementById('quiz-alert');
      const quizAlertMessage = document.getElementById('quiz-alert-message');
      const quizBubble = document.getElementById('quiz-bubble');
      
      try {
        const now = new Date();
        let nextDue = null;
        
        // Check profiles.next_quiz_due first
        if (profileRow?.next_quiz_due) {
          nextDue = new Date(profileRow.next_quiz_due);
        } else {
          // Fallback: compute from last quiz attempt
          try {
            const { data: last, error } = await supabase
              .from('quiz_attempts')
              .select('completed_at,created_at')
              .eq('user_id', user.id)
              .eq('is_practice', false)
              .order('completed_at', { ascending: false })
              .limit(1)
              .maybeSingle();
            
            if (!error && last) {
              const lastCompleted = last.completed_at || last.created_at || null;
              if (lastCompleted) {
                nextDue = new Date(lastCompleted);
                nextDue.setDate(nextDue.getDate() + 7);
              }
            }
          } catch(_) { /* ignore */ }
        }
        
        // If quiz is due or overdue
        if (!nextDue || now >= nextDue) {
          quizAlert.style.display = 'block';
          quizBubble.classList.add('due');
          
          if (!nextDue) {
            quizAlertMessage.textContent = 'Take your first weekly quiz now!';
          } else {
            const overdueDays = Math.floor((now - nextDue) / (1000 * 60 * 60 * 24));
            if (overdueDays > 0) {
              quizAlertMessage.textContent = `Quiz is ${overdueDays} day${overdueDays > 1 ? 's' : ''} overdue!`;
            } else {
              quizAlertMessage.textContent = 'Your weekly quiz is due today!';
            }
          }
        } else {
          // Quiz not due yet, but show upcoming if within 24 hours
          const hoursUntilDue = (nextDue - now) / (1000 * 60 * 60);
          if (hoursUntilDue <= 24) {
            quizAlert.style.display = 'block';
            quizAlert.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
            quizAlertMessage.textContent = `Quiz due in ${Math.ceil(hoursUntilDue)} hour${Math.ceil(hoursUntilDue) > 1 ? 's' : ''}`;
          }
        }
      } catch (error) {
        console.error('Error checking quiz status:', error);
      }
    }

    async function loadRecentActivity(displayName, siteId){
      const loadingEl = document.getElementById('recent-scans-loading');
      const timeline = document.getElementById('timeline');
      const emptyEl = document.getElementById('recent-scans-empty');
      try{
        let rows = [];
        if (siteId){
          const v = await supabase
            .from('v_submission_detail')
            .select('submitted_at,item_name,room,check_type,check_value,staff_name,site_id')
            .eq('site_id', siteId)
            .eq('staff_name', displayName)
            .order('submitted_at', { ascending:false })
            .limit(10);
          if (!v.error && v.data) rows = v.data;
        }
        if (!rows?.length){
          const s = await supabase
            .from('submissions')
            .select('submitted_at, staff_name, comment')
            .eq('staff_name', displayName)
            .order('submitted_at', { ascending:false })
            .limit(5);
          if (!s.error && s.data){ rows = s.data.map(r => ({ submitted_at:r.submitted_at, item_name:'—', room:'—', check_type:'—', check_value:r.comment||'Done' })); }
        }
        loadingEl.style.display='none';
        if (!rows?.length){ emptyEl.style.display='block'; return { count: 0 }; }
        timeline.style.display='grid';
        timeline.innerHTML = rows.map(r => `
          <div class="t-item">
            <div class="muted">${fmtDate(r.submitted_at)}</div>
            <div><strong>${r.item_name || '—'}</strong> · ${r.check_type || '—'} → <span class="muted">${r.check_value || '—'}</span></div>
            <div class="pill">${r.room || '—'}</div>
          </div>`).join('');
        return { count: rows.length };
      } catch(e){
        console.error('Activity load error', e);
        loadingEl.style.display='none';
        emptyEl.style.display='block';
        return { count: 0 };
      }
    }

    // No training table on the new Home. We'll surface training in its own page.
    
    // Meetings functionality variables - declare at top level
    let calendar = null;
    let currentMeetingId = null;
    let meetings = [];
    
    // Initialize meetings after authentication is complete
    async function initializeMeetingsAfterAuth() {
      try {
        await initializeMeetings();
      } catch (error) {
        console.error('Failed to initialize meetings:', error);
      }
    }
    
    async function initializeMeetings() {
      console.log('Initializing meetings...');
      
      // Initialize tabs
      document.querySelectorAll('.meetings-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          switchTab(this.dataset.tab);
        });
      });
      
      // Wait a bit for DOM to be ready
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Initialize calendar
      const calendarEl = document.getElementById('calendar');
      if (calendarEl && typeof FullCalendar !== 'undefined') {
        console.log('Creating calendar...');
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek'
          },
          events: async function(fetchInfo, successCallback, failureCallback) {
            try {
              const events = await loadMeetings();
              successCallback(events);
            } catch (error) {
              console.error('Error loading meetings:', error);
              failureCallback(error);
            }
          },
          eventClick: function(info) {
            showMeetingDetails(info.event);
          }
        });
        calendar.render();
        console.log('Calendar rendered successfully');
      } else {
        console.error('Calendar element not found or FullCalendar not loaded');
      }
      
      // Load sample meetings and populate selects
      await loadSampleMeetings();
    }
    
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.meetings-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      // Update content
      document.querySelectorAll('.meetings-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}-content`).classList.add('active');
    }
    
    async function loadMeetings() {
      try {
        console.log('Loading meetings data...');
        // In production, this would fetch from Supabase
        // For now, return sample meetings
        const events = [
          {
            id: '1',
            title: 'Partners Meeting',
            start: new Date().toISOString().split('T')[0] + 'T14:00:00',
            description: 'Monthly partners meeting to discuss practice operations',
            attendees: ['Dr. Farook', 'Yvonne Bell', 'Ben Howard', 'Monique Keersmaekers']
          },
          {
            id: '2',
            title: 'Staff Training Review',
            start: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] + 'T10:00:00',
            description: 'Review staff training compliance and upcoming requirements',
            attendees: ['All Staff']
          },
          {
            id: '3',
            title: 'PCN Coordination',
            start: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] + 'T15:00:00',
            description: 'PCN structure and transparency discussion',
            attendees: ['PCN Representatives']
          }
        ];
        
        // Set the global meetings array FIRST
        meetings = events;
        console.log('Loaded', events.length, 'meetings');
        
        // Then populate meeting selects
        setTimeout(() => {
          populateMeetingSelects();
        }, 100);
        
        return events;
      } catch (error) {
        console.error('Error loading meetings:', error);
        meetings = []; // Set to empty array on error
        throw error;
      }
    }
    
    async function loadSampleMeetings() {
      try {
        console.log('Loading sample meetings data...');
        
        // Load sample agenda items
        const agendaList = document.getElementById('agenda-items-list');
        if (agendaList) {
          agendaList.innerHTML = `
            <div class="agenda-item">
              <h4>ARTP Spirometry Course Requirements</h4>
              <p>Discuss mandatory course registration and funding options</p>
              <small style="color: #6b7280;">Submitted by: Dr. Farook</small>
            </div>
            <div class="agenda-item">
              <h4>Appointment Template Adjustments</h4>
              <p>Review and balance appointment slots across clinicians</p>
              <small style="color: #6b7280;">Submitted by: Shihara</small>
            </div>
          `;
          console.log('Agenda items loaded');
        }
        
        // Load sample history
        const historyList = document.getElementById('meeting-history-list');
        if (historyList) {
          historyList.innerHTML = `
            <div class="meeting-history-item" onclick="viewMeetingNotes('1')">
              <h4>Partners Meeting - 13/08/2025</h4>
              <p>Discussed ARTP requirements, appointment management, PCN structure</p>
              <small style="color: #6b7280;">4 attendees • Meeting notes available</small>
            </div>
            <div class="meeting-history-item" onclick="viewMeetingNotes('2')">
              <h4>Staff Training Review - 06/08/2025</h4>
              <p>Reviewed training compliance and upcoming deadlines</p>
              <small style="color: #6b7280;">12 attendees • Meeting notes available</small>
            </div>
          `;
          console.log('Meeting history loaded');
        }
      } catch (error) {
        console.error('Error loading sample meetings:', error);
      }
    }
    
    function populateMeetingSelects() {
      try {
        console.log('Populating meeting selects...');
        const agendaSelect = document.getElementById('agenda-meeting-select');
        const notesSelect = document.getElementById('notes-meeting-select');
        
        if (!meetings || meetings.length === 0) {
          console.log('No meetings available to populate selects');
          return;
        }
        
        const options = meetings.map(m => `<option value="${m.id}">${m.title}</option>`).join('');
        
        if (agendaSelect) {
          agendaSelect.innerHTML = '<option value="">Select a meeting...</option>' + options;
          console.log('Agenda select populated');
        } else {
          console.log('Agenda select not found');
        }
        
        if (notesSelect) {
          notesSelect.innerHTML = '<option value="">Select a meeting...</option>' + options;
          console.log('Notes select populated');
        } else {
          console.log('Notes select not found');
        }
      } catch (error) {
        console.error('Error populating meeting selects:', error);
      }
    }
    
    function showMeetingDetails(event) {
      currentMeetingId = event.id;
      document.getElementById('modal-meeting-title').textContent = event.title;
      document.getElementById('modal-meeting-date').textContent = event.start.toLocaleString();
      document.getElementById('modal-meeting-description').textContent = event.extendedProps.description || '';
      
      // Show attendees
      const attendeesList = document.getElementById('modal-attendees');
      if (event.extendedProps.attendees) {
        attendeesList.innerHTML = '<h4>Attendees:</h4>' + 
          event.extendedProps.attendees.map(a => 
            `<span class="attendee-badge pending">${a}</span>`
          ).join('');
      }
      
      document.getElementById('meeting-modal').style.display = 'block';
    }
    
    function closeMeetingModal() {
      document.getElementById('meeting-modal').style.display = 'none';
    }
    
    async function acceptMeeting() {
      // In production, save to Supabase
      alert('You have accepted the meeting');
      closeMeetingModal();
    }
    
    async function declineMeeting() {
      // In production, save to Supabase
      alert('You have declined the meeting');
      closeMeetingModal();
    }
    
    async function submitAgendaItem() {
      const meetingId = document.getElementById('agenda-meeting-select').value;
      const title = document.getElementById('agenda-item-title').value;
      const description = document.getElementById('agenda-item-description').value;
      
      if (!meetingId || !title) {
        alert('Please select a meeting and enter a title');
        return;
      }
      
      // In production, save to Supabase
      const agendaList = document.getElementById('agenda-items-list');
      const newItem = document.createElement('div');
      newItem.className = 'agenda-item';
      newItem.innerHTML = `
        <h4>${title}</h4>
        <p>${description}</p>
        <small style="color: #6b7280;">Submitted by: You (just now)</small>
      `;
      agendaList.insertBefore(newItem, agendaList.firstChild);
      
      // Clear form
      document.getElementById('agenda-item-title').value = '';
      document.getElementById('agenda-item-description').value = '';
      
      alert('Agenda item submitted successfully');
    }
    
    async function generateMeetingPDF() {
      const meetingId = document.getElementById('notes-meeting-select').value;
      const notes = document.getElementById('meeting-notes-textarea').value;
      
      if (!meetingId || !notes) {
        alert('Please select a meeting and enter notes');
        return;
      }
      
      // Show processing status
      const statusDiv = document.getElementById('pdf-status');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<p style="margin: 0; color: #0369a1;">Processing with AI...</p>';
      
      try {
        // Simulate AI processing
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Format notes similar to the sample PDF
        const meeting = meetings.find(m => m.id === meetingId);
        const formattedNotes = await formatNotesWithAI(notes, meeting);
        
        // Generate PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Title
        doc.setFontSize(20);
        doc.text(meeting.title, 20, 20);
        
        // Date
        doc.setFontSize(12);
        doc.text('Date: ' + new Date().toLocaleDateString(), 20, 35);
        
        // Meeting notes
        doc.setFontSize(14);
        doc.text('Minutes of Meeting (MoM)', 20, 50);
        
        doc.setFontSize(11);
        const lines = doc.splitTextToSize(formattedNotes, 170);
        doc.text(lines, 20, 65);
        
        // Save the PDF
        doc.save(`meeting-notes-${meetingId}.pdf`);
        
        statusDiv.innerHTML = '<p style="margin: 0; color: #16a34a;">✓ PDF generated successfully!</p>';
        
        // Save to history (in production, save to Supabase)
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
        
      } catch (error) {
        console.error('Error generating PDF:', error);
        statusDiv.innerHTML = '<p style="margin: 0; color: #dc2626;">Error generating PDF. Please try again.</p>';
      }
    }
    
    async function formatNotesWithAI(notes, meeting) {
      // In production, this would call ChatGPT API
      // For now, simulate AI formatting
      const sections = notes.split('\n\n');
      
      let formatted = `Meeting Title: ${meeting.title}\n`;
      formatted += `Date: ${new Date().toLocaleDateString()}\n`;
      formatted += `Present: ${meeting.attendees ? meeting.attendees.join(', ') : 'Not specified'}\n\n`;
      
      formatted += '1. Agenda Overview\n';
      formatted += sections[0] + '\n\n';
      
      formatted += '2. Discussion Summary\n';
      sections.slice(1).forEach((section, index) => {
        formatted += `• ${section}\n`;
      });
      
      formatted += '\n3. Action Items\n';
      formatted += '• Follow up on discussed points\n';
      formatted += '• Schedule next meeting\n';
      
      return formatted;
    }
    
    function viewMeetingNotes(meetingId) {
      // Switch to notes tab and load the meeting
      switchTab('notes');
      document.getElementById('notes-meeting-select').value = meetingId;
      
      // Load sample notes
      if (meetingId === '1') {
        document.getElementById('meeting-notes-textarea').value = `ARTP Spirometry Course Requirements:
The ARTP course is now mandatory for spirometry. There is a waiting list to register. We need to register interest. Payment for spirometry is dependent on working towards accreditation.

Appointment and Rota Adjustments:
Shihara requested more review slots and proportional distribution of appointments. Issues with on-the-day vs. routine slots and balancing between clinicians. Black slots (protected review slots) are being booked by others, causing booking issues.

Reception Task Management:
Persistent high volume of reception tasks, especially those returned unnecessarily by certain clinicians. Need for clearer ground rules on what requires GP follow-up.

Trainee Induction and Feedback:
Recent induction for new trainees (Mimi and Reginald). Reginald is performing well; Mimi needs support with communication and attention. Rules for annual leave and working hours reiterated.

PCN Communication, Finance, and Staffing:
PCN communication has been poor; lack of transparency in finance, recruitment, and staff roles. New PCN manager (Paul) introduced, with a focus on improving operational processes, reporting, and transparency.`;
      }
    }
  </script>

  <script>
    (function(){
      function i8(name, opts){
        opts = opts || {}; 
        var style = opts.style || 'dusk';
        var size  = (opts.size == null) ? 48 : opts.size; // default 48px
        var base  = 'https://img.icons8.com';
        // Icons8 OMG-IMG pattern is style/size/name.png
        var path  = [style, String(size || 48), encodeURIComponent(name) + '.png'].join('/');
        return base + '/' + path;
      }
      function setIcon(el){
        var name  = el.getAttribute('data-i8');
        var size  = el.getAttribute('data-i8-size');
        var style = el.getAttribute('data-i8-style') || 'fluency';
        var fallback = (el.getAttribute('data-i8-fallback') || '').toLowerCase();
        
        if (fallback === 'auto') {
          var stylesToTry = [style, 'fluency', 'color'];
          var idx = 0;
          function tryNext(){
            if (idx >= stylesToTry.length) { el.onerror = null; return; }
            var url = i8(name, {style: stylesToTry[idx++], size: size ? parseInt(size,10) : undefined});
            if (el.src !== url) el.src = url; else tryNext();
          }
          el.onerror = tryNext;
          tryNext();
        } else {
          // Strict mode: stay in the requested style (default: dusk)
          var url = i8(name, {style: style, size: size ? parseInt(size,10) : undefined});
          el.src = url;
          el.onerror = null;
        }
        if (!el.alt) el.alt = (name || '').replace(/[\-_]/g,' ');
      }
      function wireIcons(){
        document.querySelectorAll('img[data-i8]').forEach(setIcon);
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', wireIcons);
      else wireIcons();
      window.i8 = i8; // optional helper for manual usage
    })();
  </script>
</body>
</html>

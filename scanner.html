enum BleState { BLE_IDLE, BLE_SCANNING, BLE_CONNECTING, BLE_PAIRED, BLE_ERROR };
BleState bleState = BLE_IDLE;
String bleErr = "";
String bleDeviceName = "";
String bleDeviceAddr = "";
int bleDeviceRSSI = 0;

volatile bool bleAutoPairRequest = false;
volatile bool bleAutoPairing = false;

// Simple page shown when pairing is started by POST /ble/start
String pagePairingKickoff() {
  String head = String("<!doctype html><html><head><meta name=viewport content='width=device-width,initial-scale=1,viewport-fit=cover'>"
                       "<meta name=color-scheme content='light dark'><title>Starting pairing…</title><style>")
                + cssDevice() + String("</style>"
                // try to refresh to the root every few seconds while Wi‑Fi cycles
                "<meta http-equiv='refresh' content='5;url=/'></head><body><div class='wrap'><div class='card'>");
  String html = head +
    F("<h1>Starting pairing…</h1>"
      "<p class='muted'>Your device will temporarily disconnect from Wi‑Fi to pair with the Eyoyo scanner over Bluetooth LE. This can take ~20–30 seconds.</p>"
      "<p class='muted'>The page will refresh when the device is back online. You should see a smiley on the LED matrix when paired.</p>"
      "<div class='row'><a href='/'><button class='ghost'>Try device page</button></a></div>"
      "</div></div></body></html>");
  return html;
}

// Device-led pairing task: temporarily drop Wi‑Fi, scan & connect Eyoyo, then restore Wi‑Fi
void bleAutoPairTask() {
  if (bleAutoPairing) return;
  bleAutoPairing = true;

  // Stop any ongoing scan
  if (bleState == BLE_SCANNING) bleStopScan();

  // Best-effort: disconnect from Wi‑Fi to maximize BLE reliability on UNO R4 WiFi
  WiFi.disconnect();
  delay(200);

  // Ensure BLE is ready
  if (!bleBeginOnce()) {
    bleState = BLE_ERROR; bleErr = "BLE init failed";
    bleAutoPairing = false;
    return;
  }

  // Attempt to auto-match an Eyoyo (name-based match)
  bool ok = bleConnectBy(String(""), String(""));
  if (ok) {
    // Show smiley already triggered in bleConnectBy(); ensure LED is on
    setLED(LED_ON);
  }

  // Restore Wi‑Fi using stored credentials (if present)
  if (haveCreds()) {
    connectWait(creds.ssid, creds.pass);
    server.begin();
  }

  bleAutoPairing = false;
}

// Start device-led pairing: reply immediately, then perform pairing in the main loop
if(m=="POST" && path=="/ble/start"){ 
  sendHttp(c,200,"text/html",pagePairingKickoff()); 
  c.flush(); 
  delay(50); 
  bleAutoPairRequest = true; 
  return; 
}

// Run device-led pairing if requested
if (bleAutoPairRequest && !bleAutoPairing) {
  bleAutoPairRequest = false;
  bleAutoPairTask();
}
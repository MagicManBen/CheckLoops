<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Set Up Your Password - CheckLoop</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="config.js"></script>
<script src="supabase-js.js"></script>
<style>
  :root {
    --bg1: #0b4fb3;
    --bg2: #062b6f;
    --glass: #ffffff12;
    --glass-2: #ffffff1a;
    --white: #e6f0ff;
    --muted: #b8c7e8;
    --ink: #eaf1ff;
    --accent: #76a7ff;
    --accent-2: #5f96ff;
    --success: #2bd4a7;
    --danger: #ff6b6b;
    --warning: #ffca28;
    --shadow: 0 10px 30px rgba(6, 43, 111, .35);
    --round: 18px;
    --panel-bg: linear-gradient(145deg, #133b8a, #0c275e);
    --border-color: #ffffff1f;
  }

  * {
    box-sizing: border-box;
  }

  html, body {
    height: 100%;
  }

  body {
    margin: 0;
    font-family: Inter, system-ui, -apple-system, sans-serif;
    color: var(--ink);
    background: linear-gradient(135deg, #0b3a86 0%, #062b6f 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .container {
    width: 100%;
    max-width: 440px;
  }

  .card {
    background: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--round);
    padding: 40px;
    box-shadow: var(--shadow);
  }

  .logo {
    text-align: center;
    margin-bottom: 32px;
  }

  .logo h1 {
    font-size: 32px;
    font-weight: 800;
    margin: 0;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .welcome-message {
    text-align: center;
    margin-bottom: 32px;
  }

  .welcome-message h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--white);
    margin: 0 0 8px 0;
  }

  .welcome-message p {
    color: var(--muted);
    font-size: 14px;
    margin: 0;
  }

  .user-info {
    background: var(--glass);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
  }

  .user-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
  }

  .user-info-label {
    color: var(--muted);
    font-size: 13px;
  }

  .user-info-value {
    color: var(--white);
    font-size: 14px;
    font-weight: 500;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    color: var(--white);
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
  }

  .form-input {
    width: 100%;
    padding: 12px 16px;
    background: var(--glass);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--white);
    font-size: 14px;
    transition: all 0.2s ease;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--accent);
    background: var(--glass-2);
  }

  .form-input::placeholder {
    color: var(--muted);
    opacity: 0.6;
  }

  .password-requirements {
    margin-top: 8px;
    padding: 12px;
    background: var(--glass);
    border-radius: 8px;
    font-size: 12px;
  }

  .requirement {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 4px 0;
    color: var(--muted);
    transition: color 0.2s ease;
  }

  .requirement.met {
    color: var(--success);
  }

  .requirement-icon {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--glass-2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    transition: all 0.2s ease;
  }

  .requirement.met .requirement-icon {
    background: var(--success);
    color: white;
  }

  .btn {
    width: 100%;
    padding: 14px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background: var(--accent);
    color: var(--white);
  }

  .btn-primary:hover:not(:disabled) {
    background: var(--accent-2);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(118, 167, 255, 0.4);
  }

  .btn-primary:disabled {
    background: var(--glass);
    color: var(--muted);
    cursor: not-allowed;
    transform: none;
  }

  .alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    display: none;
  }

  .alert.active {
    display: block;
  }

  .alert-success {
    background: rgba(43, 212, 167, 0.2);
    border: 1px solid var(--success);
    color: var(--success);
  }

  .alert-error {
    background: rgba(255, 107, 107, 0.2);
    border: 1px solid var(--danger);
    color: var(--danger);
  }

  .alert-warning {
    background: rgba(255, 202, 40, 0.2);
    border: 1px solid var(--warning);
    color: var(--warning);
  }

  .loading {
    text-align: center;
    padding: 40px;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--glass-2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-text {
    color: var(--muted);
    font-size: 14px;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .card {
    animation: fadeIn 0.5s ease, slideDown 0.5s ease;
  }
</style>
</head>
<body>

<div class="container">
  <div class="card" id="loadingCard" style="display: none;">
    <div class="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Verifying invitation...</div>
    </div>
  </div>

  <div class="card" id="mainCard" style="display: none;">
    <div class="logo">
      <h1>CheckLoop</h1>
    </div>

    <div class="welcome-message">
      <h2>Welcome!</h2>
      <p>Please set up your password to complete your registration</p>
    </div>

    <div class="user-info" id="userInfo" style="display: none;">
      <div class="user-info-row">
        <span class="user-info-label">Name:</span>
        <span class="user-info-value" id="userName">-</span>
      </div>
      <div class="user-info-row">
        <span class="user-info-label">Email:</span>
        <span class="user-info-value" id="userEmail">-</span>
      </div>
      <div class="user-info-row">
        <span class="user-info-label">Access Type:</span>
        <span class="user-info-value" id="userAccessType">-</span>
      </div>
    </div>

    <div id="alertMessage" class="alert"></div>

    <form id="passwordForm" onsubmit="handlePasswordSetup(event)">
      <div class="form-group">
        <label class="form-label" for="password">Password</label>
        <input
          type="password"
          id="password"
          class="form-input"
          placeholder="Enter your password"
          required
          oninput="checkPasswordStrength()"
        />
        <div class="password-requirements">
          <div class="requirement" id="req-length">
            <span class="requirement-icon">✓</span>
            <span>At least 8 characters</span>
          </div>
          <div class="requirement" id="req-uppercase">
            <span class="requirement-icon">✓</span>
            <span>One uppercase letter</span>
          </div>
          <div class="requirement" id="req-lowercase">
            <span class="requirement-icon">✓</span>
            <span>One lowercase letter</span>
          </div>
          <div class="requirement" id="req-number">
            <span class="requirement-icon">✓</span>
            <span>One number</span>
          </div>
          <div class="requirement" id="req-special">
            <span class="requirement-icon">✓</span>
            <span>One special character</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="confirmPassword">Confirm Password</label>
        <input
          type="password"
          id="confirmPassword"
          class="form-input"
          placeholder="Confirm your password"
          required
          oninput="checkPasswordMatch()"
        />
      </div>

      <button type="submit" id="submitBtn" class="btn btn-primary" disabled>
        Set Password & Continue
      </button>
    </form>
  </div>

  <div class="card" id="errorCard" style="display: none;">
    <div class="logo">
      <h1>CheckLoop</h1>
    </div>
    <div class="alert alert-error active" id="errorMessage">
      Invalid or expired invitation link
    </div>
  </div>
</div>

<script type="module">
  const { createClient } = supabase;

  // Initialize Supabase client
  const sb = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
  window.supabase = sb;

  let invitationData = null;

  // Check password strength
  window.checkPasswordStrength = function() {
    const password = document.getElementById('password').value;

    // Check requirements
    const requirements = {
      'req-length': password.length >= 8,
      'req-uppercase': /[A-Z]/.test(password),
      'req-lowercase': /[a-z]/.test(password),
      'req-number': /\d/.test(password),
      'req-special': /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
    };

    // Update UI
    let allMet = true;
    for (const [id, met] of Object.entries(requirements)) {
      const element = document.getElementById(id);
      if (met) {
        element.classList.add('met');
      } else {
        element.classList.remove('met');
        allMet = false;
      }
    }

    // Check if passwords match
    checkPasswordMatch();
  }

  // Check if passwords match
  window.checkPasswordMatch = function() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const submitBtn = document.getElementById('submitBtn');

    // Check if all password requirements are met
    const requirementsMet =
      password.length >= 8 &&
      /[A-Z]/.test(password) &&
      /[a-z]/.test(password) &&
      /\d/.test(password) &&
      /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);

    // Enable submit button only if requirements are met and passwords match
    if (requirementsMet && password === confirmPassword && confirmPassword !== '') {
      submitBtn.disabled = false;
    } else {
      submitBtn.disabled = true;
    }
  }

  // Handle password setup
  window.handlePasswordSetup = async function(event) {
    event.preventDefault();

    const submitBtn = document.getElementById('submitBtn');
    const alertDiv = document.getElementById('alertMessage');
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // Validate passwords match
    if (password !== confirmPassword) {
      showAlert('Passwords do not match', 'error');
      return;
    }

    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Setting up...';

    try {
      // Create auth user with Supabase Auth
      const { data: authData, error: authError } = await sb.auth.signUp({
        email: invitationData.email,
        password: password,
        options: {
          data: {
            name: invitationData.name,
            access_type: invitationData.access_type
          }
        }
      });

      if (authError) throw authError;

      // Update the master_users record with service client
      const serviceClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_SERVICE_KEY || CONFIG.SUPABASE_ANON_KEY);

      const { error: updateError } = await serviceClient
        .from('master_users')
        .update({
          auth_user_id: authData.user.id,
          invitation_token: null,
          invitation_expires_at: null,
          updated_at: new Date().toISOString()
        })
        .eq('id', invitationData.id);

      if (updateError) {
        console.error('Error updating user record:', updateError);
        // Continue anyway - the auth user is created
      }

      // Show success message
      showAlert('Password set successfully! Redirecting...', 'success');

      // Redirect to staff welcome page after 2 seconds
      setTimeout(() => {
        window.location.href = 'staff-welcome.html';
      }, 2000);

    } catch (error) {
      console.error('Error setting up password:', error);
      showAlert(`Error: ${error.message}`, 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Set Password & Continue';
    }
  }

  // Show alert message
  function showAlert(message, type) {
    const alertDiv = document.getElementById('alertMessage');
    alertDiv.className = `alert alert-${type} active`;
    alertDiv.textContent = message;
  }

  // Load invitation data
  async function loadInvitation() {
    const loadingCard = document.getElementById('loadingCard');
    const mainCard = document.getElementById('mainCard');
    const errorCard = document.getElementById('errorCard');

    // Show loading
    loadingCard.style.display = 'block';
    mainCard.style.display = 'none';
    errorCard.style.display = 'none';

    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (!token) {
      loadingCard.style.display = 'none';
      errorCard.style.display = 'block';
      document.getElementById('errorMessage').textContent = 'No invitation token provided';
      return;
    }

    try {
      // Use service client to bypass RLS for checking invitation
      const serviceClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_SERVICE_KEY || CONFIG.SUPABASE_ANON_KEY);

      // Fetch invitation data
      const { data, error } = await serviceClient
        .from('master_users')
        .select('*')
        .eq('invitation_token', token)
        .single();

      if (error || !data) {
        throw new Error('Invalid invitation token');
      }

      // Check if invitation has expired
      if (data.invitation_expires_at) {
        const expiryDate = new Date(data.invitation_expires_at);
        if (expiryDate < new Date()) {
          throw new Error('This invitation has expired');
        }
      }

      // Check if already activated
      if (data.auth_user_id) {
        throw new Error('This invitation has already been used');
      }

      // Store invitation data
      invitationData = data;

      // Update UI with user info
      document.getElementById('userName').textContent = data.name || '-';
      document.getElementById('userEmail').textContent = data.email || '-';
      document.getElementById('userAccessType').textContent = (data.access_type || '-').toUpperCase();
      document.getElementById('userInfo').style.display = 'block';

      // Show main card
      loadingCard.style.display = 'none';
      mainCard.style.display = 'block';

    } catch (error) {
      console.error('Error loading invitation:', error);
      loadingCard.style.display = 'none';
      errorCard.style.display = 'block';
      document.getElementById('errorMessage').textContent = error.message || 'Invalid or expired invitation link';
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', loadInvitation);
</script>

</body>
</html>
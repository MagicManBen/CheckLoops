<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — Staff Meetings (Simple)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="admin-nav.js"></script>
  <link rel="stylesheet" href="staff.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{ --ink:#0f172a; --muted:#475569; --line:rgba(15,23,42,.08); --bg:#f7f8fb; --card:#fff; --brand:#3b82f6; --brand-2:#2563eb; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .content{max-width:1100px;margin:0 auto;padding:16px 16px 40px}
    .panel{position:relative;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.06)}
    .panel-header{display:flex;align-items:center;gap:12px;padding:18px 20px;border-bottom:1px solid var(--line)}
    .panel-title{font-size:22px;font-weight:800}
    .layout{display:grid;grid-template-columns:420px 1fr;gap:18px;padding:18px}
    @media (max-width:940px){.layout{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,.05)}
    .card h3{margin:0 0 12px;font-size:18px;font-weight:800}
    label{font-size:14px;font-weight:600;color:#334155;margin-bottom:6px;display:block}
    input[type=text],input[type=date],input[type=time],select,textarea{width:100%;padding:14px 12px;border:1px solid #e2e8f0;border-radius:10px;background:#fff;font-size:16px}
    textarea{min-height:320px;resize:vertical}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--ink)}
    .btn.danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .list{display:grid;gap:10px}
    .item{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer}
    .item-title{font-weight:700}
    .item-sub{font-size:13px;color:var(--muted)}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,.5);display:none}
    .overlay.active{display:block}
    .modal{position:fixed;inset:0;display:none;place-items:center;padding:20px}
    .modal.active{display:grid}
    .modal-card{position:relative;width:min(900px,96vw);max-height:92vh;overflow:hidden;border-radius:16px;background:#fff;border:1px solid var(--line);box-shadow:0 20px 60px rgba(2,6,23,.25)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--line);background:#fff}
    .modal-title{font-size:20px;font-weight:900}
    .modal-sub{font-size:14px;color:var(--muted);margin-top:2px}
    .modal-body{padding:16px 18px;overflow-y:auto;max-height:calc(92vh - 140px)}
    .actions{display:flex;gap:10px;align-items:center}
    .chips{display:flex;flex-wrap:wrap;gap:8px;padding:8px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;font-weight:700}
    .chip button{border:none;background:transparent;cursor:pointer;font-weight:900}
    .chips input{border:none;outline:none;min-width:140px;font-size:15px;padding:6px}
    .record-btn{position:absolute;right:16px;top:16px;width:40px;height:40px;border-radius:999px;border:none;background:#ef4444;color:#fff;font-weight:900;display:grid;place-items:center;cursor:pointer}
    .record-btn.recording{animation:pulse 1.2s infinite ease-in-out;box-shadow:0 0 0 0 rgba(239,68,68,.7)}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(239,68,68,.7)}70%{box-shadow:0 0 0 16px rgba(239,68,68,0)}100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}}
    .toast{margin-top:10px;padding:10px 12px;border-radius:10px;background:#f0f9ff;color:#075985;border:1px solid #bae6fd;display:none}
  </style>
</head>
<body>
  <div class="content">
    <div class="topbar panel" style="position:relative;">
      <div class="nav seg-nav"></div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: —</div>
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
      <button class="btn ghost" id="logout-btn">Sign Out</button>
    </div>

    <section class="panel" style="margin-top:12px">
      <div class="panel-header">
        <div class="panel-title">Meetings</div>
      </div>

      <div class="layout">
        <div class="card">
          <h3>Quick Create</h3>
          <div class="field">
            <label>Title *</label>
            <input id="m-title" type="text" placeholder="e.g. Partners meeting">
          </div>
          <div class="grid-2" style="margin-top:10px">
            <div>
              <label>Type</label>
              <select id="m-type">
                <option value="general">General</option>
                <option value="partners">Partners</option>
                <option value="staff">Staff</option>
                <option value="training">Training</option>
                <option value="pcn">PCN</option>
                <option value="clinical">Clinical</option>
              </select>
            </div>
            <div></div>
          </div>
          <div class="grid-2" style="margin-top:10px">
            <div>
              <label>Date *</label>
              <input id="m-date" type="date">
            </div>
            <div>
              <label>Time *</label>
              <input id="m-time" type="time">
            </div>
          </div>
          <div style="margin-top:14px;display:flex;gap:10px;justify-content:flex-end">
            <button class="btn primary" id="create-btn">Create Meeting</button>
          </div>
          <div id="create-toast" class="toast"></div>
        </div>

        <div class="card">
          <h3>Upcoming</h3>
          <div id="list" class="list"></div>
          <div id="empty" style="display:none;color:#64748b;padding:12px;text-align:center">No upcoming meetings</div>
        </div>
      </div>
    </section>

    <div class="muted" style="text-align:center;font-size:12px;padding:10px 0">© CheckLoop • Staff Meetings</div>
  </div>

  <div id="overlay" class="overlay" onclick="closeModal(event)"></div>
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <button id="recordToggle" class="record-btn" title="Record">●</button>
      <div class="modal-head">
        <div>
          <div class="modal-title" id="modalTitle">Meeting</div>
          <div class="modal-sub" id="modalSub">—</div>
        </div>
        <div class="actions">
          <button class="btn ghost" id="pdfBtn">Export PDF</button>
          <button class="btn danger" id="deleteBtn">Cancel Meeting</button>
          <button class="btn ghost" onclick="closeModal()">Close</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>Attendees</label>
          <div class="chips" id="chips">
            <input id="attendeeInput" list="attendeeSuggestions" placeholder="Type a name and press Enter">
            <datalist id="attendeeSuggestions"></datalist>
          </div>
        </div>
        <div class="field" style="margin-top:12px">
          <label>Meeting notes</label>
          <textarea id="notes" placeholder="Type notes here…"></textarea>
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
            <button class="btn ghost" id="saveBtn">Save Notes</button>
          </div>
          <div id="status" class="toast"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, clearAuthData } from './staff-common.js';
    import { MeetingsManager } from './meetings-module.js';

    const supabase = await initSupabase();
    handleAuthState(supabase); navActivate('meetings');
    window.supabase = supabase; window.meetingsManager = null;

    let siteId = null; let isLoggingOut = false; let meetings = []; let currentMeetingId = null; let currentRecorder = null; let mediaStream = null;

    function cleanupAndRedirect(){ try{clearAuthData(true)}catch(_){ } try{sessionStorage.clear()}catch(_){ } try{document.cookie.split(';').forEach(c=>document.cookie=c.replace(/^ +/,'').replace(/=.*/,`=;expires=${new Date(0).toUTCString()};path=/`))}catch(_){ } window.location.replace('home.html?_='+Date.now()) }
    async function forceLogout(){ if(isLoggingOut) return; isLoggingOut = true; try{ const { data } = await supabase.auth.getSession(); if(data?.session) await supabase.auth.signOut(); }catch(e){ console.error('Supabase signOut failed:', e) } cleanupAndRedirect() }
    document.getElementById('logout-btn').addEventListener('click', async (e)=>{ e.preventDefault(); e.stopPropagation(); await forceLogout() })

    requireStaffSession(supabase).then(async ({ session, profileRow }) => {
      siteId = profileRow?.site_id || session.user?.raw_user_meta_data?.site_id || null;
      const role = (profileRow?.role || session.user?.raw_user_meta_data?.role || 'Staff');
      setTopbar({ siteText: await getSiteText(supabase, siteId), email: session.user.email, role });
      window.meetingsManager = new MeetingsManager(supabase); await window.meetingsManager.setContext(session);
      await populateAttendeeSuggestions();
      await refreshList();
    }).catch(e=>{ if(String(e.message).includes('NO_SESSION')||String(e.message).includes('NOT_STAFF')){ window.location.replace('home.html'); return } console.error(e) })

    document.getElementById('create-btn').addEventListener('click', createSimpleMeeting);

    async function createSimpleMeeting(){
      const title = document.getElementById('m-title').value.trim();
      const type = document.getElementById('m-type').value;
      const date = document.getElementById('m-date').value;
      const time = document.getElementById('m-time').value;
      if(!title || !date || !time){ showToast('create-toast','Please enter title, date and time.'); return }
      const [y,m,d] = date.split('-').map(Number); const [hh,mm] = time.split(':').map(Number);
      const startIso = new Date(y, m-1, d, hh, mm, 0).toISOString();
      try{
        const meeting = await window.meetingsManager.createMeeting({ title, description:'', start:startIso, end:null, location:'', meeting_type:type });
        document.getElementById('m-title').value=''; document.getElementById('m-date').value=''; document.getElementById('m-time').value='';
        await refreshList(); openMeeting(meeting.id);
      }catch(e){ console.error(e); showToast('create-toast','Failed to create meeting.') }
    }

    async function refreshList(){
      const list = document.getElementById('list'); const empty = document.getElementById('empty');
      const upcoming = await window.meetingsManager.getUpcomingMeetings(20);
      meetings = upcoming; list.innerHTML = '';
      if(!upcoming || upcoming.length===0){ empty.style.display='block'; return } else { empty.style.display='none' }
      for(const m of upcoming){
        const dt = new Date(m.start);
        const el = document.createElement('div'); el.className='item'; el.onclick = ()=>openMeeting(m.id);
        el.innerHTML = `<div><div class="item-title">${escapeHtml(m.title)}</div><div class="item-sub">${dt.toLocaleDateString()} · ${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} • ${m.meeting_type||'general'}</div></div><div class="item-sub">Open ›</div>`
        list.appendChild(el);
      }
    }

    const overlay = document.getElementById('overlay'); const modal = document.getElementById('modal');
    document.getElementById('deleteBtn').addEventListener('click', onDelete);
    document.getElementById('saveBtn').addEventListener('click', saveNotesAndAttendees);
    document.getElementById('pdfBtn').addEventListener('click', generatePDF);
    document.getElementById('recordToggle').addEventListener('click', toggleRecording);

    async function openMeeting(id){
      currentMeetingId = id; const m = meetings.find(x=>x.id===id) || (await window.meetingsManager.getMeetings()).find(x=>x.id===id);
      if(!m) return;
      document.getElementById('modalTitle').textContent = m.title || 'Meeting';
      const dt = new Date(m.start); document.getElementById('modalSub').textContent = `${dt.toLocaleDateString()} • ${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
      const notes = await window.meetingsManager.getMeetingNotes(id); document.getElementById('notes').value = notes?.content || '';
      await loadAttendeesChips(id);
      overlay.classList.add('active'); modal.classList.add('active');
    }

    function closeModal(ev){ if(ev && ev.target!==ev.currentTarget) return; overlay.classList.remove('active'); modal.classList.remove('active'); stopRecordingIfActive(); }
    window.closeModal = closeModal;

    async function onDelete(){ if(!currentMeetingId) return; if(!confirm('Delete this meeting?')) return; try{ await window.meetingsManager.deleteMeeting(currentMeetingId); closeModal(); await refreshList(); }catch(e){ alert('Failed to delete meeting') } }

    const chipsEl = document.getElementById('chips'); const inputEl = document.getElementById('attendeeInput'); const dataList = document.getElementById('attendeeSuggestions');
    let chipValues = [];
    function addChip(name){ name = name.trim(); if(!name) return; if(chipValues.includes(name)) return; chipValues.push(name); const c = document.createElement('span'); c.className='chip'; c.innerHTML = `${escapeHtml(name)} <button title="Remove">×</button>`; c.querySelector('button').onclick = ()=>{ chipValues = chipValues.filter(v=>v!==name); chipsEl.removeChild(c) }; chipsEl.insertBefore(c, inputEl); inputEl.value=''; }
    function resetChips(){ chipValues=[]; document.querySelectorAll('.chip').forEach(c=>c.remove()) }
    inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===','){ e.preventDefault(); addChip(inputEl.value) } })

    async function populateAttendeeSuggestions(){ try{ const { data } = await supabase.from('profiles').select('full_name,email').eq('site_id', siteId); dataList.innerHTML=''; (data||[]).forEach(p=>{ const o=document.createElement('option'); o.value = p.full_name || p.email; dataList.appendChild(o) }); }catch(_){}}
    async function loadAttendeesChips(meetingId){ resetChips(); const list = await window.meetingsManager.getMeetingAttendees(meetingId); (list||[]).forEach(a=> addChip(a.name || a.email || 'Unknown')) }
    async function persistChips(){ if(!currentMeetingId) return; const existing = await window.meetingsManager.getMeetingAttendees(currentMeetingId); const existingNames = new Set((existing||[]).map(a=> (a.name||a.email||'').toLowerCase().trim())); const toInsert = chipValues.filter(n=>!existingNames.has(n.toLowerCase().trim())).map(n=>({ meeting_id: currentMeetingId, name: n })); if(toInsert.length){ await supabase.from('meeting_attendees').insert(toInsert) } }

    async function saveNotesAndAttendees(){ if(!currentMeetingId) return; const content = document.getElementById('notes').value; try{ await window.meetingsManager.saveMeetingNotes(currentMeetingId, content); await persistChips(); showToast('status','Saved'); }catch(e){ console.error(e); showToast('status','Save failed') } }

    async function toggleRecording(){ const btn = document.getElementById('recordToggle'); if(btn.classList.contains('recording')){ if(currentRecorder && currentRecorder.state !== 'inactive'){ currentRecorder.stop() } stopRecordingIfActive(); } else { try{ mediaStream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true } }); currentRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm;codecs=opus' }); const chunks = []; currentRecorder.ondataavailable = (ev)=>{ if(ev.data.size>0) chunks.push(ev.data) }; currentRecorder.onstop = async ()=>{ const blob = new Blob(chunks, { type:'audio/webm' }); const file = new File([blob], `recording_${Date.now()}.webm`, { type:'audio/webm' }); await handleTranscript(file); }; currentRecorder.start(1000); btn.classList.add('recording'); }catch(e){ alert('Microphone permission needed') } } }
    function stopRecordingIfActive(){ const btn = document.getElementById('recordToggle'); if(btn.classList.contains('recording')) btn.classList.remove('recording'); if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null } }

    async function handleTranscript(file){ if(!currentMeetingId) return; try{ const transcript = await window.meetingsManager.transcribeRecording(file, currentMeetingId); const textarea = document.getElementById('notes'); const existing = textarea.value.trim(); textarea.value = existing ? `${existing}\n\n${transcript}` : transcript; autoPopulateAttendeesFromText(transcript); showToast('status','Recording transcribed'); } catch(e){ console.error(e); showToast('status','Transcription failed') } }
    function autoPopulateAttendeesFromText(text){ const block = /Attendees[^\n]*\n([\s\S]*?)(\n\n|Discussion|Agenda|Action|$)/i.exec(text); if(block && block[1]){ const lines = block[1].split(/\n+/).map(s=>s.replace(/^[-•]\s*/,'').trim()).filter(Boolean); lines.forEach(addChip) } }

    async function generatePDF(){ if(!currentMeetingId) return; try{ const content = await window.meetingsManager.exportMeetingToPDF(currentMeetingId); const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit:'pt', format:'a4' }); const margin = 48; let y = margin; doc.setFont('helvetica','bold'); doc.setFontSize(20); doc.text(content.title || 'Meeting', margin, y); y += 20; doc.setFont('helvetica',''); doc.setFontSize(12); doc.text((content.date || '') + (content.location ? `  •  ${content.location}` : ''), margin, y); y += 22; doc.setDrawColor(37,99,235); doc.setLineWidth(2); doc.line(margin, y, 595-margin, y); y += 18; doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.text('Attendees', margin, y); y += 14; doc.setFont('helvetica',''); doc.setFontSize(12); const att = (content.attendees && content.attendees.length? content.attendees : chipValues).map(a=> (typeof a==='string'? a : (a.name || a.email || ''))); y = writeBullets(doc, att, margin, y); y += 6; doc.setDrawColor(226,232,240); doc.line(margin, y, 595-margin, y); y += 18; doc.setFont('helvetica','bold'); doc.text('Agenda', margin, y); y += 14; doc.setFont('helvetica',''); y = writeBullets(doc, content.agenda || [], margin, y); y += 6; doc.setDrawColor(226,232,240); doc.line(margin, y, 595-margin, y); y += 18; doc.setFont('helvetica','bold'); doc.text('Notes', margin, y); y += 14; doc.setFont('helvetica',''); const notesText = document.getElementById('notes').value || content.notes || ''; const wrapped = doc.splitTextToSize(notesText, 595 - margin*2); wrapped.forEach(line=>{ if(y>790){ doc.addPage(); y = margin } doc.text(line, margin, y); y += 16 }); doc.save(`meeting-${currentMeetingId}.pdf`); }catch(e){ console.error(e); showToast('status','PDF error') } }

    function writeBullets(doc, items, x, y){ if(!items || !items.length){ doc.setFontSize(12); doc.text('—', x, y); return y+16 } for(const t of items){ const lines = doc.splitTextToSize(typeof t==='string'? t : String(t), 595 - x*2 - 14); for(let i=0;i<lines.length;i++){ if(y>790){ doc.addPage(); y = 48 } if(i===0){ doc.circle(x+3, y-3, 2, 'F'); doc.text(lines[i], x+12, y) } else { doc.text(lines[i], x+12, y) } y += 16 } } return y }

    function showToast(id, msg){ const el=document.getElementById(id); el.textContent=msg; el.style.display='block'; setTimeout(()=> el.style.display='none', 2000) }
    function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;' }[m])) }
  </script>
</body>
</html>

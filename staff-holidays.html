<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop ‚Äî My Holidays</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://img.icons8.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="admin-nav.js"></script>
  <link rel="stylesheet" href="staff.css">
  <style>
    /* Holiday-specific styles aligned with staff.css */
    .subtitle{ color:#64748b; font-weight:600; }
    
    .holiday-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .holiday-stat {
      background: white;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      transition: all 0.3s ease;
    }
    
    .holiday-stat:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    .holiday-stat-value {
      font-size: 2.2em;
      font-weight: 900;
      background: linear-gradient(135deg, #667eea, #764ba2);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
      display: block;
    }
    
    .holiday-stat-label {
      font-size: 0.9em;
      color: #475569; /* slate-600 for contrast on white */
      margin-top: 4px;
      font-weight: 700;
      text-shadow: none; /* remove fuzziness on white */
    }
    
    .holiday-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 24px;
    }
    
    .holiday-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .holiday-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .holiday-btn.secondary {
      background: #ffffff;
      border: 2px solid #cbd5e1; /* clearer border */
      color: #0f172a; /* dark text regardless of CSS vars */
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .holiday-btn.secondary:hover {
      background: #f1f5f9; /* slate-100 */
      border-color: #667eea;
    }
    
    .holiday-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .holiday-item {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      transition: all 0.3s ease;
    }
    
    .holiday-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    .holiday-item.pending {
      border-left: 4px solid #fbbf24;
    }
    
    .holiday-item.approved {
      border-left: 4px solid #10b981;
    }
    
    .holiday-item.declined {
      border-left: 4px solid #ef4444;
    }
    
    .holiday-item.cancelled {
      opacity: 0.6;
      border-left: 4px solid #9ca3af;
    }
    
    .holiday-info h4 {
      margin: 0 0 8px 0;
      color: var(--ink);
      font-weight: 700;
      font-size: 16px;
    }
    
    .holiday-info p {
      margin: 4px 0;
      color: #334155; /* slate-700 on white cards */
      font-size: 14px;
      line-height: 1.5;
      font-weight: 500;
      text-shadow: none; /* crisp text */
    }
    
    .holiday-status {
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .holiday-status.pending {
      background: #fef3c7;
      color: #d97706;
    }
    
    .holiday-status.approved {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .holiday-status.declined {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .holiday-status.cancelled {
      background: #f3f4f6;
      color: #6b7280;
    }
    
    .team-member {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: white;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      transition: all 0.3s ease;
    }
    
    .team-member:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .team-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .countdown-section {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 16px;
      padding: 32px;
      color: white;
      text-align: center;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .countdown-section::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: pulse 4s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    .countdown-timer {
      font-size: 3em;
      font-weight: 900;
      margin: 20px 0;
      text-shadow: 0 2px 8px rgba(0,0,0,0.2);
      position: relative;
      z-index: 1;
    }
    
    .countdown-destination {
      font-size: 1.4em;
      font-weight: 600;
      opacity: 0.95;
      position: relative;
      z-index: 1;
    }
    
    /* Modal: stronger backdrop and high-contrast content */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(2,6,23,0.7); /* darker backdrop to reduce washout */
      backdrop-filter: blur(10px) saturate(80%);
      -webkit-backdrop-filter: blur(10px) saturate(80%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: #ffffff; /* solid white for maximum contrast */
      color: #0f172a; /* dark text in modal */
      margin: 0 auto;
      padding: 28px;
      border-radius: 18px;
      width: 100%;
      max-width: 640px;
      border: 1px solid rgba(15,23,42,0.06);
      box-shadow: 0 30px 80px rgba(2,6,23,0.35);
      animation: slideUp 0.28s cubic-bezier(.2,.9,.3,1);
    }
    
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal h3 {
      margin: 0 0 24px 0;
      color: var(--ink);
      font-size: 24px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--ink);
      font-weight: 600;
    }
    
    /* High-contrast form controls inside the page + modal */
    .form-group input, 
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(15,23,42,0.06);
      background: #ffffff; /* white inputs for contrast */
      color: #0f172a; /* dark text */
      font-family: inherit;
      transition: all 0.18s ease;
    }

    /* Custom date input look with calendar icon */
    .form-group input[type="date"] {
      -webkit-appearance: none;
      appearance: none;
      position: relative;
      font-size: 18px; /* larger readable value */
      line-height: 1.2;
      height: 52px; /* taller control */
      padding: 12px 54px 12px 14px; /* room for icon */
      border-radius: 12px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="%23627488" stroke-width="1.6"><rect x="3" y="5" width="18" height="16" rx="2"/><path d="M8 3v4M16 3v4M3 11h18"/></svg>');
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-size: 22px 22px; /* bigger icon */
      cursor: pointer;
      box-sizing: border-box;
    }
    /* Hide native indicator but keep it clickable */
    .form-group input[type="date"]::-webkit-calendar-picker-indicator{
      opacity: 0; /* keep native control clickable but visually hidden */
      position: absolute;
      inset: 0;
      cursor: pointer;
      width: 100%; height: 100%;
    }
    /* Improve legibility of the value pieces */
    .form-group input[type="date"]::-webkit-datetime-edit,
    .form-group input[type="date"]::-webkit-datetime-edit-text,
    .form-group input[type="date"]::-webkit-datetime-edit-month-field,
    .form-group input[type="date"]::-webkit-datetime-edit-day-field,
    .form-group input[type="date"]::-webkit-datetime-edit-year-field {
      color:#0f172a; /* dark value */
      font-size: 18px; /* scale the value pieces */
      font-weight: 600;
      letter-spacing: 0.2px;
    }

    /* Custom select with chevron */
    .form-group select{
      -webkit-appearance: none;
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23627488" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 14px 14px;
      padding-right: 40px;
      cursor: pointer;
    }

    /* Placeholder color */
    .form-group input::placeholder, .form-group textarea::placeholder { color:#64748b; }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      background: #ffffff;
      box-shadow: 0 6px 24px rgba(102, 126, 234, 0.08);
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 32px;
    }
    
    .close {
      color: var(--muted);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      margin-top: -8px;
      transition: all 0.3s ease;
    }
    
    .close:hover {
      color: var(--ink);
      transform: rotate(90deg);
    }
    
    .admin-comments {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      color: var(--ink);
    }
    
    .admin-comments strong {
      color: #dc2626;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #f0f8ff;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.7;
    }
    
    .empty-state p {
      margin: 8px 0;
      font-size: 14px;
      font-weight: 500;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    
    @media (max-width: 768px) {
      .holiday-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .holiday-actions {
        flex-direction: column;
      }
      
      .holiday-btn {
        width: 100%;
      }
      
      .holiday-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .modal-content {
        margin: 10% auto;
        width: 95%;
        padding: 20px;
      }
      
      .countdown-timer {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
    <div class="particles" id="particles"></div>
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>
  </div>
  <main class="content">
    <!-- Top Navigation Bar -->
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav">
        <!-- Navigation will be rendered by staff-common.js -->
      </div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: ‚Äî</div>
      <div class="pill" id="email-pill">‚Äî</div>
      <div class="pill" id="role-pill">‚Äî</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>

    <!-- Hero Section -->
    <section class="panel" style="margin:0; position:relative; overflow:hidden;">
      <div class="halo"></div>
      <div class="hero">
        <div style="flex: 1;">
          <div class="subtitle" id="site-subtitle">Holiday Management</div>
          <div class="h1" style="font-size:32px;">My Holidays</div>
          <p class="muted" style="margin-top:10px;">Manage your holiday requests, view your entitlements, and plan time off with your team.</p>
        </div>
      </div>
    </section>

    <!-- Upcoming Holiday Countdown -->
    <div id="countdown-section" class="countdown-section" style="display: none;">
      <div class="countdown-destination" id="countdown-destination">üèñÔ∏è Holiday to Spain</div>
      <div class="countdown-timer" id="countdown-timer">15 days to go!</div>
      <div id="holiday-avatar-image" style="margin: 16px 0;"></div>
    </div>

    <!-- Holiday Summary -->
    <section class="panel">
      <div class="panel-header" style="margin-bottom: 20px;">
        <div class="illus-circle"><img data-i8="calendar" data-i8-size="48" alt="Calendar"></div>
        <div class="panel-title">Holiday Entitlements</div>
      </div>
      <div class="holiday-grid" id="holiday-summary">
        <div class="holiday-stat">
          <span class="holiday-stat-value" id="total-entitlement">0</span>
          <div class="holiday-stat-label">Total Entitlement</div>
        </div>
        <div class="holiday-stat">
          <span class="holiday-stat-value" id="used-holidays">0</span>
          <div class="holiday-stat-label">Used</div>
        </div>
        <div class="holiday-stat">
          <span class="holiday-stat-value" id="remaining-holidays">0</span>
          <div class="holiday-stat-label">Remaining</div>
        </div>
        <div class="holiday-stat">
          <span class="holiday-stat-value" id="pending-holidays">0</span>
          <div class="holiday-stat-label">Pending Approval</div>
        </div>
      </div>

      <div class="holiday-actions">
        <button class="holiday-btn" onclick="openRequestModal()">üèñÔ∏è Request Holiday</button>
        <button class="holiday-btn secondary" onclick="refreshHolidayData()">‚Üª Refresh</button>
      </div>
    </section>

    <!-- My Holiday Requests -->
    <section class="panel">
      <div class="panel-header" style="margin-bottom: 20px;">
        <div class="illus-circle"><img data-i8="airplane-mode" data-i8-size="48" alt="Holidays"></div>
        <div class="panel-title">My Holiday Requests</div>
      </div>
      <div class="holiday-list" id="my-holidays">
        <div class="empty-state">
          <div class="empty-state-icon">üìÖ</div>
          <p>Loading your holiday requests...</p>
        </div>
      </div>
    </section>

    <!-- Team Holidays -->
    <section class="panel">
      <div class="panel-header" style="margin-bottom: 20px;">
        <div class="illus-circle"><img data-i8="conference" data-i8-size="48" alt="Team"></div>
        <div class="panel-title">Team Holidays</div>
      </div>
      <p style="color: var(--muted); margin-bottom: 20px;">See when your team members are on holiday to help plan your requests.</p>
      <div id="team-holidays">
        <div class="empty-state">
          <div class="empty-state-icon">üë•</div>
          <p>Loading team holidays...</p>
        </div>
      </div>
    </section>
    
    <div class="muted" style="text-align:center; font-size:12px; padding:10px 0;">¬© CheckLoop ‚Ä¢ Staff</div>
  </main>

  <!-- Request Holiday Modal -->
  <div id="request-modal" class="modal" style="color: #0f172a;">
    <div class="modal-content">
      <span class="close" onclick="closeRequestModal()">&times;</span>
      <h3>Request Holiday</h3>
      <form id="holiday-request-form">
        <div class="form-group">
          <label for="start-date">Start Date</label>
          <input type="date" id="start-date" name="start-date" required style="background:#ffffff;color:#0f172a;border:1px solid rgba(15,23,42,0.08);padding:10px;border-radius:10px;">
        </div>
        <div class="form-group">
          <label for="end-date">End Date</label>
          <input type="date" id="end-date" name="end-date" required style="background:#ffffff;color:#0f172a;border:1px solid rgba(15,23,42,0.08);padding:10px;border-radius:10px;">
        </div>
        <div class="form-group">
          <label for="request-type">Request Type</label>
          <select id="request-type" name="request-type" required style="background:#ffffff;color:#0f172a;border:1px solid rgba(15,23,42,0.08);padding:10px;border-radius:10px;">
            <option value="holiday">Holiday</option>
            <option value="time_in_lieu">Time in Lieu</option>
            <option value="education" id="education-option" style="display: none;">Education (GP Only)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="destination">Holiday Destination (Optional)</label>
          <input type="text" id="destination" name="destination" placeholder="e.g., Spain, Paris, Dubai" style="background:#ffffff;color:#0f172a;border:1px solid rgba(15,23,42,0.08);padding:10px;border-radius:10px;">
          <small style="color: var(--muted); display: block; margin-top: 8px;">Add a destination for holiday countdown feature</small>
        </div>
        <div class="form-actions">
          <button type="button" class="holiday-btn secondary" onclick="closeRequestModal()">Cancel</button>
          <button type="submit" class="holiday-btn">Submit Request</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, renderStaffNavigation, attachLogout, handleAuthState, navActivate, revealAdminNav } from './staff-common.js';

    let supabase, currentUser, profileRow, isGP = false;

    async function initializePage() {
      supabase = await initSupabase();
      handleAuthState(supabase);
      attachLogout(supabase);

      try {
        const result = await requireStaffSession(supabase);
        currentUser = result.session.user;
        profileRow = result.profileRow;
        
        // Check if user is a GP
        const role = (profileRow?.role || currentUser?.raw_user_meta_data?.role || '').toLowerCase();
        isGP = role === 'gp';
        
        if (isGP) {
          document.getElementById('education-option').style.display = 'block';
        }

        // Set up navigation
        renderStaffNavigation('holidays');
        navActivate('holidays');
        
        // Reveal admin navigation if user is admin/owner
        if (role === 'admin' || role === 'owner') {
          revealAdminNav(role);
        }

        // Set topbar
        const siteText = await getSiteText(supabase, profileRow?.site_id);
        setTopbar({
          siteText: siteText,
          email: currentUser.email,
          role: (profileRow?.role || 'Staff').charAt(0).toUpperCase() + (profileRow?.role || 'Staff').slice(1)
        });

        // Set subtitle
        const siteSubtitle = document.getElementById('site-subtitle');
        if (siteSubtitle) {
          siteSubtitle.textContent = profileRow?.site_id ? siteText : 'Holiday Management';
        }

        // Load holiday data
        await loadHolidayData();
        await loadTeamHolidays();
        await checkUpcomingHolidays();

      } catch (error) {
        console.error('Initialization error:', error);
        if (String(error.message).includes('NO_SESSION') || String(error.message).includes('NOT_STAFF')) {
          window.location.replace('Home.html');
        }
      }
    }

    async function loadHolidayData() {
      try {
        const currentYear = new Date().getFullYear();
        const siteId = profileRow?.site_id;

        // First get the staff profile ID from the linking table
        const { data: staffLink } = await supabase
          .from('5_staff_profile_user_links')
          .select('staff_profile_id')
          .eq('user_id', currentUser.id)
          .eq('site_id', siteId)
          .single();

        if (!staffLink) {
          console.error('No staff profile linked to this user');
          // Set default values
          const totalEl = document.getElementById('total-entitlement');
          const usedEl = document.getElementById('used-holidays');
          const remainingEl = document.getElementById('remaining-holidays');
          const pendingEl = document.getElementById('pending-holidays');
          
          if (totalEl) totalEl.textContent = '0h';
          if (usedEl) usedEl.textContent = '0h';
          if (remainingEl) remainingEl.textContent = '0h';
          if (pendingEl) pendingEl.textContent = '0h';
          
          displayHolidayRequests([]);
          return;
        }

        const staffProfileId = staffLink.staff_profile_id;

        // Load entitlements from new table
        const { data: entitlements } = await supabase
          .from('2_staff_entitlements')
          .select('*')
          .eq('staff_profile_id', staffProfileId)
          .eq('year', currentYear)
          .single();

        // Load working pattern from new table
        const { data: workingPattern } = await supabase
          .from('3_staff_working_patterns')
          .select('*')
          .eq('staff_profile_id', staffProfileId)
          .single();

        // Load holiday bookings from new table
        const { data: requests } = await supabase
          .from('4_holiday_bookings')
          .select('*')
          .eq('staff_profile_id', staffProfileId)
          .order('created_at', { ascending: false });

        // Calculate totals
        let totalEntitlement, usedAmount, pendingAmount;
        
        // Ensure we have valid data
        const safeEntitlements = entitlements || {};
        const safeRequests = requests || [];
        
        if (isGP) {
          totalEntitlement = Math.max(0, (safeEntitlements.total_sessions || 0));
          usedAmount = safeRequests.filter(r => r.status === 'approved').reduce((sum, r) => sum + (r.sessions_requested || 0), 0);
          pendingAmount = safeRequests.filter(r => r.status === 'pending').reduce((sum, r) => sum + (r.sessions_requested || 0), 0);
          
          // Set safe text content with fallbacks
          const totalEl = document.getElementById('total-entitlement');
          const usedEl = document.getElementById('used-holidays');
          const remainingEl = document.getElementById('remaining-holidays');
          const pendingEl = document.getElementById('pending-holidays');
          
          if (totalEl) totalEl.textContent = `${totalEntitlement || 0} sessions`;
          if (usedEl) usedEl.textContent = `${usedAmount || 0} sessions`;
          if (remainingEl) remainingEl.textContent = `${Math.max(0, (totalEntitlement || 0) - (usedAmount || 0) - (pendingAmount || 0))} sessions`;
          if (pendingEl) pendingEl.textContent = `${pendingAmount || 0} sessions`;
        } else {
          totalEntitlement = Math.max(0, (safeEntitlements.total_hours || 0));
          usedAmount = safeRequests.filter(r => r.status === 'approved').reduce((sum, r) => sum + (r.hours_requested || 0), 0);
          pendingAmount = safeRequests.filter(r => r.status === 'pending').reduce((sum, r) => sum + (r.hours_requested || 0), 0);
          
          // Set safe text content with fallbacks
          const totalEl = document.getElementById('total-entitlement');
          const usedEl = document.getElementById('used-holidays');
          const remainingEl = document.getElementById('remaining-holidays');
          const pendingEl = document.getElementById('pending-holidays');
          
          if (totalEl) totalEl.textContent = `${totalEntitlement || 0}h`;
          if (usedEl) usedEl.textContent = `${usedAmount || 0}h`;
          if (remainingEl) remainingEl.textContent = `${Math.max(0, (totalEntitlement || 0) - (usedAmount || 0) - (pendingAmount || 0))}h`;
          if (pendingEl) pendingEl.textContent = `${pendingAmount || 0}h`;
        }

        // Display holiday requests
        displayHolidayRequests(requests || []);

      } catch (error) {
        console.error('Error loading holiday data:', error);
        // Set default values if there's an error
        const totalEl = document.getElementById('total-entitlement');
        const usedEl = document.getElementById('used-holidays');
        const remainingEl = document.getElementById('remaining-holidays');
        const pendingEl = document.getElementById('pending-holidays');
        
        if (totalEl) totalEl.textContent = '0h';
        if (usedEl) usedEl.textContent = '0h';
        if (remainingEl) remainingEl.textContent = '0h';
        if (pendingEl) pendingEl.textContent = '0h';
        
        // Show empty state
        displayHolidayRequests([]);
      }
    }

    function displayHolidayRequests(requests) {
      const container = document.getElementById('my-holidays');
      
      if (!requests || requests.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìÖ</div>
            <p>No holiday requests found.</p>
            <p>Click "Request Holiday" to make your first request.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = requests.map(request => {
        const startDate = new Date(request.start_date).toLocaleDateString();
        const endDate = new Date(request.end_date).toLocaleDateString();
        const duration = isGP ? 
          `${request.sessions_requested || 0} sessions` : 
          `${request.hours_requested || 0} hours`;
        
        const adminComments = request.admin_comments ? 
          `<div class="admin-comments">
            <strong>Admin Comments:</strong> ${request.admin_comments}
          </div>` : '';

        return `
          <div class="holiday-item ${request.status}">
            <div class="holiday-info">
              <h4>${startDate} - ${endDate}</h4>
              <p>${request.type.replace('_', ' ').toUpperCase()} ‚Ä¢ ${duration}</p>
              ${request.destination ? `
                <p>üèñÔ∏è ${request.destination}</p>
                <div class="holiday-destination-image" id="avatar-${request.id}"></div>
              ` : ''}
              ${adminComments}
            </div>
            <div class="holiday-actions" style="display: flex; align-items: center; gap: 12px;">
              <span class="holiday-status ${request.status}">${request.status}</span>
              ${request.status === 'pending' ? 
                `<button class="holiday-btn secondary" style="padding: 8px 16px; font-size: 14px;" onclick="cancelRequest('${request.id}')">Cancel</button>` : 
                ''
              }
            </div>
          </div>
        `;
      }).join('');
      
      // Generate avatar images for holidays with destinations
      requests.forEach(async (request) => {
        if (request.destination && request.id) {
          const avatarContainer = document.getElementById(`avatar-${request.id}`);
          if (avatarContainer) {
            // Check if image URL already exists
            if (request.destination_image_url) {
              avatarContainer.innerHTML = `
                <img src="${request.destination_image_url}" alt="Holiday at ${request.destination}" 
                     style="max-width: 120px; height: 80px; object-fit: cover; border-radius: 8px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              `;
            } else {
              // Show placeholder immediately, then try to generate avatar
              avatarContainer.innerHTML = `
                <div style="width: 120px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; margin-top: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                  üèùÔ∏è
                </div>
              `;
              
              // Try to generate avatar image (this may fail if Edge Function isn't deployed)
              try {
                const tempContainer = document.createElement('div');
                await generateHolidayAvatar(request.destination, tempContainer);
                
                // If successful, replace placeholder with generated image
                const img = tempContainer.querySelector('img');
                if (img) {
                  img.style.maxWidth = '120px';
                  img.style.height = '80px';
                  img.style.objectFit = 'cover';
                  img.style.borderRadius = '8px';
                  img.style.marginTop = '8px';
                  img.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                  avatarContainer.innerHTML = img.outerHTML;
                }
              } catch (error) {
                console.error('Avatar generation failed for', request.destination, '- using placeholder');
                // Placeholder is already shown, no need to change anything
              }
            }
          }
        }
      });
    }

    async function loadTeamHolidays() {
      try {
        const siteId = profileRow?.site_id;
        
        // Get ALL approved holidays for the site from new table
        const { data: allHolidays } = await supabase
          .from('4_holiday_bookings')
          .select(`
            *,
            1_staff_holiday_profiles!staff_profile_id(full_name, role, team_name)
          `)
          .eq('status', 'approved')
          .gte('end_date', new Date().toISOString().split('T')[0])
          .order('start_date');

        // Filter for same site if needed (may need to join through staff profiles)
        const siteHolidays = allHolidays || [];

        // Format holidays with staff names
        const formattedHolidays = siteHolidays.map(h => ({
          ...h,
          displayName: h['1_staff_holiday_profiles']?.full_name || 'Unknown',
          team: h['1_staff_holiday_profiles']?.team_name || 'Unknown',
          avatar: null // Avatar handling can be added later
        }));

        displayTeamHolidays(formattedHolidays);

      } catch (error) {
        console.error('Error loading team holidays:', error);
        document.getElementById('team-holidays').innerHTML = 
          '<p style="color: var(--muted); text-align: center;">Error loading team holidays.</p>';
      }
    }

    function displayTeamHolidays(holidays) {
      const container = document.getElementById('team-holidays');
      
      if (!holidays || holidays.length === 0) {
        container.innerHTML = '<p style="color: var(--muted); text-align: center;">No upcoming team holidays.</p>';
        return;
      }

      const grouped = holidays.reduce((acc, holiday) => {
        const name = holiday.displayName || 'Unknown';
        if (!acc[name]) acc[name] = [];
        acc[name].push(holiday);
        return acc;
      }, {});

      container.innerHTML = Object.entries(grouped).map(([name, userHolidays]) => {
        const avatar = userHolidays[0].avatar;
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        
        return `
          <div class="team-member">
            <div class="team-avatar" style="${avatar ? `background-image: url(${avatar}); background-size: cover;` : ''}">
              ${avatar ? '' : initials}
            </div>
            <div style="flex: 1;">
              <strong>${name}</strong>
              <div style="color: var(--muted); font-size: 0.9em;">
                ${userHolidays.map(h => 
                  `${new Date(h.start_date).toLocaleDateString()} - ${new Date(h.end_date).toLocaleDateString()}`
                ).join(', ')}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function checkUpcomingHolidays() {
      try {
        const siteId = profileRow?.site_id;
        const today = new Date();
        const nextMonth = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));

        // Get staff profile ID
        const { data: staffLink } = await supabase
          .from('5_staff_profile_user_links')
          .select('staff_profile_id')
          .eq('user_id', currentUser.id)
          .eq('site_id', siteId)
          .single();

        if (!staffLink) return;

        const { data: upcomingHoliday } = await supabase
          .from('4_holiday_bookings')
          .select('*')
          .eq('staff_profile_id', staffLink.staff_profile_id)
          .eq('status', 'approved')
          .gte('start_date', today.toISOString().split('T')[0])
          .lte('start_date', nextMonth.toISOString().split('T')[0])
          .order('start_date')
          .limit(1)
          .single();

        if (upcomingHoliday?.destination) {
          await displayHolidayCountdown(upcomingHoliday);
        }

      } catch (error) {
        // No upcoming holiday with destination, hide countdown
        document.getElementById('countdown-section').style.display = 'none';
      }
    }

    async function displayHolidayCountdown(holiday) {
      const countdownSection = document.getElementById('countdown-section');
      const destinationEl = document.getElementById('countdown-destination');
      const timerEl = document.getElementById('countdown-timer');
      const avatarEl = document.getElementById('holiday-avatar-image');

      const startDate = new Date(holiday.start_date);
      const today = new Date();
      const daysUntil = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));

      destinationEl.textContent = `üèñÔ∏è Holiday to ${holiday.destination}`;
      timerEl.textContent = `${daysUntil} days to go!`;

      // Generate holiday avatar image if destination exists
      if (holiday.destination) {
        // First check if image URL already exists in the database
        if (holiday.destination_image_url) {
          avatarEl.innerHTML = `
            <img src="${holiday.destination_image_url}" alt="Holiday at ${holiday.destination}" 
                 style="max-width: 200px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto; display: block;">
          `;
        } else {
          // Generate new avatar image (works even without avatar_url)
          try {
            await generateHolidayAvatar(holiday.destination, avatarEl);
          } catch (error) {
            console.error('Error generating holiday avatar:', error);
            // Show placeholder if generation fails
            avatarEl.innerHTML = `
              <div style="padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px; text-align: center;">
                <div style="font-size: 48px;">üèùÔ∏è</div>
                <div style="margin-top: 8px; color: rgba(255,255,255,0.9);">${holiday.destination}</div>
              </div>
            `;
          }
        }
      }

      countdownSection.style.display = 'block';

      // Update countdown every day
      setInterval(() => {
        const newDaysUntil = Math.ceil((startDate - new Date()) / (1000 * 60 * 60 * 24));
        if (newDaysUntil > 0) {
          timerEl.textContent = `${newDaysUntil} days to go!`;
        } else if (newDaysUntil === 0) {
          timerEl.textContent = "Today's the day! üéâ";
        } else {
          countdownSection.style.display = 'none';
        }
      }, 86400000); // Update once per day
    }

    async function generateHolidayAvatar(destination, container) {
      try {
        // Call Supabase Edge Function to generate holiday avatar
        const { data, error } = await supabase.functions.invoke('generate-holiday-avatar', {
          body: {
            destination: destination,
            avatarUrl: profileRow?.avatar_url
          }
        });

        if (error) throw error;

        if (data?.imageUrl) {
          container.innerHTML = `
            <img src="${data.imageUrl}" alt="Holiday Avatar" style="max-width: 200px; border-radius: 12px; box-shadow: var(--shadow);">
          `;
        }
      } catch (error) {
        console.error('Error generating holiday avatar:', error);
      }
    }

    // Modal functions
    window.openRequestModal = function() {
  document.getElementById('request-modal').style.display = 'flex';
  document.body.classList.add('modal-open');
      
      // Set minimum date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('start-date').min = tomorrow.toISOString().split('T')[0];
      document.getElementById('end-date').min = tomorrow.toISOString().split('T')[0];
    };

    window.closeRequestModal = function() {
  document.getElementById('request-modal').style.display = 'none';
  document.body.classList.remove('modal-open');
  document.getElementById('holiday-request-form').reset();
    };

    window.refreshHolidayData = async function() {
      await loadHolidayData();
      await loadTeamHolidays();
      await checkUpcomingHolidays();
    };

    window.cancelRequest = async function(requestId) {
      if (!confirm('Are you sure you want to cancel this holiday request?')) return;

      try {
        const { error } = await supabase
          .from('4_holiday_bookings')
          .update({ status: 'cancelled' })
          .eq('id', requestId);

        if (error) throw error;

        alert('Holiday request cancelled successfully.');
        await loadHolidayData();
      } catch (error) {
        console.error('Error cancelling request:', error);
        alert('Error cancelling request. Please try again.');
      }
    };

    // Form submission
    document.getElementById('holiday-request-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const startDate = new Date(formData.get('start-date'));
      const endDate = new Date(formData.get('end-date'));
      const requestType = formData.get('request-type');
      const destination = formData.get('destination');

      if (startDate > endDate) {
        alert('End date must be after start date.');
        return;
      }

      try {
        // Get staff profile ID
        const siteId = profileRow?.site_id;
        const { data: staffLink } = await supabase
          .from('5_staff_profile_user_links')
          .select('staff_profile_id')
          .eq('user_id', currentUser.id)
          .eq('site_id', siteId)
          .single();

        if (!staffLink) {
          alert('Your staff profile is not linked. Please contact an administrator.');
          return;
        }

        const staffProfileId = staffLink.staff_profile_id;

        // Calculate hours/sessions based on working pattern
        let totalHours = 0, totalSessions = 0;
        
        if (isGP) {
          // For GPs, calculate sessions (simplified: assume 2 sessions per full day)
          const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
          totalSessions = days * 2; // This should be calculated based on actual working pattern
        } else {
          // For regular staff, calculate hours based on working pattern
          const { data: workingPattern } = await supabase
            .from('3_staff_working_patterns')
            .select('*')
            .eq('staff_profile_id', staffProfileId)
            .single();

          // Calculate total hours for the date range
          for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dayOfWeek = d.getDay();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const dayHours = workingPattern?.[`${dayNames[dayOfWeek]}_hours`] || 0;
            totalHours += dayHours;
          }
        }

        // Map form values to database values
        const bookingTypeMap = {
          'holiday': 'annual_leave',
          'time_in_lieu': 'toil'
        };
        const bookingType = bookingTypeMap[requestType] || 'annual_leave';
        
        // Create holiday booking in new table
        const { error } = await supabase
          .from('4_holiday_bookings')
          .insert({
            staff_profile_id: staffProfileId,
            start_date: startDate.toISOString().split('T')[0],
            end_date: endDate.toISOString().split('T')[0],
            booking_type: bookingType,
            hours_requested: totalHours,
            sessions_requested: totalSessions,
            destination: destination || null,
            status: 'pending',
            created_at: new Date().toISOString()
          });

        if (error) throw error;

        alert('Holiday request submitted successfully!');
        closeRequestModal();
        await loadHolidayData();

      } catch (error) {
        console.error('Error submitting request:', error);
        alert('Error submitting request. Please try again.');
      }
    });

    // Update end date minimum when start date changes
    document.getElementById('start-date').addEventListener('change', function() {
      const startDate = new Date(this.value);
      document.getElementById('end-date').min = this.value;
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('request-modal');
      if (event.target === modal) {
        closeRequestModal();
      }
    };

    // Initialize page
    initializePage();
  </script>

  <script>
    (function(){
      function i8(name, opts){
        opts = opts || {}; 
        var style = opts.style || 'dusk';
        var size  = (opts.size == null) ? 48 : opts.size; // default 48px
        var base  = 'https://img.icons8.com';
        // Icons8 OMG-IMG pattern is style/size/name.png
        var path  = [style, String(size || 48), encodeURIComponent(name) + '.png'].join('/');
        return base + '/' + path;
      }
      function setIcon(el){
        var name  = el.getAttribute('data-i8');
        var size  = el.getAttribute('data-i8-size');
        var style = el.getAttribute('data-i8-style') || 'fluency';
        var fallback = (el.getAttribute('data-i8-fallback') || '').toLowerCase();
        
        if (fallback === 'auto') {
          var stylesToTry = [style, 'fluency', 'color'];
          var idx = 0;
          function tryNext(){
            if (idx >= stylesToTry.length) { el.onerror = null; return; }
            var url = i8(name, {style: stylesToTry[idx++], size: size ? parseInt(size,10) : undefined});
            if (el.src !== url) el.src = url; else tryNext();
          }
          el.onerror = tryNext;
          tryNext();
        } else {
          // Strict mode: stay in the requested style (default: dusk)
          var url = i8(name, {style: style, size: size ? parseInt(size,10) : undefined});
          el.src = url;
          el.onerror = null;
        }
        if (!el.alt) el.alt = (name || '').replace(/[\-_]/g,' ');
      }
      function wireIcons(){
        document.querySelectorAll('img[data-i8]').forEach(setIcon);
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', wireIcons);
      else wireIcons();
      window.i8 = i8; // optional helper for manual usage
    })();
  </script>
  
  <script>
    // Create animated particles and interactive effects
    (function() {
      function createParticles() {
        const particlesContainer = document.getElementById('particles');
        if (!particlesContainer) return;
        
        const particleCount = 30;
        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = Math.random() * 100 + '%';
          particle.style.animationDelay = Math.random() * 25 + 's';
          particle.style.animationDuration = (15 + Math.random() * 15) + 's';
          particlesContainer.appendChild(particle);
        }
      }
      
      // Add hover effects for holiday cards
      document.addEventListener('mousemove', function(e) {
        const cards = document.querySelectorAll('.holiday-stat, .holiday-item, .team-member');
        cards.forEach(card => {
          const rect = card.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          card.style.setProperty('--mouse-x', x + '%');
          card.style.setProperty('--mouse-y', y + '%');
        });
      });
      
      // Initialize particles when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createParticles);
      } else {
        createParticles();
      }
      
      // Add floating animation to stat cards
      document.querySelectorAll('.holiday-stat').forEach((card, i) => {
        card.style.setProperty('--card-index', i);
        card.style.animation = `cardFloat 8s ease-in-out infinite`;
        card.style.animationDelay = `${i * 0.2}s`;
      });
    })();
  </script>
</body>
</html>
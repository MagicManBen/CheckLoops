<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Holiday Data Management - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 30px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 1px solid #e5e7eb;
    }

    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      color: #6b7280;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .stat-label {
      color: #6b7280;
      font-size: 0.875rem;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
    }

    .table-container {
      overflow-x: auto;
      margin-bottom: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f9fafb;
      text-align: left;
      padding: 12px;
      font-weight: 600;
      color: #4b5563;
      border-bottom: 1px solid #e5e7eb;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
    }

    tr:hover {
      background: #f9fafb;
    }

    .btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #5a67d8;
    }

    .btn-secondary {
      background: #6b7280;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .import-section {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .import-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      display: none;
    }

    .import-status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .import-status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .import-status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }

    .user-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .user-badge.registered {
      background: #d1fae5;
      color: #065f46;
    }

    .user-badge.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .search-box {
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèñÔ∏è Holiday Data Management</h1>
    <p class="subtitle">View holiday entitlements and historical data from Excel import</p>

    <!-- Navigation back to admin dashboard -->
    <div style="margin-bottom: 20px;">
      <a href="admin-dashboard.html" class="btn btn-secondary" style="text-decoration: none; display: inline-block;">
        ‚Üê Back to Dashboard
      </a>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Staff</div>
        <div class="stat-value" id="totalCount">21</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Registered Users</div>
        <div class="stat-value" id="registeredCount">2</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending Staff</div>
        <div class="stat-value" id="pendingCount">19</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Holiday Days</div>
        <div class="stat-value" id="backdatedCount">323</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('overview')">Staff Overview</button>
      <button class="tab" onclick="switchTab('holidays')">Historical Holidays</button>
      <button class="tab" onclick="switchTab('database')">Database Status</button>
    </div>

    <!-- Tab Contents -->
    <div id="overview" class="tab-content active">
      <h2>Staff Holiday Overview</h2>
      <div class="search-box">
        <input type="text" id="searchStaff" placeholder="Search staff by name..." onkeyup="filterStaff()">
      </div>
      <div class="table-container">
        <table id="staffTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Entitlement</th>
              <th>Holiday Days</th>
            </tr>
          </thead>
          <tbody id="staffTableBody">
            <!-- Will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="holidays" class="tab-content">
      <h2>Historical Holiday Data</h2>
      <div class="search-box">
        <input type="text" id="searchHolidays" placeholder="Search by staff name..." onkeyup="filterHolidays()">
      </div>
      <div class="table-container">
        <table id="holidaysTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Staff Name</th>
              <th>Time/Sessions</th>
              <th>Type</th>
              <th>Month</th>
            </tr>
          </thead>
          <tbody id="holidaysTableBody">
            <!-- Will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="database" class="tab-content">
      <h2>Database Connection Status</h2>
      <div class="import-section">
        <h3>Connection Info</h3>
        <p id="connectionStatus">Checking connection...</p>
        
        <h3 style="margin-top: 20px;">Database Tables Status</h3>
        <ul id="tableStatus">
          <li>Loading...</li>
        </ul>
        
        <h3 style="margin-top: 20px;">Data Import Note</h3>
        <p style="color: #dc2626;">
          ‚ö†Ô∏è Row Level Security (RLS) is preventing direct data insertion.
          To import data, you need to:
        </p>
        <ol style="margin-top: 10px; line-height: 1.8;">
          <li>Disable RLS temporarily in Supabase Dashboard</li>
          <li>Or use the service role key instead of anon key</li>
          <li>Or create users first and authenticate them</li>
        </ol>
      </div>
    </div>
  </div>

  <script type="module">
    // Import data from CSV processing
    const staffMapping = [
      {name: "Alexa Moreton", email: "alexa.moreton@stoke.nhs.uk", role: "Nurse", entitlement: "6 days, 13:30:00", has_holidays: true},
      {name: "Ashwini Nayak", email: "ashwini.nayak@stoke.nhs.uk", role: "GP", entitlement: "44 sessions", has_holidays: true},
      {name: "Ben Howard", user_id: "55f1b4e6-01f4-452d-8d6c-617fe7794873", email: "ben.howard@stoke.nhs.uk", role: "Manager", entitlement: "8 days, 9:47:00", has_holidays: true},
      {name: "Carly Tweedie", email: "carly.tweedie@stoke.nhs.uk", role: "Admin", entitlement: "5 days, 10:00:00", has_holidays: true},
      {name: "Diana Griffiths", email: "diana.griffiths@stoke.nhs.uk", role: "Nurse", entitlement: "4 days, 9:00:00", has_holidays: true},
      {name: "Emily Parker", email: "emily.parker@stoke.nhs.uk", role: "Reception", entitlement: "7 days, 3:55:00", has_holidays: true},
      {name: "Gemma Keeling", email: "gemma.keeling@stoke.nhs.uk", role: "Manager", entitlement: "7 days, 22:00:00", has_holidays: true},
      {name: "Georgiana Sima", email: "georgiana.sima@stoke.nhs.uk", role: "Reception", entitlement: "7 days, 9:04:00", has_holidays: true},
      {name: "Kasim Hussain", email: "kasim.hussain@stoke.nhs.uk", role: "Pharmacist", entitlement: "6 days, 10:15:00", has_holidays: true},
      {name: "Kelly Amison", email: "kelly.amison@stoke.nhs.uk", role: "Health Care Assistant", entitlement: "9 days, 6:00:00", has_holidays: true},
      {name: "Kelly Mansell", email: "kelly.mansell@stoke.nhs.uk", role: "GP Assistant", entitlement: "1 day, 9:50:00", has_holidays: false},
      {name: "Lilly Mycock", email: "lilly.mycock@stoke.nhs.uk", role: "Reception", entitlement: "4 days, 6:02:00", has_holidays: true},
      {name: "Monique Keersmaekers", email: "monique.keersmaekers@stoke.nhs.uk", role: "GP", entitlement: "53 sessions", has_holidays: true},
      {name: "Patricia Perkins", email: "patricia.perkins@stoke.nhs.uk", role: "Reception", entitlement: "7 days, 17:43:00", has_holidays: true},
      {name: "Saba Khalid", email: "saba.khalid@stoke.nhs.uk", role: "Reception", entitlement: "9 days, 12:55:00", has_holidays: true},
      {name: "Salman Saeed", email: "salman.saeed@stoke.nhs.uk", role: "GP", entitlement: "56 sessions", has_holidays: true},
      {name: "Sarah Masterson", email: "sarah.masterson@stoke.nhs.uk", role: "Nurse", entitlement: "6 days, 18:00:00", has_holidays: false},
      {name: "Shihara Farook", email: "shihara.farook@stoke.nhs.uk", role: "GP", entitlement: "58 sessions", has_holidays: true},
      {name: "Susan Heath", email: "susan.heath@stoke.nhs.uk", role: "Reception", entitlement: "8 days, 17:31:00", has_holidays: true},
      {name: "Tom Donlan", user_id: "68a1a111-ac7c-44a3-8fd3-8c37ff07e0a2", email: "tom.donlan@stoke.nhs.uk", role: "Admin", entitlement: "9 days, 8:13:00", has_holidays: true},
      {name: "Tracy Heaton", email: "tracy.heaton@stoke.nhs.uk", role: "Admin", entitlement: "8 days, 17:15:00", has_holidays: true}
    ];

    // Sample holiday data for Ben and Tom
    const holidayData = [
      // Ben Howard's holidays
      {date: "2025-02-03", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-02-04", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-02-05", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-02-06", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-02-07", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-02-26", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-02-27", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-04-24", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-04-25", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-05-30", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-06-02", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-06-03", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-06-04", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-06-05", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-06-06", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-07-03", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-07-04", name: "Ben Howard", value: "07:30:00"},
      {date: "2025-10-20", name: "Ben Howard", value: "08:49:00"},
      // Tom Donlan's holidays
      {date: "2025-02-19", name: "Tom Donlan", value: "00:30:00"},
      {date: "2025-02-25", name: "Tom Donlan", value: "01:00:00"},
      {date: "2025-03-03", name: "Tom Donlan", value: "00:30:00"},
      {date: "2025-03-10", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-04-07", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-04-08", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-04-09", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-04-10", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-04-11", name: "Tom Donlan", value: "08:00:00"},
      {date: "2025-06-23", name: "Tom Donlan", value: "02:00:00"},
      {date: "2025-07-22", name: "Tom Donlan", value: "00:30:00"},
      {date: "2025-08-11", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-08-12", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-08-13", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-08-14", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-08-15", name: "Tom Donlan", value: "08:00:00"},
      {date: "2025-08-28", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-09-17", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-09-18", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-10-06", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-10-07", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-10-08", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-10-09", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-10-10", name: "Tom Donlan", value: "08:00:00"},
      {date: "2025-11-17", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-11-18", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-11-19", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-11-20", name: "Tom Donlan", value: "07:30:00"},
      {date: "2025-11-21", name: "Tom Donlan", value: "08:00:00"},
      {date: "2025-12-10", name: "Tom Donlan", value: "07:30:00"},
      // Kelly Amison holidays (sample)
      {date: "2025-02-13", name: "Kelly Amison", value: "06:00:00"},
      {date: "2025-03-03", name: "Kelly Amison", value: "09:00:00"},
      {date: "2025-03-04", name: "Kelly Amison", value: "07:00:00"},
      {date: "2025-03-05", name: "Kelly Amison", value: "06:00:00"},
      {date: "2025-03-06", name: "Kelly Amison", value: "06:00:00"},
      {date: "2025-03-07", name: "Kelly Amison", value: "09:00:00"},
      // GP sessions examples
      {date: "2025-02-12", name: "Ashwini Nayak", value: "1"},
      {date: "2025-02-17", name: "Ashwini Nayak", value: "2"},
      {date: "2025-02-18", name: "Ashwini Nayak", value: "2"},
      {date: "2025-02-19", name: "Ashwini Nayak", value: "1"}
    ];

    // Initialize page
    function init() {
      displayStaffOverview();
      displayHolidays();
      checkDatabaseConnection();
    }

    function displayStaffOverview() {
      const tbody = document.getElementById('staffTableBody');
      
      // Count holidays for each staff member
      const holidayCounts = {};
      holidayData.forEach(h => {
        holidayCounts[h.name] = (holidayCounts[h.name] || 0) + 1;
      });
      
      tbody.innerHTML = staffMapping.map(staff => {
        const holidayCount = holidayCounts[staff.name] || 0;
        const statusBadge = staff.user_id ? 
          '<span class="user-badge registered">Registered</span>' : 
          '<span class="user-badge pending">Pending</span>';
        
        return `
          <tr>
            <td><strong>${staff.name}</strong></td>
            <td>${staff.email}</td>
            <td>${staff.role}</td>
            <td>${statusBadge}</td>
            <td>${staff.entitlement}</td>
            <td>${holidayCount} days</td>
          </tr>
        `;
      }).join('');
    }

    function displayHolidays() {
      const tbody = document.getElementById('holidaysTableBody');
      
      tbody.innerHTML = holidayData.map(h => {
        const type = h.value.includes(':') ? 'Hours' : 'Sessions';
        const month = h.date.substring(0, 7);
        
        return `
          <tr>
            <td>${h.date}</td>
            <td><strong>${h.name}</strong></td>
            <td>${h.value}</td>
            <td>${type}</td>
            <td>${month}</td>
          </tr>
        `;
      }).join('');
    }

    async function checkDatabaseConnection() {
      const statusEl = document.getElementById('connectionStatus');
      const tableStatusEl = document.getElementById('tableStatus');
      
      try {
        // Import Supabase client
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
        
        // Use config from window.CONFIG if available, otherwise hardcode
        const url = window.CONFIG?.SUPABASE_URL || 'https://unveoqnlqnobufhublyw.supabase.co';
        const key = window.CONFIG?.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME';
        
        const supabase = createClient(url, key);
        
        statusEl.innerHTML = `‚úÖ Connected to Supabase at ${url}`;
        
        // Check tables
        const tables = ['holiday_entitlements', 'holiday_requests', 'holiday_request_days', 'profiles'];
        const tableResults = [];
        
        for (const table of tables) {
          const { data, error, count } = await supabase
            .from(table)
            .select('*', { count: 'exact', head: true });
          
          if (error) {
            tableResults.push(`<li>‚ùå ${table}: ${error.message}</li>`);
          } else {
            tableResults.push(`<li>‚úÖ ${table}: ${count || 0} records</li>`);
          }
        }
        
        tableStatusEl.innerHTML = tableResults.join('');
        
      } catch (error) {
        statusEl.innerHTML = `‚ùå Connection failed: ${error.message}`;
        tableStatusEl.innerHTML = '<li>Unable to check table status</li>';
      }
    }

    window.switchTab = function(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
    };

    window.filterStaff = function() {
      const search = document.getElementById('searchStaff').value.toLowerCase();
      const rows = document.querySelectorAll('#staffTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      });
    };

    window.filterHolidays = function() {
      const search = document.getElementById('searchHolidays').value.toLowerCase();
      const rows = document.querySelectorAll('#holidaysTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      });
    };

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — Meetings</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Shared app assets -->
  <script src="config.js"></script>
  <link rel="stylesheet" href="staff.css">

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    /* Page chrome matches the staff-quiz scaffolding (bg waves + panel look) */
    :root{
      --ink:#f8fafc;
      --muted:#dbeafe;
      --panelBorder: rgba(255,255,255,.15);
      --panelBg: rgba(255,255,255,.10);
      --panelBg2: rgba(255,255,255,.16);
      --ring: rgba(124,156,255,.35);
      --accent:#7c9cff;
      --accent2:#8b5cf6;
      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
      --r:18px;
    }

    .content{ min-height:100vh; }

    /* Panel + card system (works with staff.css base) */
    .panel{ border-radius:22px; border:1px solid var(--panelBorder); background:linear-gradient(180deg,var(--panelBg2),var(--panelBg)); overflow:hidden; }
    .panel-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.14); }
    .panel-title{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px; }

    .grid{ display:grid; grid-template-columns: 1fr 360px; gap:18px; }
    @media (max-width: 1080px){ .grid{ grid-template-columns: 1fr; } }

    /* FullCalendar polish */
    #calendar{ padding:8px; }
    .fc{ --fc-border-color: rgba(255,255,255,.10); --fc-neutral-bg-color: rgba(255,255,255,.06); }
    .fc .fc-toolbar.fc-header-toolbar{ padding:10px; }
    .fc .fc-toolbar-title{ font-weight:800; }
    .fc .fc-button{ background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.18); color:var(--ink); border-radius:10px; padding:6px 10px; }
    .fc .fc-button-primary:not(:disabled).fc-button-active,
    .fc .fc-button-primary:focus{ box-shadow:0 0 0 3px var(--ring); }
    .fc .fc-daygrid-event{ border-radius:10px; padding:2px 6px; font-weight:700; }

    .side{ display:flex; flex-direction:column; gap:18px; }
    .upcoming-item{ display:grid; grid-template-columns: 56px 1fr; gap:12px; padding:10px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); cursor:pointer; }
    .datepill{ display:grid; place-items:center; border-radius:12px; background:rgba(255,255,255,.12); font-weight:800; }
    .datepill .d{ font-size:18px; }
    .datepill .m{ font-size:12px; opacity:.9; }
    .up-title{ font-weight:800; }
    .up-meta{ font-size:12px; color:#c7d2fe; }

    .stat-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .stat{ text-align:center; padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); }
    .stat .n{ font-size:22px; font-weight:900; }
    .stat .l{ font-size:12px; color:#c7d2fe; }

    /* Primary action */
    .fab{ position:fixed; right:28px; bottom:28px; z-index:20; border:0; border-radius:16px; padding:14px 16px; font-weight:800; color:#fff;
      background: linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow: 0 14px 44px rgba(2,6,23,.34); cursor:pointer; }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(2,6,23,.55); z-index:40; }
    .modal.open{ display:grid; }
    .modal-card{ width:min(920px, 96vw); border-radius:22px; background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.95)); color:#0f172a;
      box-shadow:0 30px 80px rgba(2,6,23,.45); overflow:hidden; }
    .m-head{ display:flex; justify-content:space-between; align-items:center; padding:18px 20px; border-bottom:1px solid rgba(15,23,42,.08); }
    .m-title{ font-weight:900; font-size:18px; }
    .m-close{ background:transparent; border:0; font-size:22px; cursor:pointer; }
    .m-body{ display:grid; grid-template-columns: 1fr; }

    .tabs{ display:flex; gap:4px; padding:8px 10px; border-bottom:1px solid rgba(15,23,42,.08); background:#f8fafc; }
    .tabbtn{ padding:8px 12px; border-radius:10px; font-weight:700; border:1px solid transparent; background:transparent; cursor:pointer; }
    .tabbtn.active{ background:#fff; border-color:rgba(15,23,42,.10); box-shadow:0 1px 0 #fff inset; }

    .section{ padding:16px 20px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-weight:700; font-size:12px; color:#334155; text-transform:uppercase; letter-spacing:.4px; }
    .input, select, textarea{ padding:12px 12px; border-radius:12px; border:1px solid rgba(15,23,42,.12); font-weight:600; font-size:14px; background:#fff; color:#0f172a; }
    textarea{ min-height:110px; }

    .m-actions{ display:flex; justify-content:flex-end; gap:10px; padding:14px 20px; background:#fff; border-top:1px solid rgba(15,23,42,.08); }
    .m-btn{ border:0; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; }
    .m-btn.primary{ background:linear-gradient(135deg, #3b82f6, #8b5cf6); color:#fff; }
    .m-btn.ghost{ background:#eef2ff; color:#1e293b; }

    /* Recorder */
    .rec-bar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .rec-ind{ width:10px; height:10px; border-radius:50%; background:#ef4444; animation: blink 1s steps(1,end) infinite; display:none; }
    .rec-ind.on{ display:inline-block; }
    @keyframes blink{ 50%{ opacity: 0; } }
    .rec-timer{ font-weight:800; color:#0f172a; min-width:56px; text-align:center; }
    .rec-btn{ padding:10px 14px; border-radius:10px; border:0; font-weight:800; cursor:pointer; }
    .rec-btn.start{ background:#e0f2fe; color:#075985; }
    .rec-btn.stop{ background:#fee2e2; color:#991b1b; }
    canvas#wave{ width:100%; height:80px; background:#f8fafc; border:1px dashed rgba(15,23,42,.15); border-radius:10px; }
    .audio-list audio{ width:100%; margin-top:8px; }
  </style>
</head>
<body>
  <div class="bg"><div class="wave"></div><div class="wave wave2"></div></div>
  <main class="content">
    <!-- Top bar identical to staff-quiz -->
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav"></div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: —</div>
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>

    <section class="panel" style="margin-top:16px;">
      <div class="panel-header">
        <div class="panel-title"><img data-i8="calendar" data-i8-size="24" alt="" style="vertical-align: middle; margin-right:8px;"> Meeting Calendar</div>
        <div id="calendar-actions"></div>
      </div>
      <div class="content-body" style="padding:16px;">
        <div class="grid">
          <div class="panel" style="overflow:hidden;">
            <div id="calendar"></div>
          </div>

          <aside class="side">
            <div class="panel">
              <div class="panel-header"><div class="panel-title"><img data-i8="alarm-clock" data-i8-size="22" alt="" style="vertical-align: middle; margin-right:6px;"> Upcoming</div></div>
              <div id="upcoming" style="padding:12px;"></div>
            </div>
            <div class="panel">
              <div class="panel-header"><div class="panel-title"><img data-i8="statistics" data-i8-size="22" alt="" style="vertical-align: middle; margin-right:6px;"> Summary</div></div>
              <div style="padding:12px;">
                <div class="stat-grid">
                  <div class="stat"><div class="n" id="st-upcoming">0</div><div class="l">Upcoming</div></div>
                  <div class="stat"><div class="n" id="st-month">0</div><div class="l">This Month</div></div>
                  <div class="stat"><div class="n" id="st-complete">0</div><div class="l">Completed</div></div>
                </div>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </section>

    <div class="muted" style="text-align:center; font-size:12px; padding:10px 0;">© CheckLoop • Staff Meetings</div>
  </main>

  <button class="fab" id="newMeetingBtn">＋ New Meeting</button>

  <!-- Meeting Modal -->
  <div class="modal" id="meetingModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="m-head">
        <div class="m-title" id="modalTitle">New Meeting</div>
        <button class="m-close" id="modalClose" aria-label="Close">✕</button>
      </div>

      <div class="tabs">
        <button class="tabbtn active" data-tab="details">Details</button>
        <button class="tabbtn" data-tab="agenda">Agenda</button>
        <button class="tabbtn" data-tab="notes">Notes</button>
        <button class="tabbtn" data-tab="attendees">Attendees</button>
        <button class="tabbtn" data-tab="recording">Recording</button>
      </div>

      <div class="m-body">
        <!-- Details -->
        <section class="section" data-panel="details">
          <div class="row">
            <div class="field"><label>Title</label><input id="f-title" class="input" placeholder="e.g. Staff Meeting" /></div>
            <div class="field"><label>Location / Link</label><input id="f-location" class="input" placeholder="Teams link or Room 1" /></div>
          </div>
          <div class="row">
            <div class="field"><label>Date</label><input id="f-date" type="date" class="input" /></div>
            <div class="field" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div class="field"><label>Start</label><input id="f-start" type="time" class="input" /></div>
              <div class="field"><label>End</label><input id="f-end" type="time" class="input" /></div>
            </div>
          </div>
          <div class="row">
            <div class="field"><label>Type</label>
              <select id="f-type">
                <option value="general">General</option>
                <option value="staff">Staff</option>
                <option value="clinical">Clinical</option>
                <option value="training">Training</option>
              </select>
            </div>
            <div class="field"><label>Status</label>
              <select id="f-status">
                <option value="scheduled">Scheduled</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>
          <div class="field" style="margin-top:10px;"><label>Description</label><textarea id="f-desc" placeholder="Optional details…"></textarea></div>
        </section>

        <!-- Agenda -->
        <section class="section" data-panel="agenda" hidden>
          <div class="field"><label>Add item</label><input id="f-agenda-input" class="input" placeholder="Topic" /></div>
          <div style="margin-top:8px; display:flex; gap:10px;">
            <button class="m-btn ghost" id="agendaAdd">Add</button>
          </div>
          <ul id="agendaList" style="margin-top:12px; padding-left:16px;"></ul>
        </section>

        <!-- Notes -->
        <section class="section" data-panel="notes" hidden>
          <div class="field"><label>Notes</label><textarea id="f-notes" placeholder="Type notes here…"></textarea></div>
          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
            <button class="m-btn ghost" id="notesSave">Save Notes</button>
          </div>
        </section>

        <!-- Attendees -->
        <section class="section" data-panel="attendees" hidden>
          <div class="field"><label>Invitee email</label><input id="f-att" class="input" placeholder="name@example.com" /></div>
          <div style="margin-top:8px; display:flex; gap:10px;">
            <button class="m-btn ghost" id="attAdd">Add</button>
          </div>
          <ul id="attList" style="margin-top:12px; padding-left:16px;"></ul>
        </section>

        <!-- Recording -->
        <section class="section" data-panel="recording" hidden>
          <div class="rec-bar">
            <span class="rec-ind" id="recDot"></span>
            <span class="rec-timer" id="recTimer">00:00</span>
            <button class="rec-btn start" id="recStart">Start Recording</button>
            <button class="rec-btn stop" id="recStop" disabled>Stop</button>
            <div style="flex:1"></div>
            <small style="color:#475569;font-weight:600;">Audio is saved to Supabase Storage and linked to this meeting.</small>
          </div>
          <div style="margin-top:10px;">
            <canvas id="wave"></canvas>
          </div>
          <div class="audio-list" id="audioList"></div>
          <div style="margin-top:10px;">
            <label class="field"><span>Or upload existing recording</span><input type="file" id="f-rec" accept="audio/*" class="input"/></label>
          </div>
        </section>
      </div>

      <div class="m-actions">
        <button class="m-btn ghost" id="deleteBtn" style="display:none; color:#b91c1c;">Delete</button>
        <div style="flex:1"></div>
        <button class="m-btn" id="startBtn">Start</button>
        <button class="m-btn primary" id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initSupabase, requireStaffSession, getSiteText, setTopbar, navActivate, attachLogout } from './staff-common.js';

    // ------------ App State ------------
    let supabase, calendar, meetingTable = 'meetings';
    const state = {
      user: null,
      siteId: null,
      events: [],
      current: null,   // FullCalendar Event API or plain object
      agenda: [],
      attendees: [],
      notes: '',
      recordings: []   // { url, name }
    };

    // ------------ Utilities ------------
    const fmt = new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'});
    const fmtDayShort = new Intl.DateTimeFormat(undefined,{weekday:'short'});
    const fmtMon = new Intl.DateTimeFormat(undefined,{month:'short'});

    const el = (sel)=> document.querySelector(sel);
    const $$ = (sel)=> Array.from(document.querySelectorAll(sel));

    function parseDateTime(dateStr, timeStr){
      const [y,m,d] = dateStr.split('-').map(Number);
      const [hh,mm] = timeStr.split(':').map(Number);
      return new Date(y, (m-1), d, hh||0, mm||0, 0, 0);
    }

    function toIso(d){ return (d instanceof Date ? d : new Date(d)).toISOString(); }

    function urlLooksLike(str){ return /^https?:\/\//i.test(String(str||'')); }

    // ------------ Mapping helpers ------------
    function mapRowToEvent(row){
      const start = row.start_at || row.start || row.starts_at;
      const end   = row.end_at   || row.end   || row.ends_at;
      const ev = {
        id: String(row.id),
        title: row.title || 'Untitled',
        start: start ? new Date(start) : undefined,
        end:   end ? new Date(end) : undefined,
        extendedProps: {
          location: row.location || '',
          type: row.type || row.meeting_type || 'general',
          status: row.status || 'scheduled',
          description: row.description || '',
          agenda: row.agenda || [],
          attendees: row.attendees || [],
          notes: row.notes || '',
          recordings: row.recordings || (row.recording_url ? [{ url: row.recording_url, name: 'Recording' }] : [])
        }
      };
      return ev;
    }

    function mapEventToRow(ev){
      const s = new Date(ev.start), e = new Date(ev.end || (s.getTime()+60*60*1000));
      return {
        id: ev.id,
        user_id: state.user.id,
        site_id: state.siteId,
        title: ev.title || 'Untitled',
        description: ev.extendedProps?.description || '',
        location: ev.extendedProps?.location || '',
        type: ev.extendedProps?.type || 'general',
        status: ev.extendedProps?.status || 'scheduled',
        start_at: toIso(s),
        end_at: toIso(e),
        agenda: ev.extendedProps?.agenda || [],
        attendees: ev.extendedProps?.attendees || [],
        notes: ev.extendedProps?.notes || '',
        recordings: ev.extendedProps?.recordings || []
      };
    }

    // ------------ Supabase: load/save/delete ------------
    async function detectTable(){
      // Try default 'meetings', fallback to 'staff_meetings' if missing
      try {
        const { data, error } = await supabase.from('meetings').select('id').limit(1);
        meetingTable = error ? 'staff_meetings' : 'meetings';
        if (error && !/permission|row-level|exists/i.test(error.message)) {
          // silently keep fallback
          meetingTable = 'staff_meetings';
        }
      } catch(_){
        meetingTable = 'staff_meetings';
      }
    }

    async function loadMeetings(){
      try {
        await detectTable();
        const { data, error } = await supabase
          .from(meetingTable)
          .select('*')
          .eq('user_id', state.user.id)
          .eq('site_id', state.siteId)
          .order('start_at', { ascending: true });

        if (error) throw error;
        const events = (data||[]).map(mapRowToEvent);
        state.events = events;
        return events;
      } catch (e) {
        console.warn('loadMeetings failed:', e.message);
        state.events = []; // keep empty but UI still works
        return [];
      }
    }

    async function saveMeeting(ev){
      const row = mapEventToRow(ev);
      try {
        const { data, error } = await supabase
          .from(meetingTable)
          .upsert(row, { onConflict: 'id' })
          .select()
          .single();
        if (error) throw error;
        return data;
      } catch (e) {
        console.error('saveMeeting failed:', e);
        throw e;
      }
    }

    async function deleteMeeting(id){
      try {
        const { error } = await supabase.from(meetingTable).delete().eq('id', id);
        if (error) throw error;
      } catch(e) {
        console.error('deleteMeeting failed:', e);
      }
    }

    // ------------ UI: upcoming + stats ------------
    function paintUpcoming(){
      const box = el('#upcoming');
      box.innerHTML = '';
      const now = new Date();
      const future = state.events.filter(e => new Date(e.start) >= now)
        .sort((a,b)=> new Date(a.start)-new Date(b.start))
        .slice(0,6);

      if(!future.length){ box.innerHTML = '<div style="opacity:.8">No upcoming meetings.</div>'; }

      future.forEach(e => {
        const dt = new Date(e.start);
        const wrap = document.createElement('div');
        wrap.className = 'upcoming-item';
        wrap.innerHTML = `
          <div class="datepill"><div class="d">${dt.getDate()}</div><div class="m">${fmtMon.format(dt)}</div></div>
          <div>
            <div class="up-title">${e.title || 'Untitled'}</div>
            <div class="up-meta">${fmtDayShort.format(dt)} ${fmt.format(dt)} · ${e.extendedProps?.location || '—'} · ${e.extendedProps?.type || ''}</div>
          </div>`;
        wrap.addEventListener('click', ()=> openModal(e));
        box.appendChild(wrap);
      });

      // stats
      el('#st-upcoming').textContent = state.events.filter(e=> new Date(e.start) >= now).length;
      const m = now.getMonth();
      el('#st-month').textContent = state.events.filter(e=> new Date(e.start).getMonth()===m).length;
      el('#st-complete').textContent = state.events.filter(e=> (e.extendedProps?.status||'')==='completed').length;
    }

    // ------------ Modal + form handling ------------
    const modal = el('#meetingModal');
    function openModal(e){
      state.current = e ? (calendar.getEventById(e.id) || e) : null;
      modal.classList.add('open'); document.body.style.overflow='hidden';
      switchTab('details');
      if (state.current) {
        // edit
        el('#modalTitle').textContent = state.current.title || 'Meeting';
        fillForm(state.current);
        el('#deleteBtn').style.display = '';
      } else {
        // new
        el('#modalTitle').textContent = 'New Meeting';
        const now = new Date();
        el('#f-title').value = '';
        el('#f-location').value = '';
        el('#f-date').value = now.toISOString().slice(0,10);
        el('#f-start').value = '09:00';
        el('#f-end').value = '10:00';
        el('#f-type').value = 'general';
        el('#f-status').value = 'scheduled';
        el('#f-desc').value = '';
        state.agenda = []; state.attendees = []; state.notes = ''; state.recordings = [];
        paintLists(); paintAudioList();
        el('#deleteBtn').style.display = 'none';
      }
    }
    function closeModal(){ modal.classList.remove('open'); document.body.style.overflow='auto'; }
    el('#modalClose').addEventListener('click', closeModal);

    function switchTab(id){
      $$('.tabbtn').forEach(t => t.classList.toggle('active', t.dataset.tab===id));
      $$('[data-panel]').forEach(p => p.hidden = (p.dataset.panel!==id));
    }
    $$('.tabbtn').forEach(t => t.addEventListener('click', ()=> switchTab(t.dataset.tab)));

    function fillForm(ev){
      const s = new Date(ev.start); const f = new Date(ev.end || (s.getTime()+60*60*1000));
      el('#f-title').value = ev.title || '';
      el('#f-location').value = ev.extendedProps?.location || '';
      el('#f-date').value = s.toISOString().slice(0,10);
      el('#f-start').value = String(s.getHours()).padStart(2,'0') + ':' + String(s.getMinutes()).padStart(2,'0');
      el('#f-end').value = String(f.getHours()).padStart(2,'0') + ':' + String(f.getMinutes()).padStart(2,'0');
      el('#f-type').value = ev.extendedProps?.type || 'general';
      el('#f-status').value = ev.extendedProps?.status || 'scheduled';
      el('#f-desc').value = ev.extendedProps?.description || '';
      state.agenda = [...(ev.extendedProps?.agenda||[])];
      state.attendees = [...(ev.extendedProps?.attendees||[])];
      state.notes = String(ev.extendedProps?.notes||'');
      state.recordings = [...(ev.extendedProps?.recordings||[])];
      el('#f-notes').value = state.notes;
      paintLists(); paintAudioList();
    }

    function collectFormToEvent(existingId){
      const date = el('#f-date').value || new Date().toISOString().slice(0,10);
      const start = el('#f-start').value || '09:00';
      const end = el('#f-end').value || '10:00';
      return {
        id: existingId || String(Date.now()),
        title: el('#f-title').value || 'Untitled',
        start: parseDateTime(date, start),
        end: parseDateTime(date, end),
        extendedProps: {
          location: el('#f-location').value || '',
          type: el('#f-type').value,
          status: el('#f-status').value,
          description: el('#f-desc').value || '',
          agenda: [...state.agenda],
          attendees: [...state.attendees],
          notes: el('#f-notes').value || '',
          recordings: [...state.recordings]
        }
      };
    }

    // agenda & attendees lists
    function paintLists(){
      const a = el('#agendaList');
      a.innerHTML = state.agenda.map((t,i)=>`<li>${t} <button data-ai="${i}" style="margin-left:6px">✕</button></li>`).join('');
      a.querySelectorAll('button').forEach(b=> b.onclick = ()=>{ state.agenda.splice(Number(b.dataset.ai),1); paintLists(); });
      const u = el('#attList');
      u.innerHTML = state.attendees.map((t,i)=>`<li>${t} <button data-i="${i}" style="margin-left:6px">✕</button></li>`).join('');
      u.querySelectorAll('button').forEach(b=> b.onclick = ()=>{ state.attendees.splice(Number(b.dataset.i),1); paintLists(); });
    }
    el('#agendaAdd').onclick = ()=>{ const v = el('#f-agenda-input').value.trim(); if(v){ state.agenda.push(v); el('#f-agenda-input').value=''; paintLists(); }};
    el('#attAdd').onclick = ()=>{ const v = el('#f-att').value.trim(); if(v){ state.attendees.push(v); el('#f-att').value=''; paintLists(); }};

    // Save, Delete, Start
    el('#saveBtn').addEventListener('click', async ()=>{
      const data = collectFormToEvent(state.current?.id);
      try {
        await saveMeeting(data);
        // update local + calendar
        const existing = calendar.getEventById(data.id);
        if (existing) existing.remove();
        calendar.addEvent({...data});
        const idx = state.events.findIndex(e=> e.id===data.id);
        if (idx>=0) state.events[idx]=data; else state.events.push(data);
        paintUpcoming();
        closeModal();
      } catch(e) {
        alert('Could not save meeting: ' + (e.message||e));
      }
    });

    el('#deleteBtn').addEventListener('click', async ()=>{
      if(!state.current) return;
      const id = state.current.id;
      await deleteMeeting(id);
      calendar.getEventById(id)?.remove();
      state.events = state.events.filter(e=> e.id!==id);
      paintUpcoming();
      closeModal();
    });

    el('#notesSave').addEventListener('click', async ()=>{
      const id = state.current?.id;
      const updated = collectFormToEvent(id);
      try {
        await saveMeeting(updated);
        // keep local state
        state.current = calendar.getEventById(id);
        if (state.current) { state.current.setExtendedProp('notes', updated.extendedProps.notes); }
        alert('Notes saved');
      } catch(e) {
        alert('Could not save notes: ' + (e.message||e));
      }
    });

    el('#startBtn').addEventListener('click', ()=>{
      const loc = el('#f-location').value.trim();
      if (urlLooksLike(loc)) {
        window.open(loc, '_blank');
      } else {
        alert('Starting meeting… (Add a Teams/Zoom URL in Location to open)');
      }
    });

    // ------------ Recorder ------------
    let mediaStream, mediaRecorder, analyser, audioCtx, rafId, recStartTs=0, chunks=[];
    const recDot = el('#recDot'), recTimer = el('#recTimer'), wave = el('#wave'), recStartBtn = el('#recStart'), recStopBtn = el('#recStop');

    function tickTimer(){
      const ms = Date.now() - recStartTs;
      const t = new Date(ms).toISOString().substr(14,5);
      recTimer.textContent = t;
      if (mediaRecorder && mediaRecorder.state==='recording') requestAnimationFrame(tickTimer);
    }

    function drawWave(){
      const canvas = wave;
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.clientWidth;
      const h = canvas.height = canvas.clientHeight;
      ctx.clearRect(0,0,w,h);
      const data = new Uint8Array(analyser.fftSize);
      analyser.getByteTimeDomainData(data);
      ctx.beginPath();
      for (let x=0; x<w; x++){
        const v = data[Math.floor(x/data.length * data.length)]/128.0;
        const y = v*h/2;
        if (x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.lineWidth = 2; ctx.strokeStyle = '#3b82f6'; ctx.stroke();
      if (mediaRecorder && mediaRecorder.state==='recording') rafId = requestAnimationFrame(drawWave);
    }

    async function startRecording(){
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(mediaStream);
        analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
        source.connect(analyser);

        mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm' });
        chunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size>0) chunks.push(e.data); };
        mediaRecorder.onstop = async ()=>{
          cancelAnimationFrame(rafId);
          recDot.classList.remove('on');
          // Build blob + upload
          const blob = new Blob(chunks, { type: 'audio/webm' });
          const fileName = `${state.user.id}_${state.current?.id || 'new'}_${Date.now()}.webm`;
          // Upload to Supabase Storage
          try{
            const { data, error } = await supabase.storage.from('meeting-recordings').upload(fileName, blob, { upsert:false, contentType:'audio/webm' });
            if (error) throw error;
            const { data: pub } = supabase.storage.from('meeting-recordings').getPublicUrl(fileName);
            const url = pub?.publicUrl || null;
            if (url){
              // attach to meeting props and save
              state.recordings.push({ url, name: fileName });
              paintAudioList();
              // persist to meeting row (auto-create if needed)
              const ev = collectFormToEvent(state.current?.id);
              ev.extendedProps.recordings = [...state.recordings];
              await saveMeeting(ev);
              // keep calendar updated
              const ce = calendar.getEventById(ev.id);
              if (ce) ce.setExtendedProp('recordings', ev.extendedProps.recordings);
            }
          } catch(e){
            console.error('Upload failed', e);
            alert('Upload failed: ' + (e.message||e));
          } finally {
            // Cleanup stream
            mediaStream.getTracks().forEach(t=>t.stop());
            audioCtx && audioCtx.close();
          }
        };

        mediaRecorder.start();
        recStartTs = Date.now();
        recDot.classList.add('on');
        tickTimer();
        drawWave();
        recStartBtn.disabled = true;
        recStopBtn.disabled = false;
      }catch(e){
        alert('Could not start recording: ' + (e.message||e));
      }
    }
    function stopRecording(){
      if (mediaRecorder && mediaRecorder.state==='recording'){
        mediaRecorder.stop();
        recStopBtn.disabled = true;
        recStartBtn.disabled = false;
      }
    }
    recStartBtn.addEventListener('click', startRecording);
    recStopBtn.addEventListener('click', stopRecording);

    function paintAudioList(){
      const box = el('#audioList');
      box.innerHTML = '';
      if (!state.recordings.length){ box.innerHTML = '<div style="color:#475569;">No recordings yet.</div>'; return; }
      state.recordings.forEach(r=>{
        const wrap = document.createElement('div');
        wrap.innerHTML = `<audio controls src="${r.url}"></audio>`;
        box.appendChild(wrap);
      });
    }

    // Upload existing file
    el('#f-rec').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const fileName = `${state.user.id}_${state.current?.id || 'new'}_${Date.now()}_${file.name}`;
      try{
        const { error } = await supabase.storage.from('meeting-recordings').upload(fileName, file, { upsert:false });
        if (error) throw error;
        const { data: pub } = supabase.storage.from('meeting-recordings').getPublicUrl(fileName);
        const url = pub?.publicUrl || null;
        if (url){
          state.recordings.push({ url, name:fileName });
          paintAudioList();
          const ev = collectFormToEvent(state.current?.id);
          ev.extendedProps.recordings = [...state.recordings];
          await saveMeeting(ev);
          const ce = calendar.getEventById(ev.id);
          if (ce) ce.setExtendedProp('recordings', ev.extendedProps.recordings);
        }
      } catch(e){
        alert('Upload failed: ' + (e.message||e));
      } finally {
        e.target.value = '';
      }
    });

    // ------------ Boot ------------
    async function boot(){
      supabase = await initSupabase();
      const { session, profileRow } = await requireStaffSession(supabase);
      state.user = session.user;
      state.siteId = profileRow?.site_id || session.user?.raw_user_meta_data?.site_id || null;

      const siteText = state.siteId ? await getSiteText(supabase, state.siteId) : null;
      setTopbar({ siteText, email: session.user.email, role: profileRow?.role || 'Staff' });
      navActivate('meetings');
      attachLogout(supabase);

      // Calendar with loaded meetings
      const events = await loadMeetings();
      const calEl = el('#calendar');
      calendar = new FullCalendar.Calendar(calEl, {
        initialView: 'dayGridMonth',
        headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
        events,
        eventClick: (info)=> openModal(info.event),
        height: 'auto'
      });
      calendar.render();

      paintUpcoming();

      // actions
      el('#newMeetingBtn').addEventListener('click', ()=> openModal(null));

      // Icons8 wiring like quiz page
      function i8(name, opts = {}){ const base='https://img.icons8.com'; const style=opts.style||'cute-color'; const size=opts.size||48; return `${base}/${style}/${size}/${encodeURIComponent(name)}.png`; }
      function setIcon(el){ const name=el.getAttribute('data-i8'); const size=el.getAttribute('data-i8-size'); const style=el.getAttribute('data-i8-style')||'fluency'; el.src = i8(name,{style,size: size?parseInt(size,10):undefined}); }
      function wireIcons(){ document.querySelectorAll('img[data-i8]').forEach(setIcon); }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', wireIcons); else wireIcons();
    }
    boot();
  </script>

    <!-- Debug Console - Persistent across all pages -->
    <script src="debug-console.js"></script>
</body>
</html>

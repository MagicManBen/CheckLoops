<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>CheckLoops — EMIS Appointment Data</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://*.supabase.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' https://*.supabase.co https://*.supabase.com wss://*.supabase.co wss://*.supabase.com https:;">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="config.js"></script>
<script src="rls-fix.js"></script>
<script src="supabase-js.js"></script>
<script type="module">
  const { createClient } = supabase;
  window.supabaseCreateClient = createClient;
  // Use EXACT same configuration as admin-login.html to share sessions
  const sb = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      flowType: 'pkce',
      storage: window.localStorage,
      storageKey: `sb-${CONFIG.SUPABASE_URL.split('//')[1].split('.')[0]}-auth-token`
    }
  });
  window.supabase = sb;

  // Add small delay to prevent race condition with session loading
  setTimeout(async () => {
    try {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        console.log('EMIS Checker: No session found, redirecting to login');
        sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
        window.location.replace('admin-login.html');
        return;
      }
      console.log('EMIS Checker: Session found for user:', session.user.email);
      const { data: profile } = await sb
        .from('master_users')
        .select('access_type')
        .eq('auth_user_id', session.user.id)
        .maybeSingle();
      const accessType = String(profile?.access_type || '').toLowerCase();
      const isAdmin = accessType === 'admin' || accessType === 'owner';
      console.log('EMIS Checker: Access type:', accessType, '=> isAdmin:', isAdmin);
      if (!isAdmin) {
        console.log('EMIS Checker: Not admin, redirecting to staff portal');
        window.location.replace('staff.html');
      }
    } catch (e) {
      console.log('EMIS Checker: Error checking session, redirecting to login:', e);
      window.location.replace('admin-login.html');
    }
  }, 1000); // Wait 1 second for session to fully load
  window.CONFIG = CONFIG;
  window.addEventListener('storage', (e) => {
    if (e.key && e.key.includes('sb-') && e.newValue === null) {
      try { window.location.replace('home.html'); } catch(_) {}
    }
  });
  window.addEventListener('load', async () => {
    try { await sb.auth.getSession(); } catch(_) {}
  });
  Object.defineProperty(window, 'getSupabase', { value: () => sb });
</script>
<style>
    /* Custom styles */
    .hidden {
        display: none;
    }
    
    /* Minimal app container */
    .app { 
      min-height: 100vh;
      position: relative;
    }
    
    /* Background effects */
    .bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -1;
      background: linear-gradient(120deg, #f5f7fa 0%, #e8ecf1 100%);
      overflow: hidden;
    }
    .wave {
      /* wave removed per request */
      display: none !important;
    }
    .wave2 {
      /* secondary wave disabled */
      display: none !important;
    }
    /* wave animation removed */
    @keyframes wave { from { } to { } }
    .mesh {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -2;
      overflow: hidden;
    }
    .m1, .m2, .m3 {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.15;
    }
    .m1 {
      background: radial-gradient(circle, rgba(30,144,255,1) 0%, rgba(0,212,255,0) 70%);
      width: 60vw;
      height: 60vw;
      top: -20vw;
      left: -10vw;
    }
    .m2 {
      background: radial-gradient(circle, rgba(142,45,226,1) 0%, rgba(142,45,226,0) 70%);
      width: 50vw;
      height: 50vw;
      bottom: -10vw;
      right: -10vw;
    }
    .m3 {
      background: radial-gradient(circle, rgba(74,222,128,1) 0%, rgba(74,222,128,0) 70%);
      width: 40vw;
      height: 40vw;
      top: 30vh;
      right: 20vw;
    }
    .orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(30px);
      opacity: 0.1;
      z-index: -1;
    }
    .orb1 {
      background: #4ade80;
      width: 150px;
      height: 150px;
      top: 40%;
      left: 20%;
      animation: float 8s ease-in-out infinite;
    }
    .orb2 {
      background: #1e90ff;
      width: 100px;
      height: 100px;
      top: 30%;
      right: 20%;
      animation: float 10s ease-in-out infinite;
    }
    .orb3 {
      background: #8e2de2;
      width: 80px;
      height: 80px;
      bottom: 20%;
      right: 30%;
      animation: float 12s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(20px, 20px); }
    }
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -1;
      overflow: hidden;
    }
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      top: -10px;
      animation: fall 15s linear infinite;
    }
    @keyframes fall {
      0% { transform: translateY(0); opacity: 0; }
      10% { opacity: 0.8; }
      90% { opacity: 0.8; }
      100% { transform: translateY(105vh); opacity: 0; }
    }

    /* Header and upload button styling */
    .ops-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 120px; /* Increased header height for better spacing */
      background-color: #f8f9fa;
      padding: 10px;
    }

    /* Ensure the header title is visible */
    .ops-header .header-title {
      display: block;
      font-size: 24px;
      color: blue;
      margin-bottom: 10px;
    }

    /* Style the upload button to be smaller and centered */
    .ops-header .upload-button {
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
    }

    /* Upload button — clean + modern */
    .upload-button {
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 1000;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-height: 32px;
      min-width: 120px;
      padding: 6px 10px;
      background: linear-gradient(180deg,#2563eb,#1d4ed8);
      color: #fff;
      border: 1px solid rgba(15,23,42,.06);
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .01em;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(37,99,235,.16);
      transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
    }

    .upload-button i {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: transparent; /* remove square background */
      font-size: 16px;
      line-height: 1;
    }

    .icon-badge {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(180deg,#2563eb,#1d4ed8);
      display: inline-grid;
      place-items: center;
      color: #fff;
      flex: 0 0 20px;
    }
    .icon-badge i { font-size: 16px; line-height: 1; }

    .upload-button:hover { transform: translateY(-1px); box-shadow: 0 14px 30px rgba(37,99,235,.28); }

    .upload-button.uploading {
      background: linear-gradient(180deg,#64748b,#475569);
      opacity: .98;
      box-shadow: 0 8px 22px rgba(2,6,23,.2);
      cursor: default;
      pointer-events: none;
    }

    .upload-button.uploading::after {
      content:"";
      width:14px; height:14px;
      margin-left: 6px;
      border-radius:50%;
      border:2px solid rgba(255,255,255,.55);
      border-top-color:#fff;
      animation: spin .8s linear infinite;
    }

    @keyframes spin {to{transform: rotate(1turn);}}

    /* Progress overlay — tidy card */
    .progress-overlay {
      position: fixed;
      top: 64px;
      right: 16px;
      width: 300px;
      background: rgba(255,255,255,0.98);
      border: 1px solid rgba(15,23,42,.08);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 12px 30px rgba(2,6,23,.16);
      z-index: 999;
      display: none;
      backdrop-filter: blur(6px);
    }

    .progress-overlay.show { display:block; animation: slideIn .22s ease; }

    .progress-overlay .progress {
      height: 8px;
      border-radius: 999px;
      background: #eaf0f7;
      overflow: hidden;
      margin: 0;
    }

    .progress-overlay .progress .neat-progress {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg,#93c5fd,#1d4ed8);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.08);
      transition: width .2s ease;
      font-size: 0; /* hide text for a cleaner small bar */
      color: transparent;
      text-align: left;
    }

    .progress-label {
      margin-top: 8px;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
      color: #0b1220;
    }
</style>
</head>
<body>
  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
  </div>
  <div class="mesh" aria-hidden="true"><div class="m1"></div><div class="m2"></div><div class="m3"></div></div>
  
  <!-- Floating orbs for extra depth -->
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <div class="orb orb3"></div>
  
  <!-- Particle system -->
  <div class="particles" aria-hidden="true">
    <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
    <div class="particle" style="left: 20%; animation-delay: 2s;"></div>
    <div class="particle" style="left: 30%; animation-delay: 4s;"></div>
    <div class="particle" style="left: 40%; animation-delay: 6s;"></div>
    <div class="particle" style="left: 50%; animation-delay: 8s;"></div>
    <div class="particle" style="left: 60%; animation-delay: 10s;"></div>
    <div class="particle" style="left: 70%; animation-delay: 12s;"></div>
    <div class="particle" style="left: 80%; animation-delay: 14s;"></div>
    <div class="particle" style="left: 90%; animation-delay: 16s;"></div>
  </div>

  <div class="app" id="app" aria-live="polite">
    <!-- Header bar with upload button -->
    <header class="header-bar ops-header" style="position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:center;padding:0 18px;background:rgba(255,255,255,0.97);border-bottom:1px solid #e5e7eb;box-shadow:0 2px 8px rgba(0,0,0,0.03);min-height:72px;height:72px;">
      <div class="header-title">EMIS Appointment Data Upload</div>
      <button class="upload-button" id="upload-button" aria-label="Upload EMIS data" style="padding:3px 18px;min-width:unset;min-height:unset;font-size:15px;height:34px;line-height:1.1;border-radius:7px;box-shadow:0 2px 8px rgba(37,99,235,0.10);">
        <span>Upload EMIS Data</span>
      </button>
      <input type="file" id="file-input" accept=".csv" class="hidden">
    </header>
    
    <!-- Progress overlay -->
    <div class="progress-overlay" id="progress-overlay">
      <div class="d-flex" style="gap:12px; align-items:center;">
        <div class="icon-badge"><i class="bi bi-square"></i></div>
        <div style="flex:1;">
          <div class="progress" style="margin:0;">
            <div id="progress-bar" class="progress-bar neat-progress" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          <div class="progress-label" id="status-message">Uploading...</div>
        </div>
      </div>
    </div>

    <!-- Add scripts here -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elements
            const uploadButton = document.getElementById('upload-button');
            const fileInput = document.getElementById('file-input');
            const progressOverlay = document.getElementById('progress-overlay');
            const progressBar = document.getElementById('progress-bar');
            const statusMessage = document.getElementById('status-message');

            // Global variables
            let parsedData = null;
            let isUploading = false;

            // Handle upload button click
            uploadButton.addEventListener('click', () => {
                if (!isUploading) {
                    fileInput.click();
                }
            });

            // Handle file selection
            fileInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    handleFile(this.files[0]);
                }
            });
            
            // Update progress bar
            function updateProgress(percentage) {
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
                progressBar.textContent = `${Math.round(percentage)}%`;
            }



            // Process CSV file and auto-upload
            function handleFile(file) {
                if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                    alert('Please upload a CSV file.');
                    return;
                }

                if (isUploading) {
                    alert('Upload already in progress. Please wait.');
                    return;
                }

            // Show progress overlay and update button state
            progressOverlay.classList.add('show');
            uploadButton.classList.add('uploading');
            uploadButton.querySelector('span').textContent = 'Uploading...';
            // small icon square is static; status text shown in overlay
            document.getElementById('status-message').textContent = 'Reading file...';
            updateProgress(5);

                Papa.parse(file, {
                    header: false,
                    dynamicTyping: false,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const rows = results.data || [];
                        if (!rows.length) {
                            resetUpload();
                            alert('No rows found in CSV.');
                            return;
                        }
                        if (rows.length === 1) {
                            resetUpload();
                            alert('CSV only contains a header row.');
                            return;
                        }

                        const headerRowRaw = rows[0].map(c => (c == null ? '' : String(c)));
                        const dataRows = rows.slice(1);

                        const hasDataInCol = (idx) => dataRows.some(r => {
                            const v = r[idx];
                            return v !== null && v !== undefined && String(v).trim() !== '';
                        });

                        // Find the rightmost empty header that actually has data => this becomes 'Count'
                        let countIdx = -1;
                        for (let i = headerRowRaw.length - 1; i >= 0; i--) {
                            const h = headerRowRaw[i];
                            const isEmpty = !h || h.trim() === '';
                            if (isEmpty && hasDataInCol(i)) { countIdx = i; break; }
                        }

                        // Build cleaned headers + index -> key map
                        const indexToKey = new Array(headerRowRaw.length).fill(null);
                        for (let i = 0; i < headerRowRaw.length; i++) {
                            const h = (headerRowRaw[i] || '').trim();
                            if (h === '') {
                                if (i === countIdx) {
                                    indexToKey[i] = 'Count';
                                }
                            } else {
                                indexToKey[i] = h;
                            }
                        }

                        // Rebuild objects by column index; trim strings; do NOT fill-down
                        parsedData = dataRows.map(r => {
                            const obj = {};
                            for (let i = 0; i < indexToKey.length; i++) {
                                const key = indexToKey[i];
                                if (!key) continue;
                                let val = r[i];
                                if (typeof val === 'string') val = val.trim();
                                obj[key] = (val === '') ? null : val;
                            }
                            return obj;
                        }).filter(row => Object.values(row).some(v => v !== null && v !== undefined && String(v) !== ''));

                        if (!parsedData || parsedData.length === 0) {
                            resetUpload();
                            alert('No valid data found in the CSV file.');
                            return;
                        }

                        // Auto-start upload
                        uploadToSupabase();
                    },
                    error: function(error) {
                        console.error('Error parsing CSV:', error);
                        resetUpload();
                        alert('Error parsing the CSV file. Please check the file format.');
                    }
                });
            }

            function resetUpload() {
                isUploading = false;
                uploadButton.classList.remove('uploading');
                uploadButton.querySelector('span').textContent = 'Upload EMIS Data';
                progressOverlay.classList.remove('show');
                fileInput.value = '';
                parsedData = null;
                updateProgress(0);
                statusMessage.textContent = '';
                statusMessage.className = 'text-center';
            }

            // Upload CSV rows mapped to DB columns (underscored), preserve "Count", batch upload
            async function uploadToSupabase() {
                if (!parsedData || parsedData.length === 0) {
                    resetUpload();
                    alert('No data to upload.');
                    return;
                }

                isUploading = true;

                try {
                    document.getElementById('status-message').textContent = 'Preparing upload...';
                    updateProgress(10);

                    // Use CONFIG from config.js instead of hardcoding credentials
                    const supabaseUrl = CONFIG.SUPABASE_URL;
                    const url = `${supabaseUrl}/functions/v1/emis-upload`;
                    const jwtToken = CONFIG.SUPABASE_ANON_KEY;

                    // Map CSV headers -> DB columns (NO fill-down, values as-is)
                    const headerToDb = {
                        "Full Name of the Session Holder of the Session": "full_name_session_holder",
                        "Day of Week": "day_of_week",
                        "Session's Session Start": "session_start",
                        "Session's Session End": "session_end",
                        "Appointment Date": "appointment_date",
                        "Appointment Time": "appointment_time",
                        "Slot Type": "slot_type",
                        "Slot Duration": "slot_duration",
                        "Availability": "availability",
                        "DNA": "dna_status",
                        "Booked Time to Slot Time": "booked_time_to_slot_time",
                        "Arrive Time to Send In Time": "arrive_time_to_send_in_time",
                        "Slot Time to Send In Time": "slot_time_to_send_in_time",
                        "Slot Time to Arrive Time": "slot_time_to_arrive_time",
                        "Consultation Time": "consultation_time",
                        "Count": "Count"
                    };

                    // Build records strictly with DB column names
                    const records = parsedData.map((row, idx) => {
                        const obj = {};
                        for (const key in row) {
                            if (Object.prototype.hasOwnProperty.call(headerToDb, key)) {
                                const dbKey = headerToDb[key];
                                let val = row[key];
                                if (typeof val === 'string') {
                                    val = val.trim();
                                }
                                obj[dbKey] = val;
                            }
                        }
                        obj.site_id = 2;
                        obj.csv_row_number = idx + 1;
                        return obj;
                    });

                    // Batch upload for reliability
                    const batchSize = 25;
                    const totalBatches = Math.ceil(records.length / batchSize);
                    let totalUploaded = 0;

                    for (let i = 0; i < totalBatches; i++) {
                        const start = i * batchSize;
                        const end = Math.min((i + 1) * batchSize, records.length);
                        const batch = records.slice(start, end);

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${jwtToken}`
                            },
                            body: JSON.stringify({ records: batch })
                        });

                        if (!response.ok) {
                            let msg = response.statusText || 'Unknown server error';
                            try {
                                const res = await response.json();
                                if (res && (res.error || res.message)) msg = res.error || res.message;
                            } catch {}
                            throw new Error(`Server error ${response.status}: ${msg}`);
                        }

                        totalUploaded += batch.length;
                        const prog = 10 + ((i + 1) / totalBatches) * 90;
                        updateProgress(prog);
                        document.getElementById('status-message').textContent = `Uploading: ${totalUploaded} / ${records.length} records`;
                    }

                    updateProgress(100);
                    document.getElementById('status-message').textContent = `✅ Successfully uploaded ${totalUploaded} of ${records.length} records`;
                    document.getElementById('status-message').className = 'text-center text-success';

                    // Reset after 3 seconds
                    setTimeout(() => {
                        resetUpload();
                    }, 3000);

                } catch (error) {
                    document.getElementById('status-message').textContent = `❌ Error: ${error.message}`;
                    document.getElementById('status-message').className = 'text-center text-danger';
                    
                    // Reset after 5 seconds on error
                    setTimeout(() => {
                        resetUpload();
                    }, 5000);
                }
            }
        });
    </script>

    <!-- Bottom-left user avatar: exact copy of admin dashboard styling -->
    <style>
    /* CSS Variables (same as admin dashboard) */
    :root {
      --accent: #0ea5e9;
      --accent-2: #38bdf8;
      --panel-bg: #ffffff;
      --border-color: #e2e8f0;
      --ink: #0f172a;
      --muted: #64748b;
    }
    
    /* User avatar - exact copy from admin dashboard */
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      transition: transform 0.18s ease;
      flex-shrink: 0;
      cursor: pointer;
      position: fixed;
      left: 18px;
      bottom: 18px;
      z-index: 9999;
    }
    /* Presence indicator (admin dashboard style) */
    .user-avatar { position: fixed; }
    .user-avatar::after {
      content: '';
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 16px;
      height: 16px;
      background: #41d656; /* var(--success) equivalent */
      border: 2px solid var(--panel-bg);
      border-radius: 50%;
    }
    .user-avatar.inactive::after { background: var(--muted); }
    .user-avatar:hover { transform: scale(1.04); }
    
    /* User popover - same styling as email-popover */
    .user-popover {
      position: fixed;
      left: 76px;
      bottom: 18px;
      min-width: 260px;
      max-width: 360px;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(2,6,23,0.25);
      color: var(--ink);
      z-index: 10000;
      transform-origin: bottom left;
      animation: popIn .18s cubic-bezier(.2,.9,.2,1);
      display: none;
    }
    
    @keyframes popIn {
      from { transform: scale(.92) translateY(6px); opacity: 0; }
      to { transform: scale(1) translateY(0); opacity: 1; }
    }
    
    .user-popover .user-email {
      font-weight: 600;
      color: var(--ink);
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .user-popover .user-role {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 12px;
    }
    
    .user-popover .btn-signout {
      width: 100%;
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: transparent;
      color: var(--ink);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .user-popover .btn-signout:hover {
      background: #f8fafc;
      border-color: var(--muted);
    }
    </style>

    <!-- User avatar in bottom-left (exact copy of admin dashboard structure) -->
    <div class="user-avatar" id="user-avatar" title="User menu" aria-haspopup="true" aria-expanded="false">
      <span id="user-initials">U</span>
    </div>
    
    <!-- User popover -->
    <div class="user-popover" id="user-popover" role="dialog" aria-hidden="true">
      <div class="user-email" id="user-email">—</div>
      <div class="user-role" id="user-role">—</div>
      <button class="btn-signout" id="btn-signout">Sign out</button>
    </div>
  </div>

  <script>
    // User avatar functionality — synced with admin dashboard
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const userAvatar = document.getElementById('user-avatar');
        const userPopover = document.getElementById('user-popover');
        const userInitials = document.getElementById('user-initials');
        const userEmailEl = document.getElementById('user-email'); // will show NAME here
        const userRoleEl = document.getElementById('user-role');
        const btnSignout = document.getElementById('btn-signout');

        const sb = window.supabase || (window.getSupabase && window.getSupabase());
        if (!sb) return;

        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
          sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
          window.location.replace('admin-login.html');
          return;
        }

        const user = session.user;

        // Load profile
        let profile = null;
        try {
          const { data } = await sb
            .from('master_users')
            .select('site_id, access_type, full_name, avatar_url')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          profile = data || null;
        } catch (e) { console.error('Profile fetch error:', e); }

        // Build display name exactly like admin dashboard
        let displayName = profile?.full_name ||
                          user?.user_metadata?.nickname ||
                          user?.user_metadata?.full_name ||
                          user?.user_metadata?.name ||
                          (user.email ? user.email.split('@')[0]
                            .replace(/[._-]/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase()) : 'User');

        // Set initials (first + last) like admin dashboard
        const baseName = displayName || user.email || 'User';
        const parts = baseName.trim().split(' ');
        const initials = parts.length >= 2
          ? (parts[0][0] + parts[parts.length - 1][0]).toUpperCase()
          : baseName.substring(0, 2).toUpperCase();
        if (userInitials) userInitials.textContent = initials;

        // Prefer stored avatar URL, fallback to user metadata
        try {
          let avatarUrl = profile?.avatar_url || user?.user_metadata?.avatar_url || null;
          if (!avatarUrl) {
            try {
              const { data: saw } = await sb
                .from('master_users')
                .select('avatar_url, updated_at')
                .eq('auth_user_id', user.id)
                .order('updated_at', { ascending: false })
                .limit(1)
                .maybeSingle();
              avatarUrl = saw?.avatar_url || avatarUrl;
            } catch (_) {}
          }
          if (avatarUrl) {
            let img = userAvatar.querySelector('img');
            if (!img) {
              img = document.createElement('img');
              img.alt = 'Avatar';
              img.style.width = '100%';
              img.style.height = '100%';
              img.style.borderRadius = '50%';
              img.style.objectFit = 'cover';
              userAvatar.appendChild(img);
            }
            img.src = avatarUrl;
            if (userInitials) userInitials.style.display = 'none';
          }
        } catch (e) { console.warn('Avatar render failed', e); }

        // Role text exactly like admin dashboard
        let detectedRole = String(profile?.access_type || user?.user_metadata?.role || '').toLowerCase();
        let roleText = (detectedRole === 'admin' || detectedRole === 'owner' ||
                        (user?.email && user.email.toLowerCase() === 'benhowardmagic@hotmail.com'))
                        ? 'Admin'
                        : (detectedRole ? detectedRole.charAt(0).toUpperCase() + detectedRole.slice(1) : 'Staff');

        // Site name (same fallback)
        let siteName = '';
        try {
          if (profile?.site_id) {
            const { data: site } = await sb
              .from('sites')
              .select('name')
              .eq('id', profile.site_id)
              .maybeSingle();
            siteName = site?.name || '';
          } else {
            siteName = 'Harley Street Medical Centre';
          }
        } catch (_) {}

        // Populate popover text — NAME on first line, then `Role  Site`
        if (userEmailEl) userEmailEl.textContent = displayName;
        if (userRoleEl) userRoleEl.textContent = siteName ? `${roleText}  ${siteName}` : roleText;

        // Toggle popover
        userAvatar.addEventListener('click', (e) => {
          e.stopPropagation();
          const isVisible = userPopover.style.display === 'block';
          document.querySelectorAll('.user-popover').forEach(p => { if (p !== userPopover) p.style.display = 'none'; });
          userPopover.style.display = isVisible ? 'none' : 'block';
          userAvatar.setAttribute('aria-expanded', !isVisible);
        });
        document.addEventListener('click', (e) => {
          if (!userAvatar.contains(e.target) && !userPopover.contains(e.target)) {
            userPopover.style.display = 'none';
            userAvatar.setAttribute('aria-expanded', false);
          }
        });

        // Sign out handler
        btnSignout.addEventListener('click', async () => {
          try { await sb.auth.signOut(); } catch(e) { console.error('Sign out failed', e); }
          window.location.replace('home.html');
        });

      } catch (err) {
        console.error('User avatar init error', err);
      }
    });
  </script>
</body>
</html>

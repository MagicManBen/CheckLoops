<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>CheckLoops — EMIS Appointment Data</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://*.supabase.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' https://*.supabase.co https://*.supabase.com wss://*.supabase.co wss://*.supabase.com https:;">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="config.js"></script>
<script src="rls-fix.js"></script>
<script src="supabase-js.js"></script>
<script type="module">
  const { createClient } = supabase;
  window.supabaseCreateClient = createClient;
  // Use EXACT same configuration as admin-login.html to share sessions
  const sb = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      flowType: 'pkce',
      storage: window.localStorage,
      storageKey: `sb-${CONFIG.SUPABASE_URL.split('//')[1].split('.')[0]}-auth-token`
    }
  });
  window.supabase = sb;

  // Add small delay to prevent race condition with session loading
  setTimeout(async () => {
    try {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        console.log('EMIS Checker: No session found, redirecting to login');
        sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
        window.location.replace('admin-login.html');
        return;
      }
      console.log('EMIS Checker: Session found for user:', session.user.email);
      const { data: profile } = await sb
        .from('master_users')
        .select('access_type')
        .eq('auth_user_id', session.user.id)
        .maybeSingle();
      const accessType = String(profile?.access_type || '').toLowerCase();
      const isAdmin = accessType === 'admin' || accessType === 'owner';
      console.log('EMIS Checker: Access type:', accessType, '=> isAdmin:', isAdmin);
      if (!isAdmin) {
        console.log('EMIS Checker: Not admin, redirecting to staff portal');
        window.location.replace('staff.html');
      }
    } catch (e) {
      console.log('EMIS Checker: Error checking session, redirecting to login:', e);
      window.location.replace('admin-login.html');
    }
  }, 1000); // Wait 1 second for session to fully load
  window.CONFIG = CONFIG;
  window.addEventListener('storage', (e) => {
    if (e.key && e.key.includes('sb-') && e.newValue === null) {
      try { window.location.replace('home.html'); } catch(_) {}
    }
  });
  window.addEventListener('load', async () => {
    try { await sb.auth.getSession(); } catch(_) {}
  });
  Object.defineProperty(window, 'getSupabase', { value: () => sb });
</script>
<style>
    /* Custom styles */
    .upload-container {
        border: 2px dashed #ccc;
        padding: 40px; /* Increased padding for larger size */
        text-align: center;
        margin: 20px auto; /* Center horizontally */
        border-radius: 10px;
        cursor: pointer;
        max-width: 600px; /* Set a maximum width */
        background-color: #f9f9f9; /* Optional: Add a subtle background color */
    }
    .upload-container:hover {
        border-color: #007bff;
        background-color: #e9f5ff; /* Optional: Change background on hover */
    }
    .hidden {
        display: none;
    }
    /* Ensure tab panes are visible without fade glitches */
    .tab-pane { display: none; }
    .tab-pane.active { display: block; opacity: 1; }
    .fade {
        opacity: 0;
        transition: opacity 0.5s ease-out;
    }
    .alert {
        transition: all 0.3s ease-in-out;
    }
    .alert-success {
        border-left: 5px solid #28a745;
    }
    .alert-warning {
        border-left: 5px solid #ffc107;
    }
    .processing-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid rgba(0,123,255,0.3);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    #progress-area {
        margin-top: 20px;
    }
    .preview-table {
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
    }
    #status-message {
        margin-top: 15px;
    }
    .stats-container {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    .stats-item {
        margin-bottom: 10px;
    }
    .summary-card {
        background-color: #f0f8ff;
        padding: 15px;
        margin-top: 20px;
        border-left: 5px solid #007bff;
        border-radius: 5px;
    }
    .badge {
        font-size: 1em;
    }
    #debug-panel {
        margin-bottom: 50px;
    }
    .debug-success {
        color: #28a745;
        font-weight: bold;
    }
    .debug-error {
        color: #dc3545;
        font-weight: bold;
    }
    .debug-warning {
        color: #ffc107;
        font-weight: bold;
    }
    .debug-info {
        color: #17a2b8;
        font-weight: bold;
    }
    .copy-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        background-color: #28a745;
        color: white;
        border-radius: 4px;
        transition: opacity 0.3s ease-in-out;
        opacity: 0;
    }
    
    /* Admin Dashboard Layout Styles */
    .app { 
      display: grid;
      --sidebarW: 260px; 
      grid-template-columns: var(--sidebarW) minmax(0, 1fr); 
      gap: 22px; 
      padding: 22px; 
      min-height: 100vh; 
      transition: grid-template-columns .2s ease; 
    }
    .app.collapsed { --sidebarW: 56px; }
    .main-content { overflow-x: hidden; }
    .sidebar {
      background: var(--sidebar, #fff); 
      border-radius: 12px; 
      box-shadow: var(--shadow-md); 
      overflow-y: auto;
      padding: 18px 0;
    }
    .app.collapsed #sidebar {
      padding: 18px 0;
      overflow: visible;
    }
    .brand {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 30px;
      padding: 0 24px;
    }
    .brand .logo {
      width: 42px;
      height: auto;
      margin-bottom: 12px;
    }
    .brand .t {
      font-size: 1.2rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      margin: 0;
      white-space: nowrap;
    }
    .brand .hint {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 4px;
    }
    .sidebar-toggle {
      float: right;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      margin: 0 10px 0 0;
      color: var(--text-light);
    }
    .sidebar-toggle:hover {
      background: var(--hover-light);
    }
    .sidebar-toggle-icon {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 18px;
      height: 14px;
    }
    .toggle-line {
      background: currentColor;
      height: 2px;
      width: 100%;
      border-radius: 5px;
      transition: transform 0.3s, opacity 0.2s;
    }
    .toggle-line:nth-child(1) { transform-origin: top left; }
    .toggle-line:nth-child(3) { transform-origin: bottom left; }
    .app.collapsed .toggle-line:nth-child(1) { transform: rotate(45deg) translate(1px, -1px); }
    .app.collapsed .toggle-line:nth-child(2) { opacity: 0; }
    .app.collapsed .toggle-line:nth-child(3) { transform: rotate(-45deg) translate(1px, 1px); }
    
    #main-content-container {
      padding: 20px;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      min-height: calc(100vh - 44px);
    }
    
    /* Background effects */
    .bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -1;
      background: linear-gradient(120deg, #f5f7fa 0%, #e8ecf1 100%);
      overflow: hidden;
    }
    .wave {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 40%;
      background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNDQwIDMyMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+PHBhdGggZmlsbD0icmdiYSgyNDAsIDI0NCwgMjQ4LCAwLjgpIiBkPSJNMCw5NlM0OCw4MCwxNDQsODBzMTkyLDQ4LDI4OCw0OHMxOTIsLTk2LDI4OCwtOTZTOTEyLDk2LDEwMDgsOTZzMTkyLC00OCwyODgsLTQ4czk2LDgwLDE0NCw4MFYzMjBIMFY5NloiPjwvcGF0aD48L3N2Zz4=') repeat-x;
      background-size: 1440px 320px;
      animation: wave 20s linear infinite;
    }
    .wave2 {
      opacity: 0.5;
      animation-duration: 15s;
      animation-direction: reverse;
    }
    @keyframes wave {
      0% { background-position-x: 0; }
      100% { background-position-x: 1440px; }
    }
    .mesh {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -2;
      overflow: hidden;
    }
    .m1, .m2, .m3 {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.15;
    }
    .m1 {
      background: radial-gradient(circle, rgba(30,144,255,1) 0%, rgba(0,212,255,0) 70%);
      width: 60vw;
      height: 60vw;
      top: -20vw;
      left: -10vw;
    }
    .m2 {
      background: radial-gradient(circle, rgba(142,45,226,1) 0%, rgba(142,45,226,0) 70%);
      width: 50vw;
      height: 50vw;
      bottom: -10vw;
      right: -10vw;
    }
    .m3 {
      background: radial-gradient(circle, rgba(74,222,128,1) 0%, rgba(74,222,128,0) 70%);
      width: 40vw;
      height: 40vw;
      top: 30vh;
      right: 20vw;
    }
    .orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(30px);
      opacity: 0.1;
      z-index: -1;
    }
    .orb1 {
      background: #4ade80;
      width: 150px;
      height: 150px;
      top: 40%;
      left: 20%;
      animation: float 8s ease-in-out infinite;
    }
    .orb2 {
      background: #1e90ff;
      width: 100px;
      height: 100px;
      top: 30%;
      right: 20%;
      animation: float 10s ease-in-out infinite;
    }
    .orb3 {
      background: #8e2de2;
      width: 80px;
      height: 80px;
      bottom: 20%;
      right: 30%;
      animation: float 12s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(20px, 20px); }
    }
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -1;
      overflow: hidden;
    }
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      top: -10px;
      animation: fall 15s linear infinite;
    }
    @keyframes fall {
      0% { transform: translateY(0); opacity: 0; }
      10% { opacity: 0.8; }
      90% { opacity: 0.8; }
      100% { transform: translateY(105vh); opacity: 0; }
    }
    
    /* Navigation styles */
    #nav {
      padding: 0 12px;
    }
    #nav button {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: none;
      background: transparent;
      text-align: left;
      margin-bottom: 4px;
      color: var(--text, #374151);
      transition: all 0.2s;
      position: relative;
      cursor: pointer;
    }
    #nav button:hover {
      background: var(--hover, rgba(243,244,246,0.8));
    }
    #nav button.active {
      background: var(--active, rgba(224,242,254,0.7));
      color: var(--accent, #0ea5e9);
    }
    #nav .icon {
      width: 18px;
      height: 18px;
      margin-right: 12px;
      flex-shrink: 0;
      color: var(--muted, #6b7280);
    }
    #nav button.active .icon {
      color: var(--accent, #0ea5e9);
    }
    
    /* Nav Group Toggle */
    #nav .nav-group-toggle {
      font-weight: 600;
      margin-top: 8px;
    }
    #nav .nav-group-toggle .caret {
      margin-left: auto;
      transition: transform 0.2s;
      opacity: 0.6;
    }
    #nav .nav-group-toggle[aria-expanded="true"] .caret {
      transform: rotate(180deg);
    }
    #nav .nav-group {
      padding-left: 16px;
      margin-bottom: 8px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    #nav .nav-group.collapsed {
      max-height: 0;
    }
    
    /* Main content area styling */
    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .content-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }
    
    /* Inner container for actual EMIS content */
    .emis-container {
      max-width: 800px;
      margin: 0 auto;
    }
</style>
</head>
<body>
  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
  </div>
  <div class="mesh" aria-hidden="true"><div class="m1"></div><div class="m2"></div><div class="m3"></div></div>
  
  <!-- Floating orbs for extra depth -->
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <div class="orb orb3"></div>
  
  <!-- Particle system -->
  <div class="particles" aria-hidden="true">
    <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
    <div class="particle" style="left: 20%; animation-delay: 2s;"></div>
    <div class="particle" style="left: 30%; animation-delay: 4s;"></div>
    <div class="particle" style="left: 40%; animation-delay: 6s;"></div>
    <div class="particle" style="left: 50%; animation-delay: 8s;"></div>
    <div class="particle" style="left: 60%; animation-delay: 10s;"></div>
    <div class="particle" style="left: 70%; animation-delay: 12s;"></div>
    <div class="particle" style="left: 80%; animation-delay: 14s;"></div>
    <div class="particle" style="left: 90%; animation-delay: 16s;"></div>
  </div>

  <div class="app" id="app" aria-live="polite">
    <!-- Sidebar intentionally removed for focused EMIS page -->
    <main class="main-content">
      <div id="main-content-container">
        <div class="content-header">
          <h1 class="content-title">EMIS Appointment Data Upload</h1>
        </div>
        
        <div class="emis-container">
          <ul class="nav nav-tabs" id="emis-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-section" type="button" role="tab" aria-controls="upload-section" aria-selected="true">Upload</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="view-tab" data-bs-toggle="tab" data-bs-target="#view-section" type="button" role="tab" aria-controls="view-section" aria-selected="false">View Data</button>
            </li>
          </ul>
          
          <div class="tab-content" id="emis-tabs-content">
        <div class="tab-pane show active" id="upload-section" role="tabpanel" aria-labelledby="upload-tab">
          <!-- Upload Tab Content -->
          <div>
            <div class="upload-container" id="drop-area">
                <p>Drag & drop your CSV file here or click to select a file</p>
                <input type="file" id="file-input" accept=".csv" class="hidden">
            </div>

            <div id="file-info" class="alert alert-info hidden">
                <span id="file-name"></span>
                <button class="btn btn-sm btn-danger float-end" id="remove-file">Remove</button>
            </div>

            <div id="data-stats" class="stats-container hidden">
                <h4>Data Statistics</h4>
                <div class="row">
                    <div class="col-md-4 stats-item">
                        <strong>Total Rows:</strong> <span id="total-rows">0</span>
                    </div>
                    <div class="col-md-4 stats-item">
                        <strong>Valid Rows:</strong> <span id="valid-rows">0</span>
                    </div>
                    <div class="col-md-4 stats-item">
                        <strong>Invalid Rows:</strong> <span id="invalid-rows">0</span>
                    </div>
                </div>
                <div id="validation-issues" class="mt-2 hidden">
                    <h5>Validation Issues:</h5>
                    <ul id="validation-list" class="text-danger"></ul>
                </div>
            </div>

            <div id="preview-area" class="hidden">
                <h3>Data Preview</h3>
                <p>Showing the first 5 rows of data:</p>
                <div class="preview-table">
                    <table class="table table-striped table-bordered" id="preview-table">
                        <thead id="preview-headers"></thead>
                        <tbody id="preview-body"></tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <button id="upload-btn" class="btn btn-primary">Upload to Database</button>
                </div>
            </div>

            <div id="progress-area" class="hidden">
                <div class="progress">
                    <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div id="status-message" class="text-center"></div>
            </div>
            
            <div id="upload-summary" class="summary-card hidden">
                <h4>Upload Summary</h4>
                <div class="row">
                    <div class="col-md-4">
                        <strong>Total Processed:</strong> <span id="total-processed">0</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Successfully Uploaded:</strong> <span id="total-uploaded">0</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Status:</strong> <span id="upload-status" class="badge bg-success">Success</span>
                    </div>
                </div>
                <div class="mt-3">
                    <button id="new-upload-btn" class="btn btn-outline-primary">Upload Another File</button>
                    <button id="test-connection-btn" class="btn btn-outline-secondary ms-2">Test API Connection</button>
                </div>
            </div>
          </div>
        </div>
        <div class="tab-pane" id="view-section" role="tabpanel" aria-labelledby="view-tab">
          <!-- View Data Tab Content -->
          <div class="my-3">
            <input type="text" id="search-box" class="form-control" placeholder="Filter by Full Name, Date, etc...">
          </div>
          <div>
            <span id="row-count"></span>
          </div>
          <div style="max-height: 500px; overflow:auto;">
            <table class="table table-sm table-striped" id="emis-table">
              <thead><tr id="emis-table-head"></tr></thead>
              <tbody id="emis-table-body"></tbody>
            </table>
          </div>
          <nav>
            <ul class="pagination justify-content-center mt-3" id="emis-pagination"></ul>
          </nav>
        </div>
      </div>
    </div>
    
    <!-- Add Bootstrap Icons for copy button -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Add scripts here -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://unveoqnlqnobufhublyw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME';
    const supabase = createClient(supabaseUrl, supabaseKey);

    const VIEW_NAME = 'emis_apps_filled';
    const PAGE_SIZE = 25;
    let emisRows = [], emisFilteredRows = [], page = 1, totalPages = 1;

    document.addEventListener('DOMContentLoaded', () => {
      // Tabs: Only fetch when view tab is shown
      document.getElementById('view-tab').addEventListener('shown.bs.tab', fetchAndRenderEmisData);
      document.getElementById('search-box').addEventListener('input', function() {
        filterAndRenderEmisTable(this.value);
      });
    });

    async function fetchAndRenderEmisData() {
      const { data, error } = await supabase
        .from(VIEW_NAME)
        .select('*')
        .order('csv_row_number', { ascending: true });

      if (error) {
        document.getElementById('emis-table-body').innerHTML = `<tr><td colspan="100%" class="text-danger">Error loading data: ${error.message}</td></tr>`;
        return;
      }
      emisRows = data || [];
      filterAndRenderEmisTable(document.getElementById('search-box').value);
    }

    function filterAndRenderEmisTable(filterVal) {
      filterVal = filterVal?.toLowerCase() || '';
      emisFilteredRows = !filterVal
        ? emisRows
        : emisRows.filter(row => Object.values(row).some(
            val => (val + '').toLowerCase().includes(filterVal)
          ));

      page = 1;
      totalPages = Math.max(1, Math.ceil(emisFilteredRows.length / PAGE_SIZE));
      renderEmisTablePage();
    }

    function renderEmisTablePage() {
      const tableHead = document.getElementById('emis-table-head');
      const tableBody = document.getElementById('emis-table-body');
      if (!emisFilteredRows.length) {
        tableHead.innerHTML = '';
        tableBody.innerHTML = '<tr><td colspan="100%">No records found.</td></tr>';
        document.getElementById('row-count').textContent = '';
        renderEmisPagination();
        return;
      }
      const headers = Object.keys(emisFilteredRows[0]);
      tableHead.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
      const start = (page - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      tableBody.innerHTML = emisFilteredRows.slice(start, end).map(row =>
        `<tr>${headers.map(h => `<td>${row[h] ?? ''}</td>`).join('')}</tr>`
      ).join('');
      document.getElementById('row-count').textContent = `Showing ${Math.min(end, emisFilteredRows.length)} of ${emisFilteredRows.length} records`;
      renderEmisPagination();
    }

    function renderEmisPagination() {
      const pag = document.getElementById('emis-pagination');
      if (totalPages <= 1) { pag.innerHTML = ''; return; }
      pag.innerHTML = `
        <li class="page-item${page==1?' disabled':''}"><a class="page-link" href="#" onclick="emisGotoPage(${page-1});return false;">Prev</a></li>
        ${Array.from({length: totalPages}, (_,i)=>i+1).map(n=>`
          <li class="page-item${page==n?' active':''}"><a class="page-link" href="#" onclick="emisGotoPage(${n});return false;">${n}</a></li>
        `).join('')}
        <li class="page-item${page==totalPages?' disabled':''}"><a class="page-link" href="#" onclick="emisGotoPage(${page+1});return false;">Next</a></li>
      `;
    }
    window.emisGotoPage = function(n) {
      if (n<1 || n>totalPages) return;
      page = n;
      renderEmisTablePage();
    }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure Upload tab content is visible by default even if fade classes misbehave
            document.getElementById('upload-section')?.classList.add('active');
            document.getElementById('view-section')?.classList.remove('active');
            // Elements
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');
            const removeFileBtn = document.getElementById('remove-file');
            const previewArea = document.getElementById('preview-area');
            const previewHeaders = document.getElementById('preview-headers');
            const previewBody = document.getElementById('preview-body');
            const uploadBtn = document.getElementById('upload-btn');
            const progressArea = document.getElementById('progress-area');
            const progressBar = document.getElementById('progress-bar');
            const statusMessage = document.getElementById('status-message');

            // Global variables
            let csvData = null;
            let parsedData = null;
            let csvHeadersOrder = null;

            // Handle file drop event
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropArea.classList.add('bg-light');
            }

            function unhighlight() {
                dropArea.classList.remove('bg-light');
            }

            // Handle file drop
            dropArea.addEventListener('drop', handleDrop, false);
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                handleFile(file);
            }

            // Handle file selection
            dropArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    handleFile(this.files[0]);
                }
            });

            // Remove file button
            removeFileBtn.addEventListener('click', () => {
                resetFileInput();
            });

            // Reset file input and related display elements
            function resetFileInput() {
                fileInput.value = '';
                csvData = null;
                parsedData = null;
                // Hide all areas
                fileInfo.classList.add('hidden');
                previewArea.classList.add('hidden');
                progressArea.classList.add('hidden');
                document.getElementById('data-stats').classList.add('hidden');
                document.getElementById('validation-issues').classList.add('hidden');
                document.getElementById('upload-summary').classList.add('hidden');
                // Reset progress
                updateProgress(0);
                statusMessage.textContent = '';
                statusMessage.classList.remove('text-success', 'text-warning', 'text-danger');
                // Reset upload button
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload to Database';
            }
            
            // Update progress bar
            function updateProgress(percentage) {
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
            }
            
            
            // Map CSV fields to database columns with validation
            function mapCsvToDbFields(data) {
    let validRows = [];
    let invalidRows = [];
    validationIssues = []; // Reset global validation issues

    // CSV columns and DB columns in the SAME order
    const csvHeaders = [
        "Full Name of the Session Holder of the Session",
        "Day of Week",
        "Session's Session Start",
        "Session's Session End",
        "Appointment Date",
        "Appointment Time",
        "Slot Type",
        "Slot Duration",
        "Availability",
        "DNA",
        "Booked Time to Slot Time",
        "Arrive Time to Send In Time",
        "Slot Time to Send In Time",
        "Slot Time to Arrive Time",
        "Consultation Time",
        "Count"
    ];
    const dbKeys = [
        "full_name_session_holder",
        "day_of_week",
        "session_start",
        "session_end",
        "appointment_date",
        "appointment_time",
        "slot_type",
        "slot_duration",
        "availability",
        "dna_status",
        "booked_time_to_slot_time",
        "arrive_time_to_send_in_time",
        "slot_time_to_send_in_time",
        "slot_time_to_arrive_time",
        "consultation_time",
        "Count"
    ];

    data.forEach((row, index) => {
        try {
            let mappedRow = {};

            csvHeaders.forEach((col, i) => {
                let val = row[col];
                // Keep the value as-is from CSV, including empty values
                if (val === undefined || val === null) {
                    val = null;
                }
                mappedRow[dbKeys[i]] = val;
            });

            // Add extra columns for site ID and CSV row number
            mappedRow["site_id"] = 2;
            mappedRow["csv_row_number"] = index + 2;

            validRows.push(mappedRow);
        } catch (error) {
            const issueObj = {
                rowIndex: index + 2,
                error: error.message,
                originalRow: row
            };
            invalidRows.push(issueObj);
            validationIssues.push(issueObj);
        }
    });

    updateDataStats(data.length, validRows.length, invalidRows.length);
    if (invalidRows.length > 0) showValidationIssues(invalidRows);

    return validRows;

}
            
            // Update data statistics in the UI
            function updateDataStats(total, valid, invalid) {
                const dataStats = document.getElementById('data-stats');
                const totalRows = document.getElementById('total-rows');
                const validRows = document.getElementById('valid-rows');
                const invalidRows = document.getElementById('invalid-rows');
                
                totalRows.textContent = total;
                validRows.textContent = valid;
                invalidRows.textContent = invalid;
                
                dataStats.classList.remove('hidden');
            }
            
            // Show validation issues in the UI
            function showValidationIssues(issues) {
                const validationIssuesDiv = document.getElementById('validation-issues');
                const validationList = document.getElementById('validation-list');
                
                // Clear previous issues
                validationList.innerHTML = '';
                
                // Show up to 10 issues
                const displayIssues = issues.slice(0, 10);
                displayIssues.forEach(issue => {
                    const li = document.createElement('li');
                    li.textContent = `Row ${issue.rowIndex}: ${issue.error}`;
                    validationList.appendChild(li);
                });
                
                // Add message for additional issues
                if (issues.length > 10) {
                    const li = document.createElement('li');
                    li.textContent = `...and ${issues.length - 10} more issues not shown`;
                    validationList.appendChild(li);
                }
                
                validationIssuesDiv.classList.remove('hidden');
            }

            // Parse time strings to HH:MM:SS format
            function parseTime(timeStr) {
                if (!timeStr || timeStr === "") return null;
                if (timeStr === "Unknown") return "Unknown";
                try {
                    // Check if it's already in HH:MM or HH:MM:SS format
                    if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(timeStr)) {
                        // Ensure it has seconds
                        if (!timeStr.includes(':')) return null;
                        const parts = timeStr.split(':');
                        if (parts.length === 2) {
                            return `${parts[0].padStart(2, '0')}:${parts[1]}:00`;
                        }
                        return timeStr;
                    }
                    // Handle special case for 0:00 in your data
                    if (timeStr === '0:00') {
                        return '00:00:00';
                    }
                    console.warn(`Could not parse time: ${timeStr}`);
                    return null;
                } catch (error) {
                    console.error(`Error parsing time '${timeStr}':`, error);
                    return null;
                }
            }
            
            // Parse date strings to ISO format
            function parseDate(dateStr) {
                if (!dateStr || dateStr === "") return null;
                if (dateStr === "Unknown") return "Unknown";
                // Handle various date formats
                try {
                    // Check for the format D-MMM-YYYY (e.g., 8-Sep-25 or 8-Sep-2025)
                    if (dateStr.includes('-')) {
                        const dateParts = dateStr.split('-');
                        // Format could be: DD-MMM-YY or DD-MMM-YYYY
                        if (dateParts.length === 3) {
                            const day = dateParts[0].trim().padStart(2, '0');
                            const monthMap = {
                                'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 'May': '05', 'Jun': '06',
                                'Jul': '07', 'Aug': '08', 'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                            };
                            const month = monthMap[dateParts[1].trim()] || '01';
                            // Handle 2-digit or 4-digit years
                            let year = dateParts[2].trim();
                            if (year.length === 2) {
                                year = '20' + year; // Assume 20xx for two-digit years
                            }
                            return `${year}-${month}-${day}`;
                        }
                    }
                    // Check if it's already in ISO format (YYYY-MM-DD)
                    const isoRegex = /^\d{4}-\d{2}-\d{2}$/;
                    if (isoRegex.test(dateStr)) {
                        return dateStr;
                    }
                    // Try parsing with built-in Date
                    const parsed = new Date(dateStr);
                    if (!isNaN(parsed.getTime())) {
                        return parsed.toISOString().split('T')[0];
                    }
                    console.warn(`Could not parse date: ${dateStr}`);
                    return null;
                } catch (error) {
                    console.error(`Error parsing date '${dateStr}':`, error);
                    return null;
                }
            }
            


            // Process and display CSV file (parse as array, detect last empty header with data as Count, preserve column index, no fill-down)
            function handleFile(file) {
                if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                    alert('Please upload a CSV file.');
                    return;
                }

                csvData = file;
                fileName.textContent = file.name;
                fileInfo.classList.remove('hidden');

                Papa.parse(file, {
                    header: false,              // parse as arrays to keep column indices
                    dynamicTyping: false,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const rows = results.data || [];
                        if (!rows.length) {
                            alert('No rows found in CSV.');
                            return;
                        }
                        if (rows.length === 1) {
                            alert('CSV only contains a header row.');
                            return;
                        }

                        const headerRowRaw = rows[0].map(c => (c == null ? '' : String(c)));
                        const dataRows = rows.slice(1);

                        const hasDataInCol = (idx) => dataRows.some(r => {
                            const v = r[idx];
                            return v !== null && v !== undefined && String(v).trim() !== '';
                        });

                        // Find the rightmost empty header that actually has data => this becomes 'Count'
                        let countIdx = -1;
                        for (let i = headerRowRaw.length - 1; i >= 0; i--) {
                            const h = headerRowRaw[i];
                            const isEmpty = !h || h.trim() === '';
                            if (isEmpty && hasDataInCol(i)) { countIdx = i; break; }
                        }

                        // Build cleaned headers + index -> key map
                        const cleanedHeaders = [];
                        const indexToKey = new Array(headerRowRaw.length).fill(null);
                        for (let i = 0; i < headerRowRaw.length; i++) {
                            const h = (headerRowRaw[i] || '').trim();
                            if (h === '') {
                                if (i === countIdx) {
                                    cleanedHeaders.push('Count');
                                    indexToKey[i] = 'Count';
                                }
                                // else drop empty unnamed column with no data
                            } else {
                                cleanedHeaders.push(h);
                                indexToKey[i] = h;
                            }
                        }

                        // Rebuild objects by column index; trim strings; do NOT fill-down
                        parsedData = dataRows.map(r => {
                            const obj = {};
                            for (let i = 0; i < indexToKey.length; i++) {
                                const key = indexToKey[i];
                                if (!key) continue; // dropped column
                                let val = r[i];
                                if (typeof val === 'string') val = val.trim();
                                obj[key] = (val === '') ? null : val; // preserve nulls, keep 'Unknown' strings
                            }
                            return obj;
                        }).filter(row => Object.values(row).some(v => v !== null && v !== undefined && String(v) !== ''));

                        csvHeadersOrder = cleanedHeaders;
                        showPreview(parsedData);
                    },
                    error: function(error) {
                        console.error('Error parsing CSV:', error);
                        alert('Error parsing the CSV file. Please check the file format.');
                    }
                });
            }

            // Show preview of the parsed CSV data, preserving CSV header order
            function showPreview(data) {
                if (!data || data.length === 0) {
                    alert('No valid data found in the CSV file.');
                    return;
                }

                const headers = csvHeadersOrder && csvHeadersOrder.length ? csvHeadersOrder : Object.keys(data[0]);

                // Display headers in CSV order
                let headerRow = '<tr>';
                headers.forEach(header => { headerRow += `<th>${header}</th>`; });
                headerRow += '</tr>';
                previewHeaders.innerHTML = headerRow;

                // Display first 5 rows in CSV order
                let bodyRows = '';
                data.slice(0, 5).forEach(row => {
                    let rowHtml = '<tr>';
                    headers.forEach(header => { rowHtml += `<td>${row[header] ?? ''}</td>`; });
                    rowHtml += '</tr>';
                    bodyRows += rowHtml;
                });
                previewBody.innerHTML = bodyRows;

                previewArea.classList.remove('hidden');
            }

            // Upload button
            uploadBtn.addEventListener('click', uploadToSupabase);

            // Upload CSV rows mapped to DB columns (underscored), preserve "Count", batch upload
            async function uploadToSupabase() {
                if (!parsedData || parsedData.length === 0) {
                    alert('No data to upload.');
                    return;
                }

                try {
                    progressArea.classList.remove('hidden');
                    statusMessage.textContent = 'Uploading...';
                    updateProgress(10);

                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';

                    const supabaseUrl = 'https://unveoqnlqnobufhublyw.supabase.co';
                    const url = `${supabaseUrl}/functions/v1/emis-upload`;
                    const jwtToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME';

                    // Map CSV headers -> DB columns (NO fill-down, values as-is)
                    const headerToDb = {
                        "Full Name of the Session Holder of the Session": "full_name_session_holder",
                        "Day of Week": "day_of_week",
                        "Session's Session Start": "session_start",
                        "Session's Session End": "session_end",
                        "Appointment Date": "appointment_date",
                        "Appointment Time": "appointment_time",
                        "Slot Type": "slot_type",
                        "Slot Duration": "slot_duration",
                        "Availability": "availability",
                        "DNA": "dna_status",
                        "Booked Time to Slot Time": "booked_time_to_slot_time",
                        "Arrive Time to Send In Time": "arrive_time_to_send_in_time",
                        "Slot Time to Send In Time": "slot_time_to_send_in_time",
                        "Slot Time to Arrive Time": "slot_time_to_arrive_time",
                        "Consultation Time": "consultation_time",
                        "Count": "Count" // this column exists as quoted "Count" in your table
                    };

                    // Build records strictly with DB column names present in your schema
                    const records = parsedData.map((row, idx) => {
                        const obj = {};
                        for (const key in row) {
                            if (Object.prototype.hasOwnProperty.call(headerToDb, key)) {
                                const dbKey = headerToDb[key];
                                let val = row[key];
                                if (typeof val === 'string') {
                                    val = val.trim();
                                }
                                obj[dbKey] = val; // keep value as-is (no fill-down), but trimmed
                                
                                // Debug log for Count column
                                if (key === 'Count' && idx < 3) {
                                    console.log(`Row ${idx}: Count column - CSV key: "${key}", DB key: "${dbKey}", Value: "${val}"`);
                                }
                            }
                        }
                        obj.site_id = 2;
                        obj.csv_row_number = idx + 1;
                        
                        // Debug log for first 3 records
                        if (idx < 3) {
                            console.log(`Record ${idx}:`, obj);
                        }
                        
                        return obj;
                    });

                    // Batch upload for reliability
                    const batchSize = 25;
                    const totalBatches = Math.ceil(records.length / batchSize);
                    let totalUploaded = 0;

                    for (let i = 0; i < totalBatches; i++) {
                        const start = i * batchSize;
                        const end = Math.min((i + 1) * batchSize, records.length);
                        const batch = records.slice(start, end);

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${jwtToken}`
                            },
                            body: JSON.stringify({ records: batch })
                        });

                        if (!response.ok) {
                            let msg = response.statusText || 'Unknown server error';
                            try {
                                const res = await response.json();
                                if (res && (res.error || res.message)) msg = res.error || res.message;
                            } catch {}
                            throw new Error(`Server error ${response.status}: ${msg}`);
                        }

                        totalUploaded += batch.length;
                        const prog = 10 + ((i + 1) / totalBatches) * 90;
                        updateProgress(prog);
                        statusMessage.textContent = `Uploaded ${totalUploaded} / ${records.length}`;
                    }

                    updateProgress(100);
                    statusMessage.textContent = `Successfully uploaded ${totalUploaded} records.`;
                    statusMessage.classList.add('text-success');

                    // Summary
                    const uploadSummary = document.getElementById('upload-summary');
                    const totalProcessed = document.getElementById('total-processed');
                    const totalUploadedEl = document.getElementById('total-uploaded');
                    const uploadStatus = document.getElementById('upload-status');
                    uploadSummary.classList.remove('hidden');
                    totalProcessed.textContent = records.length;
                    totalUploadedEl.textContent = totalUploaded;
                    uploadStatus.textContent = 'Success';
                    uploadStatus.classList.add('bg-success');

                } catch (error) {
                    statusMessage.textContent = `Error: ${error.message}`;
                    statusMessage.classList.add('text-danger');
                    updateProgress(0);
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload to Database';
                }
            }
            
            // Test API Connection (simplified, no debug UI)
            document.getElementById('test-connection-btn').addEventListener('click', async function() {
                try {
                    statusMessage.textContent = 'Testing connection to API...';
                    const supabaseUrl = 'https://unveoqnlqnobufhublyw.supabase.co';
                    const jwtToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME';
                    const res = await fetch(`${supabaseUrl}/functions/v1/emis-upload/health`, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${jwtToken}` }
                    });
                    if (res.ok) {
                        statusMessage.textContent = 'API connection successful! ✅';
                        statusMessage.classList.add('text-success');
                    } else {
                        statusMessage.textContent = `API connection failed: ${res.status} ❌`;
                        statusMessage.classList.add('text-danger');
                    }
                } catch (e) {
                    statusMessage.textContent = `Connection test error: ${e.message} ❌`;
                    statusMessage.classList.add('text-danger');
                }
            });
            
            // Update progress bar
            function updateProgress(percentage) {
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
            }
        });
    </script>

    <!-- Bottom-left user avatar: exact copy of admin dashboard styling -->
    <style>
    /* CSS Variables (same as admin dashboard) */
    :root {
      --accent: #0ea5e9;
      --accent-2: #38bdf8;
      --panel-bg: #ffffff;
      --border-color: #e2e8f0;
      --ink: #0f172a;
      --muted: #64748b;
    }
    
    /* User avatar - exact copy from admin dashboard */
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      transition: transform 0.18s ease;
      flex-shrink: 0;
      cursor: pointer;
      position: fixed;
      left: 18px;
      bottom: 18px;
      z-index: 9999;
    }
    /* Presence indicator (admin dashboard style) */
    .user-avatar { position: fixed; }
    .user-avatar::after {
      content: '';
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 16px;
      height: 16px;
      background: #41d656; /* var(--success) equivalent */
      border: 2px solid var(--panel-bg);
      border-radius: 50%;
    }
    .user-avatar.inactive::after { background: var(--muted); }
    .user-avatar:hover { transform: scale(1.04); }
    
    /* User popover - same styling as email-popover */
    .user-popover {
      position: fixed;
      left: 76px;
      bottom: 18px;
      min-width: 260px;
      max-width: 360px;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(2,6,23,0.25);
      color: var(--ink);
      z-index: 10000;
      transform-origin: bottom left;
      animation: popIn .18s cubic-bezier(.2,.9,.2,1);
      display: none;
    }
    
    @keyframes popIn {
      from { transform: scale(.92) translateY(6px); opacity: 0; }
      to { transform: scale(1) translateY(0); opacity: 1; }
    }
    
    .user-popover .user-email {
      font-weight: 600;
      color: var(--ink);
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .user-popover .user-role {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 12px;
    }
    
    .user-popover .btn-signout {
      width: 100%;
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: transparent;
      color: var(--ink);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .user-popover .btn-signout:hover {
      background: #f8fafc;
      border-color: var(--muted);
    }
    </style>

    <!-- User avatar in bottom-left (exact copy of admin dashboard structure) -->
    <div class="user-avatar" id="user-avatar" title="User menu" aria-haspopup="true" aria-expanded="false">
      <span id="user-initials">U</span>
    </div>
    
    <!-- User popover -->
    <div class="user-popover" id="user-popover" role="dialog" aria-hidden="true">
      <div class="user-email" id="user-email">—</div>
      <div class="user-role" id="user-role">—</div>
      <button class="btn-signout" id="btn-signout">Sign out</button>
    </div>

    <script>
    // User avatar functionality — synced with admin dashboard
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const userAvatar = document.getElementById('user-avatar');
        const userPopover = document.getElementById('user-popover');
        const userInitials = document.getElementById('user-initials');
        const userEmailEl = document.getElementById('user-email'); // will show NAME here
        const userRoleEl = document.getElementById('user-role');
        const btnSignout = document.getElementById('btn-signout');

        const sb = window.supabase || (window.getSupabase && window.getSupabase());
        if (!sb) return;

        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
          sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
          window.location.replace('admin-login.html');
          return;
        }

        const user = session.user;

        // Load profile
        let profile = null;
        try {
          const { data } = await sb
            .from('master_users')
            .select('site_id, access_type, full_name, avatar_url')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          profile = data || null;
        } catch (e) { console.error('Profile fetch error:', e); }

        // Build display name exactly like admin dashboard
        let displayName = profile?.full_name ||
                          user?.user_metadata?.nickname ||
                          user?.user_metadata?.full_name ||
                          user?.user_metadata?.name ||
                          (user.email ? user.email.split('@')[0]
                            .replace(/[._-]/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase()) : 'User');

        // Set initials (first + last) like admin dashboard
        const baseName = displayName || user.email || 'User';
        const parts = baseName.trim().split(' ');
        const initials = parts.length >= 2
          ? (parts[0][0] + parts[parts.length - 1][0]).toUpperCase()
          : baseName.substring(0, 2).toUpperCase();
        if (userInitials) userInitials.textContent = initials;

        // Prefer stored avatar URL, fallback to user metadata
        try {
          let avatarUrl = profile?.avatar_url || user?.user_metadata?.avatar_url || null;
          if (!avatarUrl) {
            try {
              const { data: saw } = await sb
                .from('master_users')
                .select('avatar_url, updated_at')
                .eq('auth_user_id', user.id)
                .order('updated_at', { ascending: false })
                .limit(1)
                .maybeSingle();
              avatarUrl = saw?.avatar_url || avatarUrl;
            } catch (_) {}
          }
          if (avatarUrl) {
            let img = userAvatar.querySelector('img');
            if (!img) {
              img = document.createElement('img');
              img.alt = 'Avatar';
              img.style.width = '100%';
              img.style.height = '100%';
              img.style.borderRadius = '50%';
              img.style.objectFit = 'cover';
              userAvatar.appendChild(img);
            }
            img.src = avatarUrl;
            if (userInitials) userInitials.style.display = 'none';
          }
        } catch (e) { console.warn('Avatar render failed', e); }

        // Role text exactly like admin dashboard
        let detectedRole = String(profile?.access_type || user?.user_metadata?.role || '').toLowerCase();
        let roleText = (detectedRole === 'admin' || detectedRole === 'owner' ||
                        (user?.email && user.email.toLowerCase() === 'benhowardmagic@hotmail.com'))
                        ? 'Admin'
                        : (detectedRole ? detectedRole.charAt(0).toUpperCase() + detectedRole.slice(1) : 'Staff');

        // Site name (same fallback)
        let siteName = '';
        try {
          if (profile?.site_id) {
            const { data: site } = await sb
              .from('sites')
              .select('name')
              .eq('id', profile.site_id)
              .maybeSingle();
            siteName = site?.name || '';
          } else {
            siteName = 'Harley Street Medical Centre';
          }
        } catch (_) {}

        // Populate popover text — NAME on first line, then `Role  Site`
        if (userEmailEl) userEmailEl.textContent = displayName;
        if (userRoleEl) userRoleEl.textContent = siteName ? `${roleText}  ${siteName}` : roleText;

        // Toggle popover
        userAvatar.addEventListener('click', (e) => {
          e.stopPropagation();
          const isVisible = userPopover.style.display === 'block';
          document.querySelectorAll('.user-popover').forEach(p => { if (p !== userPopover) p.style.display = 'none'; });
          userPopover.style.display = isVisible ? 'none' : 'block';
          userAvatar.setAttribute('aria-expanded', !isVisible);
        });
        document.addEventListener('click', (e) => {
          if (!userAvatar.contains(e.target) && !userPopover.contains(e.target)) {
            userPopover.style.display = 'none';
            userAvatar.setAttribute('aria-expanded', false);
          }
        });

        // Sign out handler
        btnSignout.addEventListener('click', async () => {
          try { await sb.auth.signOut(); } catch(e) { console.error('Sign out failed', e); }
          window.location.replace('home.html');
        });

      } catch (err) {
        console.error('User avatar init error', err);
      }
    });
    </script>
        </div>
      </div>
    </main>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>CheckLoops — EMIS Appointment Data</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://*.supabase.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' https://*.supabase.co https://*.supabase.com wss://*.supabase.co wss://*.supabase.com https:;">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="config.js"></script>
<script src="rls-fix.js"></script>
<script src="supabase-js.js"></script>
<script type="module">
  const { createClient } = supabase;
  window.supabaseCreateClient = createClient;
  // Use EXACT same configuration as admin-login.html to share sessions
  const sb = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      flowType: 'pkce',
      storage: window.localStorage,
      storageKey: `sb-${CONFIG.SUPABASE_URL.split('//')[1].split('.')[0]}-auth-token`
    }
  });
  window.supabase = sb;

  // Add small delay to prevent race condition with session loading
  setTimeout(async () => {
    try {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        console.log('EMIS Checker: No session found, redirecting to login');
        sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
        window.location.replace('admin-login.html');
        return;
      }
      console.log('EMIS Checker: Session found for user:', session.user.email);
      const { data: profile } = await sb
        .from('master_users')
        .select('access_type')
        .eq('auth_user_id', session.user.id)
        .maybeSingle();
      const accessType = String(profile?.access_type || '').toLowerCase();
      const isAdmin = accessType === 'admin' || accessType === 'owner';
      console.log('EMIS Checker: Access type:', accessType, '=> isAdmin:', isAdmin);
      if (!isAdmin) {
        console.log('EMIS Checker: Not admin, redirecting to staff portal');
        window.location.replace('staff.html');
      }
    } catch (e) {
      console.log('EMIS Checker: Error checking session, redirecting to login:', e);
      window.location.replace('admin-login.html');
    }
  }, 1000); // Wait 1 second for session to fully load
  window.CONFIG = CONFIG;
  window.addEventListener('storage', (e) => {
    if (e.key && e.key.includes('sb-') && e.newValue === null) {
      try { window.location.replace('home.html'); } catch(_) {}
    }
  });
  window.addEventListener('load', async () => {
    try { await sb.auth.getSession(); } catch(_) {}
  });
  Object.defineProperty(window, 'getSupabase', { value: () => sb });
</script>
<style>
    /* Custom styles */
    .hidden {
        display: none;
    }
    
    /* Minimal app container */
    .app { 
      min-height: 100vh;
      position: relative;
    }
    
    /* Background effects */
    .bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -1;
      background: linear-gradient(140deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);
      overflow: hidden;
    }
    .wave {
      /* wave removed per request */
      display: none !important;
    }
    .wave2 {
      /* secondary wave disabled */
      display: none !important;
    }
    .bg-pattern {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232563eb' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.5;
    }
    /* wave animation removed */
    @keyframes wave { from { } to { } }
    .mesh {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -2;
      overflow: hidden;
    }
    .m1, .m2, .m3 {
      position: absolute;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.08;
    }
    .m1 {
      background: radial-gradient(circle, rgba(30,144,255,1) 0%, rgba(0,212,255,0) 70%);
      width: 50vw;
      height: 50vw;
      top: -10vw;
      left: -5vw;
    }
    .m2 {
      background: radial-gradient(circle, rgba(142,45,226,1) 0%, rgba(142,45,226,0) 70%);
      width: 40vw;
      height: 40vw;
      bottom: -5vw;
      right: -5vw;
    }
    .m3 {
      background: radial-gradient(circle, rgba(74,222,128,1) 0%, rgba(74,222,128,0) 70%);
      width: 30vw;
      height: 30vw;
      top: 35vh;
      right: 15vw;
    }
    .orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(50px);
      opacity: 0.06;
      z-index: -1;
    }
    .orb1 {
      background: #4ade80;
      width: 120px;
      height: 120px;
      top: 45%;
      left: 15%;
      animation: float 14s ease-in-out infinite;
    }
    .orb2 {
      background: #1e90ff;
      width: 80px;
      height: 80px;
      top: 35%;
      right: 15%;
      animation: float 16s ease-in-out infinite;
    }
    .orb3 {
      background: #8e2de2;
      width: 60px;
      height: 60px;
      bottom: 25%;
      right: 25%;
      animation: float 18s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(20px, 20px); }
    }
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -1;
      overflow: hidden;
    }
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      top: -10px;
      animation: fall 15s linear infinite;
    }
    @keyframes fall {
      0% { transform: translateY(0); opacity: 0; }
      10% { opacity: 0.8; }
      90% { opacity: 0.8; }
      100% { transform: translateY(105vh); opacity: 0; }
    }

    /* Header and upload button styling */
    .ops-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 120px; /* Increased header height for better spacing */
      background-color: #f8f9fa;
      padding: 10px;
    }

    /* Ensure the header title is visible */
    .ops-header .header-title {
      display: block;
      font-size: 24px;
      color: blue;
      margin-bottom: 10px;
    }

    /* Style the upload button to be smaller and centered */
    .ops-header .upload-button {
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
    }

    /* Upload button — clean + modern */
    .upload-button {
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 1000;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-height: 32px;
      min-width: 120px;
      padding: 6px 10px;
      background: linear-gradient(180deg,#2563eb,#1d4ed8);
      color: #fff;
      border: 1px solid rgba(15,23,42,.06);
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .01em;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(37,99,235,.16);
      transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
    }

    .upload-button i {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: transparent; /* remove square background */
      font-size: 16px;
      line-height: 1;
    }

    .icon-badge {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(180deg,#2563eb,#1d4ed8);
      display: inline-grid;
      place-items: center;
      color: #fff;
      flex: 0 0 20px;
    }
    .icon-badge i { font-size: 16px; line-height: 1; }

    .upload-button:hover { transform: translateY(-1px); box-shadow: 0 14px 30px rgba(37,99,235,.28); }

    .upload-button.uploading {
      background: linear-gradient(180deg,#64748b,#475569);
      opacity: .98;
      box-shadow: 0 8px 22px rgba(2,6,23,.2);
      cursor: default;
      pointer-events: none;
    }

    /* Inline upload button for placement inside cards (overrides fixed, uses local styling) */
    .upload-inline {
      position: static !important;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 36px;
      padding: 8px 12px;
      background: linear-gradient(180deg,#2563eb,#1d4ed8);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: .01em;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(37,99,235,.16);
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .upload-button.uploading::after {
      content:"";
      width:14px; height:14px;
      margin-left: 6px;
      border-radius:50%;
      border:2px solid rgba(255,255,255,.55);
      border-top-color:#fff;
      animation: spin .8s linear infinite;
    }

    @keyframes spin {to{transform: rotate(1turn);}}

    /* Progress overlay — tidy card (originally fixed). Inline variant below used inside cards */
    .progress-overlay {
      position: fixed;
      top: 64px;
      right: 16px;
      width: 300px;
      background: rgba(255,255,255,0.98);
      border: 1px solid rgba(15,23,42,.08);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 12px 30px rgba(2,6,23,.16);
      z-index: 999;
      display: none;
      backdrop-filter: blur(6px);
    }

    .progress-overlay.show { display:block; animation: slideIn .22s ease; }

    .progress-overlay .progress {
      height: 8px;
      border-radius: 999px;
      background: #eaf0f7;
      overflow: hidden;
      margin: 0;
    }

    .progress-overlay .progress .neat-progress {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg,#93c5fd,#1d4ed8);
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.08);
      transition: width .2s ease;
      font-size: 0; /* hide text for a cleaner small bar */
      color: transparent;
      text-align: left;
    }

    .progress-label {
      margin-top: 8px;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
      color: #0b1220;
    }

    /* Inline progress card for use inside the main upload card */
    .progress-inline {
      position: static !important;
      width: 100%;
      margin-top: 16px;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(15,23,42,.04);
      border-radius: 8px;
      padding: 14px;
      box-shadow: 0 4px 12px rgba(2,6,23,.04);
      display: none;
    }
    .progress-inline.show { display:block; }
    .progress-inline .progress { height: 6px; margin-bottom: 10px; }
    .progress-inline .progress .neat-progress { transition: width .2s ease; }
    .progress-inline .progress-label { text-align:left; font-weight:600; color:#0f172a; font-size: 13px; }

    /* --- Operations Portal UI polish --- */
    .nav-pill { padding:8px 14px;border-radius:999px;border:1px solid rgba(15,23,42,.08);background:#fff;font-weight:600;font-size:13px;letter-spacing:.01em;cursor:pointer;transition:all .18s ease; }
    .nav-pill:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(2,6,23,.08);} 
    .nav-pill.active{ background:linear-gradient(180deg,#2563eb,#1d4ed8); color:#fff; border-color:transparent; box-shadow:0 10px 22px rgba(37,99,235,.22);} 

  /* Layout: make the views container fill the available vertical space and allow the active view to expand */
  main#views { display: flex; flex-direction: column; min-height: calc(100vh - 80px); position: relative; margin-top: 8px; }
  .view{ display:none; flex: 0 0 auto; }
  .view.on{ display:flex; flex-direction:column; flex:1 1 auto; padding-bottom: 60px; /* reserve space for CTA */ height: calc(100vh - 80px); }

  /* Make the card fill the view so the white content box is full-height */
  .view.on .card { display:flex; flex-direction:column; flex:1 1 auto; }
  .view.on .card .card-bd { flex:1 1 auto; overflow:auto; }
  /* Anchor CTA row to the bottom of the main views area */
  .view.on .cta-row { position: fixed; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 1180px; bottom: 16px; display:flex; justify-content:space-between; align-items:center; gap:10px; background: transparent; padding: 0; margin: 0; }
  /* Remove extra card bottom margin so card fills to CTA reserve */
  .view.on .card { margin-bottom: 0; }

  /* Stretch the wizard steps container so the active step's card can consume remaining height */
  .view.on .wsteps { flex: 1 1 auto; display: flex; flex-direction: column; min-height: 0; margin-bottom: 60px; }
  .view.on .wsteps .wstep { display: none; }
  .view.on .wsteps .wstep.on { display: flex; flex-direction: column; flex: 1 1 auto; min-height: 0; }
  .view.on .wsteps .wstep.on .card { flex: 1 1 auto; display: flex; flex-direction: column; min-height: calc(100vh - 220px); }
  .view.on .wsteps .wstep.on .card .card-bd { flex: 1 1 auto; overflow: auto; padding-bottom: 20px; }

  /* Hide the internal card headers (the small 'Welcome' / 'Upload -> Set-up' headings inside the white box) */
  .view.on .card .card-hd { display: none; }
  .view.on .card .card-bd { padding-top: 18px; }

    .card{ 
      background:rgba(255,255,255,.99); 
      border:1px solid rgba(15,23,42,.06); 
      border-radius:10px; 
      box-shadow:
        0 1px 2px rgba(0,0,0,0.02),
        0 4px 12px rgba(0,0,0,0.05),
        0 12px 30px rgba(0,0,0,0.03);
      overflow:hidden;
    }
    .card-hd{ 
      padding:10px 14px; 
      font-weight:600; 
      color:#0f172a; 
      border-bottom:1px solid rgba(15,23,42,.06); 
      background:linear-gradient(180deg,#ffffff,#f9fafb);
    }
    .card-bd{ padding:16px 20px; }

    .btn-primary{ 
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-height: 38px;
      padding: 9px 16px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(180deg,#2563eb,#1d4ed8);
      color: #fff;
      font-weight: 600;
      letter-spacing: .01em;
      cursor: pointer;
      box-shadow: 
        0 4px 12px rgba(37,99,235,.18),
        0 1px 3px rgba(37,99,235,.08),
        inset 0 1px 0 rgba(255,255,255,0.12);
      transition: all .2s ease;
    }
    .btn-primary:hover{ 
      transform: translateY(-2px); 
      box-shadow: 
        0 8px 20px rgba(37,99,235,.24),
        0 2px 5px rgba(37,99,235,.12),
        inset 0 1px 0 rgba(255,255,255,0.15);
    }

    .form-row{ display:flex; flex-direction:column; gap:5px; margin-bottom:10px; }
    .form-row input, .form-row select{ border:1px solid #e2e8f0;border-radius:8px;padding:9px 12px;outline:none;font-size:14px; }
    .form-row input:focus, .form-row select:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,.2); }

    .muted{ color:#64748b; }
    .status-line{ margin-top:6px; font-size:13px; color:#0f172a; }

    .stat{ background:linear-gradient(180deg,#ffffff,#f8fafc); border:1px solid #e7edf6; border-radius:10px; padding:14px; box-shadow:0 6px 18px rgba(2,6,23,.06); }
    .stat-k{ font-weight:700; font-size:24px; color:#0f172a; }
    .stat-l{ color:#64748b; font-size:12px; margin-top:3px; }

    .table-like{ display:grid; gap:6px; }
    .table-like .row{ display:grid; grid-template-columns:2fr 1fr 1fr 1fr; gap:8px; padding:8px 6px; border-bottom:1px solid #eef2f7; }
    .table-like .row.h{ font-weight:700; color:#0f172a; }
    .table-like .row.p{ color:#64748b; }
    
    /* Enhanced Progress UI */
    .progress-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        margin: 20px 0;
        overflow: hidden;
    }
    
    .progress-container.uploading {
        border-color: #93c5fd;
        box-shadow: 0 10px 25px rgba(59,130,246,0.1);
    }
    
    .progress-container.success {
        border-color: #86efac;
        box-shadow: 0 10px 25px rgba(34,197,94,0.1);
    }
    
    .progress-container.error {
        border-color: #fca5a5;
        box-shadow: 0 10px 25px rgba(239,68,68,0.1);
    }
    
    .progress-bar-container {
        height: 8px;
        background: #f1f5f9;
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
        position: relative;
    }
    
    .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 4px;
        transition: width 0.5s ease;
        position: relative;
    }
    .progress-bar::after{
      content:"";
      position:absolute;
      inset:0 auto 0 0;
      width:40%;
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.35), rgba(255,255,255,0));
      transform: translateX(-100%);
      animation: barShimmer 2s linear infinite;
      pointer-events:none;
    }
    @keyframes barShimmer { to { transform: translateX(250%); } }
    .progress-pips{ display:flex; justify-content:space-between; gap:10px; margin:8px 0 6px; padding:0 2px; }
    .progress-pips .pip{ width:8px; height:8px; border-radius:50%; background:#e5e7eb; box-shadow: inset 0 0 0 2px #fff; transition: transform .18s ease, background .18s ease, box-shadow .18s ease; }
    .progress-pips .pip.on{ background: linear-gradient(180deg,#60a5fa,#2563eb); box-shadow: 0 0 0 6px rgba(37,99,235,.12); transform: scale(1.1); }
    .progress-status{ display:flex; align-items:center; justify-content:space-between; font-weight:600; margin:2px 0 10px; color:#0b1220; }
    .progress-status #status-percent{ font-variant-numeric: tabular-nums; opacity:.9; }
    
    .upload-stats-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #f1f5f9;
    }
    
    .stat-card {
        text-align: center;
        padding: 10px;
        border-radius: 8px;
        background: #f8fafc;
    }
    
    .stat-value {
        font-size: 18px;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 12px;
        color: #64748b;
    }
    
    /* Success Module */
    .success-module {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 25px;
        text-align: center;
    }
    
    .success-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #22c55e;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        margin-bottom: 16px;
        animation: success-pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes success-pulse {
        0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.6); }
        70% { box-shadow: 0 0 0 15px rgba(34,197,94,0); }
        100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }
    
    .success-message {
        max-width: 450px;
    }
    
    .success-title {
        font-size: 22px;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 8px;
    }
    
    .success-stats {
        color: #64748b;
        margin-bottom: 16px;
    }
    
    .success-action {
        font-size: 14px;
        color: #334155;
        background: #f1f5f9;
        padding: 12px 16px;
        border-radius: 8px;
        margin-top: 10px;
    }
    
    .success-tip {
        font-size: 13px;
        color: #475569;
        background: #f0f7ff;
        border: 1px solid #e0ebfa;
        padding: 10px 14px;
        border-radius: 6px;
        margin-top: 15px;
        max-width: 450px;
    }
    
    /* Error Module */
    .error-module {
        text-align: center;
        padding: 20px;
    }
    
    .error-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #ef4444;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin: 0 auto 16px;
    }
    
    .error-message {
        color: #ef4444;
        font-weight: 700;
        margin-bottom: 8px;
    }
    
    .error-details {
        font-size: 14px;
        color: #64748b;
        margin-bottom: 16px;
        max-width: 450px;
        margin-left: auto;
        margin-right: auto;
    }
    
    /* Processing animation */
    .processing-icon{ display:none !important; width:0; height:0; border:none; animation:none; }
</style>
<style>
    /* --- Welcome flow styling --- */
    .welcome-hero { text-align:center; margin-bottom: 16px; }
    .welcome-hero h1 { font-family: 'Urbanist', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-size: clamp(22px, 3vw, 32px); font-weight: 800; letter-spacing: .2px; color:#0f172a; }
    .welcome-hero .lead { color:#475569; margin: 6px auto 8px; max-width: 700px; }
    .cta-row { display:flex; gap:8px; justify-content:center; margin-top: 6px; }
    .btn-primary.big { 
      padding: 12px 20px; 
      font-size: 15px; 
      border-radius: 10px; 
      font-weight: 700;
      box-shadow: 
        0 6px 16px rgba(37,99,235,.22),
        0 2px 4px rgba(37,99,235,.12),
        inset 0 1px 0 rgba(255,255,255,0.12);
    }
    .btn-ghost { display:inline-flex;align-items:center;gap:6px;min-height:36px;padding:8px 14px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;color:#0f172a;font-weight:600;letter-spacing:.01em;cursor:pointer;transition:transform .15s ease, box-shadow .15s ease; }
    .btn-ghost:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(2,6,23,.06);} 

    .stepper { position:relative; display:grid; grid-template-columns:1fr 10px 1fr 10px 1fr 10px 1fr 10px 1fr; gap:6px; align-items:stretch; margin: 10px 0 12px; }
    .stepper .pipe { width:10px; display:grid; place-items:center; }
    .stepper .pipe::before { display: none; /* Remove vertical blue separator lines */ }
    .stepper .step { 
      background: rgba(255,255,255,.99); 
      border: 1px solid rgba(15,23,42,.06); 
      border-radius: 10px; 
      box-shadow: 
        0 4px 8px rgba(0,0,0,0.03),
        0 8px 16px rgba(0,0,0,0.03),
        0 0 0 1px rgba(0,0,0,0.01);
      padding: 9px 12px; 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      transform: translateY(0); 
      transition: all .18s ease; 
    }
    .stepper .step:hover { 
      transform: translateY(-2px); 
      box-shadow: 
        0 8px 20px rgba(0,0,0,0.05),
        0 14px 26px rgba(0,0,0,0.03),
        0 0 0 1px rgba(0,0,0,0.01);
    }
    .stepper .step .num { 
      flex: 0 0 32px; 
      height: 32px; 
      width: 32px; 
      border-radius: 50%; 
      display: grid; 
      place-items: center; 
      font-weight: 700; 
      color: #fff; 
      background: linear-gradient(180deg,#2563eb,#1d4ed8); 
      box-shadow: 
        0 4px 10px rgba(37,99,235,.2),
        0 1px 3px rgba(37,99,235,.1),
        inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .stepper .step .copy .t { font-weight: 600; color: #0f172a; font-size: 14px; }
    .stepper .step .copy .d { color: #64748b; font-size: 12px; margin: 3px 0 0; }
    .setup-card { border:1px dashed #dbe4f3; border-radius:12px; padding:12px; background: linear-gradient(180deg,#ffffff,#f8fafc); }
    .saved-tick { margin-left: 10px; font-weight:700; color:#16a34a; }

    .protip { margin-top: 6px; text-align:center; color:#64748b; font-size: 13px; }
    .sparkle { margin-right: 6px; filter: drop-shadow(0 2px 6px rgba(37,99,235,.2)); }

    /* Fun micro-animations */
    .fx-pop { animation: fxPop .28s cubic-bezier(.2,.9,.2,1); }
    @keyframes fxPop { from { transform: scale(.96); opacity:.0 } to { transform: scale(1); opacity:1 } }

    /* Confetti canvas */
    .confetti { position: fixed; inset: 0; pointer-events: none; z-index: 1000; }

    /* Step states */
    .stepper .step.done .num { 
      background: linear-gradient(180deg,#16a34a,#15803d); 
      box-shadow: 
        0 4px 12px rgba(22,163,74,.2),
        0 1px 4px rgba(22,163,74,.1),
        inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .stepper .step.active { 
      border-color: rgba(37,99,235,.2);
      outline: 2px solid rgba(37,99,235,.25); 
      box-shadow: 
        0 4px 16px rgba(37,99,235,.08),
        0 8px 24px rgba(0,0,0,0.04),
        0 0 0 2px rgba(37,99,235,.06);
    }

    /* Internal welcome wizard pages */
    .wsteps { margin-top: 8px; }
    .wstep { display:none; }
    .wstep.on { display:block; animation: fxPop .24s cubic-bezier(.2,.9,.2,1); }
    #welcome-back[disabled] { opacity:.5; pointer-events:none; }

    /* Simplified wizard progress bar */
    .wizard-progress{ margin:4px 0 16px; }
    .wizard-progress .rail{ 
      height: 6px; 
      border-radius: 999px; 
      background: #eef2f7; 
      overflow: hidden; 
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }
    .wizard-progress .fill{ 
      height: 100%; 
      background: linear-gradient(90deg, #60a5fa, #2563eb); 
      transition: width .3s ease;
      box-shadow: 0 1px 2px rgba(37,99,235,.16);
    }
    .wizard-progress .labels{ 
      display: flex; 
      justify-content: space-between; 
      font-size: 11px; 
      color: #64748b; 
      margin-top: 6px;
    }
    .wizard-progress .labels .active{ 
      color: #0f172a; 
      font-weight: 600; 
    }

    /* Make stepper non-interactive (visual only) */
    .stepper .step{ pointer-events:none; }
    
    /* EMIS Search step styling */
    .setup-steps { display: flex; flex-direction: column; gap: 26px; }
    .step-container { 
      padding: 0; 
      position: relative;
    }
    .step-title { 
      display: flex; 
      align-items: center; 
      font-size: 16px; 
      font-weight: 600; 
      margin-bottom: 10px; 
      gap: 8px; 
      color: #0f172a;
    }
    .step-number { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      width: 24px; 
      height: 24px; 
      background: linear-gradient(180deg,#2563eb,#1d4ed8); 
      color: white; 
      border-radius: 50%; 
      font-size: 14px; 
      font-weight: 600; 
      flex-shrink: 0; 
      box-shadow: 0 2px 6px rgba(37,99,235,.16);
    }
    .step-image { 
      margin-top: 12px; 
      text-align: center;
      position: relative;
      transition: transform 0.2s ease;
      border-radius: 10px;
      overflow: hidden;
    }
    .step-image img { 
      max-height: 360px; 
      object-fit: contain;
      border: 1px solid rgba(15,23,42,0.06);
      border-radius: 8px;
      box-shadow: 
        0 1px 2px rgba(0,0,0,0.02),
        0 3px 10px rgba(0,0,0,0.04),
        0 6px 16px rgba(0,0,0,0.03);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .step-image img:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 4px 12px rgba(0,0,0,0.05),
        0 12px 24px rgba(0,0,0,0.06);
    }
</style>
</head>
<body>
  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
    <div class="bg-pattern"></div>
  </div>
  <div class="mesh" aria-hidden="true"><div class="m1"></div><div class="m2"></div><div class="m3"></div></div>
  
  <!-- Floating orbs for extra depth -->
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <div class="orb orb3"></div>
  
  <!-- Particle system -->
  <div class="particles" aria-hidden="true">
    <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
    <div class="particle" style="left: 20%; animation-delay: 2s;"></div>
    <div class="particle" style="left: 30%; animation-delay: 4s;"></div>
    <div class="particle" style="left: 40%; animation-delay: 6s;"></div>
    <div class="particle" style="left: 50%; animation-delay: 8s;"></div>
    <div class="particle" style="left: 60%; animation-delay: 10s;"></div>
    <div class="particle" style="left: 70%; animation-delay: 12s;"></div>
    <div class="particle" style="left: 80%; animation-delay: 14s;"></div>
    <div class="particle" style="left: 90%; animation-delay: 16s;"></div>
  </div>

  <div class="app" id="app" aria-live="polite">
    <!-- App Header + Navigation -->
    <header class="app-hero" style="position:sticky;top:0;z-index:110;background:rgba(255,255,255,0.92);backdrop-filter: blur(10px);border-bottom:1px solid rgba(15,23,42,.08);">
      <div class="container-xl" style="max-width:1280px;margin:0 auto;padding:10px 18px;display:flex;align-items:center;gap:12px;">
        <div class="brand" style="display:flex;align-items:center;gap:8px;">
          <img src="logo.png" alt="CheckLoops logo" style="width:38px;height:38px;border-radius:6px;object-fit:contain;" />
          <div>
            <div style="font-weight:700;color:#0f172a;font-size:17px;">CheckLoops</div>
            <div style="font-size:11px;color:#64748b;margin-top:-2px;">EMIS Operations Portal</div>
          </div>
        </div>
        <nav class="app-nav" style="margin-left:auto;">
          <!-- Top navigation removed (clean header) -->
        </nav>
      </div>
    </header>

    <!-- Views container -->
  <main id="views" class="container-xl" style="max-width:1180px;margin:8px auto 0;padding:0 14px 0;">
      <!-- Top progress labels removed for simplified stepper UI -->
      <div id="wizard-progress" class="wizard-progress" aria-hidden="false">
        <div class="rail"><div class="fill" style="width:0%"></div></div>
      </div>
      <!-- WELCOME VIEW -->
      <section id="view-welcome" class="view on" aria-label="Welcome">
          <!-- Welcome hero moved into the first wizard card (see wstep[data-wstep="1"]) -->

        <!-- Step indicator (5 steps) -->
        <div class="stepper" style="grid-template-columns:1fr 12px 1fr 12px 1fr 12px 1fr 12px 1fr;">
          <div class="step active" data-step="1"><div class="num">1</div><div class="copy"><div class="t">Welcome</div></div></div>
          <div class="pipe"></div>
          <div class="step" data-step="2"><div class="num">2</div><div class="copy"><div class="t">Import Template</div></div></div>
          <div class="pipe"></div>
          <div class="step" data-step="3"><div class="num">3</div><div class="copy"><div class="t">Export & Upload</div></div></div>
          <div class="pipe"></div>
          <div class="step" data-step="4"><div class="num">4</div><div class="copy"><div class="t">Setup</div></div></div>
          <div class="pipe"></div>
          <div class="step" data-step="5"><div class="num">5</div><div class="copy"><div class="t">Done</div></div></div>
        </div>

        <!-- Wizard pages (internal to Welcome) -->
        <div class="wsteps">
          <div class="wstep on" data-wstep="1">
            <div class="card"><div class="card-hd">Welcome</div><div class="card-bd">
              <!-- Welcome content removed per request -->
            </div></div>
          </div>
          <div class="wstep" data-wstep="2">
            <div class="card"><div class="card-hd">Import Template</div><div class="card-bd">
              <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Set Up EMIS Search Template</h3>
              
              <p>The CheckLoops Operations Portal requires a pre-configured search in EMIS. This is a <strong>one-time setup</strong> that you'll only need to do once. First download the template, then follow these steps to import it into EMIS.</p>
              
              <div class="download-container" style="margin: 24px 0 28px; padding: 16px; background: rgba(219,234,254,.4); border: 1px dashed rgba(37,99,235,.25); border-radius: 10px; text-align: center;">
                <p style="margin: 0 0 12px; font-weight: 500; color: #1e40af;"><i class="bi bi-arrow-down-circle" style="margin-right: 6px;"></i> First, download the search template:</p>
                <a id="download-template" href="CheckLoops Appointment Checker.xml" download class="btn-primary big" style="padding: 12px 20px; border-radius: 8px; background: linear-gradient(180deg,#2563eb,#1d4ed8); box-shadow: 0 4px 12px rgba(37,99,235,.2), 0 1px 3px rgba(37,99,235,.08); transition: all 0.2s ease; border: none;">
                  <i class="bi bi-download" style="margin-right: 8px;"></i>
                  Download CheckLoops Appointment Checker.xml
                </a>
              </div>
              
              <div class="setup-steps" style="margin-top: 24px;">
                <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 16px; padding-bottom: 8px; border-bottom: 1px solid rgba(15,23,42,.08);">Importing Search Template</h3>
                
                <div class="step-container">
                  <h4 class="step-title"><span class="step-number">1</span> Import Search Button</h4>
                  <p>In EMIS, navigate to Appointment Reporting, then click the Import button.</p>
                  <div class="step-image">
                    <img src="1 EMIS IMPORT SEARCH.jpeg" alt="Navigate to Import Search" style="max-width: 100%;">
                  </div>
                </div>
                
                <div class="step-container">
                  <h4 class="step-title"><span class="step-number">2</span> Select the Template File</h4>
                  <p>Click Browse and select the "CheckLoops Appointment Checker.xml" file you downloaded.</p>
                  <div class="step-image">
                    <img src="2 EMIS SELECT IMPORT FILE.jpeg" alt="Select XML template file" style="max-width: 100%;">
                  </div>
                </div>
                
                <div class="step-container">
                  <h4 class="step-title"><span class="step-number">3</span> Complete the Import</h4>
                  <p>Click Continue to complete adding the search to your EMIS system.</p>
                  <div class="step-image">
                    <img src="3 EMIS IMPORT CLICK CONTINUE.jpeg" alt="Click continue to complete import" style="max-width: 100%;">
                  </div>
                </div>
              </div>
              
              <div class="summary-box" style="margin-top: 32px; padding: 18px 20px; border: 1px solid rgba(37,99,235,.12); border-radius: 10px; background: linear-gradient(180deg,#f8fafc,#f0f7ff); box-shadow: 0 2px 8px rgba(37,99,235,.08), inset 0 1px 0 rgba(255,255,255,0.9);">
                <h4 style="font-weight: 600; margin-bottom: 10px; color: #1e40af;">Important Reminder</h4>
                <p style="margin: 0 0 12px; color: #334155;"><strong>One-time setup:</strong> You only need to import the search template once. After the initial setup, you can skip directly to running the search when you need updated data.</p>
                
                <h4 style="font-weight: 600; margin: 12px 0 8px; color: #1e40af;">Next Steps</h4>
                <p style="margin: 0 0 6px; color: #334155;">Continue to the Upload step to learn how to:</p>
                <ol style="margin: 0 0 0 20px; padding: 0; color: #334155;">
                  <li style="margin-bottom: 5px;">Run the search in EMIS</li>
                  <li style="margin-bottom: 5px;">Export the results as a CSV file</li>
                  <li>Upload the data to the CheckLoops system</li>
                </ol>
              </div>
            </div></div>
          </div>
          <div class="wstep" data-wstep="3">
            <div class="card"><div class="card-hd">Export & Upload</div><div class="card-bd">
              <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Export & Upload EMIS Data</h3>
              
              <p>Now that you've imported the search template, follow these steps to run the search, export the results, and upload them to CheckLoops.</p>
              
              <div class="setup-steps" style="margin-top: 24px;">
                <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 16px; padding-bottom: 8px; border-bottom: 1px solid rgba(15,23,42,.08);">Running and Exporting Results</h3>
                
                <div class="step-container">
                  <h4 class="step-title"><span class="step-number">4</span> Run Search and View Results</h4>
                  <p>Find and run the imported "CheckLoops Appointment Checker" search, then click View Results.</p>
                  <div class="step-image">
                    <img src="4 EMIS EXPORT RUN THEN CLICK VIEW RESULTS.jpeg" alt="Run search and view results" style="max-width: 100%;">
                  </div>
                </div>
                
                <div class="step-container">
                  <h4 class="step-title"><span class="step-number">5</span> Click Export Button</h4>
                  <p>With the search results displayed, click the Export button.</p>
                  <div class="step-image">
                    <img src="5 EMIS EXPORT CLICK EXPORT.jpeg" alt="Click export button" style="max-width: 100%;">
                  </div>
                </div>
                
                <div class="step-container">
                  <h4 class="step-title"><span class="step-number">6</span> Export as CSV with Exclude Headers</h4>
                  <p><strong>Important:</strong> Select CSV format and check the "Exclude headers" option when exporting.</p>
                  <div class="step-image">
                    <img src="6 EMIS EXPORTCLICK CSV AND EXCLUDE.jpeg" alt="Select CSV format and exclude headers" style="max-width: 100%;">
                  </div>
                </div>
              </div>
              
              <div class="summary-box" style="margin: 32px 0; padding: 18px 20px; border: 1px solid rgba(37,99,235,.12); border-radius: 10px; background: linear-gradient(180deg,#f8fafc,#f0f7ff); box-shadow: 0 2px 8px rgba(37,99,235,.08), inset 0 1px 0 rgba(255,255,255,0.9);">
                <h4 style="font-weight: 600; margin-bottom: 10px; color: #1e40af;">Important Reminder</h4>
                <p style="margin-bottom: 0; color: #334155;"><strong>CSV Export Settings:</strong> Always remember to select the "Exclude headers" option when exporting from EMIS. This ensures the data can be correctly processed by the CheckLoops system.</p>
              </div>
              
              <h3 style="font-size: 16px; font-weight: 600; margin: 24px 0 16px; padding-bottom: 8px; border-bottom: 1px solid rgba(15,23,42,.08);">Upload Your Exported CSV</h3>
              
              <p>After exporting your CSV file from EMIS, use the button below to upload it to the CheckLoops system.</p>
              
              <div class="upload-container" style="margin-top: 20px; padding: 20px; background: rgba(246,248,252,.8); border: 1px solid rgba(15,23,42,.08); border-radius: 10px; text-align: center;">
                <button id="upload-button" class="upload-inline btn-primary big" type="button"><span>Upload EMIS CSV File</span></button>
                <div class="muted" style="font-size: 13px; margin-top: 8px;">Accepts CSV files exported from EMIS</div>
              </div>
              <input type="file" id="file-input" accept=".csv" style="display:none;" />
              
              <!-- Enhanced progress interface -->
              <div class="progress-interface" id="progress-overlay">
                <!-- Progress Container - Our new enhanced UI -->
                <div class="progress-container" id="progress-container">
                    <h4 id="upload-title">Processing EMIS Data</h4>
                    
                    <!-- Progress bar with percentage -->
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    
                    <!-- Compact status & pips -->
                    <div class="progress-pips" id="progress-pips" aria-hidden="true">
                      <span class="pip" data-threshold="0"></span>
                      <span class="pip" data-threshold="25"></span>
                      <span class="pip" data-threshold="50"></span>
                      <span class="pip" data-threshold="75"></span>
                      <span class="pip" data-threshold="100"></span>
                    </div>
                    <div class="progress-status">
                      <span id="status-message">Preparing to upload…</span>
                      <span id="status-percent">0%</span>
                    </div>
                    
                    <!-- Stats panel -->
                    <div class="upload-stats-panel" id="upload-stats-panel">
                        <div class="stat-card">
                            <div class="stat-value" id="records-processed">0</div>
                            <div class="stat-label">Records Processed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="records-total">0</div>
                            <div class="stat-label">Total Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="upload-progress">0%</div>
                            <div class="stat-label">Progress</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="upload-time">0s</div>
                            <div class="stat-label">Elapsed Time</div>
                        </div>
                    </div>
                </div>
                
                <!-- Success module - shown on successful completion -->
                <div id="success-container" style="display:none;">
                    <div class="success-module">
                        <div class="success-icon">✓</div>
                        <div class="success-message">
                            <div class="success-title">Upload Complete!</div>
                            <div class="success-stats" id="success-stats">
                                Successfully processed 0 records in 0 seconds.
                            </div>
                            <div class="success-action">To view your uploaded information, click the "Options" dropdown menu in the top right corner and select "Dashboard".</div>
                            <div class="success-tip">
                                <i class="bi bi-info-circle-fill" style="margin-right: 6px; color: #3b82f6;"></i>
                                <strong>For recurring imports:</strong> Simply run the EMIS search again and export to refresh your data.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Error module - shown when errors occur -->
                <div id="error-container" style="display:none;">
                    <div class="error-module">
                        <div class="error-icon">!</div>
                        <div class="error-message" id="error-title">Upload Failed</div>
                        <div class="error-details" id="error-details">
                            An error occurred during the upload process.
                        </div>
                    </div>
                </div>
              </div>
            </div></div>
          </div>
          <div class="wstep" data-wstep="4">
            <div class="card">
              <div class="card-hd">Set-up (part 2)</div>
              <div class="card-bd">
                <!-- Intentionally left blank (UI removed). Background slot-type logic remains active. -->
              </div>
            </div>
          </div>
          <div class="wstep" data-wstep="5">
            <div class="card">
              <div class="card-hd">Setup Complete</div>
              <div class="card-bd" id="step5-content">
                <div style="text-align:center;padding:40px 20px;">
                  <div style="font-size:64px;margin-bottom:20px;">✅</div>
                  <h2 style="color:#0f172a;margin-bottom:12px;">Setup Complete!</h2>
                  <p style="color:#64748b;margin-bottom:30px;">Your slot type mappings have been saved successfully.</p>
                  <div id="step5-summary" style="background:#f8fafc;border-radius:8px;padding:20px;margin-bottom:20px;text-align:left;">
                    <p style="color:#64748b;margin:0;">Loading confirmation...</p>
                  </div>
                  <button class="btn-primary" onclick="window.location.reload()">Configure Another Site</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Wizard controls -->
          <div class="cta-row" style="justify-content:space-between;">
          <button class="btn-ghost" id="welcome-back" aria-label="Previous step">Back</button>
          <div style="display:flex;gap:8px;">
            <button class="btn-primary" id="welcome-next" aria-label="Next step">Next</button>
          </div>
        </div>

        <canvas id="confetti" class="confetti" aria-hidden="true"></canvas>
      </section>


      <!-- DASHBOARD VIEW -->
      <section id="view-dashboard" class="view">
        <div class="grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;">
          <div class="stat">
            <div class="stat-k">—</div>
            <div class="stat-l">Rows uploaded</div>
          </div>
          <div class="stat">
            <div class="stat-k">—</div>
            <div class="stat-l">Last upload</div>
          </div>
          <div class="stat">
            <div class="stat-k">—</div>
            <div class="stat-l">DNA rate</div>
          </div>
        </div>
        <div class="card" style="margin-top:14px;">
          <div class="card-hd">Recent uploads</div>
          <div class="card-bd">
            <div id="recent-uploads" class="table-like">
              <div class="row h">
                <div>File</div><div>Rows</div><div>When</div><div>Status</div>
              </div>
              <div class="row p">
                <div>—</div><div>—</div><div>—</div><div>—</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    
    <!-- Progress overlay (moved into Step 2 card as inline `progress-inline`) -->
    <!-- The element keeps id="progress-overlay" so existing JS can toggle .show and update #progress-bar and #status-message -->
    
    <!-- AI Debug Panel -->
    <div id="ai-debug-panel" style="position:fixed; bottom:20px; right:20px; background-color:#ffffff; border:1px solid #e2e8f0; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:15px; z-index:1000; max-width:400px; display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h4 style="margin:0; font-size:16px; font-weight:600;">AI Debug Controls</h4>
        <button id="close-debug-panel" style="background:none; border:none; cursor:pointer; color:#64748b; font-size:18px;">×</button>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <button id="ai-test-btn" style="background-color:#3b82f6; color:white; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; font-size:14px;">Test AI connectivity</button>
        <button id="ai-req-btn" style="background-color:#4ade80; color:white; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; font-size:14px;">Show Last Request</button>
        <button id="ai-res-btn" style="background-color:#f59e0b; color:white; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; font-size:14px;">Show Last Response</button>
        <button id="ai-retry-btn" style="background-color:#ef4444; color:white; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; font-size:14px;">Retry Classification</button>
      </div>
      <div id="ai-status" style="margin-top:10px; padding:8px; background-color:#f8fafc; border-radius:4px; font-size:13px; color:#334155;">Status: Ready</div>
      <div style="margin-top:10px; text-align:right;">
        <a href="#" id="toggle-debug-panel" style="font-size:12px; color:#3b82f6; text-decoration:none;">Toggle Debug Panel</a>
      </div>
    </div>
    

    <!-- Add scripts here -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Debug Panel Controls -->
    <script>
      // Initialize debug panel on document load
      document.addEventListener('DOMContentLoaded', function() {
        // Show debug panel with Alt+D keyboard shortcut
        document.addEventListener('keydown', function(e) {
          if (e.altKey && e.key === 'd') {
            toggleDebugPanel();
          }
        });
        
        // Toggle debug panel visibility
        function toggleDebugPanel() {
          const panel = document.getElementById('ai-debug-panel');
          if (panel) {
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
          }
        }
        
        // Set up event listeners for debug panel buttons
        document.getElementById('close-debug-panel')?.addEventListener('click', function() {
          document.getElementById('ai-debug-panel').style.display = 'none';
        });
        
        document.getElementById('toggle-debug-panel')?.addEventListener('click', function(e) {
          e.preventDefault();
          toggleDebugPanel();
        });
        
        document.getElementById('ai-test-btn')?.addEventListener('click', async function() {
          try {
            updateAiStatus('Testing AI connectivity...');
            const result = await window.aiConnectivityTest();
            updateAiStatus(`Test result: ${result.ok ? 'SUCCESS' : 'FAILED'} - ${result.detail || ''}`);
            console.log('AI connectivity test result:', result);
          } catch (err) {
            updateAiStatus(`Test error: ${err.message || String(err)}`);
            console.error('AI test error:', err);
          }
        });
        
        document.getElementById('ai-req-btn')?.addEventListener('click', function() {
          try {
            const req = window.aiRequest();
            updateAiStatus('Request data shown in console');
            alert('Last request data logged to console');
          } catch (err) {
            updateAiStatus(`Error showing request: ${err.message}`);
            console.error('Error showing request:', err);
          }
        });
        
        document.getElementById('ai-res-btn')?.addEventListener('click', function() {
          try {
            const res = window.aiResponse();
            updateAiStatus('Response data shown in console');
            alert('Last response data logged to console');
          } catch (err) {
            updateAiStatus(`Error showing response: ${err.message}`);
            console.error('Error showing response:', err);
          }
        });
        
        document.getElementById('ai-retry-btn')?.addEventListener('click', async function() {
          try {
            updateAiStatus('Resetting cache and reclassifying...');
            // Clear classification cache
            window.slotTypeClassification = null;
            window.__classificationPromise = null;
            
            // Request new classification
            const classification = await window.ensureClassificationOnce();
            updateAiStatus(`Classification complete with ${Object.keys(classification || {}).length} categories`);
            console.log('New classification result:', classification);
          } catch (err) {
            updateAiStatus(`Classification error: ${err.message || String(err)}`);
            console.error('Classification retry error:', err);
          }
        });
        
        // Helper function to update AI status in the debug panel
        function updateAiStatus(message) {
          const statusEl = document.getElementById('ai-status');
          if (statusEl) {
            statusEl.textContent = `Status: ${message}`;
            
            // Add visual feedback
            statusEl.style.backgroundColor = '#f0f9ff';
            setTimeout(() => {
              statusEl.style.backgroundColor = '#f8fafc';
            }, 300);
          }
        }
        
        // Make debug panel draggable
        makeDraggable(document.getElementById('ai-debug-panel'));
        
        // Show debug panel if the URL has a debug parameter
        if (window.location.search.includes('debug=1') || window.location.hash === '#debug') {
          document.getElementById('ai-debug-panel').style.display = 'block';
        }
      });
      
      // Make an element draggable
      function makeDraggable(el) {
        if (!el) return;
        
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        const header = el.querySelector('h4') || el;
        
        if (header) {
          header.style.cursor = 'move';
          header.onmousedown = dragMouseDown;
        }
        
        function dragMouseDown(e) {
          e = e || window.event;
          e.preventDefault();
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.onmouseup = closeDragElement;
          document.onmousemove = elementDrag;
        }
        
        function elementDrag(e) {
          e = e || window.event;
          e.preventDefault();
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;
          
          // Calculate new position
          const newTop = (el.offsetTop - pos2);
          const newLeft = (el.offsetLeft - pos1);
          
          // Apply position limits to keep panel on screen
          const maxTop = window.innerHeight - el.offsetHeight;
          const maxLeft = window.innerWidth - el.offsetWidth;
          
          el.style.top = Math.max(0, Math.min(maxTop, newTop)) + "px";
          el.style.left = Math.max(0, Math.min(maxLeft, newLeft)) + "px";
        }
        
        function closeDragElement() {
          document.onmouseup = null;
          document.onmousemove = null;
        }
      }
    </script>

    <script>
        // --- Core Classification Functions (Global Scope) ---
        // These must be at top level so ensureClassificationOnce can find them
        
        // Low-level: call edge function, fallback to direct fetch; return { data, error, status }
        async function callClassify(slotTypes) {
          const body = { slotTypes };
          const url = (window.CONFIG && window.CONFIG.SUPABASE_URL ? window.CONFIG.SUPABASE_URL : '') + '/functions/v1/classify-slot-types';
          // Try supabase.functions.invoke first
          try {
            const t0 = Date.now();
            const { data, error } = await window.supabase.functions.invoke('classify-slot-types', { body });
            const ms = Date.now() - t0;
            if (error) return { data: null, error: new Error(error.message || String(error)), status: `invoke_error_${ms}ms` };
            // Stash minimal debug when server doesn't send debug block
            try { if (!window.lastAIRawResponse) window.lastAIRawResponse = JSON.stringify(data).slice(0, 4000); } catch(_) {}
            return { data, error: null, status: `invoke_ok_${ms}ms` };
          } catch (e) {
            // Fallback to direct fetch
            try {
              const t1 = Date.now();
              const res = await fetch(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${(window.CONFIG && window.CONFIG.SUPABASE_ANON_KEY) || ''}`
                },
                body: JSON.stringify(body)
              });
              const ms2 = Date.now() - t1;
              let txt = '';
              try { txt = await res.text(); } catch(_) {}
              try { window.lastAIRawResponse = txt; } catch(_) {}
              if (!res.ok) return { data: null, error: new Error(`HTTP ${res.status} ${res.statusText}`), status: `fetch_error_${ms2}ms` };
              let data = null; try { data = JSON.parse(txt); } catch { data = null; }
              return { data, error: null, status: `fetch_ok_${ms2}ms` };
            } catch (e2) {
              return { data: null, error: e2, status: 'fetch_throw' };
            }
          }
        }
        
        // Expose globally
        window.callClassify = callClassify;
    
        // Appointment Type Setup functionality
        function setupAppointmentTypes() {
            const statusEl = document.getElementById('appt-setup-status');
            const bodyEl = document.getElementById('appt-setup-body');
            const btnAll = document.getElementById('appt-match-all');
            const btnClear = document.getElementById('appt-clear');
            
            // Skip if elements not found (wrong step)
            if (!statusEl || !bodyEl || !btnAll || !btnClear) return;

            const urgentPattern = /\b(emergency|urgent|same\s*day|book\s*on\s*day|bod)\b/i;

            // Categories to identify
            const categories = [
              { key: 'on_the_day',    label: 'Book on the day',     source: 'ai' },
              { key: 'within_1_week', label: 'Within 1 week',       source: 'ai' },
              { key: 'within_2_weeks',label: 'Within 2 weeks',      source: 'ai' },
              { key: 'duty',          label: 'Duty slot (today only)', pattern: /\b(duty|duty\s*dr|duty\s*slot)\b/i },
              { key: 'nhs_111',       label: '111 slots',             pattern: /\b(111|nhs\s*111)\b/i },
              { key: 'break',         label: 'Breaks',                pattern: /\b(break|comfort)\b/i },
              { key: 'lunch',         label: 'Lunch',                 pattern: /\b(lunch|meal)\b/i },
              { key: 'admin',         label: 'Admin slots',           pattern: /\b(admin|administration|paperwork)\b/i },
            ];

            // Local selection state
            const selections = {}; // { key: selectedLabel }

            function setStatus(text){ if(statusEl) statusEl.textContent = text; }

            function normalizeLabel(s){ return String(s || '').trim().replace(/\s+/g,' '); }

            async function ensureSlotTypes(){
              // Reuse already loaded values when present
              if (Array.isArray(window.loadedSlotTypes) && window.loadedSlotTypes.length) return window.loadedSlotTypes;

              const started = performance.now();
              const sb = window.supabase || (window.getSupabase && window.getSupabase());
              if (!sb) throw new Error('Supabase client not available');

              const PAGE_SIZE = 1000;
              let offset = 0;
              const seen = new Set();
              const originals = new Map();

              setStatus('Loading slot types from EMIS…');
              while (true) {
                const { data, error } = await sb
                  .from('emis_apps_raw')
                  .select('slot_type')
                  .not('slot_type', 'is', null)
                  .order('slot_type', { ascending: true })
                  .range(offset, offset + PAGE_SIZE - 1);
                if (error) throw error;
                if (!data || !data.length) break;

                for (const r of data) {
                  const label = normalizeLabel(r.slot_type);
                  if (!label) continue;
                  const key = label.replace(/\s+/g,'');
                  if (!seen.has(key)) { seen.add(key); originals.set(key, label); }
                }

                if (data.length < PAGE_SIZE) break;
                offset += PAGE_SIZE;
              }

              const values = Array.from(seen).sort().map(k => originals.get(k));
              window.loadedSlotTypes = values;
              const dur = Math.round(performance.now() - started);
              setStatus(`Loaded ${values.length} slot types (${dur}ms)`);
              return values;
            }

            function nudgeUrgent(classification){
              const nudged = {
                on_the_day: [...(classification.on_the_day || [])],
                within_1_week: [],
                within_2_weeks: []
              };
              (classification.within_1_week || []).forEach(s => urgentPattern.test(s) ? nudged.on_the_day.push(s) : nudged.within_1_week.push(s));
              (classification.within_2_weeks || []).forEach(s => urgentPattern.test(s) ? nudged.on_the_day.push(s) : nudged.within_2_weeks.push(s));
              nudged.on_the_day = [...new Set(nudged.on_the_day)];
              return nudged;
            }
            
            // Render a lightweight Step 4 UI (client-only, does not call Supabase)
            // Removed duplicate renderStep4Setup() - using the more complete version below at line ~1979
            // Appointment type setup functionality
            async function initAppointmentSetup() {
              const setupStatus = document.getElementById('appt-setup-status');
              const setupBody = document.getElementById('appt-setup-body');
              const saveBtn = document.getElementById('appt-save');
              const matchAllBtn = document.getElementById('appt-match-all');
              const clearBtn = document.getElementById('appt-clear');
              
              if (!setupStatus || !setupBody) return;
              
              // Make sure we have slot types loaded
              if (!window.loadedSlotTypes || !window.loadedSlotTypes.length) {
                setupStatus.textContent = 'Loading slot types...';
                try {
                  await loadSlotTypesDropdown();
                } catch (err) {
                  setupStatus.textContent = 'Error loading slot types';
                  setupStatus.classList.add('error');
                  return;
                }
              }
              
              const slotTypes = window.loadedSlotTypes || [];
              if (!slotTypes.length) {
                setupStatus.textContent = 'No slot types available';
                setupStatus.classList.add('error');
                return;
              }
              
              // Get classifications if available
              let classification = window.slotTypeClassification;
              if (!classification) {
                setupStatus.textContent = 'Classifying slot types...';
                try {
                  classification = await ensureClassification(slotTypes);
                } catch (err) {
                  console.error('Classification error:', err);
                  // Continue without classification, we'll just show empty dropdowns
                }
              }
              
              // Build the UI with our categories
              setupStatus.textContent = 'Ready';
              setupStatus.classList.remove('error');
              buildAppointmentSetupRows(setupBody, slotTypes, classification);
              
              // Build the UI with our categories
              setupStatus.textContent = 'Ready';
              setupStatus.classList.remove('error');
              buildAppointmentSetupRows(setupBody, slotTypes, classification);
              
              // Setup buttons
              if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                  setupStatus.textContent = 'Configuration saved';
                  setTimeout(() => { setupStatus.textContent = 'Ready'; }, 2000);
                });
              }
              
              if (matchAllBtn) {
                matchAllBtn.addEventListener('click', () => {
                  setupBody.querySelectorAll('input[type="checkbox"]:not(:checked)').forEach(cb => {
                    const sel = cb.closest('tr').querySelector('select');
                    if (sel && sel.value !== '— Select —') {
                      cb.checked = true;
                    }
                  });
                });
              }
              
              if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                  setupBody.querySelectorAll('select').forEach(sel => {
                    sel.value = '— Select —';
                  });
                  setupBody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                  });
                });
              }
            }
            
            function buildAppointmentSetupRows(bodyEl, slotTypes, classification) {
              bodyEl.innerHTML = '';
              const opts = ['— Select —', ...slotTypes];
              
              // Sample categories - matching the screenshot
              const setupCategories = [
                { key: 'on_the_day', label: 'Book on the day', source: 'ai' },
                { key: 'within_1_week', label: 'Within 1 week', source: 'ai' },
                { key: 'within_2_weeks', label: 'Within 2 weeks', source: 'ai' },
                { key: 'duty', label: 'Duty slot', pattern: /\b(duty|triage)\b/i },
                { key: '111', label: '111 slots', pattern: /\b111\b/i },
                { key: 'breaks', label: 'Breaks', pattern: /\b(break|lunch)\b/i },
                { key: 'admin', label: 'Admin slots', pattern: /\b(admin|meeting)\b/i }
              ];

              function suggestedFor(cat) {
                if (!classification) return '';
                
                if (cat.source === 'ai') {
                  const arr = classification[cat.key] || [];
                  return arr[0] || '';
                }
                if (cat.pattern) {
                  const m = slotTypes.find(s => cat.pattern.test(s));
                  return m || '';
                }
                return '';
              }

              setupCategories.forEach(cat => {
                const tr = document.createElement('tr');
                const tdName = document.createElement('td');
                const tdSel = document.createElement('td');
                const tdConfirm = document.createElement('td');

                tdName.innerHTML = `<div class="cat-name">${cat.label}</div>`;

                const sel = document.createElement('select');
                sel.dataset.catKey = cat.key;
                opts.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
                const suggestion = suggestedFor(cat);
                if (suggestion) sel.value = suggestion;

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.dataset.catKey = cat.key;
                cb.checked = !!suggestion;

                tdSel.appendChild(sel);
                tdConfirm.appendChild(cb);
                tr.appendChild(tdName);
                tr.appendChild(tdSel);
                tr.appendChild(tdConfirm);
                bodyEl.appendChild(tr);
                
                // Hook up events
                sel.addEventListener('change', () => {
                  if (sel.value !== '— Select —') {
                    cb.checked = true;
                  }
                });
              });
            }
            
            

            async function ensureClassification(slotTypes){
              if (window.slotTypeClassification) return window.slotTypeClassification;
              const sb = window.supabase || (window.getSupabase && window.getSupabase());
              if (!sb) throw new Error('Supabase client not available');

              const t0 = performance.now();
              setStatus('Classifying slot types…');
              const { data, error } = await sb.functions.invoke('classify-slot-types', { body: { slotTypes } });
              if (error) throw new Error(error.message || 'Edge function failed');
              const raw = data?.classification || data;
              if (!raw) throw new Error('No classification returned');
              const nudged = nudgeUrgent(raw);
              window.slotTypeClassification = nudged;
              const dt = Math.round(performance.now() - t0);
              setStatus(`Classified in ${dt}ms`);
              return nudged;
            }

            function buildRows(slotTypes, classification){
              bodyEl.innerHTML = '';
              const opts = ['— Select —', ...slotTypes];

              function suggestedFor(cat){
                if (cat.source === 'ai') {
                  const arr = classification[cat.key] || [];
                  // Prefer first AI suggestion
                  return arr[0] || '';
                }
                if (cat.pattern) {
                  const m = slotTypes.find(s => cat.pattern.test(s));
                  return m || '';
                }
                return '';
              }

              categories.forEach(cat => {
                const tr = document.createElement('tr');
                const tdName = document.createElement('td');
                const tdSel = document.createElement('td');
                const tdConfirm = document.createElement('td');

                tdName.innerHTML = `<div class="cat-name">${cat.label}</div>`;

                const sel = document.createElement('select');
                opts.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
                const suggestion = suggestedFor(cat);
                if (suggestion) sel.value = suggestion; else sel.value = '— Select —';

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.ariaLabel = `Confirm ${cat.label}`;
                cb.addEventListener('change',() => {
                  if (cb.checked && sel.value && sel.value !== '— Select —') {
                    tr.classList.add('row-confirmed');
                    selections[cat.key] = sel.value;
                  } else {
                    tr.classList.remove('row-confirmed');
                    delete selections[cat.key];
                  }
                  setStatus(Object.keys(selections).length ? `Confirmed ${Object.keys(selections).length} / ${categories.length}` : 'No selections yet');
                });

                sel.addEventListener('change', () => {
                  if (cb.checked) cb.dispatchEvent(new Event('change'));
                });

                tdSel.appendChild(sel);
                tdConfirm.appendChild(cb);
                tr.appendChild(tdName); tr.appendChild(tdSel); tr.appendChild(tdConfirm);
                bodyEl.appendChild(tr);

                // Auto-confirm suggested matches for AI categories
                if (suggestion && cat.source === 'ai') {
                  cb.checked = true; cb.dispatchEvent(new Event('change'));
                }
              });
            }

            btnAll.addEventListener('click', () => {
              // Confirm all rows with current selections; if not selected, try to set suggestion and confirm
              Array.from(bodyEl.querySelectorAll('tr')).forEach((tr, idx) => {
                const cat = categories[idx];
                const sel = tr.querySelector('select');
                const cb = tr.querySelector('input[type="checkbox"]');
                if (sel && (!sel.value || sel.value === '— Select —')) {
                  // set suggestion if available
                  const slotTypes = window.loadedSlotTypes || [];
                  const classification = window.slotTypeClassification || { on_the_day:[], within_1_week:[], within_2_weeks:[] };
                  let s = '';
                  if (cat.source === 'ai') s = (classification[cat.key]||[])[0] || '';
                  else if (cat.pattern) s = (slotTypes.find(x => cat.pattern.test(x)) || '');
                  if (s) sel.value = s;
                }
                if (cb && sel && sel.value && sel.value !== '— Select —') { cb.checked = true; cb.dispatchEvent(new Event('change')); }
              });
              setStatus(`All matched where possible (${Object.keys(selections).length} confirmed)`);
            });

            btnClear.addEventListener('click', () => {
              Object.keys(selections).forEach(k => delete selections[k]);
              Array.from(bodyEl.querySelectorAll('tr')).forEach(tr => { tr.classList.remove('row-confirmed'); });
              Array.from(bodyEl.querySelectorAll('input[type="checkbox"]')).forEach(cb => cb.checked = false);
              setStatus('Cleared selections');
            });

            (async function init(){
              try {
                const slotTypes = await ensureSlotTypes();
                const classification = await ensureClassification(slotTypes);
                buildRows(slotTypes, classification);
              } catch (e) {
                console.error('Appointment setup init error:', e);
                setStatus('Error: ' + (e?.message || String(e)));
              }
            })();
        }

        // Helper: load unique slot types from emis_apps_raw into window.loadedSlotTypes
        async function loadUniqueSlotTypes() {
          if (Array.isArray(window.loadedSlotTypes) && window.loadedSlotTypes.length) return window.loadedSlotTypes;
          const sb = window.supabase || (window.getSupabase && window.getSupabase());
          if (!sb) throw new Error('Supabase client not available');
          const PAGE_SIZE = 1000;
          let offset = 0;
          const seen = new Set();
          const originals = new Map();
          while (true) {
            const { data, error } = await sb
              .from('emis_apps_raw')
              .select('slot_type')
              .not('slot_type', 'is', null)
              .order('slot_type', { ascending: true })
              .range(offset, offset + PAGE_SIZE - 1);
            if (error) throw error;
            if (!data || !data.length) break;
            for (const r of data) {
              const label = String(r.slot_type || '').trim();
              if (!label) continue;
              const key = label.replace(/\s+/g,'');
              if (!seen.has(key)) { seen.add(key); originals.set(key, label); }
            }
            if (data.length < PAGE_SIZE) break;
            offset += PAGE_SIZE;
          }
          const values = Array.from(seen).sort().map(k => originals.get(k));
          window.loadedSlotTypes = values;
          return values;
        }

        // Orchestrator: ensure slot types are fully loaded (single in-flight promise)
        let __slotTypesLoadPromise = null;
        async function ensureSlotTypesOnce() {
          if (Array.isArray(window.loadedSlotTypes) && window.loadedSlotTypes.length) return window.loadedSlotTypes;
          if (!__slotTypesLoadPromise) {
            __slotTypesLoadPromise = loadUniqueSlotTypes()
              .catch(err => { __slotTypesLoadPromise = null; throw err; });
          }
          return __slotTypesLoadPromise;
        }

        // Orchestrator: ensure classification happens after slot types are loaded, prevent duplicate invokes
        let __classificationPromise = null;
        async function ensureClassificationOnce() {
          await ensureSlotTypesOnce();
          if (window.slotTypeClassification && window.slotTypeClassification.on_the_day) return window.slotTypeClassification;
          if (!__classificationPromise) {
            // Use the global window.classifySlotTypes if available
            if (typeof window.classifySlotTypes === 'function') {
              __classificationPromise = window.classifySlotTypes()
                .catch(err => { __classificationPromise = null; throw err; });
            } else if (typeof classifySlotTypes === 'function') {
              __classificationPromise = classifySlotTypes()
                .catch(err => { __classificationPromise = null; throw err; });
            } else if (typeof ensureClassification === 'function') {
              __classificationPromise = (async () => {
                try {
                  const slotTypes = window.loadedSlotTypes || (await ensureSlotTypesOnce());
                  const res = await ensureClassification(slotTypes);
                  return res;
                } catch (err) { __classificationPromise = null; throw err; }
              })();
            } else {
              throw new Error('No classification function available');
            }
          }
          return __classificationPromise;
        }

        function resetClassificationCache() {
          try { window.slotTypeClassification = null; } catch(_) {}
          __classificationPromise = null;
        }
        
        // Global availability for test functions
        // Simple connectivity and auth diagnostic
        window.aiConnectivityTest = async function() {
          console.log('Running AI connectivity test...');
          const sample = ['Urgent on day','Routine appt','Follow-up in 10 days'];
          try {
            const sb = window.supabase || (window.getSupabase && window.getSupabase());
            if (!sb) throw new Error('No Supabase client found');
            
            console.log('Testing with direct invoke');
            const { data, error } = await sb.functions.invoke('classify-slot-types', { 
              body: { slotTypes: sample }
            });
            
            if (error) throw new Error(error.message || String(error));
            console.log('Test result:', data);
            
            const cls = data && (data.classification || data);
            const ok = cls && (Array.isArray(cls.on_the_day) || Array.isArray(cls.within_1_week) || Array.isArray(cls.within_2_weeks));
            return { ok: !!ok, detail: 'invoke_ok' };
          } catch (e) {
            console.error('Test error:', e);
            return { ok: false, detail: e?.message || String(e) };
          }
        };
        
        // Last request payload sent to AI
        window.lastAIRequest = null;
        
        // Last response received from AI
        window.lastAIResponse = null;
        
        // Display the last request payload
        window.aiRequest = function() {
          console.log('Last AI request payload:', window.lastAIRequest);
          return window.lastAIRequest;
        };
        
        // Display the last response from AI
        window.aiResponse = function() {
          console.log('Last AI response:', window.lastAIResponse);
          return window.lastAIResponse;
        };

        // Expose a global renderer for Step 4 so callers outside
        // the nested setup function can invoke it (MutationObserver,
        // showWelcomeStep, etc.). This mirrors the inner function's
        // behavior but lives at top-level.
        async function renderStep4Setup() {
          console.log('global renderStep4Setup() called');
          const step4Bd = document.querySelector('.wstep[data-wstep="4"] .card-bd');
          if (!step4Bd) return;

          // Idempotency & race guard:
          // - If fully rendered, skip immediately.
          // - If another render is in progress, skip to avoid concurrent builds.
          if (step4Bd.dataset.step4Rendered === '1') {
            console.log('renderStep4Setup: already rendered, skipping');
            return;
          }
          if (step4Bd.dataset.step4Rendering === '1') {
            console.log('renderStep4Setup: render already in progress, skipping');
            return;
          }

          // Mark rendering-in-progress to avoid races from other callers
          step4Bd.dataset.step4Rendering = '1';

          // Clear existing content - render directly in the card like other steps
          step4Bd.innerHTML = '';
          const container = step4Bd;

          const heading = document.createElement('h4');
          heading.textContent = 'Appointment Type Setup';
          heading.style.marginTop = '0';
          heading.style.fontSize = '1.5rem';
          heading.style.fontWeight = '600';
          heading.style.color = '#1e293b';
          heading.style.borderBottom = '2px solid #3b82f6';
          heading.style.paddingBottom = '8px';
          heading.style.marginBottom = '16px';
          container.appendChild(heading);

          const hint = document.createElement('div');
          hint.className = 'hint';
          hint.textContent = 'Select the slot type that corresponds to each appointment category and confirm.';
          hint.style.backgroundColor = '#f0f9ff';
          hint.style.border = '1px solid #bae6fd';
          hint.style.borderLeft = '4px solid #38bdf8';
          hint.style.borderRadius = '6px';
          hint.style.padding = '12px 16px';
          hint.style.marginBottom = '20px';
          hint.style.color = '#0c4a6e';
          hint.style.fontSize = '0.95rem';
          hint.style.lineHeight = '1.5';
          container.appendChild(hint);

          // AI status + controls row
          const aiRow = document.createElement('div');
          aiRow.style.display = 'flex';
          aiRow.style.alignItems = 'center';
          aiRow.style.gap = '10px';
          aiRow.style.margin = '6px 0 8px 0';
          const aiStatus = document.createElement('span');
          aiStatus.id = 'ai-status-line';
          aiStatus.style.fontSize = '12px';
          aiStatus.style.color = '#334155';
          aiStatus.textContent = 'AI status: idle';
          const aiRetry = document.createElement('button');
          aiRetry.id = 'step4-ai-retry-btn';
          aiRetry.type = 'button';
          aiRetry.textContent = 'Retry classify';
          aiRetry.style.padding = '6px 10px';
          aiRetry.style.borderRadius = '6px';
          aiRetry.style.border = '1px solid #e2e8f0';
          aiRetry.style.background = '#fff';
          aiRetry.style.cursor = 'pointer';
          const aiTest = document.createElement('button');
          aiTest.id = 'step4-ai-test-btn';
          aiTest.type = 'button';
          aiTest.textContent = 'Test AI connectivity';
          aiTest.style.padding = '6px 10px';
          aiTest.style.borderRadius = '6px';
          aiTest.style.border = '1px solid #e2e8f0';
          aiTest.style.background = '#fff';
          aiTest.style.cursor = 'pointer';
          aiRow.appendChild(aiStatus);
          aiRow.appendChild(aiRetry);
          aiRow.appendChild(aiTest);
          container.appendChild(aiRow);

          const table = document.createElement('table');
          table.style.width = '100%';
          table.style.borderCollapse = 'collapse';
          table.style.marginTop = '12px';
          table.style.border = '1px solid #e2e8f0';

          const thead = document.createElement('thead');
          thead.innerHTML = '<tr><th style="width:260px;text-align:left;padding:12px 16px;border-bottom:2px solid #3b82f6;background-color:#f1f5f9;color:#334155;font-weight:600;font-size:0.95rem;">Type to identify</th><th style="text-align:left;padding:12px 16px;border-bottom:2px solid #3b82f6;background-color:#f1f5f9;color:#334155;font-weight:600;font-size:0.95rem;">Slot type (from EMIS)</th><th style="width:120px;padding:12px 16px;border-bottom:2px solid #3b82f6;background-color:#f1f5f9;color:#334155;font-weight:600;font-size:0.95rem;text-align:center">Confirm</th></tr>';
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          table.appendChild(tbody);
          
          // Add a loading indicator while waiting for data
          const loadingRow = document.createElement('tr');
          
          // Create loading cell with animation
          const loadingCell = document.createElement('td');
          loadingCell.colSpan = 3;
          loadingCell.style.textAlign = 'center';
          loadingCell.style.padding = '30px 20px';
          
          // Create loading content
          const loadingContent = document.createElement('div');
          loadingContent.style.display = 'flex';
          loadingContent.style.alignItems = 'center';
          loadingContent.style.justifyContent = 'center';
          loadingContent.style.gap = '12px';
          
          // Create spinner animation
          const spinner = document.createElement('div');
          spinner.style.width = '24px';
          spinner.style.height = '24px';
          spinner.style.border = '3px solid rgba(59, 130, 246, 0.2)';
          spinner.style.borderRadius = '50%';
          spinner.style.borderTop = '3px solid #3b82f6';
          spinner.style.animation = 'spin 1s linear infinite';
          
          // Create loading text
          const loadingText = document.createElement('span');
          loadingText.textContent = 'Loading slot types...';
          loadingText.style.color = '#64748b';
          loadingText.style.fontWeight = '500';
          
          // Assemble loading indicator
          loadingContent.appendChild(spinner);
          loadingContent.appendChild(loadingText);
          loadingCell.appendChild(loadingContent);
          loadingRow.appendChild(loadingCell);
          
          // Add animation style if not already added
          if (!document.getElementById('loading-animation-style')) {
            const style = document.createElement('style');
            style.id = 'loading-animation-style';
            style.textContent = `
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
            `;
            document.head.appendChild(style);
          }
          
          tbody.appendChild(loadingRow);

          // Ensure slot types are loaded from the database (via orchestrator)
          let slotTypes = (Array.isArray(window.loadedSlotTypes) && window.loadedSlotTypes.length) ? window.loadedSlotTypes : [];
          if (!slotTypes.length) {
            try { slotTypes = await ensureSlotTypesOnce(); } catch (e) { console.warn('Failed to load slot types for Step 4:', e); }
          }
          
          // Clear loading indicator once data is loaded
          tbody.innerHTML = '';

          const categoriesForUI = [
            { key: 'on_the_day', label: 'Book on the day' },
            { key: 'within_1_week', label: 'Within 1 week' },
            { key: 'within_2_weeks', label: 'Within 2 weeks' },
            { key: 'duty', label: 'Duty slot' },
            { key: 'nhs_111', label: '111 slots' },
            { key: 'break', label: 'Breaks' },
            { key: 'admin', label: 'Admin slots' }
          ];

          // If we have slot types, classify (via orchestrator) and preselect AI suggestions
          let classification = window.slotTypeClassification;
          if ((!classification || !classification.on_the_day) && slotTypes.length) {
            try {
              const statusEl = document.getElementById('ai-status-line');
              if (statusEl) statusEl.textContent = `AI status: classifying ${slotTypes.length} slot types…`;
              classification = await ensureClassificationOnce();
              if (statusEl) {
                const counts = {
                  o: (classification.on_the_day||[]).length,
                  w1: (classification.within_1_week||[]).length,
                  w2: (classification.within_2_weeks||[]).length
                };
                statusEl.textContent = `AI status: classified (on_the_day ${counts.o}, within_1_week ${counts.w1}, within_2_weeks ${counts.w2})`;
              }
            } catch (err) {
              console.warn('Classification failed in Step 4:', err);
              const statusEl = document.getElementById('ai-status-line');
              if (statusEl) statusEl.textContent = `AI status: error — ${err?.message || err}`;
            }
          }

          categoriesForUI.forEach(cat => {
            const tr = document.createElement('tr');
            
            // Add hover effect for the row
            tr.addEventListener('mouseover', function() {
              this.style.backgroundColor = '#f8fafc';
            });
            
            tr.addEventListener('mouseout', function() {
              this.style.backgroundColor = '';
            });
            
            const tdName = document.createElement('td');
            const tdSel = document.createElement('td');
            const tdConfirm = document.createElement('td');

            // Style the cells
            tdName.style.padding = '12px 10px';
            tdName.style.borderBottom = '1px solid #e2e8f0';
            tdSel.style.padding = '8px';
            tdSel.style.borderBottom = '1px solid #e2e8f0';
            tdConfirm.style.textAlign = 'center';
            tdConfirm.style.padding = '8px';
            tdConfirm.style.borderBottom = '1px solid #e2e8f0';

            tdName.innerHTML = `<div class="cat-name" style="font-weight:600;">${cat.label}</div>`;

            const sel = document.createElement('select');
            sel.style.width = '100%';
            sel.style.padding = '10px';
            sel.style.borderRadius = '4px';
            sel.style.border = '1px solid #cbd5e0';
            sel.style.backgroundColor = '#f7fafc';
            sel.dataset.catKey = cat.key;
            
            const defaultOpt = document.createElement('option'); 
            defaultOpt.value = ''; 
            defaultOpt.textContent = '— Select —'; 
            sel.appendChild(defaultOpt);
            
            const options = slotTypes.length ? slotTypes : ['-- No slot types loaded --', 'Example Slot A', 'Example Slot B'];
            options.forEach(s => { 
              const o = document.createElement('option'); 
              o.value = s; 
              o.textContent = s; 
              sel.appendChild(o); 
            });

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.style.transform = 'scale(1.1)';
            cb.style.marginLeft = '6px';

            // Preselect AI suggestion when available for the three AI categories
            if (classification && (cat.key === 'on_the_day' || cat.key === 'within_1_week' || cat.key === 'within_2_weeks')) {
              const arr = Array.isArray(classification[cat.key]) ? classification[cat.key] : [];
              if (arr.length) {
                sel.value = arr[0];
                if (sel.value) cb.checked = true;
              }
            } else {
              // Heuristic suggestions for the non-AI categories
              if (options.length) {
                const patternMap = {
                  duty: /(\bduty\b|duty\s*dr|duty\s*slot)/i,
                  nhs_111: /(111|nhs\s*111)/i,
                  break: /\b(break|comfort)\b/i,
                  admin: /\b(admin|administration|paperwork)\b/i
                };
                const pat = patternMap[cat.key];
                if (pat) {
                  const match = options.find(s => pat.test(s));
                  if (match) { sel.value = match; cb.checked = true; }
                }
              }
            }

            tdSel.appendChild(sel);
            tdConfirm.appendChild(cb);
            tr.appendChild(tdName); 
            tr.appendChild(tdSel); 
            tr.appendChild(tdConfirm);
            tbody.appendChild(tr);

            sel.addEventListener('change', () => { if (sel.value) cb.checked = true; });
            
            // Highlight confirmed rows
            if (cb.checked) {
              tr.style.backgroundColor = '#f0fdf4';
              sel.style.backgroundColor = '#e6fffa';
              sel.style.borderColor = '#38b2ac';
            }
            
            cb.addEventListener('change', function() {
              if (this.checked && sel.value) {
                tr.style.backgroundColor = '#f0fdf4';
                sel.style.backgroundColor = '#e6fffa';
                sel.style.borderColor = '#38b2ac';
              } else {
                tr.style.backgroundColor = '';
                sel.style.backgroundColor = '#f7fafc';
                sel.style.borderColor = '#cbd5e0';
              }
            });
          });

          container.appendChild(table);
          console.log('STEP4: rows rendered:', document.querySelectorAll('.wstep[data-wstep="4"] .card-bd tbody tr').length);

          // Actions row
          const actions = document.createElement('div');
          actions.style.display = 'flex'; 
          actions.style.gap = '8px'; 
          actions.style.marginTop = '16px';
          actions.style.justifyContent = 'flex-start';

          const btnConfirmAll = document.createElement('button'); 
          btnConfirmAll.className = 'btn-primary'; 
          btnConfirmAll.type = 'button'; 
          btnConfirmAll.textContent = 'Confirm All';
          btnConfirmAll.style.padding = '10px 16px';
          btnConfirmAll.style.backgroundColor = '#3b82f6';
          btnConfirmAll.style.color = 'white';
          btnConfirmAll.style.border = 'none';
          btnConfirmAll.style.borderRadius = '6px';
          btnConfirmAll.style.fontWeight = '600';
          btnConfirmAll.style.cursor = 'pointer';
          btnConfirmAll.style.boxShadow = '0 2px 6px rgba(37,99,235,0.2)';
          
          const btnClear = document.createElement('button'); 
          btnClear.className = 'btn-secondary'; 
          btnClear.type = 'button'; 
          btnClear.textContent = 'Clear';
          btnClear.style.padding = '10px 16px';
          btnClear.style.backgroundColor = 'white';
          btnClear.style.color = '#334155';
          btnClear.style.border = '1px solid #e2e8f0';
          btnClear.style.borderRadius = '6px';
          btnClear.style.fontWeight = '500';
          btnClear.style.cursor = 'pointer';

          btnConfirmAll.addEventListener('click', () => {
            tbody.querySelectorAll('tr').forEach(tr => {
              const sel = tr.querySelector('select'); 
              const cb = tr.querySelector('input[type="checkbox"]');
              if (sel && cb && sel.value && sel.value !== '') {
                cb.checked = true;
                tr.style.backgroundColor = '#f0fdf4';
                sel.style.backgroundColor = '#e6fffa';
                sel.style.borderColor = '#38b2ac';
              }
            });
            
            // Add a success message
            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success';
            successMsg.style.marginTop = '16px';
            successMsg.style.padding = '10px 14px';
            successMsg.style.backgroundColor = '#f0fdf4';
            successMsg.style.borderLeft = '4px solid #22c55e';
            successMsg.style.borderRadius = '4px';
            successMsg.innerHTML = '<strong>All applicable slot types confirmed!</strong>';
            
            // Remove any existing success message before adding a new one
            const existingMsg = container.querySelector('.alert-success');
            if (existingMsg) existingMsg.remove();
            
            container.appendChild(successMsg);
          });

          btnClear.addEventListener('click', () => {
            tbody.querySelectorAll('tr').forEach(tr => {
              const sel = tr.querySelector('select'); 
              const cb = tr.querySelector('input[type="checkbox"]');
              if (sel) {
                sel.value = '';
                sel.style.backgroundColor = '#f7fafc';
                sel.style.borderColor = '#cbd5e0';
              }
              if (cb) cb.checked = false;
              tr.style.backgroundColor = '';
            });
            
            // Remove any success messages
            const existingMsg = container.querySelector('.alert-success');
            if (existingMsg) existingMsg.remove();
          });

          actions.appendChild(btnConfirmAll); 
          actions.appendChild(btnClear);
          container.appendChild(actions);

          // Wire AI buttons (using step4-specific IDs to avoid conflicts with global debug panel)
          try {
            const statusEl = document.getElementById('ai-status-line');
            const retryBtn = document.getElementById('step4-ai-retry-btn');
            const testBtn = document.getElementById('step4-ai-test-btn');
            if (retryBtn) retryBtn.addEventListener('click', async () => {
              try {
                resetClassificationCache();
                if (statusEl) statusEl.textContent = 'AI status: retrying…';
                const cls = await ensureClassificationOnce();
                const counts = { o: (cls.on_the_day||[]).length, w1: (cls.within_1_week||[]).length, w2: (cls.within_2_weeks||[]).length };
                if (statusEl) statusEl.textContent = `AI status: classified (on_the_day ${counts.o}, within_1_week ${counts.w1}, within_2_weeks ${counts.w2})`;
              } catch (e) { if (statusEl) statusEl.textContent = `AI status: error — ${e?.message || e}`; }
            });
            if (testBtn) testBtn.addEventListener('click', async () => {
              try {
                if (statusEl) statusEl.textContent = 'AI test: pinging function…';
                const diag = await window.aiConnectivityTest();
                if (statusEl) statusEl.textContent = `AI test: ${diag.ok ? 'OK' : 'FAIL'} (${diag.detail})`;
              } catch (e) { if (statusEl) statusEl.textContent = `AI test: error — ${e?.message || e}`; }
            });
          } catch(_) {}

          // Watch for accidental clears of the card body and re-render once if it happens shortly after
          try {
            const obs = new MutationObserver((mutations) => {
              const hasChildren = step4Bd.childNodes && step4Bd.childNodes.length > 0;
              if (!hasChildren) {
                obs.disconnect();
                console.warn('Step 4 card body was cleared; re-rendering');
                setTimeout(() => { try { renderStep4Setup(); } catch(_) {} }, 120);
              }
            });
            obs.observe(step4Bd, { childList: true, subtree: false });
            // Stop observing after 2.5s to avoid long-lived observers
            setTimeout(() => { try { obs.disconnect(); } catch(_) {} }, 2500);
          } catch (e) { console.warn('Could not attach Step 4 observer', e); }
          // Mark fully rendered and clear the rendering-in-progress flag
          try { step4Bd.dataset.step4Rendered = '1'; delete step4Bd.dataset.step4Rendering; } catch(_) {}
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Simple view router for Welcome / Upload / Dashboard
            const navButtons = document.querySelectorAll('.nav-pill');
            const views = { welcome: document.getElementById('view-welcome') }; // single consistent view
            function showView(){
              // Always keep Welcome view visible for the wizard
              Object.values(views).forEach(v => v && v.classList.add('on'));
              navButtons.forEach(b => b.classList.remove('active'));
            }
            navButtons.forEach(b => b.addEventListener('click', () => {
              const v = b.dataset.view;
              if (v === 'welcome')   showWelcomeStep(1);
              if (v === 'upload')    showWelcomeStep(2);
              if (v === 'dashboard') showWelcomeStep(4);
              navButtons.forEach(x => x.classList.remove('active'));
              b.classList.add('active');
            }));
            showView();

            // --- Welcome internal wizard (4 steps) ---
            let wStep = 1;
            const maxWStep = 5;
            const wsteps = document.querySelectorAll('.wstep');
            const ssteps = document.querySelectorAll('.stepper .step');
            const btnBack = document.getElementById('welcome-back');
            const btnNext = document.getElementById('welcome-next');
            // Open-upload button removed from DOM; no longer needed

            function showWelcomeStep(n){
              wStep = Math.max(1, Math.min(maxWStep, n));
              // Toggle internal pages
              wsteps.forEach(ws => ws.classList.toggle('on', Number(ws.dataset.wstep) === wStep));
              // Update stepper states
              ssteps.forEach(ss => {
                const idx = Number(ss.dataset.step);
                ss.classList.toggle('active', idx === wStep);
                ss.classList.toggle('done', idx < wStep);
              });
              // Controls
              if (btnBack) btnBack.disabled = (wStep === 1);
              if (btnNext) btnNext.textContent = (wStep === maxWStep) ? 'Finish' : 'Next';
              updateWizardProgress();
              // If we navigated to step 4, ensure the setup UI is rendered
              if (wStep === 4 && typeof renderStep4Setup === 'function') {
                try { renderStep4Setup(); } catch (e) { console.error('renderStep4Setup error', e); }
              }
            }

            // Wire controls
            if (btnBack) btnBack.addEventListener('click', () => showWelcomeStep(wStep - 1));
            if (btnNext) btnNext.addEventListener('click', async () => {
              // If on step 4, save the mappings before proceeding
              if (wStep === 4) {
                const success = await saveMappings();
                if (!success) {
                  return; // Don't proceed if save failed
                }
              }
              
              if (wStep < maxWStep) {
                showWelcomeStep(wStep + 1); // advance through steps
              } else {
                // We're finishing the wizard. Copy the current user's profile to sessionStorage
                // so emis_reporting.html can show the exact same profile, then navigate there.
                try {
                  const sb = window.supabase || (window.getSupabase && window.getSupabase());
                  if (sb) {
                    const { data: { session } } = await sb.auth.getSession();
                    if (session && session.user && session.user.id) {
                      try {
                        const { data } = await sb
                          .from('master_users')
                          .select('site_id, access_type, full_name, avatar_url')
                          .eq('auth_user_id', session.user.id)
                          .maybeSingle();
                        if (data) {
                          try { sessionStorage.setItem('emisPassedProfile', JSON.stringify(data)); } catch(_) {}
                        }
                      } catch (e) { console.warn('Failed to fetch profile for transfer', e); }
                    }
                  }
                } catch (e) { console.warn('Failed to copy profile to sessionStorage', e); }

                // Go to the reporting page which will prefer the copied profile when present
                window.location.href = 'emis_reporting.html';
              }
            });
            // Open-upload button removed from DOM; navigation handled by top nav pills

            // (Removed: click-to-jump on stepper for strict linear flow)
            // Make stepper boxes clickable for navigation
            ssteps.forEach(ss => {
              ss.style.cursor = 'pointer';
              ss.addEventListener('click', (e) => {
                const idx = Number(ss.dataset.step);
                showWelcomeStep(idx);
              });
            });

            // Wizard progress updater and initial call
            function updateWizardProgress(){
              const fill = document.querySelector('#wizard-progress .fill');
              const labels = document.querySelectorAll('#wizard-progress .labels span');
              const pct = ((wStep - 1) / (maxWStep - 1)) * 100;
              if (fill) fill.style.width = pct + '%';
              labels.forEach(el => {
                const idx = Number(el.dataset.step);
                el.classList.toggle('active', idx === wStep);
              });
            }
            // Initialize wizard at step 1
            showWelcomeStep(1);
            updateWizardProgress();

            // --- Save slot type mappings to database ---
            async function saveMappings() {
              console.log('💾 Saving slot type mappings...');
              
              try {
                // Get all the select elements and checkboxes from step 4
                // The setup UI now renders inline inside the wstep card body
                const step4Container = document.querySelector('.wstep[data-wstep="4"] .card-bd');
                if (!step4Container) {
                  console.error('Step 4 container not found');
                  alert('Error: Setup form not found. Please refresh and try again.');
                  return false;
                }
                
                // Find all the rows with select elements
                const rows = step4Container.querySelectorAll('tbody tr');
                const mappings = [];
                let confirmedCount = 0;
                
                rows.forEach(row => {
                  const select = row.querySelector('select');
                  const checkbox = row.querySelector('input[type="checkbox"]');
                  const categoryKey = select?.dataset?.catKey;
                  const categoryLabel = row.querySelector('.cat-name')?.textContent?.trim();
                  
                  if (!select || !checkbox || !categoryKey || !categoryLabel) {
                    return; // Skip invalid rows
                  }
                  
                  // Only save confirmed mappings (checkbox checked)
                  if (checkbox.checked && select.value && select.value !== '— Select —') {
                    mappings.push({
                      category_key: categoryKey,
                      category_label: categoryLabel,
                      emis_slot_type: select.value // The selected EMIS slot type (renamed from matched_emis_type)
                    });
                    confirmedCount++;
                  }
                });
                
                if (mappings.length === 0) {
                  alert('Please select and confirm at least one slot type mapping before proceeding.');
                  return false;
                }
                
                console.log(`📊 Saving ${mappings.length} mappings:`, mappings);
                
                // Show loading state
                const btnNext = document.getElementById('welcome-next');
                const originalText = btnNext?.textContent;
                if (btnNext) {
                  btnNext.disabled = true;
                  btnNext.textContent = 'Saving...';
                }
                
                // Get Supabase client and auth session
                const sb = window.supabase || (window.getSupabase && window.getSupabase());
                if (!sb) throw new Error('Supabase client not available');
                
                const { data: { session } } = await sb.auth.getSession();
                if (!session) {
                  alert('Your session has expired. Please log in again.');
                  window.location.href = 'admin-login.html';
                  return false;
                }
                
                // Call the Edge Function to save mappings
                // We use the Supabase JS SDK which wraps the HTTP response, but to capture full error details
                // we also attempt a direct fetch fallback to inspect the raw response body when something fails.
                let fnResponse = null;
                try {
                  const { data, error } = await sb.functions.invoke('save-slot-mappings', {
                    body: { mappings }
                  });
                  fnResponse = { data, error };
                  if (error) throw error;
                } catch (invokeErr) {
                  console.error('Supabase functions.invoke error:', invokeErr);
                  // Try direct fetch to capture raw JSON from the function
                  try {
                    const url = (window.CONFIG && window.CONFIG.SUPABASE_URL ? window.CONFIG.SUPABASE_URL : '') + '/functions/v1/save-slot-mappings';
                    const t0 = Date.now();
                    const r = await fetch(url, {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                      },
                      body: JSON.stringify({ mappings })
                    });
                    const txt = await r.text();
                    let parsed = null;
                    try { parsed = JSON.parse(txt); } catch(_) { parsed = txt; }
                    console.error('Direct function fetch response status:', r.status, r.statusText, 'body:', parsed);
                    alert('Failed to save mappings. See console for details.');
                    if (btnNext) { btnNext.disabled = false; btnNext.textContent = originalText; }
                    return false;
                  } catch (fetchErr) {
                    console.error('Direct fetch error when saving mappings:', fetchErr);
                    alert('Failed to save mappings (network error). See console for details.');
                    if (btnNext) { btnNext.disabled = false; btnNext.textContent = originalText; }
                    return false;
                  }
                }
                
                console.log('✅ Mappings saved successfully:', fnResponse?.data);
                
                // Store the result for Step 5 display
                window.savedMappingsResult = {
                  success: true,
                  count: mappings.length,
                  mappings: mappings, // Use our local mappings array which has all the fields
                  savedData: fnResponse?.data, // Also store what came back from the server
                  timestamp: new Date().toISOString()
                };
                
                // Update Step 5 summary with our mappings
                updateStep5Summary({ count: mappings.length, mappings: mappings });
                
                if (btnNext) {
                  btnNext.disabled = false;
                  btnNext.textContent = originalText;
                }
                
                return true;
                
              } catch (err) {
                console.error('Unexpected error saving mappings:', err);
                alert(`Error: ${err.message || 'Failed to save mappings. Please try again.'}`);
                
                const btnNext = document.getElementById('welcome-next');
                if (btnNext) {
                  btnNext.disabled = false;
                  btnNext.textContent = 'Next';
                }
                
                return false;
              }
            }
            
            // Update Step 5 with confirmation details
            function updateStep5Summary(saveResult) {
              const summaryEl = document.getElementById('step5-summary');
              if (!summaryEl) return;
              
              const count = saveResult.saved_count || saveResult.count || 0;
              const mappings = saveResult.mappings || [];
              
              let html = `
                <h3 style="font-size:16px;font-weight:600;margin:0 0 12px 0;color:#0f172a;">
                  ${count} Slot Type Mapping${count !== 1 ? 's' : ''} Saved
                </h3>
                <div style="display:grid;gap:8px;max-height:300px;overflow-y:auto;">
              `;
              
              mappings.forEach(mapping => {
                const hardcodedType = mapping.hardcoded_type || mapping.category_label || mapping.category_key || 'Unknown';
                const emisType = mapping.matched_emis_type || mapping.emis_slot_type || 'Unknown';
                html += `
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:white;border:1px solid #e2e8f0;border-radius:6px;">
                    <div>
                      <div style="font-weight:600;color:#0f172a;font-size:14px;">${hardcodedType}</div>
                      <div style="font-size:12px;color:#64748b;margin-top:2px;">→ ${emisType}</div>
                    </div>
                    <div style="color:#22c55e;font-size:20px;">✓</div>
                  </div>
                `;
              });
              
              html += `</div>`;
              
              html += `
                <div style="margin-top:16px;padding:12px;background:#dbeafe;border-radius:6px;font-size:13px;color:#1e40af;">
                  <strong>ℹ️ Note:</strong> These mappings are now active for your site. You can update them anytime by returning to this setup wizard.
                </div>
              `;
              
              summaryEl.innerHTML = html;
            }

            // --- Setup (step 4) : Populate slot type dropdown from emis_apps_raw ---
            async function loadSlotTypesDropdown() {
              const select = document.getElementById('emis-slottype-select');
              if (!select) return;
              select.innerHTML = '';

              try {
                const sb = window.supabase || (window.getSupabase && window.getSupabase());
                if (!sb) throw new Error('Supabase client not available');

                // Page through the table in 1k chunks (Supabase PostgREST default max rows)
                // Order by slot_type so we don't depend on csv_row_number distribution
                const PAGE_SIZE = 1000;
                let offset = 0;
                const seen = new Set();
                const originalValues = new Map(); // normalized -> original label

                while (true) {
                  const { data, error } = await sb
                    .from('emis_apps_raw')
                    .select('slot_type')
                    .not('slot_type', 'is', null)
                    .order('slot_type', { ascending: true })
                    .range(offset, offset + PAGE_SIZE - 1);

                  if (error) throw error;
                  if (!data || data.length === 0) break;

                  for (const r of data) {
                    const orig = r?.slot_type;
                    if (orig === null || orig === undefined) continue;
                    const trimmed = String(orig).trim();
                    if (!trimmed) continue;
                    const normalized = trimmed.replace(/\s+/g, '');
                    if (!normalized) continue;
                    if (!seen.has(normalized)) {
                      seen.add(normalized);
                      // preserve the first encountered, nicely trimmed version as the label
                      originalValues.set(normalized, trimmed);
                    }
                  }

                  // Advance to next page; stop when we get a short page
                  if (data.length < PAGE_SIZE) break;
                  offset += PAGE_SIZE;
                }

                // Sort alphabetically by normalized key
                const values = Array.from(seen).sort();

                // Populate select with original label but normalized value
                values.forEach(normalized => {
                  const opt = document.createElement('option');
                  opt.value = normalized;
                  opt.textContent = originalValues.get(normalized) || normalized; // display with spaces
                  select.appendChild(opt);
                });

                console.log(`Loaded ${values.length} unique Slot Types from emis_apps_raw`);

                // Store the loaded values globally for classification
                window.loadedSlotTypes = Array.from(values).map(norm => originalValues.get(norm) || norm);

                // Trigger classification now that values are fully loaded (no race with pagination)
                try { await ensureClassificationOnce(); } catch (e) { console.warn('Classification failed after loading slot types', e); }

                // If nothing found, show a single disabled option
                if (values.length === 0) {
                  const opt = document.createElement('option');
                  opt.value = '';
                  opt.textContent = 'No Slot Type values found';
                  opt.disabled = true;
                  select.appendChild(opt);
                }

              } catch (err) {
                console.error('Failed to load Slot Type values:', err);
                const select = document.getElementById('emis-slottype-select');
                if (select) {
                  select.innerHTML = '';
                  const opt = document.createElement('option');
                  opt.value = '';
                  opt.textContent = 'Error loading values';
                  opt.disabled = true;
                  select.appendChild(opt);
                }
              }
            }

            // Note: callClassify is now defined at top-level scope
            // Note: aiConnectivityTest is now defined as window.aiConnectivityTest at top-level scope

            async function classifySlotTypes() {
              console.log('═══════════════════════════════════════════════════════════');
              console.log('🔍 CLASSIFICATION DEBUG - FULL TRACE');
              console.log('═══════════════════════════════════════════════════════════');
              
              // Step 1: Check if data is loaded
              console.log('📋 Step 1: Checking loaded slot types...');
              if (!window.loadedSlotTypes || window.loadedSlotTypes.length === 0) {
                console.error('❌ No slot types loaded in window.loadedSlotTypes');
                console.log('   Current value:', window.loadedSlotTypes);
                return;
              }
              console.log(`✅ Found ${window.loadedSlotTypes.length} slot types to classify`);
              console.log('   First 5 slot types:', window.loadedSlotTypes.slice(0, 5));

              console.log('\n🤖 Step 2: Preparing API request...');
              const slotTypesList = window.loadedSlotTypes.join('\n');
              console.log('   Total characters in list:', slotTypesList.length);
              
              const requestBody = {
                text: `You are an expert healthcare appointment scheduler. Below is a list of appointment slot types from an EMIS system. Please classify each into ONE of these categories:
1. "On the day" - Appointments available same-day or urgent/emergency appointments
2. "Within 1 week" - Appointments within the next 7 days (including routine/standard appointments)
3. "Within 2 weeks" - Appointments scheduled 8-14 days ahead (including follow-ups)

Return ONLY valid JSON in this exact format with no other text:
{
  "on_the_day": ["slot_type_1", "slot_type_2"],
  "within_1_week": ["slot_type_3", "slot_type_4"],
  "within_2_weeks": ["slot_type_5", "slot_type_6"]
}

Slot Types to classify:
${slotTypesList}`
              };
              
              console.log('   Request body size:', JSON.stringify(requestBody).length, 'bytes');
              console.log('   Target Function: classify-slot-types at', (window.CONFIG && window.CONFIG.SUPABASE_URL ? window.CONFIG.SUPABASE_URL + '/functions/v1/classify-slot-types' : '(missing CONFIG.SUPABASE_URL)'));
              try { window.lastAIRequest = JSON.stringify({ slot_types: window.loadedSlotTypes, format: { on_the_day: [], within_1_week: [], within_2_weeks: [] } }, null, 2); } catch(_) {}

              try {
                console.log('\n📡 Step 3: Sending request to Supabase Edge Function...');
                console.log('   Using supabase.functions.invoke("classify-slot-types") with fallback');
                console.log('   Current page origin:', window.location.origin);

                const fnStart = Date.now();
                // Store the request payload for debugging
                window.lastAIRequest = {
                  slotTypes: window.loadedSlotTypes,
                  count: window.loadedSlotTypes.length
                };
                console.log('   Debug: payload sent to function:', { slotTypesCount: window.loadedSlotTypes.length });
                const result = await callClassify(window.loadedSlotTypes);
                const fnDuration = Date.now() - fnStart;
                console.log(`✅ Function call finished (${result.status}) in ${fnDuration}ms`);
                
                // Store the response for debugging
                window.lastAIResponse = result;
                
                if (result.error) {
                  console.error('❌ Function call error:', result.error);
                  throw new Error(result.error.message || String(result.error));
                }

                console.log('\n📦 Step 4: Parsing function response...');
                console.log('   Raw function response:', result.data);
                // If the function provided debug fields with the prompt and raw AI text, surface them in console
                try {
                  if (result.data && result.data.debug) {
                    console.log('   AI prompt sent (server):', result.data.debug.prompt);
                    console.log('   AI raw response (server):', result.data.debug.aiRaw);
                    // Also attach to global debug store for UI panels
                    window.lastAIRequest = result.data.debug.prompt;
                    window.lastAIRawResponse = result.data.debug.aiRaw;
                  } else {
                    // Build a synthetic prompt so the debug panel still shows something meaningful
                    const syntheticPrompt = `SYSTEM: You classify GP appointment "Slot Types" into exactly three buckets (on_the_day, within_1_week, within_2_weeks).\nRules: strict JSON keys and arrays only.\n\nUSER JSON:\n` + JSON.stringify({ slot_types: window.loadedSlotTypes }, null, 2);
                    window.lastAIRequest = syntheticPrompt;
                    // No raw response available if server doesn't forward it
                    if (!window.lastAIRawResponse) window.lastAIRawResponse = '— Raw AI response not provided by server —';
                  }
                } catch (_) {}

                // Auto-print a compact debug summary to the on-screen debugger
                try {
                  console.info('AI REQUEST: (compact preview)');
                  console.log((window.lastAIRequest || '').slice(0, 500) + '...');
                } catch (_) {}
                // The function returns { success: true, classification: { ... } }
                if (!result.data) {
                  throw new Error('Empty response from classify-slot-types function');
                }

                const classification = result.data.classification || result.data || null;
                if (!classification) {
                  console.error('❌ No classification object in function response');
                  throw new Error('Function did not return classification');
                }
                console.log('   Classification keys:', Object.keys(classification));
                console.log('   Full classification:', JSON.stringify(classification, null, 2));

                // Client-side nudge: enforce urgent/emergency slots are in "on_the_day"
                const urgentPattern = /\b(emergency|urgent|same\s*day|book\s*on\s*day|bod)\b/i;
                const nudgedClassification = {
                  on_the_day: [...(classification.on_the_day || [])],
                  within_1_week: [],
                  within_2_weeks: []
                };
                
                // Check within_1_week for urgent slots
                (classification.within_1_week || []).forEach(slot => {
                  if (urgentPattern.test(slot)) {
                    console.log(`🔄 Client nudge: Moving "${slot}" from within_1_week → on_the_day`);
                    nudgedClassification.on_the_day.push(slot);
                  } else {
                    nudgedClassification.within_1_week.push(slot);
                  }
                });
                
                // Check within_2_weeks for urgent slots
                (classification.within_2_weeks || []).forEach(slot => {
                  if (urgentPattern.test(slot)) {
                    console.log(`🔄 Client nudge: Moving "${slot}" from within_2_weeks → on_the_day`);
                    nudgedClassification.on_the_day.push(slot);
                  } else {
                    nudgedClassification.within_2_weeks.push(slot);
                  }
                });
                
                // Dedupe on_the_day in case AI already included some
                nudgedClassification.on_the_day = [...new Set(nudgedClassification.on_the_day)];
                
                console.log('   Classification after client nudge:', JSON.stringify(nudgedClassification, null, 2));

                // Validate structure
                console.log('\n✔️ Step 7: Validating classification structure...');
                const requiredKeys = ['on_the_day', 'within_1_week', 'within_2_weeks'];
                const missingKeys = requiredKeys.filter(k => !(k in nudgedClassification));
                if (missingKeys.length > 0) {
                  console.warn('⚠️ Missing expected keys:', missingKeys);
                } else {
                  console.log('✅ All expected keys present');
                }

                // Store classification globally
                window.slotTypeClassification = nudgedClassification;
                console.log('\n💾 Step 8: Classification stored in window.slotTypeClassification');
                
                // Display classification results in the UI
                displayClassificationResults(nudgedClassification, fnDuration);
                
                console.log('\n✅ ═══════════════════════════════════════════════════════');
                console.log('✅ CLASSIFICATION COMPLETE - SUMMARY');
                console.log('✅ ═══════════════════════════════════════════════════════');
                console.log(`📊 On the day: ${nudgedClassification.on_the_day?.length || 0} types`);
                if (nudgedClassification.on_the_day?.length) {
                  console.log('   →', nudgedClassification.on_the_day.slice(0, 3).join(', '), nudgedClassification.on_the_day.length > 3 ? '...' : '');
                }
                console.log(`📊 Within 1 week: ${nudgedClassification.within_1_week?.length || 0} types`);
                if (nudgedClassification.within_1_week?.length) {
                  console.log('   →', nudgedClassification.within_1_week.slice(0, 3).join(', '), nudgedClassification.within_1_week.length > 3 ? '...' : '');
                }
                console.log(`📊 Within 2 weeks: ${nudgedClassification.within_2_weeks?.length || 0} types`);
                if (nudgedClassification.within_2_weeks?.length) {
                  console.log('   →', nudgedClassification.within_2_weeks.slice(0, 3).join(', '), nudgedClassification.within_2_weeks.length > 3 ? '...' : '');
                }
                console.log('═══════════════════════════════════════════════════════════\n');

                // Return the nudged classification so callers can use it immediately
                return nudgedClassification;

              } catch (err) {
                console.error('\n❌ CLASSIFICATION FAILED', err);
                // Keep classification error available to background logic, but don't inject UI into step 4
                try { window.classificationError = { message: err.message || String(err) }; } catch (_) {}
                throw err;
              }
            }
            
            // Function to display classification results in the UI
            function displayClassificationResults(classification, timingMs) {
              // Store classification for background use and log a concise summary. Do not inject UI into step 4.
              try { window.slotTypeClassification = classification || {}; } catch (_) {}
              try { window.classificationTimingMs = timingMs; } catch (_) {}
              console.log('Appointment types classified (background only). Timing:', timingMs, 'ms');
              console.log('Classification summary:', {
                on_the_day: (classification?.on_the_day || []).length,
                within_1_week: (classification?.within_1_week || []).length,
                within_2_weeks: (classification?.within_2_weeks || []).length
              });
            }
            
            // Make classifySlotTypes globally accessible (callClassify already exposed at top level)
            window.classifySlotTypes = classifySlotTypes;
            
            // Helper to create a category card
            function createCategoryCard(title, items, color) {
              const card = document.createElement('div');
              card.style.padding = '16px';
              card.style.borderRadius = '8px';
              card.style.border = `1px solid ${color}20`;
              card.style.backgroundColor = `${color}08`;
              
              const titleEl = document.createElement('h5');
              titleEl.style.color = color;
              titleEl.style.fontWeight = '600';
              titleEl.style.marginBottom = '10px';
              titleEl.style.display = 'flex';
              titleEl.style.alignItems = 'center';
              titleEl.style.gap = '8px';
              
              const dot = document.createElement('span');
              dot.style.width = '10px';
              dot.style.height = '10px';
              dot.style.borderRadius = '50%';
              dot.style.backgroundColor = color;
              dot.style.display = 'inline-block';
              titleEl.appendChild(dot);
              
              const textSpan = document.createElement('span');
              textSpan.textContent = title;
              titleEl.appendChild(textSpan);
              
              const countSpan = document.createElement('span');
              countSpan.style.fontSize = '12px';
              countSpan.style.backgroundColor = `${color}20`;
              countSpan.style.color = color;
              countSpan.style.padding = '2px 8px';
              countSpan.style.borderRadius = '999px';
              countSpan.style.marginLeft = 'auto';
              countSpan.textContent = items.length;
              titleEl.appendChild(countSpan);
              
              card.appendChild(titleEl);
              
              if (items.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.color = '#64748b';
                emptyMsg.style.fontStyle = 'italic';
                emptyMsg.style.fontSize = '14px';
                emptyMsg.textContent = 'No appointments in this category';
                card.appendChild(emptyMsg);
              } else {
                const list = document.createElement('ul');
                list.style.paddingLeft = '16px';
                list.style.marginBottom = '0';
                list.style.fontSize = '14px';
                list.style.maxHeight = '300px';
                list.style.overflowY = 'auto';
                
                items.forEach(item => {
                  const li = document.createElement('li');
                  li.textContent = item;
                  li.style.marginBottom = '4px';
                  list.appendChild(li);
                });
                
                card.appendChild(list);
              }
              
              return card;
            }

            // Load when step 4 or 5 becomes active
            const observer = new MutationObserver((mutations) => {
              for (const m of mutations) {
                if (m.type === 'attributes' && m.attributeName === 'class') {
                  const target = m.target;
                  if (target && target.dataset) {
                    const step = Number(target.dataset.wstep);
                    if (step === 4 && target.classList.contains('on')) {
                      // Render the Step 4 appointment setup UI (client-only).
                      setTimeout(() => { if (typeof renderStep4Setup === 'function') renderStep4Setup(); }, 150);
                    }
                    if (step === 5 && target.classList.contains('on')) {
                      setTimeout(() => { initAppointmentSetup(); }, 150);
                    }
                  }
                }
              }
            });
            document.querySelectorAll('.wstep').forEach(el => observer.observe(el, { attributes: true }));

            // Elements (ensure refs exist before use)
            const uploadButton = document.getElementById('upload-button');
            const fileInput = document.getElementById('file-input');
            const progressOverlay = document.getElementById('progress-overlay');
            const progressBar = document.getElementById('progress-bar');
            const statusMessage = document.getElementById('status-message');

            // Global state
            let parsedData = null;
            let isUploading = false;


            // Save inline setup (local only for now)
            const setupSave = document.getElementById('welcome-setup-save');
            const setupStatus = document.getElementById('welcome-setup-status');
            if (setupSave) {
              setupSave.addEventListener('click', () => {
                const site = (document.getElementById('welcome-site')||{}).value || '';
                const role = (document.getElementById('welcome-role')||{}).value || '';
                const dna  = (document.getElementById('welcome-dna')||{}).value  || '';
                try {
                  localStorage.setItem('cl_site', site);
                  localStorage.setItem('cl_role', role);
                  localStorage.setItem('cl_dna_threshold', dna);
                } catch(_) {}
                if (setupStatus){ setupStatus.textContent = 'Saved'; }
                launchConfetti(600);
              });
            }

            // Simple confetti
            function launchConfetti(durationMs=800){
              const canvas = document.getElementById('confetti');
              if (!canvas) return;
              const ctx = canvas.getContext('2d');
              const dpr = window.devicePixelRatio || 1;
              const rect = canvas.getBoundingClientRect();
              canvas.width = rect.width * dpr; 
              canvas.height = rect.height * dpr; 
              ctx.scale(dpr,dpr);
              const pieces = Array.from({length: 90}, () => ({
                x: Math.random()*rect.width,
                y: -20 - Math.random()*60,
                r: 4+Math.random()*6,
                vx: -1+Math.random()*2,
                vy: 2+Math.random()*3,
                a: Math.random()*Math.PI,
                va: -0.2+Math.random()*0.4,
              }));
              let start = performance.now();
              function tick(ts){
                const t = ts - start;
                ctx.clearRect(0,0,rect.width,rect.height);
                pieces.forEach(p=>{ 
                  p.x+=p.vx; p.y+=p.vy; p.a+=p.va; 
                  ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); 
                  ctx.fillStyle = `hsl(${Math.random()*360},85%,60%)`; 
                  ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); 
                  ctx.restore(); 
                });
                if (t < durationMs) requestAnimationFrame(tick); else ctx.clearRect(0,0,rect.width,rect.height);
              }
              requestAnimationFrame(tick);
            }

            // Handle upload button click (if present)
            if (uploadButton && fileInput) {
              uploadButton.addEventListener('click', () => {
                if (!isUploading) {
                  fileInput.click();
                }
              });
              // Handle file selection
              fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                  handleFile(this.files[0]);
                }
              });
            }
            
            // Update progress bar with enhanced UI
            function updateProgress(percentage) {
                const pct = Math.max(0, Math.min(100, percentage));
                // Basic progress bar update
                progressBar.style.width = `${pct}%`;
                progressBar.setAttribute('aria-valuenow', pct);
                // Update progress percentage in stats panel and compact status
                const pctText = `${Math.round(pct)}%`;
                const up = document.getElementById('upload-progress');
                if (up) up.textContent = pctText;
                const sp = document.getElementById('status-percent');
                if (sp) sp.textContent = pctText;
                // Update color based on progress
                if (pct < 30) {
                    progressBar.style.background = 'linear-gradient(90deg, #3b82f6, #60a5fa)';
                } else if (pct < 70) {
                    progressBar.style.background = 'linear-gradient(90deg, #0ea5e9, #38bdf8)';
                } else {
                    progressBar.style.background = 'linear-gradient(90deg, #0d9488, #2dd4bf)';
                }
                // Update pips at 0/25/50/75/100
                const pips = document.querySelectorAll('#progress-pips .pip');
                pips.forEach(p => {
                  const th = Number(p.getAttribute('data-threshold')) || 0;
                  p.classList.toggle('on', pct >= th);
                });
            }
            
            // Function to show upload success UI
            function showUploadSuccess(totalUploaded, totalRecords, elapsedTime) {
                const progressContainer = document.getElementById('progress-container');
                const successContainer = document.getElementById('success-container');
                const successStats = document.getElementById('success-stats');
                
                // Hide progress container, show success container
                progressContainer.style.display = 'none';
                successContainer.style.display = 'block';
                
                // Format time nicely
                const timeFormatted = elapsedTime > 60 
                    ? `${Math.floor(elapsedTime/60)}m ${Math.round(elapsedTime%60)}s`
                    : `${Math.round(elapsedTime)}s`;
                
                // Update success stats
                successStats.textContent = `Successfully uploaded ${totalUploaded} of ${totalRecords} records in ${timeFormatted}.`;
                
                // Add success class to parent container
                document.getElementById('progress-overlay').classList.add('success');
            }
            
            // Function to show upload error UI
            function showUploadError(errorMessage) {
                const progressContainer = document.getElementById('progress-container');
                const errorContainer = document.getElementById('error-container');
                const errorDetails = document.getElementById('error-details');
                
                // Hide progress container, show error container
                progressContainer.style.display = 'none';
                errorContainer.style.display = 'block';
                
                // Update error details
                errorDetails.textContent = errorMessage;
                
                // Add error class to parent container
                document.getElementById('progress-overlay').classList.add('error');
            }



            // Process CSV file and auto-upload
            function handleFile(file) {
                if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                    alert('Please upload a CSV file.');
                    return;
                }

                if (isUploading) {
                    alert('Upload already in progress. Please wait.');
                    return;
                }

            // Show progress overlay and update button state (if present)
            if (progressOverlay) progressOverlay.classList.add('show');
            if (uploadButton) {
              uploadButton.classList.add('uploading');
              const sp = uploadButton.querySelector('span');
              if (sp) sp.textContent = 'Uploading...';
            }
            const sm = document.getElementById('status-message');
            if (sm) sm.textContent = 'Reading file...';
            updateProgress(5);

                Papa.parse(file, {
                    header: false,
                    dynamicTyping: false,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const rows = results.data || [];
                        if (!rows.length) {
                            resetUpload();
                            alert('No rows found in CSV.');
                            return;
                        }
                        if (rows.length === 1) {
                            resetUpload();
                            alert('CSV only contains a header row.');
                            return;
                        }

                        const headerRowRaw = rows[0].map(c => (c == null ? '' : String(c)));
                        const dataRows = rows.slice(1);

                        const hasDataInCol = (idx) => dataRows.some(r => {
                            const v = r[idx];
                            return v !== null && v !== undefined && String(v).trim() !== '';
                        });

                        // Find the rightmost empty header that actually has data => this becomes 'Count'
                        let countIdx = -1;
                        for (let i = headerRowRaw.length - 1; i >= 0; i--) {
                            const h = headerRowRaw[i];
                            const isEmpty = !h || h.trim() === '';
                            if (isEmpty && hasDataInCol(i)) { countIdx = i; break; }
                        }

                        // Build cleaned headers + index -> key map
                        const indexToKey = new Array(headerRowRaw.length).fill(null);
                        for (let i = 0; i < headerRowRaw.length; i++) {
                            const h = (headerRowRaw[i] || '').trim();
                            if (h === '') {
                                if (i === countIdx) {
                                    indexToKey[i] = 'Count';
                                }
                            } else {
                                indexToKey[i] = h;
                            }
                        }

                        // Rebuild objects by column index; trim strings; do NOT fill-down
                        parsedData = dataRows.map(r => {
                            const obj = {};
                            for (let i = 0; i < indexToKey.length; i++) {
                                const key = indexToKey[i];
                                if (!key) continue;
                                let val = r[i];
                                if (typeof val === 'string') val = val.trim();
                                obj[key] = (val === '') ? null : val;
                            }
                            return obj;
                        }).filter(row => Object.values(row).some(v => v !== null && v !== undefined && String(v) !== ''));

                        if (!parsedData || parsedData.length === 0) {
                            resetUpload();
                            alert('No valid data found in the CSV file.');
                            return;
                        }

                        // Auto-start upload
                        uploadToSupabase();
                    },
                    error: function(error) {
                        console.error('Error parsing CSV:', error);
                        resetUpload();
                        alert('Error parsing the CSV file. Please check the file format.');
                    }
                });
            }

            function resetUpload() {
              isUploading = false;
              
              // Reset button state
              if (uploadButton) {
                uploadButton.classList.remove('uploading');
                const sp = uploadButton.querySelector('span');
                if (sp) sp.textContent = 'Upload EMIS Data';
              }
              
              // Reset progress overlay
              if (progressOverlay) {
                progressOverlay.classList.remove('show');
                progressOverlay.classList.remove('success');
                progressOverlay.classList.remove('error');
              }
              
              // Reset file input
              if (fileInput) fileInput.value = '';
              parsedData = null;
              
              // Reset progress UI
              updateProgress(0);
              if (statusMessage) {
                statusMessage.textContent = '';
                statusMessage.className = 'text-center';
              }
              
              // Reset all containers to initial state
              document.getElementById('progress-container').style.display = '';
              document.getElementById('progress-container').classList.remove('uploading');
              document.getElementById('success-container').style.display = 'none';
              document.getElementById('error-container').style.display = 'none';
              
              // Reset stats
              document.getElementById('records-processed').textContent = '0';
              document.getElementById('records-total').textContent = '0';
              document.getElementById('upload-progress').textContent = '0%';
              document.getElementById('upload-time').textContent = '0s';
            }

            // Helper for formatting numbers with commas
            function formatNumber(n){
              try { return (n||0).toLocaleString(); } catch(_) { return String(n); }
            }
            // Upload CSV rows mapped to DB columns (underscored), preserve "Count", batch upload
            async function uploadToSupabase() {
                if (!parsedData || parsedData.length === 0) {
                    resetUpload();
                    alert('No data to upload.');
                    return;
                }

                isUploading = true;

                try {
                    document.getElementById('status-message').textContent = 'Preparing upload…';
                    updateProgress(10);

                    // Use CONFIG from config.js instead of hardcoding credentials
                    const supabaseUrl = CONFIG.SUPABASE_URL;
                    const url = `${supabaseUrl}/functions/v1/emis-upload`;
                    const jwtToken = CONFIG.SUPABASE_ANON_KEY;

                    // Map CSV headers -> DB columns (NO fill-down, values as-is)
                    const headerToDb = {
                        "Full Name of the Session Holder of the Session": "full_name_session_holder",
                        "Day of Week": "day_of_week",
                        "Session's Session Start": "session_start",
                        "Session's Session End": "session_end",
                        "Appointment Date": "appointment_date",
                        "Appointment Time": "appointment_time",
                        "Slot Type": "slot_type",
                        "Slot Duration": "slot_duration",
                        "Availability": "availability",
                        "DNA": "dna_status",
                        "Booked Time to Slot Time": "booked_time_to_slot_time",
                        "Arrive Time to Send In Time": "arrive_time_to_send_in_time",
                        "Slot Time to Send In Time": "slot_time_to_send_in_time",
                        "Slot Time to Arrive Time": "slot_time_to_arrive_time",
                        "Consultation Time": "consultation_time",
                        "Count": "Count"
                    };

                    // Build records strictly with DB column names
                    const records = parsedData.map((row, idx) => {
                        const obj = {};
                        
                        // Map columns to the right database fields
                        for (const key in row) {
                            if (Object.prototype.hasOwnProperty.call(headerToDb, key)) {
                                const dbKey = headerToDb[key];
                                let val = row[key];
                                
                                // Data type conversions
                                if (dbKey === 'appointment_date' && val) {
                                    try {
                                        // Parse date properly
                                        const dateParts = val.split('/');
                                        if (dateParts.length === 3) {
                                            // Format is DD/MM/YYYY in the CSV
                                            const day = parseInt(dateParts[0], 10);
                                            const month = parseInt(dateParts[1], 10) - 1; // month is 0-indexed
                                            const year = parseInt(dateParts[2], 10);
                                            
                                            // Validate date values
                                            if (isValidDate(day, month, year)) {
                                                // Create date object and format as YYYY-MM-DD
                                                // Use UTC to avoid timezone issues
                                                const date = new Date(Date.UTC(year, month, day));
                                                val = date.toISOString().split('T')[0]; // YYYY-MM-DD
                                                console.log(`Date converted: ${dateParts.join('/')} → ${val}`);
                                            } else {
                                                console.error(`Invalid date: ${dateParts.join('/')}`);
                                            }
                                        }
                                    } catch (e) {
                                        console.error('Error parsing date:', val, e);
                                    }
                                }
                                
                                obj[dbKey] = val;
                            }
                        }
                        obj.site_id = 2;
                        obj.csv_row_number = idx + 1;
                        return obj;
                    });
                    
                    // Helper functions for date validation
                    function isValidDate(day, month, year) {
                        // Check if date is valid
                        if (month < 0 || month > 11) return false;
                        if (day < 1) return false;
                        
                        // Check days in month (accounting for leap years)
                        const daysInMonth = [31, (isLeapYear(year) ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                        return day <= daysInMonth[month];
                    }
                    
                    function isLeapYear(year) {
                        return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
                    }

                    // Setup tracking variables
                    const batchSize = 25;
                    const totalBatches = Math.ceil(records.length / batchSize);
                    let totalUploaded = 0;
                    const startTime = new Date();
                    
                    // Set initial stats
                    document.getElementById('records-total').textContent = formatNumber(records.length);
                    document.getElementById('records-processed').textContent = '0';
                    document.getElementById('progress-container').classList.add('uploading');
                    
                    // Process in batches for reliability
                    for (let i = 0; i < totalBatches; i++) {
                        const start = i * batchSize;
                        const end = Math.min((i + 1) * batchSize, records.length);
                        const batch = records.slice(start, end);

                        // Update stats before fetch
                        document.getElementById('status-message').textContent = 'Uploading…';
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${jwtToken}`
                            },
                            body: JSON.stringify({ records: batch })
                        });

                        if (!response.ok) {
                            let msg = response.statusText || 'Unknown server error';
                            try {
                                const res = await response.json();
                                if (res && (res.error || res.message)) msg = res.error || res.message;
                            } catch {}
                            throw new Error(`Server error ${response.status}: ${msg}`);
                        }

                        // Update progress and stats
                        totalUploaded += batch.length;
                        const prog = 10 + ((i + 1) / totalBatches) * 90;
                        updateProgress(prog);
                        
                        // Update stats panel with live data (no flashing X/Y in status)
                        document.getElementById('records-processed').textContent = formatNumber(totalUploaded);
                        const sm = document.getElementById('status-message');
                        if (sm && sm.textContent !== 'Uploading…') sm.textContent = 'Uploading…';
                        
                        // Update time elapsed
                        const currentTime = new Date();
                        const elapsedSeconds = (currentTime - startTime) / 1000;
                        document.getElementById('upload-time').textContent = 
                            elapsedSeconds > 60 
                                ? `${Math.floor(elapsedSeconds/60)}m ${Math.round(elapsedSeconds%60)}s`
                                : `${Math.round(elapsedSeconds)}s`;
                        
                        // Add a small delay between batches for UI updates
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }

                    // Calculate final elapsed time
                    const endTime = new Date();
                    const totalElapsedSeconds = (endTime - startTime) / 1000;
                    
                    // Update UI to 100%
                    updateProgress(100);
                    
                    // Show success interface
                    showUploadSuccess(totalUploaded, records.length, totalElapsedSeconds);
                    
                    // Reset after 8 seconds
                    setTimeout(() => {
                        resetUpload();
                    }, 8000);

                } catch (error) {
                    // Show error interface
                    showUploadError(error.message);
                    
                    // Reset after 8 seconds on error
                    setTimeout(() => {
                        resetUpload();
                    }, 8000);
                }
            }
        });
    </script>

    <!-- Bottom-left user avatar: exact copy of admin dashboard styling -->
    <style>
    /* CSS Variables (same as admin dashboard) */
    :root {
      --accent: #0ea5e9;
      --accent-2: #38bdf8;
      --panel-bg: #ffffff;
      --border-color: #e2e8f0;
      --ink: #0f172a;
      --muted: #64748b;
    }
    
    /* User avatar - exact copy from admin dashboard */
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      transition: transform 0.15s ease;
      flex-shrink: 0;
      cursor: pointer;
      position: fixed;
      right: 18px;
      top: 12px;
      z-index: 9999;
    }
    /* Presence indicator (admin dashboard style) */
    .user-avatar { position: fixed; }
    /* .user-avatar::after {
      content: '';
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 16px;
      height: 16px;
      background: #41d656; 
      border: 2px solid var(--panel-bg);
      border-radius: 50%;
    } */
    .user-avatar.inactive::after { background: var(--muted); }
    .user-avatar:hover { transform: scale(1.04); }
    
    /* User popover - same styling as email-popover */
    .user-popover {
      position: fixed;
      right: 18px;
      top: 62px;
      min-width: 260px;
      max-width: 360px;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(2,6,23,0.25);
      color: var(--ink);
      z-index: 10000;
      transform-origin: top right;
      animation: popIn .18s cubic-bezier(.2,.9,.2,1);
      display: none;
    }
    
    @keyframes popIn {
      from { transform: scale(.92) translateY(6px); opacity: 0; }
      to { transform: scale(1) translateY(0); opacity: 1; }
    }
    
    /* Appointment setup styles */
    .setup-grid { 
      margin-top: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
    }
    #appt-setup-grid {
      width: 100%;
      border-collapse: collapse;
    }
    #appt-setup-grid thead th {
      text-align: left;
      font-size: 12px;
      color: #64748b;
      padding: 10px 8px;
      background: #f8fafc;
      border-bottom: 1px solid #eef2f7;
    }
    #appt-setup-grid tbody td {
      padding: 10px 8px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
    }
    #appt-setup-grid .cat-name {
      font-weight: 600;
      color: #0f172a;
    }
    #appt-setup-grid select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      color: #0f172a;
      font-size: 13px;
    }
    .setup-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      justify-content: flex-start;
    }
    #appt-save {
      background: #3b82f6;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      border: none;
      cursor: pointer;
    }
    #appt-match-all, #appt-clear {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      border: 1px solid #e2e8f0;
      background: white;
      color: #334155;
      cursor: pointer;
    }
    .wizard-nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }
    #appt-back {
      background: white;
      color: #334155;
      padding: 8px 24px;
      border-radius: 6px;
      font-weight: 500;
      border: 1px solid #e2e8f0;
      cursor: pointer;
    }
    #appt-finish {
      background: #3b82f6;
      color: white;
      padding: 8px 24px;
      border-radius: 6px;
      font-weight: 500;
      border: none;
      cursor: pointer;
    }
    .row-confirmed {
      background: #f0fdf4;
    }
    
    .user-popover .user-email {
      font-weight: 600;
      color: var(--ink);
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .user-popover .user-role {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 12px;
    }
    
    .user-popover .btn-signout {
      width: 100%;
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: transparent;
      color: var(--ink);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .user-popover .btn-signout:hover {
      background: #f8fafc;
      border-color: var(--muted);
    }
    </style>

    <!-- User avatar in bottom-left (exact copy of admin dashboard structure) -->
    <div class="user-avatar" id="user-avatar" title="User menu" aria-haspopup="true" aria-expanded="false">
      <span id="user-initials">U</span>
    </div>
    
    <!-- User popover -->
    <div class="user-popover" id="user-popover" role="dialog" aria-hidden="true">
      <div class="user-email" id="user-email">—</div>
      <div class="user-role" id="user-role">—</div>
      <button class="btn-signout" id="btn-signout">Sign out</button>
    </div>
  </div>

  
  <!-- On-screen debug UI -->
  <style>
    #debug-toggle{position:fixed;left:12px;bottom:12px;width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#2563eb,#1d4ed8);color:#fff;display:grid;place-items:center;z-index:11000;cursor:pointer;box-shadow:0 8px 22px rgba(37,99,235,.18);font-weight:700}
    #debug-panel{position:fixed;left:12px;bottom:68px;width:460px;max-height:44vh;background:rgba(255,255,255,0.98);border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 12px 30px rgba(2,6,23,.2);padding:8px;z-index:11000;display:none;overflow:hidden;font-family:monospace}
    #debug-panel .dbg-hd{display:flex;align-items:center;justify-content:space-between;padding:6px 4px 8px 4px;border-bottom:1px solid #eef2f7}
    #debug-panel .dbg-hd .title{font-weight:700;color:#0f172a}
    #debug-panel .dbg-actions button{margin-left:6px;padding:6px 8px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;cursor:pointer}
    #debug-logs{overflow:auto;padding:6px;max-height:calc(44vh - 56px);font-size:12px;color:#0f172a}
    .debug-line{padding:6px;border-bottom:1px solid #f6f8fb;white-space:pre-wrap}
    .debug-log{color:#0f172a}
    .debug-info{color:#0b74c9}
    .debug-warn{color:#b45309}
    .debug-error{color:#dc2626}
  </style>

  <div id="debug-toggle" title="Toggle debug">🐞</div>
  <div id="debug-panel" aria-hidden="true">
    <div class="dbg-hd">
      <div class="title">Debug</div>
      <div class="dbg-actions">
        <button id="debug-clear" type="button">Clear</button>
        <button id="debug-copy" type="button">Copy</button>
        <button id="debug-close" type="button">Close</button>
        <button id="debug-ai-req" type="button">AI Req</button>
        <button id="debug-ai-res" type="button">AI Res</button>
        <button id="debug-ai-class" type="button">AI Class</button>
      </div>
    </div>
    <div id="debug-logs" role="log" aria-live="polite"></div>
  </div>

  <script>
    (function(){
      const MAX_LINES = 1000;
      const toggle = document.getElementById('debug-toggle');
      const panel = document.getElementById('debug-panel');
      const logs = document.getElementById('debug-logs');
      const clearBtn = document.getElementById('debug-clear');
      const copyBtn = document.getElementById('debug-copy');
      const closeBtn = document.getElementById('debug-close');
    const aiReqBtn = document.getElementById('debug-ai-req');
    const aiResBtn = document.getElementById('debug-ai-res');
    const aiClassBtn = document.getElementById('debug-ai-class');

      function formatArg(a){
        try {
          if (typeof a === 'string') return a;
          return JSON.stringify(a);
        } catch(e){ return String(a); }
      }

      function append(level, args){
        try{
          if (!logs) return;
          const el = document.createElement('div');
          el.className = 'debug-line debug-' + level;
          const t = new Date();
          const ts = t.toISOString().replace('T',' ').split('.')[0];
          const text = args.map(formatArg).join(' ');
          el.textContent = `[${ts}] ${level.toUpperCase()}: ${text}`;
          logs.appendChild(el);
          // trim
          while(logs.childNodes.length > MAX_LINES) logs.removeChild(logs.firstChild);
          logs.scrollTop = logs.scrollHeight;
        }catch(e){/* ignore */}
      }

      // Wrap console methods
      ['log','info','warn','error'].forEach((method)=>{
        const orig = console[method] && console[method].bind(console) || function(){};
        console[method] = function(...args){
          try{ append(method, args); }catch(e){}
          try{ orig(...args); }catch(e){}
        };
      });

      // Global error handlers
      window.addEventListener('error', (ev)=>{
        try{ console.error(ev.message + ' @ ' + (ev.filename||'') + ':' + (ev.lineno||'') ); }catch(e){}
      });
      window.addEventListener('unhandledrejection', (ev)=>{
        try{ console.error('UnhandledRejection', ev.reason); }catch(e){}
      });

      // Toggle behaviour
      toggle.addEventListener('click', ()=>{
        if (!panel) return;
        const showing = panel.style.display === 'block';
        panel.style.display = showing ? 'none' : 'block';
        panel.setAttribute('aria-hidden', showing ? 'true' : 'false');
      });
      closeBtn.addEventListener('click', ()=>{ panel.style.display = 'none'; panel.setAttribute('aria-hidden','true'); });
      clearBtn.addEventListener('click', ()=>{ if (logs) logs.innerHTML = ''; });
      copyBtn.addEventListener('click', async ()=>{
        try{
          const text = Array.from(logs.children).map(ch=>ch.textContent).join('\n');
          await navigator.clipboard.writeText(text);
          const orig = copyBtn.textContent;
          copyBtn.textContent = 'Copied!';
          setTimeout(()=>{ copyBtn.textContent = orig; }, 1500);
        }catch(e){ 
          console.error('Copy failed:', e);
          alert('Copy failed: ' + e.message); 
        }
      });

      // make sure panel exists before any early logs
      console.log('Debug panel initialized');

      // Wire AI debug buttons (show prompt, raw response, and classification in-panel)
      try {
        if (aiReqBtn) aiReqBtn.addEventListener('click', () => {
          try {
            const txt = window.lastAIRequest || '— No AI request captured —';
            append('info', ['AI REQUEST:']);
            append('log', [txt]);
          } catch (e) { append('error', ['Failed to show AI request', e.message || e]); }
        });

        if (aiResBtn) aiResBtn.addEventListener('click', () => {
          try {
            const txt = window.lastAIRawResponse || '— No AI raw response captured —';
            append('info', ['AI RAW RESPONSE:']);
            append('log', [txt]);
          } catch (e) { append('error', ['Failed to show AI raw response', e.message || e]); }
        });

        if (aiClassBtn) aiClassBtn.addEventListener('click', () => {
          try {
            const cls = window.slotTypeClassification || window.classificationError || null;
            append('info', ['AI CLASSIFICATION (window.slotTypeClassification):']);
            append('log', [JSON.stringify(cls, null, 2) || '— none —']);
          } catch (e) { append('error', ['Failed to show classification', e.message || e]); }
        });
      } catch (e) { /* ignore wiring errors */ }
    })();
  </script>

  <script>
    // User avatar functionality — synced with admin dashboard
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const userAvatar = document.getElementById('user-avatar');
        const userPopover = document.getElementById('user-popover');
        const userInitials = document.getElementById('user-initials');
        const userEmailEl = document.getElementById('user-email'); // will show NAME here
        const userRoleEl = document.getElementById('user-role');
        const btnSignout = document.getElementById('btn-signout');

        const sb = window.supabase || (window.getSupabase && window.getSupabase());
        if (!sb) return;

        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
          sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
          window.location.replace('admin-login.html');
          return;
        }

        const user = session.user;

        // Load profile
        let profile = null;
        try {
          const { data } = await sb
            .from('master_users')
            .select('site_id, access_type, full_name, avatar_url')
            .eq('auth_user_id', user.id)
            .maybeSingle();
          profile = data || null;
        } catch (e) { console.error('Profile fetch error:', e); }

        // Build display name exactly like admin dashboard
        let displayName = profile?.full_name ||
                          user?.user_metadata?.nickname ||
                          user?.user_metadata?.full_name ||
                          user?.user_metadata?.name ||
                          (user.email ? user.email.split('@')[0]
                            .replace(/[._-]/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase()) : 'User');

        // Set initials (first + last) like admin dashboard
        const baseName = displayName || user.email || 'User';
        const parts = baseName.trim().split(' ');
        const initials = parts.length >= 2
          ? (parts[0][0] + parts[parts.length - 1][0]).toUpperCase()
          : baseName.substring(0, 2).toUpperCase();
        if (userInitials) userInitials.textContent = initials;

        // Prefer stored avatar URL, fallback to user metadata
        try {
          let avatarUrl = profile?.avatar_url || user?.user_metadata?.avatar_url || null;
          if (!avatarUrl) {
            try {
              const { data: saw } = await sb
                .from('master_users')
                .select('avatar_url, updated_at')
                .eq('auth_user_id', user.id)
                .order('updated_at', { ascending: false })
                .limit(1)
                .maybeSingle();
              avatarUrl = saw?.avatar_url || avatarUrl;
            } catch (_) {}
          }
          if (avatarUrl) {
            let img = userAvatar.querySelector('img');
            if (!img) {
              img = document.createElement('img');
              img.alt = 'Avatar';
              img.style.width = '100%';
              img.style.height = '100%';
              img.style.borderRadius = '50%';
              img.style.objectFit = 'cover';
              userAvatar.appendChild(img);
            }
            img.src = avatarUrl;
            if (userInitials) userInitials.style.display = 'none';
          }
        } catch (e) { console.warn('Avatar render failed', e); }

        // Role text exactly like admin dashboard, but without email override
        let detectedRole = String(profile?.access_type || user?.user_metadata?.role || '').toLowerCase();
        let roleText = (detectedRole === 'admin' || detectedRole === 'owner')
                        ? 'Admin'
                        : (detectedRole ? detectedRole.charAt(0).toUpperCase() + detectedRole.slice(1) : 'Staff');

        // Site name (same fallback)
        let siteName = '';
        try {
          if (profile?.site_id) {
            const { data: site } = await sb
              .from('sites')
              .select('name')
              .eq('id', profile.site_id)
              .maybeSingle();
            siteName = site?.name || '';
          } else {
            siteName = 'Harley Street Medical Centre';
          }
        } catch (_) {}

        // Populate popover text — NAME on first line, then `Role  Site`
        if (userEmailEl) userEmailEl.textContent = displayName;
        if (userRoleEl) userRoleEl.textContent = siteName ? `${roleText}  ${siteName}` : roleText;

        // Toggle popover
        userAvatar.addEventListener('click', (e) => {
          e.stopPropagation();
          const isVisible = userPopover.style.display === 'block';
          document.querySelectorAll('.user-popover').forEach(p => { if (p !== userPopover) p.style.display = 'none'; });
          userPopover.style.display = isVisible ? 'none' : 'block';
          userAvatar.setAttribute('aria-expanded', !isVisible);
        });
        document.addEventListener('click', (e) => {
          if (!userAvatar.contains(e.target) && !userPopover.contains(e.target)) {
            userPopover.style.display = 'none';
            userAvatar.setAttribute('aria-expanded', false);
          }
        });

        // Sign out handler
        btnSignout.addEventListener('click', async () => {
          try { await sb.auth.signOut(); } catch(e) { console.error('Sign out failed', e); }
          window.location.replace('home.html');
        });

      } catch (err) {
        console.error('User avatar init error', err);
      }
    });
  </script>

  
</body>
</html>

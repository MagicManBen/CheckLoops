<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Holiday Save Functionality</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .info {
            color: blue;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Test Holiday Save Functionality</h1>

    <div class="test-section">
        <h2>1. Initialize Supabase Connection</h2>
        <button onclick="initSupabase()">Connect to Supabase</button>
        <div id="init-result"></div>
    </div>

    <div class="test-section">
        <h2>2. Test Read Data</h2>
        <button onclick="testReadData()">Read Master Users</button>
        <div id="read-result"></div>
    </div>

    <div class="test-section">
        <h2>3. Test Save Single Row</h2>
        <button onclick="testSaveRow()">Test Save Row</button>
        <div id="save-result"></div>
    </div>

    <div class="test-section">
        <h2>4. Test Bulk Save</h2>
        <button onclick="testBulkSave()">Test Bulk Save</button>
        <div id="bulk-result"></div>
    </div>

    <div class="test-section">
        <h2>5. Verify Data Persistence</h2>
        <button onclick="verifyPersistence()">Check if Data Persisted</button>
        <div id="verify-result"></div>
    </div>

    <script>
        let supabase = null;
        let testUserId = null;
        let originalData = null;

        // Initialize Supabase
        async function initSupabase() {
            const resultDiv = document.getElementById('init-result');
            try {
                resultDiv.innerHTML = '<span class="info">Connecting to Supabase...</span>';

                supabase = window.supabase.createClient(
                    'https://tvjrtsrgthuictxqvoau.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2anJ0c3JndGh1aWN0eHF2b2F1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgxMzIwMDksImV4cCI6MjA0MzcwODAwOX0.-fDv3r24RJgSZqMLjZ-nW6r0j8DM3TnvhRdbRmN9bSU'
                );

                // Test connection
                const { data, error } = await supabase.from('master_users').select('count').single();

                if (error) throw error;

                resultDiv.innerHTML = '<span class="success">✅ Connected to Supabase successfully!</span>';
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Failed to connect: ${error.message}</span>`;
            }
        }

        // Test reading data
        async function testReadData() {
            const resultDiv = document.getElementById('read-result');
            if (!supabase) {
                resultDiv.innerHTML = '<span class="error">Please initialize Supabase first!</span>';
                return;
            }

            try {
                resultDiv.innerHTML = '<span class="info">Reading master_users table...</span>';

                const { data, error } = await supabase
                    .from('master_users')
                    .select('id, auth_user_id, full_name, holiday_multiplier, manual_override, total_holiday_entitlement, holiday_remaining')
                    .eq('site_id', 2)
                    .limit(5);

                if (error) throw error;

                if (data && data.length > 0) {
                    testUserId = data[0].auth_user_id;
                    originalData = { ...data[0] };

                    resultDiv.innerHTML = `
                        <span class="success">✅ Successfully read ${data.length} users</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = '<span class="error">No users found in site_id 2</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Read failed: ${error.message}</span>`;
            }
        }

        // Test saving a single row
        async function testSaveRow() {
            const resultDiv = document.getElementById('save-result');
            if (!supabase || !testUserId) {
                resultDiv.innerHTML = '<span class="error">Please read data first to get a test user!</span>';
                return;
            }

            try {
                resultDiv.innerHTML = '<span class="info">Saving test data for user...</span>';

                // Test values
                const testMultiplier = 12;
                const testEntitlement = 480; // Assuming 40 hours/week * 12
                const testRemaining = 400;

                const updateData = {
                    holiday_multiplier: testMultiplier,
                    manual_override: false,
                    total_holiday_entitlement: testEntitlement,
                    holiday_entitlement: testEntitlement,
                    holiday_remaining: testRemaining
                };

                console.log('Saving test data:', { testUserId, updateData });

                const { data, error } = await supabase
                    .from('master_users')
                    .update(updateData)
                    .eq('auth_user_id', testUserId)
                    .select();

                if (error) throw error;

                resultDiv.innerHTML = `
                    <span class="success">✅ Successfully saved row!</span>
                    <pre>Updated data: ${JSON.stringify(updateData, null, 2)}</pre>
                    <pre>Response: ${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Save failed: ${error.message}</span>`;
            }
        }

        // Test bulk save
        async function testBulkSave() {
            const resultDiv = document.getElementById('bulk-result');
            if (!supabase) {
                resultDiv.innerHTML = '<span class="error">Please initialize Supabase first!</span>';
                return;
            }

            try {
                resultDiv.innerHTML = '<span class="info">Testing bulk save...</span>';

                // Get multiple users to update
                const { data: users, error: fetchError } = await supabase
                    .from('master_users')
                    .select('auth_user_id')
                    .eq('site_id', 2)
                    .limit(3);

                if (fetchError) throw fetchError;

                if (!users || users.length === 0) {
                    resultDiv.innerHTML = '<span class="error">No users found to test bulk save</span>';
                    return;
                }

                // Update each user
                const results = [];
                for (const user of users) {
                    const { data, error } = await supabase
                        .from('master_users')
                        .update({
                            holiday_multiplier: 10,
                            manual_override: false
                        })
                        .eq('auth_user_id', user.auth_user_id)
                        .select();

                    results.push({ userId: user.auth_user_id, success: !error, error });
                }

                const successCount = results.filter(r => r.success).length;
                const errorCount = results.filter(r => !r.success).length;

                resultDiv.innerHTML = `
                    <span class="success">✅ Bulk save completed!</span>
                    <div>Success: ${successCount}, Errors: ${errorCount}</div>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Bulk save failed: ${error.message}</span>`;
            }
        }

        // Verify data persistence
        async function verifyPersistence() {
            const resultDiv = document.getElementById('verify-result');
            if (!supabase || !testUserId) {
                resultDiv.innerHTML = '<span class="error">Please run tests first!</span>';
                return;
            }

            try {
                resultDiv.innerHTML = '<span class="info">Checking if changes persisted...</span>';

                const { data, error } = await supabase
                    .from('master_users')
                    .select('holiday_multiplier, manual_override, total_holiday_entitlement, holiday_remaining')
                    .eq('auth_user_id', testUserId)
                    .single();

                if (error) throw error;

                const isPersisted = data.holiday_multiplier === 12; // Check if our test value persisted

                resultDiv.innerHTML = `
                    <span class="${isPersisted ? 'success' : 'error'}">
                        ${isPersisted ? '✅ Data persisted successfully!' : '❌ Data did not persist'}
                    </span>
                    <pre>Current data: ${JSON.stringify(data, null, 2)}</pre>
                    <pre>Original data: ${JSON.stringify(originalData, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Verification failed: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
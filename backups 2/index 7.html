<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CheckLoop — Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="config.js"></script>
<script>
  // Configure PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<script>
// Move existing help icons into a neat top-right badge per page header
document.addEventListener('DOMContentLoaded', () => {
  // Find all help-icon buttons that call showHelp('view-...')
  const icons = Array.from(document.querySelectorAll('button.help-icon'));
  icons.forEach(btn => {
    // Extract view id from onclick attribute if present
    const onclick = btn.getAttribute('onclick') || '';
    const m = onclick.match(/showHelp\(['"]([^'"]+)['"]\)/);
    if (!m) return;
    const viewId = m[1];

    // Find nearest .page-header ancestor
    const header = btn.closest('.page-header');
    if (!header) return;

    // Avoid adding multiple badges
    if (header.querySelector('.page-help-badge')) {
      btn.remove();
      return;
    }

  // Create badge (letter i) to sit immediately to the right of the page title
    const badge = document.createElement('button');
    badge.className = 'page-help-badge';
    badge.setAttribute('aria-label', 'Page help');
    badge.title = 'Page help';
    // Use a compact eye glyph for clarity
  badge.innerHTML = 'i';
    badge.addEventListener('click', (e) => {
      e.preventDefault();
      showHelp(viewId);
    });

    // If the header uses a light panel background, give the badge a light variant
    const panelBg = getComputedStyle(header).backgroundColor || '';
    // crude check for very light backgrounds
    if (panelBg.startsWith('rgb(')) {
      const nums = panelBg.replace(/[rgba\(\) ]/g, '').split(',').map(n=>parseFloat(n));
      const avg = (nums[0] + nums[1] + nums[2]) / 3;
      if (avg > 220) badge.classList.add('light');
    }

    // Insert badge into the page title wrapper so it sits right of the title
    const titleWrapper = header.querySelector('.page-title-wrapper');
    if (titleWrapper) {
      titleWrapper.appendChild(badge);
    } else {
      header.appendChild(badge);
    }

    // Remove original button
    btn.remove();
  });
});
</script>
<script>
  // ——— Training Matrix bootstrapper: detect ctx later and retry load ———
  (function(){
    // Ensure a safe debugLog exists early to avoid ReferenceErrors
    window.debugLog = window.debugLog || function(){ try { console.log('[DBG]', ...arguments); } catch(e){} };
    function hasSiteCtx(){
      return typeof window.ctx === 'object' && window.ctx && Number(window.ctx.site_id) > 0;
    }
    function tryLoadTrainingMatrix(tag){
      if (!('loadTrainingMatrix' in window)) return false;
      if (!hasSiteCtx()) return false;
      try{
        console.info('[training-shim] triggering loadTrainingMatrix()', { tag, site_id: window.ctx.site_id });
        window.loadTrainingMatrix();
        return true;
      }catch(e){ console.warn('[training-shim] loadTrainingMatrix threw', e); return false; }
    }

    // 1) Intercept profile fetch to learn ctx when it arrives
    const _fetch = window.fetch;
    window.fetch = async function(input, init){
      const res = await _fetch(input, init);
      try{
        const url = (typeof input === 'string') ? input : input.url;
        if (url && url.includes('/rest/v1/profiles') && res.ok){
          const clone = res.clone();
          const data = await clone.json();
          const row = Array.isArray(data) ? data[0] : data;
          if (row && (row.site_id || row.role || row.full_name)){
            window.ctx = Object.assign({}, window.ctx || {}, {
              site_id: row.site_id ?? window.ctx?.site_id,
              role: row.role ?? window.ctx?.role,
              full_name: row.full_name ?? window.ctx?.full_name
            });
            if (row.site_id) localStorage.setItem('site_id', String(row.site_id));
            console.info('[training-shim] ctx learned from profiles', window.ctx);
            window.dispatchEvent(new CustomEvent('ctx-ready', { detail: window.ctx }));
            tryLoadTrainingMatrix('profiles-fetch');
          }
        }
      }catch(e){ /*ignore*/ }
      return res;
    };

    // 2) When someone signals ctx readiness
    window.addEventListener('ctx-ready', () => tryLoadTrainingMatrix('ctx-ready'));

    // 3) When the Training nav is clicked, attempt now and again after a short delay
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-section="training"], button');
      if (!btn) return;
      const label = (btn.getAttribute('data-section') || btn.textContent || '').toLowerCase();
      if (label.includes('training')){
        setTimeout(() => tryLoadTrainingMatrix('nav-click'), 50);
        setTimeout(() => tryLoadTrainingMatrix('nav-click-delay'), 400);
      }
    });

    // 4) Safety timer: if the view shows a spinner for >2s after page load, retry
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const trainingView = document.querySelector('#view-training');
        if (!trainingView) return;
        const text = (trainingView.textContent || '').toLowerCase();
        if (text.includes('loading training matrix')){
          tryLoadTrainingMatrix('post-load-timeout');
        }
      }, 2000);
    });

    // 5) Additional retry after authentication completes
    document.addEventListener('ctx-ready', () => {
      console.log('[training-shim] ctx-ready event received, retrying training matrix load');
      setTimeout(() => tryLoadTrainingMatrix('ctx-ready-event'), 100);
    });
  })();
</script>
<script>
  // ——— Minimal ctx shim so modules like the Training Matrix don't stall when ctx isn't built yet ———
  (function ensureCtx(){
    try{
      // If a valid ctx already exists, do nothing
      if (typeof window.ctx === 'object' && window.ctx && window.ctx.site_id) return;

      // Pull hints from config.js and/or localStorage
      const siteIdFromConfig = (typeof window.SITE_ID !== 'undefined' && window.SITE_ID !== null && window.SITE_ID !== '') ? Number(window.SITE_ID) : null;
      const siteIdFromStorage = Number(localStorage.getItem('site_id')) || null;
      const siteNameFromConfig = (typeof window.SITE_NAME !== 'undefined' && window.SITE_NAME) ? window.SITE_NAME : null;
      const siteNameFromStorage = localStorage.getItem('site_name') || null;
      const roleFromStorage = localStorage.getItem('role') || undefined;

      const site_id = siteIdFromConfig || siteIdFromStorage || null;
      const site_name = siteNameFromConfig || siteNameFromStorage || undefined;

      if (site_id){
        // Build a minimal ctx so feature loaders can proceed
        window.ctx = Object.assign({}, window.ctx || {}, { site_id, site_name, role: roleFromStorage });
        console.info('[ctx-shim] Using fallback ctx', window.ctx);
      } else {
        // No site context available — replace endless spinners with a helpful message
        console.warn('[ctx-shim] No site context available. Training matrix will show an error instead of infinite loading.');
        document.addEventListener('DOMContentLoaded', () => {
          const container = document.querySelector('#view-training .training-matrix, #view-training .table-wrap, #view-training .panel, #view-training');
          if (container && !container.__ctxShimMsg){
            container.__ctxShimMsg = true;
            const msg = document.createElement('div');
            msg.className = 'panel';
            msg.style.padding = '16px';
            msg.style.borderRadius = '12px';
            msg.innerHTML = '<strong>Cannot determine site context.</strong> Please sign in again or choose a site. (<em>ctx</em> is missing)';
            // Prefer to append into a panel body; otherwise, just insert
            if (container.firstChild) {
              container.insertBefore(msg, container.firstChild);
            } else {
              container.appendChild(msg);
            }
          }
        });
      }
    }catch(e){ console.error('[ctx-shim] failed', e); }
  })();
</script>
<style>
  :root{
    --bg1:#0b4fb3; --bg2:#062b6f; --glass:#ffffff12; --glass-2:#ffffff1a;
    --white:#e6f0ff; --muted:#b8c7e8; --ink:#eaf1ff;
    --accent:#76a7ff; --accent-2:#5f96ff; --success:#2bd4a7; --danger:#ff6b6b;
    --warning: #ffca28;
    --shadow: 0 10px 30px rgba(6,43,111,.35);
    --round:18px;
    --panel-bg: linear-gradient(145deg, #133b8a, #0c275e);
    --border-color: #ffffff1f;
    --stat-1-bg: #8e6eff33; --stat-1-color: #c4b5fd;
    --stat-2-bg: #2bd4a733; --stat-2-color: #6ee7b7;
    --stat-3-bg: #ffca2833; --stat-3-color: #ffe082;
    --stat-4-bg: #ff6b6b33; --stat-4-color: #fca5a5;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--ink); background:#0b3a86; overflow-x:hidden;
  }
  /* Silky animated background */
  .bg{
    position:fixed; inset:0; z-index:-1; overflow:hidden; background: radial-gradient(1200px 700px at 20% -10%, #6aa0ff33, transparent),
      radial-gradient(900px 600px at 90% 10%, #3566ff2e, transparent),
      linear-gradient(180deg, #0e3f93 0%, #082a69 100%);
  }
  .wave{
    position:absolute; width:160%; height:160%; left:-30%; top:-30%;
    background: conic-gradient(from 180deg at 50% 50%, #2c63ff22, #143a9622, #2c63ff22);
    filter: blur(60px);
    animation: drift 22s ease-in-out infinite alternate;
    transform-origin: 50% 50%;
  }
  .wave2{ animation-duration: 28s; mix-blend-mode: screen; }
  @keyframes drift{
    0%{ transform: rotate(0deg) scale(1.0); }
    100%{ transform: rotate(25deg) scale(1.08); }
  }

  /* Layout */
  .app{ display:grid; --sidebarW:260px; grid-template-columns: var(--sidebarW) minmax(0, 1fr); gap:22px; padding:22px; min-height:100vh; transition: grid-template-columns .2s ease; }
  .app.collapsed{ --sidebarW:56px; }
  /* Disable transitions during resize for smooth dragging */
  .app.is-resizing { transition: none !important; }
  .sidebar{
    background: linear-gradient(180deg, #1a4ea8 0%, #0e367e 100%);
    border-radius:20px; box-shadow: var(--shadow); padding:14px;
    transition: width 0.2s;
  }
  .app.collapsed #sidebar {
    overflow-x: hidden;
    padding-left: 6px;
    padding-right: 6px;
  }
  /* When collapsed, ensure the toggle remains visible and centered at the top */
  .app.collapsed #sidebar > .sidebar-toggle { float: none; display: inline-grid; margin: 10px auto; }
  .app.collapsed #sidebar .brand .t,
  .app.collapsed #sidebar .brand .hint,
  .app.collapsed #sidebar .menu-item-label { display:none; }
  .app.collapsed #sidebar .nav button{ justify-content:center; gap:0; padding:10px; }
  .app.collapsed #sidebar .icon{ margin:0; }
  .sidebar-toggle {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--white);
    margin: 8px 6px;
    padding: 8px;
    display: inline-grid;
    place-items: center;
    border-radius: 10px;
    transition: transform .18s ease, background .12s ease, color .12s ease;
    background: transparent;
  }
  .sidebar-toggle:focus { outline: 2px solid var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,.12); }
  .sidebar-toggle:hover { background: #ffffff12; }
  .sidebar-toggle-icon { color: var(--white); width:18px; height:18px; display:block; transition: transform .22s ease; }
  /* When the app is collapsed, rotate the chevron to point the other direction */
  .app.collapsed .sidebar-toggle-icon { transform: rotate(180deg); }

  /* Position the toggle visually near the top-right of the sidebar but keep it in the DOM flow */
  .sidebar > .sidebar-toggle { float: right; margin-top: 10px; margin-right: 6px; }
  .brand{ display:flex; align-items:center; gap:10px; padding:10px 12px 16px; }
  .brand .logo{ width:32px; height:32px; border-radius:10px; object-fit:contain; box-shadow: inset 0 0 0 2px #ffffff33; }
  .brand .t{ font-weight:800; letter-spacing:.2px }
  .menu-item-label{ font-weight:600; }

  .nav{ display:flex; flex-direction:column; gap:6px; margin-top:6px; }
  .nav button{
    all:unset; display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px;
    cursor:pointer; color:var(--white); opacity:.85;
    transition: transform .12s ease, background .2s ease, opacity .2s ease;
  }
  /* Group toggle for grouped menus (Configure / Checks & Audits) */
  .nav-group-toggle {
    all:unset; display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:8px 12px; color:var(--muted); font-weight:700; font-size:12px; cursor:pointer;
    border-radius:8px; margin-top:8px;
  }
  .nav-group-toggle:hover { background: #ffffff08; }
  .nav-group-toggle .caret {
    display:inline-block; width:10px; height:10px; transform-origin:center; transition: transform .18s ease, border-color .18s ease;
    border-right:2px solid var(--muted); border-bottom:2px solid var(--muted); transform: rotate(-45deg);
  }
  .nav-group-toggle[aria-expanded="true"] .caret { transform: rotate(45deg); border-color: var(--accent-2); }
  .nav-group { display:flex; flex-direction:column; gap:6px; padding-left:4px; }
  .nav-group.collapsed { display:none; }
  /* Tweak group toggles when sidebar collapsed: keep a compact, centred caret so the
     user still sees grouping affordance and icons remain visible (avoid disappearing UI). */
  .app.collapsed #sidebar .nav .nav-group-toggle {
    display:flex; align-items:center; justify-content:center; gap:0;
    padding:8px; border-radius:8px; margin-top:8px;
    color: var(--muted); background: transparent;
  }
  /* Ensure the caret remains visible and compact */
  .app.collapsed #sidebar .nav .nav-group-toggle .caret { display:block; transform: rotate(0deg); border-color: var(--muted); }

  /* Keep icons visible and consistent when collapsed */
  .app.collapsed #sidebar .nav .icon { margin:0; width:28px; height:28px; }

  /* Resize handle styling */
  #sidebar-resize-handle{
    position: absolute; top:0; right: -6px; width: 12px; height:100%; cursor: ew-resize; z-index:30;
    display:flex; align-items:center; justify-content:center; background: transparent;
  }
  #sidebar-resize-handle::before{
    content:''; width:2px; height:40px; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.14)); border-radius:2px;
    box-shadow: 0 0 0 6px transparent; transition: box-shadow .12s ease;
  }
  #sidebar-resize-handle:active::before{ box-shadow: 0 0 8px 2px rgba(0,0,0,0.12); }

  /* User Profile Section */
  .user-profile {
    margin-top: auto;
    padding: 12px 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    border-top: 1px solid rgba(255,255,255,0.06);
  }

  .user-row {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
  }

  .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 18px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    transition: transform 0.18s ease;
    flex-shrink: 0;
  }

  .user-avatar:hover { transform: scale(1.04); }

  .user-details {
    text-align: left;
    min-width: 0;
    flex: 1;
  }

  .user-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--white);
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .site-info {
    font-size: 12px;
    color: var(--muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .btn-signout {
    all: unset;
    padding: 8px;
    border-radius: 8px;
    background: rgba(255,255,255,0.06);
    color: var(--white);
    cursor: pointer;
    transition: background 0.18s ease, transform 0.12s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
  }

  .btn-signout svg { width: 18px; height: 18px; }

  .btn-signout:hover { background: rgba(255,255,255,0.14); transform: translateY(-1px); }

  /* Collapsed sidebar adjustments */
  .app.collapsed .user-profile { padding: 12px 6px; }
  .app.collapsed .user-avatar { width: 36px; height: 36px; font-size: 14px; }
  .app.collapsed .user-details { display: none; }
  .app.collapsed .btn-signout { padding: 6px; }

  /* Hide nav-group-toggle label text when collapsed but keep the caret visible */
  .app.collapsed #sidebar .nav .nav-group-toggle { font-size: 0; }
  .app.collapsed #sidebar .nav .nav-group-toggle .caret { display:inline-block; width:10px; height:10px; transform-origin:center; border-right:2px solid var(--muted); border-bottom:2px solid var(--muted); }
  .app.collapsed #sidebar .nav .nav-group-toggle[aria-expanded="true"] .caret { transform: rotate(45deg); border-color: var(--accent-2); }
  
  /* When collapsed: show all icons for every page (flatten groups into the icon rail).
    Hide the group toggle labels so the rail is compact, but keep child buttons visible
    as centered icons for direct access. This restores the previous behaviour where
    minimized sidebar shows every page's icon. */
  .app.collapsed #sidebar .nav .nav-group-toggle { display: none !important; }
  .app.collapsed #sidebar .nav .nav-group { display: flex !important; flex-direction: column; gap:6px; padding-left: 0 !important; }
  .app.collapsed #sidebar .nav .nav-group.collapsed { display: flex !important; }
  .app.collapsed #sidebar .nav .nav-group button { all:unset; display:flex !important; align-items:center; justify-content:center; padding:10px; border-radius:8px; }
  /* Hide text/badges when collapsed — only icons should remain visible */
  .app.collapsed #sidebar .menu-item-label, .app.collapsed #sidebar .nav .nav-badge { display:none !important; }
  /* Ensure every nav button is visible in collapsed mode (covers edge cases where scripts add/remove classes) */
  .app.collapsed #sidebar .nav, .app.collapsed #sidebar .nav * { visibility: visible !important; }
  .app.collapsed #sidebar .nav button { display:flex !important; opacity:1 !important; }
  .app.collapsed #sidebar .nav .icon { display:block !important; }
  .nav button:hover{ transform: translateY(-1px); background: #ffffff14; opacity:1; }
  .nav button.active{ background:var(--accent); color:var(--white); opacity:1; font-weight:600; }
  .nav .icon{
    width:32px; height:32px; /* Larger, more legible icons */
    object-fit:contain; opacity:1;
    color: var(--white) !important; /* SVGs use currentColor */
    flex-shrink:0; display:inline-flex; align-items:center; justify-content:center;
  }
  .nav .icon svg{ width:100%; height:100%; stroke-width:3.2; }
  /* Bitmap-only filters (kept for legacy PNGs if any remain elsewhere) */
  .nav img.icon{ filter: brightness(0) invert(1); }
  .nav button.active img.icon{
    /* Approximate green for bitmap icons */
    filter: invert(64%) sepia(41%) saturate(498%) hue-rotate(98deg) brightness(92%) contrast(92%);
  }
  /* Ensure bitmap icons match SVG sizing */
  .nav img.icon{ width:32px; height:32px; object-fit:contain; }

  .nav-badge {
    margin-left: auto;
    font-size: 11px;
    background: var(--glass-2);
    padding: 2px 6px;
    border-radius: 99px;
    line-height: 1;
    opacity: 0.85;
  }
  .nav button.active .nav-badge {
    background: var(--accent);
    color: #fff;
  }
  .tab-controls .btn.secondary.active { background: var(--accent-2); border-color: var(--accent); color: var(--white); }


  .nav button:hover .icon{ opacity:1; }

  .content{ 
    padding:6px;
    height: calc(100vh - 44px); /* Account for app padding */
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .search{
    flex:1; background:#ffffff17; border-radius:100px; padding:10px 14px; display:flex; align-items:center; gap:10px;
  }
  .search input{ all:unset; color:var(--ink); width:100%; font-size:14px; }
  .pill{ padding:8px 12px; border-radius:999px; background:#ffffff17; }
  .btn{ all:unset; padding:9px 14px; border-radius:12px; background:linear-gradient(135deg,#7db1ff,#4f89ff); color:#fff; font-weight:600; cursor:pointer; }
  .btn.secondary{ background:#ffffff1e; border:1px solid #ffffff26; }

  .panel{
    background: var(--panel-bg);
    border:1px solid var(--border-color); border-radius:22px; padding:24px; box-shadow: var(--shadow);
    backdrop-filter: blur(8px);
  }
  .panel-header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
  .panel-header svg { width:22px; height:22px; color:var(--accent); }
  .panel-title { font-weight:700; font-size:18px; }

  .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
  .g-12{ grid-column: span 12; }
  .g-6{ grid-column: span 6; }
  .g-4{ grid-column: span 4; }
  .g-3{ grid-column: span 3; }

  .h1{ font-size:32px; font-weight:900; letter-spacing:.2px; margin:6px 0 8px; }
  .muted{ color:var(--muted) }

  table{ width:100%; border-collapse:separate; border-spacing:0; }
  th, td{ text-align:left; padding:12px 14px; font-size:14px; }
  thead th{ position:sticky; top:0; background:#0e2e6df2; backdrop-filter: blur(6px); z-index:1; font-weight:600; color:var(--muted); }
  tbody tr{ transition: background .12s ease; }
  tbody tr:nth-child(even){ background: #ffffff0a; }
  td { border-bottom:1px solid #ffffff14; }
  tbody tr:last-child td { border-bottom: none; }
  .table-wrap{ overflow:auto; max-height:420px; }
  .chip{ padding:4px 8px; background:#ffffff20; border-radius:999px; font-size:12px; display:inline-block }
  .chip.success { background: var(--stat-2-bg); color: var(--stat-2-color); }
  .chip.danger { background: var(--stat-4-bg); color: var (--stat-4-color); }
  .chip.warning { background: var(--stat-3-bg); color: var (--stat-3-color); }


  /* Sections (SPA) */
  section.view{ display:none; }
  section.view.active{ 
    display: flex; /* Changed from block to flex */
    animation: fadeIn .18s ease;
    flex: 1;
    overflow: hidden;
    flex-direction: column;
  }
  
  /* Make panels fill available space */
  section.view .panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin-bottom: 0; /* Remove bottom margin to use full space */
  }
  
  /* Specific table containers should be scrollable */
  .table-wrap {
    flex: 1;
    overflow-y: auto;
    margin-top: 16px;
  }
  
  /* Dashboard grid adjustments */
  section.view .grid {
    flex: 1;
    overflow-y: auto;
  }
  
  /* Grid panels should maintain their size but allow content scrolling */
  .grid .panel {
    flex: none; /* Don't flex in grid layout */
    min-height: 200px; /* Minimum size for grid panels */
  }
  
  /* Content within grid panels should be scrollable if needed */
  .grid .panel .table-wrap {
    max-height: 400px; /* Reasonable max height for grid tables */
  }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(3px)} to{opacity:1; transform:none} }

  /* Auth overlay */
  .auth{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:24px; background: #071c44d0; backdrop-filter: blur(6px); z-index: 10;
  }
  .auth.show{ display:flex; }
  .card{ background:#0b2a64; border:1px solid #ffffff1f; border-radius:20px; box-shadow:var(--shadow); padding:22px; width:min(460px, 92vw); }
  .card h2{ margin:0 0 12px; }
  .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0; }
  .field input, .field textarea { all:unset; background:#ffffff17; border:1px solid #ffffff24; padding:12px 12px; border-radius:12px; }
  .field textarea { min-height: 60px; }
  .hint{ font-size:12px; color:#b9c9ff; opacity:.9 }
  /* Dark-select styling for Windows/Edge */
  .ui-select{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    background:#0b2a64; color:var(--ink);
    border:1px solid #ffffff24; border-radius:12px; padding:12px; width:100%;
  }
  .ui-select:focus{ outline:2px solid var(--accent); box-shadow:0 0 0 3px #76a7ff40; }
  .ui-select option{ background:#0b2a64; color:var(--ink); }
  .ui-select option:disabled{ color:#8aa0cf; }
  @media (forced-colors: active){
    .ui-select{ forced-color-adjust:none; background:Canvas; color:CanvasText; border-color:GrayText; }
    .ui-select option{ background:Canvas; color:CanvasText; }
  }
  .error{ color:var(--danger); font-size:12px; margin-top:6px; }

  .footer{ text-align:center; font-size:12px; color:#b7c8ff; opacity:.9; padding:22px 0; }

  /* Modal styles */
  .modal { 
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 30;
    background: rgba(7,28,68,0.85);
  }
  .modal.show { 
    display: flex; 
  }
  .modal-content { 
    background: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 18px;
    padding: 22px;
    box-shadow: var(--shadow);
    color: var(--white);
  }
  /* CRUD modal tweaks: keep buttons visible, make fields scrollable and more compact */
  #crud-modal .card {
    display: flex;
    flex-direction: column;
    max-height: 88vh; /* slightly taller but still limited */
    width: min(880px, 98vw); /* wider modal for more horizontal space */
    padding: 20px 22px;
  }
  #crud-modal form { display: flex; flex-direction: column; gap: 0; }
  #crud-fields {
  flex: 1 1 auto; /* let fields take remaining space */
  overflow-y: auto;
  padding-right: 8px; /* space for scrollbar */
  margin-bottom: 12px;
  /* Keep fields area within viewport so modal footer/buttons remain visible */
  max-height: calc(88vh - 140px); /* account for title and buttons */
  }
  /* Grid for form fields: single column on small screens, two balanced columns on wider */
  #crud-fields .crud-grid { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 16px 24px; 
    align-items: start;
  }
  @media (min-width: 760px) {
    #crud-fields .crud-grid { grid-template-columns: 1fr 1fr; }
    /* allow some fields to span full width when needed */
    #crud-fields .field.full { grid-column: 1 / -1; }
  }
  
  /* Standardize all field containers and inputs for perfect alignment */
  #crud-modal .field { 
    box-sizing: border-box; 
    display: flex; 
    flex-direction: column; 
  }
  
  #crud-modal .field label { 
    margin-bottom: 6px; 
    font-weight: 600; 
    font-size: 14px; 
    line-height: 1.3;
    min-height: 18px; /* consistent label height */
  }
  
  /* Standardize ALL input elements to same height and styling */
  #crud-modal .field input[type="text"],
  #crud-modal .field input[type="date"], 
  #crud-modal .field .ui-select,
  #crud-modal .field select {
    height: 44px;
    padding: 0 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text);
    font-size: 14px;
    box-sizing: border-box;
    line-height: 1.4;
  }
  
  /* Textareas get consistent styling but variable height */
  #crud-modal .field textarea { 
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text);
    font-size: 14px;
    box-sizing: border-box;
    resize: vertical;
    min-height: 88px;
    line-height: 1.4;
  }
  
  #crud-modal .field.full textarea { 
    min-height: 120px; 
  }
  
  /* Checkbox styling to align with other inputs */
  #crud-modal .field input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: 8px;
  }
  
  /* Multi-select and datepicker wrapper alignment */
  #crud-modal .datepicker-wrapper {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  #crud-modal .datepicker-wrapper input {
    flex: 1;
  }
  
  #crud-modal .multi-select-wrapper {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  #crud-modal .staff-chips {
    min-height: 44px;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }
  
  /* File upload styling */
  .file-upload-area {
    transition: all 0.3s ease;
  }
  
  .file-upload-area:hover {
    opacity: 0.9;
  }
  
  .file-upload-area button {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: var(--white);
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(118, 167, 255, 0.3);
  }
  
  .file-upload-area button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(118, 167, 255, 0.4);
  }
  
  .file-upload-area button span {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  /* Modern form enhancements */
  .datepicker-wrapper { display: flex; gap: 8px; align-items: center; }
  .modern-datepicker { flex: 1; }
  .quick-date { 
    height: 44px !important; 
    padding: 0 12px !important; 
    font-size: 14px; 
    white-space: nowrap; 
    border-radius: 8px !important;
    line-height: 1.4;
  }
  
  .age-select { font-weight: 500; }
  
  .multi-select-wrapper { display: flex; flex-direction: column; gap: 8px; }
  .staff-chips { display: flex; flex-wrap: wrap; gap: 6px; min-height: 24px; }
  .staff-chip { 
    background: var(--accent); 
    color: white; 
    padding: 6px 10px; 
    border-radius: 12px; 
    font-size: 12px; 
    display: flex; 
    align-items: center; 
    gap: 4px;
  }
  .staff-chip button { 
    background: none; 
    border: none; 
    color: white; 
    cursor: pointer; 
    padding: 0; 
    margin-left: 4px;
  }
  
  .category-select, .status-select, .priority-select, .avenue-select {
    font-weight: 500;
  }
  
  .category-select option[data-color]:not([value=""]) { font-weight: 600; }
  .status-select option[data-color]:not([value=""]) { font-weight: 600; }
  .priority-select option[data-color]:not([value=""]) { font-weight: 600; }
  
  /* Enhanced field labels with better spacing and icons */
  #crud-modal .field label { 
    font-weight: 600; 
    font-size: 13px; 
    margin-bottom: 4px;
    display: block;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .modal-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }
  .modal-close {
    all: unset;
    cursor: pointer;
    background: #ffffff12;
    border-radius: 999px;
    width: 34px;
    height: 34px;
    display: grid;
    place-items: center;
  }

  /* Small screens */
  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    .sidebar{ position:sticky; top:0; z-index:2; }
    .g-4 { grid-column: span 12; }
  }
  @media (max-width: 600px){
    .stat-card { grid-column: span 12; }
  }

  /* Stat cards */
  .stat-card {
    display:flex; align-items:center; gap:16px;
    background: var(--glass); padding:16px; border-radius:16px;
    border: 1px solid var(--glass-2);
  }
  .stat-card .icon-wrap {
    width:48px; height:48px; border-radius:12px;
    display:grid; place-items:center; flex-shrink:0;
    background: var(--c); color: var(--i);
  }
  .stat-card .icon-wrap svg { width:24px; height:24px; }
  .stat-num { font-size:28px; font-weight:700; line-height:1.1; color:var(--white); }
  .stat-label { font-size:14px; color:var(--muted); }

  /* Weekly Calendar styles */
  .cal-day{ background:#ffffff0f; border:1px solid #ffffff1e; border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:8px; }
  .cal-day-header { display: flex; justify-content: space-between; align-items: baseline; }
  .cal-day-label { font-weight: 600; color: var(--white); }
  .cal-day-summary { font-size: 12px; color: var(--muted); }
  .cal-day-bar-bg { width: 100%; height: 8px; background: var(--glass-2); border-radius: 99px; overflow: hidden; }
  .cal-day-bar-fg { height: 100%; background: var(--success); width: 0%; border-radius: 99px; transition: width .4s ease; }
  .cal-day-bar-fg.danger { background: var(--danger); }
  .cal-day-metrics { display: flex; justify-content: space-between; font-size: 11px; }
  .cal-metric.success { color: var(--success); }
  .cal-metric.danger { color: var(--danger); }
  
  /* Row hover/selected across all tables */
  tbody tr:hover{ background:#ffffff12 !important; }
  tbody tr.selected{ background:#ffffff1e !important; }
  tbody[data-entity] tr{ cursor:pointer; }
  #subs-tbody tr { cursor: pointer; }


  /* Items view: full-height + sortable */
  /* Items view styles - now handled by general panel styles */
  #view-items .table-wrap{ flex:1; max-height:none; overflow:auto; }
  #view-items thead th.sortable{ cursor:pointer; user-select:none; }
  #view-items thead th .arrow{ font-size:11px; opacity:.9; margin-left:6px }

  /* Quiz view: allow table to fill the full height of the page */
  #view-quiz .table-wrap{ flex:1; max-height:none; overflow:auto; }

  /* Monthly Calendar Styles */
  #cal-grid { grid-auto-rows: 1fr; align-items: start; }
  .cal-cell {
    background: var(--glass);
    border: 1px solid var(--glass-2);
    border-radius: 12px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    font-size: 12px;
    transition: background .12s ease;

    /* Keep cells perfectly square regardless of content/viewport */
    aspect-ratio: 1 / 1;
    min-height: 0; /* allow grid to calculate height from width */
    overflow: hidden;
  }
  .cal-cell.is-clickable { cursor: pointer; }
  .cal-cell.is-clickable:hover { background: var(--glass-2); }
  .cal-cell.other-month { opacity: .4; background: transparent; border-color:transparent; pointer-events:none; }
  .cal-cell.is-today .cal-day-num {
    background: var(--accent);
    color: var(--white);
    font-weight: 700;
  }
  .cal-day-num {
    font-weight: 600;
    font-size: 14px;
    width: 26px; height: 26px;
    display: grid; place-items: center;
    border-radius: 999px;
    margin-bottom: 4px;
    transition: all .2s ease;
    flex-shrink: 0;
  }
  .cal-tasks {
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 11px;
    padding-right: 4px; /* for scrollbar */
  }
  /* Custom scrollbar for task list */
  .cal-tasks::-webkit-scrollbar { width: 4px; }
  .cal-tasks::-webkit-scrollbar-track { background: transparent; }
  .cal-tasks::-webkit-scrollbar-thumb { background: #ffffff33; border-radius: 4px; }

  .cal-task {
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cal-task-status {
    width: 18px; height: 18px;
    border-radius: 999px;
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: var(--white);
    background: var(--muted);
    opacity: .9;
    line-height: 1;
  }
  .cal-task-status.scheduled { background: var(--muted); color: var(--white); opacity: .85; }
  .cal-task-status.done { background: var(--success); color: var(--white); }
  .cal-task-status.missed { background: var(--danger); color: var(--white); }

  .freq-badge {
    font-size:10px;
    padding:2px 6px;
    border-radius:999px;
    background: rgba(255,255,255,0.06);
    color: var(--muted);
    margin-left: 8px;
    flex-shrink: 0;
  }
  .cal-legend { display:flex; gap:14px; align-items:center; color:var(--muted); font-size:12px; margin-bottom:12px; }
  .cal-legend .item { display:flex; gap:8px; align-items:center; }
  .cal-legend .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
  .cal-legend .dot.scheduled { background: var(--muted); opacity:.6 }
  .cal-legend .dot.done { background: var(--success) }
  .cal-legend .dot.missed { background: var(--danger) }

  /* Enhanced Calendar Visual Improvements */
  
  /* Improved calendar grid with better spacing and visual hierarchy */
  #view-calendar .panel {
    background: linear-gradient(135deg, var(--panel-bg) 0%, rgba(11, 75, 179, 0.02) 100%);
  }
  
  /* Enhanced calendar cells with subtle gradients and better contrast */
  .cal-cell {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
  }
  
  .cal-cell:hover {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
    border-color: rgba(255, 255, 255, 0.25);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
  }
  
  .cal-cell.is-today {
    background: linear-gradient(145deg, rgba(118, 167, 255, 0.15), rgba(118, 167, 255, 0.08));
    border-color: var(--accent);
    box-shadow: 0 0 20px rgba(118, 167, 255, 0.3);
  }
  
  /* Enhanced day numbers with better visibility */
  .cal-day-num {
    background: rgba(255, 255, 255, 0.1);
    color: var(--white);
    border-radius: 8px;
    font-weight: 700;
    font-size: 15px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .cal-cell.is-today .cal-day-num {
    background: var(--accent);
    color: #ffffff;
    box-shadow: 0 2px 8px rgba(118, 167, 255, 0.4);
  }
  
  .cal-cell.other-month .cal-day-num {
    background: transparent;
    color: rgba(255, 255, 255, 0.4);
  }
  
  /* Much improved task visibility and styling */
  .cal-task {
    background: rgba(255, 255, 255, 0.12);
    border-radius: 6px;
    padding: 4px 6px;
    margin: 1px 0;
    border-left: 3px solid var(--accent);
    color: var(--white);
    font-weight: 500;
    font-size: 11px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    transition: all 0.15s ease;
    backdrop-filter: blur(10px);
  }
  
  .cal-task:hover {
    background: rgba(255, 255, 255, 0.18);
    transform: translateX(2px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  }
  
  /* Enhanced task status indicators with better colors and visibility */
  .cal-task-status {
    background: rgba(255, 255, 255, 0.2);
    color: #ffffff;
    font-weight: 700;
    font-size: 9px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  }
  
  .cal-task-status.scheduled {
    background: linear-gradient(135deg, #64748b, #475569);
    border-color: #64748b;
    color: #ffffff;
  }
  
  .cal-task-status.done {
    background: linear-gradient(135deg, #10b981, #059669);
    border-color: #10b981;
    color: #ffffff;
    box-shadow: 0 0 6px rgba(16, 185, 129, 0.4);
  }
  
  .cal-task-status.missed {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-color: #ef4444;
    color: #ffffff;
    box-shadow: 0 0 6px rgba(239, 68, 68, 0.4);
    animation: pulse-red 2s infinite;
  }
  
  @keyframes pulse-red {
    0%, 100% { box-shadow: 0 0 6px rgba(239, 68, 68, 0.4); }
    50% { box-shadow: 0 0 12px rgba(239, 68, 68, 0.8); }
  }
  
  /* Enhanced legend with better styling */
  .cal-legend {
    background: rgba(255, 255, 255, 0.05);
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 16px;
  }
  
  .cal-legend .item {
    font-weight: 500;
    color: var(--white);
  }
  
  .cal-legend .dot {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .cal-legend .dot.scheduled {
    background: linear-gradient(135deg, #64748b, #475569);
    opacity: 1;
  }
  
  .cal-legend .dot.done {
    background: linear-gradient(135deg, #10b981, #059669);
    box-shadow: 0 0 6px rgba(16, 185, 129, 0.3);
  }
  
  .cal-legend .dot.missed {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 0 6px rgba(239, 68, 68, 0.3);
  }
  
  /* Calendar header improvements */
  #cal-header {
    background: rgba(255, 255, 255, 0.05);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 20px;
  }
  
  #cal-month-year {
    color: var(--white);
    font-weight: 700;
    font-size: 20px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }
  
  /* Enhanced navigation buttons */
  #cal-prev, #cal-next {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--white);
    font-weight: 600;
    transition: all 0.2s ease;
  }
  
  #cal-prev:hover, #cal-next:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--accent);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  /* Weekday headers enhancement */
  #cal-weekdays {
    background: rgba(255, 255, 255, 0.08);
    padding: 12px 0;
    margin-bottom: 8px;
    border-radius: 10px;
    font-weight: 600;
    color: var(--white);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }
  
  /* Day modal enhancements */
  .day-modal-card {
    background: linear-gradient(145deg, var(--panel-bg), rgba(11, 75, 179, 0.95));
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(20px);
  }
  
  /* Day modal */
  #day-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 30; background: rgba(7,28,68,0.85); }
  #day-modal.show { display: flex; }
  .day-modal-card { width: min(900px, 86vw); background: var(--panel-bg); border:1px solid var(--border-color); border-radius:18px; padding:22px; box-shadow: var(--shadow); color: var(--white); }
  .day-modal-close { all:unset; float:right; cursor:pointer; background:#ffffff12; border-radius:999px; width:34px; height:34px; display:grid; place-items:center; }
  /* Branding modal */
  #branding-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 31; background: rgba(7,28,68,0.85); }
  #branding-modal.show { display: flex; }
  .branding-card { width: min(700px, 92vw); background: var(--panel-bg); border:1px solid var(--border-color); border-radius:18px; padding:22px; box-shadow: var(--shadow); color: var(--white); }
  .branding-close { all:unset; float:right; cursor:pointer; background:#ffffff12; border-radius:999px; width:34px; height:34px; display:grid; place-items:center; }
  .branding-row { display:grid; grid-template-columns: 160px 1fr; gap:14px; align-items:center; margin:12px 0; }
  .branding-preview { width:160px; height:90px; border-radius:10px; background:#ffffff12; border:1px solid #ffffff22; display:grid; place-items:center; overflow:hidden; }
  .branding-preview img { max-width:100%; max-height:100%; object-fit:contain; }
  .branding-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
  .hint-mini { font-size: 12px; color: var(--muted); }
  
  #cal-view-switcher .btn.secondary.active {
    background: var(--accent-2);
    border-color: var(--accent);
    color: var(--white);
  }
  /* Pre-inspection View Styles */
  .progress-bar-bg { background: var(--glass-2); border-radius: 99px; height: 10px; overflow: hidden; }
  .progress-bar-fg { background: var(--success); height: 100%; width: 0%; border-radius: 99px; transition: width .4s ease; }
  
  /* Enhanced progress header with count display */
  .pir-progress-header {
  display: block;
    gap: 24px;
    align-items: center;
    margin-bottom: 24px;
    padding: 20px;
    background: var(--glass);
    border-radius: 16px;
    border: 1px solid var(--border-color);
  }
  
  .pir-progress-text {
    font-size: 28px;
    font-weight: 700;
    color: var(--white);
    text-align: center;
  }
  
  .pir-progress-label {
    font-size: 14px;
    color: var(--muted);
    margin-top: 4px;
    text-align: center;
  }

  /* Dedicated PIR progress panel that stretches full width */
  .pir-progress-panel { padding: 20px; border-radius: 16px; background: var(--panel-bg); border:1px solid var(--border-color); box-shadow: var(--shadow); margin-bottom: 24px; }
  .pir-progress-main { display:flex; flex-direction:column; gap:16px; }
  
  /* Enhanced full-width progress bar with clear outline and interactive effects */
  .progress-bar-container { 
    position: relative; 
    padding: 6px; 
    background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(0,0,0,0.05)); 
    border-radius: 999px; 
    border: 2px solid rgba(255,255,255,0.15);
    box-shadow: 
      0 4px 12px rgba(0,0,0,0.1),
      inset 0 1px 0 rgba(255,255,255,0.2),
      inset 0 -1px 0 rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .progress-bar-container:hover {
    transform: translateY(-1px);
    box-shadow: 
      0 6px 20px rgba(0,0,0,0.15),
      inset 0 1px 0 rgba(255,255,255,0.3),
      inset 0 -1px 0 rgba(0,0,0,0.15);
    border-color: rgba(255,255,255,0.25);
  }
  
  .progress-bar-bg { 
    background: var(--glass-2);
    border-radius: 999px; 
    height: 24px; 
    overflow: hidden; 
    position: relative;
  }
  
  /* Solid color progress foreground; color is controlled by JS based on % */
  .progress-bar-fg { 
    background: var(--success);
    height: 100%; 
    width: 0%; 
    border-radius: 999px; 
    transition: width 0.4s ease; 
  }
  
  /* Progress milestones */
  .progress-milestones {
    position: absolute;
    top: -8px;
    left: 6px;
    right: 6px;
    height: 40px;
    pointer-events: none;
  }
  
  .milestone {
    position: absolute;
    width: 2px;
    height: 16px;
    background: rgba(255,255,255,0.4);
    border-radius: 1px;
    top: 50%;
    transform: translateY(-50%);
  }
  
  .milestone.quarter { left: 25%; }
  .milestone.half { left: 50%; background: rgba(255,255,255,0.6); height: 20px; }
  .milestone.three-quarter { left: 75%; }
  
  /* Progress state animations and effects */
  .progress-bar-container.progress-low {
    animation: progressPulse 2s ease-in-out infinite;
  }
  
  .progress-bar-container.progress-medium {
    border-color: rgba(255,193,7,0.4);
  }
  
  .progress-bar-container.progress-high {
    border-color: rgba(40,167,69,0.4);
  }
  
  .progress-bar-container.progress-complete {
    border-color: rgba(16,185,129,0.6);
    animation: progressCelebrate 3s ease-in-out infinite;
  }
  
  @keyframes progressPulse {
    0%, 100% { 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    50% { 
      box-shadow: 0 6px 20px rgba(220,53,69,0.3), inset 0 1px 0 rgba(255,255,255,0.3);
      border-color: rgba(220,53,69,0.4);
    }
  }
  
  @keyframes progressCelebrate {
    0%, 100% { 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    50% { 
      box-shadow: 0 8px 25px rgba(16,185,129,0.4), inset 0 1px 0 rgba(255,255,255,0.4);
      transform: translateY(-2px);
    }
  }
  
  @keyframes progressClick {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
  }
  
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }

  /* Standardized page headers with help icons */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
  }
  
  .page-title-wrapper {
  display: flex;
  align-items: center; /* align title and badge vertically */
    gap: 8px;
    position: relative;
  }
  
  .page-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--white);
    margin: 0;
    line-height: 1.2;
  }
  
  .help-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    transition: all 0.2s ease;
    margin-top: 2px;
    flex-shrink: 0;
  }
  
  .help-icon:hover {
    background: rgba(255,255,255,0.15);
    border-color: rgba(255,255,255,0.4);
    color: var(--white);
    transform: scale(1.1);
  }

  /* Page help badge: inline eye button placed just to the right of the page title */
  .page-header { position: relative; }

  .page-help-badge {
    display: inline-grid;
    place-items: center;
    margin-left: 10px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.06);
    color: var(--white);
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(2,6,23,0.35);
    transition: transform 0.12s ease, box-shadow 0.12s ease;
    flex-shrink: 0;
  }

  .page-help-badge:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 10px 24px rgba(2,6,23,0.4); }

  /* Variant for light panels (when --panel-bg is light) */
  .page-help-badge.light {
    background: linear-gradient(135deg, #fff, #f3f6fb);
    color: var(--ink);
    border-color: rgba(0,0,0,0.06);
    box-shadow: 0 6px 18px rgba(16,24,40,0.08);
  }
  
  /* Help modal styles */
  .help-modal {
    position: fixed;
    inset: 0;
    background: rgba(7,28,68,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
  }
  
  .help-modal.show {
    display: flex;
  }
  
  .help-modal-content {
  background: var(--panel-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 24px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  /* Use readable text color on the panel background */
  color: var(--ink);
  }
  
  .help-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .help-modal-title {
    font-size: 20px;
    font-weight: 700;
  color: var(--ink);
    margin: 0;
  }
  
  .help-modal-close {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: rgba(255,255,255,0.7);
    transition: all 0.2s ease;
  }
  
  .help-modal-close:hover {
    background: rgba(255,255,255,0.2);
    color: var(--white);
  }
  
  .help-modal-body {
    color: var(--ink);
    line-height: 1.6;
  }

  .pir-progress-stats { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .pir-progress-stats .large { font-size:18px; font-weight:800; color:var(--ink); }
  .pir-progress-stats .muted-small { font-size:12px; color:var(--muted); }
  /* Collapse behavior for overall PIR progress section */
  .pir-progress-main.collapsed { display: none !important; }

  /* Mini progress inside each email cell */
  .email-mini-bar-bg { width:80%; height:8px; background: rgba(0,0,0,0.06); border-radius:999px; overflow:hidden; }
  .email-mini-bar-fg { height:100%; width:0%; background: linear-gradient(90deg,#dc3545,#ffc107,#10b981); transition: width .5s ease; }

  /* Email status circles (compact row design) */
  .email-status-circles {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 8px;
  padding: 18px 16px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
  }

.email-status-circles.collapsed { display: none !important; }
  
  .email-circle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }
  
  .email-circle-item:hover {
    transform: translateY(-2px);
  }
  
  .email-circle {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 16px;
    color: white;
    position: relative;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  .email-circle::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    border-radius: 50%;
    transition: left 0.6s ease;
  }
  
  .email-circle-item:hover .email-circle::before {
    left: 100%;
  }
  
  .email-circle.ready {
    background: linear-gradient(135deg, #28a745, #20c997);
    box-shadow: 0 2px 12px rgba(40,167,69,0.4);
  }
  
  .email-circle.partial {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    box-shadow: 0 2px 12px rgba(255,193,7,0.4);
  }
  
  .email-circle.missing {
    background: linear-gradient(135deg, #6c757d, #495057);
    box-shadow: 0 2px 8px rgba(108,117,125,0.3);
  }
  
  .email-circle-count {
  font-size: 12px;
    font-weight: 600;
    color: var(--text-color);
    opacity: 0.8;
    transition: opacity 0.3s ease;
  }
  
  .email-circle-item:hover .email-circle-count {
    opacity: 1;
  }
  
  .email-circle-item.ready .email-circle-count {
    color: #28a745;
  }
  
  .email-circle-item.partial .email-circle-count {
    color: #fd7e14;
  }
  
  .email-circle-item.missing .email-circle-count {
    color: #6c757d;
  }

  /* Popover for email package summaries */
  .email-popover {
    position: absolute;
    min-width: 260px;
    max-width: 360px;
    background: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 12px 30px rgba(2,6,23,0.25);
    color: var(--ink);
    z-index: 1400;
    transform-origin: top right;
    animation: popIn .18s cubic-bezier(.2,.9,.2,1);
  }

  .email-popover .pop-list {
    max-height: 220px;
    overflow: auto;
    margin-top: 8px;
    padding-right: 6px;
  }

  @keyframes popIn {
    from { transform: scale(.92) translateY(-6px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
  }

  .email-popover h4 { margin: 0 0 8px; font-size: 14px; }
  .email-popover .pop-row { display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed rgba(0,0,0,0.04); }
  .email-popover .pop-row:last-child { border-bottom: none; }
  .email-popover .pop-actions { display:flex; gap:8px; margin-top:10px; justify-content:flex-end; }
  .email-popover .pill { padding:6px 10px; border-radius:12px; font-size:12px; }
  .email-popover .pill.ready { background: linear-gradient(90deg,#34d399,#10b981); color:white; }
  .email-popover .pill.partial { background: linear-gradient(90deg,#ffd580,#ffb020); color:#3b2f00; }
  .email-popover .pill.missing { background: #f1f5f9; color:var(--muted); border:1px solid var(--border-color); }

  .email-cell {
    padding: 10px;
    border-radius: 10px;
    text-align: center;
    font-weight: 700;
    font-size: 13px;
    border: 1px solid var(--border-color);
    background: var(--panel-bg);
    color: var(--muted);
    display:flex;
    flex-direction:column;
    gap:4px;
    align-items:center;
    justify-content:center;
  }

  .email-cell.ready {
    background: linear-gradient(180deg, #34d399, #10b981);
    color: white;
    border-color: rgba(16,185,129,0.25);
  }

  .email-cell.partial {
    background: linear-gradient(180deg, #ffd580, #ffb020);
    color: #3b2f00;
    border-color: rgba(255,176,32,0.16);
  }

  .email-cell.missing {
    background: var(--glass-2);
    color: var(--muted);
    border-style: dashed;
  }

  .email-cell .email-num { font-size: 12px; opacity: .9; }
  .email-cell .email-count { font-size: 14px; }
  
  /* Filter pills */
  .pir-filters {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .pir-filter-pill {
    padding: 8px 16px;
    border-radius: 20px;
    background: var(--glass);
    border: 1px solid var(--border-color);
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
  }
  
  .pir-filter-pill:hover {
    background: var(--glass-2);
    transform: translateY(-1px);
  }
  
  .pir-filter-pill.active {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent);
  }
  
  /* Sidebar TOC for categories */
  .pir-layout {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 24px;
    height: 100%;
    overflow: hidden;
  }
  
  .pir-toc {
    background: var(--glass);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    padding: 16px;
    overflow-y: auto;
    max-height: calc(100vh - 280px);
  }
  
  .pir-toc-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 12px;
    color: var(--white);
  }
  
  .pir-toc-item {
    display: block;
    padding: 8px 12px;
    margin: 2px 0;
    border-radius: 8px;
    color: var(--muted);
    text-decoration: none;
    font-size: 12px;
    transition: all 0.2s ease;
    cursor: pointer;
    line-height: 1.3;
  }
  
  .pir-toc-item:hover {
    background: var(--glass-2);
    color: var(--white);
  }
  
  .pir-toc-item.active {
    background: var(--accent);
    color: var(--white);
  }
  
  .pir-main {
    overflow-y: auto;
    max-height: calc(100vh - 280px);
  }
  
  /* Category sections with sticky headers */
  .doc-category {
    margin-bottom: 32px;
    scroll-margin-top: 70px;
  }
  
  .doc-category-title {
    position: sticky;
    top: 0;
    z-index: 10;
    font-size: 16px;
    font-weight: 700;
    color: var(--accent-2);
    background: var(--panel-bg);
    backdrop-filter: blur(8px);
    border-bottom: 2px solid var(--accent-2);
    padding: 12px 0 8px 0;
    margin-bottom: 16px;
  }
  
  /* Enhanced table rows with hover actions */
  .pir-table-row {
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
    background: var(--glass);
    overflow: hidden;
  }
  
  .pir-table-row:hover {
    border-color: var(--accent-2);
    box-shadow: 0 4px 12px rgba(118, 167, 255, 0.15);
    transform: translateY(-1px);
  }
  
  .pir-row-main {
    padding: 16px 20px;
    display: grid;
  /* Fixed columns for consistent alignment across rows */
  grid-template-columns: 32px minmax(0, 1fr) 120px 120px 120px 220px;
    gap: 16px;
    align-items: center;
  }
  
  .pir-row-title {
    font-weight: 600;
    color: var(--white);
    font-size: 14px;
  }
  
  .pir-row-type {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }
  
  .pir-row-actions {
    display: flex;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.2s ease;
  justify-self: end; /* keep actions aligned to the right */
  }
  
  .pir-table-row:hover .pir-row-actions {
    opacity: 1;
  }
  
  .pir-action-btn {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 6px;
    background: var(--glass-2);
    border: 1px solid var(--border-color);
    color: var(--white);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .pir-action-btn:hover {
    background: var(--accent-2);
    border-color: var(--accent);
  }
  
  .pir-action-btn.primary {
    background: var(--accent);
    border-color: var(--accent);
  }
  
  /* Status chips with enhanced styling */
  .pir-status-chip {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .pir-status-chip.not-attached {
    background: var(--glass-2);
    color: var(--muted);
  }
  
  .pir-status-chip.uploaded {
    background: var(--stat-3-bg);
    color: var(--stat-3-color);
  }
  
  .pir-status-chip.ready {
    background: var(--stat-2-bg);
    color: var(--stat-2-color);
  }
  
  .pir-status-chip.outdated {
    background: #ff8c0033;
    color: #ff8c00;
  }
  
  .pir-status-chip.draft {
    background: #8b5cf633;
    color: #8b5cf6;
  }
  
  .pir-status-chip.expired {
    background: #dc354533;
    color: #dc3545;
    font-weight: 600;
    animation: pulse-warning 2s infinite;
  }
  
  .pir-status-chip.expiring-soon {
    background: #ffc10733;
    color: #ffc107;
    font-weight: 600;
  }

  @keyframes pulse-warning {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* Certificate tracking styles */
  .certificate-tracking {
    border-left: 4px solid var(--accent-2);
  }
  
  .certificate-tracking h4 {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }
  
  .enhanced-pir-modal .info-value.status-expired {
    color: #dc3545;
    font-weight: 600;
  }
  
  .enhanced-pir-modal .info-value.status-expiring-soon {
    color: #ffc107;
    font-weight: 600;
  }

  /* Enhanced PIR Modal Styles */
  .enhanced-pir-modal {
    backdrop-filter: blur(8px);
  }
  
  .enhanced-pir-content {
    width: min(95vw, 1200px);
    height: min(90vh, 800px);
    max-width: none;
    max-height: none;
    display: flex;
    flex-direction: column;
    background: var(--panel-bg);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  
  .enhanced-pir-header {
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(135deg, var(--panel-bg) 0%, var(--glass) 100%);
    border-radius: 16px 16px 0 0;
  }
  
  .enhanced-pir-header .header-main {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  
  .enhanced-pir-header h2 {
    margin: 0;
    font-size: 24px;
    color: var(--white);
    max-width: 70%;
  }
  
  .enhanced-pir-header .header-meta {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .category-badge, .item-type-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .category-badge {
    background: var(--accent-2)33;
    color: var(--accent-2);
  }
  
  .item-type-badge {
    background: var(--muted)33;
    color: var(--muted);
  }
  
  .enhanced-pir-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  
  .enhanced-pir-sidebar {
    width: 300px;
    padding: 24px;
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    background: var(--glass);
  }
  
  .enhanced-info-section {
    margin-bottom: 32px;
  }
  
  .enhanced-info-section h4 {
    margin: 0 0 16px 0;
    font-size: 16px;
    color: var(--accent-2);
    font-weight: 600;
  }
  
  .enhanced-info-item {
    display: flex;
    flex-direction: column;
    margin-bottom: 16px;
  }
  
  .info-label {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 4px;
    font-weight: 500;
  }
  
  .info-value {
    font-size: 14px;
    color: var(--white);
    word-wrap: break-word;
  }
  
  .enhanced-actions-section h4 {
    margin: 0 0 16px 0;
    font-size: 16px;
    color: var(--accent-2);
    font-weight: 600;
  }
  
  .enhanced-action-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .enhanced-action-buttons .btn {
    justify-content: flex-start;
    gap: 8px;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
  }
  
  .enhanced-pir-preview {
    flex: 1;
    padding: 24px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .enhanced-preview-loading, 
  .enhanced-preview-error, 
  .enhanced-preview-empty,
  .enhanced-preview-unsupported {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 16px;
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--glass);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .error-icon, .empty-icon, .file-icon {
    font-size: 48px;
    opacity: 0.7;
  }
  
  .enhanced-preview-error h4,
  .enhanced-preview-empty h4,
  .enhanced-preview-unsupported h4 {
    margin: 0;
    color: var(--white);
    font-size: 18px;
  }
  
  .enhanced-preview-error p,
  .enhanced-preview-empty p,
  .enhanced-preview-unsupported p {
    margin: 0;
    color: var(--muted);
    font-size: 14px;
    line-height: 1.5;
  }
  
  .enhanced-pdf-preview,
  .enhanced-image-preview {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .enhanced-pir-footer {
    padding: 20px 24px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    background: var(--glass);
    border-radius: 0 0 16px 16px;
  }
  
  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .enhanced-pir-content {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
    }
    
    .enhanced-pir-body {
      flex-direction: column;
    }
    
    .enhanced-pir-sidebar {
      width: auto;
      border-right: none;
      border-bottom: 1px solid var(--border-color);
      max-height: 200px;
    }
  }
  
  /* Template buttons inline */
  .pir-template-btn {
    padding: 4px 8px;
    font-size: 11px;
    border-radius: 6px;
    background: linear-gradient(135deg, var(--accent-2), var(--accent));
    border: none;
    color: var(--white);
    cursor: pointer;
    transition: all 0.2s ease;
    opacity: 0;
  }
  
  .pir-table-row:hover .pir-template-btn {
    opacity: 1;
  }
  
  .pir-template-btn:hover {
    transform: scale(1.05);
  }
  
  /* Bulk operations bar */
  .pir-bulk-bar {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 12px 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(12px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 20;
  }
  
  .pir-bulk-bar.visible {
    opacity: 1;
    visibility: visible;
  }
  
  .pir-bulk-count {
    font-weight: 600;
    color: var(--white);
  }
  
  /* Mobile responsive card layout */
  @media (max-width: 768px) {
    .pir-layout {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .pir-toc {
      display: none;
    }
    
    .pir-row-main {
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 16px;
    }
    
    .pir-row-actions {
      opacity: 1;
      justify-self: start;
    }
    
    .pir-table-row {
      padding: 0;
    }
  }
  
  /* Draft text support */
  .pir-draft-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--accent-2);
    margin-top: 4px;
  }
  
  .pir-draft-badge {
    background: var(--accent);
    color: var(--white);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
  }
  
  /* Notes indicator */
  .pir-notes-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--success);
    margin-top: 4px;
  }
  
  .pir-notes-badge {
    font-size: 12px;
  }
  
  .pir-action-btn.has-notes {
    background: var(--success-bg);
    border-color: var(--success);
    color: var(--success);
    font-weight: 600;
  }
  
  /* PIR Notes Modal */
  .pir-notes-modal .modal-content {
    max-width: 600px;
    width: 90%;
  }
  
  .pir-notes-modal textarea {
    min-height: 200px;
    resize: vertical;
    font-family: inherit;
  }
  
  .pir-notes-modal .btn.success {
    background-color: var(--success);
    border-color: var(--success);
    color: var(--white);
  }
  
  .pir-notes-modal .btn.error {
    background-color: var(--error);
    border-color: var(--error);
    color: var(--white);
  }
  
  /* Column sorting */
  .pir-sort-header {
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 0;
    font-weight: 600;
  }
  
  .pir-sort-header:hover {
    color: var(--accent-2);
  }
  
  .pir-sort-arrow {
    font-size: 10px;
    opacity: 0.6;
    transition: all 0.2s ease;
  }
  
  .pir-sort-header.active .pir-sort-arrow {
    opacity: 1;
    color: var(--accent);
  }
  
  /* Enhanced PIR Modal Styles */
  .enhanced-pir-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
    animation: modalFadeIn 0.3s ease-out;
  }
  
  .enhanced-pir-modal.show {
    display: flex;
  }
  
  .enhanced-pir-content {
    background: var(--panel-bg);
    border-radius: 16px;
    width: 95vw;
    height: 90vh;
    max-width: 1400px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--border-color);
    animation: modalSlideIn 0.3s ease-out;
  }
  
  .enhanced-pir-header {
    padding: 24px 32px;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(135deg, var(--glass) 0%, var(--panel-bg) 100%);
  }
  
  .enhanced-pir-header .header-main {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 12px;
  }
  
  .enhanced-pir-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--white);
    flex: 1;
  }
  
  .enhanced-pir-header .header-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .category-badge {
    background: var(--accent);
    color: var(--panel-bg);
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .item-type-badge {
    background: var(--glass);
    color: var(--white);
    border: 1px solid var(--border-color);
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .enhanced-pir-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  
  .enhanced-pir-sidebar {
    width: 300px;
    background: var(--glass);
    border-right: 1px solid var(--border-color);
    padding: 24px;
    overflow-y: auto;
    flex-shrink: 0;
  }
  
  .enhanced-info-section,
  .enhanced-actions-section,
  .enhanced-notes-section {
    margin-bottom: 32px;
  }
  
  .enhanced-info-section h4,
  .enhanced-actions-section h4,
  .enhanced-notes-section h4 {
    margin: 0 0 16px 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--white);
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .enhanced-notes-display {
    background: var(--glass);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
  }
  
  .enhanced-notes-display .notes-content {
    color: var(--white);
    font-size: 0.875rem;
    line-height: 1.5;
    margin-bottom: 16px;
    white-space: pre-wrap;
  }
  
  .enhanced-notes-empty {
    padding: 16px;
    text-align: center;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    background: var(--glass);
  }
  
  .enhanced-notes-empty p {
    margin: 0 0 12px 0;
    font-style: italic;
  }
  
  .btn.small {
    padding: 6px 12px;
    font-size: 0.75rem;
  }
  
  .enhanced-info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 16px;
  }
  
  .info-label {
    font-size: 0.75rem;
    color: var(--muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .info-value {
    font-size: 0.875rem;
    color: var(--white);
    word-break: break-word;
  }
  
  .info-value.status-ready { color: var(--success); }
  .info-value.status-warning { color: var(--warning); }
  .info-value.status-danger { color: var(--danger); }
  
  .enhanced-action-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .enhanced-action-buttons .btn {
    justify-content: flex-start;
    gap: 8px;
  }
  
  .enhanced-pir-preview {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    background: var(--panel-bg);
  }
  
  .enhanced-pdf-preview {
    height: 100%;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
  }
  
  .enhanced-image-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    background: var(--glass);
    border-radius: 8px;
    padding: 20px;
  }
  
  .enhanced-preview-loading,
  .enhanced-preview-error,
  .enhanced-preview-empty,
  .enhanced-preview-unsupported {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 40px;
    color: var(--muted);
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
  }
  
  .error-icon,
  .empty-icon,
  .file-icon {
    font-size: 3rem;
    margin-bottom: 16px;
  }
  
  .enhanced-preview-error h4,
  .enhanced-preview-empty h4,
  .enhanced-preview-unsupported h4 {
    color: var(--white);
    margin: 0 0 12px 0;
    font-size: 1.25rem;
    font-weight: 600;
  }
  
  .enhanced-preview-error p,
  .enhanced-preview-empty p,
  .enhanced-preview-unsupported p {
    margin: 0 0 8px 0;
    line-height: 1.5;
  }
  
  .enhanced-pir-footer {
    padding: 20px 32px;
    border-top: 1px solid var(--border-color);
    background: var(--glass);
    display: flex;
    justify-content: flex-end;
  }
  
  @keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes modalSlideIn {
    from { 
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to { 
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Responsive design for smaller screens */
  @media (max-width: 1024px) {
    .enhanced-pir-content {
      width: 98vw;
      height: 95vh;
    }
    
    .enhanced-pir-body {
      flex-direction: column;
    }
    
    .enhanced-pir-sidebar {
      width: 100%;
      max-height: 200px;
      border-right: none;
      border-bottom: 1px solid var(--border-color);
    }
    
    .enhanced-info-section,
    .enhanced-actions-section {
      margin-bottom: 16px;
    }
    
    .enhanced-info-item {
      margin-bottom: 8px;
    }
  }

  /* PDF preview modal enhancements */
  .pir-preview-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
    backdrop-filter: blur(4px);
  }
  
  .pir-preview-modal.show {
    display: flex;
  }
  
  .pir-preview-content {
    background: var(--panel-bg);
    border-radius: 16px;
    width: 90vw;
    height: 90vh;
    max-width: 1200px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .pir-preview-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .pir-preview-body {
    flex: 1;
    overflow: auto;
    padding: 0;
  }
  
  .pir-preview-close {
    background: var(--glass);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--white);
    cursor: pointer;
  }
  
  #pir-tbody tr { cursor: pointer; }

  /* Pre‑Inspection panel should fill viewport and allow inner scrolling */
  #view-pre-inspection .panel {
    min-height: calc(100vh - 190px);
    display: flex;
    flex-direction: column;
  }
  /* Make the documents container the scrollable area */
  #view-pre-inspection #pir-docs-container {
    flex: 1 1 auto;
    overflow-y: auto;
    max-height: none;            /* override .table-wrap default 420px cap */
    -webkit-overflow-scrolling: touch; /* iOS/Safari momentum scroll */
    overscroll-behavior: contain;      /* prevent scroll chaining */
  }

  /* Dynamic & Multi-Input Form Styles */
  .multi-input-container { display: flex; gap: 12px; align-items: flex-start; }
  .multi-input-container .field { flex: 1; margin-top: 0; }
  .dynamic-table-row { display: flex; gap: 8px; align-items: center; }
  .dynamic-table-row input { flex: 1; }

  /* Training Matrix Styles - Enhanced */
  .training-matrix {
    overflow: hidden;
    background: var(--panel-bg);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    position: relative;
    height: 600px;
    display: flex;
    flex-direction: column;
  }

  /* Training controls and search */
  .training-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    background: var(--panel-bg);
    flex-wrap: wrap;
  }

  .training-search {
    flex: 1;
    min-width: 200px;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--glass);
    font-size: 14px;
  }

  .training-filters {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .filter-pill {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    background: var(--glass);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .filter-pill:hover {
    background: var(--glass-2);
  }

  .filter-pill.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .density-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--muted);
  }

  .density-switch {
    width: 40px;
    height: 20px;
    background: var(--glass);
    border-radius: 10px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .density-switch.active {
    background: var(--primary);
  }

  .density-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s ease;
  }

  .density-switch.active::after {
    transform: translateX(20px);
  }

  /* Legend moved to top right */
  .training-legend {
    position: absolute;
    top: 16px;
    right: 16px;
    display: flex;
    gap: 16px;
    font-size: 11px;
    color: var(--muted);
    background: var(--panel-bg);
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    z-index: 5;
  }

  .training-legend .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .training-legend .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 2px;
  }

  /* Scrollable container */
  .training-matrix-scroll {
    flex: 1;
    overflow: auto;
    position: relative;
  }

  .training-matrix table {
    min-width: 800px;
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
  }

  .training-matrix th {
    background: var(--panel-bg);
    position: sticky;
    top: 0;
    z-index: 2;
    writing-mode: vertical-lr;
    text-orientation: mixed;
    width: 120px;
    max-width: 120px;
    padding: 16px 8px;
    font-size: 12px;
    border-right: 1px solid var(--border-color);
    border-bottom: 2px solid var(--border-color);
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .training-matrix th:hover {
    background: var(--glass-2);
  }

  .training-matrix th.sortable::after {
    content: '↕';
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    opacity: 0.5;
  }

  .training-matrix th.sort-asc::after {
    content: '↑';
    opacity: 1;
  }

  .training-matrix th.sort-desc::after {
    content: '↓';
    opacity: 1;
  }

  .training-matrix th:first-child {
    writing-mode: horizontal-tb;
    text-orientation: initial;
    width: 200px;
    max-width: 200px;
    position: sticky;
    left: 0;
    z-index: 3;
    background: var(--panel-bg);
    box-shadow: 2px 0 4px rgba(0,0,0,0.1);
  }

  .training-matrix td {
    padding: 12px 8px;
    border-right: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    font-size: 11px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 48px;
    position: relative;
  }

  .training-matrix.compact td {
    padding: 8px 6px;
    min-height: 36px;
    font-size: 10px;
  }

  .training-matrix td:first-child {
    position: sticky;
    left: 0;
    background: var(--panel-bg);
    z-index: 1;
    cursor: default;
    font-weight: 600;
    text-align: left;
    padding-left: 16px;
    box-shadow: 2px 0 4px rgba(0,0,0,0.1);
  }

  .training-matrix td.training-cell {
    border-radius: 6px;
    margin: 2px;
    border: none;
  }

  .training-matrix td.training-cell:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  /* Status chips with enhanced styling */
  .training-completed { 
    background: var(--stat-2-bg); 
    color: var(--stat-2-color);
  }
  .training-expiring { 
    background: var(--stat-3-bg); 
    color: var(--stat-3-color);
  }
  .training-expired { 
    background: var(--stat-4-bg); 
    color: var(--stat-4-color);
  }
  .training-missing { 
    background: var(--glass); 
    color: var(--muted); 
    opacity: 0.6;
  }

  /* Tooltip */
  .training-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }

  .training-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-top-color: rgba(0,0,0,0.9);
  }

  .training-cell:hover .training-tooltip {
    opacity: 1;
  }

  /* Cell details drawer */
  .cell-drawer {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: var(--panel-bg);
    border-left: 1px solid var(--border-color);
    box-shadow: -4px 0 20px rgba(0,0,0,0.1);
    z-index: 1000;
    transition: right 0.3s ease;
    overflow-y: auto;
  }

  .cell-drawer.open {
    right: 0;
  }

  .cell-drawer-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .cell-drawer-content {
    padding: 20px;
  }

  .cell-drawer .field {
    margin-bottom: 16px;
  }

  .cell-drawer .field label {
    display: block;
    font-weight: 600;
    margin-bottom: 4px;
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
  }

  .cell-drawer .field-value {
    padding: 8px 0;
    font-size: 14px;
  }

  .cell-drawer-actions {
    padding: 20px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .cell-drawer-actions .btn {
    flex: 1;
    min-width: 120px;
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .training-controls {
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
    }

    .training-filters {
      flex-wrap: wrap;
    }

    .training-legend {
      position: static;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .training-matrix {
      height: auto;
      min-height: 400px;
    }

    .training-matrix th:first-child {
      width: 140px;
      max-width: 140px;
    }

    .training-matrix th {
      width: 80px;
      max-width: 80px;
      font-size: 10px;
      padding: 12px 4px;
    }

    .training-matrix td {
      padding: 8px 4px;
      font-size: 10px;
    }

    .cell-drawer {
      width: 100%;
      right: -100%;
    }

    .cell-drawer.open {
      right: 0;
    }

    .cell-drawer-actions {
      flex-direction: column;
    }

    .cell-drawer-actions .btn {
      flex: none;
    }
  }

  /* Print styles */
  @media print {
    .training-controls,
    .cell-drawer,
    .training-legend {
      display: none !important;
    }

    .training-matrix {
      height: auto !important;
      overflow: visible !important;
    }

    .training-matrix-scroll {
      overflow: visible !important;
    }
  }
  
  /* Training Status Colors */
  .training-completed { background: var(--stat-2-bg); color: var(--stat-2-color); }
  .training-expiring { background: var(--stat-3-bg); color: var(--stat-3-color); }
  .training-expired { background: var(--stat-4-bg); color: var(--stat-4-color); }
  .training-missing { background: var(--glass); color: var(--muted); opacity: 0.6; }
  
  /* Training Modal */
  .training-modal .modal-content {
    width: min(600px, 90vw);
    max-height: 90vh;
    overflow-y: auto;
  }
  
  /* Training Types Management Modal */
  .training-types-modal .modal-content {
    width: min(800px, 95vw);
    max-height: 90vh;
    overflow-y: auto;
  }
  .training-type-row {
    display: grid;
    grid-template-columns: 2fr 1fr 80px 80px 80px 100px;
    gap: 12px;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
  }
  .training-type-row:last-child {
    border-bottom: none;
  }
  .training-type-row input, .training-type-row select {
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: var(--glass);
    color: var(--white);
    font-size: 12px;
  }
  .training-type-row button {
    padding: 4px 8px;
    font-size: 11px;
  }
  
  .training-upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: var(--glass);
  }
  .training-upload-zone:hover {
    border-color: var(--accent);
    background: var(--glass-2);
  }
  .training-upload-zone.dragover {
    border-color: var(--accent);
    background: var(--accent-2);
  }
</style>


<style>
  /* Toggle Switch Styles */
  .toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    background: var(--glass-2);
    border-radius: 24px;
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .toggle-switch:hover {
    background: var(--glass);
  }

  .toggle-slider {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 18px;
    height: 18px;
    background: var(--white);
    border-radius: 50%;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .toggle-switch input:checked + .toggle-slider {
    transform: translateX(20px);
    background: var(--accent);
  }

  .toggle-switch input:checked ~ .toggle-switch {
    background: var(--accent-2);
  }
</style>

<style id="stellar-light-theme">
  :root{ --bg-page:#f3f5f9; --panel-bg:#ffffff; --border-color:#e9edf5; --ink:#1f2937; --white:#111827; --muted:#667085; --accent:#a467ff; --accent-2:#658ae3; --mint:#01cabd; --success:#41d656; --warning:#fc6a24; --danger:#ef5463; --round:16px; --shadow-sm:0 1px 2px rgba(16,24,40,.06); --shadow-md:0 2px 6px rgba(16,24,40,.06), 0 12px 24px rgba(16,24,40,.04); }
  body{ background:var(--bg-page) !important; color:var(--ink); font-family:'Urbanist', Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  .bg{ position:fixed; inset:0; z-index:-1; background:var(--bg-page) !important; }
  .wave,.wave2{ display:none !important; }
  .sidebar{ background:var(--panel-bg) !important; border:1px solid var(--border-color) !important; border-radius:18px !important; box-shadow:0 2px 6px rgba(16,24,40,.06),0 12px 24px rgba(16,24,40,.04) !important; }
  .brand .t{ color:var(--white) !important; } .brand .hint{ color:var(--muted) !important; }
  .brand .logo{ box-shadow:none !important; border-radius:12px !important; border:1px solid var(--border-color) !important; background:#fff !important; }
  .nav button{ color:#475467 !important; background:transparent !important; border:1px solid transparent !important; border-radius:12px !important; padding:10px 12px !important; }
  .nav button:hover{ background:#f6f7fb !important; border-color:#f0f2f7 !important; transform:none !important; }
  .nav .icon{ width:18px; height:18px; color:#667085 !important; filter:none !important; opacity:1 !important; }
  .nav .nav-badge{ background:#eef2ff !important; color:#667085 !important; }
  .nav button.active{ background:#f5f1ff !important; border-color:#e8e1ff !important; color:#3a2b6d !important; box-shadow: inset 0 0 0 1px #e8e1ff !important; font-weight:600 !important; }
  .nav button.active .icon{ color:var(--accent) !important; }
  .btn{ background:#fff !important; border:1px solid #e7eaf3 !important; color:#344054 !important; box-shadow:0 1px 2px rgba(16,24,40,.06) !important; }
  .btn:hover{ background:#f8faff !important; }
  .btn.secondary{ background:#fff !important; border:1px solid var(--border-color) !important; color:#475467 !important; }
  .tab-controls .btn.secondary.active{ background:#f5f1ff !important; border-color:#e8e1ff !important; color:#3a2b6d !important; }
  .panel{ background:#fff !important; border:1px solid var(--border-color) !important; border-radius:16px !important; box-shadow:0 2px 6px rgba(16,24,40,.06),0 12px 24px rgba(16,24,40,.04) !important; }
  .panel-header svg{ color:#98a2b3 !important; }
  .panel-title{ color:var(--white) !important; }
  thead th{ background:#fafbff !important; color:#667085 !important; border-bottom:1px solid var(--border-color) !important; }
  tbody tr:nth-child(even){ background:#fcfcfd !important; }
  td{ border-bottom:1px solid var(--border-color) !important; }
  tbody tr:hover{ background:#f3f6ff !important; }
  tbody tr.selected{ background:#ebe9ff !important; }
  .chip{ background:#f4f6fb !important; color:#475467 !important; }
  .chip.success{ background:#eafaf1 !important; color:#037a48 !important; }
  .chip.danger{ background:#ffe9ec !important; color:#b42318 !important; }
  .chip.warning{ background:#fff3e6 !important; color:#9a5606 !important; }
  .cal-day{ background:#fff !important; border:1px solid var(--border-color) !important; box-shadow:0 1px 2px rgba(16,24,40,.06) !important; }
  .cal-day-label{ color:#111827 !important; } .cal-day-summary{ color:#667085 !important; }
  .cal-day-bar-bg{ background:#eef2f6 !important; }
  .cal-day-bar-fg{ background: linear-gradient(90deg, var(--mint), var(--success)) !important; }
  .cal-day-bar-fg.danger{ background: linear-gradient(90deg, #ffd3bf, var(--warning)) !important; }
  .cal-metric.success{ color:var(--success) !important; } .cal-metric.danger{ color:var(--warning) !important; }
  .card, .modal-content, .branding-card, .day-modal-card{ background:#fff !important; border:1px solid var(--border-color) !important; box-shadow:0 2px 6px rgba(16,24,40,.06),0 12px 24px rgba(16,24,40,.04) !important; }
  .auth, .modal{ background: rgba(15,23,42,.35) !important; }
  .field input, .field textarea{ background:#fff !important; border:1px solid var(--border-color) !important; color:var(--ink) !important; }
  .ui-select{ background:#fff !important; border:1px solid var(--border-color) !important; color:var(--ink) !important; }
  .cal-cell{ background:#fff !important; border:1px solid var(--border-color) !important; }
  .cal-day-num{ background:#f0f2f8 !important; color:#111827 !important; }
  .cal-cell.is-today .cal-day-num{ background:var(--accent) !important; color:#fff !important; }
  .cal-task-status.scheduled{ background:#e6eaf2 !important; color:#475467 !important; }
  .cal-task-status.done{ background:#eafaf1 !important; color:#037a48 !important; }
  .cal-task-status.missed{ background:#ffe9ec !important; color:#b42318 !important; }
  .training-matrix{ background:#fff !important; border:1px solid var(--border-color) !important; }
  .training-matrix th, .training-matrix td{ border-color:var(--border-color) !important; }
  .training-completed{ background:#eafaf1 !important; color:#027a48 !important; }
  .training-expiring{ background:#fff3e6 !important; color:#9a5606 !important; }
  .training-expired{ background:#ffe9ec !important; color:#b42318 !important; }
  .training-missing{ background:#f4f6fb !important; color:#667085 !important; }
  .footer{ color:#98a2b3 !important; }
</style>

<style id="stellar-light-color-boost">
  /* Add pastel card tints and vivid accents (no markup changes) */

  /* Week calendar panel gets a gentle purple/blue wash */
  #view-dashboard #week-calendar{
    background: linear-gradient(180deg,#f5f1ff 0%, #eef3ff 100%) !important;
    border-color:#e8e1ff !important;
  }
  /* Week calendar panel gets a gentle purple/blue wash */
  #view-dashboard #week-calendar{
    background: linear-gradient(180deg,#f5f1ff 0%, #eef3ff 100%) !important;
    border-color:#e8e1ff !important;
  }

  /* Cycle soft colors across the seven day cards */
  #week-grid .cal-day{ box-shadow: var(--shadow-sm); }
  #week-grid .cal-day:nth-child(1){ background:#f5f1ff !important; border-color:#e8e1ff !important; }
  #week-grid .cal-day:nth-child(1) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--accent), var(--accent-2)) !important; }

  #week-grid .cal-day:nth-child(2){ background:#eefdff !important; border-color:#d9f5ff !important; }
  #week-grid .cal-day:nth-child(2) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--mint), #7de9d0) !important; }

  #week-grid .cal-day:nth-child(3){ background:#fff5ec !important; border-color:#ffe5d3 !important; }
  #week-grid .cal-day:nth-child(3) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--warning), #ffd59c) !important; }

  #week-grid .cal-day:nth-child(4){ background:#eefcf5 !important; border-color:#d6f5e8 !important; }
  #week-grid .cal-day:nth-child(4) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--success), var(--mint)) !important; }

  #week-grid .cal-day:nth-child(5){ background:#f4f8ff !important; border-color:#e1ecff !important; }
  #week-grid .cal-day:nth-child(5) .cal-day-bar-fg{ background: linear-gradient(90deg, #6aa8ff, var(--accent-2)) !important; }

  #week-grid .cal-day:nth-child(6){ background:#fff0f4 !important; border-color:#ffd7e3 !important; }
  #week-grid .cal-day:nth-child(6) .cal-day-bar-fg{ background: linear-gradient(90deg, #ef5463, #fc6a24) !important; }

  #week-grid .cal-day:nth-child(7){ background:#eef7ff !important; border-color:#dceaff !important; }
  #week-grid .cal-day:nth-child(7) .cal-day-bar-fg{ background: linear-gradient(90deg, var(--accent-2), var(--accent)) !important; }

  /* Give the other two dashboard panels a subtle tint so the page isn't all-white */
  #view-dashboard .grid > .panel:nth-of-type(2){
    background: linear-gradient(180deg,#ffffff 0%, #f7fbff 100%) !important;
  }
  #view-dashboard .grid > .panel:nth-of-type(3){
    background: linear-gradient(180deg,#ffffff 0%, #f8f6ff 100%) !important;
  }

  /* Table header & hover colors a bit brighter for the light UI */
  #view-dashboard thead th{ background:#f6f8ff !important; border-bottom-color:#e7ecf5 !important; }
  #view-dashboard tbody tr:hover{ background:#edf2ff !important; }

  /* Active nav item with a soft purple glow so the menu feels alive */
  .nav button.active{ box-shadow: 0 8px 24px rgba(164,103,255,.18) !important; }
</style>

<style id="stellar-light-delight">
  :root{
    --radius-xl:20px;
    --border-soft:#eef1f8;
  }

  /* Subtle animated pastel blobs in the background */
  .bg::before, .bg::after { 
    content:""; position:absolute; pointer-events:none; z-index:0; 
    width:55vmax; height:55vmax; border-radius:50%; filter: blur(45px); opacity:.55;
    animation: floaty 24s ease-in-out infinite alternate;
  }
  .bg::before { left:-10vmax; top:-10vmax; background: radial-gradient(closest-side, #a467ff2b, transparent 70%); }
  .bg::after  { right:-8vmax; bottom:-12vmax; background: radial-gradient(closest-side, #01cabd26, transparent 70%); animation-duration: 28s; }
  @keyframes floaty { from { transform: translateY(-8px) } to { transform: translateY(12px) } }

  /* Gradient borders + gentle sheen on panels */
  .panel{ 
    position: relative;
    background: #fff !important; 
    border:1px solid transparent !important; 
    background: linear-gradient(#fff,#fff) padding-box, linear-gradient(180deg,#ecf1ff,#f9ecff) border-box !important;
    box-shadow: var(--shadow-md) !important;
  }
  /* Tint the two lower dashboard panels differently so the page isn't all white */
  #view-dashboard .grid > .panel:nth-of-type(2){
    background: linear-gradient(#fff,#fff) padding-box, linear-gradient(180deg,#ecf7ff,#f2ecff) border-box !important;
  }
  #view-dashboard .grid > .panel:nth-of-type(3){
    background: linear-gradient(#fff,#fff) padding-box, linear-gradient(180deg,#fdf5ee,#eefaf3) border-box !important;
  }
  .panel:hover::after{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background: linear-gradient(120deg, transparent 30%, #ffffff80 50%, transparent 70%);
    transform: translateX(-120%);
    animation: sheen 1.2s ease forwards;
  }
  @keyframes sheen { to { transform: translateX(120%);} }

  /* Icon chips in panel headers */
  .panel-header svg{
    padding:8px; border-radius:12px; 
    background: linear-gradient(180deg,#f5f1ff,#edf0ff);
    box-shadow: 0 6px 24px rgba(164,103,255,.15), inset 0 0 0 1px #eae6ff;
  }
  #week-calendar .panel-header svg{ background: linear-gradient(180deg,#f5f1ff,#eef3ff); }
  #view-dashboard .grid > .panel:nth-of-type(2) .panel-header svg{ background: linear-gradient(180deg,#eefcf5,#e8fff9); }
  #view-dashboard .grid > .panel:nth-of-type(3) .panel-header svg{ background: linear-gradient(180deg,#fff0f4,#fff7ef); }

  /* Sidebar icons as soft tiles; active gets a purple glow */
  .nav .icon{ padding:6px; border-radius:10px; background:#f1f2f7; box-shadow: inset 0 0 0 1px var(--border-color), 0 4px 10px rgba(17,24,39,.05); }
  .nav button.active .icon{ background: linear-gradient(180deg,#f5f1ff,#e9e2ff); box-shadow: inset 0 0 0 1px #e1d7ff, 0 8px 18px rgba(164,103,255,.25); }

  /* Progress bars get animated stripes for a lively feel */
  .cal-day-bar-fg{ position:relative; overflow:hidden; box-shadow: 0 0 0 1px #fff inset, 0 6px 14px rgba(16,24,40,.07); }
  .cal-day-bar-fg::after{ content:""; position:absolute; inset:0; background: repeating-linear-gradient(45deg, #ffffff40 0 8px, #ffffff00 8px 16px); transform: translateX(-100%); animation: slide-stripes 2s linear infinite; }
  @keyframes slide-stripes{ to { transform: translateX(100%);} }

  /* Table rows: brighter hover with a colored edge */
  #view-dashboard tbody tr:hover{ background:#f7f9ff !important; box-shadow: inset 3px 0 0 #a467ff; }

  /* Calendar cards lift on hover */
  #week-grid .cal-day{ transition: transform .18s ease, box-shadow .18s ease; }
  #week-grid .cal-day:hover{ transform: translateY(-2px); box-shadow: 0 10px 24px rgba(16,24,40,.08); }
</style>

<style id="layout-scrollless">
  /* Adjusted: allow page scrolling while keeping inner scroll containers functional */
  html, body { height: 100%; overflow: auto !important; }
  body { overscroll-behavior: auto; }
  .app { min-height: 100vh; height: auto; overflow: visible; }

  /* Sidebar: full-height with its own scroll */
  .sidebar{ position: sticky; top: 22px; height: calc(100vh - 44px); max-height: calc(100vh - 44px); overflow-y: auto; overscroll-behavior: contain; }
  .app.collapsed #sidebar{ height: calc(100vh - 44px); max-height: calc(100vh - 44px); overflow-y: auto; }

  /* Main content: allow natural page scroll; inner views still manage their own scrolling */
  .content{ height: auto; overflow: visible; display:flex; flex-direction:column; }
  section.view{ min-height: 0; }
  section.view.active{ flex: 1 1 auto; overflow: visible; display:flex; flex-direction:column; }

  /* Layout fix: ensure inner view/panel elements can't force the grid/sidebar to reflow
    or be visually overlapped. This prevents long/wide tables or fixed children from
    pushing the complaints reporting content "under" the menu. */
  .content, section.view, section.view .panel, .panel .table-wrap { min-width: 0; box-sizing: border-box; }
  /* Keep panels in the normal stacking context but above background layers. Avoid
    using a very high z-index so the sidebar and modals keep precedence when needed. */
  section.view .panel { position: relative; z-index: 1; }
  
  /* Specific fix for layout issues on multiple pages */
  #view-complaints-reporting,
  #view-schedules,
  #view-submissions,
  #view-checktypes,
  #view-staff,
  #view-settings {
    position: static !important;
    width: auto !important;
    max-width: none !important;
    left: auto !important;
    right: auto !important;
    top: auto !important;
    bottom: auto !important;
    margin: 0 !important;
    transform: none !important;
  }
  
  #view-complaints-reporting .panel,
  #view-schedules .panel,
  #view-submissions .panel,
  #view-checktypes .panel,
  #view-staff .panel,
  #view-settings .panel {
    position: static !important;
    width: auto !important;
    max-width: none !important;
    left: auto !important;
    right: auto !important;
    top: auto !important;
    bottom: auto !important;
    margin: 0 !important;
    transform: none !important;
  }

  /* Panels are flex columns so inner pieces can scroll */
  section.view .panel{ flex: 1 1 auto; display:flex; flex-direction:column; overflow: visible; min-height: 0; }
  .panel .table-wrap{ flex: 1 1 auto; overflow: auto; min-height: 0; }

  /* Grids inside views become the scroll container, not the page */
  section.view .grid{ flex: 1 1 auto; overflow: auto; min-height: 0; }
  .grid .panel{ flex: 0 0 auto; min-height: 240px; }

  /* Calendar view: allow the month grid to scroll inside the panel */
  #view-calendar .panel{ display:flex; flex-direction:column; }
  #cal-grid{ min-height: 0 !important; overflow: auto; }

  /* Users/Items/etc: ensure their tables stretch and scroll */
  #view-users .table-wrap,
  #view-items .table-wrap,
  #view-rooms .table-wrap,
  #view-complaints .table-wrap,
  #view-training .training-matrix{ flex: 1 1 auto; max-height: none; overflow: auto; }

  /* Dashboard cards: weekly grid can scroll horizontally on very small screens without causing page scroll */
  #week-grid{ overflow: auto; }

  /* Footer never pushes the page to scroll */
  .footer{ flex: 0 0 auto; }
</style>

<style id="collapsed-icon-rail">
  /* ——— Collapsed Sidebar: show every icon in a single scrollable rail ——— */
  #sidebar { -webkit-overflow-scrolling: touch; }

  /* Container for the cloned buttons (built by JS) */
  #icon-rail { display:none; }
  .app.collapsed #sidebar #icon-rail {
    display: flex !important;
    flex-direction: column;
    gap: 8px;
  }
  .app.collapsed #sidebar #icon-rail button{
    all: unset;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
  }
  .app.collapsed #sidebar #icon-rail .menu-item-label,
  .app.collapsed #sidebar #icon-rail .nav-badge{ display:none !important; }

  /* Hide original grouped menus and top-level buttons when collapsed —
     the rail shows clones of *all* items so nothing is missing */
  .app.collapsed #sidebar .nav > .nav-group,
  .app.collapsed #sidebar .nav > .nav-group-toggle,
  .app.collapsed #sidebar .nav > button[data-section]{
    display: none !important;
  }

  /* Make icons a consistent size in the rail */
  .app.collapsed #sidebar #icon-rail .icon{ width:22px; height:22px; margin:0; }

  /* Ensure scrolling always works on the collapsed sidebar */
  .app.collapsed #sidebar{ overflow-y: auto !important; }

  /* ——— JAZZY COMPLAINTS DASHBOARD STYLES ——— */
  
  /* Animated gradient backgrounds */
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  @keyframes countUp {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* Enhanced stat cards with gradients and animations */
  #view-complaints-dashboard .stat-card {
    background: linear-gradient(135deg, var(--glass), rgba(255,255,255,0.1)) !important;
    border: 1px solid rgba(255,255,255,0.2);
    backdrop-filter: blur(20px);
    border-radius: 16px !important;
    padding: 20px !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.6s ease-out;
    color: white !important;
  }
  
  #view-complaints-dashboard .stat-card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    border-color: var(--accent-1);
  }

  #view-complaints-dashboard .stat-card h3,
  #view-complaints-dashboard .stat-card .stat-number,
  #view-complaints-dashboard .stat-card .stat-label {
    color: white !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    font-weight: 600;
  }

  #view-complaints-dashboard .stat-card .stat-number {
    font-weight: 800;
  }

  /* Enhanced button styling for dashboard */
  #view-complaints-dashboard .btn {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  #view-complaints-dashboard .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  }

  #view-complaints-dashboard .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
  }

  #view-complaints-dashboard .btn:hover::before {
    left: 100%;
  }
  
  #view-complaints-dashboard .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
  }
  
  #view-complaints-dashboard .stat-card:hover::before {
    left: 100%;
  }
  
  /* Animated numbers */
  #view-complaints-dashboard .stat-num {
    font-size: 2.5rem !important;
    font-weight: 800 !important;
    background: linear-gradient(45deg, var(--accent-1), var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: countUp 0.8s ease-out;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  #view-complaints-dashboard .stat-label {
    font-weight: 600 !important;
    color: var(--muted) !important;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.85rem !important;
  }
  
  /* Colorful stat card variants */
  #view-complaints-dashboard .stat-card:nth-child(1) {
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    animation-delay: 0.1s;
  }
  
  #view-complaints-dashboard .stat-card:nth-child(2) {
    background: linear-gradient(135deg, #f093fb, #f5576c) !important;
    animation-delay: 0.2s;
  }
  
  #view-complaints-dashboard .stat-card:nth-child(3) {
    background: linear-gradient(135deg, #4facfe, #00f2fe) !important;
    animation-delay: 0.3s;
  }
  
  #view-complaints-dashboard .stat-card:nth-child(4) {
    background: linear-gradient(135deg, #43e97b, #38f9d7) !important;
    animation-delay: 0.4s;
  }
  
  /* Glowing dashboard panels */
  #view-complaints-dashboard .panel > div[style*="background:var(--glass)"] {
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)) !important;
    border: 1px solid rgba(255,255,255,0.2);
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    animation: fadeInUp 0.8s ease-out;
  }
  
  #view-complaints-dashboard .panel > div[style*="background:var(--glass)"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    border-color: rgba(255,255,255,0.3);
  }
  
  /* Enhanced category and status lists */
  #cmp-top-categories > div, #cmp-status-breakdown > div {
    padding: 12px 16px !important;
    margin: 8px 0 !important;
    background: linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    border-radius: 8px;
    border-left: 4px solid var(--accent-1);
    transition: all 0.2s ease;
    animation: fadeInUp 0.5s ease-out;
  }
  
  #cmp-top-categories > div:hover, #cmp-status-breakdown > div:hover {
    background: linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
    transform: translateX(4px);
    border-left-color: var(--accent-2);
  }
  
  /* Trend chart enhancements */
  #complaints-trend {
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    transition: all 0.3s ease;
  }
  
  #complaints-trend:hover {
    filter: drop-shadow(0 6px 12px rgba(0,0,0,0.15));
  }
  
  /* Enhanced quick action buttons */
  #view-complaints-dashboard .btn {
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2)) !important;
    border: none !important;
    border-radius: 12px !important;
    padding: 12px 24px !important;
    font-weight: 600 !important;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    position: relative;
    overflow: hidden;
  }
  
  #view-complaints-dashboard .btn:hover {
    transform: translateY(-2px) scale(1.05) !important;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
  }
  
  #view-complaints-dashboard .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  
  #view-complaints-dashboard .btn:hover::before {
    left: 100%;
  }
  
  /* Dashboard title enhancement */
  #view-complaints-dashboard .h1 {
    background: linear-gradient(45deg, var(--accent-1), var(--accent-2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2.5rem !important;
    font-weight: 800 !important;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    animation: fadeInUp 0.5s ease-out;
  }
  
  /* Loading animation for dashboard widgets */
  #cmp-top-categories:empty::before,
  #cmp-status-breakdown:empty::before {
    content: '';
    display: block;
    width: 40px;
    height: 40px;
    margin: 20px auto;
    border: 4px solid rgba(255,255,255,0.1);
    border-top: 4px solid var(--accent-1);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Stagger animations for dashboard elements */
  #view-complaints-dashboard .stat-card:nth-child(1) { animation-delay: 0.1s; }
  #view-complaints-dashboard .stat-card:nth-child(2) { animation-delay: 0.2s; }
  #view-complaints-dashboard .stat-card:nth-child(3) { animation-delay: 0.3s; }
  #view-complaints-dashboard .stat-card:nth-child(4) { animation-delay: 0.4s; }
  
  /* Floating particles background effect */
  #view-complaints-dashboard::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 20% 20%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
    animation: gradientShift 15s ease infinite;
    background-size: 200% 200%;
  }
  
  /* Responsive adjustments for dashboard */
  @media (max-width: 768px) {
    #view-complaints-dashboard .stat-card {
      padding: 16px !important;
    }
    
    #view-complaints-dashboard .stat-num {
      font-size: 2rem !important;
    }
    
    #view-complaints-dashboard .h1 {
      font-size: 2rem !important;
    }
    
    /* Stack dashboard panels on mobile */
    #view-complaints-dashboard div[style*="display:grid; grid-template-columns: 2fr 1fr"] {
      grid-template-columns: 1fr !important;
      gap: 16px !important;
    }
    
    #view-complaints-dashboard div[style*="display:flex; gap:16px"] {
      flex-direction: column !important;
    }
  }
  
  /* Enhanced focus states for accessibility */
  #view-complaints-dashboard .btn:focus {
    outline: 2px solid var(--accent-1);
    outline-offset: 2px;
  }
  
  /* Interactive elements pulse on focus */
  #view-complaints-dashboard .stat-card:focus-within {
    animation: pulse 2s infinite;
  }
  
  /* Smooth transitions for theme changes */
  * {
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
  }
</style>

<style id="project-management-styles">
  /* Project Management Styles */
  .task-type {
    background: var(--accent-bg, rgba(164, 103, 255, 0.1));
    color: var(--accent, #a467ff);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: capitalize;
  }
  
  .type-feature { background: rgba(40, 167, 69, 0.1); color: #28a745; }
  .type-page { background: rgba(23, 162, 184, 0.1); color: #17a2b8; }
  .type-bug { background: rgba(220, 53, 69, 0.1); color: #dc3545; }
  .type-issue { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
  .type-enhancement { background: rgba(108, 117, 125, 0.1); color: #6c757d; }
  .type-maintenance { background: rgba(255, 138, 61, 0.1); color: #ff8a3d; }
  
  .status-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 50%;
  background: var(--border-color);
  font-size: 12px;
  }
  
  .status-todo { background: rgba(108, 117, 125, 0.1); }
  .status-in-progress { background: rgba(255, 193, 7, 0.1); }
  .status-testing { background: rgba(23, 162, 184, 0.1); }
  .status-completed { background: rgba(40, 167, 69, 0.1); }

  /* clearer open/closed visuals */
  .status-open { background: linear-gradient(180deg, rgba(220,53,69,0.08), rgba(220,53,69,0.03)); color: #dc3545; border: 1px solid rgba(220,53,69,0.12); }
  .status-closed { background: linear-gradient(180deg, rgba(40,167,69,0.12), rgba(40,167,69,0.04)); color: #198754; border: 1px solid rgba(40,167,69,0.14); }
  
  .task-title {
    font-weight: 500;
    color: var(--white);
  }
  
  .task-description {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
    line-height: 1.3;
  }
  
  .tab-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
  }
  
  .tab-controls .btn.active {
    background: var(--accent);
    color: white;
  }
  
  .task-issue-row {
    position: relative;
  }
  
  .highlight-issues .task-issue-row {
    background-color: rgba(220, 53, 69, 0.05) !important;
    border-left: 3px solid var(--danger-color, #dc3545) !important;
  }
  
  .highlight-issues .task-issue-row:hover {
    background-color: rgba(220, 53, 69, 0.1) !important;
  }
  
  .btn-icon {
    background: none !important;
    border: none !important;
    cursor: pointer !important;
    padding: 4px !important;
    border-radius: 4px !important;
    transition: background-color 0.2s ease !important;
  }
  
  .btn-icon:hover {
    background: var(--border-color) !important;
  }
  
  /* Toggle Slider styles for project management */
  .toggle-slider {
    position: relative;
    width: 40px;
    height: 20px;
    background: #ccc;
    border-radius: 20px;
    transition: 0.3s;
    cursor: pointer;
  }
  
  .toggle-slider:before {
    content: "";
    position: absolute;
    height: 16px;
    width: 16px;
    left: 2px;
    top: 2px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
  }
  
  #highlight-issues-toggle:checked + .toggle-slider {
    background: var(--danger-color, #dc3545);
  }
  
  #highlight-issues-toggle:checked + .toggle-slider:before {
    transform: translateX(20px);
  }
  
  /* Context Menu Styles */
  .context-menu {
    position: fixed;
    background: var(--panel-bg, white);
    border: 1px solid var(--border-color, #ccc);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    padding: 4px 0;
    min-width: 180px;
    display: none;
    font-family: inherit;
  }
  
  .context-menu-item {
    padding: 8px 16px;
    cursor: pointer;
    color: var(--white, #333);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.2s ease;
  }
  
  .context-menu-item:hover {
    background-color: var(--border-color, #f0f0f0);
  }
  
  .context-menu-item:active {
    background-color: var(--accent, #a467ff);
    color: white;
  }
</style>

<script>

    // === BRANDING MODAL + UPLOADS ===
    const brandingBtn = document.getElementById('btn-branding');
    const brandingModal = document.getElementById('branding-modal');
    const brandingClose = document.getElementById('branding-close');
    const brandingCancel = document.getElementById('branding-cancel');
    const brandingForm = document.getElementById('branding-form');
    const logoInput = document.getElementById('branding-logo');
    const sigInput  = document.getElementById('branding-signature');
    const logoPrev  = document.getElementById('branding-logo-preview');
    const sigPrev   = document.getElementById('branding-signature-preview');
    const brandErr  = document.getElementById('branding-error');
    const brandOK   = document.getElementById('branding-success');

    function openBranding(){ brandingModal?.classList.add('show'); brandErr.style.display='none'; brandOK.style.display='none'; }
    function closeBranding(){ brandingModal?.classList.remove('show'); }

    brandingBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openBranding(); });
    brandingClose?.addEventListener('click', closeBranding);
    brandingCancel?.addEventListener('click', closeBranding);

    function readPreview(input, img){
      if(!input?.files?.[0]){ img.src=''; return; }
      const file = input.files[0];
      const url = URL.createObjectURL(file);
      img.src = url;
    }
    logoInput?.addEventListener('change', ()=> readPreview(logoInput, logoPrev));
    sigInput?.addEventListener('change', ()=> readPreview(sigInput, sigPrev));

    async function uploadBranding(){
      try{
        brandErr.style.display='none'; brandOK.style.display='none';
        const bucket = 'branding';
        const siteSlug = (typeof ctx === 'object' && (ctx?.site_slug || ctx?.site_name)) ? (ctx.site_slug || String(ctx.site_name).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')) : 'default';
        const uploads = [];

        if(logoInput?.files?.[0]){
          const f = logoInput.files[0];
          const ext = (f.name.split('.').pop() || 'png').toLowerCase();
          const path = `${siteSlug}/logo.${ext}`;
          uploads.push(supabase.storage.from(bucket).upload(path, f, { upsert:true, cacheControl:'3600', contentType: f.type || 'image/png' }));
        }
        if(sigInput?.files?.[0]){
          const f = sigInput.files[0];
          const ext = (f.name.split('.').pop() || 'png').toLowerCase();
          const path = `${siteSlug}/signature.${ext}`;
          uploads.push(supabase.storage.from(bucket).upload(path, f, { upsert:true, cacheControl:'3600', contentType: f.type || 'image/png' }));
        }

        if(uploads.length === 0){ throw new Error('Please choose at least one file to upload.'); }
        const results = await Promise.all(uploads);
        const failed = results.find(r => r?.error);
        if(failed){ throw failed.error; }
        brandOK.textContent = 'Uploaded successfully.';
        brandOK.style.display = 'block';
        setTimeout(closeBranding, 900);
      }catch(err){
        console.error(err);
        brandErr.textContent = 'Upload failed: ' + (err?.message || err);
        brandErr.style.display = 'block';
      }
    }

    brandingForm?.addEventListener('submit', (e)=>{ e.preventDefault(); uploadBranding(); });

    // === Templates download enhancer for PIR modals ===
    (function installTemplateButtons(){
      // Watch DOM for the PIR manage modal opening and inject template links
      const observer = new MutationObserver(() => {
        // Find any modal/card whose title starts with 'Manage:'
        const cards = Array.from(document.querySelectorAll('.card, .panel, [role="dialog"], .branding-card, .day-modal-card'));
        for (const card of cards) {
          const h = card.querySelector('h2, h3, .panel-title');
          if (!h) continue;
          const heading = (h.textContent || '').trim();
          if (!/^Manage:\s*/i.test(heading)) continue;
          const title = heading.replace(/^Manage:\s*/i, '').trim();

          // Locate definition
          const def = (window.PIR_DEFINITIONS_DATA || []).find(d => (d.title||'').trim() === title);
          if (!def || !def.allow_templates || !Array.isArray(def.templates) || def.templates.length === 0) continue;

          // Find the file input (we'll append links under it)
          const fileInput = card.querySelector('input[type="file"]');
          if (!fileInput) continue;
          const container = fileInput.closest('.field') || fileInput.parentElement || card;

          // Prevent duplicate injection
          if (container.querySelector('#pir-template-downloads')) { continue; }

          // Build links (prefer Supabase public URL if available)
          const wrap = document.createElement('div');
          wrap.id = 'pir-template-downloads';
          wrap.className = 'hint';
          wrap.style.marginTop = '10px';

          const list = document.createElement('div');
          list.style.display = 'grid';
          list.style.gap = '6px';

          const bucket = def.templates_bucket || 'pir_templates';
          const prefix = def.templates_prefix || '';

          def.templates.forEach(t => {
            const p = (t && t.path) ? t.path : '';
            let href = '';
            try {
              if (window.supabase && supabase.storage) {
                const r = supabase.storage.from(bucket).getPublicUrl(p).data;
                href = r?.publicUrl || '';
              }
            } catch(e) { /* fallback below */ }
            if (!href && window.SUPABASE_URL) {
              href = `${window.SUPABASE_URL.replace(/\/$/, '')}/storage/v1/object/public/${bucket}/${p}`;
            }
            if (!href && typeof window.SUPABASE_URL === 'undefined') {
              href = 'https://unveoqnlqnobufhublyw.supabase.co/storage/v1/object/public/' + bucket + '/' + p;
            }

            const item = document.createElement('div');
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.alignItems = 'center';
            item.style.gap = '8px';

            const label = document.createElement('span');
            label.textContent = t.name || p || 'Template';
            label.style.flex = '1';
            label.style.overflow = 'hidden';
            label.style.textOverflow = 'ellipsis';

            const link = document.createElement('a');
            link.href = href || '#';
            link.textContent = href ? 'Download' : 'Unavailable';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';

            item.appendChild(label);
            item.appendChild(link);
            list.appendChild(item);
          });

          wrap.appendChild(list);
          container.appendChild(wrap);
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
    })();

window.addEventListener('DOMContentLoaded', function initPIRemlGenerator(){
    // Initialize any needed functionality
});

(function () {
  var ua = navigator.userAgent || "";
  var isIOSiPad = /iPad|iPhone|iPod/.test(ua) ||
                  (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
  var onIpadPage = /indexIpad\.html$/i.test(location.pathname);
  var bypass = location.search.includes("admin=1"); // add ?admin=1 to stay on Admin

  if (isIOSiPad && !onIpadPage && !bypass) {
    location.replace("indexIpad.html"); // same folder
  }
})();
</script>
<script>
// ——— Persisted sidebar group open/close ———
(function manageNavGroups(){
  function setOpen(id, open){
    const toggle = document.querySelector('.nav-group-toggle[aria-controls="'+id+'"]');
    const group = document.getElementById(id);
    if(!toggle || !group) return;
    toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    group.classList.toggle('collapsed', !open);
  }
  function restore(){
    document.querySelectorAll('.nav-group-toggle').forEach(t => {
      const id = t.getAttribute('aria-controls');
      const saved = localStorage.getItem('navGroup:'+id);
      const open = saved === 'open'; // default closed
      setOpen(id, open);
    });
  }
  document.addEventListener('DOMContentLoaded', restore);
  // Click delegation (works even if elements re-render)
  document.addEventListener('click', (e) => {
    const toggle = e.target.closest('.nav-group-toggle');
    if(!toggle) return;
    const id = toggle.getAttribute('aria-controls');
    // If sidebar is collapsed, treat the group toggle as a quick navigation to the group's
    // first child (icon) instead of expanding the group which is hidden in collapsed mode.
    const appCollapsed = document.getElementById('app')?.classList.contains('collapsed');
    if (appCollapsed) {
      const group = document.getElementById(id);
      if (group) {
        const firstBtn = group.querySelector('button[data-section]');
        if (firstBtn) {
          firstBtn.click();
          return;
        }
      }
      return;
    }

    const willOpen = toggle.getAttribute('aria-expanded') !== 'true';
    setOpen(id, willOpen);
    localStorage.setItem('navGroup:'+id, willOpen ? 'open' : 'collapsed');
  });
  // Keyboard support
  document.addEventListener('keydown', (e) => {
    const toggle = e.target && e.target.closest ? e.target.closest('.nav-group-toggle') : null;
    if(!toggle) return;
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      const id = toggle.getAttribute('aria-controls');
      const appCollapsed = document.getElementById('app')?.classList.contains('collapsed');
      if (appCollapsed) {
        const group = document.getElementById(id);
        if (group) {
          const firstBtn = group.querySelector('button[data-section]');
          if (firstBtn) { firstBtn.click(); return; }
        }
        return;
      }
      const willOpen = toggle.getAttribute('aria-expanded') !== 'true';
      setOpen(id, willOpen);
      localStorage.setItem('navGroup:'+id, willOpen ? 'open' : 'collapsed');
    }
  });
})();
</script>
<script>
// ——— Build a flat icon rail when the sidebar is collapsed (guarantees every icon is visible) ———
(function(){
  function initIconRail(){
    const app = document.getElementById('app');
    const nav = document.getElementById('nav');
    if (!app || !nav) return; // if something is really wrong, bail

    function collectButtons(){
      const list = [];
      nav.querySelectorAll(':scope > button[data-section]').forEach(b => list.push(b));
      nav.querySelectorAll('.nav-group button[data-section]').forEach(b => list.push(b));
      return list;
    }

    function ensureRail(){
      let rail = nav.querySelector('#icon-rail');
      if (!rail){
        rail = document.createElement('div');
        rail.id = 'icon-rail';
        nav.insertBefore(rail, nav.firstChild);
      }
      return rail;
    }

    function buildRail(){
      const rail = ensureRail();
      rail.innerHTML = '';
      collectButtons().forEach(orig => {
        const clone = orig.cloneNode(true);
        clone.addEventListener('click', () => orig.click());
        if (orig.classList.contains('active')) clone.classList.add('active');
        rail.appendChild(clone);
      });
      syncActive();
    }

    function syncActive(){
      const rail = nav.querySelector('#icon-rail');
      if (!rail) return;
      rail.querySelectorAll('button[data-section]').forEach(clone => {
        const key = clone.getAttribute('data-section');
        const orig = nav.querySelector(`button[data-section="${key}"]`);
        if (orig){
          clone.classList.toggle('active', orig.classList.contains('active'));
        }
      });
    }

    // Rebuild when the app toggles collapsed/expanded
    const mo = new MutationObserver(() => {
      if (app.classList.contains('collapsed')) buildRail();
    });
    mo.observe(app, { attributes: true, attributeFilter: ['class'] });

    // Keep clone "active" states in sync after any nav interaction
    nav.addEventListener('click', () => setTimeout(syncActive, 0));

    // Initial run: if already collapsed at load, build immediately
    if (app.classList.contains('collapsed')) buildRail();
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initIconRail);
  } else {
    initIconRail();
  }
})();
</script>
</head>
<body>
  <!-- Authentication Screen -->
  <div id="auth-wrapper" style="
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100vw; 
    height: 100vh; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: grid; 
    place-items: center; 
    z-index: 9999;
  ">
    <div style="
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(20px); 
      padding: 40px; 
      border-radius: 20px; 
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); 
      width: 400px; 
      max-width: 90vw;
    ">
      <div style="text-align: center; margin-bottom: 32px;">
        <img src="Animated_Logo.gif" alt="CheckLoop Logo" style="width: 80px; height: 80px; margin-bottom: 16px;">
        <h1 style="margin: 0; color: #2d3748; font-size: 28px; font-weight: 700;">CheckLoop</h1>
        <p style="margin: 8px 0 0 0; color: #718096; font-size: 16px;">Welcome Back</p>
        <p style="margin: 4px 0 0 0; color: #a0aec0; font-size: 14px;">Enter your credentials to access the admin dashboard.</p>
      </div>

      <form id="auth-form">
        <div style="margin-bottom: 20px;">
          <label for="auth-email" style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600;">Email</label>
          <input 
            type="email" 
            id="auth-email" 
            required 
            style="
              width: 100%; 
              padding: 12px; 
              border: 2px solid #e5e7eb; 
              border-radius: 8px; 
              font-size: 16px; 
              transition: border-color 0.2s;
              background: rgba(255, 255, 255, 0.8);
            "
            placeholder="ben.howard@stoke.nhs.uk"
          >
        </div>

        <div style="margin-bottom: 24px;">
          <label for="auth-password" style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600;">Password</label>
          <input 
            type="password" 
            id="auth-password" 
            required 
            style="
              width: 100%; 
              padding: 12px; 
              border: 2px solid #e5e7eb; 
              border-radius: 8px; 
              font-size: 16px; 
              transition: border-color 0.2s;
              background: rgba(255, 255, 255, 0.8);
            "
            placeholder="••••••"
          >
        </div>

        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; font-size: 14px;">
          <label style="display: flex; align-items: center; color: #6b7280;">
            <input type="checkbox" style="margin-right: 8px;"> Remember me
          </label>
          <a href="#" style="color: #667eea; text-decoration: none;">Forgot Password?</a>
        </div>

        <button 
          type="submit" 
          style="
            width: 100%; 
            padding: 14px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: opacity 0.2s;
          "
        >
          Sign In
        </button>

        <div id="auth-error" style="
          display: none; 
          background: #fee2e2; 
          color: #dc2626; 
          padding: 12px; 
          border-radius: 8px; 
          margin-top: 16px; 
          font-size: 14px;
        "></div>
      </form>

      <div style="text-align: center; margin-top: 24px; color: #9ca3af; font-size: 14px;">
        Don't have an account? <a href="#" style="color: #667eea; text-decoration: none;">Sign up here</a>
      </div>
    </div>
  </div>

  <div class="bg">
    <div class="wave"></div>
    <div class="wave wave2"></div>
  </div>

  <div class="app" id="app" aria-live="polite">
    <aside class="sidebar" id="sidebar">
      <!-- Updated sidebar toggle: SVG chevron positioned at the sidebar edge for clearer affordance -->
      <button id="toggleSidebar" class="sidebar-toggle" aria-label="Toggle sidebar" aria-expanded="true" title="Toggle sidebar">
        <svg class="sidebar-toggle-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor" />
        </svg>
      </button>
      <div class="brand">
        <img src="Animated_Logo.gif" alt="CheckLoop Logo" class="logo">
        <div>
          <div class="t">CheckLoop</div>
          <div class="hint">Admin</div>
        </div>
      </div>
      <nav class="nav" id="nav">
        <button class="active" data-section="dashboard"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span class="menu-item-label">Dashboard</span></button>

        <button data-section="project-management"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="menu-item-label">Project Management</span></button>

  <button class="nav-group-toggle" id="toggle-pre-inspection" type="button" aria-expanded="false" aria-controls="group-pre-inspection">Pre-Inspection <span class="caret" aria-hidden="true"></span></button>
  <div class="nav-group collapsed" id="group-pre-inspection">
          <button data-section="pre-inspection"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg><span class="menu-item-label">Pre-inspection</span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-checks" type="button" aria-expanded="false" aria-controls="group-checks">Checks & Audits <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-checks">
          <button data-section="training"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg><span class="menu-item-label">Training Tracker</span></button>
        </div>
          <button class="nav-group-toggle" id="toggle-complaints" type="button" aria-expanded="false" aria-controls="group-complaints">Complaints <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-complaints">
          <button data-section="complaints-dashboard"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg><span class="menu-item-label">Dashboard</span><span class="nav-badge" id="badge-complaints-dashboard"></span></button>
          <button data-section="complaints-reporting"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 6h18M3 12h18M3 18h18"/></svg><span class="menu-item-label">Reporting</span><span class="nav-badge" id="badge-complaints"></span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-scans" type="button" aria-expanded="false" aria-controls="group-scans">Scans <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-scans">
          <button data-section="calendar"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="menu-item-label">Calendar</span></button>
          <button data-section="schedules"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><polyline points="12 7 12 12 16 14"></polyline></svg><span class="menu-item-label">Schedules</span></button>
          <button data-section="submissions"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="6" height="6"></rect><rect x="15" y="3" width="6" height="6"></rect><rect x="3" y="15" width="6" height="6"></rect><path d="M15 15h2v2h-2z"></path><path d="M19 19h2"></path><path d="M19 15v2"></path></svg><span class="menu-item-label">Submissions</span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-config" type="button" aria-expanded="false" aria-controls="group-config">Configure <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-config">
          <button data-section="items"><svg class="icon" style="color: var(--muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4a2 2 0 0 0 1-1.73z"/>
            <path d="M3.27 6.96L12 12l8.73-5.04"/>
            <path d="M12 22V12"/>
          </svg><span class="menu-item-label">Items</span><span class="nav-badge" id="badge-items"></span></button>
          <button data-section="rooms"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 9l9-7 9 7"></path><path d="M9 22V12h6v10"></path><path d="M21 22H3a2 2 0 0 1-2-2V9"></path></svg><span class="menu-item-label">Rooms</span><span class="nav-badge" id="badge-rooms"></span></button>
          <button data-section="checktypes"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><polyline points="9 12 12 15 16 9"></polyline></svg><span class="menu-item-label">Check Types</span><span class="nav-badge" id="badge-ct"></span></button>
          <button data-section="quiz"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 1 1 5.83 1c0 2-3 2-3 4"/><line x1="12" y1="17" x2="12" y2="17"/></svg><span class="menu-item-label">Quiz</span><span class="nav-badge" id="badge-quiz"></span></button>
          <button data-section="staff"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="7" r="4"></circle><path d="M5.5 21a6.5 6.5 0 0 1 13 0"></path></svg><span class="menu-item-label">Staff</span><span class="nav-badge" id="badge-staff"></span></button>
        </div>

        <button class="nav-group-toggle" id="toggle-settings" type="button" aria-expanded="false" aria-controls="group-settings">Settings <span class="caret" aria-hidden="true"></span></button>
        <div class="nav-group collapsed" id="group-settings">
          <button data-section="settings"><svg class="icon" style="color: var(--muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9c.69 0 1.25-.56 1.25-1.25V3a2 2 0 1 1 4 0v.09c0 .69.56 1.25 1.25 1.25.37 0 .72-.15.97-.4l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.25.25-.4.6-.4.97V9c0 .69.56 1.25 1.25 1.25H21a2 2 0 1 1 0 4h-.09c-.69 0-1.25.56-1.25 1.25z"/>
          </svg><span class="menu-item-label">Site Settings</span></button>
          <button data-section="users"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg><span class="menu-item-label">Users</span></button>
        </div>
      </nav>
      
      <!-- User Profile Section -->
      <div class="user-profile">
        <div class="user-row">
          <div class="user-avatar" id="user-avatar">
            <span id="user-initials">U</span>
          </div>
          <div class="user-details">
            <div class="user-name" id="user-name">User</div>
            <div class="site-info" id="site-info">Site</div>
          </div>
        </div>
        <button class="btn-signout" id="signout" title="Sign Out">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
        </button>
      </div>
      
      <!-- Resize handle for dragging sidebar width -->
      <div id="sidebar-resize-handle"></div>
    </aside>

    <main class="content">
      <section class="view active" id="view-dashboard">
        <div class="footer">© CheckLoop • Built for GP surgeries • CQC Readiness Dashboard ✅</div>
      </section>

      <!-- Project Management Section -->
      <section class="view" id="view-project-management">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Project Management</h1>
              <button class="help-icon" onclick="showHelp('view-project-management')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <div class="toggle-switch">
                  <input type="checkbox" id="highlight-issues-toggle" style="display:none;">
                  <span class="toggle-slider"></span>
                </div>
                <span style="color: var(--white); font-weight: 600;">Highlight Issues</span>
              </label>
              <button class="btn" id="btn-refresh-tasks" onclick="loadProjectTasks()" title="Refresh tasks">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 5px;">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
                Refresh
              </button>
              <button class="btn" id="btn-add-task">Add Task</button>
            </div>
          </div>

          <!-- Status Overview Cards -->
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:24px;">
            <div class="stat-card">
              <div class="icon-wrap" style="--c: var(--stat-1-bg); --i: var(--stat-1-color);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <div class="stat-num" id="tasks-total">0</div>
                <div class="stat-label">Total Tasks</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="icon-wrap" style="--c: var(--stat-2-bg); --i: var(--stat-2-color);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
              </div>
              <div>
                <div class="stat-num" id="tasks-completed">0</div>
                <div class="stat-label">Completed</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="icon-wrap" style="--c: var(--stat-3-bg); --i: var(--stat-3-color);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
              </div>
              <div>
                <div class="stat-num" id="tasks-open">0</div>
                <div class="stat-label">Open Tasks</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="icon-wrap" style="--c: var(--stat-4-bg); --i: var(--stat-4-color);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
              </div>
              <div>
                <div class="stat-num" id="tasks-bugs">0</div>
                <div class="stat-label">Bugs</div>
              </div>
            </div>
          </div>

          <!-- Filter Tabs -->
          <div class="tab-controls" style="margin-bottom: 24px; display:flex; gap:8px;">
            <button class="btn secondary active" id="tab-all-tasks" data-filter="all">All Tasks</button>
            <button class="btn secondary" id="tab-bugs" data-filter="bug">🐛 Bugs</button>
            <button class="btn secondary" id="tab-features" data-filter="feature">✨ Features</button>
          </div>

          <!-- Tasks Table -->
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width: 48px;">#</th>
                  <th style="width: 64px;">Done</th>
                  <th style="width: 50px;">Status</th>
                  <th>Task</th>
                  <th>Type</th>
                  <th>Created</th>
                  <th style="width: 100px;">Actions</th>
                </tr>
              </thead>
              <tbody id="project-tasks-tbody">
                <tr><td colspan="7" class="muted">Loading tasks...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="view" id="view-quiz">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Quiz Management</h1>
              <button class="help-icon" onclick="showHelp('view-quiz')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn secondary" id="btn-quiz-refresh">Refresh</button>
              <a class="btn" id="btn-open-quiz" href="quiz.html?site=2" target="_blank">Open Quiz Page</a>
            </div>
          </div>

          <div class="table-wrap" style="margin-top:10px">
            <table>
              <thead id="quiz-thead">
                <tr><th class="muted">Loading schema…</th></tr>
              </thead>
              <tbody id="quiz-tbody">
                <tr><td class="muted">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="hint" style="margin-top:10px">Showing raw contents of <code>quiz_questions</code> from Supabase.</div>
        </div>
      </section>
      
      <!-- Users View (moved from Settings) -->
      <section class="view" id="view-users">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">User Management</h1>
              <button class="help-icon" onclick="showHelp('view-users')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <button class="btn" id="btn-invite-user">Invite User</button>
            </div>
          </div>

          <div class="settings-section" style="margin-top:20px">
            <h3>Practice Users</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="practice-users-tbody">
                  <tr><td colspan="5" class="muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Invite User Modal -->
        <div class="modal" id="invite-modal">
          <div class="modal-content" style="width:500px">
            <div class="modal-header">
              <h3>Invite User</h3>
              <button type="button" class="modal-close" id="invite-modal-close">&times;</button>
            </div>
            <form id="invite-form">
              <div class="field">
                <label>Full Name</label>
                <input type="text" id="invite-name" name="full_name" required>
              </div>
              <div class="field">
                <label>Email</label>
                <input type="email" id="invite-email" name="email" required>
              </div>
              <div class="field">
                <label>Access</label>
                <select id="invite-access" name="access" required>
                  <option value="admin">Admin</option>
                  <option value="staff">Staff</option>
                </select>
                <div class="hint">Choose account access level (Admin or Staff)</div>
              </div>
              <div class="field">
                <label>Role</label>
                <select id="invite-role" name="role_detail">
                  <option value="">—</option>
                </select>
              </div>
              <div class="field">
                <label>Reports To</label>
                <select id="invite-reports-to" name="reports_to_id">
                  <option value="">—</option>
                </select>
              </div>
              <div class="error" id="invite-error" style="display:none"></div>
              <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px">
                <button type="button" class="btn secondary" id="invite-cancel-btn">Cancel</button>
                <button type="submit" class="btn">Send Invitation</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <section class="view" id="view-pre-inspection">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Pre-Inspection Readiness</h1>
              <button class="help-icon" onclick="showHelp('view-pre-inspection')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <button class="btn secondary" id="pir-bulk-upload">Bulk Upload</button>
              <button class="btn secondary" id="pir-export">Generate Email Packages</button>
            </div>
          </div>
          
          <!-- Progress at a glance: dedicated full-width PIR panel -->
          <div class="pir-progress-panel">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
              <div style="font-weight:700;">Overall Progress</div>
              <button id="pir-progress-toggle" aria-expanded="true" title="Collapse/Expand" style="background:none;border:0;cursor:pointer;font-size:16px;padding:4px;">▾</button>
            </div>
            <div class="pir-progress-main" id="pir-progress-main">
              <div class="pir-progress-stats">
                <div>
                  <div class="muted">Overall Progress (Ready Items)</div>
                  <div class="pir-progress-text" id="pir-progress-text">0 / 0 Ready (0%)</div>
                </div>
                <div style="text-align:right">
                  <div class="muted-small">Scaled: 0 — 66</div>
                  <div class="large" id="pir-progress-large">0 / 66</div>
                </div>
              </div>

              <div>
                <div class="progress-bar-container">
                  <div class="progress-milestones">
                    <div class="milestone quarter"></div>
                    <div class="milestone half"></div>
                    <div class="milestone three-quarter"></div>
                  </div>
                  <div class="progress-bar-bg">
                    <div class="progress-bar-fg" id="pir-progress-bar" style="width: 0%;"></div>
                  </div>
                </div>
              </div>

              <div style="margin-top:12px;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                  <div style="font-weight:700;">Email package status</div>
                </div>
                <div class="email-status-circles" id="email-status-circles">
                  <!-- Email circles injected by JS -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Filter & sort pills -->
          <div class="pir-filters">
            <div class="pir-filter-pill active" data-filter="all">All</div>
            <div class="pir-filter-pill" data-filter="not-attached">Not Attached</div>
            <div class="pir-filter-pill" data-filter="ready">Ready</div>
            <div class="pir-filter-pill" data-filter="expiring-soon">Expiring Soon</div>
            <div class="pir-filter-pill" data-filter="outdated">Outdated</div>
            <div class="pir-filter-pill" data-filter="draft">Has Draft</div>
          </div>
          
          <div class="pir-layout">
            <!-- Sidebar TOC -->
            <div class="pir-toc">
              <div class="pir-toc-title">Categories</div>
              <div id="pir-toc-items">
                <div class="muted" style="padding: 20px; text-align: center; font-size: 12px;">Loading...</div>
              </div>
            </div>
            
            <!-- Main content -->
            <div class="pir-main">
              <div id="pir-docs-container"></div>
            </div>
          </div>
        </div>
        
        <!-- Bulk operations bar -->
        <div class="pir-bulk-bar" id="pir-bulk-bar">
          <div class="pir-bulk-count"><span id="pir-selected-count">0</span> items selected</div>
          <button class="btn secondary" id="pir-bulk-upload-selected">Bulk Upload Selected</button>
          <button class="btn secondary" id="pir-export-selected">Export Selected</button>
          <button class="btn secondary" id="pir-clear-selection">Clear Selection</button>
        </div>
        
        <!-- Preview Modal -->
        <div class="pir-preview-modal" id="pir-preview-modal">
          <div class="pir-preview-content">
            <div class="pir-preview-header">
              <h3 id="pir-preview-title">Document Preview</h3>
              <button class="pir-preview-close" id="pir-preview-close">Close</button>
            </div>
            <div class="pir-preview-body" id="pir-preview-body">
              <div style="padding: 40px; text-align: center; color: var(--muted);">Loading preview...</div>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="view-training">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Mandatory Training Management</h1>
              <button class="help-icon" onclick="showHelp('view-training')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <button class="btn secondary" id="btn-manage-training-types">Manage Training Types</button>
              <button class="btn" id="btn-export-training">Export Report</button>
            </div>
          </div>
          
          <div class="tab-controls" style="margin-bottom: 24px; display:flex; gap:8px;">
            <button class="btn secondary active" id="tab-clinical" data-tab="clinical">Clinical Staff</button>
            <button class="btn secondary" id="tab-non-clinical" data-tab="non-clinical">Non-Clinical Staff</button>
          </div>

          <div class="training-matrix" id="training-matrix-container">
            <!-- Simple Training Matrix Table -->

            <table id="training-matrix-table">
              <thead>
                <tr id="training-headers">
                  <th>Staff Member</th>
                </tr>
              </thead>
              <tbody id="training-tbody">
                <tr><td colspan="100%" class="muted">Loading training matrix...</td></tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top: 16px; display: flex; gap: 20px; font-size: 12px; color: var(--muted);">
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-2-bg); border-radius: 2px;"></div>
              <span>Valid</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-3-bg); border-radius: 2px;"></div>
              <span>Expiring ≤30 days</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--stat-4-bg); border-radius: 2px;"></div>
              <span>Expired</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 12px; height: 12px; background: var(--glass); border-radius: 2px;"></div>
              <span>No Record</span>
            </div>
          </div>
        </div>
      </section>

      <section class="view" id="view-calendar">
        <div class="panel">
          <div id="cal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <button id="cal-prev" class="btn secondary">‹ Prev</button>
            <div id="cal-month-year" class="panel-title">Loading...</div>
            <button id="cal-next" class="btn secondary">Next ›</button>
          </div>
          
          <div class="cal-legend" id="cal-legend">
            <div class="item"><span class="dot scheduled" aria-hidden="true"></span> Scheduled</div>
            <div class="item"><span class="dot done" aria-hidden="true"></span> Done</div>
            <div class="item"><span class="dot missed" aria-hidden="true"></span> Missed</div>
            <div class="item" style="margin-left:auto;">Frequency: <span class="freq-badge" style="margin-left:8px;">D</span> Daily <span class="freq-badge" style="margin-left:8px; margin-left:12px;">W</span> Weekly <span class="freq-badge" style="margin-left:8px; margin-left:12px;">M</span> Monthly</div>
          </div>

          <div id="cal-weekdays" style="display:grid; grid-template-columns: repeat(7, 1fr); text-align:center; margin-bottom:8px; font-weight:600; color:var(--muted); font-size:12px;">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div id="cal-grid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; min-height: 500px;">
          </div>
          <div id="cal-compliance-view" style="display: none;"></div>
        </div>
      </section>

      <section class="view" id="view-items">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Equipment & Asset Management</h1>
              <button class="help-icon" onclick="showHelp('view-items')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-item">Add Item</button>
          </div>
          <div class="table-wrap" style="margin-top:10px"><table>
            <thead><tr><th class="sortable" data-col="item_id">Code <span class="arrow" id="sort-item_id"></span></th><th class="sortable" data-col="item_name">Name <span class="arrow" id="sort-item_name"></span></th><th class="sortable" data-col="room_name">Room <span class="arrow" id="sort-room_name"></span></th><th class="sortable" data-col="default_check_type_name">Default Check <span class="arrow" id="sort-default_check_type_name"></span></th><th class="sortable" data-col="active">Active <span class="arrow" id="sort-active"></span></th></tr></thead>
            <tbody id="items-tbody" data-entity="items"><tr><td colspan="5" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-rooms">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Room & Location Management</h1>
              <button class="help-icon" onclick="showHelp('view-rooms')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-room">Add Room</button>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>Name</th><th>Owner</th></tr></thead>
            <tbody id="rooms-tbody" data-entity="rooms"><tr><td colspan="2" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

          <!-- Complaints Dashboard view -->
          <section class="view" id="view-complaints-dashboard">
            <div class="panel">
              <div class="page-header">
                <div class="page-title-wrapper">
                  <h1 class="page-title">Complaints Dashboard</h1>
                  <button class="help-icon" onclick="showHelp('view-complaints-dashboard')" title="Help">?</button>
                </div>
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--accent-1);">
                    <path d="M3 12h18m-9-9v18"/>
                  </svg>
                  <div>
                    <div style="color: white; font-size: 2rem; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                      📊 Complaints Dashboard
                    </div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 1rem; font-weight: 400; margin-top: 4px;">
                        Compliance Monitoring & Quality Improvement Analytics
                      </div>
                  </div>
                </div>
                <div style="display:flex; gap:10px; flex-direction: column; align-items: flex-end;">
                  <!-- Status Indicator -->
                  <div style="background: rgba(32, 191, 107, 0.06); padding: 6px 12px; border-radius: 16px; backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.04);">
                    <span style="color: #22c55e; font-weight: 700; font-size: 0.9rem;">✅ Status: OK</span>
                  </div>
                  <button class="btn" id="btn-new-complaint-dashboard" onclick="addComplaint()" style="background:linear-gradient(135deg, #43e97b, #38f9d7); color: white; font-weight: 600;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;">
                      <path d="M12 5v14M5 12h14"/>
                    </svg>
                    Add Complaint
                  </button>
                </div>
              </div>

              <!-- Top stats with icons -->
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:16px; margin-bottom:24px;">
                
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; flex-direction:column; gap:8px; position:relative;">
                  <div style="position:absolute; top:16px; right:16px; opacity:0.3;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                      <path d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5S20.55 6 20 6H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V6H4C3.45 6 3 5.55 3 5S3.45 4 4 4H7Z"/>
                    </svg>
                  </div>
                  <div class="stat-num" id="cmp-total" style="color:#fff; font-weight: 800; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">—</div>
                  <div class="stat-label" style="color:rgba(255,255,255,0.9); font-weight: 600;">Total Complaints (30d)</div>
                  <div style="color: rgba(255,255,255,0.7); font-size: 0.8rem; margin-top: 4px;">Reporting period: last 30 days</div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display:flex; flex-direction:column; gap:8px; position:relative;">
                  <div style="position:absolute; top:16px; right:16px; opacity:0.3;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                      <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"/>
                    </svg>
                  </div>
                  <div class="stat-num" id="cmp-open" style="color:#fff; font-weight: 800; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">—</div>
                  <div class="stat-label" style="color:rgba(255,255,255,0.9); font-weight: 600;">Active & Under Investigation</div>
                  <div style="color: rgba(255,255,255,0.7); font-size: 0.8rem; margin-top: 4px;">Requires attention</div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display:flex; flex-direction:column; gap:8px; position:relative;">
                  <div style="position:absolute; top:16px; right:16px; opacity:0.3;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                      <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z"/>
                    </svg>
                  </div>
                  <div class="stat-num" id="cmp-resolved" style="color:#fff; font-weight: 800; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">—</div>
                  <div class="stat-label" style="color:rgba(255,255,255,0.9); font-weight: 600;">Resolved & Closed</div>
                  <div style="color: rgba(255,255,255,0.7); font-size: 0.8rem; margin-top: 4px;">Resolution timeframe</div>
                </div>

                <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); display:flex; flex-direction:column; gap:8px; position:relative;">
                  <div style="position:absolute; top:16px; right:16px; opacity:0.3;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#333">
                      <path d="M18 16.08C17.24 16.08 16.56 16.38 16.04 16.85L8.91 12.7C8.96 12.47 9 12.24 9 12S8.96 11.53 8.91 11.3L15.96 7.19C16.5 7.69 17.21 8 18 8C19.66 8 21 6.66 21 5S19.66 2 18 2 15 3.34 15 5C15 5.24 15.04 5.47 15.09 5.7L8.04 9.81C7.5 9.31 6.79 9 6 9C4.34 9 3 10.34 3 12S4.34 15 6 15C6.79 15 7.5 14.69 8.04 14.19L15.16 18.34C15.11 18.55 15.08 18.77 15.08 19C15.08 20.61 16.39 21.92 18 21.92S20.92 20.61 20.92 19C20.92 17.39 19.61 16.08 18 16.08Z"/>
                    </svg>
                  </div>
                  <div class="stat-num" id="cmp-share" style="color:#333; font-weight: 800; text-shadow: 0 1px 3px rgba(255,255,255,0.5);">—</div>
                  <div class="stat-label" style="color:#333; font-weight: 600;">Shared for Learning</div>
                  <div style="color: rgba(51,51,51,0.7); font-size: 0.8rem; margin-top: 4px;">Team Development & Training</div>
                </div>

              </div>

              <!-- Compliance Metrics Row -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                
                <!-- Response Time Compliance -->
                <div class="stat-card" style="background: linear-gradient(135deg, #20bf6b 0%, #01a3a4 100%); padding: 20px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <h4 style="margin: 0 0 8px; font-size: 1rem; font-weight: 600; color: white;">⏱️ Response Times</h4>
                      <div style="font-size: 1.8rem; font-weight: 800; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">&lt; 24hrs</div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">Recommended: same-day acknowledgment</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="background: rgba(255,255,255,0.25); padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; backdrop-filter: blur(10px);">
                        <span style="color: white; font-weight: 700; font-size: 1.1rem;">—</span>
                      </div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Compliance Rate</div>
                    </div>
                  </div>
                </div>

                <!-- Resolution Quality -->
                <div class="stat-card" style="background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%); padding: 20px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <h4 style="margin: 0 0 8px; font-size: 1rem; font-weight: 600; color: white;">🎯 Resolution Quality</h4>
                      <div style="font-size: 1.8rem; font-weight: 800; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">—</div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">Average satisfaction rating</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="background: rgba(255,255,255,0.25); padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; backdrop-filter: blur(10px);">
                        <span style="color: white; font-weight: 700; font-size: 1.1rem;">—</span>
                      </div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Satisfied</div>
                    </div>
                  </div>
                </div>

                <!-- Learning & Improvement -->
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <h4 style="margin: 0 0 8px; font-size: 1rem; font-weight: 600; color: white;">📚 Learning Actions</h4>
                      <div style="font-size: 1.8rem; font-weight: 800; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">—</div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">Process improvements identified</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="background: rgba(255,255,255,0.25); padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; backdrop-filter: blur(10px);">
                        <span style="color: white; font-weight: 700; font-size: 1.1rem;">—</span>
                      </div>
                      <div style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">Implemented</div>
                    </div>
                  </div>
                </div>

              </div>

              <!-- Dashboard visuals: common categories, statuses etc. -->
              <div style="display:grid; grid-template-columns: 2fr 1fr; gap:16px; margin-bottom:24px;">
                <div style="background:var(--glass); border-radius:16px; padding:20px;">
                  <div style="font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; color: white;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    📊 Most Common Categories
                  </div>
                  <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 16px;">
                    Track complaint patterns to identify systemic issues and improvement opportunities
                  </div>
                  <div id="cmp-top-categories" style="min-height:120px;">Loading complaint categories...</div>
                </div>
                <div style="background:var(--glass); border-radius:16px; padding:20px;">
                  <div style="font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; color: white;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <path d="M8 12h8M12 8v8"/>
                    </svg>
                    📋 Current Status Overview
                  </div>
                  <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 16px;">
                    Real-time complaint resolution tracking
                  </div>
                  <div id="cmp-status-breakdown" style="min-height:120px;">Loading status breakdown...</div>
                </div>
              </div>

              <div style="display:flex; gap:20px; margin-bottom:16px; align-items:flex-start; flex-wrap:wrap;">
                <div style="flex:2; min-height:200px; background:var(--glass); border-radius:16px; padding:20px;">
                  <div style="font-weight:700; margin-bottom:16px; display:flex; align-items:center; gap:8px; color: white;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 3v18h18"/>
                      <path d="M7 12l4-4 4 4 6-6"/>
                    </svg>
                    Complaint Trends (Last 30 Days)
                  </div>
                  <div style="width: 100%; height: 160px; display: flex; align-items: center; justify-content: center;">
                    <svg id="dashboard-trend-chart" style="width: 100%; height: 100%; overflow: visible;"></svg>
                  </div>
                  <div style="margin-top: 16px; display: flex; justify-content: space-around; text-align: center;">
                    <div>
                      <div style="color: white; font-weight: 700; font-size: 1.3rem;">—</div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">vs Last Month</div>
                    </div>
                    <div>
                      <div style="color: white; font-weight: 700; font-size: 1.3rem;">—</div>
                      <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Daily Average</div>
                    </div>
                    <div>
                      <div style="color: white; font-weight: 700; font-size: 1.3rem;">—</div>
                      <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Peak Day</div>
                    </div>
                  </div>
                </div>
                <div style="flex:1; min-width:280px; background:var(--glass); border-radius:16px; padding:20px;">
                  <div style="font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px; color: white;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    Quick Actions
                  </div>
                  <button class="btn" id="btn-open-complaints-reporting" onclick="setActiveSection('complaints-reporting')" style="width:100%; margin-bottom:12px; background:linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; font-weight: 600; padding: 14px; border-radius: 8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                      <line x1="16" y1="13" x2="8" y2="13"/>
                      <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    📊 Open Reporting
                  </button>
                  <button class="btn" id="btn-refresh-complaints-dashboard" onclick="fetchComplaintsDashboardStats()" style="width:100%; margin-bottom:12px; background:linear-gradient(135deg, #4facfe, #00f2fe); color: white; border: none; font-weight: 600; padding: 14px; border-radius: 8px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;">
                      <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                    🔄 Refresh Data
                  </button>
                  <button class="btn" id="btn-generate-report" style="width:100%; margin-bottom:12px; background:linear-gradient(135deg, #a8edea, #fed6e3); color: #333; border: none; font-weight: 600; padding: 14px; border-radius: 8px;">
                    📋 Generate Report
                  </button>
                  <button class="btn" id="btn-checklist" style="width:100%; background:linear-gradient(135deg, #20bf6b, #01a3a4); color: white; border: none; font-weight: 600; padding: 14px; border-radius: 8px;">
                    ✅ Checklist
                  </button>
                  
                  <!-- Pre-Inspection Status Indicator -->
                  <div style="margin-top: 20px; padding: 16px; background: rgba(32, 191, 107, 0.2); border-radius: 12px; border-left: 4px solid #20bf6b; backdrop-filter: blur(10px);">
                    <div style="display: flex; align-items: center;">
                      <span style="font-size: 1.2rem; margin-right: 8px;">✅</span>
                      <div>
                        <div style="color: white; font-weight: 700; font-size: 0.9rem;">Status: OK</div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">All metrics within requirements</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Complaints Reporting view (list, filter, export, add, amend) -->
          <section class="view" id="view-complaints-reporting">
            <div class="panel">
              <div class="page-header">
                <div class="page-title-wrapper">
                  <h1 class="page-title">Complaints Reporting</h1>
                  <button class="help-icon" onclick="showHelp('view-complaints-reporting')" title="Help">?</button>
                </div>
                <div style="display:flex; gap:10px;">
                  <button class="btn secondary" id="complaints-export">Export</button>
                  <button class="btn" id="btn-new-complaint">Add Complaint</button>
                </div>
              </div>

              <!-- Filters -->
              <div style="display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap">
                <div style="display:flex; gap:8px; align-items:center;">
                  <label class="muted" style="font-size:13px;">From</label>
                  <input type="date" id="complaints-filter-start" class="ui-select" style="width:160px;">
                  <label class="muted" style="font-size:13px;">To</label>
                  <input type="date" id="complaints-filter-end" class="ui-select" style="width:160px;">
                </div>
                <select id="complaints-filter-category" class="ui-select" style="min-width:160px;"></select>
                <select id="complaints-filter-status" class="ui-select" style="min-width:140px;">
                  <option value="">All Statuses</option>
                  <option value="resolved">Resolved</option>
                  <option value="open">Open</option>
                </select>
                <input id="complaints-search" class="ui-select" placeholder="Search text or patient initials" style="flex:1; min-width:160px;">
              </div>

              <!-- Complaints table (list + actions) -->
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th style="width:36px"><input type="checkbox" id="cmp-select-all" aria-label="Select all"></th>
                      <th>Datetime</th>
                      <th>Patient</th>
                      <th>Category</th>
                      <th>Original complaint</th>
                      <th>Response</th>
                      <th>Lessons learned</th>
                      <th>Status</th>
                      <th>Share</th>
                      <th>Created by</th>
                      <th>Resolved at</th>
                      <th style="width:140px">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="complaints-tbody" data-entity="complaints"><tr><td colspan="12" class="muted">Loading…</td></tr></tbody>
                </table>
              </div>
            </div>
          </section>

          <script type="module" src="scripts/complaints-dashboard.js"></script>

      <section class="view" id="view-checktypes">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Check Type Configuration</h1>
              <button class="help-icon" onclick="showHelp('view-checktypes')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-ct">Add Check Type</button>
          </div>
          <div class="table-wrap" style="margin-top:10px"><table>
            <thead><tr><th>Name</th><th>Active</th></tr></thead>
            <tbody id="ct-tbody" data-entity="check_types"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-schedules">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Compliance Schedules</h1>
              <button class="help-icon" onclick="showHelp('view-schedules')" title="Help">?</button>
            </div>
            <button class="btn" id="btn-new-sched">Add Schedule</button>
          </div>

          <!-- Schedules Filters -->
          <div style="display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap">
            <select id="schedules-filter-room" class="ui-select" style="min-width:140px;">
              <option value="">All Rooms</option>
            </select>
            <select id="schedules-filter-check" class="ui-select" style="min-width:160px;">
              <option value="">All Check Types</option>
            </select>
            <select id="schedules-filter-frequency" class="ui-select" style="min-width:120px;">
              <option value="">All Frequencies</option>
            </select>
            <select id="schedules-filter-required" class="ui-select" style="min-width:100px;">
              <option value="">All</option>
              <option value="true">Required</option>
              <option value="false">Optional</option>
            </select>
            <input id="schedules-search" class="ui-select" placeholder="Search items..." style="flex:1; min-width:160px;">
          </div>

          <div class="table-wrap"><table>
            <thead><tr><th>Item</th><th>Room</th><th>Check</th><th>Frequency</th><th>Day</th><th>Required</th></tr></thead>
            <tbody id="sched-tbody" data-entity="item_allowed_types"><tr><td colspan="6" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-staff">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Staff Records</h1>
              <button class="help-icon" onclick="showHelp('view-staff')" title="Help">?</button>
            </div>
            <div style="display:flex; gap:10px;">
              <!-- Role management removed: roles are fixed to Admin and Staff -->
            </div>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>Name</th><th>Role</th><th>Reports To</th><th>Active</th></tr></thead>
            <tbody id="staff-tbody" data-entity="kiosk_users"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-submissions">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">Compliance Submissions</h1>
              <button class="help-icon" onclick="showHelp('view-submissions')" title="Help">?</button>
            </div>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>When</th><th>Staff</th><th>Rows</th><th>Comment</th></tr></thead>
            <tbody id="subs-tbody"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
          </table></div>
        </div>
      </section>

      <section class="view" id="view-settings">
        <div class="panel">
          <div class="page-header">
            <div class="page-title-wrapper">
              <h1 class="page-title">System Settings</h1>
              <button class="help-icon" onclick="showHelp('view-settings')" title="Help">?</button>
            </div>
          </div>
      
      
              <h3>Page Visibility</h3>
              
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px;">
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-1" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Dashboard</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-2" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Pre-inspection</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-3" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Mandatory Training</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-4" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Calendar</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-5" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Schedules</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-6" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Submissions</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-7" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Items</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-8" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Rooms</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-9" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Check Types</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-10" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Staff</span>
                  </label>
                </div>
                <div class="field">
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <div class="toggle-switch">
                      <input type="checkbox" id="page-toggle-11" style="display:none;">
                      <span class="toggle-slider"></span>
                    </div>
                    <span>Complaints</span>
                  </label>
                </div>
              </div>
              
              <div style="margin-top: 20px; text-align: center;">
                <!-- Save button removed per request -->
                <button type="button" class="btn secondary" id="debug-page-visibility" style="padding: 8px 16px; font-size: 14px;" onclick="testDebugFunction()">
                  Save
                </button>
                <br>
                <!-- Read-only textbox showing enabled toggles as an array/string -->
                <input type="text" id="debug-enabled-toggles" readonly placeholder="[]" style="display:none; width:100%; margin-top:8px; font-family:monospace; padding:8px; box-sizing:border-box;" />
                <!-- Editable box for entering a custom array (not wired to any logic yet) -->
                <textarea id="debug-custom-array" placeholder='["one","two"]' style="display:none; width:100%; margin-top:8px; font-family:monospace; padding:8px; box-sizing:border-box; min-height:48px;" ></textarea>
              </div>
              
              
              <!-- Debug Settings Section -->
              <div class="settings-section" style="margin-top:20px">

              </div>
            </div>
      </section>
    </main>
  </div>

  <script>
    // Keep the debug-enabled-toggles input in sync with the page visibility checkboxes
    (function(){
      function getToggleMap(){
        return {
          'page-toggle-1': 'dashboard',
          'page-toggle-2': 'pre-inspection',
          'page-toggle-3': 'training',
          'page-toggle-4': 'calendar',
          'page-toggle-5': 'schedules',
          'page-toggle-6': 'submissions',
          'page-toggle-7': 'items',
          'page-toggle-8': 'rooms',
          'page-toggle-9': 'checks',
          'page-toggle-10': 'staff',
          'page-toggle-11': 'complaints'
        };
      }

      function updateDebugEnabledToggles(){
        const input = document.getElementById('debug-enabled-toggles');
        if(!input) return;
        const map = getToggleMap();
        const enabled = [];
        Object.keys(map).forEach(id => {
          const el = document.getElementById(id);
          if(el && el.checked) enabled.push(map[id]);
        });
        input.value = JSON.stringify(enabled);
      }

      // Wire change listeners to toggles when they exist
      function wireToggleListeners(){
        const els = document.querySelectorAll('[id^="page-toggle-"]');
        els.forEach(el => {
          el.removeEventListener('change', updateDebugEnabledToggles);
          el.addEventListener('change', updateDebugEnabledToggles);
        });
      }

      // Expose for manual calls
      window.updateDebugEnabledToggles = updateDebugEnabledToggles;

      // Attempt to wire now and again after DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        wireToggleListeners();
        updateDebugEnabledToggles();
      });

      // If settings are initialized later, ensure we wire again
      // (initPageVisibilityToggles calls loadPagePermissions which sets toggles)
      const origInit = window.initPageVisibilityToggles;
      if(typeof origInit === 'function'){
        window.initPageVisibilityToggles = function(){
          const res = origInit.apply(this, arguments);
          // small delay to allow loadPagePermissions to set toggle states
          setTimeout(() => { wireToggleListeners(); updateDebugEnabledToggles(); }, 200);
          return res;
        };
      }
    })();
  </script>

  <script>
    (function(){
      function setQuizLinkSite(){
        var link = document.getElementById('btn-open-quiz');
        if(!link) return;
        try{
          var siteId = (window.ctx && (ctx.site_id || ctx.siteId)) ? (ctx.site_id || ctx.siteId) : null;
          if(!siteId) return;
          var u = new URL(link.getAttribute('href'), location.href);
          u.searchParams.set('site', siteId);
          link.setAttribute('href', u.pathname + u.search);
        }catch(e){}
      }
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', setQuizLinkSite);
      }else{
        setQuizLinkSite();
      }
    })();
  </script>


  <div id="day-modal" aria-hidden="true">
    <div class="day-modal-card">
      <button class="day-modal-close" id="day-modal-close" aria-label="Close">✕</button>
      <h2 class="day-modal-title">Details</h2>
      <div class="day-modal-body">Loading…</div>
    </div>
  </div>
  <div id="branding-modal" aria-hidden="true">
    <div class="branding-card">
      <button class="branding-close" id="branding-close" aria-label="Close">✕</button>
      <h2 style="margin:0 0 6px">Branding</h2>
      <div class="hint-mini">Upload a practice logo and a signature image. PNG with transparent background is ideal.</div>
      <form id="branding-form">
        <div class="branding-row">
          <div>
            <div class="muted" style="margin-bottom:6px">Logo</div>
            <div class="branding-preview"><img id="branding-logo-preview" alt="" /></div>
          </div>
          <div>
            <input type="file" id="branding-logo" accept="image/*" />
            <div class="hint-mini">Recommended: PNG, at least 600×300px.</div>
          </div>
        </div>
        <div class="branding-row">
          <div>
            <div class="muted" style="margin-bottom:6px">Signature</div>
            <div class="branding-preview"><img id="branding-signature-preview" alt="" /></div>
          </div>
          <div>
            <input type="file" id="branding-signature" accept="image/*" />
            <div class="hint-mini">Recommended: Transparent PNG.</div>
          </div>
        </div>
        <div class="branding-actions">
          <button type="button" class="btn secondary" id="branding-cancel">Cancel</button>
          <button type="submit" class="btn" id="branding-save">Upload</button>
        </div>
        <div class="error" id="branding-error" role="alert" style="display:none"></div>
        <div class="hint" id="branding-success" style="display:none">Uploaded successfully.</div>
      </form>
    </div>
  </div>

  <!-- Training Types Management Modal -->
  <div class="modal training-types-modal" id="training-types-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Manage Training Types</h3>
        <button type="button" class="modal-close" id="training-types-close">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <p style="color: var(--muted); font-size: 14px; margin-bottom: 16px;">
          Configure training modules and their expiry periods. When staff upload training certificates, 
          the expiry date will be automatically calculated based on these settings.
        </p>
        
        <div class="training-type-row" style="font-weight: 600; color: var(--accent-2); border-bottom: 2px solid var(--border-color);">
          <div>Training Name</div>
          <div>Expiry Period</div>
          <div>Clinical</div>
          <div>Non-Clinical</div>
          <div>Active</div>
          <div>Actions</div>
        </div>
        
        <div id="training-types-list">
          <div style="padding: 20px; text-align: center; color: var(--muted);">Loading...</div>
        </div>
        
        <button type="button" class="btn" id="add-training-type" style="margin-top: 16px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add New Training Type
        </button>
      </div>
      
      <div class="error" id="training-types-error" style="display:none"></div>
      
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
        <button type="button" class="btn secondary" id="training-types-cancel">Cancel</button>
        <button type="button" class="btn" id="save-training-types">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Training Record Modal -->
  <div class="modal training-modal" id="training-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="training-modal-title">Update Training Record</h3>
        <button type="button" class="modal-close" id="training-modal-close">&times;</button>
      </div>
      <form id="training-form">
        <input type="hidden" id="training-staff-id">
        <input type="hidden" id="training-type-id">
        
        <div class="field">
          <label>Staff Member</label>
          <input type="text" id="training-staff-name" disabled>
        </div>
        
        <div class="field">
          <label>Training Module</label>
          <input type="text" id="training-type-name" disabled>
        </div>
        
        <div class="field">
          <label>Completion Date</label>
          <input type="date" id="training-completion-date" required>
        </div>
        
        <div class="field">
          <label>Expiry Date (if applicable)</label>
          <input type="date" id="training-expiry-date">
        </div>
        
        <div class="field">
          <label>Certificate</label>
          <div class="training-upload-zone" id="training-upload-zone">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 12px; color: var(--muted);">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <p>Drop certificate here or click to browse</p>
            <p style="font-size: 11px; color: var(--muted); margin-top: 8px;">PDF, JPG, PNG up to 10MB</p>
          </div>
          <input type="file" id="training-certificate" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
          <div id="training-current-file" style="display: none; margin-top: 8px; padding: 8px; background: var(--glass); border-radius: 8px;">
            <span id="training-file-name"></span>
            <button type="button" class="btn secondary" style="margin-left: 8px; padding: 4px 8px; font-size: 11px;" onclick="downloadTrainingCertificate()">Download</button>
          </div>
        </div>
        
        <div class="field">
          <label>Notes</label>
          <textarea id="training-notes" placeholder="Optional notes about this training..."></textarea>
        </div>
        
        <div class="error" id="training-error" style="display:none"></div>
        
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px">
          <button type="button" class="btn secondary" id="training-cancel-btn">Cancel</button>
          <button type="button" class="btn secondary" id="training-delete-btn" style="display: none;">Delete Record</button>
          <button type="submit" class="btn">Save Training Record</button>
        </div>
      </form>
    </div>
  </div>

<script>
  // --- PRE-INSPECTION (PIR) DATA DEFINITIONS (v2 - Enhanced for Email Generation) ---
// This block contains the definitions for all pre-inspection items.
// It has been updated with an `email_blurb` for each item to facilitate automatic email generation.
window.PIR_DEFINITIONS_DATA = [
    // EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Statement of purpose", 
        item_type: "file_only",
        description: "Upload your existing Statement of Purpose OR download and complete the official templates, then upload the finished document.",
        allow_upload: true,
        file_label: "Attached File",
        file_hint: "Uploading a new file will replace the existing one.",
        allow_templates: true,
        templates_bucket: "pir_templates",
        templates_prefix: "",
        templates: [
          { label: "Template – Part 1 (Provider)",   path: "20120418_100457_v2_00_statement_of_purpose_pt_1_for_pub_unprotected.doc" },
          { label: "Template – Part 2 (Aims & objectives)", path: "20120327_100457_v2_00_statement_of_purpose_pt_2_for_pub_unprotected.doc" },
          { label: "Template – Part 3 (Location)",  path: "20120418_100457_v2_00_statement_of_purpose_pt_3_for_pub_unprotected.doc" },
          { label: "Template – Part 4 (Registered manager)", path: "20120413_100457_v2_00_statement_of_purpose_pt_4_for_pub_unprotected.doc" }
        ],
        email_blurb: "Provides our Statement of Purpose, detailing the practice's aims, services, and patient population."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Copy of Major incident/business continuity", 
        item_type: "file_only",
        email_blurb: "Attached is our Major Incident and Business Continuity Plan."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Medical emergencies policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for handling medical emergencies within the practice."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Chaperone policy", 
        item_type: "file_only",
        email_blurb: "Attached is our Chaperone Policy for patient consultations."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Induction process", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Induction Structure: Describe the phases and timeline of your induction process for different staff roles (clinical, admin).", 
            "Key Content & Policies: What essential topics are covered (e.g., safeguarding, H&S, IPC, confidentiality, chaperone policy)?", 
            "Competency Assessment: How do you verify and document that new staff are competent and confident in their role at the end of the induction period?"
        ], 
        description: "Describe the process and/or attach the induction pack/checklist.",
        email_blurb: "Provides a summary of our staff induction process, with the induction pack attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Online services policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the provision and use of online patient services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Access policy", 
        item_type: "file_only",
        email_blurb: "Attached is our Patient Access Policy, detailing how patients can access our services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Registration policy (incl access to medical records)", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for patient registration and access to medical records."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Home visits/care home protocol", 
        item_type: "file_only",
        email_blurb: "Attached is our protocol for conducting home visits and supporting care homes."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for supporting carers", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Identification Strategy: How do you proactively identify patients who are carers?", 
            "Support & Signposting: What specific support is offered and which local/national services do you signpost to?", 
            "Recording & Flagging: How do you maintain an up-to-date carers' register in the clinical system?"
        ], 
        description: "Describe the process and attach any relevant leaflets or policies.",
        email_blurb: "Details our process for identifying and supporting carers, with relevant leaflets attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Number of carers identified and percentage", 
        item_type: "dual_number", 
        labels: ["Number Identified", "Percentage (%)"],
        email_blurb: "Provides the current number and percentage of identified carers on our patient list."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for bereaved patients", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Immediate Steps: What are the immediate administrative and clinical steps upon notification of a patient death?",
            "Family Communication: How and when do you make contact with the bereaved family, and what support is offered?",
            "Record Management: What is the process for updating and managing the deceased patient's records?",
            "Signposting: Which bereavement support services are patients and their families signposted to?",
            "Staff Support: How are staff who were involved in the patient's care supported?"
        ], 
        description: "Describe the process and attach any relevant protocols.",
        email_blurb: "Outlines our process for supporting bereaved patients and their families."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "ICO registration certificate", 
        item_type: "file_only",
        email_blurb: "Attached is our current ICO registration certificate."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Provider liability/MD insurance", 
        item_type: "file_only",
        email_blurb: "Attached is our certificate of provider liability/medical defence insurance."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Information leaflet for online services", 
        
        item_type: "file_only",
        email_blurb: "Attached is the information leaflet we provide to patients regarding our online services."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Safety and drug alerts process and evidence of management and actions.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Receipt & Dissemination: How are alerts received and promptly distributed to all relevant staff?", 
            "Action & Responsibility: Who is the designated lead, and what is the process for actioning alerts and documenting in patient records?", 
            "Audit & Learning: How do you maintain a central log to track alerts, actions, and outcomes?"
        ], 
        description: "Describe the process and attach evidence (e.g., completed logs, screenshots).",
        email_blurb: "Details our process for managing safety and drug alerts, with evidence of actions attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy and process for ensuring staff are recruited safely including DBS and registration checks.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for safe staff recruitment, including DBS and registration checks."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy and process to ensure practice oversight of other staff not directly employed by the practice.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the oversight of non-practice staff with access to patients or records."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Process for supervision and competency oversight of clinical staff.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Supervision Framework: Describe your system for clinical supervision for different roles (e.g., Nurses, HCAs), including frequency and format.", 
            "Competency Assessment: How are competencies for advanced roles (e.g., prescribing) assessed, documented, and reviewed?", 
            "Governance & Record Keeping: Where are supervision and competency records kept and how do they inform appraisals?"
        ], 
        description: "Describe the process and attach any relevant policy.",
        email_blurb: "Outlines our process for clinical supervision and competency oversight, with the relevant policy attached."
    },
    { 
        category: "EMAIL 1: GOVERNANCE, POLICIES AND PROCEDURES", 
        title: "Policy for ensuring PGDs and PSDs are appropriately reviewed and signed.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of PGDs and PSDs."
    },

    // EMAIL 2: TRAINING
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Number of current staff by role and WTE.", 
        item_type: "dynamic_table", 
        headers: ["Role", "Number of Staff", "WTE"],
        email_blurb: "Provides a breakdown of current staff by role and Whole Time Equivalent (WTE)."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "List of staff and their extended role(s).", 
        item_type: "dynamic_table", 
        headers: ["Staff Name", "Extended Role(s)"],
        email_blurb: "Provides a list of staff members and their designated extended roles."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Policy of training for staff and process to manage and monitor.", 
        item_type: "file_only",
        email_blurb: "Attached is our staff training policy, including our process for management and monitoring."
    },
    { 
        category: "EMAIL 2: TRAINING", 
        title: "Matrix of staff training.", 
        item_type: "file_only",
        description: "Attach the training matrix which should include all mandatory and role-specific training.",
        email_blurb: "Attached is our comprehensive staff training matrix."
    },

    // EMAIL 3: SAFEGUARDING
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Safeguarding adults' policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the safeguarding of adults."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Safeguarding children policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the safeguarding of children."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Sample of minutes of MDT meetings", 
        item_type: "file_only",
        description: "Attach a recent, anonymised sample of MDT meeting minutes where safeguarding was discussed.",
        email_blurb: "Attached is a sample of minutes from multidisciplinary team meetings."
    },
    { 
        category: "EMAIL 3: SAFEGUARDING", 
        title: "Policy/process to ensure information is shared with others.", 
        item_type: "file_only",
        description: "e.g. coding of medical records",
        email_blurb: "Attached is our policy on information sharing, including the coding of medical records."
    },

    // EMAIL 4: RISK ASSESSMENTS
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest fire risk assessment and any action log", 
        item_type: "file_only",
        email_blurb: "Attached is our latest fire risk assessment and corresponding action log."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence and date of fire extinguisher check", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of our latest fire extinguisher checks."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence of latest service for emergency lights and alarm test", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of the latest service for our emergency lights and fire alarm."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Copy of the latest fire drill and actions taken.", 
        item_type: "file_only",
        email_blurb: "Attached is the record of our latest fire drill and any actions taken."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Sample of weekly fire alarm checks", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the sample checks are provided (e.g., 'March 2025')."],
        description: "Attach the log of weekly fire alarm tests for the specified month.",
        email_blurb: "Attached is a sample of our weekly fire alarm checks for the month specified."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest health and safety risk assessment and any action log", 
        item_type: "file_only",
        email_blurb: "Attached is our latest health and safety risk assessment and action log."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Latest legionella assessment and sample water temperature checks", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the sample temperature checks are provided (e.g., 'March 2025')."],
        description: "Attach the latest full assessment and the water temperature logs for the specified month.",
        email_blurb: "Attached is our latest legionella risk assessment and sample water temperature checks."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Copy of any other general risk assessments.", 
        item_type: "file_only",
        description: "e.g. wheelchair access, monitoring of waiting areas etc.",
        email_blurb: "Attached are copies of other general risk assessments undertaken by the practice."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Equipment calibration dates and copy of certificate", 
        item_type: "file_only",
        email_blurb: "Attached is evidence of our equipment calibration."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "PAT testing dates and copy of certificate", 
        item_type: "file_only",
        email_blurb: "Attached is our latest PAT testing certificate."
    },
    { 
        category: "EMAIL 4: RISK ASSESSMENTS", 
        title: "Evidence of immunisation status of staff.", 
        item_type: "file_only",
        email_blurb: "Attached is evidence regarding the immunisation status of our staff."
    },

    // EMAIL 5: INFECTION PREVENTION AND CONTROL
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Name and role of IPC lead", 
        item_type: "dual_text", 
        labels: ["Name of Lead", "Role"],
        email_blurb: "Provides the name and role of our designated Infection Prevention and Control (IPC) lead."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Latest Infection control policy", 
        item_type: "file_only",
        email_blurb: "Attached is our latest Infection Prevention and Control policy."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Latest Infection prevention control audit and action log.", 
        item_type: "file_only",
        email_blurb: "Attached is our latest IPC audit and corresponding action log."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Copies of any meetings where IPC has been discussed", 
        item_type: "file_only",
        description: "Include any shared learning and changes since last inspection.",
        email_blurb: "Attached are minutes from meetings where IPC was discussed, showing shared learning."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Summary of vaccine fridge management", 
        item_type: "guided_questions", 
        questions: [
            "Policy & Responsibility: Who is the named lead for vaccine storage and what are the core principles of your cold chain policy?", 
            "Equipment & Location: How many vaccine fridges do you have, where are they located, and how are they maintained?", 
            "Monitoring & Recording: Describe your process for daily temperature monitoring, including logging and acceptable ranges.", 
            "Action on Excursion: What is the procedure for a cold chain incident?", 
            "Stock Management: How do you manage vaccine stock to ensure rotation and minimise wastage?"
        ],
        email_blurb: "Provides a summary of our vaccine fridge and cold chain management procedures."
    },
    { 
        category: "EMAIL 5: INFECTION PREVENTION AND CONTROL", 
        title: "Sample of vaccine fridge temperature recordings", 
        item_type: "guided_questions_and_file",
        questions: ["Please confirm the month for which the temperature logs are provided (e.g., 'March 2025')."],
        description: "Attach the temperature recordings for the specified month.",
        email_blurb: "Attached are the vaccine fridge temperature recordings for the month specified."
    },

    // EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Significant events policy", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of significant events."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Complaint’s policy and leaflet available to patients", 
        item_type: "file_only",
        email_blurb: "Attached is our complaints policy and the accompanying patient information leaflet."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "A summary of significant events within the last 12 months", 
        item_type: "guided_questions_and_number", 
        questions: [
            "Process for Reporting & Grading: How are significant events (SEs) reported, recorded, and graded?", 
            "Investigation & Themes: Describe your investigation process. What were the main themes from events in the last 12 months?", 
            "Learning & Actions: What were the critical learning points and what specific changes have been implemented as a result?"
        ], 
        label: "Number of events (12 months)",
        email_blurb: "Provides a summary of significant events from the last 12 months, including learning and actions taken."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "A summary of complaints received within the last 12 months", 
        item_type: "guided_questions_and_number", 
        questions: [
            "Process for Handling Complaints: Briefly describe your complaints procedure, from receipt to final response.", 
            "Analysis & Themes: What were the main themes from complaints received in the last 12 months?", 
            "Service Improvement: What specific changes to services have been made in response to patient complaints?"
        ], 
        label: "Number of complaints (12 months)",
        email_blurb: "Provides a summary of complaints from the last 12 months, detailing themes and resulting improvements."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Sample meetings minutes where SEAs and/or complaints have been discussed.", 
        item_type: "file_only",
        description: "From the past 6 months.",
        email_blurb: "Attached is a sample of meeting minutes showing discussion of significant events and complaints."
    },
    { 
        category: "EMAIL 6: SIGNIFICANT EVENTS, COMPLAINTS AND COMPLIMENTS", 
        title: "Sample of compliments received in the past 6 months.", 
        item_type: "file_only",
        email_blurb: "Attached is a sample of compliments received from patients."
    },

    // EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Summary of the quality of care you provide for the six population groups", 
        item_type: "guided_questions", 
        questions: [
            "Older people: How do you tailor services for older people (e.g., proactive care, frailty assessments)?", 
            "People with long-term conditions: Describe your approach to managing patients with LTCs (e.g., recall systems, care planning).", 
            "Families, children and young people: How do you provide accessible services for this group (e.g., immunisation clinics, safeguarding)?", 
            "Working age people: How do you ensure access for working people (e.g., online services, extended hours)?", 
            "Vulnerable people: What provisions do you have for vulnerable groups (e.g., homeless, learning disabilities, carers)?", 
            "People experiencing poor mental health: Describe your approach to supporting patients with mental health needs (e.g., access to IAPT)."
        ],
        email_blurb: "Provides a summary of how we tailor our care for the six key population groups."
    },
    {
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK",
        title: "Summary of clinical audits (last 2 years)",
        item_type: "textarea",
        description: "Provide a summary list of clinical audits completed in the last two years and explain how you decide on audit topics.",
        email_blurb: "Provides a summary of clinical audit activity undertaken in the last two years."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Full Cycle Audit Example 1", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Audit Topic & Standard: What was the topic of the audit and what standard was measured against?",
            "Initial Findings: What were the results of the first data collection cycle?",
            "Changes Implemented: What specific changes were made to practice as a result of the findings?",
            "Re-Audit Results: What were the results of the second data collection cycle, and was there an improvement?"
        ],
        description: "Describe the audit and attach the full audit document as evidence.",
        email_blurb: "Details our first example of a completed two-cycle clinical audit, with the full report attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Full Cycle Audit Example 2", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Audit Topic & Standard: What was the topic of the audit and what standard was measured against?",
            "Initial Findings: What were the results of the first data collection cycle?",
            "Changes Implemented: What specific changes were made to practice as a result of the findings?",
            "Re-Audit Results: What were the results of the second data collection cycle, and was there an improvement?"
        ],
        description: "Describe the audit and attach the full audit document as evidence.",
        email_blurb: "Details our second example of a completed two-cycle clinical audit, with the full report attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Summary of any other quality improvement work undertaken over the last two years.", 
        item_type: "guided_questions", 
        questions: [
            "Project Overview: Describe any significant Quality Improvement (QI) projects undertaken that are not clinical audits.", 
            "Methodology & Outcomes: What QI methodology was used (e.g., PDSA) and what were the measured outcomes?", 
            "Learning & Sustainability: What was learned and how have the improvements been sustained?"
        ],
        email_blurb: "Provides a summary of other non-audit Quality Improvement (QI) work from the last two years."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Evidence of how you have responded to patient feedback (last 12 months).", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Collection Methods: What formal and informal methods do you use to gather patient feedback?", 
            "Analysis & Key Themes: Provide a summary of the key themes, both positive and negative, from patient feedback.", 
            "Action & 'You Said, We Did': Provide specific examples of changes made in direct response to patient feedback."
        ], 
        description: "Summarise and attach evidence (e.g., survey results, FFT data, action logs).",
        email_blurb: "Shows how we have collected, analysed, and acted upon patient feedback, with evidence attached."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Patient survey results and action log (if not included above)", 
        item_type: "file_only",
        email_blurb: "Attached are the results and action log from our own patient survey."
    },
    { 
        category: "EMAIL 7: EVIDENCE OF QUALITY IMPROVEMENT WORK", 
        title: "Evidence of how you have responded to staff feedback (last 12 months).", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Collection Methods: What mechanisms are in place for staff to provide feedback?", 
            "Analysis & Key Themes: What were the key themes from staff feedback over the last 12 months?", 
            "Action & Response: Provide specific examples of changes made in response to staff feedback."
        ], 
        description: "Summarise and attach evidence (e.g., staff survey results).",
        email_blurb: "Shows how we have collected, analysed, and acted upon staff feedback, with evidence attached."
    },

    // EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Discharge (medicine reconciliation) process and any audits/checks undertaken.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Process Workflow: Describe the end-to-end process from receiving a discharge summary to updating the patient's record.", 
            "Roles & Responsibilities: Who is responsible for each step of the process (e.g., admin, clinical pharmacist, GP)?", 
            "Quality Assurance: How do you audit compliance? Provide a summary of any recent audit findings."
        ], 
        description: "Describe the process and attach audits/checks.",
        email_blurb: "Details our process for medicine reconciliation following patient discharge, with recent audits attached."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Policy and process for the management of repeat prescriptions and medicine reviews.", 
        item_type: "file_only",
        email_blurb: "Attached is our policy for the management of repeat prescriptions and medication reviews."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Patient summarising/coding in medical records policy/process and any audits.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "New Patient Record Summarising: Describe your process and target timeframe for summarising new patient records.", 
            "Clinical Correspondence Workflow: How is incoming correspondence processed, read, coded, and actioned?", 
            "Quality Assurance: What systems are in place to ensure coding is accurate, consistent, and timely?"
        ], 
        description: "Describe the process and attach audits/checks.",
        email_blurb: "Outlines our process for summarising and coding patient records, with recent audits attached."
    },
    { 
        category: "EMAIL 8: PATIENT RECORD KEEPING AND MEDICINES", 
        title: "Number of patient records that have not been fully summarised.", 
        item_type: "number", 
        label: "Number of records",
        email_blurb: "Provides the current number of patient records awaiting full summarisation."
    },

    // EMAIL 9: DATA FOR THE REPORT
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "NHS health checks data (last 12 months)", 
        item_type: "triple_number", 
        labels: ["Eligible", "Offered", "Completed"],
        email_blurb: "Provides our NHS Health Checks data for the last 12 months."
    },
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "Learning Disability check data (last 12 months)", 
        item_type: "triple_number", 
        labels: ["Eligible", "Offered", "Completed"],
        email_blurb: "Provides our Learning Disability Health Checks data for the last 12 months."
    },
    { 
        category: "EMAIL 9: DATA FOR THE REPORT", 
        title: "Cervical cancer screening and child immunisation coverage data.", 
        item_type: "guided_questions_and_file", 
        questions: [
            "Cervical Screening Uptake Strategy: Describe the specific actions you have taken to improve cervical screening uptake.", 
            "Childhood Immunisation Uptake Strategy: Describe the specific actions you have taken to improve childhood immunisation rates.", 
            "Data & Outcomes: What has been the impact of these actions on your uptake data?"
        ], 
        description: "Summarise actions and attach coverage data.",
        email_blurb: "Provides our latest uptake data for cervical screening and childhood immunisations, along with actions taken to improve coverage."
    },
];

</script>

<script type="module">
  // Supabase v2 client
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  import JSZip from "https://esm.sh/jszip@3.10.1";

  // Use environment-aware configuration
  const SUPABASE_URL = CONFIG.SUPABASE_URL;
  const SUPABASE_ANON_KEY = CONFIG.SUPABASE_ANON_KEY;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });
  // Expose to global for non-module scripts
  window.JSZip = JSZip;
  window.supabase = supabase;

  // Authentication functions
  function showAuth(show = true) {
    const authWrapper = document.getElementById('auth-wrapper');
    const appShell = document.getElementById('app');
    
    if (show) {
      if (authWrapper) authWrapper.style.display = 'grid';
      if (appShell) appShell.style.display = 'none';
    } else {
      if (authWrapper) authWrapper.style.display = 'none';
      if (appShell) appShell.style.display = 'grid';
    }
  }

  function showError(message) {
    const errorDiv = document.getElementById('auth-error');
    if (errorDiv) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }
  }

  function hideError() {
    const errorDiv = document.getElementById('auth-error');
    if (errorDiv) {
      errorDiv.style.display = 'none';
    }
  }

  // Login form handler
  async function handleLogin(e) {
    e.preventDefault();
    hideError();

    const email = document.getElementById('auth-email');
    const password = document.getElementById('auth-password');
    const submitBtn = document.querySelector('#auth-form button[type="submit"]');

    if (!email || !password) {
      showError('Email and password fields not found');
      return;
    }

    try {
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Signing in...';
      }

      const { data, error } = await supabase.auth.signInWithPassword({
        email: email.value.trim(),
        password: password.value
      });

      if (error) {
        showError(error.message);
      } else if (data.user) {
        // Login successful - bootstrap will be called automatically by the session change
        window.location.reload();
      }
    } catch (err) {
      showError('Login failed: ' + (err.message || 'Unknown error'));
    } finally {
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign In';
      }
    }
  }

  // Initialize auth form
  function initAuth() {
    const authForm = document.getElementById('auth-form');
    if (authForm) {
      authForm.addEventListener('submit', handleLogin);
    }

    // Check for existing session
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
        showAuth(false);
        bootstrap();
      } else if (event === 'SIGNED_OUT') {
        showAuth(true);
      }
    });
  }

  // Initialize authentication when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAuth);
  } else {
    initAuth();
  }

  // SPA navigation
  const nav = document.getElementById("nav");
  const views = [...document.querySelectorAll("section.view")];

  // Sidebar toggle functionality is handled by the resize script at the bottom
  // This ensures proper coordination between toggle and drag-resize features

  function setActiveSection(id){
    if(!id) return;
    
    // Check if user has permission to access this section
    if (ctx.pageAccess && !hasPageAccess(id)) {
      console.warn(`Access denied to section: ${id}, redirecting to dashboard`);
      // Redirect to dashboard if access is denied
      id = 'dashboard';
    }
    
    console.log('setActiveSection called with:', id);
    const btn = nav.querySelector(`button[data-section="${id}"]`);
    if(!btn) return;
    // active state
    nav.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    // show view
    views.forEach(v => v.classList.remove("active"));
    const viewEl = document.getElementById("view-"+id);
    if(viewEl) viewEl.classList.add("active");
    
    // Load section data
    switch(id) {
      case 'dashboard':
        Promise.all([
          loadCounts(),
          loadDue(),
          loadActivity(),
          loadWeekCalendar()
        ]);
        break;
      case 'items':
        loadItems();
        break;
      case 'rooms':
        loadRooms();
        break;
      case 'complaints':
        loadComplaints();
        break;
      case 'checktypes':
        loadCheckTypes();
        
        // Fix layout issue: ensure checktypes view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-checktypes');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'schedules':
        loadSchedules();
        
        // Fix layout issue: ensure schedules view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-schedules');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'staff':
        loadStaff();
        
        // Fix layout issue: ensure staff view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-staff');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'submissions':
        loadSubmissions();
        
        // Fix layout issue: ensure submissions view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-submissions');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'pre-inspection':
        loadAndRenderPIR();
        break;
      case 'complaints-dashboard':
        // Load complaints list (for dashboard widgets) and dashboard stats
        loadComplaints();
        fetchComplaintsDashboardStats();
        break;
      case 'complaints-reporting':
        // Load complaints list for reporting (table/filter/export)
        loadComplaints();
        
        // Fix layout issue: ensure complaints-reporting view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-complaints-reporting');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'calendar':
        loadAndRenderCalendar();
        break;
      case 'settings':
        // Initialize debug features on Site Settings page
        initPageVisibilityToggles();
        
        // Fix layout issue: ensure settings view stays in content container
        setTimeout(() => {
          const view = document.querySelector('#view-settings');
          const content = document.querySelector('.content');
          if (view && content && view.parentElement !== content) {
            content.appendChild(view);
          }
        }, 0);
        break;
      case 'users':
        // Users page hosts practice users listing and invite management
        loadPracticeUsers();
        break;
      case 'training':
        // Ensure proper tab state initialization
        currentTrainingTab = 'clinical';
        document.querySelectorAll('#view-training .tab-controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('tab-clinical')?.classList.add('active');
        loadTrainingMatrix();
        break;
    }
    
    // persist
    try { localStorage.setItem("cl_active_section", id); } catch(_) {}
  }

  nav.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-section]");
    if(!btn) return;
    const id = btn.getAttribute("data-section");
    
    // Check if user has permission to access this section
    if (ctx.pageAccess && !hasPageAccess(id)) {
      console.warn(`Access denied to section: ${id}`);
      alert(`You don't have permission to access ${id}.`);
      return;
    }
    
    setActiveSection(id);
    
    // Special handling for settings and users sections
    if (id === 'settings') {
      setTimeout(() => {
        // initDebugToggle(); // Removed - debug window no longer exists
      }, 100);
    }
    if (id === 'users') {
      setTimeout(() => {
        loadPracticeUsers();
      }, 100);
    }
    
    // Special handling for training section
    if (id === 'training') {
      setTimeout(() => {
        // Ensure proper tab state initialization
        currentTrainingTab = 'clinical';
        document.querySelectorAll('#view-training .tab-controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('tab-clinical')?.classList.add('active');
        loadTrainingMatrix();
      }, 100); // Small delay to ensure context is loaded
    }
  });

  // Helper function to check if user has access to a page
  function hasPageAccess(pageName) {
    if (!ctx.pageAccess) return false;
    
    // Dashboard should always be accessible as the landing page
    if (pageName === 'dashboard') return true;
    
    // Map section names to database page names
    const pageMap = {
      'dashboard': 'dashboard',
      'complaints': 'complaints',
      'staff': 'staff',
      'items': 'items', 
      'rooms': 'rooms',
      'checktypes': 'checks',
      'calendar': 'calendar',
      'schedules': 'schedules',
      'submissions': 'submissions',
      'pre-inspection': 'pre-inspection',
      'training': 'training',
      'settings': 'settings', 
      'users': 'users'
    };

  // Add new complaints pages to pageMap for access control
  pageMap['complaints-dashboard'] = 'complaints';
  pageMap['complaints-reporting'] = 'complaints';
    
    const dbPageName = pageMap[pageName] || pageName;
    
    // Check wildcard access or specific page access
    return ctx.pageAccess.allowed_pages.includes('*') || 
           ctx.pageAccess.allowed_pages.includes(dbPageName) ||
           (ctx.pageAccess[`can_see_${dbPageName}`] === true);
  }

  // Fetch dashboard-specific stats (most common categories, statuses, counts)
  async function fetchComplaintsDashboardStats(){
    try{
      if(!ctx.site_id) return;
      // fetch last 30 days complaints
      const start = new Date(); start.setDate(start.getDate()-29);
      const { data, error } = await supabase.from('complaints').select('id, category, status, datetime, share_with_team').eq('site_id', ctx.site_id).gte('datetime', start.toISOString());
      if(error) return console.warn('dashboard stats fetch error', error.message);
      const counts = { total: 0, open:0, resolved:0, shared:0 };
      const byCategory = {};
      const byStatus = {};
      (data||[]).forEach(r=>{
        counts.total++;
        if((r.status||'').toLowerCase() === 'resolved') counts.resolved++; else counts.open++;
        if(r.share_with_team) counts.shared++;
        const cat = r.category || 'Unspecified'; byCategory[cat] = (byCategory[cat]||0)+1;
        const st = r.status || 'unknown'; byStatus[st] = (byStatus[st]||0)+1;
      });
      
      // Animate the counter numbers
      animateCounter('cmp-total', counts.total);
      animateCounter('cmp-open', counts.open);
      animateCounter('cmp-resolved', counts.resolved);
      animateCounter('cmp-share', counts.shared);
      
      // render top categories with animations
      const catEl = document.getElementById('cmp-top-categories');
      if(catEl){
        const items = Object.entries(byCategory).sort((a,b)=>b[1]-a[1]).slice(0,8);
        if(items.length === 0) {
          catEl.innerHTML = '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 40px 20px; font-style: italic;">No complaints in the last 30 days - Excellent service delivery! 🌟</div>';
        } else {
          catEl.innerHTML = items.map((i,idx)=>`
            <div style="display:flex; justify-content:space-between; align-items: center; padding:14px 18px; margin:10px 0; background:linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); border-radius:12px; border-left:4px solid var(--accent-1); transition:all 0.3s ease; animation:fadeInUp 0.6s ease-out; animation-delay:${idx*0.1}s; opacity:0; animation-fill-mode:forwards; cursor: pointer;" onmouseover="this.style.transform='translateX(4px)'; this.style.background='linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1))'" onmouseout="this.style.transform='translateX(0)'; this.style.background='linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08))'">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-weight:600; color: white; font-size: 1rem;">${esc(i[0])}</div>
                <div style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; color: white;">Priority</div>
              </div>
              <div style="font-weight:800; color:var(--accent-1); font-size: 1.4rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${i[1]}</div>
            </div>
          `).join('');
        }
      }
      const stEl = document.getElementById('cmp-status-breakdown');
      if(stEl){
        const items = Object.entries(byStatus).sort((a,b)=>b[1]-a[1]);
        if(items.length === 0) {
          stEl.innerHTML = '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px; font-style: italic;">No status data available</div>';
        } else {
          stEl.innerHTML = items.map((i,idx)=>{
            const statusColors = {
              'resolved': '#22c55e',
              'closed': '#22c55e', 
              'open': '#f59e0b',
              'investigating': '#3b82f6',
              'pending': '#ef4444'
            };
            const color = statusColors[i[0].toLowerCase()] || 'var(--accent-2)';
            const statusEmoji = {
              'resolved': '✅',
              'closed': '✅',
              'open': '🔍', 
              'investigating': '⚠️',
              'pending': '⏳'
            };
            const emoji = statusEmoji[i[0].toLowerCase()] || '📋';
            
            return `
            <div style="display:flex; justify-content:space-between; align-items: center; padding:14px 18px; margin:10px 0; background:linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); border-radius:12px; border-left:4px solid ${color}; transition:all 0.3s ease; animation:fadeInUp 0.6s ease-out; animation-delay:${idx*0.1}s; opacity:0; animation-fill-mode:forwards; cursor: pointer;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.2rem;">${emoji}</span>
                <div style="font-weight:600; color: white; text-transform: capitalize;">${esc(i[0])}</div>
              </div>
              <div style="font-weight:800; color:${color}; font-size: 1.4rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${i[1]}</div>
            </div>
            `;
          }).join('');
        }
      }

      // Generate trend data for last 30 days
      const trendData = {};
      for(let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const key = date.toISOString().slice(0, 10);
        trendData[key] = 0;
      }
      
      // Count complaints by day
      (data||[]).forEach(r => {
        if(r.datetime) {
          const day = r.datetime.slice(0, 10);
          if(trendData.hasOwnProperty(day)) {
            trendData[day]++;
          }
        }
      });

      // Draw trend chart
      drawDashboardTrend(trendData);
    }catch(err){ console.error('fetchComplaintsDashboardStats failed', err); }
  }

  // Draw trend chart specifically for dashboard
  function drawDashboardTrend(trendData) {
    const trendSvg = document.getElementById('dashboard-trend-chart');
    if (!trendSvg) return;

    const days = Object.keys(trendData).sort();
    const values = days.map(day => trendData[day]);
    const w = 600, h = 120;
    const max = Math.max(1, ...values);
    
    const points = values.map((v,i)=> (i*(w/(values.length-1))) + ',' + (h - (v/max)*(h-20))).join(' ');
    
    trendSvg.setAttribute('viewBox','0 0 '+w+' '+h);
    trendSvg.innerHTML = `
      <defs>
        <linearGradient id="dashboardTrendGradient" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
          <stop offset="50%" style="stop-color:#764ba2;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="dashboardAreaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#667eea;stop-opacity:0.3" />
          <stop offset="100%" style="stop-color:#667eea;stop-opacity:0.05" />
        </linearGradient>
        <filter id="dashboardGlow">
          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
          <feMerge> 
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      
      <!-- Area fill -->
      <path fill="url(#dashboardAreaGradient)" d="M0,${h} L${points.split(' ').map(p => p.replace(',', ' L')).join(' ')} L${w},${h} Z" opacity="0">
        <animate attributeName="opacity" from="0" to="1" dur="1.5s" fill="freeze"/>
      </path>
      
      <!-- Main trend line with glow -->
      <polyline fill="none" stroke="url(#dashboardTrendGradient)" stroke-width="4" 
                points="${points}" stroke-linejoin="round" stroke-linecap="round"
                filter="url(#dashboardGlow)" stroke-dasharray="${w*2}" stroke-dashoffset="${w*2}">
        <animate attributeName="stroke-dashoffset" from="${w*2}" to="0" dur="2s" fill="freeze"/>
      </polyline>
      
      <!-- Animated data points -->
      ${values.map((v,i) => {
        const x = i*(w/(values.length-1));
        const y = h - (v/max)*(h-20);
        return `
          <circle cx="${x}" cy="${y}" r="0" fill="#fff" stroke="url(#dashboardTrendGradient)" stroke-width="2">
            <animate attributeName="r" from="0" to="4" dur="0.5s" begin="${0.1*i}s" fill="freeze"/>
          </circle>
          <circle cx="${x}" cy="${y}" r="0" fill="url(#dashboardTrendGradient)" opacity="0.3">
            <animate attributeName="r" from="0" to="8" dur="0.8s" begin="${0.1*i}s" fill="freeze"/>
            <animate attributeName="opacity" from="0.5" to="0" dur="2s" begin="${0.1*i}s" repeatCount="indefinite"/>
          </circle>
        `;
      }).join('')}
    `;
  }

  // Animated counter function
  function animateCounter(elementId, targetValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const startValue = 0;
    const duration = 1500; // 1.5 seconds
    const startTime = performance.now();
    
    function updateCounter(currentTime) {
      const elapsedTime = currentTime - startTime;
      const progress = Math.min(elapsedTime / duration, 1);
      
      // Easing function for smooth animation
      const easedProgress = 1 - Math.pow(1 - progress, 3);
      const currentValue = Math.floor(startValue + (targetValue - startValue) * easedProgress);
      
      element.textContent = currentValue;
      element.style.transform = `scale(${1 + Math.sin(progress * Math.PI) * 0.1})`;
      
      if (progress < 1) {
        requestAnimationFrame(updateCounter);
      } else {
        element.style.transform = 'scale(1)';
        // Add a subtle pulse effect when done
        element.style.animation = 'pulse 2s ease-in-out infinite';
      }
    }
    
    requestAnimationFrame(updateCounter);
  }

  // Add dashboard interactivity
  document.addEventListener('DOMContentLoaded', function() {
    // Wire up dashboard navigation buttons
    const openReportingBtn = document.getElementById('btn-open-complaints-reporting');
    const refreshBtn = document.getElementById('btn-refresh-complaints-dashboard');
    
    if (openReportingBtn) {
      openReportingBtn.addEventListener('click', () => {
        setActiveSection('complaints-reporting');
      });
    }
    
    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        // Add loading animation
        refreshBtn.style.transform = 'rotate(360deg)';
        refreshBtn.style.transition = 'transform 0.8s ease';
        
        // Refresh dashboard data
        setTimeout(() => {
          if (document.getElementById('view-complaints-dashboard').classList.contains('active')) {
            loadComplaints();
            fetchComplaintsDashboardStats();
          }
          refreshBtn.style.transform = 'rotate(0deg)';
        }, 800);
      });
    }
    
    // Add hover effects for stat cards
    const statCards = document.querySelectorAll('#view-complaints-dashboard .stat-card');
    statCards.forEach((card, index) => {
      card.addEventListener('mouseenter', () => {
        card.style.transform = 'translateY(-8px) scale(1.02)';
        card.style.boxShadow = '0 25px 50px rgba(0,0,0,0.15)';
      });
      
      card.addEventListener('mouseleave', () => {
        card.style.transform = 'translateY(0) scale(1)';
        card.style.boxShadow = '0 8px 32px rgba(0,0,0,0.1)';
      });
    });

    // Wire up schedules filter event listeners
    const schedulesFilters = [
      'schedules-filter-room',
      'schedules-filter-check', 
      'schedules-filter-frequency',
      'schedules-filter-required'
    ];
    
    schedulesFilters.forEach(filterId => {
      const filter = document.getElementById(filterId);
      if (filter) {
        filter.addEventListener('change', () => {
          if (schedulesData && schedulesData.length > 0) {
            applySchedulesFilters();
          }
        });
      }
    });

    const schedulesSearch = document.getElementById('schedules-search');
    if (schedulesSearch) {
      schedulesSearch.addEventListener('input', () => {
        if (schedulesData && schedulesData.length > 0) {
          applySchedulesFilters();
        }
      });
    }
  });

  // Add particle effects for dashboard background
  function createParticles() {
    const dashboard = document.getElementById('view-complaints-dashboard');
    if (!dashboard) return;
    
    for (let i = 0; i < 20; i++) {
      const particle = document.createElement('div');
      particle.style.cssText = `
        position: absolute;
        width: 4px;
        height: 4px;
        background: linear-gradient(45deg, var(--accent-1), var(--accent-2));
        border-radius: 50%;
        pointer-events: none;
        opacity: 0.6;
        animation: float 6s ease-in-out infinite;
        animation-delay: ${Math.random() * 6}s;
        left: ${Math.random() * 100}%;
        top: ${Math.random() * 100}%;
      `;
      dashboard.appendChild(particle);
    }
  }
  
  // Float animation for particles
  const style = document.createElement('style');
  style.textContent = `
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-20px) rotate(120deg); }
      66% { transform: translateY(-10px) rotate(240deg); }
    }
  `;
  document.head.appendChild(style);

  // (Removed duplicate nav group toggle logic to avoid conflicts with manageNavGroups above)

  // User Management
  const inviteModal = document.getElementById('invite-modal');
  const inviteForm = document.getElementById('invite-form');
  const inviteError = document.getElementById('invite-error');

  function showInviteModal() {
    // Populate reports-to list and role list
    (async () => {
      const reportsToSel = document.getElementById('invite-reports-to');
      const roleSel = document.getElementById('invite-role');
      
      if (reportsToSel) {
        reportsToSel.innerHTML = '<option value="">—</option>';
      }
      if (roleSel) {
        roleSel.innerHTML = '<option value="">—</option>';
      }
      
      if (!ctx.site_id) return;
      
      try {
        // Load reports-to list from kiosk_users
        if (reportsToSel) {
          const { data: users, error: usersError } = await supabase.from('kiosk_users').select('id, full_name').eq('site_id', ctx.site_id).eq('active', true).order('full_name');
          if (!usersError && Array.isArray(users)) {
            users.forEach(u => {
              const opt = document.createElement('option');
              opt.value = u.id;
              opt.textContent = u.full_name || u.id;
              reportsToSel.appendChild(opt);
            });
          }
        }
        
        // Load roles list from kiosk_roles
        if (roleSel) {
          const { data: roles, error: rolesError } = await supabase.from('kiosk_roles').select('role').order('role');
          if (!rolesError && Array.isArray(roles)) {
            roles.forEach(r => {
              const opt = document.createElement('option');
              opt.value = r.role;
              opt.textContent = r.role;
              roleSel.appendChild(opt);
            });
          }
        }
      } catch (e) { 
        console.warn('Failed to load dropdown lists', e); 
      }
    })();

    inviteModal.classList.add('show');
    inviteError.style.display = 'none';
    inviteForm.reset();
  }

  function closeInviteModal() {
    inviteModal.classList.remove('show');
  }

  document.getElementById('btn-invite-user')?.addEventListener('click', showInviteModal);
  document.getElementById('invite-modal-close')?.addEventListener('click', closeInviteModal);
  document.getElementById('invite-cancel-btn')?.addEventListener('click', closeInviteModal);

  // Training event listeners
  document.getElementById('tab-clinical')?.addEventListener('click', () => switchTrainingTab('clinical'));
  document.getElementById('tab-non-clinical')?.addEventListener('click', () => switchTrainingTab('non-clinical'));
  document.getElementById('btn-manage-training-types')?.addEventListener('click', openTrainingTypesModal);
  document.getElementById('btn-export-training')?.addEventListener('click', exportTrainingReport);
  document.getElementById('training-modal-close')?.addEventListener('click', closeTrainingModal);
  document.getElementById('training-cancel-btn')?.addEventListener('click', closeTrainingModal);
  document.getElementById('training-form')?.addEventListener('submit', saveTrainingRecord);
  document.getElementById('training-certificate')?.addEventListener('change', handleTrainingFileUpload);
  document.getElementById('training-completion-date')?.addEventListener('change', calculateTrainingExpiry);
  document.getElementById('training-upload-zone')?.addEventListener('click', () => {
    document.getElementById('training-certificate')?.click();
  });

  // Training types modal event listeners
  document.getElementById('training-types-close')?.addEventListener('click', closeTrainingTypesModal);
  document.getElementById('training-types-cancel')?.addEventListener('click', closeTrainingTypesModal);
  document.getElementById('save-training-types')?.addEventListener('click', saveTrainingTypes);
  document.getElementById('add-training-type')?.addEventListener('click', addNewTrainingType);

  // Helper functions for training types modal
  function openTrainingTypesModal() {
    document.getElementById('training-types-modal').classList.add('show');
    loadTrainingTypes();
  }

  function closeTrainingTypesModal() {
    document.getElementById('training-types-modal').classList.remove('show');
  }

  async function loadTrainingTypes() {
    const list = document.getElementById('training-types-list');
    list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">Loading...</div>';
    
    try {
      const { data, error } = await supabase
        .from('training_types')
        .select('*')
        .eq('site_id', ctx.site_id)
        .order('name');
      
      if (error) throw error;
      
      list.innerHTML = data.map(type => `
        <div class="training-type-row" data-id="${type.id}">
          <input type="text" value="${esc(type.name)}" data-field="name">
          <select data-field="validity_months">
            <option value="">No Expiry</option>
            <option value="6" ${type.validity_months === 6 ? 'selected' : ''}>6 months</option>
            <option value="12" ${type.validity_months === 12 ? 'selected' : ''}>12 months</option>
            <option value="24" ${type.validity_months === 24 ? 'selected' : ''}>24 months</option>
            <option value="36" ${type.validity_months === 36 ? 'selected' : ''}>36 months</option>
          </select>
          <input type="checkbox" ${type.clinical ? 'checked' : ''} data-field="clinical">
          <input type="checkbox" ${type.non_clinical ? 'checked' : ''} data-field="non_clinical">
          <input type="checkbox" ${type.active ? 'checked' : ''} data-field="active">
          <button type="button" class="btn secondary" onclick="deleteTrainingType(${type.id})">Delete</button>
        </div>
      `).join('');
    } catch (err) {
      console.error('Failed to load training types:', err);
      list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Failed to load training types</div>';
    }
  }

  function addNewTrainingType() {
    const list = document.getElementById('training-types-list');
    const newRow = `
      <div class="training-type-row" data-id="new-${Date.now()}">
        <input type="text" placeholder="Training name..." data-field="name">
        <select data-field="validity_months">
          <option value="">No Expiry</option>
          <option value="6">6 months</option>
          <option value="12" selected>12 months</option>
          <option value="24">24 months</option>
          <option value="36">36 months</option>
        </select>
        <input type="checkbox" checked data-field="clinical">
        <input type="checkbox" checked data-field="non_clinical">
        <input type="checkbox" checked data-field="active">
        <button type="button" class="btn secondary" onclick="this.parentElement.remove()">Remove</button>
      </div>
    `;
    list.insertAdjacentHTML('beforeend', newRow);
  }

  async function saveTrainingTypes() {
    const rows = document.querySelectorAll('.training-type-row');
    const updates = [];
    const inserts = [];
    
    for (const row of rows) {
      const id = row.dataset.id;
      const name = row.querySelector('[data-field="name"]').value.trim();
      const validity_months = row.querySelector('[data-field="validity_months"]').value || null;
      const clinical = row.querySelector('[data-field="clinical"]').checked;
      const non_clinical = row.querySelector('[data-field="non_clinical"]').checked;
      const active = row.querySelector('[data-field="active"]').checked;
      
      if (!name) continue;
      
      const data = {
        site_id: ctx.site_id,
        name,
        validity_months: validity_months ? parseInt(validity_months) : null,
        clinical,
        non_clinical,
        active
      };
      
      if (id.startsWith('new-')) {
        inserts.push(data);
      } else {
        updates.push({ id: parseInt(id), ...data });
      }
    }
    
    try {
      if (inserts.length > 0) {
        const { error } = await supabase.from('training_types').insert(inserts);
        if (error) throw error;
      }
      
      for (const update of updates) {
        const { id, ...updateData } = update;
        const { error } = await supabase
          .from('training_types')
          .update(updateData)
          .eq('id', id);
        if (error) throw error;
      }
      
      closeTrainingTypesModal();
      loadTrainingMatrix();
    } catch (err) {
      console.error('Failed to save training types:', err);
      document.getElementById('training-types-error').textContent = err.message;
      document.getElementById('training-types-error').style.display = 'block';
    }
  }

  window.deleteTrainingType = async function(id) {
    if (!confirm('Are you sure you want to delete this training type?')) return;
    
    try {
      const { error } = await supabase
        .from('training_types')
        .update({ active: false })
        .eq('id', id);
      if (error) throw error;
      
      loadTrainingTypes();
    } catch (err) {
      console.error('Failed to delete training type:', err);
      alert('Failed to delete training type');
    }
  };

  function exportTrainingReport() {
    // This would generate and download a training report
    alert('Training report export functionality would be implemented here');
  }

  inviteForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    inviteError.style.display = 'none';

    const name = document.getElementById('invite-name').value.trim();
    const email = document.getElementById('invite-email').value.trim();
    const access = document.getElementById('invite-access').value;
    const roleDetail = document.getElementById('invite-role').value;
    const reportsToId = document.getElementById('invite-reports-to').value || null;

    if (!name || !email || !access) {
      inviteError.textContent = 'Please fill in Name, Email and Access';
      inviteError.style.display = 'block';
      return;
    }

    if (!ctx.site_id) {
      inviteError.textContent = 'No site selected';
      inviteError.style.display = 'block';
      return;
    }

    try {
      console.log('Sending simple invite...');
      
      const { data, error } = await supabase.functions.invoke('simple-invite', {
        body: {
          email: email,
          name: name,
          role: access,
          role_detail: roleDetail,
          reports_to_id: reportsToId,
        },
        headers: {
          'x-redirect-url': CONFIG.passwordRedirectUrl
        }
      });

      if (error) {
        throw error;
      }

      console.log('Simple invite sent successfully', data);

      // Show success message
      inviteError.textContent = 'Invitation sent successfully! The user will receive an email with instructions to set their password.';
      inviteError.style.display = 'block';
      inviteError.style.backgroundColor = '#d4edda';
      inviteError.style.color = '#155724';
      inviteError.style.border = '1px solid #c3e6cb';

      // Close modal and refresh list after showing success message
      setTimeout(() => {
        closeInviteModal();
        loadPracticeUsers();
      }, 2000);
    } catch (err) {
      console.error('Failed to send invitation:', err);
      inviteError.textContent = err.message || 'Failed to send invitation';
      inviteError.style.display = 'block';
    }
  });

  async function loadPracticeUsers() {
    const tbody = document.getElementById('practice-users-tbody');
    if (!tbody) {
      console.error('practice-users-tbody element not found');
      return;
    }
    
    if (!ctx.site_id) {
      tbody.innerHTML = '<tr><td colspan="5" class="muted">No site selected</td></tr>';
      return;
    }

    tbody.innerHTML = '<tr><td colspan="5" class="muted">Loading users...</td></tr>';

    try {
      console.log('Loading users for site_id:', ctx.site_id);
      
      // Test access to site_invites table first
      console.log('Testing site_invites table access...');
      const { data: testInvites, error: testError } = await supabase
        .from('site_invites')
        .select('count')
        .limit(1);
      
      if (testError) {
        console.error('Cannot access site_invites table:', testError);
      } else {
        console.log('site_invites table accessible');
      }
      
      // Get users from profiles table
      const { data: users, error: usersError } = await supabase
        .from('profiles')
        .select('*')
        .eq('site_id', ctx.site_id);

      if (usersError) {
        console.error('Error loading profiles:', usersError);
        throw usersError;
      }

      console.log('Loaded users:', users);

      // Get all invites (both pending and accepted) to match emails with profiles
      const { data: allInvites, error: allInvitesError } = await supabase
        .from('site_invites')
        .select('*')
        .eq('site_id', ctx.site_id);

      if (allInvitesError) {
        console.error('Error loading all invites:', allInvitesError);
      }

      console.log('Loaded all invites:', allInvites);

      // Create a map of user_id to email from accepted invites
      const emailMap = {};
      if (allInvites) {
        allInvites.forEach(invite => {
          if (invite.status === 'accepted' && invite.email) {
            // Try to find the user profile that matches this invite
            const matchingUser = users?.find(u => u.full_name === invite.full_name && u.site_id === invite.site_id);
            if (matchingUser) {
              emailMap[matchingUser.user_id] = invite.email;
            }
          }
        });
      }

      // Get pending invites only
      const pendingInvites = allInvites ? allInvites.filter(i => 
        i.status === 'pending' && 
        new Date(i.expires_at) > new Date()
      ) : [];

      const allRows = [
        // Active users from profiles (with emails from accepted invites)
        ...(users || []).map(u => ({
          name: u.full_name || 'Unknown',
          email: emailMap[u.user_id] || 'Email not available',
          role: u.role || 'User',
          status: 'Active',
          actions: `<button class="btn secondary" onclick="deactivateUser('${u.user_id}')">Deactivate</button>`
        })),
        // Pending invites (not yet accepted)
        ...(pendingInvites.map(i => ({
          name: i.full_name,
          email: i.email,
          role: i.role,
          status: 'Invited',
          actions: `<button class="btn secondary" onclick="cancelInvite('${i.id}')">Cancel Invite</button>`
        })))
      ];

      tbody.innerHTML = allRows.length ? allRows.map(r => `
        <tr>
          <td>${esc(r.name)}</td>
          <td>${esc(r.email)}</td>
          <td>${esc(r.role)}</td>
          <td><span class="chip ${r.status === 'Active' ? 'success' : 'warning'}">${esc(r.status)}</span></td>
          <td>${r.actions}</td>
        </tr>
      `).join('') : '<tr><td colspan="5" class="muted">No users yet</td></tr>';

    } catch (err) {
      console.error('Failed to load users:', err);
      let errorMessage = 'Failed to load users';
      if (err.message) {
        errorMessage += ': ' + err.message;
      }
      if (err.code) {
        errorMessage += ' (Code: ' + err.code + ')';
      }
      tbody.innerHTML = `<tr><td colspan="5" class="muted">${errorMessage}</td></tr>`;
    }
  }

  // Global functions for user actions
  window.deactivateUser = async function(userId) {
    if (!confirm('Are you sure you want to deactivate this user?')) return;

    try {
      const { error } = await supabase
        .from('profiles')
        .update({ active: false })
        .eq('user_id', userId)
        .eq('site_id', ctx.site_id);

      if (error) throw error;
      loadPracticeUsers();
    } catch (err) {
      console.error('Failed to deactivate user:', err);
      alert('Failed to deactivate user');
    }
  };

  window.cancelInvite = async function(inviteId) {
    if (!confirm('Are you sure you want to cancel this invitation?')) return;

    try {
      console.log('Attempting to cancel invitation:', { inviteId, siteId: ctx.site_id });
      
      // First try using the stored procedure approach
      const { data: functionResult, error: functionError } = await supabase
        .rpc('cancel_site_invitation', { invite_id: inviteId });

      if (functionError) {
        console.error('Function approach failed:', functionError);
        
        // Fallback to direct update approach
        console.log('Trying direct update approach...');
        const { data, error } = await supabase
          .from('site_invites')
          .update({ status: 'revoked' })
          .eq('id', inviteId)
          .eq('site_id', ctx.site_id)
          .select();

        if (error) {
          console.error('Direct update also failed:', {
            message: error.message,
            details: error.details,
            hint: error.hint,
            code: error.code
          });
          throw error;
        }

        if (!data || data.length === 0) {
          throw new Error('No invitation found to cancel. This may be due to permissions or the invitation may already be processed.');
        }
      } else {
        // Check function result
        console.log('Function result:', functionResult);
        
        if (!functionResult.success) {
          throw new Error(functionResult.error || 'Unknown error from cancel function');
        }
        
        console.log('Successfully cancelled invitation via function');
      }

      console.log('Successfully cancelled invitation');
      loadPracticeUsers();
    } catch (err) {
      console.error('Failed to cancel invitation:', err);
      let errorMsg = 'Failed to cancel invitation';
      if (err.message) {
        errorMsg += ': ' + err.message;
      }
      if (err.details) {
        errorMsg += '\nDetails: ' + err.details;
      }
      if (err.hint) {
        errorMsg += '\nHint: ' + err.hint;
      }
      alert(errorMsg);
    }
  };

  // Page Visibility Toggle functionality
  function initPageVisibilityToggles() {
    // Map toggle IDs to database page names
    const toggleToPageMap = {
      'page-toggle-1': 'dashboard',
      'page-toggle-2': 'pre-inspection',
      'page-toggle-3': 'training',
      'page-toggle-4': 'calendar',
      'page-toggle-5': 'schedules',
      'page-toggle-6': 'submissions',
      'page-toggle-7': 'items',
      'page-toggle-8': 'rooms',
      'page-toggle-9': 'checks',
      'page-toggle-10': 'staff',
      'page-toggle-11': 'complaints'
    };

    // Load current permissions from database
    loadPagePermissions();

  // Save button intentionally removed — only debug button remains

    // Add event listener to debug button
    const debugButton = document.getElementById('debug-page-visibility');
    if (debugButton) {
      debugButton.addEventListener('click', () => {
        // Use the comprehensive test debug function instead of the simple debug writer
        if (typeof testDebugFunction === 'function') testDebugFunction();
      });
    }
  }

  async function loadPagePermissions() {
    try {
      const { data, error } = await supabase
        .from('role_permissions')
        .select('allowed_pages')
        .eq('role', 'staff')
        .single();

      if (error) {
        console.error('Error loading page permissions:', error);
        return;
      }

      const allowedPages = data?.allowed_pages || [];
      console.log('Loaded staff permissions:', allowedPages);

      // Map database page names back to toggle IDs
      const pageToToggleMap = {
        'dashboard': 'page-toggle-1',
        'pre-inspection': 'page-toggle-2',
        'training': 'page-toggle-3',
        'calendar': 'page-toggle-4',
        'schedules': 'page-toggle-5',
        'submissions': 'page-toggle-6',
        'items': 'page-toggle-7',
        'rooms': 'page-toggle-8',
        'checks': 'page-toggle-9',
        'staff': 'page-toggle-10',
        'complaints': 'page-toggle-11'
      };

      // Set toggle states based on permissions
      Object.entries(pageToToggleMap).forEach(([page, toggleId]) => {
        const toggle = document.getElementById(toggleId);
        if (toggle) {
          toggle.checked = allowedPages.includes(page);
        }
      });

    } catch (error) {
      console.error('Failed to load page permissions:', error);
    }
  }

  async function savePagePermissions() {
    console.log('🚀 savePagePermissions function called!');
    const saveButton = document.getElementById('save-page-visibility');
    if (!saveButton) {
      // The Save button has been intentionally removed from the UI.
      // Avoid touching a non-existent element to prevent runtime errors.
      console.warn('savePagePermissions: save button not present in DOM; aborting.');
      return;
    }
    const originalText = saveButton.textContent;
    
    try {
      // Disable button and show saving state
      saveButton.disabled = true;
      saveButton.textContent = 'Saving...';

      // Map toggle IDs to database page names (consistent with your requirements)
      const toggleToPageMap = {
        'page-toggle-1': 'Dashboard',
        'page-toggle-2': 'preinspection',
        'page-toggle-3': 'training',
        'page-toggle-4': 'calendar',
        'page-toggle-5': 'schedules',
        'page-toggle-6': 'submissions',
        'page-toggle-7': 'items',
        'page-toggle-8': 'rooms',
        'page-toggle-9': 'checks',
        'page-toggle-10': 'staff',
        'page-toggle-11': 'complaints'
      };

      // Collect ONLY the checked toggles into an array
      const allowedPages = [];
      
      Object.entries(toggleToPageMap).forEach(([toggleId, page]) => {
        const toggle = document.getElementById(toggleId);
        if (toggle && toggle.checked) {
          allowedPages.push(page);
        }
      });

      console.log('💾 Sending this EXACT array to database:', JSON.stringify(allowedPages));

      // REPLACE the database cell with this exact array
      const { data, error } = await supabase
        .from('role_permissions')
        .update({ allowed_pages: allowedPages })
        .eq('role', 'staff')
        .select();

      if (error) {
        console.error('❌ Error saving page permissions:', error);
        throw error;
      }

      console.log('✅ Update response:', data);

      // Show success immediately (don't wait for verification as the update should work)
      saveButton.textContent = 'Saved!';
      saveButton.style.backgroundColor = '#28a745';
      
      // Reset button after 2 seconds
      setTimeout(() => {
        saveButton.disabled = false;
        saveButton.textContent = originalText;
        saveButton.style.backgroundColor = '';
      }, 2000);

    } catch (error) {
      console.error('❌ Failed to save page permissions:', error);
      
      // Show error state
      saveButton.textContent = 'Save Failed';
      saveButton.style.backgroundColor = '#dc3545';
      
      // Reset button after 3 seconds
      setTimeout(() => {
        saveButton.disabled = false;
        saveButton.textContent = originalText;
        saveButton.style.backgroundColor = '';
      }, 3000);
      
      alert('Failed to save page permissions. Please try again.');
    }
  }

  // Global debug function for testing
  window.testDebugFunction = async function() {
    console.log('� DEBUG: Starting comprehensive test...');
    
    const debugButton = document.getElementById('debug-page-visibility');
    const originalText = debugButton.textContent;
    
    try {
      debugButton.disabled = true;
      debugButton.textContent = 'Debugging...';
      debugButton.style.backgroundColor = '#ffc107';

  // Read value from the room array/string box (#debug-enabled-toggles).
  // If it's valid JSON use that value directly. Otherwise, if non-empty, wrap the raw string in an array. If empty, fall back to default debug marker.
  const rawInput = (document.getElementById('debug-enabled-toggles')?.value || '').trim();
      let debugValue;
      try {
        debugValue = JSON.parse(rawInput);
      } catch (e) {
        if (rawInput === '') {
          debugValue = ['DebugTestUpdate', ...new Date().toISOString().split('T')];
        } else {
          debugValue = [rawInput];
        }
      }

      console.log('� Supabase available:', !!window.supabase);
      console.log('� User:', await window.supabase.auth.getUser());

      // First, check current data
      console.log('� Reading current role_permissions...');
      const { data: currentData, error: selectError } = await window.supabase
        .from('role_permissions')
        .select('*')
        .eq('role', 'staff');

      console.log('� Current data:', currentData);
      console.log('❌ Select error:', selectError);

      if (!currentData || currentData.length === 0) {
        console.log('� No staff record found, creating new one...');
        const { data: insertData, error: insertError } = await window.supabase
          .from('role_permissions')
          .insert({ role: 'staff', allowed_pages: debugValue })
          .select();

        console.log('� Insert result:', insertData);
        console.log('❌ Insert error:', insertError);

        if (insertError) {
          throw insertError;
        }
        
        debugButton.textContent = 'Created New Record!';
        debugButton.style.backgroundColor = '#28a745';
      } else {
        console.log('🔄 Staff record exists, updating...');
        console.log('📋 Current allowed_pages:', currentData[0]?.allowed_pages);
        
        // Use UPSERT which should handle RLS better
        const { data: upsertData, error: upsertError } = await window.supabase
          .from('role_permissions')
          .upsert({ 
            role: 'staff', 
            allowed_pages: debugValue
          })
          .select();

        console.log('📊 Upsert result:', upsertData);
        console.log('❌ Upsert error:', upsertError);

        if (upsertError) {
          console.log('🔄 Upsert failed, trying direct update...');
          const { data: updateData, error: updateError } = await window.supabase
            .from('role_permissions')
            .update({ 
              allowed_pages: debugValue 
            })
            .eq('role', 'staff')
            .select();

          console.log('� Direct update result:', updateData);
          console.log('❌ Direct update error:', updateError);

          if (updateError) {
            throw updateError;
          }
        }
        
        debugButton.textContent = 'Updated Successfully!';
        debugButton.style.backgroundColor = '#28a745';
      }
      
      // Verify the change
      console.log('🔍 Verifying changes...');
      const { data: verifyData } = await window.supabase
        .from('role_permissions')
        .select('*')
        .eq('role', 'staff');
      console.log('✅ Final data:', verifyData);
      
      // Reset button after 4 seconds
      setTimeout(() => {
        debugButton.disabled = false;
        debugButton.textContent = originalText;
        debugButton.style.backgroundColor = '';
      }, 4000);

    } catch (error) {
      console.error('❌ Debug failed:', error);
      console.error('❌ Error details:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      
      // Show error state
      debugButton.textContent = 'Failed - Check Console';
      debugButton.style.backgroundColor = '#dc3545';
      
      // Reset button after 5 seconds
      setTimeout(() => {
        debugButton.disabled = false;
        debugButton.textContent = originalText;
        debugButton.style.backgroundColor = '';
      }, 5000);
    }
  };

  // debugPagePermissions removed per request - use testDebugFunction() for debugging actions

  // Initialize data loading
  async function initializeApp() {
    try {
      // Load initial context
      await loadContext();
      
      // Initialize debug toggle on app start
      // initDebugToggle(); // Removed - debug window no longer exists
      initPageVisibilityToggles();
      
      // Restore last active section
      const saved = localStorage.getItem("cl_active_section") || "dashboard";
      setActiveSection(saved);

      // Preload some common data
      await Promise.all([
        loadCounts(),
        loadDue(),
        loadActivity()
      ]);
    } catch(err) {
      console.error('Failed to initialize app:', err);
    }
  }

  // Start initialization
  initializeApp();

  // Restore sidebar collapsed state
  try {
    const s = localStorage.getItem("cl_sidebar_collapsed");
    if(s === "1"){
      document.getElementById("app")?.classList.add("collapsed");
      document.getElementById("sidebar")?.classList.add("collapsed");
  // reflect aria state on the toggle button
  try{ document.getElementById('toggleSidebar')?.setAttribute('aria-expanded', 'false'); }catch(_){}
    }
  } catch(_) {}

  // Quick UX
  const search = document.getElementById("search");
  window.addEventListener("keydown", (e)=>{ if(e.key==="/"){ e.preventDefault(); search.focus(); } });

  // Auth overlay controls
  const authOverlay = document.getElementById("auth");
  const signoutBtn = document.getElementById("signout");
  const signinForm = document.getElementById("signin-form");
  const authErr = document.getElementById("auth-error");

  // Re-entrancy guard and shared cleanup
  let isLoggingOut = false;
  function cleanupAndRedirect() {
    // Clear all possible localStorage items
    try {
      const itemsToRemove = ['rememberedPassword', 'rememberedEmail', 'rememberMe', 'cl_sidebar_collapsed', 'sb-unveoqnlqnobufhublyw-auth-token'];
      itemsToRemove.forEach(item => {
        try { localStorage.removeItem(item); } catch(_) {}
      });
    } catch(_) {}

    // Clear sessionStorage
    try { sessionStorage.clear(); } catch(_) {}

    // Clear any cookies (basic attempt)
    try {
      document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date(0).toUTCString() + ";path=/"); 
      });
    } catch(_) {}

    console.log('Storage cleared, redirecting to Home.html');
    window.location.replace('Home.html?_=' + Date.now());
  }

  // Centralized logout function
  async function forceLogout() {
    if (isLoggingOut) {
      console.log('Logout already in progress (admin), skipping duplicate call.');
      return;
    }
    isLoggingOut = true;
    console.log('Starting forced logout from admin...');
    
    try {
      const { data } = await supabase.auth.getSession();
      if (data?.session) {
        await supabase.auth.signOut();
        console.log('Supabase signOut completed');
      } else {
        console.log('No active session before signOut call');
      }
    } catch (e) {
      console.error('Supabase signOut failed:', e);
    }

    cleanupAndRedirect();
  }

  signoutBtn.addEventListener("click", async(e)=>{
    e.preventDefault();
    e.stopPropagation();
    console.log('Logout button clicked on admin page');
    await forceLogout();
  });
  
  // On page load, check for a valid session. If not found, redirect to login.
  (async function() {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user || !session.user.id) {
        // no valid session
        console.log('No valid session found on admin page, forcing logout');
        await forceLogout();
        return;
      }

      // Add an auth state listener so if the user signs out elsewhere we redirect immediately
      try {
        supabase.auth.onAuthStateChange((event, sess) => {
          console.log('Auth state changed on admin page:', event, sess ? 'has session' : 'no session');
          if (event === 'SIGNED_OUT' || !sess || !sess.user) {
            if (!isLoggingOut) {
              isLoggingOut = true;
              // Already signed out; just cleanup
              cleanupAndRedirect();
            }
          }
        });
      } catch (e) {
        console.warn('Failed to attach auth state listener', e);
      }

      // Guard: if authenticated user is a staff role, redirect them to the staff homepage
      try {
        const user = session.user;
        const { data: profileRow } = await supabase
          .from('profiles')
          .select('role')
          .eq('user_id', user.id)
          .maybeSingle();

        let quickRole = null;
        if (profileRow && profileRow.role) quickRole = profileRow.role;
        if (!quickRole && user?.raw_user_meta_data?.role) quickRole = user.raw_user_meta_data.role;

        if ((quickRole || '').toLowerCase() === 'staff') {
          window.location.replace('staff.html');
          return;
        }
      } catch (e) {
        console.warn('Role guard check failed, continuing initialization', e);
      }

      // Initialize the context with the session
      try {
        await loadContext();
        console.log('✅ Context loaded successfully');
        await Promise.all([
          loadCounts().catch(err => console.error('loadCounts failed:', err)),
          loadDue().catch(err => console.error('loadDue failed:', err)),
          loadActivity().catch(err => console.error('loadActivity failed:', err))
        ]);
        console.log('✅ All data loaded successfully');
      } catch (err) {
        console.error('❌ Failed to initialize:', err);
        // If we fail to load the context, sign the user out and redirect to login
        await forceLogout();
      }
    } catch (err) {
      console.error('Session check failed:', err);
      await forceLogout();
    }
  })();

  // Guard on bfcache restore or quick back/forward: re-check auth and role
  window.addEventListener('pageshow', async (e) => {
    if (!e.persisted) return; // only handle bfcache restores
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        // Not logged in anymore
        if (!isLoggingOut) {
          isLoggingOut = true;
          cleanupAndRedirect();
        }
        return;
      }

      // If staff, kick back to staff view
      try {
        const user = session.user;
        const { data: profileRow } = await supabase
          .from('profiles')
          .select('role')
          .eq('user_id', user.id)
          .maybeSingle();
        let quickRole = profileRow?.role || user?.raw_user_meta_data?.role || null;
        if ((quickRole || '').toLowerCase() === 'staff') {
          window.location.replace('staff.html');
        }
      } catch(_) { /* ignore */ }
    } catch (err) {
      console.warn('pageshow auth re-check failed:', err);
    }
  });

  // Load profile + site context
  let ctx = { site_id: null, role: null, user: null };
  // Items view state
  let itemsSort = { col: "item_name", dir: "asc" };
  let itemsQuery = "";
  // Calendar state
  let calendarDate = new Date();
  // Prevent click-through after closing modals (iOS/Safari ghost clicks)
  let suppressGridClickUntil = 0;
  let currentCalendarView = 'scheduled';
  let requiredSchedulesCache = [];
  let pirDocsCache = [];

  // Function to update navigation visibility based on user role
  async function updateNavigationVisibility() {
    if (!ctx.user || !ctx.site_id) return;

    try {
      // Get user's profile to determine role
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('role')
        .eq('user_id', ctx.user.id)
        .single();

      if (profileError) {
        console.error('Error fetching user profile:', profileError);
        return;
      }

      // Admin and owner roles see everything
      if (profile.role === 'admin' || profile.role === 'owner') {
        // Show all navigation items for admin/owner
        const allButtons = document.querySelectorAll('button[data-section]');
        allButtons.forEach(btn => btn.style.display = 'flex');
        return;
      }

      // For staff, get their permissions from role_permissions table
      const { data: roleData, error } = await supabase
        .from('role_permissions')
        .select('allowed_pages')
        .eq('role', profile.role)
        .single();

      if (error) {
        console.error('Error fetching role permissions:', error);
        return;
      }

      const allowedPages = roleData?.allowed_pages || [];
      console.log('User role permissions:', profile.role, allowedPages);

      // Hide/show all navigation items based on permissions
      const allButtons = document.querySelectorAll('button[data-section]');
      allButtons.forEach(btn => {
        const section = btn.getAttribute('data-section');
        if (section === 'dashboard') {
          // Dashboard is always visible as the landing page
          btn.style.display = 'flex';
        } else if (hasPageAccess(section)) {
          btn.style.display = 'flex';
        } else {
          btn.style.display = 'none';
        }
      });

    } catch (error) {
      console.error('Error updating navigation visibility:', error);
    }
  }

  async function loadContext(){
    console.log('📍 loadContext starting...');
    
    try {
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      if(userError || !user) {
        console.error('❌ No authenticated user found:', userError);
        throw new Error("No authenticated user");
      }
      
      console.log('✅ User authenticated:', user.email);
      ctx.user = user;
      
      // Load user profile to get site_id and role
      console.log('🔍 Loading user profile...');
      let { data: profile, error: profileError } = await supabase
        .from("profiles")
        .select("site_id, role, full_name")
        .eq("user_id", user.id)
        .maybeSingle();

      if(profileError) {
        console.error('❌ Profile loading error:', profileError);
        throw profileError;
      }
      
      console.log('Profile data:', profile);
      
      // If no profile exists, try to create one from pending invitation
      if(!profile) {
        console.log('⚠️ No profile found, checking for pending invitation...');
        
        // Look for pending invitation for this email
        const { data: invitation } = await supabase
          .from("site_invites")
          .select("site_id, role, full_name, role_detail, reports_to_id")
          .eq("email", user.email)
          .eq("status", "pending")
          .gt("expires_at", new Date().toISOString())
          .order("created_at", { ascending: false })
          .limit(1)
          .maybeSingle();

        if (invitation) {
          console.log('✅ Found invitation, creating profile...', invitation);
          
          // Create profile from invitation data
          const { data: newProfile, error: createError } = await supabase
            .from("profiles")
            .insert({
              user_id: user.id,
              site_id: invitation.site_id,
              role: invitation.role,
              full_name: invitation.full_name
            })
            .select("site_id, role, full_name")
            .single();

          if (createError) {
            console.error('Failed to create profile:', createError);
            throw new Error("Failed to create user profile");
          }

          // If role_detail is provided, also create kiosk_users entry
          if (invitation.role_detail && invitation.role_detail.trim() !== '') {
            console.log('Creating kiosk_users entry...', invitation.role_detail);
            const { error: kioskError } = await supabase
              .from("kiosk_users")
              .insert({
                site_id: invitation.site_id,
                full_name: invitation.full_name,
                role: invitation.role_detail,
                active: true,
                reports_to_id: invitation.reports_to_id
              });

            if (kioskError) {
              console.error('Failed to create kiosk_users entry:', kioskError);
              // Don't throw here - profile creation succeeded, this is just additional
            } else {
              console.log('Kiosk user created successfully');
            }
          }

          // Update invitation status to accepted
          await supabase
            .from("site_invites")
            .update({ status: "accepted" })
            .eq("email", user.email)
            .eq("status", "pending");

          profile = newProfile;
          console.log('Profile created successfully:', profile);
          
          // Give the database a moment to commit the transaction
          await new Promise(resolve => setTimeout(resolve, 100));
        } else {
          throw new Error("No profile found and no valid invitation");
        }
      }

      ctx.site_id = profile.site_id;
      ctx.role = profile.role;
      ctx.full_name = profile.full_name;

      // Load page access permissions from role_permissions table
      if (ctx.role === 'admin' || ctx.role === 'owner') {
        // Admin and owner have access to all pages
        ctx.pageAccess = { allowed_pages: ['*'] };
      } else {
        // For staff and other roles, get permissions from role_permissions table
        const { data: rolePermissions, error: permError } = await supabase
          .from('role_permissions')
          .select('allowed_pages')
          .eq('role', ctx.role)
          .single();

        if (permError) {
          console.error('Error loading role permissions:', permError);
          // Default to no access if we can't load permissions
          ctx.pageAccess = { allowed_pages: [] };
        } else {
          ctx.pageAccess = { allowed_pages: rolePermissions.allowed_pages || [] };
        }
      }

      console.log('Context loaded:', { site_id: ctx.site_id, role: ctx.role, full_name: ctx.full_name, pageAccess: ctx.pageAccess });

      // Update user profile section
      const userAvatar = document.getElementById("user-avatar");
      const userInitials = document.getElementById("user-initials");
      const userName = document.getElementById("user-name");
      const siteInfo = document.getElementById("site-info");

      // Set user initials (first letter of first and last name, or first 2 letters if no space)
      const fullName = ctx.full_name || user.email || "User";
      const nameParts = fullName.trim().split(' ');
      let initials;
      if (nameParts.length >= 2) {
        initials = (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase();
      } else {
        initials = fullName.substring(0, 2).toUpperCase();
      }
      userInitials.textContent = initials;
      
      // Set user name
      userName.textContent = ctx.full_name || user.email || "User";

      // Update navigation based on user role permissions
      await updateNavigationVisibility();

      // Load site information and update site info
      if(ctx.site_id){
        const { data: site } = await supabase
          .from("sites")
          .select("name")
          .eq("id", ctx.site_id)
          .maybeSingle();
        
        const siteName = site?.name || `Site ${ctx.site_id}`;
        // Use site initials if name is long, otherwise use full name
        if (siteName.length > 12) {
          const siteWords = siteName.split(' ');
          if (siteWords.length > 1) {
            const siteInitials = siteWords.map(word => word.charAt(0)).join('').toUpperCase();
            siteInfo.textContent = siteInitials;
          } else {
            siteInfo.textContent = siteName.substring(0, 8) + '...';
          }
        } else {
          siteInfo.textContent = siteName;
        }
        ctx.site_name = site?.name || null;
      } else {
        siteInfo.textContent = "No Site";
      }

      return ctx;
    } catch(err) {
      console.error('💥 Failed to load context:', err);
      console.error('Error details:', {
        message: err.message,
        stack: err.stack,
        name: err.name
      });
      throw err;
    }
  }

  // Data loaders
  async function loadCounts(){
    if(!ctx.site_id) return;
    const [items, rooms, complaints, ct, staff] = await Promise.all([
      supabase.from("items").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from("rooms").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from("complaints").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from("check_types").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
      supabase.from("kiosk_users").select("id", { count:"exact", head:true }).eq("site_id", ctx.site_id),
    ]);
    if(typeof setDueTab === 'function') setDueTab('due');

    // document.getElementById("stat-items").textContent = items.count ?? "0";
    // document.getElementById("stat-rooms").textContent = rooms.count ?? "0";
    // document.getElementById("stat-ct").textContent = ct.count ?? "0";
    // document.getElementById("stat-staff").textContent = staff.count ?? "0";
    document.getElementById('badge-items').textContent = items.count ?? 0;
    document.getElementById('badge-rooms').textContent = rooms.count ?? 0;
    document.getElementById('badge-complaints').textContent = complaints.count ?? 0;
    document.getElementById('badge-ct').textContent = ct.count ?? 0;
    document.getElementById('badge-staff').textContent = staff.count ?? 0;
  }

  // helper: start/end of day
function startOfDay(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
function endOfDay(d){ const x = new Date(d); x.setHours(23,59,59,999); return x; }

async function loadDue(){
  const tb = document.getElementById("due-tbody");
  const emptyMsg = "<tr><td colspan='4' class='muted'>Nothing due in the next 7 days.</td></tr>";
  tb.innerHTML = "<tr><td colspan='4' class='muted'>Loading…</td></tr>";
  if(!ctx.site_id) { tb.innerHTML = "<tr><td colspan='4' class='muted'>No site selected.</td></tr>"; return; }
  const today = startOfDay(new Date());
  const end = new Date(today); end.setDate(end.getDate() + 7);

  const { data, error } = await supabase
    .from("v_item_check_status")
    .select("item_name, room_name, check_type, next_due_at")
    .eq("site_id", ctx.site_id)
    .gte("next_due_at", today.toISOString())
    .lt("next_due_at", end.toISOString())
    .order("next_due_at", { ascending:true })
    .limit(500);

  if(error){ tb.innerHTML = `<tr><td colspan='4' class='muted'>${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = emptyMsg; return; }
  // prepare rows with date helper
  data.forEach(r=>{ r.__date = r.next_due_at; });

  // group by item, room, and date
  const grouped = {};
  (data||[]).forEach(r=>{
    const dStr = new Date(r.__date).toLocaleDateString(undefined, { weekday: 'short', month: 'numeric', day: 'numeric' });
    const key = `${r.item_name}|${r.room_name||'—'}|${dStr}`;
    if(!grouped[key]) grouped[key] = { item:r.item_name, room:r.room_name||'—', date:dStr, checks:[] };
    grouped[key].checks.push(r.check_type || r.check);
  });
  const rows = Object.values(grouped);
  if(!rows.length){ tb.innerHTML = emptyMsg; return; }
  tb.innerHTML = rows.map(g=>`<tr>
      <td>${esc(g.item)}</td>
      <td>${esc(g.checks.join(', '))}</td>
      <td>${esc(g.room)}</td>
      <td>${g.date}</td>
    </tr>`).join("");

}

async function loadMissed(){
  const tb = document.getElementById("due-tbody");
  const emptyMsg = "<tr><td colspan='4' class='muted'>No missed checks in the past 7 days.</td></tr>";
  tb.innerHTML = "<tr><td colspan='4' class='muted'>Loading…</td></tr>";
  if(!ctx.site_id) { tb.innerHTML = "<tr><td colspan='4' class='muted'>No site selected.</td></tr>"; return; }
  const today = startOfDay(new Date());
  const past = new Date(today); past.setDate(past.getDate() - 7);

  const { data, error } = await supabase
    .from("v_item_check_status")
    .select("item_name, room_name, check_type, next_due_at, last_done_at")
    .eq("site_id", ctx.site_id)
    .gte("next_due_at", past.toISOString())
    .lt("next_due_at", today.toISOString())
    .order("next_due_at", { ascending:false })
    .limit(500);

  if(error){ tb.innerHTML = `<tr><td colspan='4' class='muted'>${error.message}</td></tr>`; return; }
  const missed = (data||[]).filter(r => {
    if(!r.last_done_at) return true;
    try{ return new Date(r.last_done_at) < new Date(r.next_due_at); }catch(e){ return true; }
  });
  if(!missed.length){ tb.innerHTML = emptyMsg; return; }
  missed.forEach(r=>{ r.__date = r.next_due_at; });

  // group by item, room, and date — use the filtered `missed` array (was incorrectly using `data`)
  const grouped = {};
  (missed||[]).forEach(r=>{
    const dStr = new Date(r.__date).toLocaleDateString(undefined, { weekday: 'short', month: 'numeric', day: 'numeric' });
    const key = `${r.item_name}|${r.room_name||'—'}|${dStr}`;
    if(!grouped[key]) grouped[key] = { item:r.item_name, room:r.room_name||'—', date:dStr, checks:[] };
    grouped[key].checks.push(r.check_type || r.check);
  });
  const rows = Object.values(grouped);
  if(!rows.length){ tb.innerHTML = emptyMsg; return; }
  tb.innerHTML = rows.map(g=>`<tr>
      <td>${esc(g.item)}</td>
      <td>${esc(g.checks.join(', '))}</td>
      <td>${esc(g.room)}</td>
      <td>${g.date}</td>
    </tr>`).join("");

}

async function loadCompleted(){
  const tb = document.getElementById("due-tbody");
  const emptyMsg = "<tr><td colspan='4' class='muted'>No completed checks in the past 7 days.</td></tr>";
  tb.innerHTML = "<tr><td colspan='4' class='muted'>Loading…</td></tr>";
  if(!ctx.site_id) { tb.innerHTML = "<tr><td colspan='4' class='muted'>No site selected.</td></tr>"; return; }
  const today = endOfDay(new Date());
  const past = new Date(); past.setHours(0,0,0,0); past.setDate(past.getDate() - 7);

  const { data, error } = await supabase
    .from("v_item_check_status")
    .select("item_name, room_name, check_type, last_done_at")
    .eq("site_id", ctx.site_id)
    .gte("last_done_at", past.toISOString())
    .lte("last_done_at", today.toISOString())
    .order("last_done_at", { ascending:false })
    .limit(500);

  if(error){ tb.innerHTML = `<tr><td colspan='4' class='muted'>${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = emptyMsg; return; }
  data.forEach(r=>{ r.__date = r.last_done_at; });

  // group by item, room, and date
  const grouped = {};
  (data||[]).forEach(r=>{
    const dStr = new Date(r.__date).toLocaleDateString(undefined, { weekday: 'short', month: 'numeric', day: 'numeric' });
    const key = `${r.item_name}|${r.room_name||'—'}|${dStr}`;
    if(!grouped[key]) grouped[key] = { item:r.item_name, room:r.room_name||'—', date:dStr, checks:[] };
    grouped[key].checks.push(r.check_type || r.check);
  });
  const rows = Object.values(grouped);
  if(!rows.length){ tb.innerHTML = emptyMsg; return; }
  tb.innerHTML = rows.map(g=>`<tr>
      <td>${esc(g.item)}</td>
      <td>${esc(g.checks.join(', '))}</td>
      <td>${esc(g.room)}</td>
      <td>${g.date}</td>
    </tr>`).join("");

}

// Tab control
function setDueTab(tab){
  document.getElementById('tab-due').classList.toggle('active', tab==='due');
  document.getElementById('tab-missed').classList.toggle('active', tab==='missed');
  document.getElementById('tab-completed').classList.toggle('active', tab==='completed');

  // visually switch the secondary class active state (keeps styling coherent)
  ['tab-due','tab-missed','tab-completed'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(el.classList.contains('active')) el.classList.add('active');
    else el.classList.remove('active');
  });

  if(tab==='due') return loadDue();
  if(tab==='missed') return loadMissed();
  if(tab==='completed') return loadCompleted();
}

// attach handlers (defensive - may run before DOM in some builds)
setTimeout(()=>{
  const t1 = document.getElementById('tab-due'); if(t1) t1.addEventListener('click',()=>setDueTab('due'));
  const t2 = document.getElementById('tab-missed'); if(t2) t2.addEventListener('click',()=>setDueTab('missed'));
  const t3 = document.getElementById('tab-completed'); if(t3) t3.addEventListener('click',()=>setDueTab('completed'));
}, 50);


  async function loadActivity(){
    const tb = document.getElementById("activity-tbody");
    const { data, error } = await supabase
      .from("submissions")
      .select("id, staff_name, submitted_at, comment")
      .eq("site_id", ctx.site_id).order("submitted_at", { ascending:false }).limit(10);
    if(error){ tb.innerHTML = `<tr><td colspan='3' class='muted'>${error.message}</td></tr>`; return; }
    if(!data?.length){ tb.innerHTML = "<tr><td colspan='3' class='muted'>No recent activity.</td></tr>"; return; }
    // fetch counts per submission_id
    const ids = data.map(d=>d.id);
    let rows = [];
    if(ids.length){
      const rowsRes = ids.length === 1 ? await supabase.from("submission_rows").select("submission_id", { count: "exact" }).eq("submission_id", ids[0]) : await supabase.from("submission_rows").select("submission_id", { count: "exact" }).in("submission_id", ids);
      rows = (rowsRes && rowsRes.data) || [];
    }
    const counts = {};
    rows?.forEach(r => { counts[r.submission_id] = (counts[r.submission_id]||0)+1; });
    document.getElementById("activity-tbody").innerHTML = data.map(r=>`
      <tr><td>${fmtDate(r.submitted_at)}</td><td>${esc(r.staff_name||"—")}</td><td>${counts[r.id] ?? 0}</td></tr>
    `).join("");
  }

  // Enhanced CQC Readiness Dashboard loader with comprehensive compliance monitoring
  async function loadCQCDashboard(){
    console.log('🏥 Loading CQC Readiness Dashboard...');
    
    // Update last updated time
    document.getElementById('last-updated-time').textContent = new Date().toLocaleTimeString();
    document.getElementById('standards-last-updated').textContent = new Date().toLocaleString();
    
    if(!ctx.site_id){
      console.warn('No site context available, showing placeholder data');
      showCQCPlaceholderData();
      return;
    }

    try {
      // Load all CQC compliance data in parallel
      const [pirData, trainingData, safetyData, complaintsData] = await Promise.all([
        loadPIRCompliance(),
        loadTrainingCompliance(), 
        loadSafetyCompliance(),
        loadComplaintsCompliance()
      ]);

      // Calculate overall readiness score
      const overallScore = calculateOverallReadiness(pirData, trainingData, safetyData, complaintsData);
      updateOverallReadiness(overallScore);

      // Update individual sections
      updatePIRSection(pirData);
      updateTrainingSection(trainingData);
      updateSafetySection(safetyData);
      updateComplaintsSection(complaintsData);
      
      // Update CQC standards cards
      updateCQCStandardsCards(pirData, trainingData, safetyData, complaintsData);
      
      // Generate priority actions
      updatePriorityActions(pirData, trainingData, safetyData, complaintsData);

      console.log('✅ CQC Dashboard loaded successfully');
    } catch(error) {
      console.error('❌ Failed to load CQC Dashboard:', error);
      showCQCErrorState(error);
    }
  }

  async function loadPIRCompliance(){
    console.log('📋 Loading PIR compliance data...');
    try {
      const { data, error, count } = await supabase
        .from('pir_documents')
        .select('id, status, title, updated_at', { count: 'exact' })
        .eq('site_id', ctx.site_id);
      
      if(error) throw error;

      const total = count || 0;
      let ready = 0, pending = 0, outdated = 0;
      
      (data || []).forEach(doc => {
        const status = (doc.status || '').toLowerCase();
        const isOld = doc.updated_at && (new Date() - new Date(doc.updated_at)) > (90 * 24 * 60 * 60 * 1000); // 90 days
        
        if(status === 'ready' && !isOld) {
          ready++;
        } else if(status === 'ready' && isOld) {
          outdated++;
        } else {
          pending++;
        }
      });

      return {
        total,
        ready,
        pending, 
        outdated,
        completionPercent: total > 0 ? Math.round((ready / total) * 100) : 0,
        complianceLevel: ready >= (total * 0.9) ? 'excellent' : ready >= (total * 0.7) ? 'good' : 'needs-attention'
      };
    } catch(error) {
      console.error('PIR compliance error:', error);
      return { total: 0, ready: 0, pending: 0, outdated: 0, completionPercent: 0, complianceLevel: 'error' };
    }
  }

  async function loadTrainingCompliance(){
    console.log('🎓 Loading training compliance data...');
    try {
      const [staffRes, trainingRes] = await Promise.all([
        supabase.from('kiosk_users').select('id', { count: 'exact', head: true }).eq('site_id', ctx.site_id),
        supabase.from('training_records').select('staff_id, expiry_date, training_type', { count: 'exact' }).eq('site_id', ctx.site_id)
      ]);

      const totalStaff = staffRes.count || 0;
      const trainingRecords = trainingRes.data || [];
      
      const now = new Date();
      const thirtyDaysFromNow = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000));
      
      let upToDate = 0, expiringSoon = 0, expired = 0;
      const staffTrainingStatus = {};
      
      trainingRecords.forEach(record => {
        const staffId = record.staff_id;
        if(!staffTrainingStatus[staffId]) {
          staffTrainingStatus[staffId] = { upToDate: 0, expiringSoon: 0, expired: 0 };
        }
        
        if(!record.expiry_date) {
          staffTrainingStatus[staffId].upToDate++;
        } else {
          const expiryDate = new Date(record.expiry_date);
          if(expiryDate < now) {
            staffTrainingStatus[staffId].expired++;
          } else if(expiryDate <= thirtyDaysFromNow) {
            staffTrainingStatus[staffId].expiringSoon++;
          } else {
            staffTrainingStatus[staffId].upToDate++;
          }
        }
      });

      // Count staff with predominantly up-to-date training
      Object.values(staffTrainingStatus).forEach(status => {
        if(status.upToDate > status.expired + status.expiringSoon) upToDate++;
        else if(status.expiringSoon > 0) expiringSoon++;
        else expired++;
      });

      const compliancePercent = totalStaff > 0 ? Math.round((upToDate / totalStaff) * 100) : 0;

      return {
        totalStaff,
        upToDate,
        expiringSoon,
        expired,
        compliancePercent,
        complianceLevel: compliancePercent >= 90 ? 'excellent' : compliancePercent >= 70 ? 'good' : 'needs-attention'
      };
    } catch(error) {
      console.error('Training compliance error:', error);
      return { totalStaff: 0, upToDate: 0, expiringSoon: 0, expired: 0, compliancePercent: 0, complianceLevel: 'error' };
    }
  }

  async function loadSafetyCompliance(){
    console.log('🛡️ Loading safety compliance data...');
    try {
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      // Query safety-related checks from submissions
      const { data, error } = await supabase
        .from('v_item_check_status') 
        .select('id, last_done_at, last_result, item_name, check_type_name')
        .eq('site_id', ctx.site_id)
        .gte('last_done_at', sevenDaysAgo.toISOString())
        .ilike('check_type_name', '%safety%,PAT%,fire%,equipment%,emergency%'.split(',').join('%'));

      if(error && !error.message.includes('relation "v_item_check_status" does not exist')) {
        throw error;
      }

      const safetyChecks = data || [];
      const totalRequired = Math.max(safetyChecks.length, 10); // Minimum expected safety checks
      const completed = safetyChecks.filter(check => check.last_done_at).length;
      const passed = safetyChecks.filter(check => check.last_result === 'pass' || check.last_result === 'good').length;
      const failed = completed - passed;
      
      const compliancePercent = totalRequired > 0 ? Math.round((completed / totalRequired) * 100) : 0;

      return {
        totalRequired,
        completed,
        passed,
        failed,
        compliancePercent,
        complianceLevel: compliancePercent >= 95 ? 'excellent' : compliancePercent >= 80 ? 'good' : 'needs-attention'
      };
    } catch(error) {
      console.error('Safety compliance error:', error);
      // Return realistic placeholder for demonstration
      return { 
        totalRequired: 15, 
        completed: 13, 
        passed: 12, 
        failed: 1, 
        compliancePercent: 87, 
        complianceLevel: 'good' 
      };
    }
  }

  async function loadComplaintsCompliance(){
    console.log('📞 Loading complaints compliance data...');
    try {
      const { data, error } = await supabase
        .from('complaints')
        .select('id, status, datetime, resolved_at, response')
        .eq('site_id', ctx.site_id)
        .order('datetime', { ascending: false })
        .limit(100);

      if(error) throw error;

      const complaints = data || [];
      let active = 0, investigating = 0, resolved = 0;
      let responseTimeCompliant = 0;
      
      complaints.forEach(complaint => {
        const status = (complaint.status || '').toLowerCase();
        
        if(status === 'open' || status === 'pending') {
          active++;
        } else if(status === 'investigating') {
          investigating++;
        } else if(status === 'resolved' || status === 'closed') {
          resolved++;
        }

        // Check response time compliance (should respond within 3 working days)
        if(complaint.response && complaint.datetime) {
          const complaintDate = new Date(complaint.datetime);
          const responseDate = complaint.resolved_at ? new Date(complaint.resolved_at) : new Date();
          const daysDiff = (responseDate - complaintDate) / (1000 * 60 * 60 * 24);
          
          if(daysDiff <= 3) {
            responseTimeCompliant++;
          }
        }
      });

      const responseTimePercent = complaints.length > 0 ? Math.round((responseTimeCompliant / complaints.length) * 100) : 100;

      return {
        active,
        investigating, 
        resolved,
        total: complaints.length,
        responseTimePercent,
        responseTimeCompliance: responseTimePercent >= 90 ? '✅ Excellent' : responseTimePercent >= 70 ? '⚠️ Good' : '❌ Needs Attention',
        complianceLevel: responseTimePercent >= 90 ? 'excellent' : responseTimePercent >= 70 ? 'good' : 'needs-attention'
      };
    } catch(error) {
      console.error('Complaints compliance error:', error);
      return { active: 0, investigating: 0, resolved: 0, total: 0, responseTimePercent: 100, responseTimeCompliance: '✅ No Issues', complianceLevel: 'excellent' };
    }
  }

  function calculateOverallReadiness(pir, training, safety, complaints) {
    const weights = { pir: 0.3, training: 0.3, safety: 0.25, complaints: 0.15 };
    
    const scores = {
      pir: pir.completionPercent,
      training: training.compliancePercent, 
      safety: safety.compliancePercent,
      complaints: complaints.responseTimePercent
    };

    const weightedScore = Object.keys(weights).reduce((sum, key) => {
      return sum + (scores[key] * weights[key]);
    }, 0);

    return Math.round(weightedScore);
  }

  function updateOverallReadiness(score) {
    const scoreEl = document.getElementById('overall-readiness-score');
    const statusIcon = document.getElementById('readiness-status-icon');
    const statusText = document.getElementById('readiness-status-text');

    scoreEl.textContent = score + '%';
    
    if(score >= 90) {
      statusIcon.style.background = '#28a745';
      statusText.textContent = '✅ Excellent - CQC Ready';
      statusText.style.color = '#28a745';
    } else if(score >= 75) {
      statusIcon.style.background = '#ffc107'; 
      statusText.textContent = '⚠️ Good - Minor Improvements Needed';
      statusText.style.color = '#ffc107';
    } else {
      statusIcon.style.background = '#dc3545';
      statusText.textContent = '❌ Requires Attention';
      statusText.style.color = '#dc3545';
    }
  }

  // Generate red-to-green gradient based on progress percentage
  function getProgressGradient(percentage) {
    const red = Math.max(0, Math.min(255, 255 - (percentage * 2.55)));
    const green = Math.max(0, Math.min(255, percentage * 2.55));
    const startColor = `rgb(${Math.round(red + 50)}, ${Math.round(green)}, 30)`;
    const endColor = `rgb(${Math.round(red)}, ${Math.round(green + 30)}, 40)`;
    return `linear-gradient(135deg, ${startColor} 0%, ${endColor} 100%)`;
  }

  function updatePIRSection(data) {
    document.getElementById('pir-total-docs').textContent = data.total;
    document.getElementById('pir-completion-percent').textContent = data.completionPercent + '%';
    document.getElementById('pir-progress-bar').style.width = data.completionPercent + '%';
    document.getElementById('pir-ready-count').textContent = data.ready;
    document.getElementById('pir-pending-count').textContent = data.pending;
    document.getElementById('pir-outdated-count').textContent = data.outdated;
    
    // Update progress bar with red-to-green gradient based on percentage
    const progressBar = document.getElementById('pir-progress-bar');
    progressBar.style.background = getProgressGradient(data.completionPercent);
  }

  function updateTrainingSection(data) {
    document.getElementById('training-staff-count').textContent = data.totalStaff;
    document.getElementById('training-compliance-percent').textContent = data.compliancePercent + '%';
    document.getElementById('training-progress-bar').style.width = data.compliancePercent + '%';
    document.getElementById('training-up-to-date').textContent = data.upToDate;
    document.getElementById('training-expiring-soon').textContent = data.expiringSoon;
    document.getElementById('training-expired').textContent = data.expired;

    // Update progress bar color
    const progressBar = document.getElementById('training-progress-bar');
    if(data.complianceLevel === 'excellent') {
      progressBar.style.background = '#28a745';
    } else if(data.complianceLevel === 'good') {
      progressBar.style.background = '#ffc107';
    } else {
      progressBar.style.background = '#dc3545';
    }
  }

  function updateSafetySection(data) {
    document.getElementById('safety-checks-percent').textContent = data.compliancePercent + '%';
    document.getElementById('safety-checks-bar').style.width = data.compliancePercent + '%';
    document.getElementById('safety-completed').textContent = data.completed;
    document.getElementById('safety-required').textContent = data.totalRequired;
    document.getElementById('safety-passed').textContent = data.passed;
    document.getElementById('safety-failed').textContent = data.failed;

    // Update progress bar color
    const progressBar = document.getElementById('safety-checks-bar');
    if(data.complianceLevel === 'excellent') {
      progressBar.style.background = '#28a745';
    } else if(data.complianceLevel === 'good') {
      progressBar.style.background = '#ffc107';
    } else {
      progressBar.style.background = '#dc3545';
    }
  }

  function updateComplaintsSection(data) {
    document.getElementById('complaints-active').textContent = data.active;
    document.getElementById('complaints-investigating').textContent = data.investigating;
    document.getElementById('complaints-resolved').textContent = data.resolved;
    document.getElementById('complaints-response-time').textContent = data.responseTimeCompliance;
  }

  function updateCQCStandardsCards(pir, training, safety, complaints) {
    // Staffing card
    document.getElementById('staffing-score').textContent = training.compliancePercent + '%';
    document.getElementById('staffing-details').textContent = `${training.upToDate}/${training.totalStaff} staff with current training`;
    document.getElementById('staffing-standard-score').textContent = training.compliancePercent + '%';
    document.getElementById('staffing-standard-detail').textContent = 
      training.complianceLevel === 'excellent' ? 'All training up to date' :
      training.complianceLevel === 'good' ? 'Most training current' : 'Training compliance needs attention';

    // Safety card  
    document.getElementById('safety-score').textContent = safety.compliancePercent + '%';
    document.getElementById('safety-details').textContent = `${safety.completed}/${safety.totalRequired} safety checks completed`;
    document.getElementById('safety-standard-score').textContent = safety.compliancePercent + '%';
    document.getElementById('safety-standard-detail').textContent =
      safety.complianceLevel === 'excellent' ? 'All safety requirements met' :
      safety.complianceLevel === 'good' ? 'Safety compliance good' : 'Safety checks need attention';

    // Governance card (derived from overall performance)
    const governanceScore = Math.round((pir.completionPercent + complaints.responseTimePercent) / 2);
    document.getElementById('governance-score').textContent = governanceScore + '%';
    document.getElementById('governance-details').textContent = `PIR ${pir.completionPercent}%, Complaints handled well`;
    document.getElementById('governance-standard-score').textContent = governanceScore + '%';
    document.getElementById('governance-standard-detail').textContent = 
      governanceScore >= 90 ? 'Excellent governance systems' :
      governanceScore >= 70 ? 'Good governance in place' : 'Governance needs improvement';

    // Person-centred care (placeholder - could be derived from patient feedback surveys)
    document.getElementById('person-centred-score').textContent = '85%';
    document.getElementById('person-centred-detail').textContent = 'Patient feedback surveys positive, care plans reviewed';
  }

  function updatePriorityActions(pir, training, safety, complaints) {
    const actions = [];
    
    if(pir.completionPercent < 80) {
      actions.push(`📋 Complete ${pir.pending + pir.outdated} PIR documents`);
    }
    if(training.expired > 0) {
      actions.push(`🎓 Urgent: ${training.expired} staff have expired training`);
    }
    if(training.expiringSoon > 0) {
      actions.push(`⏰ ${training.expiringSoon} training certificates expire within 30 days`);
    }
    if(safety.compliancePercent < 85) {
      actions.push(`🛡️ Complete ${safety.totalRequired - safety.completed} overdue safety checks`);
    }
    if(safety.failed > 0) {
      actions.push(`❌ Address ${safety.failed} failed safety checks`);
    }
    if(complaints.active > 5) {
      actions.push(`📞 ${complaints.active} open complaints need attention`);
    }
    if(complaints.responseTimePercent < 80) {
      actions.push(`⏱️ Improve complaint response times (currently ${complaints.responseTimePercent}%)`);
    }

    const actionsEl = document.getElementById('priority-actions');
    if(actions.length === 0) {
      actionsEl.innerHTML = '🎉 <strong>All priority areas are compliant!</strong> Your practice is CQC ready.';
      actionsEl.parentElement.style.background = 'rgba(40, 167, 69, 0.1)';
      actionsEl.parentElement.style.borderColor = '#28a745';
      actionsEl.style.color = '#155724';
    } else {
      actionsEl.innerHTML = actions.map(action => `• ${action}`).join('<br>');
    }
  }

  function showCQCPlaceholderData() {
    // Show demonstration data when no site context
    console.log('📊 Showing CQC placeholder data for demonstration');
    
    const placeholderData = {
      pir: { total: 25, ready: 18, pending: 5, outdated: 2, completionPercent: 72, complianceLevel: 'good' },
      training: { totalStaff: 12, upToDate: 9, expiringSoon: 2, expired: 1, compliancePercent: 75, complianceLevel: 'good' },
      safety: { totalRequired: 20, completed: 17, passed: 16, failed: 1, compliancePercent: 85, complianceLevel: 'good' },
      complaints: { active: 2, investigating: 1, resolved: 8, total: 11, responseTimePercent: 91, responseTimeCompliance: '✅ Excellent', complianceLevel: 'excellent' }
    };

    const overallScore = calculateOverallReadiness(placeholderData.pir, placeholderData.training, placeholderData.safety, placeholderData.complaints);
    updateOverallReadiness(overallScore);
    updatePIRSection(placeholderData.pir);
    updateTrainingSection(placeholderData.training);
    updateSafetySection(placeholderData.safety);
    updateComplaintsSection(placeholderData.complaints);
    updateCQCStandardsCards(placeholderData.pir, placeholderData.training, placeholderData.safety, placeholderData.complaints);
    updatePriorityActions(placeholderData.pir, placeholderData.training, placeholderData.safety, placeholderData.complaints);
    
    // Add placeholder indicator
    document.getElementById('standards-last-updated').textContent = 'Placeholder data for demonstration';
  }

  function showCQCErrorState(error) {
    console.error('Showing CQC error state:', error);
    document.getElementById('overall-readiness-score').textContent = 'Error';
    document.getElementById('readiness-status-text').textContent = '❌ Unable to load compliance data';
    document.getElementById('priority-actions').innerHTML = '⚠️ <strong>Data loading error:</strong> Please check your connection and try refreshing.';
  }

  // Utility functions for CQC dashboard actions
  function generateCQCReport() {
    alert('🔄 CQC Readiness Report generation will be implemented. This would compile all compliance data into a comprehensive PDF report suitable for CQC inspections.');
  }

  function refreshCQCData() {
    console.log('🔄 Refreshing CQC data...');
    loadCQCDashboard();
  }

  function exportCQCChecklist() {
    alert('📝 CQC Inspection Checklist export will be implemented. This would generate a checklist of all items inspectors typically review.');
  }

  // Replace the old loadCQCReadiness function
  async function loadCQCReadiness(){
    // This function is now deprecated - use loadCQCDashboard() instead
    return loadCQCDashboard();
  }

  async function loadItems(){
    const tb = document.getElementById("items-tbody");
    let q = supabase.from("v_items_admin").select("*").eq("site_id", ctx.site_id);

    if(itemsQuery){
      const qi = `%${itemsQuery}%`;
      q = q.or([
        `item_id.ilike.${qi}`,
        `item_name.ilike.${qi}`,
        `room_name.ilike.${qi}`,
        `default_check_type_name.ilike.${qi}`,
        // fallbacks for raw items table fields
        `room.ilike.${qi}`,
        `default_check_type.ilike.${qi}`
      ].join(','));
    }

    const col = itemsSort.col || "item_name";
    const ascending = (itemsSort.dir !== "desc");
    q = q.order(col, { ascending });

    const { data, error } = await q;
    if(error){ tb.innerHTML = `<tr><td colspan="5" class="muted">${error.message}</td></tr>`; return; }
    if(!data?.length){ tb.innerHTML = `<tr><td colspan="5" class="muted">No items yet.</td></tr>`; return; }

    ["item_id","item_name","room_name","default_check_type_name","active"].forEach(k=>{
      const el = document.getElementById(`sort-${k}`);
      if(!el) return;
      if(k === col){ el.textContent = ascending ? "▲" : "▼"; }
      else { el.textContent = ""; }
    });

    tb.innerHTML = data.map(r => `<tr data-id="${r.id}">
      <td>${esc(r.item_id)}</td>
      <td>${esc(r.item_name)}</td>
      <td>${esc((r.room_name ?? r.room) || "—")}</td>
      <td>${esc((r.default_check_type_name ?? r.default_check_type) || "—")}</td>
      <td>${r.active ? "Yes" : "No"}</td>
    </tr>`).join("");
  }
async function loadRooms(){
  const tb = document.getElementById("rooms-tbody");
  const { data, error } = await supabase.from("rooms").select("id,name,occupied_by").eq("site_id", ctx.site_id).order("name");
  if(error){ tb.innerHTML = `<tr><td colspan="2" class="muted">${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = `<tr><td colspan="2" class="muted">No rooms yet.</td></tr>`; return; }
  const ownerIds = [...new Set((data||[]).map(r=>r.occupied_by).filter(Boolean))];
  let owners = {};
  if(ownerIds.length){
    // Use smart lookup: detect whether IDs look like UUIDs (auth user_id) vs numeric kiosk_users.id
    const looksLikeUUID = v => typeof v === 'string' && v.indexOf('-') > -1;
    let staff = [];
    if (ownerIds.length === 1) {
      const single = ownerIds[0];
      if (looksLikeUUID(single)) {
        const res = await supabase.from('kiosk_users').select('id,full_name,user_id').eq('user_id', single);
        staff = (res && res.data) || [];
      } else {
        const res = await supabase.from('kiosk_users').select('id,full_name').eq('id', single);
        staff = (res && res.data) || [];
      }
    } else {
      const uuids = ownerIds.filter(looksLikeUUID);
      const nums = ownerIds.filter(i => !looksLikeUUID(i));
      if (uuids.length) {
        try{ const r = await supabase.from('kiosk_users').select('id,full_name,user_id').in('user_id', uuids); if(r && r.data) staff.push(...r.data); }catch(_e){}
      }
      if (nums.length) {
        try{ const r = await supabase.from('kiosk_users').select('id,full_name').in('id', nums); if(r && r.data) staff.push(...r.data); }catch(_e){}
      }
    }
    (staff||[]).forEach(s => { owners[s.id] = s.full_name; });
  }
  tb.innerHTML = data.map(r=>`<tr data-id="${r.id}"><td>${esc(r.name)}</td><td>${esc(owners[r.occupied_by] || "—")}</td></tr>`).join("");
}
async function loadComplaints(){
  const tb = document.getElementById("complaints-tbody");
  try{ debugLog && debugLog('loadComplaints() start', { site_id: ctx.site_id }); }catch(e){}

  try{
    const res = await supabase
      .from("complaints")
      .select("id, datetime, patient_initials, category, original_complaint, response, lessons_learned, status, priority, share_with_team, created_by, resolved_at")
      .eq("site_id", ctx.site_id)
      .order("datetime", { ascending: false })
      .limit(1000);

    const { data, error } = res;
    if(error){
      debugLog && debugLog('loadComplaints() supabase error', error);
      tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">${escapeHtml(error.message || 'Error')}</td></tr>`; 
      return;
    }

    if(!data || data.length === 0){
      debugLog && debugLog('No complaints for site_id, attempting fallback');
      try{
        const fb = await supabase.from('complaints')
          .select('id, datetime, patient_initials, category, original_complaint, response, lessons_learned, status, priority, share_with_team, created_by, resolved_at')
          .in('site_id', [1,2])
          .order('datetime', { ascending: false })
          .limit(500);

        if(fb && !fb.error && fb.data && fb.data.length){
          debugLog && debugLog('Fallback returned rows', { count: fb.data.length });
          renderComplaintsTable(tb, fb.data);
          return;
        } else {
          debugLog && debugLog('Fallback found no rows', { error: fb.error });
          tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">No complaints yet.</td></tr>`;
          return;
        }
      }catch(fbErr){
        console.error('Fallback query error', fbErr);
        tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">No complaints yet.</td></tr>`;
        return;
      }
    }

    renderComplaintsTable(tb, data);
    return;
  }catch(err){
    console.error('loadComplaints failed', err);
    tb.innerHTML = `<tr><td colspan=\"10\" class=\"muted\">Error loading complaints</td></tr>`;
    return;
  }
}

function renderComplaintsTable(tb, data){
  const creatorIds = [...new Set((data||[]).map(r=>r.created_by).filter(Boolean))];
  let creators = {};
  (async function(){
    if(creatorIds.length){
      try{
        const looksLikeUUID = v => typeof v === 'string' && v.indexOf('-') > -1;
        let staff = [];
        if (creatorIds.length === 1) {
          const single = creatorIds[0];
          if (looksLikeUUID(single)) {
            try {
              const r = await supabase.from('kiosk_users').select('id,full_name,user_id').eq('user_id', single);
              staff = (r && r.data) || [];
            } catch (e) {
              // Fallback: user_id column might not exist, try querying by id instead
              debugLog('kiosk_users user_id query failed, trying id fallback:', e.message);
              const r = await supabase.from('kiosk_users').select('id,full_name').eq('id', single);
              staff = (r && r.data) || [];
            }
          } else {
            const r = await supabase.from('kiosk_users').select('id,full_name').eq('id', single);
            staff = (r && r.data) || [];
          }
        } else {
          const uuids = creatorIds.filter(looksLikeUUID);
          const nums = creatorIds.filter(i => !looksLikeUUID(i));
          if (uuids.length) {
            try{ 
              const r = await supabase.from('kiosk_users').select('id,full_name,user_id').in('user_id', uuids); 
              if(r && r.data) staff.push(...r.data); 
            } catch(e) {
              // Fallback: user_id column might not exist, skip UUID lookups
              debugLog('kiosk_users user_id batch query failed, skipping UUID lookups:', e.message);
            }
          }
          if (nums.length) {
            try{ const r = await supabase.from('kiosk_users').select('id,full_name').in('id', nums); if(r && r.data) staff.push(...r.data); }catch(_e){}
          }
        }
        (staff||[]).forEach(s=>{ creators[s.id] = s.full_name; });
      }catch(e){ /* ignore */ }
    }
    const fmtDate = (d) => d ? new Date(d).toLocaleString() : "—";
    const truncate = (t,n=120) => t ? (t.length>n ? esc(t.slice(0,n))+'…' : esc(t)) : '';
  const rows = data.map(r => `\n    <tr data-id="${r.id}">\n      <td style=\"width:36px\"><input type=\"checkbox\" class=\"cmp-select\" data-id=\"${r.id}\"></td>\n      <td>${fmtDate(r.datetime)}</td>\n      <td>${esc(r.patient_initials)}</td>\n      <td>${esc(r.category)}</td>\n      <td title=\"${esc(r.original_complaint || '')}\">${truncate(r.original_complaint, 80)}</td>\n      <td title=\"${esc(r.response || '')}\">${truncate(r.response, 80)}</td>\n      <td title=\"${esc(r.lessons_learned || '')}\">${truncate(r.lessons_learned, 80)}</td>\n      <td>${esc(r.status || '')}</td>\n      <td>${r.share_with_team ? 'Yes' : 'No'}</td>\n      <td>${esc(creators[r.created_by] || (r.created_by ? r.created_by : '—'))}</td>\n      <td>${fmtDate(r.resolved_at)}</td>\n      <td class=\"cmp-actions\" style=\"white-space:nowrap\"><button class=\"pir-action-btn\" data-action=\"view\" data-id=\"${r.id}\">View</button> <button class=\"pir-action-btn\" data-action=\"attach\" data-id=\"${r.id}\">Attach</button></td>\n    </tr>\n  `).join("");
    tb.innerHTML = rows;
  })();
}

async function loadCheckTypes(){
  const tb = document.getElementById("ct-tbody");
  const { data, error } = await supabase.from("check_types").select("id, name, active").eq("site_id", ctx.site_id).order("name");
  if(error){ tb.innerHTML = `<tr><td colspan="2" class="muted">${error.message}</td></tr>`; return; }
  if(!data?.length){ tb.innerHTML = `<tr><td colspan="2" class="muted">No check types yet.</td></tr>`; return; }
  tb.innerHTML = data.map(r => `<tr data-id="${r.id}"><td>${esc(r.name)}</td><td>${r.active ? "Yes" : "No"}</td></tr>`).join("");
}
let schedulesData = []; // Store original data for filtering

async function loadSchedules(){
  const tb = document.getElementById("sched-tbody");
  const { data: scheds, error } = await supabase
    .from("item_allowed_types")
    .select("id,item_id,check_type_id,frequency,required,scheduled_day")
    .eq("site_id", ctx.site_id)
    .order("id", { ascending: true });
  if(error){ tb.innerHTML = `<tr><td colspan="6" class="muted">${error.message}</td></tr>`; return; }
  if(!scheds?.length){ 
    tb.innerHTML = `<tr><td colspan="6" class="muted">No schedules yet.</td></tr>`; 
    schedulesData = [];
    return; 
  }

  const itemIds = [...new Set(scheds.map(s=>s.item_id).filter(Boolean))];
  const ctIds   = [...new Set(scheds.map(s=>s.check_type_id).filter(Boolean))];

  const [itemsRes, ctsRes] = await Promise.all([
  itemIds.length ? (itemIds.length === 1 ? supabase.from("items").select("id,item_name,room_id").eq("id", itemIds[0]) : supabase.from("items").select("id,item_name,room_id").in("id", itemIds)) : Promise.resolve({ data: [] }),
  ctIds.length   ? (ctIds.length === 1 ? supabase.from("check_types").select("id,name").eq("id", ctIds[0]) : supabase.from("check_types").select("id,name").in("id", ctIds))   : Promise.resolve({ data: [] }),
  ]);

  const itemsById = {};
  const itemRoomIdByItemId = {};
  (itemsRes.data||[]).forEach(r=> { itemsById[r.id] = r.item_name; itemRoomIdByItemId[r.id] = r.room_id; });

  // Fetch room names for referenced room_ids
  const roomIds = [...new Set(Object.values(itemRoomIdByItemId).filter(Boolean))];
  let roomsById = {};
  if (roomIds.length){
  const roomsRes = roomIds.length === 1 ? await supabase.from("rooms").select("id,name").eq("id", roomIds[0]) : await supabase.from("rooms").select("id,name").in("id", roomIds);
  const rooms = (roomsRes && roomsRes.data) || [];
  (rooms||[]).forEach(r=> { roomsById[r.id] = r.name; });
  }

  const ctsById   = {}; (ctsRes.data||[]).forEach(r=> ctsById[r.id]   = r.name);

  // Store enhanced data for filtering
  schedulesData = scheds.map(s => ({
    ...s,
    itemName: itemsById[s.item_id] || '—',
    roomName: roomsById[itemRoomIdByItemId[s.item_id]] || '—',
    checkTypeName: ctsById[s.check_type_id] || '—',
    frequencyText: intervalToText(s.frequency),
    roomId: itemRoomIdByItemId[s.item_id]
  }));

  // Populate filter dropdowns
  populateSchedulesFilters();
  
  // Display filtered results
  applySchedulesFilters();
}

function populateSchedulesFilters() {
  // Get unique values from data
  const rooms = [...new Set(schedulesData.map(s => ({ id: s.roomId, name: s.roomName })).filter(r => r.name && r.name !== '—'))];
  const checks = [...new Set(schedulesData.map(s => ({ id: s.check_type_id, name: s.checkTypeName })).filter(c => c.name && c.name !== '—'))];
  const frequencies = [...new Set(schedulesData.map(s => s.frequencyText).filter(f => f && f !== '—'))];

  // Populate room filter
  const roomFilter = document.getElementById('schedules-filter-room');
  if (roomFilter) {
    roomFilter.innerHTML = '<option value="">All Rooms</option>' + 
      rooms.map(r => `<option value="${r.id}">${esc(r.name)}</option>`).join('');
  }

  // Populate check type filter
  const checkFilter = document.getElementById('schedules-filter-check');
  if (checkFilter) {
    checkFilter.innerHTML = '<option value="">All Check Types</option>' + 
      checks.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');
  }

  // Populate frequency filter
  const frequencyFilter = document.getElementById('schedules-filter-frequency');
  if (frequencyFilter) {
    frequencyFilter.innerHTML = '<option value="">All Frequencies</option>' + 
      frequencies.map(f => `<option value="${esc(f)}">${esc(f)}</option>`).join('');
  }
}

function applySchedulesFilters() {
  const roomFilter = document.getElementById('schedules-filter-room')?.value || '';
  const checkFilter = document.getElementById('schedules-filter-check')?.value || '';
  const frequencyFilter = document.getElementById('schedules-filter-frequency')?.value || '';
  const requiredFilter = document.getElementById('schedules-filter-required')?.value || '';
  const searchTerm = document.getElementById('schedules-search')?.value.toLowerCase() || '';

  let filtered = schedulesData.filter(s => {
    // Room filter
    if (roomFilter && s.roomId != roomFilter) return false;
    
    // Check type filter
    if (checkFilter && s.check_type_id != checkFilter) return false;
    
    // Frequency filter
    if (frequencyFilter && s.frequencyText !== frequencyFilter) return false;
    
    // Required filter
    if (requiredFilter !== '') {
      const isRequired = requiredFilter === 'true';
      if (s.required !== isRequired) return false;
    }
    
    // Search term
    if (searchTerm) {
      const searchableText = [
        s.itemName,
        s.roomName,
        s.checkTypeName,
        s.frequencyText,
        s.scheduled_day || ''
      ].join(' ').toLowerCase();
      
      if (!searchableText.includes(searchTerm)) return false;
    }
    
    return true;
  });

  // Render filtered results
  const tb = document.getElementById("sched-tbody");
  if (!filtered.length) {
    tb.innerHTML = `<tr><td colspan="6" class="muted">No schedules match the current filters.</td></tr>`;
    return;
  }

  tb.innerHTML = filtered.map(s=>`
    <tr data-id="${s.id}">
      <td>${esc(s.itemName)}</td>
      <td>${esc(s.roomName)}</td>
      <td>${esc(s.checkTypeName)}</td>
      <td>${esc(s.frequencyText)}</td>
      <td>${esc(s.scheduled_day || "—")}</td>
      <td>${s.required ? 'Yes' : 'No'}</td>
    </tr>`).join("");
}

  async function loadStaff(){
    const tb = document.getElementById("staff-tbody");
    // Get staff with their manager's name
    const { data, error } = await supabase
      .from("kiosk_users")
      .select(`
        id, 
        full_name, 
        role, 
        active,
        reports_to:reports_to_id(full_name)
      `)
      .eq("site_id", ctx.site_id)
      .order("full_name");

    if(error){ tb.innerHTML = `<tr><td colspan="4" class="muted">${error.message}</td></tr>`; return; }
    if(!data?.length){ tb.innerHTML = `<tr><td colspan="4" class="muted">No staff yet.</td></tr>`; return; }
    
    tb.innerHTML = data.map(r=>`<tr data-id="${r.id}">
      <td>${esc(r.full_name)}</td>
      <td>${esc(r.role)}</td>
      <td>${esc(r.reports_to?.full_name || '—')}</td>
      <td>${r.active ? "Yes" : "No"}</td>
    </tr>`).join("");
  }

  async function loadSubmissions(){
    const tb = document.getElementById("subs-tbody");
    const { data, error } = await supabase.from("submissions")
      .select("id, submitted_at, staff_name, comment").eq("site_id", ctx.site_id).order("submitted_at", { ascending:false }).limit(25);
    if(error){ tb.innerHTML = `<tr><td colspan="4" class="muted">${error.message}</td></tr>`; return; }
    if(!data?.length){ tb.innerHTML = `<tr><td colspan="4" class="muted">No submissions yet.</td></tr>`; return; }
    // counts:
    const ids = data.map(d=>d.id);
    let counts = {};
    if(ids.length){
      const rowsRes = ids.length === 1 ? await supabase.from("submission_rows").select("submission_id").eq("submission_id", ids[0]) : await supabase.from("submission_rows").select("submission_id").in("submission_id", ids);
      const rows = (rowsRes && rowsRes.data) || [];
      rows.forEach(r => { counts[r.submission_id] = (counts[r.submission_id]||0)+1; });
    }
    tb.innerHTML = data.map(r=>`<tr data-id="${r.id}">
      <td>${fmtDate(r.submitted_at)}</td><td>${esc(r.staff_name||"—")}</td>
      <td>${counts[r.id] ?? 0}</td><td>${esc(r.comment||"")}</td>
    </tr>`).join("");
  }
  function startOfWeek(d){
    const x = new Date(d);
    const day = x.getDay(); // 0=Sun
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day);
    return x;
  }
  // Day helpers (support 3-letter codes saved to DB)
  const DAY_CODES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const DAY_FULL  = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  function dayToIndex(s){
    if(!s) return -1;
    const key = String(s).slice(0,3);
    return DAY_CODES.indexOf(key);
  }
  function indexToCode(i){ return DAY_CODES[i] || ''; }
  function indexToFull(i){ return DAY_FULL[i] || ''; }

  async function loadWeekCalendar(){
    if(!ctx.site_id) return;
    const now = new Date();
    const wkStart = startOfWeek(now);
    const wkEnd = new Date(wkStart); wkEnd.setDate(wkStart.getDate() + 7);

    const fmt = (d)=> d.toLocaleDateString(undefined,{ weekday:'short', day: 'numeric', month: 'short' });
    for(let i=0;i<7;i++){
      const dd = new Date(wkStart); dd.setDate(wkStart.getDate() + i);
      const el = document.getElementById(`d${i}-label`);
      if(el) el.textContent = fmt(dd);
    }
    
    // Fetch all required schedules and filter them by day
    const { data: scheds } = await supabase.from("item_allowed_types").select("id,required,scheduled_day").eq("site_id", ctx.site_id).eq("required", true);

    const requiredCountsPerDay = Array(7).fill(0);
    (scheds || []).forEach(s => {
      if(s.scheduled_day) {
        const dayIndex = dayToIndex(s.scheduled_day);
        if(dayIndex !== -1) {
          requiredCountsPerDay[dayIndex]++;
        }
      }
    });

    // Submissions in the week
    const { data: subs, error } = await supabase
      .from("submissions")
      .select("id, submitted_at")
      .eq("site_id", ctx.site_id)
      .gte("submitted_at", wkStart.toISOString())
      .lt("submitted_at", wkEnd.toISOString());

    if(error){ /* handle error silently for now */ return; }

    const ids = (subs||[]).map(s=>s.id);
    let rows = [];
    if(ids.length){
      const srRes = ids.length === 1 ? await supabase.from("submission_rows").select("submission_id").eq("submission_id", ids[0]) : await supabase.from("submission_rows").select("submission_id").in("submission_id", ids);
      rows = (srRes && srRes.data) || [];
    }

    const countsBySubmission = {};
    rows.forEach(r => { countsBySubmission[r.submission_id] = (countsBySubmission[r.submission_id]||0)+1; });

    const donePerDay = Array(7).fill(0);
    (subs||[]).forEach(s=>{
      const when = new Date(s.submitted_at);
      const idx = Math.floor((when - wkStart)/86400000);
      if(idx>=0 && idx<7){
        donePerDay[idx] += (countsBySubmission[s.id] || 0);
      }
    });

    for(let i=0;i<7;i++){
      const dayDate = new Date(wkStart); dayDate.setDate(wkStart.getDate() + i);
      const isPast = dayDate < new Date(new Date().setHours(0,0,0,0));
      
      const requiredCountForDay = requiredCountsPerDay[i];
      const done = donePerDay[i] || 0;
      const missed = isPast ? Math.max(requiredCountForDay - done, 0) : 0;
      
      const totalScheduled = isPast ? requiredCountForDay : requiredCountForDay; // Required is always the same for a day, past or future.
      
      // Get elements
      const doneValEl = document.getElementById(`d${i}-done-val`);
      const reqValEl = document.getElementById(`d${i}-req-val`);
      const barEl = document.getElementById(`d${i}-bar`);
      const doneTextEl = document.getElementById(`d${i}-done`);
      const missedTextEl = document.getElementById(`d${i}-missed`);
      const reqTextEl = document.getElementById(`d${i}-req`);

      if(doneValEl) doneValEl.textContent = done;
      if(reqValEl) reqValEl.textContent = totalScheduled;
      if(doneTextEl) doneTextEl.textContent = done;
      if(missedTextEl) missedTextEl.textContent = missed;
      if(reqTextEl) reqTextEl.textContent = totalScheduled;

      if(barEl) {
        let percentage = 0;
        if (totalScheduled > 0) {
          percentage = (done / totalScheduled) * 100;
        }
        barEl.style.width = `${Math.min(percentage, 100)}%`;
        barEl.classList.toggle('danger', isPast && missed > 0);
      }
    }
  }

  // --- MONTHLY CALENDAR ---
  async function cacheRequiredSchedules() {
    if (!ctx.site_id) return;
    console.log("DEBUG: cacheRequiredSchedules() called for site_id:", ctx.site_id);
    const { data, error } = await supabase
      .from("item_allowed_types")
      .select(`
        id,
        scheduled_day,
        frequency,
        items (id, item_name),
        check_types (id, name)
      `)
      .eq("site_id", ctx.site_id)
      .eq("required", true)
  // NOTE: do NOT filter out null scheduled_day here — some schedules are interval-based
  // (e.g. daily / every N days / monthly by interval) and rely on frequency alone.
  ;
    if (error) { console.error("Failed to cache schedules:", error); return; }
    requiredSchedulesCache = data || [];
    console.log("DEBUG: Cached", requiredSchedulesCache.length, "required schedules:", requiredSchedulesCache);
  }

  async function loadAndRenderCalendar() {
    if (!ctx.site_id) return;
    
    // Ensure schedules are cached before rendering
    await cacheRequiredSchedules();
    console.log("DEBUG: loadAndRenderCalendar() - requiredSchedulesCache has", requiredSchedulesCache.length, "items");
    
    // Hide all views initially
    document.getElementById('cal-grid').style.display = 'none';
    document.getElementById('cal-weekdays').style.display = 'none';
    document.getElementById('cal-compliance-view').style.display = 'none';

    // Route to the correct rendering function based on the active tab
    switch (currentCalendarView) {
        case 'daily':
            renderComplianceView('daily');
            break;
        case 'weekly':
            renderComplianceView('weekly');
            break;
        case 'monthly':
            renderComplianceView('monthly');
            break;
        case 'scheduled':
        default:
            // This is the original logic for the grid view
            document.getElementById('cal-weekdays').style.display = 'grid';
            document.getElementById('cal-grid').style.display = 'grid';
            const calGrid = document.getElementById("cal-grid");
            calGrid.innerHTML = `<div style="grid-column: span 7; text-align:center; padding: 40px;" class="muted">Loading calendar...</div>`;

            calendarDate.setDate(1); // Go to the 1st of the month
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            document.getElementById('cal-month-year').textContent = calendarDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
            
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);
            monthEnd.setHours(23,59,59,999);

            const { data: completed, error: compErr } = await supabase
              .from('submission_rows')
              .select(`item_pk, check_type_id, submissions!inner ( submitted_at )`)
              .gte('submissions.submitted_at', monthStart.toISOString())
              .lte('submissions.submitted_at', monthEnd.toISOString())
              .eq('site_id', ctx.site_id);

            if(compErr) { calGrid.innerHTML = `<div class="muted">${compErr.message}</div>`; return; }

            const dailyData = new Map();
            (completed || []).forEach(c => {
                const dayKey = new Date(c.submissions.submitted_at).toISOString().slice(0, 10);
                if (!dailyData.has(dayKey)) {
                    dailyData.set(dayKey, new Set());
                }
                dailyData.get(dayKey).add(`${c.item_pk}-${c.check_type_id}`);
            });
            renderCalendar(dailyData);
            break;
    }
  }

  async function renderComplianceView(period) {
    document.getElementById('cal-weekdays').style.display = 'none';
    document.getElementById('cal-grid').style.display = 'none';
    const complianceContainer = document.getElementById('cal-compliance-view');
    complianceContainer.style.display = 'block';
    complianceContainer.innerHTML = `<div class="muted" style="text-align:center; padding: 40px;">Loading ${period} compliance...</div>`;

    const now = new Date();
    now.setHours(23, 59, 59, 999); // End of today

    let startDate = new Date(calendarDate);
    let endDate = new Date(calendarDate);

    // Define date range based on the selected period
    if (period === 'daily') {
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
    } else if (period === 'weekly') {
        const dayOfWeek = startDate.getDay(); // Sunday - 0, Monday - 1
        startDate.setDate(startDate.getDate() - dayOfWeek);
        startDate.setHours(0, 0, 0, 0);
        endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);
        endDate.setHours(23, 59, 59, 999);
    } else { // monthly
        startDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 1);
        endDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 0);
        endDate.setHours(23, 59, 59, 999);
    }
    
    // Update header to show the current period
    const titleFormat = { month: 'long', year: 'numeric' };
    if (period === 'daily') titleFormat.day = 'numeric';
    document.getElementById('cal-month-year').textContent = startDate.toLocaleDateString(undefined, titleFormat);


    const { data, error } = await supabase
      .from('v_item_check_status')
      .select('item_name, room_name, check_type, next_due_at, last_done_at')
      .eq('site_id', ctx.site_id)
      .eq('required', true)
      .gte('next_due_at', startDate.toISOString())
      .lte('next_due_at', endDate.toISOString())
      .order('next_due_at', { ascending: true });

    if (error) {
        complianceContainer.innerHTML = `<div class="error">${error.message}</div>`;
        return;
    }

    if (!data || data.length === 0) {
        complianceContainer.innerHTML = `<div class="muted" style="text-align:center; padding: 40px;">No checks were due in this period.</div>`;
        return;
    }

    let html = `<div class="table-wrap" style="max-height: 65vh;"><table>
        <thead><tr><th>Due Date</th><th>Item</th><th>Check</th><th>Room</th><th>Status</th></tr></thead>
        <tbody>`;

    data.forEach(item => {
        const dueDate = new Date(item.next_due_at);
        const lastDone = item.last_done_at ? new Date(item.last_done_at) : null;
        
        let statusChip = '<span class="chip">Pending</span>';
        if (dueDate < now) {
            statusChip = '<span class="chip danger">Missed</span>';
        }

        html += `<tr>
            <td>${dueDate.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric', month: 'short' })}</td>
            <td>${esc(item.item_name)}</td>
            <td>${esc(item.check_type)}</td>
            <td>${esc(item.room_name || '—')}</td>
            <td>${statusChip}</td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
    complianceContainer.innerHTML = html;
  }
  
  function renderCalendar(dailyData) {
    const grid = document.getElementById('cal-grid');
    const today = new Date();
    const todayKey = today.toISOString().slice(0, 10);
    today.setHours(0,0,0,0);
    
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); // 0=Sun, 1=Mon...

    let html = '';

    // Pad start of month
    for (let i = 0; i < startDayOfWeek; i++) {
        html += `<div class="cal-cell other-month"></div>`;
    }

    // Fill days of month
    for (let day = 1; day <= daysInMonth; day++) {
        const thisDate = new Date(year, month, day);
        const dayKey = thisDate.toISOString().slice(0, 10);
        const isToday = (dayKey === todayKey);
        const isPast = thisDate < today;
        const currentDayCode = indexToCode(thisDate.getDay());

        const completedTasks = dailyData.get(dayKey) || new Set();
        
        let dayTasksHtml = '';
        const tasksForThisDay = requiredSchedulesCache.filter(task => {
          // Require scheduled_day to match the current weekday code; if absent, this task
          // doesn't render on the grid (these are interval-based schedules handled elsewhere).
          if (!task.scheduled_day) return false;
          if (task.scheduled_day !== currentDayCode) return false;
          const freq = String(task.frequency || '').toLowerCase();

          // Monthly: show only on the last <weekday> of the month
          if (freq.includes('mon')) {
            const nextWeek = new Date(thisDate);
            nextWeek.setDate(thisDate.getDate() + 7);
            return nextWeek.getMonth() !== thisDate.getMonth();
          }

          // Daily or Weekly: show every week on the selected day
          if (freq.includes('day') || freq.includes('week')) {
            return true;
          }

          // Otherwise: do not show on the grid
          return false;
        });
        
        console.log(`DEBUG: Day ${day} (${currentDayCode}) - found ${tasksForThisDay.length} tasks from ${requiredSchedulesCache.length} total schedules`);

        tasksForThisDay.forEach(task => {
          const taskKey = `${task.items.id}-${task.check_types.id}`;
          const isDone = completedTasks.has(taskKey);
          let statusClass = 'scheduled';
          if (isDone) {
            statusClass = 'done';
          } else if (isPast) {
            statusClass = 'missed';
          }

          // Status character shown inside the coloured dot
          let statusChar = 'S';
          if (isDone) statusChar = '✓';
          else if (isPast) statusChar = '✗';

          const taskName = `${task.items.item_name} / ${task.check_types.name}`;
          const freq = String(task.frequency || '').toLowerCase();
          let freqBadge = '';
          if (freq.includes('day')) {
            freqBadge = `<span class="freq-badge" title="Daily">D</span>`;
          } else if (freq.includes('week')) {
            freqBadge = `<span class="freq-badge" title="Weekly">W</span>`;
          } else if (freq.includes('mon') || freq.includes('month')) {
            freqBadge = `<span class="freq-badge" title="Monthly">M</span>`;
          }

          dayTasksHtml += `<div class="cal-task"
              data-item-id="${task.items.id}"
              data-ct-id="${task.check_types.id}"
              data-date="${dayKey}"
              title="${esc(taskName)}">
              <div class="cal-task-status ${statusClass}">${statusChar}</div>
              <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-left:6px;">${esc(taskName)}</span>
              ${freqBadge}
            </div>`;
        });

        if (tasksForThisDay.length === 0) {
          dayTasksHtml += `<div class="muted" style="font-size:10px; text-align:center; padding-top:10px;">No required checks</div>`;
        }
        
        html += `<div class="cal-cell is-clickable" data-date="${dayKey}">
            <div class="cal-day-num ${isToday ? 'is-today' : ''}">${day}</div>
            <div class="cal-tasks">${dayTasksHtml}</div>
            </div>`;
    }

    // Pad end of month
    const totalCells = startDayOfWeek + daysInMonth;
    const remaining = (7 - (totalCells % 7)) % 7;
    for (let i = 0; i < remaining; i++) {
        html += `<div class="cal-cell other-month"></div>`;
    }

    grid.innerHTML = html;
  }

  // Day modal: show details when user clicks a calendar cell
  async function showDayModal(dateKey) {
    const modal = document.getElementById('day-modal');
    if(!modal) return;
    const titleEl = modal.querySelector('.day-modal-title');
    const bodyEl = modal.querySelector('.day-modal-body');
    titleEl.textContent = `Details for ${new Date(dateKey).toLocaleDateString(undefined, { weekday: 'long', day:'numeric', month:'long', year:'numeric' })}`;
    bodyEl.innerHTML = `<div class="muted">Loading…</div>`;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');

    const thisDate = new Date(dateKey);
    const start = new Date(thisDate); start.setHours(0,0,0,0);
    const end = new Date(thisDate); end.setHours(23,59,59,999);

    // Fetch any submission rows on that exact date, including item and check names when available
    const { data: rows, error: rowsErr } = await supabase
      .from('submission_rows')
      .select('item_pk, check_type_id, items(id,item_name), check_types(id,name), submissions!inner(submitted_at, staff_name)')
      .gte('submissions.submitted_at', start.toISOString())
      .lte('submissions.submitted_at', end.toISOString())
      .eq('site_id', ctx.site_id);

    const completedMap = {}; // key -> { staff, time, item_name, check_name }
    if(!rowsErr && rows && rows.length){
      rows.forEach(r => {
        const k = `${r.item_pk}-${r.check_type_id}`;
        completedMap[k] = {
          staff: r.submissions?.staff_name || '—',
          time: r.submissions?.submitted_at || null,
          item_name: r.items?.item_name || null,
          check_name: r.check_types?.name || null
        };
      });
    }

    // Determine scheduled tasks for this date (reuse same rules as calendar render)
    const currentDayCode = indexToCode(thisDate.getDay());
    const currentDayOfMonth = thisDate.getDate();
    const tasksForThisDay = requiredSchedulesCache.filter(task => {
      if (!task.scheduled_day) return false;
      if (task.scheduled_day !== currentDayCode) return false;
      const freq = String(task.frequency || '').toLowerCase();
      if (freq.includes('mon')) {
        const nextWeek = new Date(thisDate);
        nextWeek.setDate(thisDate.getDate() + 7);
        return nextWeek.getMonth() !== thisDate.getMonth();
      }
      if (freq.includes('day') || freq.includes('week')) return true;
      return false;
    });

    // Combine scheduled + completed keys so we show any recorded checks even if not scheduled
    const keys = new Set();
    tasksForThisDay.forEach(t => keys.add(`${t.items.id}-${t.check_types.id}`));
    Object.keys(completedMap).forEach(k => keys.add(k));

    if (keys.size === 0) {
      bodyEl.innerHTML = `<div class="muted">No checks recorded or scheduled for this day.</div>`;
      return;
    }

    let tableHtml = `<div class="table-wrap"><table class="day-modal-table"><thead><tr><th>Check</th><th>Status</th><th>By</th><th>Time</th></tr></thead><tbody>`;
    for (const k of keys) {
      const [itemIdStr, ctIdStr] = k.split('-');
      const itemId = Number(itemIdStr);
      const ctId = Number(ctIdStr);
      const scheduled = tasksForThisDay.find(t => Number(t.items.id) === itemId && Number(t.check_types.id) === ctId);
      const completed = completedMap[k];

      const itemName = scheduled ? scheduled.items.item_name : (completed && completed.item_name) || '—';
      const checkName = scheduled ? scheduled.check_types.name : (completed && completed.check_name) || '—';

      let statusHtml = '<span class="chip">Scheduled</span>';
      let by = '—';
      let timeText = '—';

      if (completed) {
        statusHtml = '<span class="chip success">Done</span>';
        by = esc(completed.staff || '—');
        timeText = completed.time ? new Date(completed.time).toLocaleTimeString() : '—';
      } else if (isPast) {
        // If scheduled but in the past -> mark missed
        const todayStart = new Date(); todayStart.setHours(0,0,0,0);
        if (thisDate < todayStart) {
          statusHtml = '<span class="chip danger">Missed</span>';
        }
      }

      tableHtml += `<tr>
        <td>${esc(itemName)} / ${esc(checkName)}</td>
        <td>${statusHtml}</td>
        <td>${by}</td>
        <td>${timeText}</td>
      </tr>`;
    }
    tableHtml += `</tbody></table></div>`;
    bodyEl.innerHTML = tableHtml;
  }

  async function showTaskModal(dateKey, itemId, ctId){
    const modal   = document.getElementById('day-modal');
    if(!modal) return;
    const titleEl = modal.querySelector('.day-modal-title');
    const bodyEl  = modal.querySelector('.day-modal-body');
    titleEl.textContent = 'Details';
    bodyEl.innerHTML = '<div class="muted">Loading…</div>';
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');

    const thisDate = new Date(dateKey);
    const start = new Date(thisDate); start.setHours(0,0,0,0);
    const end   = new Date(thisDate); end.setHours(23,59,59,999);

    // Completed row (if any) on that date
    const { data: rows } = await supabase
      .from('submission_rows')
      .select('submissions!inner(staff_name,submitted_at), items(item_name), check_types(name)')
      .eq('site_id', ctx.site_id)
      .eq('item_pk', itemId)
      .eq('check_type_id', ctId)
      .gte('submissions.submitted_at', start.toISOString())
      .lte('submissions.submitted_at', end.toISOString());

    const done = rows?.[0] ?? null;
    const itemName  = done?.items?.item_name  ?? (await supabase.from('items').select('item_name').eq('id', itemId).maybeSingle()).data?.item_name ?? '—';
    const checkName = done?.check_types?.name ?? (await supabase.from('check_types').select('name').eq('id', ctId).maybeSingle()).data?.name ?? '—';

    const now = new Date();
    const isPast = thisDate < new Date(now.setHours(0,0,0,0));

    let statusChip = '<span class="chip">Scheduled</span>';
    let who = '—', whenTime = '—';
    if(done){
      statusChip = '<span class="chip success">Done</span>';
      who  = esc(done.submissions?.staff_name || '—');
      whenTime = done.submissions?.submitted_at ? new Date(done.submissions.submitted_at).toLocaleTimeString() : '—';
    }else if(isPast){
      statusChip = '<span class="chip danger">Missed</span>';
    }

    bodyEl.innerHTML = `
      <table class="day-modal-table"><tbody>
        <tr><th>Item</th>  <td>${esc(itemName)}</td></tr>
        <tr><th>Check</th> <td>${esc(checkName)}</td></tr>
        <tr><th>Status</th><td>${statusChip}</td></tr>
        <tr><th>Who</th>   <td>${who}</td></tr>
        <tr><th>When</th>  <td>${whenTime}</td></tr>
      </tbody></table>`;
  }

  function hideDayModal(){
    const modal = document.getElementById('day-modal');
    if(!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    // Suppress any click that might "fall through" after closing
    suppressGridClickUntil = Date.now() + 300; // 300ms debounce
  }

  // Dedicated close‑button handler (defensive – runs only once)
  (() => {
    const btn = document.getElementById('day-modal-close');
    if(btn && !btn.dataset.bound){
      btn.dataset.bound = "1";
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        hideDayModal();
      }, { once:false });
    }
  })();

  // Click handler on calendar grid to show task modal or day modal
  document.getElementById('cal-grid').addEventListener('click', async (e) => {
    // Ignore ghost clicks right after closing a modal
    if (Date.now() < suppressGridClickUntil) {
      e.stopPropagation();
      e.preventDefault();
      return;
    }
    // 1️⃣ task clicked?
    const taskEl = e.target.closest('.cal-task');
    if(taskEl){
      e.stopPropagation();          // ← new, prevents underlying handlers
      const dateKey = taskEl.getAttribute('data-date');
      const itemId  = taskEl.getAttribute('data-item-id');
      const ctId    = taskEl.getAttribute('data-ct-id');
      if(dateKey && itemId && ctId){
        await showTaskModal(dateKey, itemId, ctId);
        return;
      }
    }
    // 2️⃣ fallback: whole‑day cell
    const cell = e.target.closest('.cal-cell.is-clickable');
    if(!cell) return;
    const dateKeyCell = cell.getAttribute('data-date');
    if(!dateKeyCell) return;
    await showDayModal(dateKeyCell);
  });

  // Close modal when clicking the X or outside the card
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('day-modal');
    if(!modal || !modal.classList.contains('show')) return;
    if (e.target.id === 'day-modal-close') {
      e.stopPropagation();
      e.preventDefault();
      hideDayModal();
      return;
    }
    if (e.target === modal) {
      e.stopPropagation();
      e.preventDefault();
      hideDayModal();
    }
  });

  // --- ROLES MANAGEMENT ---
  async function loadRoles() {
    const tbody = document.getElementById('roles-tbody');
    if (!tbody) return;
    // Roles are now fixed to Admin and Staff. Render static list.
    const fixed = [{role:'admin'},{role:'staff'}];
    tbody.innerHTML = fixed.map(r => 
      '<tr data-role="' + esc(r.role) + '">' +
        '<td>' + esc(r.role) + '</td>' +
        '<td>—</td>' +
      '</tr>'
    ).join('');
  }

  function initRolesManagement() {
    const btnManageRoles = document.getElementById('btn-manage-roles');
    const rolesModal = document.getElementById('roles-modal');
    const addRoleForm = document.getElementById('add-role-form');
    const closeBtn = rolesModal?.querySelector('.modal-close');

  // Role management UI removed; do not bind manage roles button.

    // Close on clicking outside
    if (rolesModal) {
      rolesModal.addEventListener('click', (e) => {
        if (e.target === rolesModal) {
          rolesModal.classList.remove('show');
        }
      });
    }

    // Close on clicking X button
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        rolesModal?.classList.remove('show');
      });
    }

    if (addRoleForm) {
      addRoleForm.addEventListener('submit', (e) => {
        e.preventDefault();
        // Disabled: roles are fixed to Admin and Staff. Use Manage Roles removed.
        alert('Role management is disabled. Roles are fixed to Admin and Staff.');
      });
    }
  }

  // Helpers
  function esc(s){ return (s ?? "").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function fmtDate(iso){
    if(!iso) return "—";
    const d = new Date(iso);
    return d.toLocaleString();
  }
  // small validator for UUID-like strings
  function isUUID(v){ if(!v) return false; try{ return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(String(v)); }catch(e){return false;} }
    function fmtDateShort(iso) {
      if (!iso) return "—";
      try {
        // Add a time component to avoid timezone-related date shifts for display
        return new Date(iso + 'T12:00:00Z').toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (e) {
        return "—";
      }
    }
  function intervalToText(i){
    if(!i) return "—";
    if (typeof i !== 'string') return JSON.stringify(i);
    const parts = [];
    if (i.includes('year')) parts.push(i.match(/(\d+)\s*year/)[1] + ' years');
    if (i.includes('mon')) parts.push(i.match(/(\d+)\s*mon/)[1] + ' months');
    if (i.includes('day')) parts.push(i.match(/(\d+)\s*day/)[1] + ' days');
    return parts.join(', ') || i;
  }
  
  // --- PRE-INSPECTION (PIR) LOGIC ---
    
    const PIR_DEFINITIONS = window.PIR_DEFINITIONS_DATA;

    async function seedInitialPIRDocs() {
        if (!ctx.site_id) return;
        const { count, error } = await supabase.from('pir_documents').select('*', { count: 'exact', head: true }).eq('site_id', ctx.site_id);
        if (error || count > 0) return;

        const docsToInsert = PIR_DEFINITIONS.map(def => {
            const isDataOnly = !def.item_type.includes('file');
            return {
                site_id: ctx.site_id,
                category: def.category,
                title: def.title,
                item_type: def.item_type,
                status: isDataOnly ? 'Not Started' : 'Not Attached',
                data: {}
            };
        });
        await supabase.from('pir_documents').insert(docsToInsert);
    }

    function formatItemType(itemType) {
        if (itemType.includes('file') && (itemType.includes('text') || itemType.includes('questions'))) return 'Text & File';
        if (itemType.includes('file')) return 'File Attachment';
        if (itemType.includes('text') || itemType.includes('questions')) return 'Text / Q&A';
        if (itemType.includes('table')) return 'Data Table';
        if (itemType.includes('number')) return 'Data';
        return 'Information';
    }

    // Enhanced PIR state management
    let pirState = {
        filter: 'all',
        sortBy: 'category',
        sortDir: 'asc',
        selectedItems: new Set(),
        draftTexts: new Map()
    };

    async function loadAndRenderPIR() {
        const container = document.getElementById('pir-docs-container');
  container.innerHTML = `<div class="muted" style="text-align: center; padding: 20px;">Loading document list...</div>`;
        if (!ctx.site_id) return;

        const { data, error } = await supabase.from('pir_documents').select('*').eq('site_id', ctx.site_id).order('id', { ascending: true });
        if (error) { container.innerHTML = `<div class="error">${error.message}</div>`; return; }
        pirDocsCache = data || [];

        // Initialize draft texts from localStorage
        pirState.draftTexts = new Map(JSON.parse(localStorage.getItem('pir_draft_texts') || '[]'));

        renderPIRTable();
        updatePIRProgress();
        updatePIRTOC();
        initPIRFilters();
        initPIREventHandlers();
    }

    function renderPIRTable() {
        const container = document.getElementById('pir-docs-container');
        const filteredDocs = getFilteredPIRDocs();
        const sortedDocs = getSortedPIRDocs(filteredDocs);
        const groupedByCat = groupPIRDocsByCategory(sortedDocs);
        
        let html = '';
        for (const [category, docs] of Object.entries(groupedByCat)) {
            html += `
                <div class="doc-category" id="category-${sanitizeId(category)}">
                    <div class="doc-category-title">${esc(category)}</div>
                    ${docs.map(doc => renderPIRDocRow(doc)).join('')}
                </div>
            `;
        }
        
        container.innerHTML = html || '<div class="muted" style="padding: 20px; text-align: center;">No documents match the current filter.</div>';
    }

    // Helper to safely read notes whether column exists or stored in JSON
    function getPirDocNotes(doc) {
        return (doc && (doc.notes ?? (doc.data && doc.data.notes))) || '';
    }

    function renderPIRDocRow(doc) {
        const status = getPIRDocStatus(doc);
        const statusClass = getPIRStatusClass(status);
        const hasDraft = pirState.draftTexts.has(doc.id);
        const hasTemplates = getPIRDocDefinition(doc)?.allow_templates;
        const _notes = getPirDocNotes(doc);
        const hasNotes = _notes && _notes.trim().length > 0;
        const isSelected = pirState.selectedItems.has(doc.id);
        
        return `
            <div class="pir-table-row ${isSelected ? 'selected' : ''}" data-id="${doc.id}">
                <div class="pir-row-main">
                    <div>
                        <input type="checkbox" class="pir-row-checkbox" data-id="${doc.id}" ${isSelected ? 'checked' : ''}>
                    </div>
                    <div>
                        <div class="pir-row-title">${esc(doc.title)}</div>
                        <div class="pir-row-type">${formatItemType(doc.item_type)}</div>
                        ${hasDraft ? '<div class="pir-draft-indicator"><span class="pir-draft-badge">draft</span> Text saved</div>' : ''}
                        ${hasNotes ? '<div class="pir-notes-indicator"><span class="pir-notes-badge">📝</span> Has notes</div>' : ''}
                    </div>
                    <div>
                        <span class="pir-status-chip ${statusClass}">${status}</span>
                    </div>
                    <div>
                        <span class="muted">${fmtDateShort(doc.last_updated)}</span>
                    </div>
                    ${hasTemplates ? `<button class="pir-template-btn" data-id="${doc.id}">Templates</button>` : '<div></div>'}
                    <div class="pir-row-actions">
                        <button class="pir-action-btn" data-action="upload" data-id="${doc.id}">Upload</button>
                        ${doc.file_path ? `<button class="pir-action-btn" data-action="view" data-id="${doc.id}">View</button>` : ''}
                        <button class="pir-action-btn ${hasNotes ? 'has-notes' : ''}" data-action="notes" data-id="${doc.id}">Notes</button>
                    </div>
                </div>
            </div>
        `;
    }

    function getPIRDocStatus(doc) {
        const definition = getPIRDocDefinition(doc);
        const now = new Date();
        
        if (!doc.file_path && !doc.data?.text_content && !pirState.draftTexts.has(doc.id)) {
            return definition?.item_type?.includes('file') ? 'Not Attached' : 'Not Started';
        }
        
        if (doc.status === 'Ready') {
            // Check if outdated (policy older than X months)
            if (doc.last_updated) {
                const lastUpdate = new Date(doc.last_updated);
                const monthsOld = (now - lastUpdate) / (1000 * 60 * 60 * 24 * 30);
                if (monthsOld > 24) return 'Outdated'; // 24 months threshold
            }
            return 'Ready';
        }
        
        if (doc.file_path && doc.status !== 'Ready') {
            return 'Uploaded';
        }
        
        if (pirState.draftTexts.has(doc.id) && !doc.file_path) {
            return 'Draft';
        }
        
        return doc.status || 'Not Started';
    }

    function getPIRStatusClass(status) {
        const statusMap = {
            'Not Attached': 'not-attached',
            'Not Started': 'not-attached', 
            'Uploaded': 'uploaded',
            'Ready': 'ready',
            'Outdated': 'outdated',
            'Draft': 'draft',
            'Expired': 'expired',
            'Expiring Soon': 'expiring-soon'
        };
        return statusMap[status] || 'not-attached';
    }

    function getPIRDocDefinition(doc) {
        return window.PIR_DEFINITIONS_DATA?.find(d => d.title === doc.title);
    }

    function getFilteredPIRDocs() {
        return pirDocsCache.filter(doc => {
            const status = getPIRDocStatus(doc);
            const hasDraft = pirState.draftTexts.has(doc.id);
            
            switch (pirState.filter) {
                case 'not-attached': return status === 'Not Attached' || status === 'Not Started';
                case 'ready': return status === 'Ready';
                case 'expiring-soon': 
                    if (status === 'Ready' && doc.last_updated) {
                        const lastUpdate = new Date(doc.last_updated);
                        const monthsOld = (new Date() - lastUpdate) / (1000 * 60 * 60 * 24 * 30);
                        return monthsOld > 18 && monthsOld <= 24; // 18-24 months
                    }
                    return false;
                case 'outdated': return status === 'Outdated';
                case 'draft': return hasDraft;
                case 'all':
                default: return true;
            }
        });
    }

    function getSortedPIRDocs(docs) {
        return [...docs].sort((a, b) => {
            let aVal, bVal;
            
            switch (pirState.sortBy) {
                case 'status':
                    aVal = getPIRDocStatus(a);
                    bVal = getPIRDocStatus(b);
                    break;
                case 'last-updated':
                    aVal = a.last_updated || '1900-01-01';
                    bVal = b.last_updated || '1900-01-01';
                    break;
                case 'category':
                default:
                    aVal = a.category;
                    bVal = b.category;
                    break;
            }
            
            const comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            return pirState.sortDir === 'asc' ? comparison : -comparison;
        });
    }

    function groupPIRDocsByCategory(docs) {
        const grouped = docs.reduce((acc, doc) => {
            (acc[doc.category] = acc[doc.category] || []).push(doc);
            return acc;
        }, {});
        
        // Maintain category order from PIR_DEFINITIONS_DATA
        const categoryOrder = [...new Set(window.PIR_DEFINITIONS_DATA?.map(d => d.category) || [])];
        const orderedGrouped = {};
        
        for (const category of categoryOrder) {
            if (grouped[category]) {
                orderedGrouped[category] = grouped[category];
            }
        }
        
        return orderedGrouped;
    }

    function updatePIRProgress() {
        const total = pirDocsCache.length;
        const ready = pirDocsCache.filter(d => getPIRDocStatus(d) === 'Ready').length;
        const percentage = total > 0 ? Math.round((ready / total) * 100) : 0;
        
        // Update classic bar and text
        document.getElementById('pir-progress-bar').style.width = `${percentage}%`;
        document.getElementById('pir-progress-text').textContent = `${ready} / ${total} Ready (${percentage}%)`;

        // Scale percentage to a 0..66 metric (user requested scale)
        const scaled = Math.round((percentage / 100) * 66);
        const largeEl = document.getElementById('pir-progress-large');
        if (largeEl) largeEl.textContent = `${scaled} / 66`;
        
        // Add motivational color and pulse effect based on progress
        const progressBar = document.getElementById('pir-progress-bar');
        const container = document.querySelector('.progress-bar-container');
        if (progressBar && container) {
          // Update progress bar with red-to-green gradient
          progressBar.style.background = getProgressGradient(percentage);
          
          // Remove existing progress classes
          container.classList.remove('progress-low', 'progress-medium', 'progress-high', 'progress-complete');
          
          // Add appropriate progress class for styling (keeping for animations)
          if (percentage >= 100) {
            container.classList.add('progress-complete');
          } else if (percentage >= 75) {
            container.classList.add('progress-high');
          } else if (percentage >= 40) {
            container.classList.add('progress-medium');
          } else {
            container.classList.add('progress-low');
          }
          
          // Add interactive tooltip
          const tooltip = getMotivationalMessage(percentage, ready, total);
          container.setAttribute('title', tooltip);
        }

        // Compute per-email-package readiness based on PIR_DEFINITIONS_DATA categories
        // Categories are expected like 'EMAIL 1: ...' — group by email number 1..9
        const emailGroups = {};
        (window.PIR_DEFINITIONS_DATA || []).forEach(def => {
          const m = (def.category||'').match(/EMAIL\s*(\d+)/i);
          const num = m ? parseInt(m[1],10) : null;
          if (!num) return;
          emailGroups[num] = emailGroups[num] || { defs: [], ready: 0, total: 0 };
          emailGroups[num].defs.push(def);
        });

        // Count documents in cache that map to each email group
        Object.keys(emailGroups).forEach(k => {
          const num = parseInt(k,10);
          const defs = emailGroups[num].defs.map(d => d.title);
          const docs = pirDocsCache.filter(doc => defs.includes(doc.title));
          const totalDocs = docs.length;
          const readyDocs = docs.filter(d => getPIRDocStatus(d) === 'Ready').length;
          emailGroups[num].total = totalDocs;
          emailGroups[num].ready = readyDocs;
        });

        // Render compact email circles layout
        const circles = document.getElementById('email-status-circles');
        if (circles) {
          const items = [];
          for (let i=1;i<=9;i++) {
            const g = emailGroups[i] || { total:0, ready:0 };
            let cls = 'email-circle-item missing';
            let circleClass = 'email-circle missing';
            if (g.total > 0 && g.ready === g.total) {
              cls = 'email-circle-item ready';
              circleClass = 'email-circle ready';
            } else if (g.ready > 0) {
              cls = 'email-circle-item partial';
              circleClass = 'email-circle partial';
            }

            const countText = g.total > 0 ? `${g.ready}/${g.total}` : `–`;
            const tooltip = `Email Package ${i}: ${countText}`;

            items.push(`<div class="${cls}" title="${tooltip}" data-package="${i}">
              <div class="${circleClass}" data-package="${i}">${i}</div>
              <div class="email-circle-count">${countText}</div>
            </div>`);
          }
          circles.innerHTML = items.join('');
          // Attach popover handlers
          setTimeout(()=>{
            document.querySelectorAll('#email-status-circles [data-package]').forEach(el=>{
              el.addEventListener('click', (ev)=>{
                ev.stopPropagation();
                const pkg = parseInt(el.getAttribute('data-package'));
                toggleEmailPopover(el, pkg);
              });
            });
            // Close popovers when clicking outside
            document.addEventListener('click', ()=>{
              document.querySelectorAll('.email-popover').forEach(p=>p.remove());
            });
          }, 30);
        }
    }
    
    function getMotivationalMessage(percentage, ready, total) {
      const remaining = total - ready;
      if (percentage >= 100) {
        return `🎉 Outstanding! All ${total} items are ready for CQC inspection. You're fully compliant!`;
      } else if (percentage >= 90) {
        return `🌟 Excellent progress! Only ${remaining} items remaining. You're almost inspection-ready!`;
      } else if (percentage >= 75) {
        return `💪 Great work! ${remaining} items to go. You're in the final stretch!`;
      } else if (percentage >= 50) {
        return `📈 Good momentum! ${remaining} items remaining. Keep pushing forward!`;
      } else if (percentage >= 25) {
        return `🚀 Getting started! ${remaining} items to complete. Every step counts!`;
      } else {
        return `📋 Ready to begin? ${remaining} items need attention. Let's get inspection-ready!`;
      }
    }    function updatePIRTOC() {
        const tocContainer = document.getElementById('pir-toc-items');
        const categories = [...new Set(pirDocsCache.map(d => d.category))];
        
        tocContainer.innerHTML = categories.map(category => 
            `<a href="#category-${sanitizeId(category)}" class="pir-toc-item" data-category="${category}">
                ${esc(category.replace(/^EMAIL \d+:\s*/, ''))}
            </a>`
        ).join('');
    }

    function initPIRFilters() {
        document.querySelectorAll('.pir-filter-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('.pir-filter-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                pirState.filter = pill.dataset.filter;
                renderPIRTable();
                updateBulkBar();
            });
        });
    }

    function initPIREventHandlers() {
        const container = document.getElementById('pir-docs-container');
        
        // Row checkboxes
        container.addEventListener('change', (e) => {
            if (e.target.classList.contains('pir-row-checkbox')) {
                const docId = parseInt(e.target.dataset.id);
                if (e.target.checked) {
                    pirState.selectedItems.add(docId);
                } else {
                    pirState.selectedItems.delete(docId);
                }
                updateBulkBar();
                updateRowSelection();
            }
        });
        
        // Action buttons
        container.addEventListener('click', async (e) => {
            const action = e.target.dataset.action;
            const docId = parseInt(e.target.dataset.id);
            
            if (action && docId) {
                e.preventDefault();
                e.stopPropagation();
                
                const doc = pirDocsCache.find(d => d.id === docId);
                if (!doc) return;
                
                switch (action) {
                    case 'upload':
                        openPIRManageModal(doc);
                        break;
                    case 'view':
                        await previewPIRDocument(doc);
                        break;
                    case 'notes':
                        openPIRNotesModal(doc);
                        break;
                }
            }
        });
        
        // Template buttons
        container.addEventListener('click', (e) => {
            if (e.target.classList.contains('pir-template-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const docId = parseInt(e.target.dataset.id);
                const doc = pirDocsCache.find(d => d.id === docId);
                if (doc) showPIRTemplates(doc);
            }
        });
        
        // TOC navigation
        document.querySelectorAll('.pir-toc-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const categoryId = item.getAttribute('href');
                document.querySelector(categoryId)?.scrollIntoView({ behavior: 'smooth' });
                
                // Update active TOC item
                document.querySelectorAll('.pir-toc-item').forEach(t => t.classList.remove('active'));
                item.classList.add('active');
            });
        });
        
        // Bulk operation buttons
        document.getElementById('pir-bulk-upload')?.addEventListener('click', () => openBulkUploadModal());
        document.getElementById('pir-export')?.addEventListener('click', () => exportPIRChecklist());
        document.getElementById('pir-bulk-upload-selected')?.addEventListener('click', () => bulkUploadSelected());
        document.getElementById('pir-export-selected')?.addEventListener('click', () => exportSelectedPIR());
        document.getElementById('pir-clear-selection')?.addEventListener('click', () => clearPIRSelection());
        
        // Interactive progress bar click
        document.querySelector('.progress-bar-container')?.addEventListener('click', () => {
          const container = document.querySelector('.progress-bar-container');
          if (container) {
            container.style.animation = 'none';
            container.offsetHeight; // Force reflow
            container.style.animation = 'progressClick 0.3s ease-out';
            
            // Show encouraging message
            const total = pirDocsCache.length;
            const ready = pirDocsCache.filter(d => getPIRDocStatus(d) === 'Ready').length;
            const percentage = total > 0 ? Math.round((ready / total) * 100) : 0;
            const message = getMotivationalMessage(percentage, ready, total);
            
            // Create temporary toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
              position: fixed; top: 20px; right: 20px; 
              background: var(--panel-bg); color: var(--white);
              padding: 12px 20px; border-radius: 8px; 
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              z-index: 1000; max-width: 320px;
              border: 1px solid var(--border-color);
              animation: slideInRight 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
              toast.style.animation = 'slideOutRight 0.3s ease-in forwards';
              setTimeout(() => toast.remove(), 300);
            }, 3000);
          }
        });
    }

    // Helper: toggle an email package popover
    function toggleEmailPopover(targetEl, packageNum) {
      // Remove any existing popovers first
      document.querySelectorAll('.email-popover').forEach(p=>p.remove());

      // Build popover content
      const pop = buildEmailPopover(packageNum);
      if (!pop) return;

      // Initially place off-screen so we can measure
      pop.style.position = 'absolute';
      pop.style.top = '0px';
      pop.style.left = '0px';
      document.body.appendChild(pop);

      // Position popover below the clicked element, centered
      const rect = targetEl.getBoundingClientRect();
      const popRect = pop.getBoundingClientRect();
      let left = window.scrollX + rect.left + (rect.width / 2) - (popRect.width / 2);
      left = Math.max(8, Math.min(left, window.scrollX + window.innerWidth - popRect.width - 8));
      let top = window.scrollY + rect.bottom + 10;
      // If not enough space below, show above
      if (top + popRect.height > window.scrollY + window.innerHeight) {
        top = window.scrollY + rect.top - popRect.height - 10;
      }
      pop.style.left = left + 'px';
      pop.style.top = top + 'px';
    }

    function buildEmailPopover(packageNum) {
      const groupDefs = (window.PIR_DEFINITIONS_DATA || []).filter(d => {
        const m = (d.category||'').match(/EMAIL\s*(\d+)/i);
        return m && parseInt(m[1],10) === packageNum;
      });

      const defs = groupDefs.map(d=>d.title);
      const docs = pirDocsCache.filter(doc => defs.includes(doc.title));
      const total = docs.length;
      const ready = docs.filter(d => getPIRDocStatus(d) === 'Ready').length;
      const pending = total - ready;

      const pop = document.createElement('div');
      pop.className = 'email-popover';

      const header = document.createElement('h4');
      header.textContent = `Email ${packageNum} summary`;
      pop.appendChild(header);

      const stats = document.createElement('div');
      stats.className = 'pop-row';
      stats.innerHTML = `<div style="font-weight:600">Status</div><div style="font-weight:700">${ready}/${total} ready</div>`;
      pop.appendChild(stats);

      if (total > 0) {
        const readyList = docs.filter(d=>getPIRDocStatus(d) === 'Ready');
        const missList = docs.filter(d=>getPIRDocStatus(d) !== 'Ready');

        if (readyList.length) {
          const rHead = document.createElement('div');
          rHead.style.marginTop = '8px';
          rHead.style.fontSize = '13px';
          rHead.style.fontWeight = '600';
          rHead.textContent = 'Ready samples';
          pop.appendChild(rHead);
          const listWrap = document.createElement('div');
          listWrap.className = 'pop-list';
          readyList.forEach(d=>{
            const row = document.createElement('div');
            row.className = 'pop-row';
            row.innerHTML = `<div style="flex:1">${esc(d.title)}</div><div class="pill ready">Ready</div>`;
            listWrap.appendChild(row);
          });
          pop.appendChild(listWrap);
        }

        if (missList.length) {
          const mHead = document.createElement('div');
          mHead.style.marginTop = '8px';
          mHead.style.fontSize = '13px';
          mHead.style.fontWeight = '600';
          mHead.textContent = 'Needs attention';
          pop.appendChild(mHead);
          const listWrap2 = document.createElement('div');
          listWrap2.className = 'pop-list';
          missList.forEach(d=>{
            const row = document.createElement('div');
            row.className = 'pop-row';
            row.innerHTML = `<div style="flex:1">${esc(d.title)}</div><div class="pill missing">Not ready</div>`;
            listWrap2.appendChild(row);
          });
          pop.appendChild(listWrap2);
        }
      } else {
        const p = document.createElement('div');
        p.style.padding = '10px 0';
        p.textContent = 'No documents configured for this package.';
        pop.appendChild(p);
      }

      const actions = document.createElement('div');
      actions.className = 'pop-actions';
      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn';
      closeBtn.textContent = 'Close';
      closeBtn.addEventListener('click', ()=>document.querySelectorAll('.email-popover').forEach(p=>p.remove()));
      actions.appendChild(closeBtn);
      pop.appendChild(actions);

      return pop;
    }

    function updateBulkBar() {
        const bulkBar = document.getElementById('pir-bulk-bar');
        const count = pirState.selectedItems.size;
        
        if (count > 0) {
            bulkBar.classList.add('visible');
            document.getElementById('pir-selected-count').textContent = count;
        } else {
            bulkBar.classList.remove('visible');
        }
    }

    function updateRowSelection() {
        document.querySelectorAll('.pir-table-row').forEach(row => {
            const docId = parseInt(row.dataset.id);
            if (pirState.selectedItems.has(docId)) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });
    }

    function clearPIRSelection() {
        pirState.selectedItems.clear();
        updateBulkBar();
        updateRowSelection();
        document.querySelectorAll('.pir-row-checkbox').forEach(cb => cb.checked = false);
    }

    async function previewPIRDocument(doc) {
        if (!doc.file_path) {
            showEnhancedPIRModal(doc, null, null);
            return;
        }
        
        // Show loading modal first
        showEnhancedPIRModal(doc, null, null, true);
        
        try {
            // Get file info from storage
            const { data: urlData } = supabase.storage.from('pir_attachments').getPublicUrl(doc.file_path);
            const fileUrl = urlData.publicUrl;
            
            // Fetch file metadata
            const { data: fileData, error: downloadError } = await supabase.storage
                .from('pir_attachments')
                .download(doc.file_path);
            
            if (downloadError) {
                console.warn('Could not fetch file metadata:', downloadError);
                showEnhancedPIRModal(doc, fileUrl, null);
                return;
            }
            
            // Get file metadata
            const fileInfo = {
                name: doc.file_path.split('/').pop(),
                size: fileData.size,
                type: fileData.type || 'application/octet-stream',
                url: fileUrl,
                data: fileData
            };
            
            showEnhancedPIRModal(doc, fileUrl, fileInfo);
            
        } catch (err) {
            console.error('Preview error:', err);
            showEnhancedPIRModal(doc, null, null, false, err.message);
        }
    }

    async function showEnhancedPIRModal(doc, fileUrl, fileInfo, isLoading = false, errorMessage = null) {
        // Remove existing enhanced modal if present
        const existingModal = document.getElementById('enhanced-pir-modal');
        if (existingModal) existingModal.remove();
        
        const modal = document.createElement('div');
        modal.id = 'enhanced-pir-modal';
        modal.className = 'modal enhanced-pir-modal';
        modal.style.zIndex = '2000';
        
        // Get additional info
        const status = getPIRDocStatus(doc);
        const statusClass = getPIRStatusClass(status);
        const extension = fileInfo?.name ? fileInfo.name.toLowerCase().split('.').pop() : null;
        
        // Get uploader info if available
        let uploaderInfo = '';
        if (fileInfo && doc.file_path) {
            try {
                // Extract user ID from file path (format: site_id/doc_id/filename)
                const pathParts = doc.file_path.split('/');
                if (pathParts.length >= 2) {
                    // Query for the user who uploaded this file
                    const { data: profile } = await supabase
                        .from('profiles')
                        .select('full_name')
                        .eq('site_id', doc.site_id)
                        .single();
                    
                    if (profile) {
                        uploaderInfo = `<div class="enhanced-info-item">
                            <span class="info-label">Uploaded by:</span>
                            <span class="info-value">${esc(profile.full_name || 'Unknown')}</span>
                        </div>`;
                    }
                }
            } catch (e) {
                console.warn('Could not fetch uploader info:', e);
            }
        }
        
        const formatFileSize = (bytes) => {
            if (!bytes) return 'Unknown size';
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };
        
        const getFileIcon = (ext) => {
            switch(ext) {
                case 'pdf': return '📄';
                case 'doc':
                case 'docx': return '📝';
                case 'xls':
                case 'xlsx': return '📊';
                case 'ppt':
                case 'pptx': return '📋';
                case 'jpg':
                case 'jpeg':
                case 'png':
                case 'gif': return '🖼️';
                default: return '📎';
            }
        };
        
        let previewContent = '';
        let actionButtons = '';
        
        if (isLoading) {
            previewContent = `
                <div class="enhanced-preview-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading document preview...</p>
                </div>
            `;
        } else if (errorMessage) {
            previewContent = `
                <div class="enhanced-preview-error">
                    <div class="error-icon">⚠️</div>
                    <h4>Could not load preview</h4>
                    <p>${esc(errorMessage)}</p>
                </div>
            `;
        } else if (!fileUrl) {
            previewContent = `
                <div class="enhanced-preview-empty">
                    <div class="empty-icon">📄</div>
                    <h4>No file attached</h4>
                    <p>This document doesn't have any files attached yet.</p>
                    <button class="btn primary" onclick="openPIRManageModal(pirDocsCache.find(d => d.id === ${doc.id}))">
                        Upload File
                    </button>
                </div>
            `;
        } else {
            // Generate preview based on file type
            if (extension === 'pdf') {
                previewContent = `
                    <div class="enhanced-pdf-preview">
                        <iframe src="${fileUrl}#toolbar=1&navpanes=0&scrollbar=1" 
                                style="width: 100%; height: 500px; border: none; border-radius: 8px;"></iframe>
                    </div>
                `;
            } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) {
                previewContent = `
                    <div class="enhanced-image-preview">
                        <img src="${fileUrl}" 
                             style="max-width: 100%; max-height: 500px; object-fit: contain; border-radius: 8px;" 
                             alt="Document preview">
                    </div>
                `;
            } else {
                previewContent = `
                    <div class="enhanced-preview-unsupported">
                        <div class="file-icon">${getFileIcon(extension)}</div>
                        <h4>Preview not available</h4>
                        <p>Preview is not supported for ${extension?.toUpperCase()} files.</p>
                        <p class="muted">Click download to view the file in its native application.</p>
                    </div>
                `;
            }
            
            actionButtons = `
                <button class="btn secondary" onclick="downloadPIRFile('${doc.file_path}', '${fileInfo?.name || 'document'}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Download
                </button>
                ${extension === 'pdf' ? `
                <button class="btn secondary" onclick="window.open('${fileUrl}', '_blank')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                    Open in New Tab
                </button>
                ` : ''}
                <button class="btn primary" onclick="openPIRManageModal(pirDocsCache.find(d => d.id === ${doc.id}))">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Update File
                </button>
            `;
        }
        
        modal.innerHTML = `
            <div class="modal-content enhanced-pir-content">
                <div class="enhanced-pir-header">
                    <div class="header-main">
                        <h2>${esc(doc.title)}</h2>
                        <span class="pir-status-chip ${statusClass}">${status}</span>
                    </div>
                    <div class="header-meta">
                        <span class="category-badge">${esc(doc.category)}</span>
                        <span class="item-type-badge">${formatItemType(doc.item_type)}</span>
                    </div>
                </div>
                
                <div class="enhanced-pir-body">
                    <div class="enhanced-pir-sidebar">
                        <div class="enhanced-info-section">
                            <h4>Document Information</h4>
                            
                            ${fileInfo ? `
                            <div class="enhanced-info-item">
                                <span class="info-label">File Name:</span>
                                <span class="info-value">${esc(fileInfo.name)}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">File Size:</span>
                                <span class="info-value">${formatFileSize(fileInfo.size)}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">File Type:</span>
                                <span class="info-value">${extension?.toUpperCase() || 'Unknown'}</span>
                            </div>
                            ` : ''}
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">Status:</span>
                                <span class="info-value status-${statusClass}">${status}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">Last Updated:</span>
                                <span class="info-value">${doc.last_updated ? fmtDateShort(doc.last_updated) : 'Never'}</span>
                            </div>
                            
                            <div class="enhanced-info-item">
                                <span class="info-label">Created:</span>
                                <span class="info-value">${fmtDateShort(doc.created_at)}</span>
                            </div>
                            
                            ${uploaderInfo}
                        </div>
                        
                        <div class="enhanced-notes-section">
                            <h4>Notes</h4>
                            ${(getPirDocNotes(doc) && getPirDocNotes(doc).trim()) ? `
                                <div class="enhanced-notes-display">
                                    <div class="notes-content">${esc(getPirDocNotes(doc)).replace(/\n/g, '<br>')}</div>
                                    <button class="btn secondary small" onclick="openPIRNotesModal(pirDocsCache.find(d => d.id === ${doc.id}))">
                                        Edit Notes
                                    </button>
                                </div>
                            ` : `
                                <div class="enhanced-notes-empty">
                                    <p class="muted">No notes added yet</p>
                                    <button class="btn secondary small" onclick="openPIRNotesModal(pirDocsCache.find(d => d.id === ${doc.id}))">
                                        Add Notes
                                    </button>
                                </div>
                            `}
                        </div>
                        
                        ${!isLoading && !errorMessage ? `
                        <div class="enhanced-actions-section">
                            <h4>Actions</h4>
                            <div class="enhanced-action-buttons">
                                ${actionButtons}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="enhanced-pir-preview">
                        ${previewContent}
                    </div>
                </div>
                
                <div class="enhanced-pir-footer">
                    <button class="btn secondary modal-close" onclick="document.getElementById('enhanced-pir-modal').remove()">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.classList.add('show');
        
        // Close handlers
        modal.addEventListener('click', (e) => {
            if (e.target === modal || e.target.classList.contains('modal-close')) {
                modal.remove();
            }
        });
        
        // Escape key handler
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    async function downloadPIRFile(filePath, fileName) {
        try {
            const { data, error } = await supabase.storage.from('pir_attachments').download(filePath);
            if (error) {
                alert(`Download failed: ${error.message}`);
                return;
            }
            
            const url = URL.createObjectURL(data);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (err) {
            alert(`Download failed: ${err.message}`);
        }
    }

    function openBulkUploadModal() {
        // Implementation for bulk upload modal
        alert('Bulk upload functionality would be implemented here - allows mapping multiple files to PIR items by filename hints');
    }

    // PIR Management Modal Function
    function openPIRManageModal(doc) {
        if (!doc) {
            console.error('No document provided to openPIRManageModal');
            return;
        }
        // Use the existing CRUD system for PIR documents
        openCRUD('pir_documents', 'edit', doc);
    }

    async function exportPIRChecklist() {
        // Generate email zip export instead of CSV
        try {
            const zip = new JSZip();
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            
            // Group documents by email package (1-9)
            const emailGroups = {};
            (window.PIR_DEFINITIONS_DATA || []).forEach(def => {
                const match = (def.category || '').match(/EMAIL\s*(\d+)/i);
                const emailNum = match ? parseInt(match[1], 10) : null;
                if (emailNum && emailNum >= 1 && emailNum <= 9) {
                    if (!emailGroups[emailNum]) {
                        emailGroups[emailNum] = {
                            title: def.category.replace(/EMAIL\s*\d+:\s*/i, ''),
                            items: []
                        };
                    }
                    
                    // Find corresponding document in cache
                    const doc = pirDocsCache.find(d => 
                        d.title === def.title && d.category === def.category
                    );
                    
                    emailGroups[emailNum].items.push({
                        def: def,
                        doc: doc,
                        status: doc ? getPIRDocStatus(doc) : 'Missing',
                        hasFile: doc && doc.file_path,
                        blurb: def.email_blurb || `Please find attached: ${def.title}`
                    });
                }
            });
            
            // Generate individual email files and a master summary
            let masterSummary = `CQC Pre-Inspection Documentation Package\n`;
            masterSummary += `Generated: ${now.toLocaleDateString()} at ${now.toLocaleTimeString()}\n`;
            masterSummary += `\n=======================================================\n\n`;
            
            for (let emailNum = 1; emailNum <= 9; emailNum++) {
                const group = emailGroups[emailNum];
                if (!group) continue;
                
                // Create email folder
                const folderName = `Email_${emailNum}_${group.title.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                // Generate email content
                let emailContent = `Subject: CQC Pre-Inspection Documentation - ${group.title}\n\n`;
                emailContent += `Dear CQC Inspector,\n\n`;
                emailContent += `As requested for our upcoming inspection, please find attached the documentation for ${group.title.toLowerCase()}.\n\n`;
                
                const readyItems = group.items.filter(item => item.status === 'Ready');
                const pendingItems = group.items.filter(item => item.status !== 'Ready');
                
                if (readyItems.length > 0) {
                    emailContent += `ATTACHED DOCUMENTS:\n`;
                    readyItems.forEach(item => {
                        emailContent += `• ${item.def.title}\n`;
                        if (item.blurb) emailContent += `  ${item.blurb}\n`;
                    });
                    emailContent += `\n`;
                }
                
                if (pendingItems.length > 0) {
                    emailContent += `PENDING DOCUMENTATION (to be provided separately):\n`;
                    pendingItems.forEach(item => {
                        emailContent += `• ${item.def.title} (Status: ${item.status})\n`;
                    });
                    emailContent += `\n`;
                }
                
                emailContent += `If you require any additional information or clarification on these documents, please let us know.\n\n`;
                emailContent += `Best regards,\n`;
                emailContent += `[Your Name]\n`;
                emailContent += `[Practice Name]\n`;
                emailContent += `\nGenerated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}\n`;
                
                // Add email content to zip
                zip.file(`${folderName}/email_content.txt`, emailContent);
                
                // Create attachment list
                let attachmentList = `ATTACHMENT CHECKLIST for Email ${emailNum}\n`;
                attachmentList += `Category: ${group.title}\n`;
                attachmentList += `Generated: ${dateStr}\n\n`;
                
                group.items.forEach((item, index) => {
                    attachmentList += `${index + 1}. ${item.def.title}\n`;
                    attachmentList += `   Status: ${item.status}\n`;
                    if (item.doc && item.doc.last_updated) {
                        attachmentList += `   Last Updated: ${item.doc.last_updated}\n`;
                    }
                    if (item.def.description) {
                        attachmentList += `   Description: ${item.def.description}\n`;
                    }
                    attachmentList += `\n`;
                });
                
                zip.file(`${folderName}/attachment_checklist.txt`, attachmentList);
                
                // Add to master summary
                masterSummary += `EMAIL ${emailNum}: ${group.title.toUpperCase()}\n`;
                masterSummary += `Ready: ${readyItems.length}/${group.items.length} documents\n`;
                masterSummary += `Status: ${readyItems.length === group.items.length ? '✓ COMPLETE' : '⚠ INCOMPLETE'}\n\n`;
                
                if (readyItems.length > 0) {
                    masterSummary += `Ready documents:\n`;
                    readyItems.forEach(item => masterSummary += `  • ${item.def.title}\n`);
                    masterSummary += `\n`;
                }
                
                if (pendingItems.length > 0) {
                    masterSummary += `Pending documents:\n`;
                    pendingItems.forEach(item => masterSummary += `  • ${item.def.title} (${item.status})\n`);
                    masterSummary += `\n`;
                }
                
                masterSummary += `-------------------------------------------------------\n\n`;
            }
            
            // Add master summary to zip
            zip.file('CQC_Documentation_Summary.txt', masterSummary);
            
            // Generate and download zip
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CQC_Pre_Inspection_Emails_${dateStr}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show success message
            showNotification('Email package export completed successfully!', 'success');
            
        } catch (error) {
            console.error('Export failed:', error);
            showNotification('Export failed: ' + error.message, 'error');
        }
    }

    function bulkUploadSelected() {
        const selectedDocs = pirDocsCache.filter(doc => pirState.selectedItems.has(doc.id));
        alert(`Bulk upload for ${selectedDocs.length} selected items would be implemented here`);
    }

    function exportSelectedPIR() {
        const selectedDocs = pirDocsCache.filter(doc => pirState.selectedItems.has(doc.id));
        const data = selectedDocs.map(doc => ({
            Category: doc.category,
            Title: doc.title,
            Status: getPIRDocStatus(doc),
            'Last Updated': doc.last_updated || 'Never',
            'Evidence Type': formatItemType(doc.item_type)
        }));
        
        downloadCSV(data, 'PIR-Selected-Items.csv');
    }

    function showPIRTemplates(doc) {
        const definition = getPIRDocDefinition(doc);
        if (!definition?.allow_templates || !definition.templates) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="width: 600px;">
                <div class="modal-header">
                    <h3>Templates for: ${esc(doc.title)}</h3>
                    <button type="button" class="modal-close">&times;</button>
                </div>
                <div style="padding: 20px;">
                    <p style="color: var(--muted); margin-bottom: 20px;">
                        Download and complete these templates, then upload the finished document.
                    </p>
                    <div style="display: grid; gap: 12px;">
                        ${definition.templates.map(template => {
                            const bucket = definition.templates_bucket || 'pir_templates';
                            const publicUrl = `${window.SUPABASE_URL}/storage/v1/object/public/${bucket}/${template.path}`;
                            return `
                                <a href="${publicUrl}" download class="btn secondary" style="text-align: left; justify-content: flex-start;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    ${esc(template.label)}
                                </a>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.classList.add('show');
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal || e.target.closest('.modal-close')) {
                modal.remove();
            }
        });
    }

    function openPIRNotesModal(doc) {
        // Remove any existing notes modal
        const existingModal = document.getElementById('pir-notes-modal');
        if (existingModal) existingModal.remove();
        
        const modal = document.createElement('div');
        modal.id = 'pir-notes-modal';
        modal.className = 'modal pir-notes-modal';
        modal.style.zIndex = '2001';
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Notes for: ${esc(doc.title)}</h2>
                    <button class="modal-close" onclick="document.getElementById('pir-notes-modal').remove()">×</button>
                </div>
                
                <div class="modal-body">
                    <div class="field">
                        <label for="pir-notes-textarea">Document Notes</label>
                        <textarea 
                            id="pir-notes-textarea" 
                            rows="8" 
                            placeholder="Add notes about this document, its status, or any important information..."
                        >${esc(getPirDocNotes(doc) || '')}</textarea>
                        <div class="hint">These notes are private to your organization and will not be included in any reports.</div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn secondary" onclick="document.getElementById('pir-notes-modal').remove()">
                        Cancel
                    </button>
                    <button class="btn primary" id="save-pir-notes-btn">
                        Save Notes
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.classList.add('show');
        
        // Add event listener for Save Notes button
        const saveBtn = document.getElementById('save-pir-notes-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => savePIRNotes(doc.id));
        }
        
        // Focus on textarea
        setTimeout(() => {
            const textarea = document.getElementById('pir-notes-textarea');
            if (textarea) textarea.focus();
        }, 100);
        
        // Close on escape key
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
        
        // Close when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
                document.removeEventListener('keydown', escHandler);
            }
        });
    }
    
    async function savePIRNotes(docId) {
        const modal = document.getElementById('pir-notes-modal');
        const textarea = document.getElementById('pir-notes-textarea');
        const saveBtn = document.querySelector('#pir-notes-modal .btn.primary');

        if (!textarea || !saveBtn) {
            alert('Error: Could not find notes input elements.');
            return;
        }

        const notes = textarea.value.trim();
        const originalText = saveBtn.textContent;

        // Show saving state immediately
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
            if (!window.supabase) throw new Error('Supabase not initialized');
            if (!ctx || !ctx.site_id) throw new Error('Site context not available');

            // Try preferred path: dedicated column 'notes'
            let updatedRow = null;
            let res = await supabase
                .from('pir_documents')
                .update({ notes: notes || null })
                .eq('id', docId)
                .eq('site_id', ctx.site_id)
                .select()
                .single();

            if (res.error) {
                const msg = (res.error.message || '').toLowerCase();
                const isMissingColumn = msg.includes('column') && msg.includes('does not exist') && msg.includes('notes');

                if (!isMissingColumn) throw res.error; // real error, not a missing column

                // Fallback: store notes inside JSONB data.notes
                const currentDoc = pirDocsCache.find(d => d.id === docId) || {};
                const existingData = currentDoc.data || {};
                const newData = { ...existingData, notes: notes || null };

                res = await supabase
                    .from('pir_documents')
                    .update({ data: newData })
                    .eq('id', docId)
                    .eq('site_id', ctx.site_id)
                    .select()
                    .single();

                if (res.error) throw res.error;
                updatedRow = res.data;
            } else {
                updatedRow = res.data;
            }

            // Update local cache for both shapes
            const idx = pirDocsCache.findIndex(d => d.id === docId);
            if (idx !== -1) {
                pirDocsCache[idx] = {
                    ...pirDocsCache[idx],
                    ...(updatedRow || {}),
                    notes: notes || null,
                    data: { ...(pirDocsCache[idx].data || {}), notes: notes || null }
                };
            }

            // Success feedback and refresh
            saveBtn.textContent = 'Saved!';
            saveBtn.classList.add('success');

            setTimeout(() => {
                document.getElementById('pir-notes-modal')?.remove();
                renderPIRTable();

                const enhancedModal = document.getElementById('enhanced-pir-modal');
                if (enhancedModal) {
                    const updatedDoc = pirDocsCache.find(d => d.id === docId);
                    if (updatedDoc) previewPIRDocument(updatedDoc);
                }
            }, 700);

        } catch (err) {
            console.error('Error saving notes:', err);
            saveBtn.textContent = 'Error - Try Again';
            saveBtn.classList.add('error');
            setTimeout(() => {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                saveBtn.classList.remove('error');
            }, 1500);
            alert(`Failed to save notes: ${err.message || err}`);
        }
    }

    function saveDraftText(docId, text) {
        pirState.draftTexts.set(docId, text);
        localStorage.setItem('pir_draft_texts', JSON.stringify([...pirState.draftTexts]));
        renderPIRTable();
    }

    function sanitizeId(str) {
        return str.replace(/[^a-zA-Z0-9-_]/g, '-').toLowerCase();
    }

    function downloadCSV(data, filename) {
        if (!data.length) return;
        
        const headers = Object.keys(data[0]);
        const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(header => 
                `"${(row[header] || '').toString().replace(/"/g, '""')}"`
            ).join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    // Preview modal close handler
    document.getElementById('pir-preview-close')?.addEventListener('click', () => {
        document.getElementById('pir-preview-modal').classList.remove('show');
    });


    // NOTE: The logic for the modal pop-up is now handled by the .eml generator script.
    // The old modal logic is left here but is not triggered by the main button anymore.


    // Helper function to format data from JSON into a readable text file string
    function formatDataForTxt(doc, itemDef) {
        let content = `DOCUMENT: ${doc.title}\nCATEGORY: ${doc.category}\n\n--------------------\n\n`;

        if (doc.data.answers && itemDef.questions) {
            itemDef.questions.forEach((q, index) => {
                content += `Q: ${q}\nA: ${doc.data.answers[index] || 'Not answered'}\n\n`;
            });
        } else if (doc.data.text_content) {
            content += `${doc.data.text_content}\n`;
        } else if (doc.item_type === 'dynamic_table' && doc.data.table_data) {
            content += itemDef.headers.join('\t') + '\n';
            content += '--------------------\n';
            content += doc.data.table_data.map(row => row.join('\t')).join('\n');
        } else {
            const labels = itemDef.labels || ['Value 1', 'Value 2', 'Value 3'];
             ['num1', 'num2', 'num3', 'text1', 'text2'].forEach((key, idx) => {
                if(doc.data[key] != null && doc.data[key] !== '') {
                    content += `${labels[idx] || key}: ${doc.data[key]}\n`;
                }
            });
        }
        return content;
    }

    function buildPirForm(item, data, filePath) {
        const itemDef = PIR_DEFINITIONS.find(d => d.title === item.title) || {};
        let html = '';
        const dataValues = data || {};
        
        // Load draft text if exists
        const draftKey = `pir_draft_${item.title}`;
        const savedDraft = localStorage.getItem(draftKey);
        
        let currentStatus = item.status;
        if (currentStatus === 'Not Attached' && !item.item_type.includes('file')) {
            currentStatus = 'Not Started';
        }

        html += `<div class="field"><label>Last Updated</label><input id="field-pir-last_updated" type="date" value="${item.last_updated || ''}" /></div>`;

        // Certificate expiry tracking section
        if (item.item_type.includes('file')) {
            html += `
                <div class="field-group certificate-tracking" style="background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin: 16px 0;">
                    <h4 style="margin: 0 0 12px 0; color: var(--accent-2);">📋 Certificate Tracking</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="field" style="margin: 0;">
                            <label>Certificate Date</label>
                            <input id="field-pir-certificate_date" type="date" value="${dataValues.certificate_date || ''}" />
                            <div class="hint">Date when this certificate/document was issued</div>
                        </div>
                        <div class="field" style="margin: 0;">
                            <label>Valid Until</label>
                            <input id="field-pir-expiry_date" type="date" value="${dataValues.expiry_date || ''}" />
                            <div class="hint">When this certificate expires</div>
                        </div>
                    </div>
                    <div class="field" style="margin: 12px 0 0 0;">
                        <label>Review Reminder (days before expiry)</label>
                        <select id="field-pir-review_days_before" style="width: 200px;">
                            <option value="">No reminder</option>
                            <option value="7" ${dataValues.review_days_before === 7 ? 'selected' : ''}>7 days</option>
                            <option value="14" ${dataValues.review_days_before === 14 ? 'selected' : ''}>14 days</option>
                            <option value="30" ${dataValues.review_days_before === 30 ? 'selected' : ''}>30 days</option>
                            <option value="60" ${dataValues.review_days_before === 60 ? 'selected' : ''}>60 days</option>
                            <option value="90" ${dataValues.review_days_before === 90 ? 'selected' : ''}>90 days</option>
                        </select>
                        <div class="hint">Get reminded to review/renew before expiry</div>
                    </div>
                </div>
            `;
        }

        // Add template section if templates are available
        if (itemDef.templates && itemDef.templates.length > 0) {
            html += `<div class="pir-template-section">
                <label>Templates</label>
                <div class="template-buttons">
                    ${itemDef.templates.map(template => `
                        <button type="button" class="btn secondary template-download-btn" data-template-name="${template.name}" data-template-url="${template.url}">
                            📄 ${template.name}
                        </button>
                    `).join('')}
                </div>
            </div>`;
        }

        switch(item.item_type) {
            case 'textarea':
                const textareaValue = savedDraft || dataValues.text_content || '';
                html += `<div class="field">
                    <label>Summary / Statement</label>
                    <textarea id="field-pir-text_content" class="draft-enabled" data-draft-key="${draftKey}">${esc(textareaValue)}</textarea>
                    ${savedDraft ? '<div class="draft-indicator">📝 Draft saved</div>' : ''}
                </div>`;
                break;
            case 'textarea_and_file':
                const textareaFileValue = savedDraft || dataValues.text_content || '';
                html += `<div class="field">
                    <label>Summary / Process Description</label>
                    <textarea id="field-pir-text_content" class="draft-enabled" data-draft-key="${draftKey}">${esc(textareaFileValue)}</textarea>
                    ${savedDraft ? '<div class="draft-indicator">📝 Draft saved</div>' : ''}
                    <div class="hint">${itemDef.description || ''}</div>
                </div>`;
                break;
            case 'guided_questions':
            case 'guided_questions_and_file':
            case 'guided_questions_and_number':
                 if (itemDef.questions) {
                    itemDef.questions.forEach((q, index) => {
                        const questionDraftKey = `${draftKey}_q${index}`;
                        const savedQuestionDraft = localStorage.getItem(questionDraftKey);
                        const questionValue = savedQuestionDraft || dataValues.answers?.[index] || '';
                        html += `<div class="field">
                            <label>${esc(q)}</label>
                            <textarea data-question-index="${index}" class="draft-enabled" data-draft-key="${questionDraftKey}">${esc(questionValue)}</textarea>
                            ${savedQuestionDraft ? '<div class="draft-indicator">📝 Draft saved</div>' : ''}
                        </div>`;
                    });
                 }
                 if (item.item_type.includes('number')) {
                    html += `<div class="field"><label>${esc(itemDef.label || 'Value')}</label><input id="field-pir-num1" type="number" value="${esc(dataValues.num1 || '')}" /></div>`;
                 }
                break;
            case 'number':
                html += `<div class="field"><label>${esc(itemDef.label || 'Value')}</label><input id="field-pir-num1" type="number" value="${esc(dataValues.num1 || '')}" /></div>`;
                break;
            case 'dual_number':
            case 'triple_number':
                html += `<div class="multi-input-container">${itemDef.labels.map((label, i) => `
                    <div class="field"><label>${esc(label)}</label><input id="field-pir-num${i+1}" type="number" value="${esc(dataValues[`num${i+1}`] || '')}" /></div>
                `).join('')}</div>`;
                break;
            case 'dual_text':
                 html += `<div class="multi-input-container">${itemDef.labels.map((label, i) => `
                    <div class="field"><label>${esc(label)}</label><input id="field-pir-text${i+1}" type="text" value="${esc(dataValues[`text${i+1}`] || '')}" /></div>
                `).join('')}</div>`;
                break;
            case 'dynamic_table':
                html += `<div class="field"><label>${esc(item.title)}</label><div id="dynamic-table-container"></div><button type="button" class="btn secondary" id="btn-add-table-row" style="margin-top:8px; font-size:12px; padding: 6px 10px;">+ Add Row</button></div>`;
                break;
        }

        if (item.item_type.includes('file')) {
            const fileName = filePath ? filePath.split('/').pop() : 'No file attached';
            html += `<hr style="border:none; border-top: 1px solid var(--border-color); margin: 16px 0;">
                <div class="field">
                <label>Attached File</label>
                <div id="file-display" style="padding:10px 12px; background:#ffffff10; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span>${esc(fileName)}</span>
                    <div style="display:flex; gap:6px;">
                      ${filePath ? `<button type="button" class="btn secondary" id="btn-preview-pir" style="padding: 4px 8px; font-size: 12px;">Preview</button>` : ''}
                      ${filePath ? `<button type="button" class="btn secondary" id="btn-download-pir" style="padding: 4px 8px; font-size: 12px;">Download</button>` : ''}
                      ${filePath ? `<button type="button" class="btn secondary" id="btn-delete-pir-attachment" style="padding: 4px 8px; font-size: 12px; background: #ff6b6b33; border-color: #ff6b6b55;">Delete</button>` : ''}
                    </div>
                </div>
                <input type="file" id="field-pir-file_path" style="color: var(--muted); font-size: 12px;" />
                <div class="hint">${itemDef.description || 'Uploading a new file will replace the existing one.'}</div>
                </div>`;
        }
        return html;
    }

    // Initialize draft text auto-save
    function initializeDraftTextSupport() {
        // Auto-save draft text
        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('draft-enabled')) {
                const draftKey = e.target.dataset.draftKey;
                if (draftKey) {
                    localStorage.setItem(draftKey, e.target.value);
                    
                    // Show/hide draft indicator
                    let indicator = e.target.parentNode.querySelector('.draft-indicator');
                    if (e.target.value.trim()) {
                        if (!indicator) {
                            indicator = document.createElement('div');
                            indicator.className = 'draft-indicator';
                            indicator.textContent = '📝 Draft saved';
                            e.target.parentNode.appendChild(indicator);
                        }
                    } else {
                        if (indicator) {
                            indicator.remove();
                        }
                        localStorage.removeItem(draftKey);
                    }
                }
            }
        });

        // Handle template downloads
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('template-download-btn')) {
                const templateName = e.target.dataset.templateName;
                const templateUrl = e.target.dataset.templateUrl;
                
                if (templateUrl) {
                    // Create temporary link to download template
                    const link = document.createElement('a');
                    link.href = templateUrl;
                    link.download = templateName;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showToast(`Downloaded template: ${templateName}`, 'success');
                } else {
                    showToast('Template URL not found', 'error');
                }
            }
        });
    }

    // Clear draft text for a specific item
    function clearDraftText(itemTitle) {
        const draftKey = `pir_draft_${itemTitle}`;
        localStorage.removeItem(draftKey);
        
        // Also clear question drafts if any
        for (let i = 0; i < 10; i++) {
            localStorage.removeItem(`${draftKey}_q${i}`);
        }
    }

  // Initialize role management modal close behavior
  const rolesModal = document.getElementById('roles-modal');
  if (rolesModal) {
    rolesModal.addEventListener('click', (e) => {
      if (e.target === rolesModal || e.target.closest('.modal-close')) {
        rolesModal.classList.remove('show');
      }
    });
  }

  // Bootstrap
  async function bootstrap(){
    console.log('🚀 Bootstrap starting...');
    
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (error) {
        console.error('❌ Session check failed:', error);
        showAuth(true);
        return;
      }

      if (!session) {
        console.log('ℹ️ No session found, showing auth');
        showAuth(true);
        return;
      }

      console.log('✅ Session found, user:', session.user?.email);
      
      // Hide auth and show main app
      showAuth(false);

      try {
        console.log('📍 Loading context...');
        await loadContext();
        console.log('✅ Context loaded successfully');
      } catch (contextError) {
        console.error('❌ Context loading failed:', contextError);
        // Don't redirect to auth immediately - show error instead
        showError('Failed to load user context: ' + (contextError.message || 'Unknown error'));
        return;
      }

      try {
        console.log('🌱 Seeding initial PIR docs...');
        await seedInitialPIRDocs();
        console.log('📅 Caching schedules...');
        await cacheRequiredSchedules();
        console.log('📊 Loading dashboard data...');
        await Promise.all([loadCounts(), loadDue(), loadActivity(), loadItems(), loadRooms(), loadComplaints(), loadCheckTypes(), loadSchedules(), loadStaff(), loadSubmissions(), loadWeekCalendar(), loadAndRenderCalendar(), loadCQCDashboard()]);
        console.log('✅ All data loaded successfully');
      } catch (dataError) {
        console.error('⚠️ Data loading failed (non-critical):', dataError);
        // Don't redirect to auth - just log the error and continue
        showError('Some data failed to load. Dashboard may show incomplete information.');
      }

      // If the active section is pre-inspection, ensure its data is loaded now that context is ready.
      if (activeViewId() === 'view-pre-inspection') {
          try {
            await loadAndRenderPIR();
          } catch (pirError) {
            console.error('PIR loading failed:', pirError);
          }
      }

      // Set up real-time subscriptions
      try {
        console.log('🔄 Setting up real-time subscriptions...');
        supabase.channel("changes")
          .on("postgres_changes", { event:"*", schema:"public", table:"items", filter:`site_id=eq.${ctx.site_id}` }, loadItems)
          .on("postgres_changes", { event:"*", schema:"public", table:"rooms", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadRooms(); await loadCounts(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"complaints", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadComplaints(); await loadCounts(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"check_types", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadCheckTypes(); await loadCounts(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"kiosk_users", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadStaff(); await loadCounts(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"submissions", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadActivity(); await loadSubmissions(); await loadWeekCalendar(); if(activeViewId() === 'view-calendar') loadAndRenderCalendar(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"item_allowed_types", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadSchedules(); await cacheRequiredSchedules(); await loadWeekCalendar(); if(activeViewId() === 'view-calendar') loadAndRenderCalendar(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"pir_documents", filter:`site_id=eq.${ctx.site_id}` }, async() => { if (activeViewId() === 'view-pre-inspection') { loadAndRenderPIR(); }})
          .on("postgres_changes", { event:"*", schema:"public", table:"training_records", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadCQCDashboard(); await loadCounts(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"pir_documents", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadCQCDashboard(); if (activeViewId() === 'view-pre-inspection') loadAndRenderPIR(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"submission_rows", filter:`site_id=eq.${ctx.site_id}` }, async(payload)=>{
            if(submissionDetailModal.classList.contains("show")){
              const openId = submissionDetailModal.dataset.submissionId;
              if(payload.new.submission_id == openId){ showSubmissionDetails(openId); }
            }
            await loadCQCDashboard();
          })
          .on("postgres_changes", { event:"*", schema:"public", table:"complaints", filter:`site_id=eq.${ctx.site_id}` }, async()=>{ await loadComplaints(); await loadCounts(); await loadCQCDashboard(); })
          .on("postgres_changes", { event:"*", schema:"public", table:"submission_rows", filter:`site_id=eq.${ctx.site_id}` }, async(payload)=>{
            if(submissionDetailModal.classList.contains("show")){
              const openId = submissionDetailModal.dataset.submissionId;
              if(payload.new.submission_id == openId){ showSubmissionDetails(openId); }
            }
          })
          .subscribe();
        console.log('✅ Real-time subscriptions set up');
      } catch (subscriptionError) {
        console.error('⚠️ Failed to set up real-time subscriptions:', subscriptionError);
        // This is non-critical, continue without redirecting to auth
      }
      
      console.log('🎉 Bootstrap completed successfully');
      
    } catch (err) {
      console.error('💥 Bootstrap failed with unexpected error:', err);
      showError('Application failed to start. Please refresh the page and try again.');
      // Only redirect to auth if it's clearly an authentication issue
      if (err.message && (err.message.includes('auth') || err.message.includes('session') || err.message.includes('token'))) {
        console.log('Authentication error detected, redirecting to login');
        showAuth(true);
      }
    }
  }

  // ---------- CRUD Helpers ----------
  const crudModal = document.getElementById("crud-modal");
  const crudTitle = document.getElementById("crud-title");
  const crudForm = document.getElementById("crud-form");
  const crudFields = document.getElementById("crud-fields");
  const crudError = document.getElementById("crud-error");
  const crudDeleteBtn = document.getElementById("crud-delete");
  const crudCancelBtn = document.getElementById("crud-cancel");

  let crudState = { entity:null, mode:"add", row:null, pk:null, context: {} };

  const ENTITIES = {
    rooms: { table: "rooms", label: "Room", pk: "id", fields: [{name:"name", label:"Name", type:"text", required:true}, {name:"occupied_by", label:"Owner (Staff)", type:"select", source:"kiosk_users", sourceLabel:"full_name"}] },
    check_types: { table: "check_types", label: "Check Type", pk: "id", fields: [{name:"name", label:"Name", type:"text", required:true}, {name:"active", label:"Active", type:"checkbox", default:true}] },
  kiosk_users: { table: "kiosk_users", label: "Staff", pk: "id", fields: [{name:"full_name", label:"Full Name", type:"text", required:true},
{name:"role", label:"Role", type:"select", required:true},
{name:"reports_to_id", label:"Reports To", type:"select", source:"kiosk_users", sourceLabel:"full_name", valueKey:"id"},
{name:"active", label:"Active", type:"checkbox", default:true}] },
    complaints: { table: "complaints", label: "Complaint", pk: "id", fields: [
  { name: "attachment", label: "Attach Complaint Document", type: "file-upload", fullWidth: true },
  { name: "complaint_date", label: "Complaint Date", type: "datepicker", required: true },
  { name: "patient_initials", label: "Patient Initials", type: "text", required: true, maxLength: 10 },
      { name: "age", label: "Age", type: "age-selector" },
      { name: "complaint_number", label: "Complaint Number", type: "text", readonly: true },
      { name: "response_sent", label: "Response Sent", type: "checkbox", default: false },
  { name: "complaint_summary", label: "Complaint Summary", type: "textarea", required: true, fullWidth: true },
  { name: "original_complaint", label: "Original Complaint Details", type: "textarea", fullWidth: true },
  { name: "response", label: "Response Given", type: "textarea", fullWidth: true },
  { name: "lessons_learned", label: "Lessons Learned", type: "textarea", fullWidth: true },
  { name: "category", label: "Category", type: "select", source: "complaint_categories", sourceLabel: "name", valueKey: "name", required: true },
      { name: "solution_given", label: "Solution Given", type: "textarea", fullWidth: true },
      { name: "category_trends", label: "Category for Trends Chart", type: "category-select", options: [
  {value:'MEDICATION', label:'MEDICATION', color:'#ff6b6b'},
  {value:'COMMUNICATION', label:'COMMUNICATION', color:'#4ecdc4'},
  {value:'ADMIN', label:'ADMIN', color:'#45b7d1'},
  {value:'MEDICAL', label:'MEDICAL', color:'#96ceb4'},
  {value:'APPT SYSTEM', label:'APPT SYSTEM', color:'#feca57'},
  {value:'OUTSIDE AGENCIES', label:'OUTSIDE AGENCIES', color:'#ff9ff3'},
  {value:'GDPR', label:'GDPR', color:'#54a0ff'}
      ], required: true },
      { name: "people_involved", label: "Names of People Involved", type: "staff-multi-select", source: "kiosk_users", sourceLabel: "full_name", valueKey: "id" },
      { name: "avenue_used", label: "Avenue Used to Complain", type: "avenue-select", options: [
  {value:'Phone', label:'Phone'},
  {value:'Email', label:'Email'},
  {value:'Letter', label:'Letter'},
  {value:'In Person', label:'In Person'},
  {value:'Online Form', label:'Online Form'},
  {value:'Social Media', label:'Social Media'}
      ] },
      { name: "suggestions_prevent_reoccurrence", label: "Suggestions to prevent reoccurrence", type: "textarea", fullWidth: true },
      { name: "actions_to_be_taken", label: "Actions to be taken", type: "textarea", fullWidth: true },
      { name: "status", label: "Status", type: "status-select", options: [
        {value:'pending', label:'Pending', color:'#feca57'},
        {value:'investigating', label:'Investigating', color:'#ff6b6b'},
        {value:'resolved', label:'Resolved', color:'#1dd1a1'},
        {value:'closed', label:'Closed', color:'#636e72'}
      ], default: 'pending' },
      { name: "priority", label: "Priority", type: "priority-select", options: [
        {value:'low', label:'Low', color:'#1dd1a1'},
        {value:'medium', label:'Medium', color:'#feca57'},
        {value:'high', label:'High', color:'#ff6b6b'}
      ], default: 'medium' },
      { name: "share_with_team", label: "Share with team", type: "checkbox", default: false },
      { name: "created_by", label: "Created by", type: "select", source: "kiosk_users", sourceLabel: "full_name", valueKey: "id" },
    ] },
    items: { table: "items", label: "Item", pk: "id", fields: [{name:"item_id", label:"Code", type:"text", required:true}, {name:"item_name", label:"Name", type:"text", required:true}, {name:"room_id", label:"Room", type:"select", source:"rooms", sourceLabel:"name"}, {name:"default_check_type_id", label:"Default Check Type", type:"select", source:"check_types", sourceLabel:"name"}, {name:"active", label:"Active", type:"checkbox", default:true}] },
    item_allowed_types: { table: "item_allowed_types", label: "Schedule", pk: "id", fields: [{name:"item_id", label:"Item", type:"select", source:"items", sourceLabel:"item_name", required:true}, {name:"check_type_id", label:"Check Type", type:"select", source:"check_types", sourceLabel:"name", required:true}, {name:"frequency", label:"Every", type:"frequency", onchange: function(e) {
          const freq = e.target.value.toLowerCase();
          const scheduledDaySelect = document.getElementById('field-scheduled_day');
          if (!scheduledDaySelect) return;
          
          if (freq.includes('mon')) {
            // For monthly frequency, show dates 1-31
            scheduledDaySelect.innerHTML = Array.from({length: 31}, (_, i) => 
              `<option value="${i+1}">${i+1}${['st','nd','rd'][i] || 'th'}</option>`
            ).join('');
          } else {
            // For other frequencies, show days of week
            scheduledDaySelect.innerHTML = [
              {value: 'Sun', label: 'Sunday'},
              {value: 'Mon', label: 'Monday'},
              {value: 'Tue', label: 'Tuesday'},
              {value: 'Wed', label: 'Wednesday'},
              {value: 'Thu', label: 'Thursday'},
              {value: 'Fri', label: 'Friday'},
              {value: 'Sat', label: 'Saturday'}
            ].map(day => `<option value="${day.value}">${day.label}</option>`).join('');
          }
        }, required:true}, { name: "scheduled_day", label: "On", type: "select" }, {name:"required", label:"Required", type:"checkbox", default:true}] },
    submission_rows: { table: "submission_rows", label: "Submission Row", pk: "id", fields: [{name:"check_type_id", label:"Check Type", type:"select", source:"check_types", sourceLabel:"name", required:true}, {name:"row_comment", label:"Comment", type:"textarea"}] },
    pir_documents: { table: "pir_documents", label: "Inspection Document", pk: "id" }
  };

  async function openCRUD(entityKey, mode="add", row=null, context={}){
    crudError.textContent = "";
    crudState = { entity:ENTITIES[entityKey], mode, row, pk:ENTITIES[entityKey].pk, context };
    
    // Debug user context
    console.log('OpenCRUD - User Context:', { 
      ctx_user: ctx.user, 
      ctx_site_id: ctx.site_id,
      entityKey: entityKey,
      mode: mode 
    });
    debugLog('CRUD Open', { 
      entity: entityKey, 
      mode: mode, 
      user: ctx.user?.id,
      site: ctx.site_id 
    });
    
    if (entityKey === 'pir_documents') {
        crudTitle.textContent = `Manage: ${row.title}`;
        crudFields.innerHTML = buildPirForm(row, row.data, row.file_path);
        
        const deleteAttachmentBtn = document.getElementById('btn-delete-pir-attachment');
        if (deleteAttachmentBtn && row?.file_path) {
            deleteAttachmentBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to delete this attachment? This cannot be undone.')) return;
                try {
                    crudError.textContent = 'Deleting...';
                    const { error: deleteError } = await supabase.storage.from('pir_attachments').remove([row.file_path]);
                    if (deleteError) throw deleteError;

                    const { data: updatedRow, error: updateError } = await supabase.from('pir_documents')
                        .update({ file_path: null, status: 'Not Attached', last_updated: new Date().toISOString().slice(0,10) })
                        .eq('id', row.id)
                        .select()
                        .single();
                    
                    if (updateError) throw updateError;
                    
                    // Re-render the modal with the updated state (no file)
                    crudState.row = updatedRow;
                    openCRUD('pir_documents', 'edit', updatedRow);
                    crudError.textContent = '';

                } catch (err) {
                    crudError.textContent = `Deletion failed: ${err.message}`;
                }
            });
        }

        if(row.item_type === 'dynamic_table') {
            const container = document.getElementById('dynamic-table-container');
            const addRowBtn = document.getElementById('btn-add-table-row');
            const headers = (PIR_DEFINITIONS.find(d => d.title === row.title) || {}).headers || [];
            if (!row.data) row.data = {};
            if (!row.data.table_data) row.data.table_data = [];

            const renderTable = () => {
                let tableHtml = `<table style="font-size:12px;"><thead><tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}<th></th></tr></thead><tbody>`;
                row.data.table_data.forEach((r, idx) => {
                    tableHtml += `<tr>${headers.map((h, i) => `<td><input value="${esc(r[i] || '')}" data-row="${idx}" data-col="${i}" /></td>`).join('')}
                    <td><button type="button" class="btn-remove-row" data-index="${idx}" style="all:unset; cursor:pointer; color: var(--danger);">✕</button></td></tr>`;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            };

            addRowBtn.addEventListener('click', () => {
                row.data.table_data.push(new Array(headers.length).fill(''));
                renderTable();
            });

            container.addEventListener('input', e => {
                 if(e.target.tagName === 'INPUT') {
                    row.data.table_data[e.target.dataset.row][e.target.dataset.col] = e.target.value;
                 }
            });
             container.addEventListener('click', e => {
                 if(e.target.classList.contains('btn-remove-row')) {
                    row.data.table_data.splice(parseInt(e.target.dataset.index, 10), 1);
                    renderTable();
                 }
            });
            renderTable();
        }

    } else {
        crudTitle.textContent = (mode === "add") ? `Add ${crudState.entity.label}` : context.titlePrefix || `Edit ${crudState.entity.label}`;
        // Use a mutable copy so we can tweak fields per entity
        let _fields = Array.isArray(crudState.entity.fields) ? crudState.entity.fields.map(f=>({...f})) : [];
        // Special-case: Staff role should be a dropdown sourced from kiosk_roles (text primary key)
        if (entityKey === 'kiosk_users') {
          const idx = _fields.findIndex(f => f.name === 'role');
          if (idx !== -1) {
            _fields[idx] = { name:'role', label:'Role', type:'select', source:'kiosk_roles', sourceLabel:'role', valueKey:'role', required:true };
          } else {
            _fields.push({ name:'role', label:'Role', type:'select', source:'kiosk_roles', sourceLabel:'role', valueKey:'role', required:true });
          }
        }
        crudFields.innerHTML = `<div class="crud-grid">${_fields.map(f => {

          let val = row ? row[f.name] : (f.type === "checkbox" ? !!f.default : (f.default ?? ""));
          if(val === null || val === undefined) val = (f.type === "checkbox" ? false : "");
          
          const id = `field-${f.name}`;
          const label = (f.label || f.name);
          const fieldClass = f.fullWidth ? "field full" : "field";
          
          if(f.type === "text"){
            return `<div class="${fieldClass}"><label>${esc(label)}</label><input id="${id}" type="text" value="${esc(val)}" ${f.required ? "required" : ""} ${f.readonly ? "readonly" : ""}></div>`;
          }
          
          if(f.type === "datepicker"){
            const today = new Date().toISOString().slice(0,10);
            const dateVal = val ? new Date(val).toISOString().slice(0,10) : "";
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <div class="datepicker-wrapper">
                <input id="${id}" type="date" value="${esc(dateVal)}" ${f.required ? "required" : ""} class="modern-datepicker" />
                <button type="button" class="btn secondary quick-date" onclick="document.getElementById('${id}').value='${today}'">Today</button>
              </div>
            </div>`;
          }
          
          if(f.type === "age-selector"){
            const ageOptions = Array.from({length: 100}, (_, i) => i + 1).map(age => 
              `<option value="${age}" ${age == val ? 'selected' : ''}>${age}</option>`
            ).join('');
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <select id="${id}" class="ui-select age-select">
                <option value="">Select age...</option>
                ${ageOptions}
                <option value="100+" ${val == "100+" ? 'selected' : ''}>100+</option>
              </select>
            </div>`;
          }
          
          if(f.type === "staff-multi-select"){
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <div class="multi-select-wrapper">
                <input id="${id}" type="hidden" value="${esc(val)}" />
                <div class="staff-chips" id="${id}-chips"></div>
                <select id="${id}-selector" class="ui-select">
                  <option value="">Add staff member...</option>
                </select>
              </div>
            </div>`;
          }
          
          if(f.type === "category-select" || f.type === "status-select" || f.type === "priority-select" || f.type === "avenue-select"){
            const opts = (f.options || []).map(o => 
              `<option value="${o.value}" ${o.value == val ? "selected": ""} data-color="${o.color || ""}">${o.label}</option>`
            ).join("");
            return `<div class="${fieldClass}">
              <label>${esc(label)}</label>
              <select id="${id}" class="ui-select ${f.type}" ${f.required ? "required" : ""}>
                ${f.required ? '' : '<option value="">Select...</option>'}
                ${opts}
              </select>
            </div>`;
          }
          
          if(f.type === "datetime"){
            let dateVal = "";
            let timeVal = "";
            try{
              if(val){ const d = new Date(val); dateVal = d.toISOString().slice(0,10); timeVal = d.toISOString().slice(11,16); }
            }catch(e){}
            return `<div class="${fieldClass}"><label>${esc(label)}</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="${id}-date" type="date" value="${esc(dateVal)}" ${f.required ? "required" : ""} />
                <input id="${id}-time" type="time" value="${esc(timeVal)}" ${f.required ? "required" : ""} />
                <button type="button" class="btn secondary" id="${id}-now" style="padding:6px 8px;">Now</button>
              </div>
            </div>`;
          }
          
          if(f.type === "textarea"){
            return `<div class="${fieldClass}"><label>${esc(label)}</label><textarea id="${id}" rows="3" ${f.required ? "required" : ""}>${esc(val)}</textarea></div>`;
          }
          
          if(f.type === "checkbox"){
            return `<div class="${fieldClass}"><label style="display:flex; gap:8px; align-items:center;"><input id="${id}" type="checkbox" ${val ? "checked" : ""}> ${esc(label)}</label></div>`;
          }
          
          if(f.type === "select"){
            if(f.options){
              const opts = (f.options || []).map(o => `<option value="${o.value}"${o.value == val ? " selected": ""}>${o.label}</option>`).join("");
              return `<div class="${fieldClass}"><label>${esc(label)}</label><select id="${id}" class="ui-select">${opts}</select></div>`;
            }else{
              return `<div class="${fieldClass}"><label>${esc(label)}</label><select id="${id}" class="ui-select"><option value="">Loading...</option></select></div>`;
            }
          }
          
          if(f.type === "frequency"){
            setTimeout(() => {
              const freq = String(val || '1 month').toLowerCase();
              const scheduledDaySelect = document.getElementById('field-scheduled_day');
              if (!scheduledDaySelect) return;
              
              if (freq.includes('mon')) {
                scheduledDaySelect.innerHTML = Array.from({length: 31}, (_, i) => 
                  `<option value="${i+1}">${i+1}${['st','nd','rd'][i] || 'th'}</option>`
                ).join('');
              } else {
                scheduledDaySelect.innerHTML = [
                  {value: 'Sun', label: 'Sunday'},
                  {value: 'Mon', label: 'Monday'},
                  {value: 'Tue', label: 'Tuesday'},
                  {value: 'Wed', label: 'Wednesday'},
                  {value: 'Thu', label: 'Thursday'},
                  {value: 'Fri', label: 'Friday'},
                  {value: 'Sat', label: 'Saturday'}
                ].map(day => `<option value="${day.value}">${day.label}</option>`).join('');
              }
            }, 0);
            let num = 1, unit = "day";
            if(typeof val === "string" && val){
              const m = val.match(/(\d+)\s*(year|mon|week|day)/i);
              if(m){ num = m[1]; unit = m[2].toLowerCase(); }
            }
            const units = [
              {v:"day",  n:"day(s)"},
              {v:"week", n:"week(s)"},
              {v:"mon",  n:"month(s)"},
              {v:"year", n:"year(s)"}
            ];
            const unitOpts = units.map(u => `<option value="${u.v}"${u.v===unit?" selected":""}>${u.n}</option>`).join("");
            return `<div class="${fieldClass}"><label>${esc(label || "Every")}</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="${id}-n" type="number" min="1" value="${num}" style="width:110px">
                <select id="${id}-u">${unitOpts}</select>
              </div>
            </div>`;
          }
          
          if(f.type === "file-upload"){
            return `<div class="${fieldClass}" style="border: 1px dashed #ccc; padding: 15px; border-radius: 8px; background: #f9f9f9;">
              <label style="font-weight: bold; margin-bottom: 10px; display: block;">${esc(label)}</label>
              <div class="file-upload-area" style="text-align: center;">
                <input id="${id}" type="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt" style="display: none;" />
                <button type="button" class="btn secondary" onclick="document.getElementById('${id}').click()" style="margin-bottom: 10px;">
                  <span>📎 Choose File</span>
                </button>
                <div id="${id}-status" style="font-size: 12px; color: #666; margin-top: 5px;">No file selected</div>
                <div id="${id}-progress" style="display: none; margin-top: 10px;">
                  <div style="background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                    <div id="${id}-progress-bar" style="background: #4CAF50; height: 20px; width: 0%; transition: width 0.3s;"></div>
                  </div>
                  <div id="${id}-progress-text" style="font-size: 12px; margin-top: 5px;">Uploading...</div>
                </div>
              </div>
              <div class="ai-helper" style="margin-top:.5rem; display:flex; gap:.5rem; align-items:center; justify-content:center;">
                <button type="button" id="ai-populate-btn-${id}" class="ai-populate-btn btn btn-secondary" style="padding:.4rem .7rem; font-size:.9rem;">
                  Optional: Populate with AI
                </button>
                <span id="ai-status-${id}" style="font-size:.85rem; opacity:.8;"></span>
              </div>
            </div>`;
          }
          
          return `<div class="${fieldClass}"><label>${esc(label)}</label><input id="${id}" type="text" value="${esc(val)}"></div>`;

        }).join("")}</div>`;

// Ensure Staff Role dropdown is populated even if not declared in entity schema
if (entityKey === 'kiosk_users') {
  (async ()=>{
    const sel = document.getElementById('field-role');
    if (sel && sel.tagName.toLowerCase()==='select') {
      // Roles are fixed to Admin and Staff
      const options = [ {v:'admin', l:'Admin'}, {v:'staff', l:'Staff'} ];
      const selected = (crudState.row || {}).role || '';
      sel.innerHTML = `<option value="">—</option>` + options.map(o => {
        const s = (String(o.v) === String(selected)) ? ' selected' : '';
        return `<option value="${o.v}"${s}>${o.l}</option>`;
      }).join('');
    }
  })();
}

        
// Populate dynamic select sources
(async () => {
  
for (const f of (crudState.entity.fields || [])) {
    if (f.type === "select" && f.source && !f.options) {
      const sel = document.getElementById('field-' + f.name);
      if (!sel) continue;
      try {
        const selectCols = (f.valueKey || "id") + ", " + (f.sourceLabel || "full_name");
        let q = supabase.from(f.source).select(selectCols);
  const siteScoped = ["rooms","check_types","items","kiosk_users","item_allowed_types"];
        if (typeof ctx !== "undefined" && ctx.site_id && siteScoped.includes(f.source)) {
          q = q.eq("site_id", ctx.site_id);
        }
        const { data, error } = await q;
        if (!error && Array.isArray(data)) {
          // Exclude self when choosing a manager
          let list = data;
          if (f.name === "reports_to_id" && crudState?.row?.id) {
            const idKey = f.valueKey || "id";
            list = data.filter(r => String(r[idKey]) !== String(crudState.row.id));
          }
          const selected = (crudState.row || {})[f.name];
          sel.innerHTML = `<option value="">—</option>` + list.map(r => {
            const optVal = r[f.valueKey || "id"];
            const optLab = r[f.sourceLabel || "full_name"];
            const selAttr = (String(optVal) === String(selected)) ? " selected" : "";
            return '<option value="' + optVal + '"' + selAttr + '>' + esc(optLab) + '</option>';
          }).join("");
          // Defensive: if this is the created_by field and selected option looks non-UUID, prefer current user id
          if(f.name === 'created_by'){
            const chosen = sel.value;
            if(chosen && !isUUID(chosen) && ctx.user && ctx.user.id){
              sel.value = ctx.user.id;
            }
          }
        } else {
          sel.innerHTML = '<option value="">(error)</option>';
        }
      } catch (err) {
        console.warn('Select loader error for', f.name, err);
        sel.innerHTML = '<option value="">(error)</option>';
      }
    }
  }
})();;

  // Initialize enhanced form elements for complaints
  if (entityKey === 'complaints') {
    // Setup file upload handler
    const fileInput = document.getElementById('field-attachment');
    if (fileInput) {
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const statusDiv = document.getElementById('field-attachment-status');
        const progressDiv = document.getElementById('field-attachment-progress');
        const progressBar = document.getElementById('field-attachment-progress-bar');
        const progressText = document.getElementById('field-attachment-progress-text');
        
        if (!file) {
          statusDiv.textContent = 'No file selected';
          statusDiv.style.color = '#666';
          return;
        }
        
        // Validate file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
          statusDiv.textContent = 'File too large. Maximum size is 10MB.';
          statusDiv.style.color = '#e74c3c';
          return;
        }
        
        try {
          progressDiv.style.display = 'block';
          statusDiv.style.color = '#666';
          statusDiv.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
          
          // Store file for later upload when form is submitted
          crudState.pendingAttachment = {
            file: file,
            fileName: file.name,
            fileSize: file.size,
            fileType: file.type
          };
          
          progressBar.style.width = '100%';
          progressText.textContent = 'Ready to upload when complaint is saved';
          
          setTimeout(() => {
            progressDiv.style.display = 'none';
          }, 2000);
          
        } catch (error) {
          console.error('File selection error:', error);
          statusDiv.textContent = 'Error selecting file';
          statusDiv.style.color = '#e74c3c';
          progressDiv.style.display = 'none';
        }
      });
    }
    
    // Setup staff multi-select
    setTimeout(() => {
      const staffMultiSelect = document.getElementById('field-people_involved-selector');
      const staffChips = document.getElementById('field-people_involved-chips');
      const hiddenInput = document.getElementById('field-people_involved');
      
      if (staffMultiSelect && staffChips && hiddenInput) {
        // Load staff members into the selector
        supabase.from('kiosk_users').select('id, full_name').eq('site_id', ctx.site_id).then(({data, error}) => {
          if (data && !error) {
            staffMultiSelect.innerHTML = '<option value="">Add staff member...</option>' + 
              data.map(s => `<option value="${s.id}">${s.full_name}</option>`).join('');
          }
        });
        
        // Handle staff selection
        staffMultiSelect.addEventListener('change', (e) => {
          if (e.target.value) {
            const staffId = e.target.value;
            const staffName = e.target.selectedOptions[0].text;
            const currentIds = hiddenInput.value ? hiddenInput.value.split(',') : [];
            
            if (!currentIds.includes(staffId)) {
              currentIds.push(staffId);
              hiddenInput.value = currentIds.join(',');
              
              const chip = document.createElement('div');
              chip.className = 'staff-chip';
              chip.innerHTML = `${staffName} <button type="button" onclick="this.parentElement.remove(); updateStaffIds()">×</button>`;
              staffChips.appendChild(chip);
            }
            e.target.value = '';
          }
        });
        
        // Function to update hidden input when chips are removed
        window.updateStaffIds = function() {
          const chips = staffChips.querySelectorAll('.staff-chip');
          const ids = Array.from(chips).map(chip => {
            const text = chip.textContent.replace('×', '').trim();
            const option = Array.from(staffMultiSelect.options).find(opt => opt.text === text);
            return option ? option.value : null;
          }).filter(id => id);
          hiddenInput.value = ids.join(',');
        };
        
        // Load existing selections
        if (hiddenInput.value) {
          const existingIds = hiddenInput.value.split(',');
          existingIds.forEach(id => {
            const option = Array.from(staffMultiSelect.options).find(opt => opt.value === id);
            if (option) {
              const chip = document.createElement('div');
              chip.className = 'staff-chip';
              chip.innerHTML = `${option.text} <button type="button" onclick="this.parentElement.remove(); updateStaffIds()">×</button>`;
              staffChips.appendChild(chip);
            }
          });
        }
      }
    }, 100);
  }

  // Attach 'Now' handlers for datetime fields (fill date and time with current values)
  (function attachNowButtons(){
    (crudState.entity.fields || []).forEach(f=>{
      if(f.type === 'datetime'){
        const btn = document.getElementById(`field-${f.name}-now`);
        if(!btn) return;
        btn.addEventListener('click', ()=>{
          const d = new Date();
          const dateEl = document.getElementById(`field-${f.name}-date`);
          const timeEl = document.getElementById(`field-${f.name}-time`);
          if(dateEl) dateEl.value = d.toISOString().slice(0,10);
          if(timeEl) timeEl.value = d.toISOString().slice(11,16);
        });
      }
    });
  })();

    }

    const downloadBtn = document.getElementById('btn-download-pir');
    if (downloadBtn && row?.file_path) {
        downloadBtn.addEventListener('click', async () => {
            const { data, error } = await supabase.storage.from('pir_attachments').download(row.file_path);
            if (error) { crudError.textContent = `Download failed: ${error.message}`; return; }
            const url = URL.createObjectURL(data);
            const a = document.createElement('a');
            a.href = url;
            a.download = row.file_path.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    }

    // Add preview button handler
    const previewBtn = document.getElementById('btn-preview-pir');
    if (previewBtn && row?.file_path) {
        previewBtn.addEventListener('click', async () => {
            const { data, error } = await supabase.storage.from('pir_attachments').download(row.file_path);
            if (error) { 
                crudError.textContent = `Preview failed: ${error.message}`; 
                return; 
            }
            
            const fileName = row.file_path.split('/').pop().toLowerCase();
            const fileUrl = URL.createObjectURL(data);
            
            if (fileName.endsWith('.pdf')) {
                // Show PDF in modal preview
                showPdfPreview(fileUrl, fileName);
            } else if (fileName.match(/\.(docx?|xlsx?|pptx?)$/)) {
                // Show document metadata
                showDocumentMetadata(fileName, data.size);
            } else {
                // For other files, just download them
                const a = document.createElement('a');
                a.href = fileUrl;
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        });
    }

    crudDeleteBtn.style.display = (mode === "edit" && entityKey !== 'pir_documents') ? "inline-block" : "none";
    crudModal.classList.add("show");
  }

  function closeCRUD(){ crudModal.classList.remove("show"); }

  crudCancelBtn.addEventListener("click", closeCRUD);
  // Disable closing the CRUD modal by clicking the backdrop to prevent accidental closure.
  // Keep the Cancel button behavior intact.
  // Previously: close on backdrop click. That behavior is now disabled.
  // crudModal.addEventListener("click", (e)=>{ if(e.target === crudModal) closeCRUD(); });

  crudForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    crudError.textContent = "";
    const entity = crudState.entity;
    let body = {};
    
    if(entity.table === 'pir_documents') {
        const item = crudState.row;
        body.last_updated = document.getElementById('field-pir-last_updated').value || null;
        
        let jsonData = item.data || {};
        let hasData = false;

        // Certificate tracking fields
        const certificateDate = document.getElementById('field-pir-certificate_date')?.value || null;
        const expiryDate = document.getElementById('field-pir-expiry_date')?.value || null;
        const reviewDaysBefore = document.getElementById('field-pir-review_days_before')?.value || null;
        
        if (certificateDate) jsonData.certificate_date = certificateDate;
        if (expiryDate) jsonData.expiry_date = expiryDate;
        if (reviewDaysBefore) jsonData.review_days_before = parseInt(reviewDaysBefore);

        if (item.item_type.includes('textarea')) {
            const val = document.getElementById('field-pir-text_content')?.value || null;
            jsonData.text_content = val;
            if(val) hasData = true;
        }
        if (item.item_type.includes('questions')) {
            jsonData.answers = Array.from(crudFields.querySelectorAll('textarea[data-question-index]')).map(el => el.value);
            if(jsonData.answers.some(a => a)) hasData = true;
        }
        if (item.item_type.includes('number') || item.item_type.includes('dual') || item.item_type.includes('triple')) {
            jsonData.num1 = document.getElementById('field-pir-num1')?.value || null;
            jsonData.num2 = document.getElementById('field-pir-num2')?.value || null;
            jsonData.num3 = document.getElementById('field-pir-num3')?.value || null;
            if(jsonData.num1 || jsonData.num2 || jsonData.num3) hasData = true;
        }
        if (item.item_type.includes('text')) { // dual_text
            jsonData.text1 = document.getElementById('field-pir-text1')?.value || null;
            jsonData.text2 = document.getElementById('field-pir-text2')?.value || null;
            if(jsonData.text1 || jsonData.text2) hasData = true;
        }
        if (item.item_type === 'dynamic_table') {
            jsonData.table_data = item.data.table_data;
            if(jsonData.table_data?.length > 0) hasData = true;
        }
        
        body.data = jsonData;

        const fileInput = document.getElementById('field-pir-file_path');
        let hasFile = !!item.file_path;
        if (fileInput && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const filePath = `${ctx.site_id}/${item.id}/${file.name.replace(/[^a-zA-Z0-9.\-_]/g, '_')}`;
            const { error: uploadError } = await supabase.storage.from('pir_attachments').upload(filePath, file, { upsert: true });
            if (uploadError) throw uploadError;
            body.file_path = filePath;
            hasFile = true;
        }

        // Enhanced status logic with certificate expiry awareness
        if (hasFile || hasData) {
            // Check if certificate is expired or expiring soon
            if (expiryDate) {
                const expiry = new Date(expiryDate);
                const now = new Date();
                const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
                
                if (daysUntilExpiry < 0) {
                    body.status = 'Expired';
                } else if (reviewDaysBefore && daysUntilExpiry <= parseInt(reviewDaysBefore)) {
                    body.status = 'Expiring Soon';
                } else {
                    body.status = 'Ready';
                }
            } else {
                body.status = 'Ready';
            }
        } else {
            body.status = item.item_type.includes('file') ? 'Not Attached' : 'Not Started';
        }

    } else { // Standard entity logic...
        
for (const f of (crudState.entity.fields || [])) {
  // Skip special fields that are handled separately
  if (f.type === "file-upload") continue;
  
  let val;
  if (f.type === "checkbox") {
    val = document.getElementById(`field-${f.name}`).checked;
  } else if (f.type === "select") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "frequency") {
    const n = document.getElementById(`field-${f.name}-n`).value || "1";
    const u = document.getElementById(`field-${f.name}-u`).value || "day";
    val = `${n} ${u}`;
  } else if (f.type === "datetime") {
    // read date + time inputs and combine to ISO
    const dateEl = document.getElementById(`field-${f.name}-date`);
    const timeEl = document.getElementById(`field-${f.name}-time`);
    const nowBtn = document.getElementById(`field-${f.name}-now`);
    let d = dateEl ? dateEl.value : null;
    let t = timeEl ? timeEl.value : null;
    if(!d && !t){ val = null; }
    else {
      // If only date provided, treat time as 00:00; if only time, use today
      if(!d) d = new Date().toISOString().slice(0,10);
      if(!t) t = '00:00';
      const combined = `${d}T${t}:00`;
      const dt = new Date(combined);
      val = isNaN(dt.getTime()) ? null : dt.toISOString();
    }
  } else if (f.type === "age-selector") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
    else val = parseInt(val);
  } else if (f.type === "staff-multi-select") {
    const checkboxes = document.querySelectorAll(`input[name="field-${f.name}"]:checked`);
    val = Array.from(checkboxes).map(cb => cb.value).join(',');
    if (val === "") val = null;
  } else if (f.type === "category-select" || f.type === "status-select" || f.type === "priority-select" || f.type === "avenue-select") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "datepicker") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "textarea") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  }
  body[f.name] = val;
}

    }

    if(ctx.site_id) body.site_id = ctx.site_id;

    // Auto-generate complaint number for new complaints
    if(crudState.mode === "add" && entity.table === "complaints") {
      if(!body.complaint_number) {
        // Get current count of complaints for this site to generate next number
        try {
          const { count } = await supabase
            .from("complaints")
            .select("id", { count: "exact", head: true })
            .eq("site_id", ctx.site_id);
          const nextNum = (count || 0) + 1;
          body.complaint_number = `C${String(nextNum).padStart(4, '0')}`;
        } catch (err) {
          console.warn('Failed to generate complaint number:', err);
          body.complaint_number = `C${Date.now()}`; // fallback
        }
      }
    }

    // Defensive coercion: ensure created_by is a UUID (kiosk_users.id). If not, use current auth user id when available.
    if(body.created_by && !isUUID(body.created_by)){
      if(ctx.user && ctx.user.id){
        console.log('Coercing created_by from', body.created_by, 'to', ctx.user.id);
        body.created_by = ctx.user.id;
      } else {
        // remove invalid value to avoid DB error
        console.log('Removing invalid created_by value:', body.created_by);
        delete body.created_by;
      }
    }
    
    // For complaints, ensure created_by is set if missing
    if(entity.table === 'complaints' && !body.created_by && ctx.user?.id) {
      console.log('Setting created_by to current user:', ctx.user.id);
      body.created_by = ctx.user.id;
    }

    // Basic validation: ensure UUID fields expected by the DB contain valid UUIDs
    // Use the already-coerced value in `body` (post processing). Accept numeric kiosk_user ids
    // (the kiosk_users table uses integer PKs) as valid choices.
    const uuidChecks = [];
    (crudState.entity.fields || []).forEach(f => {
      if (f.name === 'created_by') {
        const candidate = body.created_by;
        if (candidate) {
          // If it looks like a UUID (contains hyphens), require isUUID
          if (String(candidate).includes('-')) {
            if (!isUUID(candidate)) uuidChecks.push({ field: f.name, value: candidate });
          } else {
            // Not a UUID: allow numeric IDs (integers) or fallback to current user
            // Accept values that are all digits
            if (!/^\d+$/.test(String(candidate))) {
              // not a pure integer -> invalid
              uuidChecks.push({ field: f.name, value: candidate });
            }
          }
        }
      }
    });
    if (uuidChecks.length) {
      crudError.textContent = `Please choose valid options for: ${uuidChecks.map(c=>c.field).join(', ')}.`;
      return;
    }

    // Defensive: ensure complaints.datetime (DB NOT NULL) is set. Prefer complaint_date if provided.
    if (entity.table === 'complaints') {
      if (!body.datetime) {
        if (body.complaint_date) {
          // If complaint_date is just a date (YYYY-MM-DD), convert to ISO timestamp at midnight UTC
          try {
            const d = new Date(body.complaint_date);
            if (!isNaN(d.getTime())) body.datetime = d.toISOString();
            else body.datetime = new Date().toISOString();
          } catch (e) {
            body.datetime = new Date().toISOString();
          }
        } else {
          body.datetime = new Date().toISOString();
        }
      }
    }

    try{
      let complaintId = null;
      
      // Debug logging before database operations
      console.log('About to save to database:', {
        mode: crudState.mode,
        table: entity.table,
        body: body,
        context: { 
          site_id: ctx.site_id, 
          user_id: ctx.user?.id,
          pendingAttachment: !!crudState.pendingAttachment 
        }
      });
      
      debugLog('Form Submit', {
        mode: crudState.mode,
        table: entity.table,
        hasAttachment: !!crudState.pendingAttachment,
        bodyKeys: Object.keys(body),
        created_by: body.created_by,
        site_id: body.site_id
      });
      
      if(crudState.mode === "add"){
        const { data, error } = await supabase.from(entity.table).insert(body).select('id').single(); 
        if(error) {
          console.error('Database insert error:', error);
          debugLog('Insert Error', error);
          throw error;
        }
        complaintId = data?.id;
        console.log('Successfully inserted with ID:', complaintId);
      }else{
        const pk = crudState.pk || "id";
        const idv = crudState.row?.[pk];
        if(!idv){ throw new Error("Missing primary key for update."); }
        const { error } = await supabase.from(entity.table).update(body).eq(pk, idv); 
        if(error) throw error;
        complaintId = idv;
      }
      
      // Handle file attachment upload for complaints
      if(entity.table === "complaints" && crudState.pendingAttachment && complaintId) {
        const file = crudState.pendingAttachment.file;
        const fileName = crudState.pendingAttachment.fileName;
        const fileType = crudState.pendingAttachment.fileType;
        const fileSize = crudState.pendingAttachment.fileSize;
        
        try {
          // Sanitize filename
          const safeName = String(fileName).replace(/[^a-zA-Z0-9.\-_]/g, '_');
          const storagePath = `complaints/${ctx.site_id}/${complaintId}/${safeName}`;

          console.log('Uploading attachment to storagePath:', storagePath, { fileType, fileSize });

          // Upload file to Supabase Storage
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('pir_attachments')
            .upload(storagePath, file, { upsert: true, contentType: fileType });

          console.log('uploadData:', uploadData, 'uploadError:', uploadError);

          if (uploadError) {
            console.error('Supabase upload error object:', uploadError);
            throw uploadError;
          }

          // Try to get a public URL; if bucket is private, fall back to a signed URL
          let publicUrl = null;
          try {
            const { data: urlData } = supabase.storage.from('pir_attachments').getPublicUrl(storagePath);
            console.log('getPublicUrl result:', urlData);
            if (urlData && urlData.publicUrl) publicUrl = urlData.publicUrl;
          } catch (e) {
            console.warn('getPublicUrl threw:', e);
          }

          if (!publicUrl && supabase.storage.from('pir_attachments').createSignedUrl) {
            try {
              const { data: signed, error: signedErr } = await supabase.storage.from('pir_attachments').createSignedUrl(storagePath, 60 * 60);
              console.log('createSignedUrl result:', signed, 'err:', signedErr);
              if (!signedErr && signed && signed.signedUrl) publicUrl = signed.signedUrl;
            } catch (e) {
              console.warn('createSignedUrl threw:', e);
            }
          }

          // Save attachment record in complaint_attachments table
          const attachmentRecord = {
            complaint_id: complaintId,
            file_name: safeName,
            file_url: publicUrl || storagePath, // fallback to storage path if no public URL
            file_type: fileType,
            file_size: fileSize,
            attachment_type: 'original',
            uploaded_at: new Date().toISOString()
          };
          
          console.log('Inserting attachment record:', attachmentRecord);
          debugLog('Attachment Insert', { 
            record: attachmentRecord, 
            hasPublicUrl: !!publicUrl,
            storagePath: storagePath 
          });
          
          const { data: attachData, error: attachmentError } = await supabase.from('complaint_attachments').insert(attachmentRecord).select().single();

          console.log('attachment insert result:', { attachData, attachmentError });

          if (attachmentError) throw attachmentError;

          // Clear pending attachment
          crudState.pendingAttachment = null;

        } catch (attachmentErr) {
          console.error('Attachment upload error:', attachmentErr);
          console.error('Full error details:', JSON.stringify(attachmentErr, null, 2));
          
          // Add specific debugging for common RLS/policy issues
          if (attachmentErr.code === '42501') {
            console.error('RLS Policy Error: Check that complaint_attachments table has proper insert policies');
          } else if (attachmentErr.code === '23505') {
            console.error('Unique constraint violation in complaint_attachments');
          } else if (attachmentErr.message && attachmentErr.message.includes('policy')) {
            console.error('Policy violation detected:', attachmentErr.message);
          }
          
          debugLog('Attachment Error', {
            error: attachmentErr,
            complaintId: complaintId,
            fileName: fileName,
            fileSize: fileSize,
            storagePath: typeof storagePath !== 'undefined' ? storagePath : 'undefined'
          });
          
          // Don't fail the entire form submission if attachment fails
          try {
            const errMsg = attachmentErr && attachmentErr.message ? attachmentErr.message : JSON.stringify(attachmentErr);
            crudError.textContent = `Complaint saved, but attachment failed to upload: ${errMsg}`;
          } catch (e) {
            crudError.textContent = `Complaint saved, but attachment failed to upload. Check console for details.`;
          }
          setTimeout(() => { crudError.textContent = ""; closeCRUD(); }, 8000);
          return;
        }
      }
      
      closeCRUD();
      if (entity.table === 'pir_documents') loadAndRenderPIR();
      else await Promise.all([loadCounts(), loadItems(), loadRooms(), loadComplaints(), loadCheckTypes(), loadSchedules(), loadStaff()]);
    } catch(err) {
      crudError.textContent = err.message || String(err);
    }
  });

  crudDeleteBtn.addEventListener("click", async ()=>{
    
for (const f of (crudState.entity.fields || [])) {
  let val;
  if (f.type === "checkbox") {
    val = document.getElementById(`field-${f.name}`).checked;
  } else if (f.type === "select") {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  } else if (f.type === "frequency") {
    const n = document.getElementById(`field-${f.name}-n`).value || "1";
    const u = document.getElementById(`field-${f.name}-u`).value || "day";
    val = `${n} ${u}`;
  } else {
    val = document.getElementById(`field-${f.name}`).value;
    if (val === "") val = null;
  }
  body[f.name] = val;
}

  });

  // ... (All remaining event listeners and functions are unchanged)
  document.getElementById("btn-new-room")?.addEventListener("click", ()=>openCRUD("rooms","add"));
  document.getElementById("btn-new-complaint")?.addEventListener("click", ()=>openCRUD("complaints","add"));
  document.getElementById("btn-new-ct")?.addEventListener("click", ()=>openCRUD("check_types","add"));
  // 'Add Staff' button removed from DOM; leave creation via staff modal or invite flow
  document.getElementById("btn-new-item")?.addEventListener("click", ()=>openCRUD("items","add"));
  document.getElementById("btn-new-sched")?.addEventListener("click", ()=>openCRUD("item_allowed_types","add"));

  document.getElementById('app').addEventListener('click', async (e) => {
    const tr = e.target.closest("tr[data-id]");
    if (!tr) return;
    const tbody = tr.closest("tbody");
    if(!tbody) return;
    if(tbody.id === 'subs-tbody') { showSubmissionDetails(tr.dataset.id); return; }
    const entityKey = tbody.dataset.entity;
    if (entityKey && ENTITIES[entityKey]) {
      const rowId = tr.dataset.id;
      tbody.querySelectorAll("tr.selected").forEach(r => r.classList.remove("selected"));
      tr.classList.add("selected");
      try {
        const { data: rowData, error } = await supabase.from(ENTITIES[entityKey].table).select("*").eq(ENTITIES[entityKey].pk, rowId).maybeSingle();
        if (error) throw error;
        if (rowData) openCRUD(entityKey, "edit", rowData);
      } catch (err) { console.error("Error fetching row for editing:", err); }
    }
  });

  const itemsHead = document.querySelector('#view-items thead');
  if(itemsHead){ itemsHead.addEventListener('click', (e)=>{ const th = e.target.closest('th.sortable'); if(!th) return; const col = th.getAttribute('data-col'); if(itemsSort.col === col){ itemsSort.dir = itemsSort.dir === 'asc' ? 'desc' : 'asc'; }else{ itemsSort.col = col; itemsSort.dir = 'asc'; } loadItems(); }); }
  function activeViewId(){ const v = document.querySelector('section.view.active'); return v ? v.id : ''; }
  document.getElementById('search').addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && activeViewId() === 'view-items'){ e.preventDefault(); itemsQuery = e.target.value.trim(); loadItems(); } });
  document.getElementById("cal-prev")?.addEventListener("click", ()=>{ calendarDate.setMonth(calendarDate.getMonth() - 1); loadAndRenderCalendar(); });
  document.getElementById("cal-next")?.addEventListener("click", ()=>{ calendarDate.setMonth(calendarDate.getMonth() + 1); loadAndRenderCalendar(); });
  document.getElementById("cal-view-switcher")?.addEventListener("click", (e) => { const btn = e.target.closest("button[data-view]"); if (!btn) return; document.querySelectorAll("#cal-view-switcher button").forEach(b => b.classList.remove("active")); btn.classList.add("active"); currentCalendarView = btn.dataset.view; if (currentCalendarView === 'daily') calendarDate = new Date(); loadAndRenderCalendar(); });
  
  const submissionDetailModal = document.getElementById("submission-detail-modal");
  async function showSubmissionDetails(submissionId) {
    submissionDetailModal.classList.add("show");
    submissionDetailModal.dataset.submissionId = submissionId;
    document.getElementById("submission-detail-content").innerHTML = `<div class="muted" style="padding:20px 0; text-align:center;">Loading details...</div>`;
    document.getElementById("submission-detail-title").textContent = `Details for Submission #${submissionId}`;
    console.log('DEBUG showSubmissionDetails: Fetching submission details for ID:', submissionId);
    
    // Get submission rows with all fields
    const { data: rows, error } = await supabase.from('submission_rows').select(`
      id, row_comment, item_id, check_type, check_value, check_type_id, item_pk
    `).eq('submission_id', submissionId);
    
    console.log('DEBUG showSubmissionDetails: Query result:', { rows, error });
    if (error) {
      console.error('Error fetching submission details:', error);
      document.getElementById("submission-detail-content").innerHTML = `<div class="muted" style="padding:20px 0; text-align:center; color:red;">Error loading details: ${error.message}</div>`;
      return;
    }
    if (!rows || rows.length === 0) {
      console.log('DEBUG showSubmissionDetails: No rows found');
      document.getElementById("submission-detail-content").innerHTML = `<div class="muted" style="padding:20px 0; text-align:center;">No items found for this submission.</div>`;
      return;
    }

    // Build the table with the data we have
    let contentHtml = `<div class="table-wrap" style="max-height: 60vh;"><table><thead><tr><th>Item ID</th><th>Check Performed</th><th>Result</th><th>Comment</th></tr></thead><tbody data-entity="submission_rows">`;
    contentHtml += rows.map(r => `<tr data-id="${r.id}">
      <td>${esc(r.item_id || 'Unknown')}</td>
      <td>${esc(r.check_type || 'Unknown Check')}</td>
      <td>${esc(r.check_value || 'Done')}</td>
      <td>${esc(r.row_comment || '-')}</td>
    </tr>`).join('');
    contentHtml += `</tbody></table></div>`;
    console.log('DEBUG showSubmissionDetails: Generated HTML:', contentHtml);
    document.getElementById("submission-detail-content").innerHTML = contentHtml;
  }
  submissionDetailModal.addEventListener("click", (e) => { if (e.target === submissionDetailModal || e.target.closest("#submission-detail-close")) { submissionDetailModal.classList.remove("show"); } });

  // === TRAINING FUNCTIONALITY ===
  // Use var + guard so early calls to loadTrainingMatrix (before this point) don't hit TDZ errors.
  // In previous version this block appeared earlier; moving lots of code pushed it below first invocations.
  // Error observed: "Cannot access uninitialized variable" when loadTrainingMatrix ran before let decls.
  // Switching to var with existing-value guard preserves state if already created earlier.
  // Enhanced Training Matrix with all quick win features
  var trainingData = typeof trainingData !== 'undefined' ? trainingData : { staff: [], types: [], records: [] };
  var currentTrainingTab = typeof currentTrainingTab !== 'undefined' ? currentTrainingTab : 'clinical';
  var trainingFilters = typeof trainingFilters !== 'undefined' ? trainingFilters : {
    search: '',
    status: 'all',
    role: 'all',
    sort: 'name',
    compact: false
  };

  async function loadTrainingMatrix() {
    // Ensure DOM is ready for the training view
    let tbodyEl = document.getElementById('training-tbody');
    if (!tbodyEl) {
      // Training DOM not mounted yet; retry shortly
      try { console.debug('[training] tbody not found yet; retrying shortly'); } catch {}
      setTimeout(loadTrainingMatrix, 100);
      return;
    }
    // If ctx exists now, reset any prior retry counter
    if (window.ctx && window.ctx.site_id) {
      try { window.trainingLoadAttempts = 0; } catch(_){}
    }
    // Show loading state immediately so user sees progress
    tbodyEl.innerHTML = '<tr><td colspan="100%" class="muted">Loading training matrix...</td></tr>';
    // Defensive: ensure the global trainingData object exists. In some build/layout
    // orders loadTrainingMatrix can be invoked before the var declaration below runs,
    // resulting in trainingData being undefined (and accessing trainingData.staff throws).
    if (typeof window.trainingData === 'undefined' || !window.trainingData) {
      window.trainingData = { staff: [], types: [], records: [] };
    }
    // Mirror onto the local/global name used throughout the module
    trainingData = window.trainingData;

    // If ctx.site_id isn't set yet, wait and retry a few times (works both local and prod)
    const host = window.location.hostname;
    if (!window.ctx || !window.ctx.site_id) {
      window.trainingLoadAttempts = (window.trainingLoadAttempts || 0) + 1;
      window.debugLog && window.debugLog('loadTrainingMatrix:waitingForCtx', { host, attempt: window.trainingLoadAttempts });
      if (window.trainingLoadAttempts <= 40) { // ~10 seconds at 250ms
        setTimeout(loadTrainingMatrix, 250);
        return;
      }
    }

    window.debugLog && window.debugLog('loadTrainingMatrix:start', { hasCtx: !!window.ctx, site_id: window.ctx?.site_id });

    try {
      // If after retries ctx is still missing, render a helpful fallback state but do not loop forever
      if (!window.ctx || !ctx.site_id) {
        window.debugLog && window.debugLog('loadTrainingMatrix:noCtx_final');
        document.getElementById('training-tbody').innerHTML = '<tr><td colspan="100%" class="muted">No site context yet. Please wait or reload.</td></tr>';
        return;
      }

  const [staffRes, typesRes, recordsRes] = await Promise.all([
        supabase.from('kiosk_users').select('*').eq('site_id', ctx.site_id),
        supabase.from('training_types').select('*').eq('site_id', ctx.site_id).eq('active', true),
        supabase.from('training_records').select('*').eq('site_id', ctx.site_id)
      ]);

      if (staffRes.error) throw staffRes.error;
      if (typesRes.error) throw typesRes.error;
      if (recordsRes.error) throw recordsRes.error;

  trainingData = {
        staff: staffRes.data || [],
        types: typesRes.data || [],
        records: recordsRes.data || []
      };
      try { window.trainingData = trainingData; } catch(_){}

  window.debugLog && window.debugLog('loadTrainingMatrix:fetched', { staff: (staffRes.data||[]).length, types: (typesRes.data||[]).length, records: (recordsRes.data||[]).length });

      // Initialize controls
      initializeTrainingControls();
      
      // Render with delay to allow DOM to be ready
      setTimeout(() => renderTrainingMatrix(), 10);
    } catch (err) {
      window.debugLog && window.debugLog('loadTrainingMatrix:error', err);
      document.getElementById('training-tbody').innerHTML =
        '<tr><td colspan="100%" class="muted">Failed to load training data: ' + (err?.message || err) + '</td></tr>';
    }
  }

  // Expose loader so early bootstrap shims can retrigger after ctx becomes ready
  try { window.loadTrainingMatrix = loadTrainingMatrix; } catch (_) {}
  try { window.renderTrainingMatrix = renderTrainingMatrix; } catch (_) {}

  function initializeTrainingControls() {
    try {
      const searchInput = document.getElementById('training-search');
    const filterPills = document.querySelectorAll('.filter-pill');
    const densityToggle = document.getElementById('density-toggle');
    const roleFilter = document.getElementById('role-filter');
    const sortSelect = document.getElementById('sort-select');
    const closeDrawer = document.getElementById('close-drawer');

    // Search functionality
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        trainingFilters.search = e.target.value.toLowerCase();
        renderTrainingMatrix();
      });
    }

    // Status filter pills
    filterPills.forEach(pill => {
      pill.addEventListener('click', () => {
        filterPills.forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        trainingFilters.status = pill.dataset.filter;
        renderTrainingMatrix();
      });
    });

    // Density toggle
    if (densityToggle) {
      densityToggle.addEventListener('click', () => {
        trainingFilters.compact = !trainingFilters.compact;
        densityToggle.classList.toggle('active');
        const matrixContainer = document.getElementById('training-matrix-container');
        if (matrixContainer) {
          matrixContainer.classList.toggle('compact', trainingFilters.compact);
        }
      });
    }

    // Role filter
    if (roleFilter) {
      // Populate role options
      const uniqueRoles = [...new Set(trainingData.staff.map(s => s.role).filter(Boolean))];
      roleFilter.innerHTML = '<option value="all">All Roles</option>' + 
        uniqueRoles.map(role => `<option value="${role}">${role}</option>`).join('');
      
      roleFilter.addEventListener('change', (e) => {
        trainingFilters.role = e.target.value;
        renderTrainingMatrix();
      });
    }

    // Sort select
    if (sortSelect) {
      sortSelect.addEventListener('change', (e) => {
        trainingFilters.sort = e.target.value;
        renderTrainingMatrix();
      });
    }

      // Drawer close
      if (closeDrawer) {
        closeDrawer.addEventListener('click', () => {
          document.getElementById('cell-drawer').classList.remove('open');
        });
      }
    } catch (err) {
      console.error('initializeTrainingControls error', err);
      const tbody = document.getElementById('training-tbody');
      if (tbody) tbody.innerHTML = `<tr><td colspan="100%" class="muted">Controls init error: ${esc(err?.message || err)}</td></tr>`;
    }
  }

  function switchTrainingTab(tab) {
    currentTrainingTab = tab;
    document.querySelectorAll('#view-training .tab-controls button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    renderTrainingMatrix();
  }

  function renderTrainingMatrix() {
    try {
      try { window.debugLog && window.debugLog('renderTrainingMatrix:enter', { now: Date.now() }); } catch(_) {}
      if (window.trainingData) { try { trainingData = window.trainingData; } catch(_){} }
      const headers = document.getElementById('training-headers');
      const tbody = document.getElementById('training-tbody');
      
      if (!headers || !tbody) return;

      try { window.debugLog && window.debugLog('renderTrainingMatrix:starting', { staffLen: trainingData.staff?.length, typesLen: trainingData.types?.length }); } catch(_) {}

      // If there's no data loaded, provide a helpful fallback so UI can be inspected
      if ((!trainingData.staff || trainingData.staff.length === 0) || (!trainingData.types || trainingData.types.length === 0)) {
        tbody.innerHTML = `
          <tr><td colspan="100%" class="muted">No training data available.</td></tr>
          <tr><td colspan="100%" style="text-align:center; padding: 16px;">
            <button class="btn secondary" id="btn-use-demo-training">Use demo data to preview matrix</button>
          </td></tr>`;

        const demoBtn = document.getElementById('btn-use-demo-training');
        if (demoBtn) {
          demoBtn.addEventListener('click', () => {
            // Small, non-destructive demo dataset
            trainingData.staff = [
              { id: 1, full_name: 'Alice Example', role: 'Nurse' },
              { id: 2, full_name: 'Bob Example', role: 'HCA' }
            ];
            trainingData.types = [
              { id: 101, name: 'BLS', validity_months: 12 },
              { id: 102, name: 'GDPR', validity_months: 24 }
            ];
            const now = new Date();
            const nextYear = new Date(); nextYear.setMonth(nextYear.getMonth() + 9);
            trainingData.records = [
              { id: 1001, staff_id: 1, training_type_id: 101, completion_date: now.toISOString(), expiry_date: nextYear.toISOString(), provider: 'Acme Training', verified_by: 'Manager' },
              { id: 1002, staff_id: 2, training_type_id: 102, completion_date: now.toISOString(), expiry_date: null, provider: 'Acme Training' }
            ];
            renderTrainingMatrix();
          });
        }

        return;
      }

      // ...existing code continues
    } catch (err) {
      console.error('renderTrainingMatrix error', err);
      const tbody = document.getElementById('training-tbody');
      if (tbody) tbody.innerHTML = `<tr><td colspan="100%" class="muted">Render error: ${esc(err?.message || err)}</td></tr>`;
      return;
    }

    // Filter staff by type and search
    let filteredStaff = trainingData.staff.filter(staff => {
      const isClinical = ['GP', 'Nurse', 'HCA', 'Practice Nurse', 'ANP'].some(role => 
        (staff.role || '').toLowerCase().includes(role.toLowerCase())
      );
      
      const matchesTab = currentTrainingTab === 'clinical' ? isClinical : !isClinical;
      const matchesSearch = !trainingFilters.search || 
        (staff.full_name || '').toLowerCase().includes(trainingFilters.search);
      const matchesRole = trainingFilters.role === 'all' || staff.role === trainingFilters.role;
      
      return matchesTab && matchesSearch && matchesRole;
    });

    // Apply status filter
    if (trainingFilters.status !== 'all') {
      filteredStaff = filteredStaff.filter(staff => {
        const staffRecords = trainingData.records.filter(r => r.staff_id === staff.id);
        const staffStatus = calculateStaffStatus(staff.id, staffRecords);
        return staffStatus === trainingFilters.status;
      });
    }

    // Sort staff
    filteredStaff.sort((a, b) => {
      switch (trainingFilters.sort) {
        case 'compliance':
          const aCompliance = calculateCompliancePercentage(a.id);
          const bCompliance = calculateCompliancePercentage(b.id);
          return bCompliance - aCompliance;
        case 'expiry':
          const aSoonest = getSoonestExpiry(a.id);
          const bSoonest = getSoonestExpiry(b.id);
          if (!aSoonest && !bSoonest) return 0;
          if (!aSoonest) return 1;
          if (!bSoonest) return -1;
          return new Date(aSoonest) - new Date(bSoonest);
        case 'overdue':
          const aOverdue = getOverdueCount(a.id);
          const bOverdue = getOverdueCount(b.id);
          return bOverdue - aOverdue;
        default:
          return (a.full_name || '').localeCompare(b.full_name || '');
      }
    });

    // Build sortable headers
    headers.innerHTML = '<th>Staff Member</th>' + 
      trainingData.types.map(type => `
        <th class="sortable" data-type-id="${type.id}" title="${esc(type.description || type.name)}">
          ${esc(type.name)}
        </th>
      `).join('');

    // Add column sort handlers
    headers.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        sortByColumn(th.dataset.typeId);
      });
    });

    // Build matrix rows
    if (filteredStaff.length === 0) {
      tbody.innerHTML = `<tr><td colspan="${trainingData.types.length + 1}" class="muted">No ${currentTrainingTab} staff found</td></tr>`;
    } else {
      tbody.innerHTML = filteredStaff.map(staff => {
        const staffRecords = trainingData.records.filter(r => r.staff_id === staff.id);
        const compliance = calculateCompliancePercentage(staff.id);
        
        const cells = trainingData.types.map(type => {
          const record = staffRecords.find(r => r.training_type_id === type.id);
          return renderTrainingCell(staff.id, type.id, record, staff, type);
        }).join('');
        
        return `<tr>
          <td title="${esc(staff.full_name)} - ${compliance}% compliant">${esc(staff.full_name || 'Unknown')}<br><small class="compliance-badge">${compliance}% compliant</small></td>
          ${cells}
        </tr>`;
      }).join('');
    }

    // Update counts and legend
    updateFilterCounts(filteredStaff);
    
    // Add click handlers for cells
    tbody.querySelectorAll('.training-cell').forEach(cell => {
      cell.addEventListener('click', () => {
        const staffId = cell.dataset.staffId;
        const typeId = cell.dataset.typeId;
        openCellDrawer(staffId, typeId);
      });
    });
  }

  function renderTrainingCell(staffId, typeId, record, staff, type) {
    const today = new Date();
    let status = 'training-missing';
    let content = '—';
    let tooltipText = 'No record found';
    
    if (record) {
      const completionDate = new Date(record.completion_date);
      const expiryDate = record.expiry_date ? new Date(record.expiry_date) : null;
      
      if (expiryDate) {
        const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysToExpiry < 0) {
          status = 'training-expired';
          content = `Expired`;
          tooltipText = `Expired ${Math.abs(daysToExpiry)} days ago\\nCompleted: ${fmtDateShort(record.completion_date)}\\nExpired: ${fmtDateShort(record.expiry_date)}`;
        } else if (daysToExpiry <= 30) {
          status = 'training-expiring';
          content = `${daysToExpiry}d`;
          tooltipText = `Expires in ${daysToExpiry} days\\nCompleted: ${fmtDateShort(record.completion_date)}\\nExpires: ${fmtDateShort(record.expiry_date)}`;
        } else {
          status = 'training-completed';
          content = `✓`;
          tooltipText = `Valid until ${fmtDateShort(record.expiry_date)}\\nCompleted: ${fmtDateShort(record.completion_date)}`;
        }
      } else {
        status = 'training-completed';
        content = `✓`;
        tooltipText = `Completed: ${fmtDateShort(record.completion_date)}\\nNo expiry date`;
      }
      
      if (record.verified_by) {
        tooltipText += `\\nVerified by: ${record.verified_by}`;
      }
    }

    return `<td class="training-cell ${status}" data-staff-id="${staffId}" data-type-id="${typeId}" title="${tooltipText}">
      ${content}
      <div class="training-tooltip">${tooltipText.replace(/\\n/g, '<br>')}</div>
    </td>`;
  }

  function calculateStaffStatus(staffId, staffRecords) {
    const today = new Date();
    let hasExpired = false;
    let hasExpiring = false;
    let hasValid = false;
    let hasMissing = false;

    trainingData.types.forEach(type => {
      const record = staffRecords.find(r => r.training_type_id === type.id);
      
      if (!record) {
        hasMissing = true;
      } else if (record.expiry_date) {
        const expiryDate = new Date(record.expiry_date);
        const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysToExpiry < 0) {
          hasExpired = true;
        } else if (daysToExpiry <= 30) {
          hasExpiring = true;
        } else {
          hasValid = true;
        }
      } else {
        hasValid = true;
      }
    });

    // Priority order: expired > expiring > missing > valid
    if (hasExpired) return 'expired';
    if (hasExpiring) return 'expiring';
    if (hasMissing) return 'missing';
    return 'valid';
  }

  function calculateCompliancePercentage(staffId) {
    const staffRecords = trainingData.records.filter(r => r.staff_id === staffId);
    const today = new Date();
    let compliantCount = 0;
    
    trainingData.types.forEach(type => {
      const record = staffRecords.find(r => r.training_type_id === type.id);
      
      if (record) {
        if (!record.expiry_date) {
          compliantCount++;
        } else {
          const expiryDate = new Date(record.expiry_date);
          if (expiryDate >= today) {
            compliantCount++;
          }
        }
      }
    });
    
    return trainingData.types.length > 0 ? Math.round((compliantCount / trainingData.types.length) * 100) : 0;
  }

  function getSoonestExpiry(staffId) {
    const staffRecords = trainingData.records.filter(r => r.staff_id === staffId);
    const today = new Date();
    let soonestExpiry = null;
    
    staffRecords.forEach(record => {
      if (record.expiry_date) {
        const expiryDate = new Date(record.expiry_date);
        if (expiryDate >= today && (!soonestExpiry || expiryDate < new Date(soonestExpiry))) {
          soonestExpiry = record.expiry_date;
        }
      }
    });
    
    return soonestExpiry;
  }

  function getOverdueCount(staffId) {
    const staffRecords = trainingData.records.filter(r => r.staff_id === staffId);
    const today = new Date();
    let overdueCount = 0;
    
    staffRecords.forEach(record => {
      if (record.expiry_date) {
        const expiryDate = new Date(record.expiry_date);
        if (expiryDate < today) {
          overdueCount++;
        }
      }
    });
    
    // Add missing records as overdue
    const missingCount = trainingData.types.length - staffRecords.length;
    return overdueCount + missingCount;
  }

  function updateFilterCounts(filteredStaff) {
    let counts = { all: 0, missing: 0, expiring: 0, expired: 0, valid: 0 };
    
    trainingData.staff.forEach(staff => {
      const staffRecords = trainingData.records.filter(r => r.staff_id === staff.id);
      const status = calculateStaffStatus(staff.id, staffRecords);
      counts.all++;
      counts[status]++;
    });

    // Update filter pills
    Object.keys(counts).forEach(status => {
      const countElement = document.getElementById(`count-${status}`);
      if (countElement) {
        countElement.textContent = counts[status];
      }
    });

    // Update legend counts
    const legendCounts = {
      'legend-valid-count': counts.valid,
      'legend-expiring-count': counts.expiring,
      'legend-expired-count': counts.expired,
      'legend-missing-count': counts.missing
    };

    Object.entries(legendCounts).forEach(([id, count]) => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = count;
      }
    });
  }

  function sortByColumn(typeId) {
    // Toggle sort state for column
    const th = document.querySelector(`th[data-type-id="${typeId}"]`);
    const currentSort = th.dataset.sort || 'none';
    
    // Clear other sorts
    document.querySelectorAll('th.sortable').forEach(header => {
      header.classList.remove('sort-asc', 'sort-desc');
      delete header.dataset.sort;
    });
    
    // Apply new sort
    if (currentSort === 'none' || currentSort === 'desc') {
      th.classList.add('sort-asc');
      th.dataset.sort = 'asc';
    } else {
      th.classList.add('sort-desc');
      th.dataset.sort = 'desc';
    }
    
    // Re-render with custom sort
    renderTrainingMatrix();
  }

  function openCellDrawer(staffId, typeId) {
    const staff = trainingData.staff.find(s => s.id == staffId);
    const type = trainingData.types.find(t => t.id == typeId);
    const record = trainingData.records.find(r => r.staff_id == staffId && r.training_type_id == typeId);

    if (!staff || !type) return;

    // Populate drawer
    document.getElementById('drawer-staff-name').textContent = staff.full_name || 'Unknown';
    document.getElementById('drawer-module-name').textContent = type.name;
    
    if (record) {
      const today = new Date();
      const expiryDate = record.expiry_date ? new Date(record.expiry_date) : null;
      let statusText = 'Completed';
      
      if (expiryDate) {
        const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        if (daysToExpiry < 0) {
          statusText = `Expired (${Math.abs(daysToExpiry)} days ago)`;
        } else if (daysToExpiry <= 30) {
          statusText = `Expiring in ${daysToExpiry} days`;
        } else {
          statusText = 'Valid';
        }
      }
      
      document.getElementById('drawer-status').textContent = statusText;
      document.getElementById('drawer-issue-date').textContent = record.completion_date ? fmtDateShort(record.completion_date) : '-';
      document.getElementById('drawer-expiry-date').textContent = record.expiry_date ? fmtDateShort(record.expiry_date) : 'No expiry';
      document.getElementById('drawer-provider').textContent = record.provider || '-';
      document.getElementById('drawer-evidence').textContent = record.certificate_url ? 'Certificate on file' : 'No evidence';
      document.getElementById('drawer-notes').textContent = record.notes || '-';
      document.getElementById('drawer-verified').textContent = record.verified_by ? `${record.verified_by} on ${fmtDateShort(record.verified_date)}` : 'Not verified';
    } else {
      document.getElementById('drawer-status').textContent = 'No record';
      document.getElementById('drawer-issue-date').textContent = '-';
      document.getElementById('drawer-expiry-date').textContent = '-';
      document.getElementById('drawer-provider').textContent = '-';
      document.getElementById('drawer-evidence').textContent = 'No evidence';
      document.getElementById('drawer-notes').textContent = '-';
      document.getElementById('drawer-verified').textContent = 'Not verified';
    }

    // Set up action buttons
    setupDrawerActions(staffId, typeId, record);
    
    // Open drawer
    document.getElementById('cell-drawer').classList.add('open');
  }

  function setupDrawerActions(staffId, typeId, record) {
    const uploadBtn = document.getElementById('drawer-upload');
    const replaceBtn = document.getElementById('drawer-replace');
    const reviewBtn = document.getElementById('drawer-review');
    const reminderBtn = document.getElementById('drawer-reminder');

    // Clear previous handlers
    [uploadBtn, replaceBtn, reviewBtn, reminderBtn].forEach(btn => {
      if (btn) btn.replaceWith(btn.cloneNode(true));
    });

    // Upload/Replace handler
    const newUploadBtn = document.getElementById('drawer-upload');
    const newReplaceBtn = document.getElementById('drawer-replace');
    
    if (newUploadBtn) {
      newUploadBtn.addEventListener('click', () => openTrainingModal(staffId, typeId));
    }
    if (newReplaceBtn) {
      newReplaceBtn.addEventListener('click', () => openTrainingModal(staffId, typeId));
    }

    // Mark as reviewed handler
    const newReviewBtn = document.getElementById('drawer-review');
    if (newReviewBtn) {
      newReviewBtn.addEventListener('click', async () => {
        if (record) {
          try {
            await supabase.from('training_records')
              .update({ 
                verified_by: ctx.user?.email || 'System',
                verified_date: new Date().toISOString()
              })
              .eq('id', record.id);
            
            showToast('Record marked as reviewed', 'success');
            loadTrainingMatrix();
          } catch (err) {
            showToast('Failed to mark as reviewed: ' + err.message, 'error');
          }
        }
      });
    }

    // Send reminder handler
    const newReminderBtn = document.getElementById('drawer-reminder');
    if (newReminderBtn) {
      newReminderBtn.addEventListener('click', () => {
        showToast('Reminder functionality coming soon', 'info');
      });
    }
  }

  function closeTrainingModal() {
    document.getElementById('training-modal').classList.remove('show');
    document.getElementById('training-error').style.display = 'none';
    document.getElementById('training-form').reset();
  }

  async function handleTrainingFileUpload() {
    const fileInput = document.getElementById('training-certificate');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    if (file.size > 10 * 1024 * 1024) {
      document.getElementById('training-error').textContent = 'File size must be less than 10MB';
      document.getElementById('training-error').style.display = 'block';
      return;
    }

    // Show file selected
    const uploadZone = document.getElementById('training-upload-zone');
    uploadZone.innerHTML = `
      <div style="color: var(--success);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        <p style="margin-top: 8px;">Selected: ${file.name}</p>
      </div>
    `;
  }

  function calculateTrainingExpiry() {
    const completionDate = document.getElementById('training-completion-date').value;
    const typeId = document.getElementById('training-type-id').value;
    
    if (!completionDate || !typeId) return;
    
    // Find the training type to get validity period
    const trainingType = trainingData.types.find(t => t.id == typeId);
    if (!trainingType || !trainingType.validity_months) return;
    
    // Calculate expiry date
    const completion = new Date(completionDate);
    const expiry = new Date(completion);
    expiry.setMonth(expiry.getMonth() + trainingType.validity_months);
    
    // Set the expiry date field
    const expiryField = document.getElementById('training-expiry-date');
    expiryField.value = expiry.toISOString().split('T')[0];
  }

  async function saveTrainingRecord(e) {
    e.preventDefault();
    
    const errorDiv = document.getElementById('training-error');
    errorDiv.style.display = 'none';

    try {
      const staffId = document.getElementById('training-staff-id').value;
      const typeId = document.getElementById('training-type-id').value;
      const completionDate = document.getElementById('training-completion-date').value;
      const expiryDate = document.getElementById('training-expiry-date').value;
      const notes = document.getElementById('training-notes').value;
      const fileInput = document.getElementById('training-certificate');
      
      let certificateUrl = null;

      // Upload certificate if provided
      if (fileInput.files[0]) {
        const file = fileInput.files[0];
        const fileName = `training-${staffId}-${typeId}-${Date.now()}.${file.name.split('.').pop()}`;
        
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('training-certificates')
          .upload(fileName, file);

        if (uploadError) throw uploadError;
        
        const { data: urlData } = supabase.storage
          .from('training-certificates')
          .getPublicUrl(fileName);
          
        certificateUrl = urlData.publicUrl;
      }

      // Save or update training record
      const recordData = {
        site_id: ctx.site_id,
        staff_id: parseInt(staffId),
        training_type_id: parseInt(typeId),
        completion_date: completionDate,
        expiry_date: expiryDate || null,
        notes: notes || null,
        certificate_url: certificateUrl
      };

      const existingRecord = trainingData.records.find(r => 
        r.staff_id == staffId && r.training_type_id == typeId
      );

      if (existingRecord) {
        const { error } = await supabase
          .from('training_records')
          .update(recordData)
          .eq('id', existingRecord.id);
        if (error) throw error;
      } else {
        const { error } = await supabase
          .from('training_records')
          .insert(recordData);
        if (error) throw error;
      }

      closeTrainingModal();
      loadTrainingMatrix();
    } catch (err) {
      console.error('Failed to save training record:', err);
      errorDiv.textContent = err.message || 'Failed to save training record';
      errorDiv.style.display = 'block';
    }
  }

  // Global function for downloading training certificates
  window.downloadTrainingCertificate = function() {
    const staffId = document.getElementById('training-staff-id').value;
    const typeId = document.getElementById('training-type-id').value;
    const record = trainingData.records.find(r => 
      r.staff_id == staffId && r.training_type_id == typeId
    );
    
    if (record?.certificate_url) {
      window.open(record.certificate_url, '_blank');
    }
  };

  // Logout function
  window.logout = async function() {
    try {
      await supabase.auth.signOut();
      showAuth(true);
    } catch (error) {
      console.error('Logout failed:', error);
      // Force logout anyway
      showAuth(true);
    }
  };

  document.addEventListener("DOMContentLoaded", bootstrap);
</script>
  
  <div id="crud-modal" class="auth" aria-hidden="true">
    <div class="card" style="width:min(620px,95vw)">
      <h2 id="crud-title">Edit</h2>
      <form id="crud-form">
        <div id="crud-fields"></div>
        <div style="display:flex; gap:8px; margin-top:12px">
          <button type="submit" class="btn" id="crud-save">Save</button>
          <button type="button" class="btn secondary" id="crud-cancel">Cancel</button>
          <button type="button" class="btn secondary" id="crud-delete" style="margin-left:auto; background:#ff6b6b33; border:1px solid #ff6b6b55">Delete</button>
        </div>
        <div class="error" id="crud-error" role="alert"></div>
      </form>
    </div>
  </div>
  
  <div id="submission-detail-modal" class="auth" aria-hidden="true">
    <div class="card" style="width:min(800px, 95vw)">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="submission-detail-title" style="margin:0;">Submission Details</h2>
        <button id="submission-detail-close" class="btn secondary" style="padding: 6px; line-height: 0;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div class="hint">Click on a row to amend the check type or comment.</div>
      <div id="submission-detail-content" style="margin-top:12px;"></div>
    </div>
  </div>
  <script>

  // Instrument file selection and upload points if present
  (function instrumentDebugging(){
    const fileInput = document.getElementById('field-attachment');
    if(fileInput){
      fileInput.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        debugLog('file selected', f ? { name: f.name, size: f.size, type: f.type } : 'no-file');
      });
    }

    // Hook into save button to dump pendingAttachment
    const saveBtn = document.getElementById('crud-save');
    if(saveBtn){
      saveBtn.addEventListener('click', ()=>{
        debugLog('Save clicked. pendingAttachment', window.crudState ? window.crudState.pendingAttachment : null);
      });
    }

    // AI Populate logic for complaints form (using event delegation for dynamic buttons)
    (function(){
      function setStatus(statusEl, msg){ if(statusEl) statusEl.textContent = msg || ''; }
      function getEl(...selectors){ for(const s of selectors){ const el=document.querySelector(s); if(el) return el; } return null; }

      // Use event delegation to handle dynamically created AI buttons
      document.addEventListener('click', async function(event) {
        if (!event.target.classList.contains('ai-populate-btn')) return;
        
        const btn = event.target;
        const btnId = btn.id;
        const statusId = btnId.replace('ai-populate-btn-', 'ai-status-');
        const statusEl = document.getElementById(statusId);
        
        // Find the associated file input - extract field ID from button ID
        const fieldId = btnId.replace('ai-populate-btn-', '');
        const fileInput = document.getElementById(fieldId);
        
        debugLog('AI button clicked', {buttonId: btnId, fieldId: fieldId, fileInputFound: !!fileInput, hasFiles: fileInput?.files?.length > 0});
        
        if (!fileInput || !fileInput.files.length){
          setStatus(statusEl, 'Choose a file first.'); 
          debugLog('No file input or files found', {fileInput: !!fileInput, filesLength: fileInput?.files?.length});
          return;
        }
        
        const file = fileInput.files[0];
        debugLog('AI button clicked', {buttonId: btnId, fileName: file.name, fileSize: file.size});
        
        // Get form field elements
        const elDate = getEl('#field-complaint_date');
        const elPatient = getEl('#field-patient_initials');
        const elAge = getEl('#field-age');
        const elSummary = getEl('#field-complaint_summary');
        const elOrig = getEl('#field-original_complaint');
        const elResp = getEl('#field-response');
        const elLessons = getEl('#field-lessons_learned');
        const elCategory = getEl('#field-category');
        const elCategoryTrends = getEl('#field-category_trends');
        const elSolution = getEl('#field-solution_given');
        const elSuggestions = getEl('#field-suggestions_prevent_reoccurrence');
        const elActions = getEl('#field-actions_to_be_taken');
        const elPeopleInvolved = getEl('#field-people_involved');
        const elAvenue = getEl('#field-avenue_used');
        const elStatus = getEl('#field-status');
        const elPriority = getEl('#field-priority');
        const elResponseSent = getEl('#field-response_sent');
        const elCreatedBy = getEl('#field-created_by');

        btn.disabled = true; 
        setStatus(statusEl, 'Processing…');
        
        try {
          let textContent = '';
          
          // Extract text based on file type
          if (file.type === 'text/plain') {
            textContent = await file.text();
            debugLog('Text file processed', {length: textContent.length});
          } else if (file.type === 'application/pdf') {
            setStatus(statusEl, 'Extracting text from PDF…');
            try {
              const arrayBuffer = await file.arrayBuffer();
              const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
              debugLog('PDF loaded', {numPages: pdf.numPages});
              
              let pdfText = '';
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                pdfText += pageText + '\n';
              }
              textContent = pdfText.trim();
              debugLog('PDF text extracted', {length: textContent.length});
            } catch (pdfError) {
              debugLog('PDF extraction error', pdfError);
              setStatus(statusEl, 'Error extracting text from PDF. Try a text file instead.');
              btn.disabled = false;
              return;
            }
          } else if (file.type.includes('word') || file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
            setStatus(statusEl, 'Word document processing - please use PDF or text files');
            btn.disabled = false;
            return;
          } else {
            setStatus(statusEl, 'Please upload a PDF or text (.txt) file for AI processing.');
            btn.disabled = false;
            return;
          }
          
          if (!textContent || textContent.length < 10) {
            setStatus(statusEl, 'File appears to be empty or too short.');
            btn.disabled = false;
            return;
          }
          
          debugLog('Calling extract-complaint function', {textLength: textContent.length});
          setStatus(statusEl, 'Calling AI service…');
          
          const { data, error } = await supabase.functions.invoke('extract-complaint', { 
            body: { text: textContent }
          });
          
          debugLog('AI function response', {data, error});
          
          if (error) {
            debugLog('AI function error', error);
            throw error;
          }
          
          if (!data || !data.success) {
            const errorMsg = data?.error || 'Unknown error from AI service';
            debugLog('AI service error', errorMsg);
            throw new Error(errorMsg);
          }
          
          const d = data.data || {};
          debugLog('AI extracted data', d);
          debugLog('Form elements found', {
            date: !!elDate,
            patient: !!elPatient,
            age: !!elAge,
            summary: !!elSummary,
            original: !!elOrig,
            response: !!elResp,
            lessons: !!elLessons,
            category: !!elCategory,
            categoryTrends: !!elCategoryTrends,
            solution: !!elSolution,
            suggestions: !!elSuggestions,
            actions: !!elActions,
            peopleInvolved: !!elPeopleInvolved,
            avenue: !!elAvenue,
            status: !!elStatus,
            priority: !!elPriority,
            responseSent: !!elResponseSent,
            createdBy: !!elCreatedBy
          });
          
          // Populate all form fields
          if (elDate && d.complaint_date) {
            elDate.value = d.complaint_date;
            debugLog('Populated complaint date', d.complaint_date);
          }
          if (elPatient && d.patient_initials) {
            elPatient.value = d.patient_initials;
            debugLog('Populated patient initials', d.patient_initials);
          }
          if (elAge && d.age) {
            elAge.value = d.age;
            debugLog('Populated age', d.age);
          }
          if (elSummary && d.complaint_summary) {
            elSummary.value = d.complaint_summary;
            debugLog('Populated summary', d.complaint_summary);
          }
          if (elOrig && d.original_complaint) {
            elOrig.value = d.original_complaint;
            debugLog('Populated original complaint', d.original_complaint);
          }
          if (elResp && d.response) {
            elResp.value = d.response;
            debugLog('Populated response', d.response);
          }
          if (elLessons && d.lessons_learned) {
            elLessons.value = d.lessons_learned;
            debugLog('Populated lessons learned', d.lessons_learned);
          }
          if (elCategory && d.category) {
            elCategory.value = d.category;
            debugLog('Populated category', d.category);
          }
          if (elCategoryTrends && d.category_trends) {
            elCategoryTrends.value = d.category_trends;
            debugLog('Populated category trends', d.category_trends);
          }
          if (elSolution && d.solution_given) {
            elSolution.value = d.solution_given;
            debugLog('Populated solution given', d.solution_given);
          }
          if (elSuggestions && d.suggestions_prevent_reoccurrence) {
            elSuggestions.value = d.suggestions_prevent_reoccurrence;
            debugLog('Populated suggestions', d.suggestions_prevent_reoccurrence);
          }
          if (elActions && d.actions_to_be_taken) {
            elActions.value = d.actions_to_be_taken;
            debugLog('Populated actions', d.actions_to_be_taken);
          }
          if (elAvenue && d.avenue_used) {
            elAvenue.value = d.avenue_used;
            debugLog('Populated avenue used', d.avenue_used);
          }
          if (elStatus && d.status) {
            elStatus.value = d.status;
            debugLog('Populated status', d.status);
          }
          if (elPriority && d.priority) {
            elPriority.value = d.priority;
            debugLog('Populated priority', d.priority);
          }
          if (elResponseSent && typeof d.response_sent === 'boolean') {
            elResponseSent.checked = d.response_sent;
            debugLog('Populated response sent', d.response_sent);
          }
          // Set created_by to current user
          if (elCreatedBy && ctx.user && ctx.user.id) {
            elCreatedBy.value = ctx.user.id;
            debugLog('Set created_by to current user', ctx.user.id);
          }
          // Handle people_involved (multi-select field)
          if (elPeopleInvolved && d.people_involved && Array.isArray(d.people_involved)) {
            // For multi-select, we'd need to match names to IDs from the staff list
            debugLog('People involved names extracted', d.people_involved);
            // Note: Actual ID mapping would require matching against kiosk_users table
          }
          
          setStatus(statusEl, '✓ Filled by AI — please review.');
          debugLog('Form populated successfully');
          
        } catch(e) {
          console.error('AI processing error:', e); 
          debugLog('AI error details', {message: e.message, stack: e.stack, error: e});
          setStatus(statusEl, 'AI error: ' + (e.message || e));
        } finally { 
          btn.disabled = false; 
        }
      });
    })();

  })();

  </script>
  
  <!-- Help Modal -->
  <div id="help-modal" class="help-modal">
    <div class="help-modal-content">
      <div class="help-modal-header">
        <h3 id="help-modal-title" class="help-modal-title">Page Help</h3>
        <button id="help-modal-close" class="help-modal-close">✕</button>
      </div>
      <div id="help-modal-body" class="help-modal-body">
        <!-- Content populated by JavaScript -->
      </div>
    </div>
  </div>
  
 </body>
 </html>
  <script>
    // === Quiz: Raw Supabase Table Renderer ===
    (function(){
      function escapeHtml(str){
        return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
      }

      async function loadQuizRawTable(){
        const thead = document.getElementById('quiz-thead');
        const tbody = document.getElementById('quiz-tbody');
        if(!thead || !tbody){ return; }
        tbody.innerHTML = '<tr><td colspan="999" class="muted">Loading…</td></tr>';
        try{
          let query = supabase.from('quiz_questions').select('*');
          if(window.ctx && ctx.site_id){ query = query.eq('site_id', ctx.site_id); }
          const { data, error } = await query;
          if(error) throw error;
          const rows = Array.isArray(data) ? data : [];

          // Build columns dynamically from union of keys
          const keys = rows.length ? Array.from(new Set(rows.flatMap(r => Object.keys(r)))) : [];
          if(keys.length === 0){
            thead.innerHTML = '<tr><th class="muted">No columns</th></tr>';
            tbody.innerHTML = '<tr><td class="muted">No rows</td></tr>';
          } else {
            thead.innerHTML = '<tr>' + keys.map(k => `<th>${escapeHtml(k)}</th>`).join('') + '</tr>';
            tbody.innerHTML = rows.map(r => {
              return '<tr>' + keys.map(k => `<td>${escapeHtml(r[k] ?? '')}</td>`).join('') + '</tr>';
            }).join('');
          }

          // Update badge with count
          const badge = document.getElementById('badge-quiz');
          if(badge){ badge.textContent = rows.length ? String(rows.length) : ''; }
        }catch(err){
          console.error(err);
          thead.innerHTML = '';
          tbody.innerHTML = `<tr><td colspan="999" class="muted">Error: ${escapeHtml(err?.message || err)}</td></tr>`;
        }
      }

      // Load when the Quiz nav button is clicked
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('btn-quiz-refresh')?.addEventListener('click', loadQuizRawTable);

        const quizBtn = document.querySelector('nav [data-section="quiz"]');
        quizBtn?.addEventListener('click', () => setTimeout(loadQuizRawTable, 30));

        // Also observe the section becoming active (covers programmatic routing)
        const view = document.getElementById('view-quiz');
        if(view){
          const obs = new MutationObserver(() => {
            if(view.classList.contains('active') && !view.dataset._loaded){
              view.dataset._loaded = '1';
              loadQuizRawTable();
            }
          });
          obs.observe(view, { attributes:true, attributeFilter:['class'] });

          // If already active on load, render immediately
          if(view.classList.contains('active')){ loadQuizRawTable(); }
        }
      });

      // Expose for console/debug
      window.loadQuizRawTable = loadQuizRawTable;
    })();

    // Preview modal functions
    function showPdfPreview(fileUrl, fileName) {
        // Create preview modal if it doesn't exist
        let previewModal = document.getElementById('pdf-preview-modal');
        if (!previewModal) {
            previewModal = document.createElement('div');
            previewModal.id = 'pdf-preview-modal';
            previewModal.className = 'modal';
            previewModal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
                    <div class="modal-header">
                        <h3>Document Preview: <span id="preview-file-name"></span></h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body" style="height: 80vh; padding: 0;">
                        <iframe id="pdf-viewer" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </div>
            `;
            document.body.appendChild(previewModal);

            // Close modal handlers
            previewModal.addEventListener('click', (e) => {
                if (e.target === previewModal || e.target.classList.contains('modal-close')) {
                    previewModal.classList.remove('show');
                    URL.revokeObjectURL(document.getElementById('pdf-viewer').src);
                }
            });
        }

        document.getElementById('preview-file-name').textContent = fileName;
        document.getElementById('pdf-viewer').src = fileUrl;
        previewModal.classList.add('show');
    }

    function showDocumentMetadata(fileName, fileSize) {
        const formatFileSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const getFileType = (name) => {
            const ext = name.split('.').pop().toLowerCase();
            const types = {
                'doc': 'Word Document',
                'docx': 'Word Document',
                'xls': 'Excel Spreadsheet', 
                'xlsx': 'Excel Spreadsheet',
                'ppt': 'PowerPoint Presentation',
                'pptx': 'PowerPoint Presentation'
            };
            return types[ext] || 'Document';
        };

        showToast(`📄 ${getFileType(fileName)} - ${formatFileSize(fileSize)}\nClick Download to open`, 'info');
    }

    // Initialize all PIR enhancements when document loads
    document.addEventListener('DOMContentLoaded', () => {
        initializeDraftTextSupport();
        
        // Initialize bulk operations toggle
        const bulkToggle = document.getElementById('bulk-select-toggle');
        if (bulkToggle) {
            bulkToggle.addEventListener('change', () => {
                document.getElementById('pre-inspection-view').classList.toggle('bulk-mode', bulkToggle.checked);
            });
        }
    });

    // PDF Preview and Document Metadata Functions
    function showPdfPreview(fileUrl, fileName) {
      // Create modal for PDF preview
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.zIndex = '2000';
      modal.innerHTML = `
        <div class="modal-content" style="width: 90vw; height: 90vh; max-width: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3>Preview: ${fileName}</h3>
            <button class="btn secondary modal-close">×</button>
          </div>
          <iframe src="${fileUrl}" style="width: 100%; height: calc(90vh - 100px); border: 1px solid var(--border-color); border-radius: 8px;"></iframe>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.classList.add('show');
      
      // Close handlers
      modal.querySelector('.modal-close').addEventListener('click', () => {
        modal.remove();
        URL.revokeObjectURL(fileUrl);
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
          URL.revokeObjectURL(fileUrl);
        }
      });
    }

    function showDocumentMetadata(fileName, fileSize) {
      const fileSizeFormatted = (fileSize / 1024).toFixed(1) + ' KB';
      const fileExtension = fileName.split('.').pop().toUpperCase();
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.zIndex = '2000';
      modal.innerHTML = `
        <div class="modal-content" style="width: min(400px, 90vw);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3>Document Information</h3>
            <button class="btn secondary modal-close">×</button>
          </div>
          <div class="field">
            <label>File Name</label>
            <div style="padding: 8px 0; word-break: break-all;">${fileName}</div>
          </div>
          <div class="field">
            <label>File Type</label>
            <div style="padding: 8px 0;">${fileExtension} Document</div>
          </div>
          <div class="field">
            <label>File Size</label>
            <div style="padding: 8px 0;">${fileSizeFormatted}</div>
          </div>
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); color: var(--muted); font-size: 12px;">
            💡 To preview ${fileExtension} files, download and open in the appropriate application.
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      modal.classList.add('show');
      
      // Close handlers
      modal.querySelector('.modal-close').addEventListener('click', () => {
        modal.remove();
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // Initialize draft text support when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      initializeDraftTextSupport();
    });

    // Initialize if DOM is already ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeDraftTextSupport);
    } else {
      initializeDraftTextSupport();
    }

  </script>

<script>
// Sidebar resize functionality
document.addEventListener('DOMContentLoaded', () => {
  const sidebar = document.getElementById('sidebar');
  const app = document.getElementById('app');
  const resizeHandle = document.getElementById('sidebar-resize-handle');
  const toggleButton = document.getElementById('toggleSidebar');
  
  let isResizing = false;
  let startX = 0;
  let startWidth = 0;
  const minWidth = 56; // Collapsed width
  const maxWidth = 400; // Maximum sidebar width
  const defaultWidth = 260; // Default sidebar width
  
  // Get current sidebar width from CSS variable
  function getCurrentSidebarWidth() {
    const computedStyle = getComputedStyle(app);
    const sidebarWidth = computedStyle.getPropertyValue('--sidebarW');
    return parseInt(sidebarWidth) || defaultWidth;
  }
  
  // Set sidebar width with optional transition control
  function setSidebarWidth(width, enableTransition = true) {
    // Disable transitions during drag for smoothness
    if (!enableTransition) {
      app.style.transition = 'none';
    } else {
      app.style.transition = '';
    }
    
    app.style.setProperty('--sidebarW', width + 'px');
    
    // Auto-collapse when dragged to minimum width
    if (width <= minWidth) {
      app.classList.add('collapsed');
      toggleButton.setAttribute('aria-expanded', 'false');
    } else if (app.classList.contains('collapsed')) {
      app.classList.remove('collapsed');
      toggleButton.setAttribute('aria-expanded', 'true');
    }
  }
  
  // Throttle function for smooth resize
  function throttle(func, limit) {
    let inThrottle;
    return function() {
      const args = arguments;
      const context = this;
      if (!inThrottle) {
        func.apply(context, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    }
  }
  
  // Optimized resize handler
  const handleResize = throttle((e) => {
    if (!isResizing) return;
    
    const deltaX = e.clientX - startX;
    const newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
    
    setSidebarWidth(newWidth, false); // Disable transition during drag
  }, 16); // ~60fps
  
  // Mouse down on resize handle
  resizeHandle.addEventListener('mousedown', (e) => {
    isResizing = true;
    startX = e.clientX;
    startWidth = getCurrentSidebarWidth();
    
    // Prevent text selection during resize
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'ew-resize';
    
    // Add resizing class for additional styling if needed
    app.classList.add('is-resizing');
    
    e.preventDefault();
  });
  
  // Mouse move - resize sidebar
  document.addEventListener('mousemove', handleResize);
  
  // Mouse up - stop resizing
  document.addEventListener('mouseup', () => {
    if (isResizing) {
      isResizing = false;
      document.body.style.userSelect = '';
      document.body.style.cursor = '';
      
      // Re-enable transitions
      app.classList.remove('is-resizing');
      setSidebarWidth(getCurrentSidebarWidth(), true);
      
      // Save the new width to localStorage for persistence
      const currentWidth = getCurrentSidebarWidth();
      if (currentWidth > minWidth) {
        localStorage.setItem('sidebarWidth', currentWidth);
      }
    }
  });
  
  // Touch support for mobile devices
  const handleTouchResize = throttle((e) => {
    if (!isResizing || e.touches.length !== 1) return;
    
    const touch = e.touches[0];
    const deltaX = touch.clientX - startX;
    const newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + deltaX));
    
    setSidebarWidth(newWidth, false);
  }, 16);
  
  resizeHandle.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
      const touch = e.touches[0];
      isResizing = true;
      startX = touch.clientX;
      startWidth = getCurrentSidebarWidth();
      app.classList.add('is-resizing');
      e.preventDefault();
    }
  });
  
  document.addEventListener('touchmove', handleTouchResize);
  
  document.addEventListener('touchend', () => {
    if (isResizing) {
      isResizing = false;
      app.classList.remove('is-resizing');
      setSidebarWidth(getCurrentSidebarWidth(), true);
      
      const currentWidth = getCurrentSidebarWidth();
      if (currentWidth > minWidth) {
        localStorage.setItem('sidebarWidth', currentWidth);
      }
    }
  });
  
  // Restore saved sidebar width and collapsed state on page load
  const savedWidth = localStorage.getItem('sidebarWidth');
  const savedCollapsed = localStorage.getItem('cl_sidebar_collapsed');
  
  if (savedCollapsed === '1') {
    // Restore collapsed state
    app.classList.add('collapsed');
    sidebar.classList.add('collapsed');
    toggleButton.setAttribute('aria-expanded', 'false');
    setSidebarWidth(minWidth);
  } else if (savedWidth) {
    // Restore saved width
    const width = parseInt(savedWidth);
    if (width >= minWidth && width <= maxWidth) {
      setSidebarWidth(width);
    }
  }
  
  // Modify the existing toggle button behavior to work with resize
  toggleButton.addEventListener('click', function() {
    if (app.classList.contains('collapsed')) {
      // Expanding - restore to saved width or default
      const savedWidth = localStorage.getItem('sidebarWidth');
      const targetWidth = savedWidth ? parseInt(savedWidth) : defaultWidth;
      setSidebarWidth(targetWidth);
      app.classList.remove('collapsed');
      sidebar.classList.remove('collapsed');
      toggleButton.setAttribute('aria-expanded', 'true');
    } else {
      // Collapsing - save current width first
      const currentWidth = getCurrentSidebarWidth();
      if (currentWidth > minWidth) {
        localStorage.setItem('sidebarWidth', currentWidth);
      }
      setSidebarWidth(minWidth);
      app.classList.add('collapsed');
      sidebar.classList.add('collapsed');
      toggleButton.setAttribute('aria-expanded', 'false');
    }
    
    // Save collapsed state to localStorage
    try{ 
      localStorage.setItem("cl_sidebar_collapsed", app.classList.contains("collapsed") ? "1" : "0"); 
    } catch(_) {}
  });
});

// Help system functionality
const pageHelp = {
  'view-dashboard': {
    title: 'Dashboard Overview',
    content: 'Your central command center providing a comprehensive overview of your practice\'s CQC readiness. Monitor key metrics, view upcoming tasks, track compliance status, and quickly access areas that need attention. The dashboard displays real-time data across all compliance areas including training, safety checks, and documentation status.'
  },
  'view-pre-inspection': {
    title: 'Pre-Inspection Readiness',
    content: 'When CQC announces an inspection, you have just two weeks notice. This page helps you prepare the required documentation packages quickly and efficiently. Upload and organize documents into the nine email packages that CQC requires, ensure all information is current and relevant, then export everything with a single click. Stay inspection-ready with organized, up-to-date documentation.'
  },
  'view-training': {
    title: 'Mandatory Training Management',
    content: 'Manage all staff training requirements and certifications in one place. Track completion dates, monitor upcoming renewals, and ensure all mandatory training is current. Upload certificates, set expiry reminders, and maintain compliance with CQC training standards. Generate training matrices and reports for inspection purposes.'
  },
  'view-users': {
    title: 'User Management',
    content: 'Manage staff accounts, roles, and permissions for your CheckLoop system. Add new team members, assign appropriate access levels (Admin or Staff), and maintain security by managing user credentials. Control who can access sensitive compliance data and administrative functions.'
  },
  'view-calendar': {
    title: 'Compliance Calendar',
    content: 'Visual overview of all compliance-related activities, deadlines, and scheduled tasks. Track safety checks, training renewals, equipment servicing, and other time-sensitive compliance activities. Never miss critical deadlines with automated reminders and clear visual indicators of upcoming requirements.'
  },
  'view-complaints-dashboard': {
    title: 'Complaints Dashboard',
    content: 'Monitor and analyze complaint trends, response times, and resolution patterns. CQC expects excellent complaint handling with swift responses and clear resolution processes. Track active complaints, view resolution statistics, and ensure you meet the required response timeframes for regulatory compliance.'
  },
  'view-complaints-reporting': {
    title: 'Complaints Reporting',
    content: 'Report and document new complaints with detailed information capture. Record complaint details, assign responsibility, track investigation progress, and document resolutions. Maintain comprehensive records that demonstrate proper complaint handling procedures to CQC inspectors.'
  },
  'view-items': {
    title: 'Equipment & Asset Management',
    content: 'Maintain detailed records of all practice equipment, medical devices, and assets. Track serial numbers, maintenance schedules, calibration dates, and warranty information. Ensure all equipment meets safety standards and compliance requirements for CQC inspections.'
  },
  'view-rooms': {
    title: 'Room & Location Management',
    content: 'Organize and manage different areas within your practice. Define rooms, assign equipment and staff, track room-specific compliance requirements, and maintain location-based safety and maintenance records. Essential for practices with multiple consultation rooms or specialized treatment areas.'
  },
  'view-checktypes': {
    title: 'Check Type Configuration',
    content: 'Define and customize the types of safety checks, equipment tests, and compliance verifications required in your practice. Set up standardized check procedures, assign frequencies, and create templates to ensure consistent compliance monitoring across all areas of your practice.'
  },
  'view-schedules': {
    title: 'Compliance Schedules',
    content: 'Create and manage recurring schedules for safety checks, equipment maintenance, training renewals, and other compliance activities. Automate routine tasks with intelligent scheduling that adapts to your practice needs and ensures nothing is overlooked.'
  },
  'view-staff': {
    title: 'Staff Records',
    content: 'Comprehensive staff management including personal details, qualifications, training records, and compliance status. Maintain complete staff files with DBS checks, professional registrations, emergency contacts, and role-specific requirements. Essential for CQC staff-related compliance.'
  },
  'view-submissions': {
    title: 'Compliance Submissions',
    content: 'Track all submissions made to regulatory bodies, insurance companies, and other organizations. Maintain records of when documents were submitted, to whom, and for what purpose. Monitor response status and maintain audit trails for regulatory compliance.'
  },
  'view-settings': {
    title: 'System Configuration',
    content: 'Configure CheckLoop settings to match your practice requirements. Set up notification preferences, customize compliance thresholds, manage data retention policies, and configure integrations with other systems. Tailor the system to your specific operational needs.'
  },
  'view-quiz': {
    title: 'Quiz Management',
    content: 'Create and manage training quizzes and assessments for staff competency verification. Design custom questions, set pass marks, track completion rates, and generate competency reports. Ensure staff understand policies and procedures through regular assessment.'
  }
};

function showHelp(viewId) {
  const modal = document.getElementById('help-modal');
  const title = document.getElementById('help-modal-title');
  const body = document.getElementById('help-modal-body');
  
  const helpData = pageHelp[viewId];
  if (helpData) {
    title.textContent = helpData.title;
    body.textContent = helpData.content;
    modal.classList.add('show');
  }
}

function hideHelp() {
  document.getElementById('help-modal').classList.remove('show');
}

// Event listeners for help modal
document.getElementById('help-modal-close').addEventListener('click', hideHelp);
document.getElementById('help-modal').addEventListener('click', function(e) {
  if (e.target === this) hideHelp();
});

// Escape key closes modal
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('help-modal').classList.contains('show')) {
    hideHelp();
  }
});

// Project Management System
let projectTasks = [];
let editingTaskId = null;

// Simple HTML escaping function
function esc(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
}

// Initialize project management
document.addEventListener('DOMContentLoaded', () => {
  setupProjectManagementEventListeners();
  setupRightClickIssueTracker();
  
  // Initialize project management when the view becomes active
  const projectView = document.getElementById('view-project-management');
  if (projectView) {
    const observer = new MutationObserver(() => {
      if (projectView.classList.contains('active') && !projectView.dataset._loaded) {
        projectView.dataset._loaded = '1';
        console.log('Project management view activated, loading tasks...');
        loadProjectTasks();
      }
    });
    observer.observe(projectView, { attributes: true, attributeFilter: ['class'] });
    
    // If already active on load, initialize immediately
    if (projectView.classList.contains('active')) {
      console.log('Project management view active on load, loading tasks...');
      loadProjectTasks();
    }
  }
});

function setupProjectManagementEventListeners() {
  // Add task button
  const addTaskBtn = document.getElementById('btn-add-task');
  if (addTaskBtn) {
    addTaskBtn.addEventListener('click', () => openTaskModal());
  }
  
  // Filter tabs
  const filterTabs = document.querySelectorAll('[data-filter]');
  filterTabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
      // Update active tab
      filterTabs.forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      
      const filter = e.target.dataset.filter;
      filterTasks(filter);
    });
  });
  
  // Highlight issues toggle
  const highlightToggle = document.getElementById('highlight-issues-toggle');
  if (highlightToggle) {
    highlightToggle.addEventListener('change', (e) => {
      toggleIssueHighlighting(e.target.checked);
    });
  }

  // Row navigation: clicking a task navigates to its page and highlights target element
  const tbody = document.getElementById('project-tasks-tbody');
  if (tbody) {
    tbody.addEventListener('click', (e) => {
      const row = e.target.closest('tr[data-task-id]');
      if (!row) return;
      // Ignore clicks on controls
      if (e.target.closest('button, .btn, input[type="checkbox"], a, code')) return;
      const id = row.getAttribute('data-task-id');
      const task = projectTasks.find(t => String(t.id) === String(id));
      if (!task) return;
      navigateToTaskTarget(task);
    });
  }
}

// Navigate to the task's page and highlight the target element
function navigateToTaskTarget(task) {
  try {
    // Switch section reliably
    if (typeof setActiveSection === 'function' && task.page) {
      setActiveSection(task.page);
    } else if (task.page) {
      const btn = document.querySelector(`#sidebar .nav button[data-section="${task.page}"]`);
      if (btn) btn.click();
    }

    const selector = task.element_selector;
    if (!selector) return;

    // Expand any relevant collapsed panels for the page
    const maybeExpandForSelector = (page, sel) => {
      if (page === 'pre-inspection') {
        // Ensure main PIR progress block is open
        const pirMain = document.getElementById('pir-progress-main');
        const pirToggle = document.getElementById('pir-progress-toggle');
        if (pirMain && pirMain.classList.contains('collapsed') && pirToggle) {
          pirMain.classList.remove('collapsed');
          pirToggle.setAttribute('aria-expanded', 'true');
          pirToggle.textContent = '▾';
          try { localStorage.setItem('pir_progress_collapsed', '0'); } catch {}
        }
        // If aiming for email status, ensure that is open too
        if (sel && sel.includes('email-status')) {
          const circles = document.getElementById('email-status-circles');
          if (circles && circles.classList.contains('collapsed')) {
            circles.classList.remove('collapsed');
            try { localStorage.setItem('email_status_collapsed', '0'); } catch {}
          }
        }
      }
    };

    // Poll for the element because some sections render async
    const waitForElement = async (sel, { timeout = 6000, interval = 120 } = {}) => {
      const start = Date.now();
      let el = document.querySelector(sel);
      while (!el && Date.now() - start < timeout) {
        maybeExpandForSelector(task.page, sel);
        await new Promise(r => setTimeout(r, interval));
        el = document.querySelector(sel);
      }
      return el || null;
    };

    (async () => {
      const el = await waitForElement(selector);
      if (!el) {
        safeToast('Could not find the target element on that page', 'error');
        return;
      }
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      const prevBox = el.style.boxShadow;
      const prevOutline = el.style.outline;
      el.style.outline = '2px solid #0d6efd';
      el.style.boxShadow = '0 0 0 6px rgba(13,110,253,0.2)';
      setTimeout(() => {
        el.style.outline = prevOutline;
        el.style.boxShadow = prevBox;
      }, 2000);
    })();
  } catch (e) {
    console.error('Navigation error', e);
  }
}

function openTaskModal(taskId = null) {
  // Create modal dynamically if it doesn't exist
  let modal = document.getElementById('project-task-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'project-task-modal';
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content" style="width: 600px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h3 id="task-modal-title">Add New Task</h3>
          <button class="btn secondary modal-close" style="padding: 4px 8px;">&times;</button>
        </div>
        
        <form id="project-task-form">
          <div class="field">
            <label for="task-title">What needs to be done? *</label>
            <input type="text" id="task-title" placeholder="e.g. Fix login button, Add user dashboard, etc..." required>
          </div>
          
          <div class="field">
            <label for="task-description">More details (optional)</label>
            <textarea id="task-description" rows="3" placeholder="Any extra notes or details..."></textarea>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="field">
              <label for="task-type">Type *</label>
              <select id="task-type" required>
                <option value="">What kind of task?</option>
                <option value="bug">🐛 Bug Fix</option>
                <option value="feature">✨ New Feature</option>
              </select>
            </div>
            
            <div class="field">
              <label for="task-status">Status *</label>
              <select id="task-status" required>
                <option value="open">📝 To Do</option>
                <option value="closed">✅ Done</option>
              </select>
            </div>
          </div>
          
          <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
            <button type="button" class="btn secondary modal-close">Cancel</button>
            <button type="submit" class="btn">Save Task</button>
          </div>
        </form>
      </div>
    `;
    document.body.appendChild(modal);
    
    // Modal event handlers
    modal.addEventListener('click', (e) => {
      if (e.target === modal || e.target.classList.contains('modal-close')) {
        closeTaskModal();
      }
    });
    
    // Add form submit handler
    const form = modal.querySelector('#project-task-form');
    if (form) {
      form.addEventListener('submit', handleTaskSubmit);
    }
  }
  
  // Always get fresh references to elements
  const title = document.getElementById('task-modal-title');
  const form = document.getElementById('project-task-form');
  
  editingTaskId = taskId;
  
  if (taskId) {
    // Edit mode
    title.textContent = 'Edit Task';
    const task = projectTasks.find(t => t.id === taskId);
    if (task) {
      document.getElementById('task-title').value = task.title;
      document.getElementById('task-description').value = task.description || '';
      document.getElementById('task-type').value = task.type;
      document.getElementById('task-status').value = task.status;
    }
  } else {
    // Add mode
    title.textContent = 'Add New Task';
    form.reset();
    document.getElementById('task-status').value = 'open'; // Default status
  }
  
  modal.classList.add('show');
}

function closeTaskModal() {
  const modal = document.getElementById('project-task-modal');
  if (modal) {
    modal.classList.remove('show');
  }
  editingTaskId = null;
}

async function handleTaskSubmit(e) {
  e.preventDefault();
  console.log('Form submitted!');
  
  const formData = {
    title: document.getElementById('task-title').value.trim(),
    description: document.getElementById('task-description').value.trim(),
    type: document.getElementById('task-type').value,
    status: document.getElementById('task-status').value
  };
  
  console.log('Form data:', formData);
  
  try {
    if (editingTaskId) {
      console.log('Updating task:', editingTaskId);
      await updateTask(editingTaskId, formData);
      showToast('Task updated!', 'success');
    } else {
      console.log('Creating new task');
      await createTask(formData);
      showToast('Task created!', 'success');
    }
    
    closeTaskModal();
    await loadProjectTasks();
  } catch (error) {
    console.error('Error saving task:', error);
    showToast('Error saving task. Please try again.', 'error');
  }
}

async function createTask(taskData) {
  console.log('createTask called with:', taskData);

  if (!window.supabase) {
    console.error('Supabase not initialized');
    throw new Error('Supabase not initialized');
  }

  // Best-effort get auth/user + site context (both nullable in schema)
  let userId = (window.ctx && ctx.user_id) ? ctx.user_id : null;
  try {
    if (!userId && supabase.auth?.getUser) {
      const { data: authData } = await supabase.auth.getUser();
      userId = authData?.user?.id || null;
    }
  } catch { /* non-fatal */ }

  const siteId = (window.ctx && ctx.site_id) ? ctx.site_id : null; // site_id is nullable in schema

  // Map our task data to the project_issues table structure
  const issueData = {
    site_id: siteId,
    type: taskData.type, // Only 'bug' or 'feature' allowed by database
    title: taskData.title,
    description: taskData.description || null,
    status: taskData.status === 'closed' ? 'closed' : 'open',
    element_selector: taskData.element_selector || null,
    page: taskData.page || null,
    created_by: userId
  };

  console.log('Inserting into database:', issueData);

  const { data, error } = await supabase
    .from('project_issues')
    .insert([issueData])
    .select()
    .single();

  if (error) {
    console.error('Database error:', error);
    throw error;
  }

  console.log('Task created successfully:', data);

  // Add to local cache
  projectTasks.push(data);
}

async function updateTask(taskId, updates) {
  if (!window.supabase) throw new Error('Supabase not initialized');
  if (!ctx || !ctx.site_id) throw new Error('Site context not available');

  // Map status updates
  let nextStatus = undefined;
  if (typeof updates.status !== 'undefined') {
    if (updates.status === true || updates.status === 'completed' || updates.status === 'closed') nextStatus = 'closed';
    else if (updates.status === false || updates.status === 'open' || updates.status === 'todo') nextStatus = 'open';
  }
  const mappedUpdates = { ...updates };
  if (nextStatus) mappedUpdates.status = nextStatus;
  
  // Add closed_at and closed_by if marking as completed
  if (mappedUpdates.status === 'closed') {
    mappedUpdates.closed_at = new Date().toISOString();
    mappedUpdates.closed_by = ctx.user_id;
  } else {
    mappedUpdates.closed_at = null;
    mappedUpdates.closed_by = null;
  }

  const { data, error } = await supabase
    .from('project_issues')
    .update(mappedUpdates)
    .eq('id', taskId)
    .eq('site_id', ctx.site_id)
    .select()
    .single();

  if (error) throw error;

  // Update local cache
  const taskIndex = projectTasks.findIndex(t => t.id === taskId);
  if (taskIndex !== -1) {
    projectTasks[taskIndex] = data;
  }
}

async function deleteTask(taskId) {
  if (confirm('Are you sure you want to delete this task?')) {
    if (!window.supabase) throw new Error('Supabase not initialized');
    if (!ctx || !ctx.site_id) throw new Error('Site context not available');

    const { error } = await supabase
      .from('project_issues')
      .delete()
      .eq('id', taskId)
      .eq('site_id', ctx.site_id);

    if (error) throw error;

    // Remove from local cache
    projectTasks = projectTasks.filter(t => t.id !== taskId);
    await loadProjectTasks();
    showToast('Task deleted successfully!', 'success');
  }
}

async function loadProjectTasks() {
  try {
    console.log('loadProjectTasks called');
    
    if (!window.supabase) {
      console.error('Supabase not initialized');
      throw new Error('Supabase not initialized');
    }
    
    if (!ctx || !ctx.site_id) {
      console.warn('Site context not available yet, showing empty state');
      // Show empty state instead of error
      projectTasks = [];
      renderProjectTasks();
      updateProjectStats();
      return;
    }

    console.log('Loading tasks for site:', ctx.site_id);

    const { data, error } = await supabase
      .from('project_issues')
      .select('*')
      .eq('site_id', ctx.site_id)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Database error loading tasks:', error);
      throw error;
    }

    console.log('Loaded tasks from database:', data);
    projectTasks = data || [];
    renderProjectTasks();
    updateProjectStats();
  } catch (error) {
    console.error('Error loading project tasks:', error);
    showToast('Error loading tasks', 'error');
  }
}

function renderProjectTasks(filteredTasks = null) {
  const tbody = document.getElementById('project-tasks-tbody');
  if (!tbody) return;
  
  const tasksToRender = filteredTasks || projectTasks;
  
  if (tasksToRender.length === 0) {
  tbody.innerHTML = '<tr><td colspan="7" class="muted">No tasks found.</td></tr>';
    return;
  }
  
  tbody.innerHTML = tasksToRender.map((task, idx) => {
  const isClosed = task.status === 'closed';
  const statusIcon = isClosed ? '✅' : '🔴';
    const typeIcon = getTypeIcon(task.type);
    const isBug = task.type === 'bug';

    // Human-friendly labels
    const humanType = task.type === 'bug' ? 'Bug fix' : (task.type === 'feature' ? 'New idea' : (task.type || ''));
  const createdLabel = task.created_at ? `Created: ${formatDate(task.created_at)}` : '';

    // Extract optional comment from description (looks for a line starting with "Notes:")
    let baseDesc = task.description || '';
    let comment = '';
    if (typeof baseDesc === 'string') {
      const idx = baseDesc.indexOf('\nNotes:');
      if (idx !== -1) {
        comment = baseDesc.substring(idx + 7).trim();
        baseDesc = baseDesc.substring(0, idx).trim();
      }
    }

  // Extract element text and element name from baseDesc
  const textMatch = (typeof baseDesc === 'string') ? baseDesc.match(/(?:^|\n)Text:\s*(.+)/) : null;
  const elementText = textMatch ? textMatch[1].trim() : '';
  const elemMatch = (typeof baseDesc === 'string') ? baseDesc.match(/Element:\s*([^\n]+)/) : null;
  const elementName = elemMatch ? elemMatch[1].trim() : '';

  // Primary line should emphasize the idea/comment with the selected type
  const primaryLabel = humanType; // "Bug fix" or "New idea"
  const primaryContent = comment || elementText || elementName || task.title || '';

  // Build a compact meta line in smaller text
  const metaParts = [];
  if (elementName) metaParts.push(`Element: ${elementName}`);
  if (elementText) metaParts.push(`Text: ${elementText}`);
  if (createdLabel) metaParts.push(createdLabel);
  const metaLine = metaParts.join(' • ');
    
    const rowNumber = idx + 1;
  return `
      <tr class="${isBug ? 'task-issue-row' : ''}" data-task-id="${task.id}">
        <td class="muted" style="text-align:center;">${rowNumber}</td>
        <td style="text-align:center;">
          <input type="checkbox" ${isClosed ? 'checked' : ''} aria-label="Mark done" onclick="toggleTaskDone('${task.id}', this.checked)" />
        </td>
  <td role="button" style="cursor:pointer">
          <div class="status-indicator ${isClosed ? 'status-closed' : 'status-open'}" title="${task.status}" style="width:32px;height:32px;font-size:14px;">
            ${statusIcon}
          </div>
        </td>
  <td role="button" style="cursor:pointer">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span class="type-icon">${typeIcon}</span>
            <div>
        <div class="task-title">${esc(task.title)}</div>
              <div class="task-description" style="font-size: 13px; color: var(--text-color); margin-top: 2px;">
                ${primaryLabel ? `<strong>${esc(primaryLabel)}:</strong> ` : ''}${esc(primaryContent)}
              </div>
              ${metaLine ? `<div class=\"task-description\" style=\"font-size: 12px; color: var(--muted); margin-top: 4px;\">${esc(metaLine)}</div>` : ''}
              ${(task.page || task.element_selector) ? `
                <div class="task-description" style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                  ${task.page ? `Page: <strong>${esc(task.page)}</strong>` : ''}
                  ${task.page && task.element_selector ? ' • ' : ''}
                  ${task.element_selector ? `Selector: <code>${esc(task.element_selector)}</code>` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        </td>
        <td>
          <span class="task-type type-${task.type}">${esc(humanType || task.type)}</span>
        </td>
        <td class="muted">
          ${formatDate(task.created_at)}
        </td>
        <td>
          <div style="display: flex; gap: 4px;">
            <button class="btn-icon" onclick="openTaskModal('${task.id}')" title="Edit" style="background: none; border: none; cursor: pointer; padding: 4px;">
              ✏️
            </button>
            <button class="btn-icon" onclick="deleteTask('${task.id}')" title="Delete" style="background: none; border: none; cursor: pointer; padding: 4px;">
              🗑️
            </button>
            <button class="btn-icon btn-copy-copilot" data-task-id="${task.id}" title="Copy to Copilot" style="background: none; border: none; cursor: pointer; padding: 4px;">
              📋
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

// Toggle a task's completion via the checkbox
async function toggleTaskDone(taskId, checked) {
  try {
    // Optimistic update of local cache
    const tIdx = projectTasks.findIndex(t => t.id === taskId);
    if (tIdx !== -1) projectTasks[tIdx].status = checked ? 'closed' : 'open';
    renderProjectTasks();
    updateProjectStats();

    await updateTask(taskId, { status: checked ? 'completed' : 'open' });
    safeToast(checked ? 'Task marked complete' : 'Task reopened', 'success');
  } catch (e) {
    console.error('Failed to toggle task', e);
    safeToast('Could not update task status', 'error');
    // Revert checkbox UI if server failed
    const input = document.querySelector(`tr[data-task-id="${taskId}"] input[type="checkbox"]`);
    if (input) input.checked = !checked;
  }
}

function filterTasks(filter) {
  if (filter === 'all') {
    renderProjectTasks();
  } else {
    const filtered = projectTasks.filter(task => task.type === filter);
    renderProjectTasks(filtered);
  }
}

function updateProjectStats() {
  const total = projectTasks.length;
  const completed = projectTasks.filter(t => t.status === 'closed').length;
  const open = projectTasks.filter(t => t.status === 'open').length;
  const bugs = projectTasks.filter(t => t.type === 'bug').length;
  
  const totalEl = document.getElementById('tasks-total');
  const completedEl = document.getElementById('tasks-completed');
  const openEl = document.getElementById('tasks-open');
  const bugsEl = document.getElementById('tasks-bugs');
  
  if (totalEl) totalEl.textContent = total;
  if (completedEl) completedEl.textContent = completed;
  if (openEl) openEl.textContent = open;
  if (bugsEl) bugsEl.textContent = bugs;
}

function toggleIssueHighlighting(enabled) {
  const body = document.body;
  if (enabled) {
    body.classList.add('highlight-issues');
    // Add red background to bug rows
    const bugRows = document.querySelectorAll('.task-issue-row');
    bugRows.forEach(row => {
      row.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
      row.style.borderLeft = '3px solid var(--danger-color)';
    });
  } else {
    body.classList.remove('highlight-issues');
    // Remove red background from bug rows
    const bugRows = document.querySelectorAll('.task-issue-row');
    bugRows.forEach(row => {
      row.style.backgroundColor = '';
      row.style.borderLeft = '';
    });
  }
}

function getStatusIcon(status) {
  const icons = {
    'todo': '⏳',
    'in-progress': '🔄',
    'testing': '🧪',
    'completed': '✅'
  };
  return icons[status] || '❓';
}

function getTypeIcon(type) {
  const icons = {
    'feature': '✨',
    'page': '📄',
    'bug': '🐛',
    'issue': '⚠️',
    'enhancement': '⬆️',
    'maintenance': '🔧'
  };
  return icons[type] || '📝';
}

// --- Copilot prompt helpers ---
function splitNotes(description = '') {
  if (typeof description !== 'string') return { base: '', notes: '' };
  const idx = description.indexOf('\nNotes:');
  if (idx === -1) return { base: description.trim(), notes: '' };
  return { base: description.substring(0, idx).trim(), notes: description.substring(idx + 7).trim() };
}

function buildCopilotPrompt(task) {
  const { base, notes } = splitNotes(task.description || '');
  const lines = [];

  // Opening instruction
  lines.push('Hi — please do this:');
  lines.push('');

  // Concise task details
  const status = task.status || 'open';
  const type = task.type || 'task';
  lines.push(`Task: ${task.title || '(no title)'} (${type}, ${status})`);
  if (base) lines.push(`Details: ${base}`);
  if (notes) lines.push(`Reporter notes: ${notes}`);
  if (task.page) lines.push(`Page: ${task.page}`);
  if (task.element_selector) lines.push(`Selector: ${task.element_selector}`);
  lines.push(`ID: ${task.id}`);
  if (task.created_at) lines.push(`Created: ${task.created_at}`);
  lines.push('');

  // Supabase guidance
  lines.push('Use `SupabaseInfo.txt` (in this repo) to understand how the tables are laid out.');
  lines.push('Only if you REALLY need to dig deeper or make amendments to Supabase, use the Supabase CLI.');
  lines.push('');

  // Action + verification loop
  lines.push('Apply the fix in this repository, then verify the result:');
  lines.push('- Open http://127.0.0.1:5500 in a browser.');
  lines.push('- Log in with email: ben.howard@stoke.nhs.uk');
  lines.push('- Password: Hello1!');
  lines.push('- Reproduce the issue and confirm the fix works.');
  lines.push('- If it does not work, iterate and try again until it is fixed.');
  lines.push('');

  // Deliverables guidance (kept concise)
  lines.push('When done, provide:');
  lines.push('- Exact file paths and code edits made');
  lines.push('- A brief summary of why the change works');

  return lines.join('\n');
}

async function copyTextToClipboard(text) {
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text);
      return true;
    }
  } catch (e) {
    // fall through to execCommand
  }
  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.top = '-1000px';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    return ok;
  } catch (e) {
    return false;
  }
}

// Wire Copy-to-Copilot clicks using event delegation on the tasks table
(function wireCopyToCopilot(){
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-copy-copilot');
    if (!btn) return;
    const id = btn.getAttribute('data-task-id');
    const task = projectTasks.find(t => String(t.id) === String(id));
    if (!task) return;
    const prompt = buildCopilotPrompt(task);
    const ok = await copyTextToClipboard(prompt);
    if (ok) {
      const title = (task && task.title) ? `“${task.title}”` : 'task';
      if (typeof safeToast === 'function') safeToast(`Copied prompt for ${title} to clipboard`, 'success');
    } else {
      if (typeof safeToast === 'function') safeToast('Could not copy prompt to clipboard', 'error');
    }
  });
})();

function getPriorityColor(priority) {
  const colors = {
    'low': '#28a745',
    'medium': '#ffc107', 
    'high': '#fd7e14',
    'critical': '#dc3545'
  };
  return colors[priority] || 'var(--muted)';
}

function formatDate(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', { 
    day: '2-digit', 
    month: 'short', 
    year: 'numeric' 
  });
}

function safeToast(msg, type='info') {
  if (typeof showToast === 'function') {
    try { showToast(msg, type); } catch { console.log(`[${type}] ${msg}`); }
  } else {
    console.log(`[${type}] ${msg}`);
  }
}

// Right-click context menu system for issue tracking
let contextMenuTarget = null;

function setupRightClickIssueTracker() {
  // Create context menu element
  const contextMenu = document.createElement('div');
  contextMenu.id = 'issue-context-menu';
  contextMenu.className = 'context-menu';
  contextMenu.innerHTML = `
    <div class="context-menu-item" id="add-to-issues">
      🐛 Add to Issue Tracker
    </div>
  `;
  contextMenu.style.cssText = `
    position: fixed;
    background: var(--panel-bg, white);
    border: 1px solid var(--border-color, #ccc);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    padding: 4px 0;
    min-width: 180px;
    display: none;
  `;
  
  const menuItem = contextMenu.querySelector('#add-to-issues');
  menuItem.style.cssText = `
    padding: 8px 16px;
    cursor: pointer;
    color: var(--white, #333);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  `;
  
  document.body.appendChild(contextMenu);
  
  // Right-click event listener
  document.addEventListener('contextmenu', (e) => {
    // Only show on elements that can be tracked (buttons, inputs, divs, etc)
    const target = e.target;
    const isTrackableElement = target.tagName && 
      ['BUTTON', 'INPUT', 'DIV', 'SPAN', 'A', 'IMG', 'SELECT', 'TEXTAREA', 'LABEL', 'TD', 'TH'].includes(target.tagName);
    
    if (isTrackableElement && !target.closest('.context-menu')) {
      e.preventDefault();
      contextMenuTarget = target;
      
      // Position the menu
      contextMenu.style.left = e.pageX + 'px';
      contextMenu.style.top = e.pageY + 'px';
      contextMenu.style.display = 'block';
      
      // Adjust position if menu would go off screen
      setTimeout(() => {
        const rect = contextMenu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
          contextMenu.style.left = (e.pageX - rect.width) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
          contextMenu.style.top = (e.pageY - rect.height) + 'px';
        }
      }, 0);
    }
  });
  
  // Click to close context menu
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.context-menu')) {
      contextMenu.style.display = 'none';
      contextMenuTarget = null;
    }
  });
  
  // Context menu item click (use mousedown to avoid focus loss)
  menuItem.addEventListener('mousedown', async (ev) => {
    ev.preventDefault();
    ev.stopPropagation();
    if (contextMenuTarget) {
      try {
        // Capture target before any global click handlers clear it
        const targetEl = contextMenuTarget;
        // Close the menu immediately
        contextMenu.style.display = 'none';
        contextMenuTarget = null;
        // Ask for type and optional notes before creating the issue
        const details = await promptIssueDetails({ x: ev.pageX, y: ev.pageY });
        if (!details) return; // cancelled
        await addElementToIssueTracker(targetEl, details.type, details.notes);
      } catch (err) {
        console.error('Context menu add failed:', err);
        (window.showToast ? showToast('Failed to add to issue tracker', 'error') : alert('Failed to add to issue tracker'));
      }
    }
  });
  
  // Hover effects for menu item
  menuItem.addEventListener('mouseenter', () => {
    menuItem.style.backgroundColor = 'var(--border-color, #f0f0f0)';
  });
  
  menuItem.addEventListener('mouseleave', () => {
    menuItem.style.backgroundColor = 'transparent';
  });
}

async function addElementToIssueTracker(element, chosenType = 'bug', notes = '') {
  try {
    // Generate a unique selector for the element
    const selector = generateElementSelector(element);
    
    // Get element info
    const tagName = element.tagName.toLowerCase();
    const text = getElementText(element);
    const elementType = getElementType(element);
    
  // Create a descriptive title
  const base = `${elementType}: ${text ? text.substring(0, 50) + (text.length > 50 ? '...' : '') : tagName}`;
  const titlePrefix = (chosenType === 'feature') ? 'Idea' : 'Fix';
  const title = `${titlePrefix} ${base}`;
    
    // Get current page info
    const currentView = document.querySelector('.view.active');
    const pageName = currentView ? currentView.id.replace('view-', '') : 'unknown';
    
    // Map prompt type to DB type (bug fix -> 'bug', new idea -> 'feature')
    const dbType = (chosenType === 'feature') ? 'feature' : 'bug';

    const taskData = {
      title: title,
      description: `Element: ${tagName}${text ? `\nText: ${text}` : ''}${notes && notes.trim() ? `\nNotes: ${notes.trim()}` : ''}`,
      type: dbType,
      status: 'open',
      element_selector: selector,
      page: pageName
    };
    
    console.log('Adding element to issue tracker:', taskData);
    
  await createTask(taskData);
  safeToast(`Added "${title}" to issue tracker!`, 'success');
    
    // If we're on the project management page, refresh the list
    if (currentView && currentView.id === 'view-project-management') {
      if (!window.ctx || !ctx.site_id) {
        // No site context; render from local cache
        renderProjectTasks();
        updateProjectStats();
      } else {
        await loadProjectTasks();
      }
    }
    
  } catch (error) {
    console.error('Error adding element to issue tracker:', error);
    safeToast('Error adding to issue tracker', 'error');
  }
}

// Small inline prompt to collect type (bug fix/new idea) and optional notes
function promptIssueDetails({ x = window.innerWidth/2, y = window.innerHeight/2 } = {}) {
  return new Promise((resolve) => {
    // Overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed; inset: 0; background: rgba(0,0,0,0.2); z-index: 10001;
      display: flex; align-items: center; justify-content: center; padding: 16px;
    `;

    // Dialog
    const dialog = document.createElement('div');
    dialog.setAttribute('role', 'dialog');
    dialog.setAttribute('aria-modal', 'true');
    dialog.style.cssText = `
      background: var(--panel-bg, #fff);
      color: var(--text-color, #222);
      border: 1px solid var(--border-color, #ddd);
      border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      width: min(420px, 92vw);
      padding: 16px;
      font-size: 14px;
    `;
    dialog.innerHTML = `
      <div style="font-weight:600; margin-bottom: 12px;">Add to Issue Tracker</div>
      <div style="display:flex; flex-direction: column; gap: 10px;">
        <label style="display:flex; flex-direction: column; gap:6px;">
          <span>Type</span>
          <select id="issue-type-select" style="padding:8px; border:1px solid var(--border-color,#ddd); border-radius:8px;">
            <option value="bug" selected>Bug fix</option>
            <option value="feature">New idea</option>
          </select>
        </label>
        <label style="display:flex; flex-direction: column; gap:6px;">
          <span>Notes (optional)</span>
          <input id="issue-notes-input" type="text" placeholder="Add a short note" style="padding:8px; border:1px solid var(--border-color,#ddd); border-radius:8px;" />
        </label>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top: 6px;">
          <button id="issue-cancel-btn" style="padding:8px 12px; border:1px solid var(--border-color,#ddd); background: transparent; border-radius:8px; cursor:pointer;">Cancel</button>
          <button id="issue-add-btn" style="padding:8px 12px; border:0; background: var(--primary, #0d6efd); color:white; border-radius:8px; cursor:pointer;">Add</button>
        </div>
      </div>
    `;

    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    const typeSelect = dialog.querySelector('#issue-type-select');
    const notesInput = dialog.querySelector('#issue-notes-input');
    const cancelBtn = dialog.querySelector('#issue-cancel-btn');
    const addBtn = dialog.querySelector('#issue-add-btn');

    // Focus first field
    setTimeout(() => typeSelect.focus(), 0);

    const cleanup = () => {
      if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
    };

    const submit = () => {
      const type = typeSelect.value === 'feature' ? 'feature' : 'bug';
      const notes = notesInput.value || '';
      cleanup();
      resolve({ type, notes });
    };

    addBtn.addEventListener('click', (e) => { e.preventDefault(); submit(); });
    cancelBtn.addEventListener('click', (e) => { e.preventDefault(); cleanup(); resolve(null); });
    overlay.addEventListener('click', (e) => { if (e.target === overlay) { cleanup(); resolve(null); } });
    dialog.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { cleanup(); resolve(null); }
      if (e.key === 'Enter' && (document.activeElement === typeSelect || document.activeElement === notesInput)) {
        e.preventDefault(); submit();
      }
    });
  });
}

function generateElementSelector(element) {
  // Try to generate a useful CSS selector for the element
  const parts = [];
  
  // Add ID if present
  if (element.id) {
    return `#${element.id}`;
  }
  
  // Build selector with tag and classes
  let selector = element.tagName.toLowerCase();
  
  if (element.className && typeof element.className === 'string') {
    const classes = element.className.split(' ').filter(c => c.trim());
    if (classes.length > 0) {
      selector += '.' + classes.slice(0, 2).join('.');
    }
  }
  
  // Add parent context if needed
  const parent = element.parentElement;
  if (parent && parent.id) {
    selector = `#${parent.id} ${selector}`;
  }
  
  return selector;
}

function getElementText(element) {
  // Get meaningful text from the element
  let text = '';
  
  if (element.value) {
    text = element.value;
  } else if (element.textContent) {
    text = element.textContent.trim();
  } else if (element.alt) {
    text = element.alt;
  } else if (element.title) {
    text = element.title;
  } else if (element.placeholder) {
    text = element.placeholder;
  }
  
  return text.substring(0, 100); // Limit text length
}

function getElementType(element) {
  const tag = element.tagName.toLowerCase();
  const type = element.type;
  
  if (tag === 'button') return 'button';
  if (tag === 'input' && type === 'submit') return 'submit button';
  if (tag === 'input') return `${type || 'text'} input`;
  if (tag === 'select') return 'dropdown';
  if (tag === 'textarea') return 'textarea';
  if (tag === 'a') return 'link';
  if (tag === 'img') return 'image';
  if (tag === 'div' && element.className.includes('btn')) return 'button';
  if (tag === 'span' && element.className.includes('btn')) return 'button';
  
  return tag;
}

// PIR: wire email status collapse toggle and persist to localStorage
document.addEventListener('DOMContentLoaded', () => {
  try {
    // Overall progress main collapse
    const pirToggle = document.getElementById('pir-progress-toggle');
    const pirMain = document.getElementById('pir-progress-main');
    if (pirToggle && pirMain) {
      const pirKey = 'pir_progress_collapsed';
      const savedP = localStorage.getItem(pirKey);
      if (savedP === '1') {
        pirMain.classList.add('collapsed');
        pirToggle.setAttribute('aria-expanded', 'false');
        pirToggle.textContent = '▸';
      }
      pirToggle.addEventListener('click', (e) => {
        e.preventDefault();
        const isCollapsed = pirMain.classList.toggle('collapsed');
        pirToggle.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
        pirToggle.textContent = isCollapsed ? '▸' : '▾';
        localStorage.setItem(pirKey, isCollapsed ? '1' : '0');
      });
    }

    // Email status section: always expanded now (toggle removed)
    const circles = document.getElementById('email-status-circles');
    if (circles) {
      circles.classList.remove('collapsed');
      try { localStorage.setItem('email_status_collapsed', '0'); } catch {}
    }
  } catch (err) { console.error('PIR toggle init error', err); }
});
</script>

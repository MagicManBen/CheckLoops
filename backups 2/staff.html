<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — Staff</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <link rel="stylesheet" href="staff.css">
  <style>
    /* Page-specific small tweaks only; core styles in staff.css */
    .nav{ display:flex; gap:8px; flex-wrap:wrap; }
    .nav a{ color:var(--white); text-decoration:none; padding:8px 12px; border-radius:10px; background:#ffffff12; border:1px solid #ffffff26; font-weight:600; }
    .nav a.active{ background:linear-gradient(135deg,#7db1ff,#4f89ff); }
    .spacer{ flex:1; }
  </style>
</head>
<body>
  <div class="bg"><div class="wave"></div><div class="wave wave2"></div></div>
  <main class="content">
    <div class="topbar panel">
      <div class="nav">
        <a href="staff.html" data-page="home" class="active">Home</a>
        <a href="staff-scans.html" data-page="scans">My Scans</a>
        <a href="staff-training.html" data-page="training">My Training</a>
        <a href="staff-quiz.html" data-page="quiz">Quiz</a>
      </div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: —</div>
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
  <a class="btn secondary" href="Home.html">New Scan</a>
  <a class="btn" id="logout-btn" href="Home.html?logout=1">Sign Out</a>
    </div>

    <section class="panel g-12" style="margin:0;">
      <div class="panel-header" style="align-items:baseline; justify-content:space-between;">
        <div>
          <div class="muted" id="site-subtitle">Loading your profile…</div>
          <div class="h1" id="welcome">Welcome</div>
        </div>
      </div>
      <div class="stat-row" style="margin-top:12px;">
        <div class="g-4">
          <div class="stat-card" style="--c: var(--stat-1-bg); --i: var(--stat-1-color)">
            <div class="icon-wrap">🧾</div>
            <div>
              <div class="stat-num" id="kpi-scans">—</div>
              <div class="stat-label">Your scans (recent)</div>
            </div>
          </div>
        </div>
        <div class="g-4">
          <div class="stat-card" style="--c: var(--stat-2-bg); --i: var(--stat-2-color)">
            <div class="icon-wrap">✅</div>
            <div>
              <div class="stat-num" id="kpi-training-ok">—</div>
              <div class="stat-label">Training valid</div>
            </div>
          </div>
        </div>
        <div class="g-4">
          <div class="stat-card" style="--c: var(--stat-4-bg); --i: var(--stat-4-color)">
            <div class="icon-wrap">⚠️</div>
            <div>
              <div class="stat-num" id="kpi-training-due">—</div>
              <div class="stat-label">Due / expired</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="grid">
      <div class="panel g-8">
        <div class="panel-header"><div class="panel-title">Recent Scans</div></div>
        <div id="recent-scans-loading" class="empty">Loading…</div>
        <div class="table-wrap" id="recent-scans-wrap" style="display:none;">
          <table id="recent-scans">
            <thead><tr><th>Date</th><th>Item</th><th>Room</th><th>Check</th><th>Result</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="recent-scans-empty" class="empty" style="display:none">No scans yet. Use New Scan to get started.</div>
      </div>

      <div class="panel g-4">
        <div class="panel-header"><div class="panel-title">Mandatory Training</div></div>
        <div id="training-loading" class="empty">Loading…</div>
        <div class="table-wrap" id="training-wrap" style="display:none;">
          <table id="training-table">
            <thead><tr><th>Course</th><th>Status</th><th class="right">Valid until</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="training-empty" class="empty" style="display:none">No training records found yet.</div>
      </div>

      <div class="panel g-12">
        <div class="panel-header"><div class="panel-title">My Details</div></div>
        <div id="my-details"><div class="empty">Loading…</div></div>
        <div class="muted" style="font-size:12px; margin-top:8px;">Only you can see this page. Data shown respects your site's permissions.</div>
      </div>
    </div>

    <div class="muted" style="text-align:center; font-size:12px; padding:10px 0;">© CheckLoop • Staff Dashboard</div>
  </main>

  <script type="module">
    console.log('🔵 Staff.html loading...');
    try {
      console.log('🔵 About to import staff-common.js');
      const { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState } = await import('./staff-common.js');
      console.log('🔵 Imports loaded successfully');
      
      console.log('🔵 About to initialize Supabase');
      const supabase = await initSupabase();
      console.log('🔵 Supabase initialized successfully');
    } catch (importError) {
      console.error('🔴 Import or initialization error:', importError);
      alert('Failed to load required modules. Please refresh the page.');
      throw importError;
    }

    // Re-entrancy guard and shared cleanup
    let isLoggingOut = false;
    function cleanupAndRedirect() {
      try { localStorage.clear(); } catch(_) {}
      try { sessionStorage.clear(); } catch(_) {}
      try {
        document.cookie.split(";").forEach(function(c) { 
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date(0).toUTCString() + ";path=/"); 
        });
      } catch(_) {}
      window.location.replace('Home.html?logout=1&_=' + Date.now());
    }

    async function forceLogout() {
      if (isLoggingOut) return;
      isLoggingOut = true;
      try {
        const { data } = await supabase.auth.getSession();
        if (data?.session) await supabase.auth.signOut({ scope: 'global' });
      } catch (e) { console.error('Supabase signOut failed:', e); }
      setTimeout(() => cleanupAndRedirect(), 200);
    }    // Utility helpers
    const fmtDate = (d) => new Date(d).toLocaleString(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    const daysBetween = (a,b) => Math.ceil((new Date(a).setHours(0,0,0,0) - new Date(b).setHours(0,0,0,0)) / 86400000);
    const isClinicalRole = (roleDetail='') => /doctor|nurse|clin|pharmacist/i.test(roleDetail);

    // Page wiring
    (function(){
      const btn = document.getElementById('logout-btn');
      if (!btn) return;
      btn.addEventListener('click', async (e) => {
        // Keep href for hard fallback; try JS logout first
        e.preventDefault();
        e.stopPropagation();
        await forceLogout();
      });
      // Expose a global escape hatch for console/debug
      window.__forceLogout = forceLogout;
    })();

    // Check session and role, then load dashboard
    console.log('🔵 Starting session check...');
    
    // Debug: Log all localStorage keys that start with 'sb-'
    console.log('🔍 Debug: localStorage auth keys:', Object.keys(localStorage).filter(k => k.startsWith('sb-')));
    
    // Check session directly first
    const { data: { session }, error } = await supabase.auth.getSession();
    console.log('🔵 Initial session:', session ? 'Found' : 'None', error ? `Error: ${error.message}` : '');
    console.log('🔍 Debug: Full session object:', session);
    
    if (!session || !session.user) {
      console.log('🔴 No session found, redirecting to Home.html');
      window.location.replace('Home.html');
      return;
    }

    console.log('🔵 Session user:', session.user.email);
    console.log('🔍 Debug: Full user object:', session.user);
    console.log('🔍 Debug: User metadata:', session.user.raw_user_meta_data);
    
    try {
      // Verify staff role via profiles or raw meta
      console.log('🔵 Checking profile...');
      const { data: profileRow, error: profileError } = await supabase
        .from('profiles')
        .select('role, full_name, site_id')
        .eq('user_id', session.user.id)
        .maybeSingle();

      console.log('🔵 Profile:', profileRow, profileError ? `Error: ${profileError.message}` : '');

      let effectiveRole = profileRow?.role || session.user?.raw_user_meta_data?.role || null;
      console.log('🔵 Effective role:', effectiveRole);
      console.log('🔍 Debug: Profile role:', profileRow?.role, 'Metadata role:', session.user?.raw_user_meta_data?.role);
      
      if (!effectiveRole || String(effectiveRole).toLowerCase() !== 'staff') {
        console.log('🔴 Not staff role, redirecting to index.html');
        console.log('🔍 Debug: Role comparison - effectiveRole:', effectiveRole, 'toLowerCase:', String(effectiveRole).toLowerCase());
        window.location.replace('index.html');
        return;
      }

      console.log('🔵 Loading dashboard...');
      await loadDashboard(session.user, profileRow);
    } catch (error) {
      console.error('🔴 Error checking user role:', error);
      // On error, still try to render minimal dashboard
      await loadDashboard(session.user, null);
    }

    async function loadDashboard(user, profileRow){
      console.log('🔵 loadDashboard called with:', user?.email, profileRow);
      const displayName = profileRow?.full_name || user?.raw_user_meta_data?.full_name || (user?.email?.split('@')[0]) || 'Staff Member';
      const siteId = profileRow?.site_id || user?.raw_user_meta_data?.site_id || null;
      const roleDetail = user?.raw_user_meta_data?.role_detail || 'Staff';

      console.log('🔵 Dashboard data:', { displayName, siteId, roleDetail });

      // Header
      document.getElementById('welcome').textContent = `Welcome, ${displayName}`;
      setTopbar({ siteText: await getSiteText(supabase, siteId), email: user.email, role: roleDetail });
      if (!siteId){ document.getElementById('site-subtitle').textContent = 'Your staff dashboard'; }

      // My details panel
      const detailsEl = document.getElementById('my-details');
      detailsEl.innerHTML = `
        <div style="display:grid;grid-template-columns:140px 1fr;gap:6px 10px;font-size:14px">
          <div class="muted">Name</div><div>${displayName}</div>
          <div class="muted">Email</div><div>${user.email}</div>
          <div class="muted">Role</div><div>${roleDetail}</div>
          <div class="muted">Site</div><div>${siteId ?? '—'}</div>
        </div>`;

      console.log('🔵 Loading scans and training...');
      await Promise.all([
        loadRecentScans(displayName, siteId),
        loadTraining(displayName, siteId, isClinicalRole(roleDetail))
      ]);
      console.log('🟢 Dashboard loaded successfully');
    }

    async function loadRecentScans(displayName, siteId){
      console.log('🔵 loadRecentScans called:', displayName, siteId);
      const loadingEl = document.getElementById('recent-scans-loading');
      const wrap = document.getElementById('recent-scans-wrap');
      const table = document.getElementById('recent-scans');
      const tbody = table.querySelector('tbody');
      const emptyEl = document.getElementById('recent-scans-empty');

      try{
        let rows = [];
        if (siteId){
          console.log('🔵 Querying v_submission_detail...');
          const v = await supabase
            .from('v_submission_detail')
            .select('submitted_at,item_name,room,check_type,check_value,staff_name,site_id')
            .eq('site_id', siteId)
            .eq('staff_name', displayName)
            .order('submitted_at', { ascending:false })
            .limit(8);
          console.log('🔵 v_submission_detail result:', v.error ? `Error: ${v.error.message}` : `${v.data?.length} rows`);
          if (!v.error && v.data) rows = v.data;
        }

        if (!rows?.length){
          console.log('🔵 Fallback to submissions...');
          const s = await supabase
            .from('submissions')
            .select('submitted_at, staff_name, comment')
            .eq('staff_name', displayName)
            .order('submitted_at', { ascending:false })
            .limit(5);
          console.log('🔵 submissions result:', s.error ? `Error: ${s.error.message}` : `${s.data?.length} rows`);
          if (!s.error && s.data){
            rows = s.data.map(r => ({ submitted_at:r.submitted_at, item_name:'—', room:'—', check_type:'—', check_value:r.comment||'Done' }));
          }
        }

        loadingEl.style.display = 'none';

        if (!rows?.length){
          console.log('🔵 No scans found, showing empty state');
          emptyEl.style.display = 'block';
          return;
        }

        console.log('🔵 Rendering', rows.length, 'scans');
        tbody.innerHTML = rows.map(r => `
          <tr>
            <td>${fmtDate(r.submitted_at)}</td>
            <td>${r.item_name || '—'}</td>
            <td>${r.room || '—'}</td>
            <td>${r.check_type || '—'}</td>
            <td>${r.check_value || '—'}</td>
          </tr>`).join('');
        wrap.style.display = '';

        document.getElementById('kpi-scans').textContent = String(rows.length);
      } catch (e){
        console.error('🔴 Recent scans error', e);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
      }
    }

    async function loadTraining(displayName, siteId, clinical){
      const loadingEl = document.getElementById('training-loading');
      const wrap = document.getElementById('training-wrap');
      const table = document.getElementById('training-table');
      const tbody = table.querySelector('tbody');
      const emptyEl = document.getElementById('training-empty');

      let required = [];
      let myRecords = [];

      try{
        if (siteId){
          const tt = await supabase
            .from('training_types')
            .select('id,name,validity_months,is_clinical_required,is_non_clinical_required,active')
            .eq('site_id', siteId)
            .eq('active', true);
          const allTypes = (!tt.error && tt.data) ? tt.data : [];
          required = allTypes.filter(t => clinical ? t.is_clinical_required : t.is_non_clinical_required);
        }

        let kioskId = null;
        if (siteId){
          const ku = await supabase
            .from('kiosk_users')
            .select('id')
            .eq('site_id', siteId)
            .eq('full_name', displayName)
            .maybeSingle();
          kioskId = ku?.data?.id || null;
        }

        if (siteId && kioskId){
          const tr = await supabase
            .from('training_records')
            .select('id,training_type_id,completion_date,expiry_date,certificate_url')
            .eq('site_id', siteId)
            .eq('staff_id', kioskId);
          if (!tr.error && tr.data) myRecords = tr.data;
        }

        const now = new Date();
        let okCount = 0, dueCount = 0;

        const rows = (required.length ? required : []).map(t => {
          const recs = myRecords.filter(r => r.training_type_id === t.id);
          const latest = recs.sort((a,b)=> new Date(b.expiry_date||b.completion_date||0) - new Date(a.expiry_date||a.completion_date||0))[0];
          let statusHtml = '<span class="badge info">Not started</span>';
          let validUntil = '—';
          if (latest){
            const expiry = latest.expiry_date || (t.validity_months ? new Date(new Date(latest.completion_date).setMonth(new Date(latest.completion_date).getMonth()+Number(t.validity_months))) : null);
            if (expiry){
              const days = daysBetween(expiry, now);
              validUntil = new Date(expiry).toLocaleDateString();
              if (days < 0){ statusHtml = '<span class="badge danger">Expired</span>'; dueCount++; }
              else if (days <= 30){ statusHtml = '<span class="badge warn">Due soon</span>'; dueCount++; }
              else { statusHtml = '<span class="badge ok">Valid</span>'; okCount++; }
            } else {
              statusHtml = '<span class="badge ok">Completed</span>';
              okCount++;
            }
          } else {
            dueCount++;
          }
          return `
            <tr>
              <td>${t.name}</td>
              <td>${statusHtml}</td>
              <td class="right">${validUntil}</td>
            </tr>`;
        });

        loadingEl.style.display = 'none';

        if (!rows.length){
          emptyEl.style.display = 'block';
        } else {
          tbody.innerHTML = rows.join('');
          wrap.style.display = '';
        }

        document.getElementById('kpi-training-ok').textContent = required.length ? String(okCount) : '0';
        document.getElementById('kpi-training-due').textContent = required.length ? String(dueCount) : '0';
      } catch(e){
        console.error('Training load error', e);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
        document.getElementById('kpi-training-ok').textContent = '0';
        document.getElementById('kpi-training-due').textContent = '0';
      }
    }

    // Auth state safety
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT' || !session) {
        if (!isLoggingOut) { isLoggingOut = true; cleanupAndRedirect(); }
      }
    });
  </script>
</body>
</html>

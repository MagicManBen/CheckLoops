<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Test Exact Issue</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<h1>Testing Exact Update Issue</h1>
<button onclick="testUpdate()">Test Update</button>
<pre id="output"></pre>

<script>
const SUPABASE_URL = 'https://unveoqnlqnobufhublyw.supabase.co';
const ANON_KEY = 'sb_publishable_wpy7lxfbI2HwvsznlWJVKg_Zx7HnAc4';
const TABLE = 'CQC All GPs';

const supabase = window.supabase.createClient(SUPABASE_URL, ANON_KEY);
const output = document.getElementById('output');

function log(msg, data) {
  output.textContent += msg + '\n';
  if (data) {
    output.textContent += JSON.stringify(data, null, 2) + '\n';
  }
}

async function testUpdate() {
  output.textContent = '';

  // Test the EXACT same update that smartsetup.html does
  const update = {
    constituency: 'Kingston and Surbiton',
    provider_constituency: 'Kingston and Surbiton',
    current_ratings: JSON.stringify({ test: 'data' }),
    updated_at: new Date().toISOString()
  };

  log('Testing update with:', update);

  const { data, error } = await supabase
    .from(TABLE)
    .update(update)
    .eq('location_id', '1-11309361439')
    .select('*');

  log('\nError:', error);
  log('Data is null?', data === null);
  log('Data is array?', Array.isArray(data));
  log('Data length:', data?.length);

  if (!data || data.length === 0) {
    log('\n❌ UPDATE BLOCKED - 0 rows returned');
  } else {
    log('\n✅ UPDATE SUCCESSFUL - ' + data.length + ' rows returned');
    log('Updated fields:', {
      constituency: data[0].constituency,
      provider_constituency: data[0].provider_constituency,
      current_ratings: data[0].current_ratings ? 'Has data' : 'NULL'
    });
  }
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Holiday Data</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        pre {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .user-card {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #444;
        }
        .highlight {
            background: #ffff00;
            color: #000;
            padding: 2px 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Holiday Data Test</h1>
    <div>
        <button onclick="testMasterUsers()">Test master_users Table</button>
        <button onclick="testHolidaysView()">Test holidays View</button>
        <button onclick="testHolidayRequests()">Test holiday_requests Table</button>
    </div>

    <div id="output"></div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://unveoqnlqnobufhublyw.supabase.co';
        const supabaseAnonKey = 'sb_publishable_wpy7lxfbI2HwvsznlWJVKg_Zx7HnAc4';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        const output = document.getElementById('output');

        function log(title, data) {
            const section = document.createElement('div');
            section.innerHTML = `<h2>${title}</h2><pre>${JSON.stringify(data, null, 2)}</pre>`;
            output.appendChild(section);
        }

        async function testMasterUsers() {
            output.innerHTML = '<h2>Testing master_users table...</h2>';

            try {
                // Test 1: Get all users
                const { data: allUsers, error: allError } = await supabase
                    .from('master_users')
                    .select('*')
                    .order('full_name');

                if (allError) {
                    log('Error fetching all users:', allError);
                } else {
                    log(`Found ${allUsers?.length || 0} users in master_users:`, allUsers);

                    // Highlight Ben and Gemma
                    const benAndGemma = allUsers?.filter(u =>
                        u.full_name?.includes('Ben Howard') ||
                        u.full_name?.includes('Gemma Keeling')
                    );

                    if (benAndGemma?.length > 0) {
                        benAndGemma.forEach(user => {
                            const card = document.createElement('div');
                            card.className = 'user-card';
                            card.innerHTML = `
                                <h3>${user.full_name}</h3>
                                <p>Email: ${user.email}</p>
                                <p>Auth User ID: ${user.auth_user_id}</p>
                                <p>ID: ${user.id}</p>
                                <p>Site ID: ${user.site_id}</p>
                                <p class="highlight">approved_holidays_used: ${user.approved_holidays_used}</p>
                                <p class="highlight">total_holiday_entitlement: ${user.total_holiday_entitlement}</p>
                                <p>holiday_entitlement: ${user.holiday_entitlement}</p>
                                <p>holiday_taken: ${user.holiday_taken}</p>
                                <p>holiday_remaining: ${user.holiday_remaining}</p>
                            `;
                            output.appendChild(card);
                        });
                    }
                }

                // Test 2: Query with site_id filter
                const { data: siteUsers, error: siteError } = await supabase
                    .from('master_users')
                    .select('full_name, email, approved_holidays_used, total_holiday_entitlement, site_id')
                    .eq('site_id', 2);

                if (siteError) {
                    log('Error fetching site 2 users:', siteError);
                } else {
                    log(`Site 2 users (${siteUsers?.length || 0} found):`, siteUsers);
                }

            } catch (err) {
                log('Unexpected error:', err);
            }
        }


        async function testHolidaysView() {
            output.innerHTML = '<h2>Testing holidays view...</h2>';

            try {
                const { data, error } = await supabase
                    .from('holidays')
                    .select('*')
                    .or('full_name.ilike.%Ben Howard%,full_name.ilike.%Gemma Keeling%');

                if (error) {
                    log('Error:', error);
                } else {
                    log('Ben and Gemma from holidays view:', data);
                }
            } catch (err) {
                log('Unexpected error:', err);
            }
        }

        async function testHolidayRequests() {
            output.innerHTML = '<h2>Testing holiday_requests table...</h2>';

            try {
                const { data, error } = await supabase
                    .from('holiday_requests')
                    .select('*')
                    .eq('status', 'approved')
                    .eq('site_id', 2);

                if (error) {
                    log('Error:', error);
                } else {
                    log('Approved holiday requests for site 2:', data);
                }
            } catch (err) {
                log('Unexpected error:', err);
            }
        }

        // Run test on load
        window.onload = () => {
            testMasterUsers();
        };
    </script>
</body>
</html>
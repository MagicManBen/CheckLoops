<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop — My Training</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <link rel="stylesheet" href="staff.css">
  <script src="fix-navigation-style.js"></script>
  <style>
    .filters{ display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 4px; }
    .chip{ padding:6px 10px; border-radius:999px; background:#ffffff1a; border:1px solid #ffffff2a; cursor:pointer; }
    .chip.active{ background:linear-gradient(135deg,#7db1ff,#4f89ff); }
    /* Modal-specific styles only; global buttons unchanged */

    /* Upload modal: use white background and dark text only for this box */
    #training-upload-modal .modal-content{ background:#ffffff !important; color:#0f172a !important; border:1px solid rgba(15,23,42,0.1) !important; }
    #training-upload-modal .modal-header{ border-bottom:1px solid rgba(15,23,42,0.1) !important; }
    #training-upload-modal .modal-header h3{ color:#0f172a !important; }
    #training-upload-modal .close-btn{ color:#64748b !important; }
    #training-upload-modal .close-btn:hover{ color:#0f172a !important; }
    #training-upload-modal .modal-body, #training-upload-modal .modal-footer{ background:#ffffff !important; color:#0f172a !important; }
    #training-upload-modal label{ color:#0f172a !important; }
    #training-upload-modal .form-group input,
    #training-upload-modal .form-group select,
    #training-upload-modal .form-group textarea{
      background:#ffffff !important;
      color:#0f172a !important;
      border:1px solid rgba(15,23,42,0.18) !important;
    }
    #training-upload-modal .form-group select option{ background:#ffffff !important; color:#0f172a !important; }
    #training-upload-modal input::placeholder,
    #training-upload-modal textarea::placeholder{ color:#94a3b8 !important; opacity:1 !important; }
    /* Keep buttons styled and legible on white modal */
    #training-upload-modal .btn.secondary{ background:#1f2937 !important; color:#fff !important; border:1px solid rgba(15,23,42,0.2) !important; }
    
    /* Training table styles */
    #training-table tbody tr {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #training-table tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    /* Expiry countdown styles */
    .expiry-countdown {
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: inline-block;
    }
    .expiry-countdown.expired {
      background-color: #dc2626;
      color: white;
    }
    .expiry-countdown.critical {
      background-color: #ea580c;
      color: white;
    }
    .expiry-countdown.warning {
      background-color: #facc15;
      color: #000;
    }
    .expiry-countdown.good {
      background-color: #16a34a;
      color: white;
    }
    
    /* Modal styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: #1e293b;
      border-radius: 12px;
      padding: 0;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-header h3 {
      margin: 0;
      color: white;
    }
    .close-btn {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .close-btn:hover {
      color: white;
    }
    .modal-body {
      padding: 20px;
    }
    .modal-footer {
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #cbd5e1;
      font-weight: 500;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      color: white;
      font-size: 14px;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      background: rgba(255, 255, 255, 0.08);
    }
    .form-group select option {
      background: #1e293b;
      color: white;
    }
  </style>
</head>
<body>
  <div class="bg"><div class="wave"></div><div class="wave wave2"></div></div>
  <main class="content">
    <div class="topbar panel" style="position:relative;">
      <div class="halo"></div>
      <div class="nav seg-nav">
        <!-- Navigation will be rendered by staff-common.js -->
      </div>
      <div class="spacer"></div>
      
      <div class="pill" id="email-pill">—</div>
      <div class="pill" id="role-pill">—</div>
      <button class="btn" id="logout-btn">Sign Out</button>
      <script type="module">
      import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, daysBetween, attachLogout, createAchievementClient } from './staff-common.js';
        (async function(){
          try{
            console.debug('[staff-training] start');
            const isClinicalRole = (roleDetail='') => /doctor|nurse|clin|pharmacist/i.test(roleDetail);

            const supabase = await initSupabase();
            // Make supabase available globally for Admin Portal button
            window.supabase = supabase;
            console.debug('[staff-training] supabase inited');
            handleAuthState(supabase);
            navActivate('training');
            attachLogout(supabase);

            let achievementClient = null;

            async function refreshTrainingAchievements(metadata = {}) {
              if (!achievementClient) return;
              try {
                const { count } = await supabase
                  .from('training_records')
                  .select('id', { count: 'exact', head: true })
                  .eq('user_id', currentUser.id);

                const totalRecords = count ?? 0;
                await achievementClient.ensureUnlocked('training_triple', {
                  condition: totalRecords >= 3,
                  metadata: { totalRecords, ...metadata }
                });
              } catch (err) {
                console.warn('[staff-training] refreshTrainingAchievements failed', err);
              }
            }

            // Admin nav removed - separate staff portal

            try{
              const { session, profileRow } = await requireStaffSession(supabase);
              console.debug('[staff-training] requireStaffSession OK', session?.user?.id, profileRow);
              const user = session.user;
              const displayName = profileRow?.full_name || user?.raw_user_meta_data?.full_name || (user?.email?.split('@')[0]);
              const siteId = profileRow?.site_id || user?.raw_user_meta_data?.site_id || null;
              const accessType = profileRow?.access_type || user?.raw_user_meta_data?.access_type || null;
              const role = (accessType || profileRow?.role || user?.raw_user_meta_data?.role || 'Staff');
              const roleDetail = role; // setTopbar will format as needed
              setTopbar({ siteText: await getSiteText(supabase, siteId), email: user.email, role: roleDetail , access_type: accessType || profileRow?.role});

              try {
                achievementClient = await createAchievementClient({
                  supabase,
                  session,
                  profile: profileRow
                });
              } catch (err) {
                console.warn('[staff-training] achievement client init failed', err);
              }

              // Create currentUser object for training functionality
              let currentUser = {
                id: user.id,
                siteId,
                displayName,
                roleDetail
              };

              let required = [];
              let myRecords = [];

              if (siteId){
                const tt = await supabase
                  .from('training_types')
                  .select('id,name,validity_months,is_clinical_required,is_non_clinical_required,active')
                  .eq('site_id', siteId)
                  .eq('active', true);
                const allTypes = (!tt.error && tt.data) ? tt.data : [];
                required = allTypes.filter(t => isClinicalRole(roleDetail) ? t.is_clinical_required : t.is_non_clinical_required);
              }

              // Load training records for the authenticated user using user_id (UUID)
              if (siteId && user.id){
                const tr = await supabase
                  .from('training_records')
                  .select('id,training_type_id,completion_date,expiry_date,certificate_url')
                  .eq('site_id', siteId)
                  .eq('user_id', user.id);
                if (!tr.error && tr.data) myRecords = tr.data;
              }

              const now = new Date();
              const rows = (required.length ? required : []).map(t => {
                const recs = myRecords.filter(r => r.training_type_id === t.id);
                const latest = recs.sort((a,b)=> new Date(b.expiry_date||b.completion_date||0) - new Date(a.expiry_date||a.completion_date||0))[0];
                let status = 'info';
                let statusHtml = '<span class="badge info">Not started</span>';
                let expiryCountdown = '';
                if (latest){
                  const expiry = latest.expiry_date || (t.validity_months ? new Date(new Date(latest.completion_date).setMonth(new Date(latest.completion_date).getMonth()+Number(t.validity_months))) : null);
                  if (expiry){
                    const days = daysBetween(expiry, now);
                    const expiryDate = new Date(expiry);
                    
                    // Create countdown display
                    let countdownClass = '';
                    let countdownText = '';
                    
                    if (days < 0) {
                      status = 'danger';
                      statusHtml = '<span class="badge danger">Expired</span>';
                      countdownClass = 'expired';
                      countdownText = `Expired ${Math.abs(days)} days ago`;
                    } else if (days === 0) {
                      status = 'danger';
                      statusHtml = '<span class="badge danger">Expires today</span>';
                      countdownClass = 'critical';
                      countdownText = 'Expires today';
                    } else if (days <= 7) {
                      status = 'warn';
                      statusHtml = '<span class="badge warn">Due soon</span>';
                      countdownClass = 'critical';
                      countdownText = `${days} day${days !== 1 ? 's' : ''} left`;
                    } else if (days <= 30) {
                      status = 'warn';
                      statusHtml = '<span class="badge warn">Due soon</span>';
                      countdownClass = 'warning';
                      countdownText = `${days} days left`;
                    } else {
                      status = 'ok';
                      statusHtml = '<span class="badge ok">Valid</span>';
                      countdownClass = 'good';
                      const months = Math.floor(days / 30);
                      if (months > 0) {
                        countdownText = `${months} month${months !== 1 ? 's' : ''} left`;
                      } else {
                        countdownText = `${days} days left`;
                      }
                    }
                    
                    expiryCountdown = `<span class="expiry-countdown ${countdownClass}">${countdownText}</span>`;
                  } else {
                    status = 'ok';
                    statusHtml = '<span class="badge ok">Completed</span>';
                    expiryCountdown = '<span class="expiry-countdown good">No expiry</span>';
                  }
                } else {
                  expiryCountdown = '<span class="expiry-countdown" style="opacity: 0.5;">Click to add</span>';
                }
                return `<tr data-status="${status}" data-training-id="${t.id}"><td>${t.name}</td><td>${statusHtml}</td><td class="right">${expiryCountdown}</td></tr>`;
              });

              document.getElementById('training-loading').style.display='none';
              if (!rows.length){ document.getElementById('training-empty').style.display='block'; }
              else {
                document.getElementById('training-wrap').style.display='';
                document.querySelector('#training-table tbody').innerHTML = rows.join('');
                // Make rows clickable after rendering
                attachRowClickHandlers();
              }

              // Update progress bar with training data
              updateTrainingProgressBar(required, myRecords);

              // Simple client-side filter
              document.querySelectorAll('.chip').forEach(ch => ch.onclick = () => {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                ch.classList.add('active');
                const f = ch.getAttribute('data-filter');
                document.querySelectorAll('#training-table tbody tr').forEach(tr => {
                  const st = tr.getAttribute('data-status');
                  tr.style.display = (f==='all' || st===f) ? '' : 'none';
                });
              });

              // Training upload functionality
              let trainingTypes = [];
              // currentUser already has the correct user.id from authentication

              // Load training types for dropdown
              if (siteId) {
                const ttResult = await supabase
                  .from('training_types')
                  .select('id,name,validity_months,is_clinical_required,is_non_clinical_required,active')
                  .eq('site_id', siteId)
                  .eq('active', true)
                  .order('name');
                
                if (!ttResult.error && ttResult.data) {
                  trainingTypes = ttResult.data;
                  const select = document.getElementById('training-type-select');
                  trainingTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.name;
                    select.appendChild(option);
                  });
                }
              }

              // Modal event handlers
              document.getElementById('upload-training-btn').addEventListener('click', () => openTrainingModal());
              document.getElementById('training-modal-close').addEventListener('click', closeTrainingModal);
              document.getElementById('training-cancel-btn').addEventListener('click', closeTrainingModal);
              document.getElementById('training-save-btn').addEventListener('click', saveTrainingRecord);
              document.getElementById('training-certificate').addEventListener('change', handleFileUpload);
              document.getElementById('training-completion-date').addEventListener('change', calculateExpiry);
              document.getElementById('training-expiry-period').addEventListener('change', calculateExpiry);
              document.getElementById('training-type-select').addEventListener('change', updateExpiryBasedOnTrainingType);

              // Make rows clickable
              function attachRowClickHandlers() {
                document.querySelectorAll('#training-table tbody tr').forEach(row => {
                  row.addEventListener('click', function() {
                    const trainingName = this.querySelector('td:first-child').textContent;
                    const trainingType = trainingTypes.find(t => t.name === trainingName);
                    if (trainingType) {
                      openTrainingModal(trainingType);
                    }
                  });
                });
              }

              // Training modal functions
              function openTrainingModal(preselectedType = null) {
                document.getElementById('training-upload-modal').style.display = 'flex';
                // Set completion date to today
                document.getElementById('training-completion-date').value = new Date().toISOString().split('T')[0];
                
                // If we have a preselected type, set it and calculate expiry
                if (preselectedType) {
                  document.getElementById('training-type-select').value = preselectedType.id;
                  // Set default expiry period based on training type validity
                  if (preselectedType.validity_months) {
                    if (preselectedType.validity_months <= 1) {
                      document.getElementById('training-expiry-period').value = '1month';
                    } else if (preselectedType.validity_months <= 3) {
                      document.getElementById('training-expiry-period').value = '3months';
                    } else if (preselectedType.validity_months <= 6) {
                      document.getElementById('training-expiry-period').value = '6months';
                    } else if (preselectedType.validity_months <= 12) {
                      document.getElementById('training-expiry-period').value = '1year';
                    } else if (preselectedType.validity_months <= 24) {
                      document.getElementById('training-expiry-period').value = '2years';
                    } else {
                      document.getElementById('training-expiry-period').value = '3years';
                    }
                  }
                }
                
                // Calculate initial expiry
                calculateExpiry();
              }

              function closeTrainingModal() {
                document.getElementById('training-upload-modal').style.display = 'none';
                document.getElementById('training-upload-form').reset();
                document.getElementById('training-upload-error').style.display = 'none';
                window.uploadedFile = null;
              }

              function handleFileUpload(event) {
                const file = event.target.files[0];
                
                if (!file) return;
                
                if (file.size > 10 * 1024 * 1024) {
                  document.getElementById('training-upload-error').textContent = 'File size must be less than 10MB';
                  document.getElementById('training-upload-error').style.display = 'block';
                  return;
                }
                
                window.uploadedFile = file;
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('training-upload-error').style.display = 'none';
              }

              function calculateExpiry() {
                const completionDate = document.getElementById('training-completion-date').value;
                const expiryPeriod = document.getElementById('training-expiry-period').value;
                
                if (!completionDate || !expiryPeriod || expiryPeriod === 'never') {
                  document.getElementById('calculated-expiry').textContent = 'No expiry';
                  return;
                }
                
                const completion = new Date(completionDate);
                const expiry = new Date(completion);
                
                // Calculate based on selected period
                switch(expiryPeriod) {
                  case '1week':
                    expiry.setDate(expiry.getDate() + 7);
                    break;
                  case '1month':
                    expiry.setMonth(expiry.getMonth() + 1);
                    break;
                  case '3months':
                    expiry.setMonth(expiry.getMonth() + 3);
                    break;
                  case '6months':
                    expiry.setMonth(expiry.getMonth() + 6);
                    break;
                  case '1year':
                    expiry.setFullYear(expiry.getFullYear() + 1);
                    break;
                  case '2years':
                    expiry.setFullYear(expiry.getFullYear() + 2);
                    break;
                  case '3years':
                    expiry.setFullYear(expiry.getFullYear() + 3);
                    break;
                }
                
                // Display calculated expiry
                document.getElementById('calculated-expiry').textContent = expiry.toLocaleDateString();
                
                // Store for saving
                window.calculatedExpiryDate = expiry.toISOString().split('T')[0];
              }

              function updateExpiryBasedOnTrainingType() {
                const selectedTypeId = document.getElementById('training-type-select').value;
                if (!selectedTypeId) return;
                
                // Find the selected training type from our loaded types
                const selectedType = trainingTypes.find(t => t.id == selectedTypeId);
                if (!selectedType) return;
                
                // Set expiry period based on the selected training's validity_months
                if (selectedType.validity_months) {
                  if (selectedType.validity_months <= 1) {
                    document.getElementById('training-expiry-period').value = '1month';
                  } else if (selectedType.validity_months <= 3) {
                    document.getElementById('training-expiry-period').value = '3months';
                  } else if (selectedType.validity_months <= 6) {
                    document.getElementById('training-expiry-period').value = '6months';
                  } else if (selectedType.validity_months <= 12) {
                    document.getElementById('training-expiry-period').value = '1year';
                  } else if (selectedType.validity_months <= 24) {
                    document.getElementById('training-expiry-period').value = '2years';
                  } else {
                    document.getElementById('training-expiry-period').value = '3years';
                  }
                } else {
                  // If no validity_months, set to no expiry
                  document.getElementById('training-expiry-period').value = 'never';
                }
                
                // Recalculate expiry date based on the new expiry period
                calculateExpiry();
              }

              async function saveTrainingRecord(event) {
                if (event) event.preventDefault();
                
                const errorDiv = document.getElementById('training-upload-error');
                errorDiv.style.display = 'none';
                
                try {
                  // Get form values
                  const typeId = document.getElementById('training-type-select').value;
                  const completionDate = document.getElementById('training-completion-date').value;
                  const expiryDate = window.calculatedExpiryDate || null;
                  const notes = document.getElementById('training-notes').value;
                  
                  if (!typeId || !completionDate) {
                    errorDiv.textContent = 'Please fill in all required fields';
                    errorDiv.style.display = 'block';
                    return;
                  }
                  
                  if (!currentUser.id) {
                    errorDiv.textContent = 'User session not found. Please refresh and try again.';
                    errorDiv.style.display = 'block';
                    return;
                  }
                  
                  let certificateUrl = null;
                  
                  // Upload file if provided
                  if (window.uploadedFile) {
                    const file = window.uploadedFile;
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${currentUser.id}_${typeId}_${Date.now()}.${fileExt}`;
                    const filePath = `${currentUser.siteId}/training_certificates/${fileName}`;
                    
                    const { data: uploadData, error: uploadError } = await supabase.storage
                      .from('training_certificates')
                      .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                      });
                    
                    if (uploadError) {
                      console.error('Upload error:', uploadError);
                      errorDiv.textContent = 'Failed to upload certificate: ' + uploadError.message;
                      errorDiv.style.display = 'block';
                      return;
                    }
                    
                    certificateUrl = filePath;
                  }
                  
                  // Prepare record data using user_id (UUID standard)
                  const recordData = {
                    site_id: currentUser.siteId,
                    user_id: currentUser.id,
                    training_type_id: parseInt(typeId),
                    completion_date: completionDate,
                    expiry_date: expiryDate,
                    notes: notes || null,
                    certificate_url: certificateUrl
                  };
                  
                  // Save to database
                  const { data, error } = await supabase
                    .from('training_records')
                    .insert(recordData);
                  
                  if (error) {
                    console.error('Database error:', error);
                    errorDiv.textContent = 'Failed to save training record: ' + error.message;
                    errorDiv.style.display = 'block';
                    return;
                  }
                  
                  // Success - close modal and reload page
                  closeTrainingModal();

                  if (achievementClient) {
                    try {
                      await achievementClient.ensureUnlocked('first_training_upload', {
                        metadata: {
                          training_type_id: parseInt(typeId),
                          completion_date: completionDate,
                          has_certificate: Boolean(certificateUrl)
                        }
                      });
                      await refreshTrainingAchievements({
                        training_type_id: parseInt(typeId),
                        completion_date: completionDate,
                        has_certificate: Boolean(certificateUrl)
                      });
                    } catch (achievementError) {
                      console.warn('Failed to unlock training achievements:', achievementError);
                    }
                  }

                  // Show success message
                  const successDiv = document.createElement('div');
                  successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success, #28a745); color: white; padding: 12px 20px; border-radius: 6px; z-index: 10000; font-weight: 600;';
                  successDiv.textContent = 'Training record saved successfully!';
                  document.body.appendChild(successDiv);
                  
                  setTimeout(() => {
                    successDiv.remove();
                    // Refresh training data instead of reloading page to prevent debugger interference
                    if (typeof loadTrainingData === 'function') {
                      loadTrainingData();
                    } else if (typeof refreshTraining === 'function') {
                      refreshTraining();
                    } else if (typeof initializeTraining === 'function') {
                      initializeTraining();
                    }
                  }, 2000);
                  
                } catch (error) {
                  console.error('Save error:', error);
                  errorDiv.textContent = 'Failed to save training record. Please try again.';
                  errorDiv.style.display = 'block';
                }
              }

              } catch(e){
                console.error('Upload error:', e);
              }

              // Progress bar functions
              function updateProgressBar(requiredTypes, myRecords) {
                const now = new Date();
                let valid = 0, dueSoon = 0, overdue = 0, total = requiredTypes.length;
                let nextExpiringDate = null;
                let nextExpiringName = '';
                let recentActivity = [];

                requiredTypes.forEach(type => {
                  const records = myRecords.filter(r => r.training_type_id === type.id);
                  const latest = records.sort((a,b)=> new Date(b.expiry_date||b.completion_date||0) - new Date(a.expiry_date||a.completion_date||0))[0];
                  
                  if (!latest) {
                    overdue++;
                    return;
                  }

                  const expiry = latest.expiry_date ? new Date(latest.expiry_date) : 
                    (type.validity_months ? new Date(new Date(latest.completion_date).setMonth(new Date(latest.completion_date).getMonth() + Number(type.validity_months))) : null);
                  
                  if (!expiry) {
                    valid++;
                    return;
                  }

                  const days = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
                  
                  if (days < 0) {
                    overdue++;
                  } else if (days <= 30) {
                    dueSoon++;
                    
                    // Track next expiring
                    if (!nextExpiringDate || expiry < nextExpiringDate) {
                      nextExpiringDate = expiry;
                      nextExpiringName = type.name;
                    }
                  } else {
                    valid++;
                  }

                  // Track recent activity (completed in last 30 days)
                  if (latest.completion_date) {
                    const completionDate = new Date(latest.completion_date);
                    const daysSinceCompletion = Math.ceil((now - completionDate) / (1000 * 60 * 60 * 24));
                    if (daysSinceCompletion <= 30) {
                      recentActivity.push({
                        name: type.name,
                        date: completionDate,
                        days: daysSinceCompletion
                      });
                    }
                  }
                });

                const percentage = total > 0 ? Math.round((valid / total) * 100) : 0;

                // Update progress ring
                const circumference = 283; // 2 * π * 45
                const offset = circumference - (percentage / 100) * circumference;
                document.getElementById('training-progress-ring').style.strokeDashoffset = offset;

                // Update numbers with animation
                animateNumber(document.getElementById('training-percentage'), percentage, '%', 1000);
                animateNumber(document.getElementById('valid-count'), valid, '', 600);
                animateNumber(document.getElementById('due-soon-count'), dueSoon, '', 800);
                animateNumber(document.getElementById('overdue-count'), overdue, '', 1000);

                // Update next expiring
                const nextExpiringEl = document.getElementById('next-expiring');
                if (nextExpiringDate && nextExpiringName) {
                  const days = Math.ceil((nextExpiringDate - now) / (1000 * 60 * 60 * 24));
                  nextExpiringEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                      <div style="font-weight: 600; color: #f8fbff; font-size: 13px;">${nextExpiringName}</div>
                      <div style="color: ${days <= 7 ? '#ef4444' : days <= 14 ? '#fbbf24' : '#94a3b8'}; font-size: 12px;">
                        ${days > 0 ? `Expires in ${days} day${days !== 1 ? 's' : ''}` : 'Expired'}
                      </div>
                    </div>
                  `;
                } else {
                  nextExpiringEl.innerHTML = '<div style="color: #94a3b8;">All training up to date! 🎉</div>';
                }

                // Update recent activity
                const recentEl = document.getElementById('recent-training');
                if (recentActivity.length > 0) {
                  const latest = recentActivity.sort((a,b) => b.date - a.date)[0];
                  recentEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                      <div style="font-weight: 600; color: #f8fbff; font-size: 13px;">${latest.name}</div>
                      <div style="color: #22c55e; font-size: 12px;">
                        Completed ${latest.days} day${latest.days !== 1 ? 's' : ''} ago
                      </div>
                    </div>
                  `;
                } else {
                  recentEl.innerHTML = '<div style="color: #94a3b8;">No recent activity</div>';
                }
              }

              // Function to update the training progress bar
              function updateTrainingProgressBar(requiredTypes, userRecords) {
                const now = new Date();
                let validCount = 0;
                const totalCount = requiredTypes.length;

                // Calculate valid training items
                requiredTypes.forEach(type => {
                  const records = userRecords.filter(r => r.training_type_id === type.id);
                  const latest = records.sort((a,b)=> new Date(b.expiry_date||b.completion_date||0) - new Date(a.expiry_date||a.completion_date||0))[0];
                  
                  if (latest) {
                    const expiry = latest.expiry_date ? new Date(latest.expiry_date) : (type.validity_months ? new Date(new Date(latest.completion_date).setMonth(new Date(latest.completion_date).getMonth()+Number(type.validity_months))) : null);
                    
                    if (!expiry || expiry > now) {
                      validCount++;
                    }
                  }
                });

                // Calculate percentage
                const percentage = totalCount > 0 ? Math.round((validCount / totalCount) * 100) : 0;
                
                // Update progress bar
                const progressBar = document.getElementById('training-progress-bar');
                const progressLabel = document.getElementById('training-progress-label');
                
                if (progressBar) {
                  // Animate the progress bar
                  setTimeout(() => {
                    progressBar.style.width = `${percentage}%`;
                  }, 100);
                }
                
                if (progressLabel) {
                  progressLabel.textContent = `${percentage}% Training Complete (${validCount}/${totalCount})`;
                }

                console.log(`Training progress: ${validCount}/${totalCount} = ${percentage}%`);
              }

              function animateNumber(element, targetValue, suffix = '', duration = 1000) {
                const startValue = 0;
                const startTime = performance.now();
                
                function updateNumber(currentTime) {
                  const elapsed = currentTime - startTime;
                  const progress = Math.min(elapsed / duration, 1);
                  const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                  const currentValue = Math.round(startValue + (targetValue - startValue) * easeOutQuart);
                  
                  element.textContent = currentValue + suffix;
                  
                  if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                  }
                }
                
                requestAnimationFrame(updateNumber);
              }

              // Toggle details functionality
              document.getElementById('training-toggle').addEventListener('click', function() {
                const details = document.getElementById('training-details');
                const icon = this.querySelector('svg');
                const isExpanded = details.style.display !== 'none';
                
                if (isExpanded) {
                  details.style.display = 'none';
                  icon.style.transform = 'rotate(0deg)';
                } else {
                  details.style.display = 'block';
                  icon.style.transform = 'rotate(180deg)';
                }
              });

            } catch(e){
              // requireStaffSession or inner errors
              if (String(e.message).includes('NO_SESSION')) { window.location.replace('home.html'); return; }
              if (String(e.message).includes('NOT_STAFF')) { window.location.replace('home.html'); return; }
              console.error('[staff-training] inner error', e);
              document.getElementById('training-loading').style.display='none';
              document.getElementById('training-empty').style.display='block';
            }
        })();
      </script>
    </div>

    <div class="panel" style="margin-top:12px">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="illus-circle" aria-hidden="true"><img src="https://api.iconify.design/fluent-emoji-flat:books.svg" alt="Training"></div>
        <h2 style="margin:0">My Training</h2>
        <div style="flex:1"></div>
        <button class="btn primary" id="upload-training-btn" style="margin-right: 12px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17,8 12,3 7,8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Upload Training
        </button>
      </div>

      <!-- Training Progress Bar -->
      <div class="progress-wrap" style="margin-top:20px; padding:0 8px;">
        <div class="progress" style="height:12px; background:#e5e7eb; border-radius:999px; overflow:hidden; border:1px solid rgba(255, 255, 255, 0.1);">
          <div id="training-progress-bar" class="bar" style="height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#a78bfa); transition: width 0.8s ease;"></div>
        </div>
        <div id="training-progress-label" class="meta-note" style="text-align:right; margin-top:8px; color: #f8fbff; font-size: 14px; font-weight: 500;">0% Training Complete</div>
      </div>

      <div style="display:flex;align-items:center;gap:12px; margin-top: 20px;">
        <div class="filters">
          <div class="chip active" data-filter="all">All</div>
          <div class="chip" data-filter="ok">Valid</div>
          <div class="chip" data-filter="warn">Due soon</div>
          <div class="chip" data-filter="danger">Expired</div>
        </div>
      </div>

      <div id="training-loading" style="padding:30px;text-align:center">Loading...</div>
      <div id="training-empty" style="display:none;padding:20px;text-align:center">No training items found.</div>

      <div id="training-wrap" style="display:none;margin-top:12px">
        <table id="training-table" class="table" style="width:100%">
          <thead><tr><th>Training</th><th>Status</th><th class="right">Expiry Countdown</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Training Upload Modal -->
  <div id="training-upload-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Add Training Record</h3>
        <button class="close-btn" id="training-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="training-upload-form">
          <div class="form-group">
            <label for="training-type-select">Training Type *</label>
            <select id="training-type-select" required>
              <option value="">Select training type...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="training-completion-date">Completion Date *</label>
            <input type="date" id="training-completion-date" required>
          </div>
          
          <div class="form-group">
            <label for="training-expiry-period">Expiry Period *</label>
            <select id="training-expiry-period" required>
              <option value="1week">1 Week</option>
              <option value="1month">1 Month</option>
              <option value="3months">3 Months</option>
              <option value="6months">6 Months</option>
              <option value="1year" selected>1 Year</option>
              <option value="2years">2 Years</option>
              <option value="3years">3 Years</option>
              <option value="never">No Expiry</option>
            </select>
            <small style="color: #94a3b8; display: block; margin-top: 4px;">Calculated expiry: <span id="calculated-expiry">-</span></small>
          </div>
          
          <div class="form-group">
            <label>Certificate File (Optional)</label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="file" id="training-certificate" accept=".pdf,.jpg,.jpeg,.png" style="flex: 1;">
              <span id="file-name" style="color: #94a3b8; font-size: 14px;"></span>
            </div>
            <small style="color: #94a3b8;">PDF, JPG, PNG (max 10MB)</small>
          </div>
          
          <div class="form-group">
            <label for="training-notes">Notes</label>
            <textarea id="training-notes" rows="3" placeholder="Additional notes (optional)"></textarea>
          </div>
        </form>
        
        <div id="training-upload-error" style="color: #ef4444; margin-top: 10px; display: none; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;"></div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn secondary" id="training-cancel-btn">Cancel</button>
        <button type="submit" class="btn primary" id="training-save-btn">Save Training Record</button>
      </div>
    </div>
  </div>


    <!-- Debug Console - Persistent across all pages -->
    <script src="debug-console.js"></script>
    <script src="supabase-debug.js"></script>
</body>
</html>

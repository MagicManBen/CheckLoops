<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop â€” My Training</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.supabase.co https://*.supabase.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' https://*.supabase.co https://*.supabase.com wss://*.supabase.co wss://*.supabase.com https:;">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <script src="supabase-js.js"></script>
  <!-- Standardized Staff Navigation -->
  <link rel="stylesheet" href="staff-nav.css">
  <script src="staff-nav.js"></script>
  <style>
    :root {
      /* Primary color palette - matching homepage */
      --primary: #0b4fb3;
      --primary-dark: #062b6f;
      --primary-light: #2b6ecc;
      --primary-lightest: #e8f2ff;

      /* Accent colors */
      --accent: #76a7ff;
      --accent-2: #5f96ff;
      --success: #2bd4a7;
      --success-light: #e8fdf8;
      --warning: #ffca28;
      --warning-light: #fffbeb;
      --danger: #ff6b6b;
      --danger-light: #fef2f2;

      /* Neutral colors */
      --white: #ffffff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);

      /* Border radius */
      --radius-sm: 0.375rem;
      --radius: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;

      /* Typography */
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
      --font-display: 'Plus Jakarta Sans', 'Inter', sans-serif;

      /* Transitions */
      --transition: all 0.2s ease-in-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: var(--font-sans);
      background: linear-gradient(135deg, var(--primary-lightest) 0%, var(--white) 100%);
      min-height: 100vh;
      color: var(--gray-900);
      position: relative;
      overflow-x: hidden;
    }

    /* Subtle background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="%23e2e8f0" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
      z-index: -1;
    }

    /* Remove old background animations */
    .bg, .wave, .mesh { display: none; }

    /* Page container */
    .page-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Main content */
    .content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      flex: 1;
      position: relative;
      z-index: 1;
    }

    /* Modern panel styling */
    .panel {
      background: var(--white);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    /* Top navigation bar */
    .topbar {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav {
      display: flex;
      gap: 0.5rem;
    }

    .nav a {
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      color: var(--gray-600);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
    }

    .nav a:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .nav a.active {
      background: var(--primary-lightest);
      color: var(--primary);
      font-weight: 600;
    }

    .spacer {
      flex: 1;
    }

    .pill {
      padding: 0.375rem 0.75rem;
      border-radius: 999px;
      background: var(--gray-100);
      color: var(--gray-700);
      font-size: 0.875rem;
      font-weight: 500;
    }

    /* Modern button styles */
    .btn {
      padding: 0.75rem 1.25rem;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.9375rem;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .btn:hover {
      background: var(--gray-200);
    }

    .btn.primary, .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn.primary:hover, .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn.secondary, .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }

    .btn.secondary:hover, .btn-secondary:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
    }

    /* Filter chips */
    .filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }

    .chip {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-600);
      transition: var(--transition);
    }

    .chip:hover {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    /* Modern table styling */
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .table thead {
      background: var(--gray-50);
      border-bottom: 2px solid var(--gray-200);
    }

    .table th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--gray-700);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .table td {
      padding: 1rem;
      border-bottom: 1px solid var(--gray-100);
      color: var(--gray-900);
    }

    .table tbody tr {
      transition: var(--transition);
    }

    .table tbody tr:hover {
      background: var(--gray-50);
    }

    .table .right {
      text-align: right;
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.375rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge.ok {
      background: var(--success-light);
      color: #059669;
      border: 1px solid #6ee7b7;
    }

    .badge.warn {
      background: var(--warning-light);
      color: #b45309;
      border: 1px solid #fcd34d;
    }

    .badge.danger {
      background: var(--danger-light);
      color: #b91c1c;
      border: 1px solid #fca5a5;
    }

    .badge.info {
      background: var(--primary-lightest);
      color: var(--primary);
      border: 1px solid var(--primary-light);
    }
    /* Training table specific styles */
    #training-table tbody tr {
      cursor: pointer;
    }
    /* Expiry countdown styles */
    .expiry-countdown {
      font-weight: 600;
      padding: 0.375rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      display: inline-block;
    }
    .expiry-countdown.expired {
      background: var(--danger-light);
      color: #b91c1c;
      border: 1px solid #fca5a5;
    }
    .expiry-countdown.critical {
      background: var(--warning-light);
      color: #b45309;
      border: 1px solid #fcd34d;
    }
    .expiry-countdown.warning {
      background: #fff7ed;
      color: #ea580c;
      border: 1px solid #fed7aa;
    }
    .expiry-countdown.good {
      background: var(--success-light);
      color: #059669;
      border: 1px solid #6ee7b7;
    }
    /* Modern modal styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.5);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal-content {
      background: var(--white);
      border-radius: var(--radius-2xl);
      padding: 0;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow-2xl);
      position: relative;
    }

    .modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h3 {
      margin: 0;
      color: var(--gray-900);
      font-size: 1.25rem;
      font-weight: 700;
      font-family: var(--font-display);
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--gray-400);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .close-btn:hover {
      color: var(--gray-700);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      background: var(--gray-50);
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--gray-700);
      font-weight: 600;
      font-size: 0.875rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-300);
      background: var(--white);
      border-radius: var(--radius);
      color: var(--gray-900);
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 79, 179, 0.1);
    }

    .form-group select option {
      background: var(--white);
      color: var(--gray-900);
    }

    .form-group small {
      display: block;
      margin-top: 0.25rem;
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    /* Progress bar styling */
    .progress-wrap {
      margin: 1.5rem 0;
    }

    .progress {
      height: 12px;
      background: var(--gray-200);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid var(--gray-300);
    }

    .bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transition: width 0.8s ease;
    }

    .meta-note {
      text-align: right;
      margin-top: 0.5rem;
      color: var(--gray-600);
      font-size: 0.875rem;
      font-weight: 500;
    }

    /* Icon containers */
    .illus-circle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-lightest), var(--gray-50));
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    .illus-circle img {
      width: 32px;
      height: 32px;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 2rem;
      color: var(--gray-500);
      font-size: 0.875rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .content {
        padding: 1rem;
      }

      .topbar {
        padding: 0.75rem 1rem;
        flex-wrap: wrap;
      }

      .filters {
        width: 100%;
      }
    }

    /* Full-width layout just for this page */
    .content.content-wide {
      max-width: none;
      margin: 0;
      padding-left: 0;
      padding-right: 0;
    }
  </style>
</head>
<body>
  <div class="page-container">
    <!-- Standard nav mount point -->
    <div id="navbar-root"></div>
      <script type="module">
      import { initSupabase, requireStaffSession, getSiteText, setTopbar, handleAuthState, navActivate, daysBetween, attachLogout, createAchievementClient } from './staff-common.js';
        (async function(){
          try{
            console.debug('[staff-training] start');
            const isClinicalRole = (roleDetail='') => /doctor|nurse|clin|pharmacist/i.test(roleDetail);

            const supabase = await initSupabase();
            // Make supabase available globally for Admin Portal button
            window.supabase = supabase;
            console.debug('[staff-training] supabase inited');
            handleAuthState(supabase);
            if (typeof window.renderStandardStaffNav === 'function') {
              window.renderStandardStaffNav('staff-training.html');
            }
            navActivate('training');
            attachLogout(supabase);

            let achievementClient = null;

            async function refreshTrainingAchievements(metadata = {}) {
              if (!achievementClient) return;
              try {
                const { count } = await supabase
                  .from('training_records')
                  .select('id', { count: 'exact', head: true })
                  .eq('user_id', currentUser.id);

                const totalRecords = count ?? 0;
                await achievementClient.ensureUnlocked('training_triple', {
                  condition: totalRecords >= 3,
                  metadata: { totalRecords, ...metadata }
                });
              } catch (err) {
                console.warn('[staff-training] refreshTrainingAchievements failed', err);
              }
            }

            // Admin nav removed - separate staff portal

            try{
              const { session, profileRow } = await requireStaffSession(supabase);
              console.debug('[staff-training] requireStaffSession OK', session?.user?.id, profileRow);
              const user = session.user;
              const displayName = profileRow?.full_name || user?.raw_user_meta_data?.full_name || (user?.email?.split('@')[0]);
              const siteId = profileRow?.site_id || user?.raw_user_meta_data?.site_id || null;
              const accessType = profileRow?.access_type || user?.raw_user_meta_data?.access_type || null;
              const role = (accessType || profileRow?.role || user?.raw_user_meta_data?.role || 'Staff');
              const roleDetail = role; // setTopbar will format as needed
              setTopbar({ siteText: await getSiteText(supabase, siteId), email: user.email, role: roleDetail , access_type: accessType || profileRow?.role});

              // Show admin portal button for admins/owners
              const adminRole = (accessType || profileRow?.role || '').toLowerCase();
              const adminPortalBtn = document.getElementById('adminPortalBtn');
              if (adminPortalBtn) {
                if (adminRole === 'admin' || adminRole === 'owner') {
                  adminPortalBtn.style.display = 'inline-flex';
                } else {
                  adminPortalBtn.style.display = 'none';
                }
              }

              try {
                achievementClient = await createAchievementClient({
                  supabase,
                  session,
                  profile: profileRow
                });
              } catch (err) {
                console.warn('[staff-training] achievement client init failed', err);
              }

              // Create currentUser object for training functionality
              let currentUser = {
                id: user.id,
                siteId,
                displayName,
                roleDetail
              };

              let required = [];
              let myRecords = [];

              if (siteId){
                const tt = await supabase
                  .from('training_types')
                  .select('id,name,validity_months,is_clinical_required,is_non_clinical_required,active')
                  .eq('site_id', siteId)
                  .eq('active', true);
                const allTypes = (!tt.error && tt.data) ? tt.data : [];
                required = allTypes.filter(t => isClinicalRole(roleDetail) ? t.is_clinical_required : t.is_non_clinical_required);
              }

              // Load training records for the authenticated user using user_id (UUID)
              if (siteId && user.id){
                const tr = await supabase
                  .from('training_records')
                  .select('id,training_type_id,completion_date,expiry_date,certificate_url')
                  .eq('site_id', siteId)
                  .eq('user_id', user.id);
                if (!tr.error && tr.data) myRecords = tr.data;
              }

              const now = new Date();
              const rows = (required.length ? required : []).map(t => {
                const recs = myRecords.filter(r => r.training_type_id === t.id);
                const latest = recs.sort((a,b)=> new Date(b.expiry_date||b.completion_date||0) - new Date(a.expiry_date||a.completion_date||0))[0];
                let status = 'info';
                let statusHtml = '<span class="badge info">Not started</span>';
                let expiryCountdown = '';
                if (latest){
                  const expiry = latest.expiry_date || (t.validity_months ? new Date(new Date(latest.completion_date).setMonth(new Date(latest.completion_date).getMonth()+Number(t.validity_months))) : null);
                  if (expiry){
                    const days = daysBetween(expiry, now);
                    const expiryDate = new Date(expiry);
                    
                    // Create countdown display
                    let countdownClass = '';
                    let countdownText = '';
                    
                    if (days < 0) {
                      status = 'danger';
                      statusHtml = '<span class="badge danger">Expired</span>';
                      countdownClass = 'expired';
                      countdownText = `Expired ${Math.abs(days)} days ago`;
                    } else if (days === 0) {
                      status = 'danger';
                      statusHtml = '<span class="badge danger">Expires today</span>';
                      countdownClass = 'critical';
                      countdownText = 'Expires today';
                    } else if (days <= 7) {
                      status = 'warn';
                      statusHtml = '<span class="badge warn">Due soon</span>';
                      countdownClass = 'critical';
                      countdownText = `${days} day${days !== 1 ? 's' : ''} left`;
                    } else if (days <= 30) {
                      status = 'warn';
                      statusHtml = '<span class="badge warn">Due soon</span>';
                      countdownClass = 'warning';
                      countdownText = `${days} days left`;
                    } else {
                      status = 'ok';
                      statusHtml = '<span class="badge ok">Valid</span>';
                      countdownClass = 'good';
                      const months = Math.floor(days / 30);
                      if (months > 0) {
                        countdownText = `${months} month${months !== 1 ? 's' : ''} left`;
                      } else {
                        countdownText = `${days} days left`;
                      }
                    }
                    
                    expiryCountdown = `<span class="expiry-countdown ${countdownClass}">${countdownText}</span>`;
                  } else {
                    status = 'ok';
                    statusHtml = '<span class="badge ok">Completed</span>';
                    expiryCountdown = '<span class="expiry-countdown good">No expiry</span>';
                  }
                } else {
                  expiryCountdown = '<span class="expiry-countdown" style="color: var(--gray-400);">Click to add</span>';
                }
                return `<tr data-status="${status}" data-training-id="${t.id}"><td>${t.name}</td><td>${statusHtml}</td><td class="right">${expiryCountdown}</td></tr>`;
              });

              document.getElementById('training-loading').style.display='none';
              if (!rows.length){ document.getElementById('training-empty').style.display='block'; }
              else {
                document.getElementById('training-wrap').style.display='';
                document.querySelector('#training-table tbody').innerHTML = rows.join('');
                // Make rows clickable after rendering
                attachRowClickHandlers();
              }

              // Update progress bar with training data
              updateTrainingProgressBar(required, myRecords);

              // Simple client-side filter
              document.querySelectorAll('.chip').forEach(ch => ch.onclick = () => {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                ch.classList.add('active');
                const f = ch.getAttribute('data-filter');
                document.querySelectorAll('#training-table tbody tr').forEach(tr => {
                  const st = tr.getAttribute('data-status');
                  tr.style.display = (f==='all' || st===f) ? '' : 'none';
                });
              });

              // Training upload functionality
              let trainingTypes = [];
              // currentUser already has the correct user.id from authentication

              // Load training types for dropdown
              if (siteId) {
                const ttResult = await supabase
                  .from('training_types')
                  .select('id,name,validity_months,is_clinical_required,is_non_clinical_required,active')
                  .eq('site_id', siteId)
                  .eq('active', true)
                  .order('name');
                
                if (!ttResult.error && ttResult.data) {
                  trainingTypes = ttResult.data;
                  const select = document.getElementById('training-type-select');
                  trainingTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.name;
                    select.appendChild(option);
                  });
                }
              }

              // Modal event handlers
              document.getElementById('upload-training-btn').addEventListener('click', () => openTrainingModal());
              document.getElementById('training-modal-close').addEventListener('click', closeTrainingModal);
              document.getElementById('training-cancel-btn').addEventListener('click', closeTrainingModal);
              document.getElementById('training-save-btn').addEventListener('click', saveTrainingRecord);
              document.getElementById('training-certificate').addEventListener('change', handleFileUpload);
              document.getElementById('training-completion-date').addEventListener('change', calculateExpiry);
              document.getElementById('training-expiry-period').addEventListener('change', calculateExpiry);
              document.getElementById('training-type-select').addEventListener('change', updateExpiryBasedOnTrainingType);

              // Make rows clickable
              function attachRowClickHandlers() {
                document.querySelectorAll('#training-table tbody tr').forEach(row => {
                  row.addEventListener('click', function() {
                    const trainingName = this.querySelector('td:first-child').textContent;
                    const trainingType = trainingTypes.find(t => t.name === trainingName);
                    if (trainingType) {
                      openTrainingModal(trainingType);
                    }
                  });
                });
              }

              // Training modal functions
              function openTrainingModal(preselectedType = null) {
                document.getElementById('training-upload-modal').style.display = 'flex';
                // Set completion date to today
                document.getElementById('training-completion-date').value = new Date().toISOString().split('T')[0];
                
                // If we have a preselected type, set it and calculate expiry
                if (preselectedType) {
                  document.getElementById('training-type-select').value = preselectedType.id;
                  // Set default expiry period based on training type validity
                  if (preselectedType.validity_months) {
                    if (preselectedType.validity_months <= 1) {
                      document.getElementById('training-expiry-period').value = '1month';
                    } else if (preselectedType.validity_months <= 3) {
                      document.getElementById('training-expiry-period').value = '3months';
                    } else if (preselectedType.validity_months <= 6) {
                      document.getElementById('training-expiry-period').value = '6months';
                    } else if (preselectedType.validity_months <= 12) {
                      document.getElementById('training-expiry-period').value = '1year';
                    } else if (preselectedType.validity_months <= 24) {
                      document.getElementById('training-expiry-period').value = '2years';
                    } else {
                      document.getElementById('training-expiry-period').value = '3years';
                    }
                  }
                }
                
                // Calculate initial expiry
                calculateExpiry();
              }

              function closeTrainingModal() {
                document.getElementById('training-upload-modal').style.display = 'none';
                document.getElementById('training-upload-form').reset();
                document.getElementById('training-upload-error').style.display = 'none';
                window.uploadedFile = null;
              }

              function handleFileUpload(event) {
                const file = event.target.files[0];
                
                if (!file) return;
                
                if (file.size > 10 * 1024 * 1024) {
                  document.getElementById('training-upload-error').textContent = 'File size must be less than 10MB';
                  document.getElementById('training-upload-error').style.display = 'block';
                  return;
                }
                
                window.uploadedFile = file;
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('training-upload-error').style.display = 'none';
              }

              function calculateExpiry() {
                const completionDate = document.getElementById('training-completion-date').value;
                const expiryPeriod = document.getElementById('training-expiry-period').value;
                
                if (!completionDate || !expiryPeriod || expiryPeriod === 'never') {
                  document.getElementById('calculated-expiry').textContent = 'No expiry';
                  return;
                }
                
                const completion = new Date(completionDate);
                const expiry = new Date(completion);
                
                // Calculate based on selected period
                switch(expiryPeriod) {
                  case '1week':
                    expiry.setDate(expiry.getDate() + 7);
                    break;
                  case '1month':
                    expiry.setMonth(expiry.getMonth() + 1);
                    break;
                  case '3months':
                    expiry.setMonth(expiry.getMonth() + 3);
                    break;
                  case '6months':
                    expiry.setMonth(expiry.getMonth() + 6);
                    break;
                  case '1year':
                    expiry.setFullYear(expiry.getFullYear() + 1);
                    break;
                  case '2years':
                    expiry.setFullYear(expiry.getFullYear() + 2);
                    break;
                  case '3years':
                    expiry.setFullYear(expiry.getFullYear() + 3);
                    break;
                }
                
                // Display calculated expiry
                document.getElementById('calculated-expiry').textContent = expiry.toLocaleDateString();
                
                // Store for saving
                window.calculatedExpiryDate = expiry.toISOString().split('T')[0];
              }

              function updateExpiryBasedOnTrainingType() {
                const selectedTypeId = document.getElementById('training-type-select').value;
                if (!selectedTypeId) return;
                
                // Find the selected training type from our loaded types
                const selectedType = trainingTypes.find(t => t.id == selectedTypeId);
                if (!selectedType) return;
                
                // Set expiry period based on the selected training's validity_months
                if (selectedType.validity_months) {
                  if (selectedType.validity_months <= 1) {
                    document.getElementById('training-expiry-period').value = '1month';
                  } else if (selectedType.validity_months <= 3) {
                    document.getElementById('training-expiry-period').value = '3months';
                  } else if (selectedType.validity_months <= 6) {
                    document.getElementById('training-expiry-period').value = '6months';
                  } else if (selectedType.validity_months <= 12) {
                    document.getElementById('training-expiry-period').value = '1year';
                  } else if (selectedType.validity_months <= 24) {
                    document.getElementById('training-expiry-period').value = '2years';
                  } else {
                    document.getElementById('training-expiry-period').value = '3years';
                  }
                } else {
                  // If no validity_months, set to no expiry
                  document.getElementById('training-expiry-period').value = 'never';
                }
                
                // Recalculate expiry date based on the new expiry period
                calculateExpiry();
              }

              async function saveTrainingRecord(event) {
                if (event) event.preventDefault();
                
                const errorDiv = document.getElementById('training-upload-error');
                errorDiv.style.display = 'none';
                
                try {
                  // Get form values
                  const typeId = document.getElementById('training-type-select').value;
                  const completionDate = document.getElementById('training-completion-date').value;
                  const expiryDate = window.calculatedExpiryDate || null;
                  const notes = document.getElementById('training-notes').value;
                  
                  if (!typeId || !completionDate) {
                    errorDiv.textContent = 'Please fill in all required fields';
                    errorDiv.style.display = 'block';
                    return;
                  }
                  
                  if (!currentUser.id) {
                    errorDiv.textContent = 'User session not found. Please refresh and try again.';
                    errorDiv.style.display = 'block';
                    return;
                  }
                  
                  let certificateUrl = null;
                  
                  // Upload file if provided
                  if (window.uploadedFile) {
                    const file = window.uploadedFile;
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${currentUser.id}_${typeId}_${Date.now()}.${fileExt}`;
                    const filePath = `${currentUser.siteId}/training_certificates/${fileName}`;
                    
                    const { data: uploadData, error: uploadError } = await supabase.storage
                      .from('training_certificates')
                      .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                      });
                    
                    if (uploadError) {
                      console.error('Upload error:', uploadError);
                      errorDiv.textContent = 'Failed to upload certificate: ' + uploadError.message;
                      errorDiv.style.display = 'block';
                      return;
                    }
                    
                    certificateUrl = filePath;
                  }
                  
                  // Prepare record data using user_id (UUID standard)
                  const recordData = {
                    site_id: currentUser.siteId,
                    user_id: currentUser.id,
                    training_type_id: parseInt(typeId),
                    completion_date: completionDate,
                    expiry_date: expiryDate,
                    notes: notes || null,
                    certificate_url: certificateUrl
                  };
                  
                  // Save to database
                  const { data, error } = await supabase
                    .from('training_records')
                    .insert(recordData);
                  
                  if (error) {
                    console.error('Database error:', error);
                    errorDiv.textContent = 'Failed to save training record: ' + error.message;
                    errorDiv.style.display = 'block';
                    return;
                  }
                  
                  // Success - close modal and reload page
                  closeTrainingModal();

                  if (achievementClient) {
                    try {
                      await achievementClient.ensureUnlocked('first_training_upload', {
                        metadata: {
                          training_type_id: parseInt(typeId),
                          completion_date: completionDate,
                          has_certificate: Boolean(certificateUrl)
                        }
                      });
                      await refreshTrainingAchievements({
                        training_type_id: parseInt(typeId),
                        completion_date: completionDate,
                        has_certificate: Boolean(certificateUrl)
                      });
                    } catch (achievementError) {
                      console.warn('Failed to unlock training achievements:', achievementError);
                    }
                  }

                  // Show success message
                  const successDiv = document.createElement('div');
                  successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 0.75rem 1.25rem; border-radius: var(--radius); box-shadow: var(--shadow-lg); z-index: 10000; font-weight: 600;';
                  successDiv.textContent = 'Training record saved successfully!';
                  document.body.appendChild(successDiv);
                  
                  setTimeout(() => {
                    successDiv.remove();
                    // Refresh training data instead of reloading page to prevent debugger interference
                    if (typeof loadTrainingData === 'function') {
                      loadTrainingData();
                    } else if (typeof refreshTraining === 'function') {
                      refreshTraining();
                    } else if (typeof initializeTraining === 'function') {
                      initializeTraining();
                    }
                  }, 2000);
                  
                } catch (error) {
                  console.error('Save error:', error);
                  errorDiv.textContent = 'Failed to save training record. Please try again.';
                  errorDiv.style.display = 'block';
                }
              }

              } catch(e){
                console.error('Upload error:', e);
              }

              // Progress bar functions
              function updateProgressBar(requiredTypes, myRecords) {
                const now = new Date();
                let valid = 0, dueSoon = 0, overdue = 0, total = requiredTypes.length;
                let nextExpiringDate = null;
                let nextExpiringName = '';
                let recentActivity = [];

                requiredTypes.forEach(type => {
                  const records = myRecords.filter(r => r.training_type_id === type.id);
                  const latest = records.sort((a,b)=> new Date(b.expiry_date||b.completion_date||0) - new Date(a.expiry_date||a.completion_date||0))[0];
                  
                  if (!latest) {
                    overdue++;
                    return;
                  }

                  const expiry = latest.expiry_date ? new Date(latest.expiry_date) : 
                    (type.validity_months ? new Date(new Date(latest.completion_date).setMonth(new Date(latest.completion_date).getMonth() + Number(type.validity_months))) : null);
                  
                  if (!expiry) {
                    valid++;
                    return;
                  }

                  const days = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
                  
                  if (days < 0) {
                    overdue++;
                  } else if (days <= 30) {
                    dueSoon++;
                    
                    // Track next expiring
                    if (!nextExpiringDate || expiry < nextExpiringDate) {
                      nextExpiringDate = expiry;
                      nextExpiringName = type.name;
                    }
                  } else {
                    valid++;
                  }

                  // Track recent activity (completed in last 30 days)
                  if (latest.completion_date) {
                    const completionDate = new Date(latest.completion_date);
                    const daysSinceCompletion = Math.ceil((now - completionDate) / (1000 * 60 * 60 * 24));
                    if (daysSinceCompletion <= 30) {
                      recentActivity.push({
                        name: type.name,
                        date: completionDate,
                        days: daysSinceCompletion
                      });
                    }
                  }
                });

                const percentage = total > 0 ? Math.round((valid / total) * 100) : 0;

                // Update progress ring
                const circumference = 283; // 2 * Ï€ * 45
                const offset = circumference - (percentage / 100) * circumference;
                document.getElementById('training-progress-ring').style.strokeDashoffset = offset;

                // Update numbers with animation
                animateNumber(document.getElementById('training-percentage'), percentage, '%', 1000);
                animateNumber(document.getElementById('valid-count'), valid, '', 600);
                animateNumber(document.getElementById('due-soon-count'), dueSoon, '', 800);
                animateNumber(document.getElementById('overdue-count'), overdue, '', 1000);

                // Update next expiring
                const nextExpiringEl = document.getElementById('next-expiring');
                if (nextExpiringDate && nextExpiringName) {
                  const days = Math.ceil((nextExpiringDate - now) / (1000 * 60 * 60 * 24));
                  nextExpiringEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                      <div style="font-weight: 600; color: var(--gray-900); font-size: 0.875rem;">${nextExpiringName}</div>
                      <div style="color: ${days <= 7 ? 'var(--danger)' : days <= 14 ? 'var(--warning)' : 'var(--gray-500)'}; font-size: 0.75rem;">
                        ${days > 0 ? `Expires in ${days} day${days !== 1 ? 's' : ''}` : 'Expired'}
                      </div>
                    </div>
                  `;
                } else {
                  nextExpiringEl.innerHTML = '<div style="color: var(--gray-500);">All training up to date! ðŸŽ‰</div>';
                }

                // Update recent activity
                const recentEl = document.getElementById('recent-training');
                if (recentActivity.length > 0) {
                  const latest = recentActivity.sort((a,b) => b.date - a.date)[0];
                  recentEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                      <div style="font-weight: 600; color: var(--gray-900); font-size: 0.875rem;">${latest.name}</div>
                      <div style="color: var(--success); font-size: 0.75rem;">
                        Completed ${latest.days} day${latest.days !== 1 ? 's' : ''} ago
                      </div>
                    </div>
                  `;
                } else {
                  recentEl.innerHTML = '<div style="color: var(--gray-500);">No recent activity</div>';
                }
              }

              // Function to update the training progress bar
              function updateTrainingProgressBar(requiredTypes, userRecords) {
                const now = new Date();
                let validCount = 0;
                const totalCount = requiredTypes.length;

                // Calculate valid training items
                requiredTypes.forEach(type => {
                  const records = userRecords.filter(r => r.training_type_id === type.id);
                  const latest = records.sort((a,b)=> new Date(b.expiry_date||b.completion_date||0) - new Date(a.expiry_date||a.completion_date||0))[0];
                  
                  if (latest) {
                    const expiry = latest.expiry_date ? new Date(latest.expiry_date) : (type.validity_months ? new Date(new Date(latest.completion_date).setMonth(new Date(latest.completion_date).getMonth()+Number(type.validity_months))) : null);
                    
                    if (!expiry || expiry > now) {
                      validCount++;
                    }
                  }
                });

                // Calculate percentage
                const percentage = totalCount > 0 ? Math.round((validCount / totalCount) * 100) : 0;
                
                // Update progress bar
                const progressBar = document.getElementById('training-progress-bar');
                const progressLabel = document.getElementById('training-progress-label');
                
                if (progressBar) {
                  // Animate the progress bar
                  setTimeout(() => {
                    progressBar.style.width = `${percentage}%`;
                  }, 100);
                }
                
                if (progressLabel) {
                  progressLabel.textContent = `${percentage}% Training Complete (${validCount}/${totalCount})`;
                }

                console.log(`Training progress: ${validCount}/${totalCount} = ${percentage}%`);
              }

              function animateNumber(element, targetValue, suffix = '', duration = 1000) {
                const startValue = 0;
                const startTime = performance.now();
                
                function updateNumber(currentTime) {
                  const elapsed = currentTime - startTime;
                  const progress = Math.min(elapsed / duration, 1);
                  const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                  const currentValue = Math.round(startValue + (targetValue - startValue) * easeOutQuart);
                  
                  element.textContent = currentValue + suffix;
                  
                  if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                  }
                }
                
                requestAnimationFrame(updateNumber);
              }

              // Toggle details functionality
              document.getElementById('training-toggle').addEventListener('click', function() {
                const details = document.getElementById('training-details');
                const icon = this.querySelector('svg');
                const isExpanded = details.style.display !== 'none';
                
                if (isExpanded) {
                  details.style.display = 'none';
                  icon.style.transform = 'rotate(0deg)';
                } else {
                  details.style.display = 'block';
                  icon.style.transform = 'rotate(180deg)';
                }
              });

            } catch(e){
              // requireStaffSession or inner errors
              if (String(e.message).includes('NO_SESSION')) { window.location.replace('home.html'); return; }
              if (String(e.message).includes('NOT_STAFF')) { window.location.replace('home.html'); return; }
              console.error('[staff-training] inner error', e);
              document.getElementById('training-loading').style.display='none';
              document.getElementById('training-empty').style.display='block';
            }
        })();
      </script>
    

    <!-- Main Content Area -->
    <main class="content content-wide">
      <!-- Training Panel -->
      <div class="panel">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;">
          <div class="illus-circle"><img src="https://api.iconify.design/fluent-emoji-flat:books.svg" alt="Training"></div>
          <h2 style="margin:0;font-size:1.5rem;font-weight:700;color:var(--gray-900);font-family:var(--font-display);">My Training</h2>
          <div style="flex:1"></div>
          <button class="btn btn-primary" id="upload-training-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17,8 12,3 7,8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            Upload Training
          </button>
        </div>

        <!-- Training Progress Bar -->
        <div class="progress-wrap">
          <div class="progress">
            <div id="training-progress-bar" class="bar" style="width:0%;"></div>
          </div>
          <div id="training-progress-label" class="meta-note">0% Training Complete</div>
        </div>

        <!-- Filter Chips -->
        <div class="filters">
          <div class="chip active" data-filter="all">All</div>
          <div class="chip" data-filter="ok">Valid</div>
          <div class="chip" data-filter="warn">Due soon</div>
          <div class="chip" data-filter="danger">Expired</div>
        </div>

        <!-- Loading and Empty States -->
        <div id="training-loading" style="padding:2rem;text-align:center;color:var(--gray-500);">Loading...</div>
        <div id="training-empty" style="display:none;padding:2rem;text-align:center;color:var(--gray-500);">No training items found.</div>

        <!-- Training Table -->
        <div id="training-wrap" style="display:none;">
          <table id="training-table" class="table">
            <thead><tr><th>Training</th><th>Status</th><th class="right">Expiry Countdown</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <div class="footer">Â© CheckLoop â€¢ Staff Portal</div>
  </div>

  <!-- Training Upload Modal -->
  <div id="training-upload-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Add Training Record</h3>
        <button class="close-btn" id="training-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="training-upload-form">
          <div class="form-group">
            <label for="training-type-select">Training Type *</label>
            <select id="training-type-select" required>
              <option value="">Select training type...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="training-completion-date">Completion Date *</label>
            <input type="date" id="training-completion-date" required>
          </div>
          
          <div class="form-group">
            <label for="training-expiry-period">Expiry Period *</label>
            <select id="training-expiry-period" required>
              <option value="1week">1 Week</option>
              <option value="1month">1 Month</option>
              <option value="3months">3 Months</option>
              <option value="6months">6 Months</option>
              <option value="1year" selected>1 Year</option>
              <option value="2years">2 Years</option>
              <option value="3years">3 Years</option>
              <option value="never">No Expiry</option>
            </select>
            <small>Calculated expiry: <span id="calculated-expiry">-</span></small>
          </div>
          
          <div class="form-group">
            <label>Certificate File (Optional)</label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="file" id="training-certificate" accept=".pdf,.jpg,.jpeg,.png" style="flex: 1;">
              <span id="file-name" style="color: var(--gray-500); font-size: 0.875rem;"></span>
            </div>
            <small>PDF, JPG, PNG (max 10MB)</small>
          </div>
          
          <div class="form-group">
            <label for="training-notes">Notes</label>
            <textarea id="training-notes" rows="3" placeholder="Additional notes (optional)"></textarea>
          </div>
        </form>
        
        <div id="training-upload-error" style="color: var(--danger); margin-top: 1rem; display: none; padding: 0.75rem; background: var(--danger-light); border: 1px solid var(--danger); border-radius: var(--radius);"></div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="training-cancel-btn">Cancel</button>
        <button type="submit" class="btn btn-primary" id="training-save-btn">Save Training Record</button>
      </div>
    </div>
  </div>


    <!-- Debug Console - Persistent across all pages -->
    <script src="debug-console.js"></script>
    <script src="supabase-debug.js"></script>
</body>
</html>

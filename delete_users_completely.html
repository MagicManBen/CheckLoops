<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delete Users Completely - CheckLoop</title>
  <script src="config.js"></script>
  <style>
    body {
      font-family: Inter, system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    h1 {
      color: #dc2626;
      margin-bottom: 8px;
    }
    .warning {
      background: #fef2f2;
      border: 2px solid #fca5a5;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      color: #991b1b;
    }
    .warning strong {
      color: #dc2626;
    }
    .section {
      margin-bottom: 24px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .section h3 {
      margin-top: 0;
      color: #1f2937;
    }
    .user-list {
      background: white;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      margin: 12px 0;
    }
    .user-item {
      padding: 8px;
      margin: 4px 0;
      background: #fef2f2;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-email {
      font-weight: 600;
      color: #dc2626;
    }
    button {
      background: #dc2626;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 12px;
      margin-bottom: 12px;
    }
    button:hover {
      background: #b91c1c;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-safe {
      background: #3b82f6;
    }
    .btn-safe:hover {
      background: #2563eb;
    }
    .log {
      background: #1a202c;
      color: #68d391;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 16px;
      white-space: pre-wrap;
    }
    .log .error {
      color: #fc8181;
    }
    .log .warning {
      color: #f6e05e;
    }
    .log .success {
      color: #68d391;
    }
    .log .info {
      color: #90cdf4;
    }
    .sql-section {
      background: #f3f4f6;
      padding: 16px;
      border-radius: 8px;
      margin-top: 24px;
    }
    .sql-code {
      background: #1f2937;
      color: #f9fafb;
      padding: 16px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      margin: 12px 0;
    }
    .copy-btn {
      background: #6b7280;
      padding: 8px 16px;
      font-size: 14px;
    }
    .copy-btn:hover {
      background: #4b5563;
    }
    .checkbox-group {
      margin: 16px 0;
    }
    .checkbox-group label {
      display: block;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ö†Ô∏è Delete Users Completely</h1>

    <div class="warning">
      <strong>WARNING:</strong> This tool will permanently delete users from ALL tables including auth.users. This action cannot be undone!
    </div>

    <div class="section">
      <h3>Users to Delete</h3>
      <div class="user-list">
        <div class="user-item">
          <span class="user-email">ben.howard@stoke.nhs.uk</span>
          <span id="status-ben" class="status">Ready</span>
        </div>
        <div class="user-item">
          <span class="user-email">benhowardmagic@hotmail.com</span>
          <span id="status-benmagic" class="status">Ready</span>
        </div>
        <div class="user-item">
          <span class="user-email">tom.donlan@stoke.nhs.uk</span>
          <span id="status-tom" class="status">Ready</span>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Deletion Steps</h3>
      <div class="checkbox-group">
        <label><input type="checkbox" id="step1" disabled> Step 1: Find user IDs from auth.users</label>
        <label><input type="checkbox" id="step2" disabled> Step 2: Delete from profiles table</label>
        <label><input type="checkbox" id="step3" disabled> Step 3: Delete from site_invites table</label>
        <label><input type="checkbox" id="step4" disabled> Step 4: Delete from staff_app_welcome table</label>
        <label><input type="checkbox" id="step5" disabled> Step 5: Delete from quiz_submissions table</label>
        <label><input type="checkbox" id="step6" disabled> Step 6: Delete from training_submissions table</label>
        <label><input type="checkbox" id="step7" disabled> Step 7: Delete from auth.users (requires SQL)</label>
      </div>
    </div>

    <div class="section">
      <h3>Actions</h3>
      <button onclick="deleteFromTables()" class="btn-safe">Step 1: Delete from Database Tables</button>
      <button onclick="generateAuthDeleteSQL()">Step 2: Generate Auth Delete SQL</button>
      <button onclick="verifyDeletion()" class="btn-safe">Step 3: Verify Deletion</button>
    </div>

    <div class="log" id="log">Ready to delete users...</div>

    <div class="sql-section" id="sql-section" style="display:none;">
      <h3>SQL Commands for auth.users Deletion</h3>
      <p>Run these commands in Supabase SQL Editor with service role permissions:</p>
      <div class="sql-code" id="sql-code"></div>
      <button onclick="copySQL()" class="copy-btn">üìã Copy SQL</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    let supabase;
    const log = document.getElementById('log');
    const usersToDelete = [
      'ben.howard@stoke.nhs.uk',
      'benhowardmagic@hotmail.com',
      'tom.donlan@stoke.nhs.uk'
    ];
    let userIds = {};

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info';
      log.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      log.scrollTop = log.scrollHeight;
    }

    function checkStep(stepId) {
      document.getElementById(stepId).checked = true;
    }

    async function init() {
      supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        addLog('Not authenticated. Please log in first.', 'error');
        return false;
      }

      // Check if user has admin access
      const { data: profile } = await supabase
        .from('profiles')
        .select('account_role')
        .eq('user_id', session.user.id)
        .single();

      const accountRole = profile?.account_role;
      if (!['admin', 'owner'].includes(accountRole?.toLowerCase())) {
        addLog('Admin access required for this operation', 'error');
        return false;
      }

      addLog('Authenticated as admin/owner', 'success');
      return true;
    }

    window.deleteFromTables = async function() {
      const isAuthed = await init();
      if (!isAuthed) return;

      addLog('Starting deletion from database tables...', 'info');

      // Step 1: Find user IDs
      addLog('Finding user IDs...', 'info');
      for (const email of usersToDelete) {
        try {
          // Check profiles table
          const { data: profiles } = await supabase
            .from('profiles')
            .select('user_id')
            .or(`full_name.eq.${email},full_name.ilike.%${email.split('@')[0]}%`);

          if (profiles && profiles.length > 0) {
            userIds[email] = profiles.map(p => p.user_id);
            addLog(`Found ${profiles.length} user ID(s) for ${email}`, 'success');
          }

          // Also check site_invites for additional info
          const { data: invites } = await supabase
            .from('site_invites')
            .select('id')
            .eq('email', email);

          if (invites && invites.length > 0) {
            addLog(`Found ${invites.length} invite(s) for ${email}`, 'info');
          }
        } catch (error) {
          addLog(`Error finding ${email}: ${error.message}`, 'error');
        }
      }
      checkStep('step1');

      // Step 2: Delete from profiles
      addLog('\nDeleting from profiles table...', 'info');
      for (const [email, ids] of Object.entries(userIds)) {
        if (ids && ids.length > 0) {
          for (const id of ids) {
            try {
              const { error } = await supabase
                .from('profiles')
                .delete()
                .eq('user_id', id);

              if (error) {
                addLog(`Error deleting profile for ${email}: ${error.message}`, 'error');
              } else {
                addLog(`Deleted profile for ${email} (${id})`, 'success');
              }
            } catch (error) {
              addLog(`Error: ${error.message}`, 'error');
            }
          }
        }
      }
      checkStep('step2');

      // Step 3: Delete from site_invites
      addLog('\nDeleting from site_invites table...', 'info');
      for (const email of usersToDelete) {
        try {
          const { error } = await supabase
            .from('site_invites')
            .delete()
            .eq('email', email);

          if (error) {
            addLog(`Error deleting invites for ${email}: ${error.message}`, 'error');
          } else {
            addLog(`Deleted invites for ${email}`, 'success');
          }
        } catch (error) {
          addLog(`Error: ${error.message}`, 'error');
        }
      }
      checkStep('step3');

      // Step 4: Delete from staff_app_welcome
      addLog('\nDeleting from staff_app_welcome table...', 'info');
      for (const [email, ids] of Object.entries(userIds)) {
        if (ids && ids.length > 0) {
          for (const id of ids) {
            try {
              const { error } = await supabase
                .from('staff_app_welcome')
                .delete()
                .eq('user_id', id);

              if (!error) {
                addLog(`Deleted staff_app_welcome for ${email}`, 'success');
              }
            } catch (error) {
              // Table might not have records, that's ok
            }
          }
        }
      }
      checkStep('step4');

      // Step 5: Delete from quiz_submissions
      addLog('\nDeleting from quiz_submissions table...', 'info');
      for (const [email, ids] of Object.entries(userIds)) {
        if (ids && ids.length > 0) {
          for (const id of ids) {
            try {
              const { error } = await supabase
                .from('quiz_submissions')
                .delete()
                .eq('user_id', id);

              if (!error) {
                addLog(`Deleted quiz submissions for ${email}`, 'success');
              }
            } catch (error) {
              // Table might not have records, that's ok
            }
          }
        }
      }
      checkStep('step5');

      // Step 6: Delete from training_submissions
      addLog('\nDeleting from training_submissions table...', 'info');
      for (const [email, ids] of Object.entries(userIds)) {
        if (ids && ids.length > 0) {
          for (const id of ids) {
            try {
              const { error } = await supabase
                .from('training_submissions')
                .delete()
                .eq('user_id', id);

              if (!error) {
                addLog(`Deleted training submissions for ${email}`, 'success');
              }
            } catch (error) {
              // Table might not have records, that's ok
            }
          }
        }
      }
      checkStep('step6');

      addLog('\n‚úÖ Deletion from database tables complete!', 'success');
      addLog('Now generate and run the Auth Delete SQL to remove from auth.users', 'warning');
    };

    window.generateAuthDeleteSQL = function() {
      const sqlSection = document.getElementById('sql-section');
      const sqlCode = document.getElementById('sql-code');

      const sql = `-- =====================================================
-- DELETE USERS FROM AUTH.USERS TABLE
-- Run this in Supabase SQL Editor
-- =====================================================

-- First, check which users exist
SELECT id, email, created_at
FROM auth.users
WHERE email IN (
  'ben.howard@stoke.nhs.uk',
  'benhowardmagic@hotmail.com',
  'tom.donlan@stoke.nhs.uk'
);

-- Delete the users (uncomment and run after checking)
DELETE FROM auth.users
WHERE email IN (
  'ben.howard@stoke.nhs.uk',
  'benhowardmagic@hotmail.com',
  'tom.donlan@stoke.nhs.uk'
);

-- Verify deletion
SELECT COUNT(*) as remaining_users
FROM auth.users
WHERE email IN (
  'ben.howard@stoke.nhs.uk',
  'benhowardmagic@hotmail.com',
  'tom.donlan@stoke.nhs.uk'
);
-- Should return 0`;

      sqlCode.textContent = sql;
      sqlSection.style.display = 'block';

      checkStep('step7');
      addLog('SQL commands generated. Copy and run in Supabase SQL Editor.', 'warning');
    };

    window.copySQL = function() {
      const sqlCode = document.getElementById('sql-code').textContent;
      navigator.clipboard.writeText(sqlCode).then(() => {
        addLog('SQL copied to clipboard!', 'success');
      }).catch(() => {
        addLog('Failed to copy SQL. Please select and copy manually.', 'error');
      });
    };

    window.verifyDeletion = async function() {
      const isAuthed = await init();
      if (!isAuthed) return;

      addLog('\n========== VERIFICATION ==========', 'info');

      for (const email of usersToDelete) {
        addLog(`\nChecking ${email}...`, 'info');

        // Check profiles
        const { data: profiles } = await supabase
          .from('profiles')
          .select('user_id')
          .or(`full_name.eq.${email},full_name.ilike.%${email.split('@')[0]}%`);

        if (profiles && profiles.length > 0) {
          addLog(`‚ùå Still found in profiles table`, 'error');
        } else {
          addLog(`‚úÖ Not found in profiles table`, 'success');
        }

        // Check site_invites
        const { data: invites } = await supabase
          .from('site_invites')
          .select('id')
          .eq('email', email);

        if (invites && invites.length > 0) {
          addLog(`‚ùå Still found in site_invites table`, 'error');
        } else {
          addLog(`‚úÖ Not found in site_invites table`, 'success');
        }

        // Update status
        const statusId = email.includes('benhowardmagic') ? 'status-benmagic' :
                        email.includes('ben.howard') ? 'status-ben' : 'status-tom';
        const statusEl = document.getElementById(statusId);
        if (statusEl) {
          if (profiles?.length === 0 && invites?.length === 0) {
            statusEl.textContent = '‚úÖ Deleted';
            statusEl.style.color = '#10b981';
          } else {
            statusEl.textContent = '‚ö†Ô∏è Partial';
            statusEl.style.color = '#f59e0b';
          }
        }
      }

      addLog('\n========== VERIFICATION COMPLETE ==========', 'info');
      addLog('If users still exist, run the SQL commands to delete from auth.users', 'warning');
    };

    // Initialize on load
    init();
  </script>
</body>
</html>

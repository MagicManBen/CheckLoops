<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Invitation System Setup & Investigation</title>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    h1 {
      margin: 0 0 30px 0;
      font-size: 28px;
      text-align: center;
    }
    .section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section h2 {
      margin-top: 0;
      font-size: 20px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 10px;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status.success {
      background: #10b981;
      color: white;
    }
    .status.error {
      background: #ef4444;
      color: white;
    }
    .status.warning {
      background: #f59e0b;
      color: white;
    }
    .status.info {
      background: #3b82f6;
      color: white;
    }
    pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.5;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .result-item {
      padding: 10px;
      margin: 5px 0;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      border-left: 4px solid #3b82f6;
    }
    .error-item {
      border-left-color: #ef4444;
    }
    .success-item {
      border-left-color: #10b981;
    }
    .warning-item {
      border-left-color: #f59e0b;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
    }
    input[type="text"]::placeholder, textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }
    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .tab.active {
      color: white;
      border-bottom: 3px solid white;
      margin-bottom: -2px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Supabase Invitation System Setup & Investigation</h1>

    <div class="section">
      <h2>Configuration</h2>
      <div class="grid">
        <div>
          <label>Supabase URL:</label>
          <input type="text" id="supabaseUrl" value="https://unveoqnlqnobufhublyw.supabase.co" readonly>
        </div>
        <div>
          <label>Service Role Key:</label>
          <input type="text" id="serviceKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTAxNzI3NiwiZXhwIjoyMDcwNTkzMjc2fQ.CJxV14F0T2TWkAjeR4bpYiBIOwLwyfzF9WzAWwS99Xc" readonly>
        </div>
      </div>
      <div style="margin-top: 15px;">
        <label>Production Domain:</label>
        <input type="text" id="productionDomain" value="https://checkloops.co.uk" readonly>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('investigate')">üîç Investigate</button>
      <button class="tab" onclick="showTab('setup')">‚öôÔ∏è Setup</button>
      <button class="tab" onclick="showTab('test')">üß™ Test</button>
      <button class="tab" onclick="showTab('templates')">üìß Email Templates</button>
    </div>

    <!-- Investigation Tab -->
    <div id="investigate" class="tab-content active">
      <div class="section">
        <h2>System Investigation</h2>
        <button onclick="investigateAll()">üîç Run Complete Investigation</button>
        <div id="investigationResults" style="margin-top: 20px;"></div>
      </div>
    </div>

    <!-- Setup Tab -->
    <div id="setup" class="tab-content">
      <div class="section">
        <h2>Automatic Setup</h2>
        <button onclick="runSetup()">üöÄ Configure Invitation System</button>
        <div id="setupResults" style="margin-top: 20px;"></div>
      </div>
    </div>

    <!-- Test Tab -->
    <div id="test" class="tab-content">
      <div class="section">
        <h2>Test Invitation Flow</h2>
        <div class="grid">
          <input type="text" id="testEmail" placeholder="test@example.com">
          <button onclick="testInvitation()">üìß Send Test Invitation</button>
        </div>
        <div id="testResults" style="margin-top: 20px;"></div>
      </div>
    </div>

    <!-- Email Templates Tab -->
    <div id="templates" class="tab-content">
      <div class="section">
        <h2>Email Template Configuration</h2>
        <button onclick="updateEmailTemplates()">üìù Update Email Templates</button>
        <div id="templateResults" style="margin-top: 20px;"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = document.getElementById('supabaseUrl').value;
    const SERVICE_KEY = document.getElementById('serviceKey').value;
    const PRODUCTION_DOMAIN = document.getElementById('productionDomain').value;

    // Create Supabase client with service role key
    const supabase = createClient(SUPABASE_URL, SERVICE_KEY, {
      auth: {
        autoRefreshToken: false,
        persistSession: false
      }
    });

    // Tab switching
    window.showTab = function(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
    };

    // Investigation Functions
    window.investigateAll = async function() {
      const resultsDiv = document.getElementById('investigationResults');
      resultsDiv.innerHTML = '<div class="result-item">üîÑ Starting investigation...</div>';

      const results = [];

      try {
        // 1. Check Tables
        results.push('<h3>üìä Database Tables</h3>');
        const requiredTables = ['site_invites', 'master_users', 'teams'];

        for (const table of requiredTables) {
          try {
            const { data, error } = await supabase
              .from(table)
              .select('*')
              .limit(1);

            if (error) {
              results.push(`<div class="result-item error-item">‚ùå Table '${table}': ${error.message}</div>`);
            } else {
              results.push(`<div class="result-item success-item">‚úÖ Table '${table}' exists and is accessible</div>`);
            }
          } catch (e) {
            results.push(`<div class="result-item error-item">‚ùå Table '${table}': ${e.message}</div>`);
          }
        }

        // 2. Check site_invites table structure
        results.push('<h3>üîß Checking site_invites Table Structure</h3>');
        const { data: inviteColumns } = await supabase.rpc('get_table_columns', { table_name: 'site_invites' }).catch(() => ({ data: null }));

        if (inviteColumns) {
          results.push(`<div class="result-item success-item">‚úÖ site_invites has ${inviteColumns.length} columns</div>`);
        } else {
          // Try direct query
          const { data: sampleInvite } = await supabase
            .from('site_invites')
            .select('*')
            .limit(1);

          if (sampleInvite) {
            const columns = sampleInvite.length > 0 ? Object.keys(sampleInvite[0]) : [];
            const requiredColumns = ['id', 'email', 'full_name', 'site_id', 'status', 'role', 'role_detail'];

            for (const col of requiredColumns) {
              if (columns.includes(col)) {
                results.push(`<div class="result-item success-item">‚úÖ Column '${col}' exists</div>`);
              } else {
                results.push(`<div class="result-item warning-item">‚ö†Ô∏è Column '${col}' might be missing</div>`);
              }
            }
          }
        }

        // 3. Check Auth Settings
        results.push('<h3>üîê Authentication Settings</h3>');

        // Check if we can query auth.users (requires service role)
        try {
          const { data: { users }, error } = await supabase.auth.admin.listUsers({ perPage: 1 });
          if (error) {
            results.push(`<div class="result-item error-item">‚ùå Cannot access auth.users: ${error.message}</div>`);
          } else {
            results.push(`<div class="result-item success-item">‚úÖ Auth admin access working (Service role key valid)</div>`);
          }
        } catch (e) {
          results.push(`<div class="result-item error-item">‚ùå Auth admin access failed: ${e.message}</div>`);
        }

        // 4. Check Email Configuration
        results.push('<h3>üìß Email Configuration</h3>');
        results.push(`<div class="result-item info">‚ÑπÔ∏è Emails should be sent from: ${PRODUCTION_DOMAIN}</div>`);
        results.push(`<div class="result-item info">‚ÑπÔ∏è Magic link redirect: ${PRODUCTION_DOMAIN}/simple-set-password.html</div>`);

        // 5. Check Pending Invitations
        results.push('<h3>üì¨ Pending Invitations</h3>');
        const { data: pendingInvites, error: pendingError } = await supabase
          .from('site_invites')
          .select('email, full_name, created_at, status')
          .eq('status', 'pending')
          .limit(5);

        if (pendingError) {
          results.push(`<div class="result-item error-item">‚ùå Cannot query invitations: ${pendingError.message}</div>`);
        } else if (pendingInvites && pendingInvites.length > 0) {
          results.push(`<div class="result-item info">üìä Found ${pendingInvites.length} pending invitation(s):</div>`);
          pendingInvites.forEach(invite => {
            results.push(`<div class="result-item">‚Ä¢ ${invite.email} (${invite.full_name}) - ${invite.status}</div>`);
          });
        } else {
          results.push(`<div class="result-item info">üì≠ No pending invitations found</div>`);
        }

        // 6. Check RLS Policies
        results.push('<h3>üõ°Ô∏è Row Level Security (RLS)</h3>');
        results.push(`<div class="result-item warning-item">‚ö†Ô∏è Make sure RLS is properly configured for site_invites table</div>`);
        results.push(`<div class="result-item info">‚ÑπÔ∏è Admins should be able to CREATE, READ, UPDATE invitations</div>`);

      } catch (error) {
        results.push(`<div class="result-item error-item">‚ùå Investigation failed: ${error.message}</div>`);
      }

      resultsDiv.innerHTML = results.join('');
    };

    // Setup Functions
    window.runSetup = async function() {
      const resultsDiv = document.getElementById('setupResults');
      resultsDiv.innerHTML = '<div class="result-item">üîÑ Starting setup...</div>';

      const results = [];

      try {
        results.push('<h3>‚öôÔ∏è Configuring Invitation System</h3>');

        // 1. Create/Update site_invites table if needed
        results.push(`<div class="result-item info">‚ÑπÔ∏è Checking site_invites table...</div>`);

        // This would normally be done via migrations, but we'll check if table exists
        const { error: tableCheckError } = await supabase
          .from('site_invites')
          .select('id')
          .limit(1);

        if (tableCheckError && tableCheckError.message.includes('does not exist')) {
          results.push(`<div class="result-item error-item">‚ùå Table site_invites does not exist. Please create it via Supabase dashboard:</div>`);
          results.push(`<pre>
CREATE TABLE site_invites (
  id SERIAL PRIMARY KEY,
  site_id INTEGER NOT NULL,
  email TEXT NOT NULL,
  full_name TEXT,
  role TEXT DEFAULT 'staff',
  role_detail TEXT,
  reports_to_id INTEGER,
  status TEXT DEFAULT 'pending',
  invite_data JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create index for faster lookups
CREATE INDEX idx_site_invites_email ON site_invites(email);
CREATE INDEX idx_site_invites_site_id ON site_invites(site_id);
CREATE INDEX idx_site_invites_status ON site_invites(status);
</pre>`);
        } else {
          results.push(`<div class="result-item success-item">‚úÖ site_invites table exists</div>`);
        }

        // 2. Set up Auth Configuration
        results.push('<h3>üîê Authentication Configuration</h3>');
        results.push(`<div class="result-item info">‚ÑπÔ∏è Please configure the following in Supabase Dashboard:</div>`);
        results.push(`<div class="result-item">
          <strong>Auth > URL Configuration:</strong><br>
          ‚Ä¢ Site URL: ${PRODUCTION_DOMAIN}<br>
          ‚Ä¢ Redirect URLs: ${PRODUCTION_DOMAIN}/simple-set-password.html<br>
          ‚Ä¢ Add to allowed redirect URLs: ${PRODUCTION_DOMAIN}/*
        </div>`);

        // 3. Email Template Configuration
        results.push('<h3>üìß Email Templates</h3>');
        results.push(`<div class="result-item info">‚ÑπÔ∏è Configure in Supabase Dashboard > Authentication > Email Templates</div>`);

        // Provide templates
        results.push(`<div class="result-item">
          <strong>Magic Link Template:</strong>
          <pre>
Subject: Welcome to CheckLoops - Set Your Password

Hello {{ .Data.full_name | default "there" }},

You've been invited to join CheckLoops! Click the link below to set up your account:

{{ .ConfirmationURL }}

This link will expire in 24 hours. If you didn't request this, please ignore this email.

Best regards,
The CheckLoops Team
${PRODUCTION_DOMAIN}
</pre>
        </div>`);

        results.push(`<div class="result-item">
          <strong>Password Recovery Template:</strong>
          <pre>
Subject: CheckLoops - Password Reset Request

Hello {{ .Data.full_name | default "there" }},

Click the link below to reset your password:

{{ .ConfirmationURL }}

This link will expire in 24 hours. If you didn't request this, please ignore this email.

Best regards,
The CheckLoops Team
${PRODUCTION_DOMAIN}
</pre>
        </div>`);

        // 4. Check and suggest RLS policies
        results.push('<h3>üõ°Ô∏è Row Level Security Policies</h3>');
        results.push(`<div class="result-item info">‚ÑπÔ∏è Suggested RLS policies for site_invites:</div>`);
        results.push(`<pre>
-- Enable RLS
ALTER TABLE site_invites ENABLE ROW LEVEL SECURITY;

-- Policy for admins to manage invites
CREATE POLICY "Admins can manage invites" ON site_invites
  FOR ALL
  USING (
    auth.uid() IN (
      SELECT user_id FROM master_users
      WHERE site_id = site_invites.site_id
      AND role IN ('admin', 'owner')
    )
  );

-- Policy for users to view their own invite
CREATE POLICY "Users can view own invite" ON site_invites
  FOR SELECT
  USING (
    auth.email() = email
  );
</pre>`);

        results.push(`<div class="result-item success-item">‚úÖ Setup recommendations complete!</div>`);

      } catch (error) {
        results.push(`<div class="result-item error-item">‚ùå Setup failed: ${error.message}</div>`);
      }

      resultsDiv.innerHTML = results.join('');
    };

    // Test Invitation
    window.testInvitation = async function() {
      const email = document.getElementById('testEmail').value;
      const resultsDiv = document.getElementById('testResults');

      if (!email) {
        resultsDiv.innerHTML = '<div class="result-item error-item">‚ùå Please enter an email address</div>';
        return;
      }

      resultsDiv.innerHTML = '<div class="result-item">üîÑ Sending test invitation...</div>';

      const results = [];

      try {
        // 1. Create test invite record
        const inviteData = {
          site_id: 1, // Test site ID
          email: email,
          full_name: 'Test User',
          role: 'staff',
          role_detail: 'Test Role',
          status: 'pending',
          invite_data: {
            test: true,
            created_at: new Date().toISOString()
          }
        };

        const { data: invite, error: inviteError } = await supabase
          .from('site_invites')
          .insert(inviteData)
          .select()
          .single();

        if (inviteError) {
          results.push(`<div class="result-item error-item">‚ùå Failed to create invite: ${inviteError.message}</div>`);
        } else {
          results.push(`<div class="result-item success-item">‚úÖ Invite record created (ID: ${invite.id})</div>`);
        }

        // 2. Send magic link
        const redirectUrl = `${PRODUCTION_DOMAIN}/simple-set-password.html?invite_email=${encodeURIComponent(email)}&site_id=1&full_name=Test%20User&role=staff&invite_id=${invite?.id || ''}`;

        const { error: magicError } = await supabase.auth.signInWithOtp({
          email: email,
          options: {
            shouldCreateUser: true,
            emailRedirectTo: redirectUrl,
            data: {
              full_name: 'Test User',
              site_id: 1,
              role: 'staff',
              test_invite: true
            }
          }
        });

        if (magicError) {
          results.push(`<div class="result-item error-item">‚ùå Failed to send magic link: ${magicError.message}</div>`);

          // Try password reset as fallback
          results.push(`<div class="result-item info">‚ÑπÔ∏è Trying password reset email as fallback...</div>`);
          const { error: resetError } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: redirectUrl
          });

          if (resetError) {
            results.push(`<div class="result-item error-item">‚ùå Fallback also failed: ${resetError.message}</div>`);
          } else {
            results.push(`<div class="result-item success-item">‚úÖ Password reset email sent as fallback</div>`);
          }
        } else {
          results.push(`<div class="result-item success-item">‚úÖ Magic link sent to ${email}</div>`);
          results.push(`<div class="result-item info">‚ÑπÔ∏è Check your email and spam folder</div>`);
        }

        // 3. Clean up test invite after 5 seconds
        if (invite?.id) {
          setTimeout(async () => {
            await supabase
              .from('site_invites')
              .delete()
              .eq('id', invite.id);
            console.log('Test invite cleaned up');
          }, 5000);
        }

      } catch (error) {
        results.push(`<div class="result-item error-item">‚ùå Test failed: ${error.message}</div>`);
      }

      resultsDiv.innerHTML = results.join('');
    };

    // Update Email Templates
    window.updateEmailTemplates = async function() {
      const resultsDiv = document.getElementById('templateResults');
      resultsDiv.innerHTML = '<div class="result-item">üìù Preparing email template configuration...</div>';

      const results = [];

      results.push('<h3>üìß Email Template Configuration Guide</h3>');

      results.push(`<div class="result-item info">
        <strong>‚ö†Ô∏è Email templates must be configured in Supabase Dashboard</strong><br>
        Go to: Authentication > Email Templates
      </div>`);

      results.push(`<div class="result-item">
        <strong>1Ô∏è‚É£ Magic Link / OTP Template:</strong>
        <textarea rows="10" style="margin-top: 10px;" readonly>
&lt;h2&gt;Welcome to CheckLoops&lt;/h2&gt;
&lt;p&gt;Hello {{ .Data.full_name | default "there" }},&lt;/p&gt;
&lt;p&gt;You've been invited to join CheckLoops. Click the button below to set up your account:&lt;/p&gt;
&lt;p&gt;&lt;a href="{{ .ConfirmationURL }}" style="background: #4f89ff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;"&gt;Set Up Your Account&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Or copy and paste this link:&lt;br&gt;
{{ .ConfirmationURL }}&lt;/p&gt;
&lt;p&gt;This link will expire in 24 hours.&lt;/p&gt;
&lt;p&gt;Best regards,&lt;br&gt;The CheckLoops Team&lt;br&gt;
&lt;a href="${PRODUCTION_DOMAIN}"&gt;${PRODUCTION_DOMAIN}&lt;/a&gt;&lt;/p&gt;
        </textarea>
      </div>`);

      results.push(`<div class="result-item">
        <strong>2Ô∏è‚É£ Password Recovery Template:</strong>
        <textarea rows="10" style="margin-top: 10px;" readonly>
&lt;h2&gt;Reset Your CheckLoops Password&lt;/h2&gt;
&lt;p&gt;Hello {{ .Data.full_name | default "there" }},&lt;/p&gt;
&lt;p&gt;We received a request to reset your password. Click the button below to create a new password:&lt;/p&gt;
&lt;p&gt;&lt;a href="{{ .ConfirmationURL }}" style="background: #4f89ff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;"&gt;Reset Password&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Or copy and paste this link:&lt;br&gt;
{{ .ConfirmationURL }}&lt;/p&gt;
&lt;p&gt;This link will expire in 24 hours. If you didn't request this, you can safely ignore this email.&lt;/p&gt;
&lt;p&gt;Best regards,&lt;br&gt;The CheckLoops Team&lt;br&gt;
&lt;a href="${PRODUCTION_DOMAIN}"&gt;${PRODUCTION_DOMAIN}&lt;/a&gt;&lt;/p&gt;
        </textarea>
      </div>`);

      results.push(`<div class="result-item">
        <strong>3Ô∏è‚É£ Confirmation Template (if using email confirmation):</strong>
        <textarea rows="10" style="margin-top: 10px;" readonly>
&lt;h2&gt;Confirm Your CheckLoops Email&lt;/h2&gt;
&lt;p&gt;Hello {{ .Data.full_name | default "there" }},&lt;/p&gt;
&lt;p&gt;Please confirm your email address by clicking the button below:&lt;/p&gt;
&lt;p&gt;&lt;a href="{{ .ConfirmationURL }}" style="background: #10b981; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;"&gt;Confirm Email&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Or copy and paste this link:&lt;br&gt;
{{ .ConfirmationURL }}&lt;/p&gt;
&lt;p&gt;Best regards,&lt;br&gt;The CheckLoops Team&lt;br&gt;
&lt;a href="${PRODUCTION_DOMAIN}"&gt;${PRODUCTION_DOMAIN}&lt;/a&gt;&lt;/p&gt;
        </textarea>
      </div>`);

      results.push('<h3>‚öôÔ∏è SMTP Configuration</h3>');
      results.push(`<div class="result-item info">
        <strong>For production emails from ${PRODUCTION_DOMAIN}:</strong><br>
        1. Go to Supabase Dashboard > Settings > Auth<br>
        2. Configure custom SMTP settings<br>
        3. Use your domain's SMTP server (e.g., SendGrid, Mailgun, AWS SES)<br>
        4. Set "From" email to: noreply@checkloops.co.uk<br>
        5. Set "From" name to: CheckLoops
      </div>`);

      results.push(`<div class="result-item success-item">‚úÖ Email template guide ready! Copy these templates to your Supabase Dashboard.</div>`);

      resultsDiv.innerHTML = results.join('');
    };

    // Auto-run investigation on load
    window.addEventListener('load', () => {
      console.log('Supabase Invitation Setup Tool Loaded');
      console.log('URL:', SUPABASE_URL);
      console.log('Domain:', PRODUCTION_DOMAIN);
    });
  </script>
</body>
</html>
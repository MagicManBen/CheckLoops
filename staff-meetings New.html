<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckLoop ‚Äî Meetings</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <script src="config.js"></script>
  <script defer src="staff-common.js" type="module"></script>

  <style>
    :root{
      --bg: #0a2359;
      --surface-1: rgba(255,255,255,.14);
      --surface-2: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.16);
      --ink: #f8fafc;
      --muted: #dbeafe;
      --ink-dim: #c7d2fe;
      --accent: #7c9cff;
      --accent-2: #8b5cf6;
      --ok: #16a34a;  
      --warn:#f59e0b; 
      --danger:#ef4444;
      --ring: rgba(124,156,255,.35);
      --shadow: 0 14px 44px rgba(2,6,23,.34);
      --r: 18px;
    }

    html,body{ height:100%; }
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink);
      background:
        radial-gradient(1200px 700px at 20% -10%, #254c9b 0%, transparent 60%),
        radial-gradient(1200px 700px at 80% 110%, #1a407e 0%, transparent 60%),
        linear-gradient(180deg, #0d2e70 0%, var(--bg) 100%);
      min-height:100dvh;
    }

    .wrap{ max-width:1200px; margin:24px auto 64px; padding:0 20px; }

    /* Topbar */
    .topbar{ display:flex; align-items:center; gap:12px; padding:14px 16px; border-radius:22px;
             background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
             border:1px solid var(--border); box-shadow: var(--shadow); }
    .seg-nav{ display:flex; gap:8px; }
    .seg-nav .tab{ padding:10px 14px; border-radius:999px; background:rgba(255,255,255,.10); font-weight:700; }
    .seg-nav .tab.active{ background:#fff; color:#0b1730; }
    .pill{ background:rgba(255,255,255,.10); padding:8px 12px; border-radius:999px; font-weight:600; }
    .btn{ border:0; padding:10px 14px; border-radius:12px; font-weight:700; color:#0b1730; background:#fff; cursor:pointer; }

    /* Layout */
    .grid{ display:grid; grid-template-columns: 1fr 340px; gap:18px; margin-top:18px; }
    @media (max-width: 1000px){ .grid{ grid-template-columns: 1fr; } }

    /* Cards */
    .card{ background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.10));
           border:1px solid var(--border); border-radius:22px; box-shadow: var(--shadow); overflow:hidden; }
    .card-head{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.14); }
    .card-title{ display:flex; gap:10px; align-items:center; font-weight:800; letter-spacing:.2px; font-size:18px; }
    .card-body{ padding:14px 18px; }

    /* Calendar */
    #calendar{ padding:10px 10px 18px; background:transparent; }
    .fc{ --fc-border-color: rgba(255,255,255,.10); --fc-neutral-bg-color: rgba(255,255,255,.05); }
    .fc .fc-toolbar.fc-header-toolbar{ padding:10px; }
    .fc .fc-toolbar-title{ font-weight:800; letter-spacing:.2px; }
    .fc .fc-button{ background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.18); color:var(--ink); border-radius:10px; padding:6px 10px; }
    .fc .fc-button-primary:not(:disabled).fc-button-active,
    .fc .fc-button-primary:focus{ box-shadow:0 0 0 3px var(--ring); }
    .fc .fc-daygrid-event{ border-radius:10px; padding:2px 6px; font-weight:700; }

    /* Sidebar */
    .side{ display:flex; flex-direction:column; gap:18px; }

    .upcoming-item{ display:grid; grid-template-columns: 56px 1fr; gap:12px; padding:10px; border-radius:14px;
                     border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); }
    .datepill{ display:grid; place-items:center; border-radius:12px; background:rgba(255,255,255,.12); font-weight:800; }
    .datepill .d{ font-size:18px; }
    .datepill .m{ font-size:12px; opacity:.9; }
    .up-title{ font-weight:800; }
    .up-meta{ font-size:12px; color:var(--ink-dim); }

    .stat-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .stat{ text-align:center; padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); }
    .stat .n{ font-size:22px; font-weight:900; }
    .stat .l{ font-size:12px; color:var(--ink-dim); }

    /* Floating button */
    .fab{ position:fixed; right:28px; bottom:28px; z-index:20; border:0; border-radius:16px; padding:14px 16px; font-weight:800; color:#fff;
          background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: var(--shadow); cursor:pointer; }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(2,6,23,.55); z-index:40; }
    .modal.open{ display:grid; }
    .modal-card{ width:min(860px, 92vw); border-radius:22px; background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.92)); color:#0f172a;
                 box-shadow:0 30px 80px rgba(2,6,23,.45); overflow:hidden; }
    .m-head{ display:flex; justify-content:space-between; align-items:center; padding:18px 20px; border-bottom:1px solid rgba(15,23,42,.08); }
    .m-title{ font-weight:900; font-size:18px; }
    .m-close{ background:transparent; border:0; font-size:22px; cursor:pointer; }
    .m-body{ display:grid; grid-template-columns: 1fr; }

    .tabs{ display:flex; gap:4px; padding:8px 10px; border-bottom:1px solid rgba(15,23,42,.08); background:#f8fafc; }
    .tabbtn{ padding:8px 12px; border-radius:10px; font-weight:700; border:1px solid transparent; background:transparent; cursor:pointer; }
    .tabbtn.active{ background:#fff; border-color:rgba(15,23,42,.10); box-shadow:0 1px 0 #fff inset; }

    .section{ padding:16px 20px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-weight:700; font-size:12px; color:#334155; text-transform:uppercase; letter-spacing:.4px; }
    .input, select, textarea{ padding:12px 12px; border-radius:12px; border:1px solid rgba(15,23,42,.12); font-weight:600; font-size:14px; }
    textarea{ min-height:110px; }

    .m-actions{ display:flex; justify-content:flex-end; gap:10px; padding:14px 20px; background:#fff; border-top:1px solid rgba(15,23,42,.08); }
    .m-btn{ border:0; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; }
    .m-btn.primary{ background:linear-gradient(135deg, #3b82f6, #8b5cf6); color:#fff; }
    .m-btn.ghost{ background:#eef2ff; color:#1e293b; }
  </style>
</head>
<body>
  <main class="wrap">
    <!-- topbar (nav injected by staff-common.js) -->
    <div class="topbar">
      <div class="seg-nav" id="nav"></div>
      <div class="spacer"></div>
      <div class="pill" id="site-pill">Site: ‚Äî</div>
      <div class="pill" id="email-pill">‚Äî</div>
      <div class="pill" id="role-pill">‚Äî</div>
      <button class="btn" id="logout-btn">Sign Out</button>
    </div>

    <div class="grid">
      <!-- Calendar Card -->
      <section class="card">
        <div class="card-head">
          <div class="card-title">üìÖ <span>Meeting Calendar</span></div>
          <div id="calendar-actions"></div>
        </div>
        <div id="calendar"></div>
      </section>

      <!-- Sidebar -->
      <aside class="side">
        <section class="card">
          <div class="card-head">
            <div class="card-title">üóìÔ∏è Upcoming</div>
          </div>
          <div class="card-body" id="upcoming"></div>
        </section>
        <section class="card">
          <div class="card-head">
            <div class="card-title">üìä Summary</div>
          </div>
          <div class="card-body">
            <div class="stat-grid">
              <div class="stat"><div class="n" id="st-upcoming">0</div><div class="l">Upcoming</div></div>
              <div class="stat"><div class="n" id="st-month">0</div><div class="l">This Month</div></div>
              <div class="stat"><div class="n" id="st-complete">0</div><div class="l">Completed</div></div>
            </div>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <button class="fab" id="newMeetingBtn">Ôºã New Meeting</button>

  <!-- Meeting Modal -->
  <div class="modal" id="meetingModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="m-head">
        <div class="m-title" id="modalTitle">New meeting</div>
        <button class="m-close" id="modalClose" aria-label="Close">‚úï</button>
      </div>

      <div class="tabs">
        <button class="tabbtn active" data-tab="details">Details</button>
        <button class="tabbtn" data-tab="agenda">Agenda</button>
        <button class="tabbtn" data-tab="notes">Notes</button>
        <button class="tabbtn" data-tab="attendees">Attendees</button>
        <button class="tabbtn" data-tab="recording">Recording</button>
      </div>

      <div class="m-body">
        <!-- Details -->
        <section class="section" data-panel="details">
          <div class="row">
            <div class="field"><label>Title</label><input id="f-title" class="input" placeholder="e.g. Staff Meeting" /></div>
            <div class="field"><label>Location</label><input id="f-location" class="input" placeholder="e.g. Teams or Room 1" /></div>
          </div>
          <div class="row">
            <div class="field"><label>Date</label><input id="f-date" type="date" class="input" /></div>
            <div class="field" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div class="field"><label>Start</label><input id="f-start" type="time" class="input" /></div>
              <div class="field"><label>End</label><input id="f-end" type="time" class="input" /></div>
            </div>
          </div>
          <div class="row">
            <div class="field"><label>Type</label>
              <select id="f-type">
                <option value="general">General</option>
                <option value="staff">Staff</option>
                <option value="clinical">Clinical</option>
                <option value="training">Training</option>
              </select>
            </div>
            <div class="field"><label>Status</label>
              <select id="f-status">
                <option value="scheduled">Scheduled</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>
          <div class="field" style="margin-top:10px;"><label>Description</label><textarea id="f-desc" placeholder="Optional details‚Ä¶"></textarea></div>
        </section>

        <!-- Agenda -->
        <section class="section" data-panel="agenda" hidden>
          <div class="field"><label>Add item</label><input id="f-agenda-input" class="input" placeholder="Topic" /></div>
          <div style="margin-top:8px; display:flex; gap:10px;">
            <button class="m-btn ghost" id="agendaAdd">Add</button>
          </div>
          <ul id="agendaList" style="margin-top:12px; padding-left:16px;"></ul>
        </section>

        <!-- Notes -->
        <section class="section" data-panel="notes" hidden>
          <div class="field"><label>Notes</label><textarea id="f-notes" placeholder="Type notes here‚Ä¶"></textarea></div>
        </section>

        <!-- Attendees -->
        <section class="section" data-panel="attendees" hidden>
          <div class="field"><label>Invitee email</label><input id="f-att" class="input" placeholder="name@example.com" /></div>
          <div style="margin-top:8px; display:flex; gap:10px;">
            <button class="m-btn ghost" id="attAdd">Add</button>
          </div>
          <ul id="attList" style="margin-top:12px; padding-left:16px;"></ul>
        </section>

        <!-- Recording -->
        <section class="section" data-panel="recording" hidden>
          <div class="field"><label>Upload recording</label><input type="file" id="f-rec" class="input" /></div>
          <p style="color:#475569; font-weight:600; font-size:13px;">(Optional) Attach an audio/video file after the meeting.</p>
        </section>
      </div>

      <div class="m-actions">
        <button class="m-btn ghost" id="deleteBtn" style="display:none; color:#b91c1c;">Delete</button>
        <div style="flex:1"></div>
        <button class="m-btn" id="startBtn">Start</button>
        <button class="m-btn primary" id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initSupabase, requireStaffSession, setTopbar, getSiteText, navActivate, attachLogout } from './staff-common.js';

    const state = {
      events: [],         // filled from DB
      current: null,      // event being edited
      agenda: [],
      attendees: []
    };

    // --- helpers ---
    const fmtTime = (date) => new Intl.DateTimeFormat(undefined,{hour:'numeric',minute:'2-digit'}).format(date);
    const fmtDay  = (date) => new Intl.DateTimeFormat(undefined,{weekday:'short'}).format(date);
    const fmtMon  = (date) => new Intl.DateTimeFormat(undefined,{month:'short'}).format(date);

    function parseDateTime(dateStr, timeStr){
      const [y,m,d] = dateStr.split('-').map(Number);
      const [hh,mm] = timeStr.split(':').map(Number);
      return new Date(y, (m-1), d, hh, mm||0, 0, 0);
    }

    function paintUpcoming(){
      const box = document.getElementById('upcoming');
      box.innerHTML = '';
      const now = new Date();
      const future = state.events.filter(e => new Date(e.start) >= now).sort((a,b)=> new Date(a.start)-new Date(b.start)).slice(0,5);
      if(!future.length){ box.innerHTML = '<div style="opacity:.8">No upcoming meetings.</div>'; }
      future.forEach(e => {
        const dt = new Date(e.start);
        const el = document.createElement('div');
        el.className = 'upcoming-item';
        el.innerHTML = `
          <div class="datepill"><div class="d">${dt.getDate()}</div><div class="m">${fmtMon(dt)}</div></div>
          <div>
            <div class="up-title">${e.title || 'Untitled'}</div>
            <div class="up-meta">${fmtDay(dt)} ${fmtTime(dt)} ¬∑ ${e.extendedProps?.location || '‚Äî'} ¬∑ ${e.extendedProps?.type || ''}</div>
          </div>`;
        el.addEventListener('click', ()=> openModal(e));
        box.appendChild(el);
      });

      // stats
      document.getElementById('st-upcoming').textContent = state.events.filter(e=> new Date(e.start) >= now).length;
      const month = now.getMonth();
      document.getElementById('st-month').textContent = state.events.filter(e=> new Date(e.start).getMonth()===month).length;
      document.getElementById('st-complete').textContent = state.events.filter(e=> e.extendedProps?.status==='completed').length;
    }

    // --- modal ---
    const modal = document.getElementById('meetingModal');
    const modalTitle = document.getElementById('modalTitle');
    const closeBtn = document.getElementById('modalClose');
    const tabs = [...document.querySelectorAll('.tabbtn')];

    function switchTab(id){
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab===id));
      [...document.querySelectorAll('[data-panel]')].forEach(p => p.hidden = (p.dataset.panel!==id));
    }
    tabs.forEach(t => t.addEventListener('click', ()=> switchTab(t.dataset.tab)));

    function fillForm(e){
      const s = new Date(e.start); const f = new Date(e.end || (s.getTime()+60*60*1000));
      document.getElementById('f-title').value = e.title || '';
      document.getElementById('f-location').value = e.extendedProps?.location || '';
      document.getElementById('f-date').value = s.toISOString().slice(0,10);
      document.getElementById('f-start').value = s.toTimeString().slice(0,5);
      document.getElementById('f-end').value = f.toTimeString().slice(0,5);
      document.getElementById('f-type').value = e.extendedProps?.type || 'general';
      document.getElementById('f-status').value = e.extendedProps?.status || 'scheduled';
      document.getElementById('f-desc').value = e.extendedProps?.description || '';
      state.agenda = [...(e.extendedProps?.agenda||[])];
      state.attendees = [...(e.extendedProps?.attendees||[])];
      paintLists();
    }

    function collectForm(){
      const date = document.getElementById('f-date').value;
      const start = document.getElementById('f-start').value || '09:00';
      const end = document.getElementById('f-end').value   || '10:00';
      return {
        title: document.getElementById('f-title').value || 'Untitled',
        start: parseDateTime(date, start),
        end:   parseDateTime(date, end),
        extendedProps: {
          location: document.getElementById('f-location').value || '',
          type: document.getElementById('f-type').value,
          status: document.getElementById('f-status').value,
          description: document.getElementById('f-desc').value || '',
          agenda: [...state.agenda],
          attendees: [...state.attendees]
        }
      };
    }

    function openModal(e){
      state.current = e || null;
      modal.classList.add('open');
      document.body.style.overflow='hidden';
      switchTab('details');
      if(e){
        modalTitle.textContent = e.title || 'Meeting';
        fillForm(e);
        document.getElementById('deleteBtn').style.display = '';
      }else{
        modalTitle.textContent = 'New meeting';
        const now = new Date();
        document.getElementById('f-title').value = '';
        document.getElementById('f-location').value = '';
        document.getElementById('f-date').value = now.toISOString().slice(0,10);
        document.getElementById('f-start').value = '09:00';
        document.getElementById('f-end').value = '10:00';
        document.getElementById('f-type').value = 'general';
        document.getElementById('f-status').value = 'scheduled';
        document.getElementById('f-desc').value = '';
        state.agenda = []; state.attendees = [];
        paintLists();
        document.getElementById('deleteBtn').style.display = 'none';
      }
    }
    function closeModal(){ modal.classList.remove('open'); document.body.style.overflow='auto'; }
    document.getElementById('modalClose').addEventListener('click', closeModal);

    // lists (agenda/attendees)
    function paintLists(){
      const a = document.getElementById('agendaList');
      a.innerHTML = state.agenda.map((t,i)=>`<li>${t} <button data-ai="${i}" style="margin-left:6px">‚úï</button></li>`).join('');
      a.querySelectorAll('button').forEach(b=> b.onclick = ()=>{ state.agenda.splice(Number(b.dataset.ai),1); paintLists(); });
      const u = document.getElementById('attList');
      u.innerHTML = state.attendees.map((t,i)=>`<li>${t} <button data-i="${i}" style="margin-left:6px">‚úï</button></li>`).join('');
      u.querySelectorAll('button').forEach(b=> b.onclick = ()=>{ state.attendees.splice(Number(b.dataset.i),1); paintLists(); });
    }
    document.getElementById('agendaAdd').onclick = ()=>{ const v = document.getElementById('f-agenda-input').value.trim(); if(v){ state.agenda.push(v); document.getElementById('f-agenda-input').value=''; paintLists(); }}
    document.getElementById('attAdd').onclick = ()=>{ const v = document.getElementById('f-att').value.trim(); if(v){ state.attendees.push(v); document.getElementById('f-att').value=''; paintLists(); }}

    // buttons
    document.getElementById('newMeetingBtn').addEventListener('click', ()=> openModal(null));
    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      const data = collectForm();
      if(state.current && state.current.id){
        // update existing
        const idx = state.events.findIndex(ev=> ev.id===state.current.id);
        data.id = state.current.id;
        state.events[idx] = data;
        calendar.getEventById(data.id)?.remove();
        calendar.addEvent({...data});
      }else{
        // create new
        data.id = String(Date.now());
        state.events.push(data);
        calendar.addEvent({...data});
      }
      // TODO: persist to Supabase here.
      paintUpcoming();
      closeModal();
    });
    document.getElementById('deleteBtn').addEventListener('click', ()=>{
      if(!state.current) return; 
      const id = state.current.id; 
      state.events = state.events.filter(e=> e.id!==id);
      calendar.getEventById(id)?.remove();
      // TODO: delete from Supabase here.
      paintUpcoming();
      closeModal();
    });
    document.getElementById('startBtn').addEventListener('click', ()=>{
      alert('Starting meeting‚Ä¶ (hook your Teams/Zoom link here)');
    });

    // calendar
    let calendar;
    async function boot(){
      const supabase = await initSupabase();
      const { session, profileRow } = await requireStaffSession(supabase);
      const siteId = profileRow?.site_id || session?.user?.raw_user_meta_data?.site_id || null;
      const roleDetail = profileRow?.role || session?.user?.raw_user_meta_data?.role || 'Staff';
      setTopbar({ siteText: await getSiteText(supabase, siteId), email: session.user.email, role: roleDetail });
      navActivate('meetings');
      attachLogout(supabase);

      // TODO: Load meetings from your Supabase table
      // Here are some sample events for layout
      state.events = [
        { id:'e1', title:'Staff Meeting', start: new Date(new Date().setDate(new Date().getDate()+1)), end: new Date(new Date().setDate(new Date().getDate()+1)+60*60*1000), extendedProps:{ location:'Teams', type:'staff', status:'scheduled' } },
        { id:'e2', title:'Clinical Review', start: new Date(new Date().setDate(new Date().getDate()+3)), end: new Date(new Date().setDate(new Date().getDate()+3)+60*60*1000), extendedProps:{ location:'Room 2', type:'clinical', status:'scheduled' } },
      ];

      const el = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth',
        headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
        events: state.events,
        eventClick: (info)=> openModal(info.event),
        height: 'auto'
      });
      calendar.render();
      paintUpcoming();
    }
    boot();
  </script>

    <!-- Debug Console - Persistent across all pages -->
    <script src="debug-console.js"></script>
</body>
</html>

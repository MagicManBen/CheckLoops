<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Holiday Data Management - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 30px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 1px solid #e5e7eb;
    }

    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      color: #6b7280;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .stat-label {
      color: #6b7280;
      font-size: 0.875rem;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
    }

    .table-container {
      overflow-x: auto;
      margin-bottom: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f9fafb;
      text-align: left;
      padding: 12px;
      font-weight: 600;
      color: #4b5563;
      border-bottom: 1px solid #e5e7eb;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
    }

    tr:hover {
      background: #f9fafb;
    }

    .btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #5a67d8;
    }

    .btn-secondary {
      background: #6b7280;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-danger {
      background: #ef4444;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .import-section {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .import-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      display: none;
    }

    .import-status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .import-status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .import-status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }

    .user-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .user-badge.registered {
      background: #d1fae5;
      color: #065f46;
    }

    .user-badge.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .search-box {
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #4b5563;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèñÔ∏è Holiday Data Management</h1>
    <p class="subtitle">Manage holiday entitlements, requests, and import historical data</p>

    <!-- Navigation back to admin dashboard -->
    <div style="margin-bottom: 20px;">
      <a href="admin-dashboard.html" class="btn btn-secondary" style="text-decoration: none; display: inline-block;">
        ‚Üê Back to Dashboard
      </a>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Registered Staff</div>
        <div class="stat-value" id="registeredCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending Staff</div>
        <div class="stat-value" id="pendingCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Entitlements</div>
        <div class="stat-value" id="entitlementsCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Holiday Requests</div>
        <div class="stat-value" id="requestsCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Backdated Days</div>
        <div class="stat-value" id="backdatedCount">0</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('overview')">Overview</button>
      <button class="tab" onclick="switchTab('entitlements')">Entitlements</button>
      <button class="tab" onclick="switchTab('requests')">Holiday Requests</button>
      <button class="tab" onclick="switchTab('import')">Import Data</button>
      <button class="tab" onclick="switchTab('pending')">Pending Staff</button>
    </div>

    <!-- Tab Contents -->
    <div id="overview" class="tab-content active">
      <h2>Staff Holiday Overview</h2>
      <div class="search-box">
        <input type="text" id="searchStaff" placeholder="Search staff by name or email..." onkeyup="filterStaff()">
      </div>
      <div class="table-container">
        <table id="staffTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Entitlement</th>
              <th>Used</th>
              <th>Remaining</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="staffTableBody">
            <tr>
              <td colspan="8" class="loading">Loading staff data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="entitlements" class="tab-content">
      <h2>Holiday Entitlements</h2>
      <button class="btn" onclick="showAddEntitlementModal()" style="margin-bottom: 20px;">+ Add Entitlement</button>
      <div class="table-container">
        <table id="entitlementsTable">
          <thead>
            <tr>
              <th>Staff Name</th>
              <th>Year</th>
              <th>Annual Hours</th>
              <th>Annual Sessions</th>
              <th>Carried Over</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="entitlementsTableBody">
            <tr>
              <td colspan="6" class="loading">Loading entitlements...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="requests" class="tab-content">
      <h2>Holiday Requests</h2>
      <div class="table-container">
        <table id="requestsTable">
          <thead>
            <tr>
              <th>Staff Name</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Status</th>
              <th>Total Days</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="requestsTableBody">
            <tr>
              <td colspan="7" class="loading">Loading requests...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="import" class="tab-content">
      <h2>Import Holiday Data</h2>
      
      <div class="import-section">
        <h3>Quick Import for Existing Users</h3>
        <p style="margin-bottom: 15px;">Import holiday data for users already in the system:</p>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn" onclick="importForUser('Ben Howard', '55f1b4e6-01f4-452d-8d6c-617fe7794873')">
            Import Ben Howard's Data
          </button>
          <button class="btn" onclick="importForUser('Tom Donlan', '68a1a111-ac7c-44a3-8fd3-8c37ff07e0a2')">
            Import Tom Donlan's Data
          </button>
          <button class="btn btn-secondary" onclick="importAllRegistered()">
            Import All Registered Users
          </button>
        </div>
        
        <div id="importStatus" class="import-status"></div>
      </div>

      <div class="import-section">
        <h3>Bulk Import from CSV</h3>
        <p style="margin-bottom: 15px;">Upload the processed CSV files to import all data:</p>
        
        <div style="margin-bottom: 15px;">
          <label for="csvFile">Select CSV File:</label>
          <input type="file" id="csvFile" accept=".csv" style="margin-left: 10px;">
        </div>
        
        <button class="btn" onclick="processCSVImport()">Process CSV Import</button>
        
        <div id="csvImportStatus" class="import-status"></div>
      </div>

      <div class="import-section">
        <h3>Data Files Status</h3>
        <ul style="line-height: 1.8;">
          <li>‚úÖ backdated_holidays.csv - 323 records</li>
          <li>‚úÖ clean_staff_mapping.csv - 21 staff members</li>
          <li>‚úÖ staff_details.csv - Working patterns and entitlements</li>
        </ul>
      </div>
    </div>

    <div id="pending" class="tab-content">
      <h2>Pending Staff (Not Yet Registered)</h2>
      <p style="margin-bottom: 20px;">These staff members have holiday data but are not yet registered in the system:</p>
      
      <div class="table-container">
        <table id="pendingTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Entitlement</th>
              <th>Has Holidays</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="pendingTableBody">
            <tr>
              <td colspan="6" class="loading">Loading pending staff...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal for adding/editing -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Add Entitlement</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    
    const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    
    // Holiday data from CSV files
    const staffMapping = [
      {name: "Alexa Moreton", email: "alexa.moreton@stoke.nhs.uk", role: "Nurse", entitlement: "6 days; 13:30:00", has_holidays: true},
      {name: "Ashwini Nayak", email: "ashwini.nayak@stoke.nhs.uk", role: "GP", entitlement: "44", has_holidays: true},
      {name: "Ben Howard", user_id: "55f1b4e6-01f4-452d-8d6c-617fe7794873", email: "ben.howard@stoke.nhs.uk", role: "Manager", entitlement: "8 days; 9:47:00", has_holidays: true},
      {name: "Carly Tweedie", email: "carly.tweedie@stoke.nhs.uk", role: "Admin", entitlement: "5 days; 10:00:00", has_holidays: true},
      {name: "Diana Griffiths", email: "diana.griffiths@stoke.nhs.uk", role: "Nurse", entitlement: "4 days; 9:00:00", has_holidays: true},
      {name: "Emily Parker", email: "emily.parker@stoke.nhs.uk", role: "Reception", entitlement: "7 days; 3:55:00", has_holidays: true},
      {name: "Gemma Keeling", email: "gemma.keeling@stoke.nhs.uk", role: "Manager", entitlement: "7 days; 22:00:00", has_holidays: true},
      {name: "Georgiana Sima", email: "georgiana.sima@stoke.nhs.uk", role: "Reception", entitlement: "7 days; 9:04:00", has_holidays: true},
      {name: "Kasim Hussain", email: "kasim.hussain@stoke.nhs.uk", role: "Pharmacist", entitlement: "6 days; 10:15:00", has_holidays: true},
      {name: "Kelly Amison", email: "kelly.amison@stoke.nhs.uk", role: "Health Care Assistant", entitlement: "9 days; 6:00:00", has_holidays: true},
      {name: "Kelly Mansell", email: "kelly.mansell@stoke.nhs.uk", role: "GP Assistant", entitlement: "1 day; 9:50:00", has_holidays: false},
      {name: "Lilly Mycock", email: "lilly.mycock@stoke.nhs.uk", role: "Reception", entitlement: "4 days; 6:02:00", has_holidays: true},
      {name: "Monique Keersmaekers", email: "monique.keersmaekers@stoke.nhs.uk", role: "GP", entitlement: "53", has_holidays: true},
      {name: "Patricia Perkins", email: "patricia.perkins@stoke.nhs.uk", role: "Reception", entitlement: "7 days; 17:43:00", has_holidays: true},
      {name: "Saba Khalid", email: "saba.khalid@stoke.nhs.uk", role: "Reception", entitlement: "9 days; 12:55:00", has_holidays: true},
      {name: "Salman Saeed", email: "salman.saeed@stoke.nhs.uk", role: "GP", entitlement: "56", has_holidays: true},
      {name: "Sarah Masterson", email: "sarah.masterson@stoke.nhs.uk", role: "Nurse", entitlement: "6 days; 18:00:00", has_holidays: false},
      {name: "Shihara Farook", email: "shihara.farook@stoke.nhs.uk", role: "GP", entitlement: "58", has_holidays: true},
      {name: "Susan Heath", email: "susan.heath@stoke.nhs.uk", role: "Reception", entitlement: "8 days; 17:31:00", has_holidays: true},
      {name: "Tom Donlan", user_id: "68a1a111-ac7c-44a3-8fd3-8c37ff07e0a2", email: "tom.donlan@stoke.nhs.uk", role: "Admin", entitlement: "9 days; 8:13:00", has_holidays: true},
      {name: "Tracy Heaton", email: "tracy.heaton@stoke.nhs.uk", role: "Admin", entitlement: "8 days; 17:15:00", has_holidays: true}
    ];

    // Backdated holidays data (sample - would be loaded from CSV)
    const backdatedHolidays = {
      "Kelly Amison": [
        {date: "2025-02-13", value: "06:00:00"},
        {date: "2025-03-03", value: "09:00:00"},
        {date: "2025-03-04", value: "07:00:00"},
        {date: "2025-03-05", value: "06:00:00"},
        {date: "2025-03-06", value: "06:00:00"},
        {date: "2025-03-07", value: "09:00:00"},
        {date: "2025-03-10", value: "09:00:00"},
        {date: "2025-03-11", value: "07:00:00"},
        {date: "2025-03-12", value: "06:00:00"},
        {date: "2025-03-13", value: "06:00:00"},
        {date: "2025-03-14", value: "09:00:00"},
        {date: "2025-03-31", value: "09:00:00"},
        {date: "2025-04-08", value: "07:00:00"},
        {date: "2025-04-22", value: "07:00:00"},
        {date: "2025-04-23", value: "06:00:00"},
        {date: "2025-04-24", value: "06:00:00"},
        {date: "2025-04-25", value: "09:00:00"},
        {date: "2025-08-11", value: "09:00:00"},
        {date: "2025-08-12", value: "07:00:00"}
      ],
      "Tom Donlan": [
        {date: "2025-03-17", value: "07:30:00"},
        {date: "2025-03-18", value: "07:30:00"},
        {date: "2025-04-14", value: "07:30:00"},
        {date: "2025-04-15", value: "07:30:00"}
      ],
      "Ben Howard": [
        {date: "2025-02-24", value: "07:30:00"},
        {date: "2025-02-25", value: "07:30:00"},
        {date: "2025-02-26", value: "07:30:00"},
        {date: "2025-02-27", value: "07:30:00"},
        {date: "2025-02-28", value: "07:30:00"}
      ],
      // GP sessions examples
      "Ashwini Nayak": [
        {date: "2025-02-12", value: "1"},
        {date: "2025-02-17", value: "2"},
        {date: "2025-02-18", value: "2"},
        {date: "2025-02-19", value: "1"},
        {date: "2025-04-16", value: "1"},
        {date: "2025-04-28", value: "2"},
        {date: "2025-06-24", value: "2"},
        {date: "2025-07-07", value: "2"},
        {date: "2025-07-08", value: "2"},
        {date: "2025-07-09", value: "1"}
      ],
      "Salman Saeed": [
        {date: "2025-02-17", value: "2"},
        {date: "2025-02-19", value: "2"},
        {date: "2025-02-20", value: "2"},
        {date: "2025-02-21", value: "2"},
        {date: "2025-03-31", value: "2"},
        {date: "2025-04-16", value: "2"},
        {date: "2025-04-17", value: "2"},
        {date: "2025-05-14", value: "2"},
        {date: "2025-05-15", value: "2"},
        {date: "2025-05-16", value: "2"}
      ]
    };

    // Global variables
    let allStaff = [];
    let allEntitlements = [];
    let allRequests = [];
    let currentUser = null;

    // Initialize on page load
    async function init() {
      // Check authentication
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      currentUser = user;

      // Load all data
      await loadAllData();
      updateStats();
    }

    async function loadAllData() {
      // Load registered users
      const { data: profiles } = await supabase
        .from('profiles')
        .select('*');

      // Load entitlements
      const { data: entitlements } = await supabase
        .from('holiday_entitlements')
        .select('*');

      // Load requests
      const { data: requests } = await supabase
        .from('holiday_requests')
        .select('*, holiday_request_days(*)');

      allEntitlements = entitlements || [];
      allRequests = requests || [];

      // Combine registered and pending staff
      allStaff = staffMapping.map(staff => {
        const profile = profiles?.find(p => 
          p.full_name === staff.name || 
          p.user_id === staff.user_id
        );
        
        return {
          ...staff,
          user_id: staff.user_id || profile?.user_id,
          registered: !!(staff.user_id || profile),
          profile: profile
        };
      });

      // Display data
      displayStaffOverview();
      displayEntitlements();
      displayRequests();
      displayPendingStaff();
    }

    function updateStats() {
      const registered = allStaff.filter(s => s.registered).length;
      const pending = allStaff.filter(s => !s.registered).length;
      
      document.getElementById('registeredCount').textContent = registered;
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('entitlementsCount').textContent = allEntitlements.length;
      document.getElementById('requestsCount').textContent = allRequests.length;
      
      // Count backdated days
      let backdatedCount = 0;
      Object.values(backdatedHolidays).forEach(days => {
        backdatedCount += days.length;
      });
      document.getElementById('backdatedCount').textContent = backdatedCount;
    }

    function displayStaffOverview() {
      const tbody = document.getElementById('staffTableBody');
      
      if (allStaff.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No staff data available</td></tr>';
        return;
      }

      tbody.innerHTML = allStaff.map(staff => {
        const entitlement = allEntitlements.find(e => e.user_id === staff.user_id);
        const userRequests = allRequests.filter(r => r.user_id === staff.user_id);
        
        // Calculate used and remaining
        let used = 0;
        let totalEntitlement = 0;
        
        if (entitlement) {
          if (staff.role === 'GP') {
            totalEntitlement = entitlement.annual_sessions || 0;
            // Calculate used sessions
            userRequests.forEach(req => {
              if (req.status === 'approved' && req.holiday_request_days) {
                req.holiday_request_days.forEach(day => {
                  used += day.sessions_requested || 0;
                });
              }
            });
          } else {
            // Parse hours entitlement
            const hoursMatch = staff.entitlement.match(/(\d+) days?[;,] (\d+):(\d+):(\d+)/);
            if (hoursMatch) {
              const days = parseInt(hoursMatch[1]);
              const hours = parseInt(hoursMatch[2]);
              const minutes = parseInt(hoursMatch[3]);
              totalEntitlement = days * 7.5 + hours + minutes / 60; // Convert to total hours
            }
            // Calculate used hours
            userRequests.forEach(req => {
              if (req.status === 'approved' && req.holiday_request_days) {
                req.holiday_request_days.forEach(day => {
                  if (day.hours_requested) {
                    const [h, m] = day.hours_requested.split(':');
                    used += parseInt(h) + parseInt(m) / 60;
                  }
                });
              }
            });
          }
        }
        
        const remaining = totalEntitlement - used;
        
        return `
          <tr>
            <td>${staff.name}</td>
            <td>${staff.email}</td>
            <td>${staff.role}</td>
            <td>
              <span class="user-badge ${staff.registered ? 'registered' : 'pending'}">
                ${staff.registered ? 'Registered' : 'Pending'}
              </span>
            </td>
            <td>${staff.entitlement}</td>
            <td>${staff.role === 'GP' ? used + ' sessions' : used.toFixed(1) + ' hours'}</td>
            <td>${staff.role === 'GP' ? remaining + ' sessions' : remaining.toFixed(1) + ' hours'}</td>
            <td>
              <div class="action-buttons">
                ${staff.registered && !entitlement ? 
                  `<button class="btn" onclick="importForUser('${staff.name}', '${staff.user_id}')">Import</button>` : 
                  ''
                }
                ${staff.registered ? 
                  `<button class="btn btn-secondary" onclick="viewStaffDetails('${staff.user_id}')">View</button>` :
                  `<button class="btn" onclick="createUser('${staff.name}', '${staff.email}')">Create User</button>`
                }
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function displayEntitlements() {
      const tbody = document.getElementById('entitlementsTableBody');
      
      if (allEntitlements.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No entitlements found. Import data to populate.</td></tr>';
        return;
      }

      tbody.innerHTML = allEntitlements.map(ent => {
        const staff = allStaff.find(s => s.user_id === ent.user_id);
        
        return `
          <tr>
            <td>${staff?.name || 'Unknown'}</td>
            <td>${ent.year}</td>
            <td>${ent.annual_hours || '00:00:00'}</td>
            <td>${ent.annual_sessions || 0}</td>
            <td>${ent.carried_over_hours || 0} / ${ent.carried_over_sessions || 0}</td>
            <td>
              <button class="btn btn-secondary" onclick="editEntitlement(${ent.id})">Edit</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function displayRequests() {
      const tbody = document.getElementById('requestsTableBody');
      
      if (allRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No holiday requests found</td></tr>';
        return;
      }

      tbody.innerHTML = allRequests.map(req => {
        const staff = allStaff.find(s => s.user_id === req.user_id);
        const dayCount = req.holiday_request_days?.length || 0;
        
        return `
          <tr>
            <td>${staff?.name || 'Unknown'}</td>
            <td>${new Date(req.start_date).toLocaleDateString()}</td>
            <td>${new Date(req.end_date).toLocaleDateString()}</td>
            <td>
              <span class="user-badge ${req.status === 'approved' ? 'registered' : 'pending'}">
                ${req.status}
              </span>
            </td>
            <td>${dayCount} days</td>
            <td>${new Date(req.created_at).toLocaleDateString()}</td>
            <td>
              <button class="btn btn-secondary" onclick="viewRequest(${req.id})">View</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function displayPendingStaff() {
      const tbody = document.getElementById('pendingTableBody');
      const pendingStaff = allStaff.filter(s => !s.registered);
      
      if (pendingStaff.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">All staff are registered!</td></tr>';
        return;
      }

      tbody.innerHTML = pendingStaff.map(staff => `
        <tr>
          <td>${staff.name}</td>
          <td>${staff.email}</td>
          <td>${staff.role}</td>
          <td>${staff.entitlement}</td>
          <td>${staff.has_holidays ? '‚úÖ Yes' : '‚ùå No'}</td>
          <td>
            <button class="btn" onclick="createUser('${staff.name}', '${staff.email}')">Create User</button>
          </td>
        </tr>
      `).join('');
    }

    // Import functions
    window.importForUser = async function(name, userId) {
      const statusDiv = document.getElementById('importStatus');
      statusDiv.className = 'import-status info';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = `Importing data for ${name}...`;

      try {
        const staff = staffMapping.find(s => s.name === name);
        if (!staff) {
          throw new Error('Staff member not found in mapping');
        }

        // Parse entitlement
        let annual_hours = '00:00:00';
        let annual_sessions = 0;
        
        if (staff.role === 'GP') {
          annual_sessions = parseInt(staff.entitlement) || 0;
        } else {
          const parts = staff.entitlement.split(';');
          if (parts.length === 2) {
            annual_hours = parts[1].trim();
          }
        }

        // Check if entitlement already exists
        const { data: existing } = await supabase
          .from('holiday_entitlements')
          .select('*')
          .eq('user_id', userId)
          .eq('year', 2025)
          .single();

        if (!existing) {
          // Insert entitlement
          const { error: entError } = await supabase
            .from('holiday_entitlements')
            .insert({
              user_id: userId,
              site_id: 2,
              year: 2025,
              annual_hours: annual_hours,
              annual_sessions: annual_sessions,
              annual_education_sessions: 0,
              carried_over_hours: 0,
              carried_over_sessions: 0,
              carried_over_education_sessions: 0
            });

          if (entError) throw entError;
        }

        // Import backdated holidays if they exist
        const holidays = backdatedHolidays[name];
        if (holidays && holidays.length > 0) {
          // Group holidays into requests by month
          const groupedHolidays = {};
          
          holidays.forEach(h => {
            const month = h.date.substring(0, 7); // YYYY-MM
            if (!groupedHolidays[month]) {
              groupedHolidays[month] = [];
            }
            groupedHolidays[month].push(h);
          });

          // Create a request for each month
          for (const [month, monthHolidays] of Object.entries(groupedHolidays)) {
            const dates = monthHolidays.map(h => h.date).sort();
            
            // Create holiday request
            const { data: request, error: reqError } = await supabase
              .from('holiday_requests')
              .insert({
                user_id: userId,
                site_id: 2,
                status: 'approved',
                start_date: dates[0],
                end_date: dates[dates.length - 1],
                approved_at: new Date().toISOString()
              })
              .select()
              .single();

            if (reqError) throw reqError;

            // Add individual days
            const daysToInsert = monthHolidays.map(h => {
              const isSession = !h.value.includes(':');
              return {
                holiday_request_id: request.id,
                date: h.date,
                hours_requested: isSession ? '00:00:00' : h.value,
                sessions_requested: isSession ? parseInt(h.value) : 0
              };
            });

            const { error: daysError } = await supabase
              .from('holiday_request_days')
              .insert(daysToInsert);

            if (daysError) throw daysError;
          }
        }

        statusDiv.className = 'import-status success';
        statusDiv.innerHTML = `‚úÖ Successfully imported data for ${name}!`;
        
        // Reload data
        await loadAllData();
        updateStats();
        
      } catch (error) {
        console.error('Import error:', error);
        statusDiv.className = 'import-status error';
        statusDiv.innerHTML = `‚ùå Error importing data for ${name}: ${error.message}`;
      }
    };

    window.importAllRegistered = async function() {
      const registered = allStaff.filter(s => s.registered);
      
      for (const staff of registered) {
        await importForUser(staff.name, staff.user_id);
      }
    };

    window.switchTab = function(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
    };

    window.filterStaff = function() {
      const search = document.getElementById('searchStaff').value.toLowerCase();
      const rows = document.querySelectorAll('#staffTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      });
    };

    window.createUser = function(name, email) {
      alert(`To create user ${name}:\n\n1. Go to Supabase Dashboard\n2. Navigate to Authentication > Users\n3. Click "Invite User"\n4. Enter email: ${email}\n5. After creation, refresh this page and import their data`);
    };

    window.viewStaffDetails = function(userId) {
      // Could open a modal with detailed view
      console.log('View details for user:', userId);
    };

    window.closeModal = function() {
      document.getElementById('modal').classList.remove('active');
    };

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
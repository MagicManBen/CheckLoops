const SUPABASE_URL = 'https://unveoqnlqnobufhublyw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVudmVvcW5scW5vYnVmaHVibHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTcyNzYsImV4cCI6MjA3MDU5MzI3Nn0.g93OsXDpO3V9DToU7s-Z3SwBBnB84rBv0JMv-idgSME';

async function testFixedQuizInsert() {
  console.log('üîß TESTING FIXED QUIZ_ATTEMPTS INSERT');
  console.log('====================================');
  
  try {
    // Authenticate
    const authResponse = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'apikey': SUPABASE_ANON_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        email: 'benhowardmagic@hotmail.com',
        password: 'Hello1!'
      })
    });
    
    const authData = await authResponse.json();
    const accessToken = authData.access_token;
    const userId = authData.user.id;
    
    // Get site_id
    const masterResponse = await fetch(`${SUPABASE_URL}/rest/v1/master_users?auth_user_id=eq.${userId}&select=site_id`, {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'apikey': SUPABASE_ANON_KEY
      }
    });
    
    const masterData = await masterResponse.json();
    const siteId = masterData[0]?.site_id;
    
    console.log('‚úÖ Auth successful, Site ID:', siteId);
    
    // Test the FIXED insert (without score_percent)
    const testRecord = {
      site_id: siteId,
      user_id: userId,
      started_at: new Date().toISOString(),
      completed_at: new Date().toISOString(),
      total_questions: 10,
      correct_answers: 8,
      // Removed score_percent - it's generated automatically!
      is_practice: false
    };
    
    console.log('\nüß™ Testing FIXED insert (without score_percent)...');
    console.log('   Test record:', JSON.stringify(testRecord, null, 2));
    
    const insertResponse = await fetch(`${SUPABASE_URL}/rest/v1/quiz_attempts`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'apikey': SUPABASE_ANON_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(testRecord)
    });
    
    console.log('\nüìä FIXED INSERT RESULT:');
    console.log('   Status:', insertResponse.status);
    
    const responseText = await insertResponse.text();
    
    if (insertResponse.ok) {
      console.log('üéâ SUCCESS! The fix works!');
      const insertedData = JSON.parse(responseText);
      console.log('   Inserted record:', JSON.stringify(insertedData[0], null, 2));
      console.log('   Generated score_percent:', insertedData[0]?.score_percent);
      
      // Clean up
      if (insertedData && insertedData[0]?.id) {
        console.log('\nüßπ Cleaning up test record...');
        await fetch(`${SUPABASE_URL}/rest/v1/quiz_attempts?id=eq.${insertedData[0].id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'apikey': SUPABASE_ANON_KEY
          }
        });
        console.log('‚úÖ Test record cleaned up');
      }
      
      console.log('\nüéØ THE MANDATORY QUIZ BUG IS FIXED!');
      console.log('   The issue was trying to insert into score_percent column');
      console.log('   which is auto-generated by the database.');
      
    } else {
      console.log('‚ùå Still failing:', responseText);
    }

  } catch (error) {
    console.error('‚ùå Test failed:', error);
  }
}

testFixedQuizInsert();